import{g as me,f as U,c as q,j as e,b as $e,d as Me,e as xe,h as _e,s as Ae,D as Ie,R as ie}from"../assets/index-qkWDMaBg.js";import{r as i,b as Oe}from"./vendor-B2j9q2e_.js";import{C as ce}from"./Card-CWQQZ5Yl.js";import{T as Ee}from"./Table-BWL2UdkV.js";import{C as Le,M as We}from"./ConfirmationModal-D8pahlml.js";import{d as he,e as se,f as P,X as V,E as Fe,ac as Be,J as Pe,O as ze,T as ee,c as Qe,b as te,v as Z,m as ue,A as He,a5 as oe,S as Ve,a1 as Ue,P as de,j as qe,F as Ye,a7 as Ke}from"./ui-GuEJqdPm.js";import{r as L,o as Je}from"./cascade-deletion-DYEBr1io.js";import"./query-BI61muSV.js";import"./utils-x1PSU_OZ.js";function Xe({rehearsal:s,compact:n=!1,onRehearsalClick:h}){const c=me(s),p=U(s),r=q(s);return e.jsx("div",{className:`${c} rounded-lg p-3 text-white cursor-pointer hover:shadow-lg transition-all duration-200 shadow-md ${n?"text-sm":""}`,onClick:()=>h?.(s),children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"flex items-start justify-between",children:e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx("div",{className:"font-semibold truncate text-base leading-tight",children:s.orchestra?.name||"ללא שם"})})}),e.jsxs("div",{className:"space-y-1.5 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-1.5 opacity-95",children:[e.jsx(he,{className:"w-3.5 h-3.5 flex-shrink-0"}),e.jsx("span",{className:"font-medium",children:p.time})]}),e.jsxs("div",{className:"flex items-center gap-1.5 opacity-95",children:[e.jsx(se,{className:"w-3.5 h-3.5 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:s.location||"לא צוין מיקום"})]}),!n&&r.hasAttendanceData&&e.jsxs("div",{className:"flex items-center gap-1.5 opacity-95",children:[e.jsx(P,{className:"w-3.5 h-3.5 flex-shrink-0"}),e.jsxs("span",{children:[r.presentCount,"/",r.totalMembers," נוכחים"]})]})]})]})})}function Ge({rehearsals:s,date:n,onClose:h,onRehearsalClick:c}){const p=n.toLocaleDateString("he-IL",{weekday:"long",day:"numeric",month:"long",year:"numeric"});return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",style:{position:"fixed !important",top:"0 !important",left:"0 !important",right:"0 !important",bottom:"0 !important",display:"flex !important",alignItems:"center !important",justifyContent:"center !important",zIndex:9999},children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-md w-full max-h-[80vh] overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-200",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"חזרות ליום"}),e.jsx("p",{className:"text-sm text-gray-600",children:p})]}),e.jsx("button",{onClick:h,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(V,{className:"w-5 h-5 text-gray-500"})})]}),e.jsx("div",{className:"p-4 overflow-y-auto max-h-[60vh]",children:e.jsx("div",{className:"space-y-3",children:s.map((r,o)=>e.jsx("div",{className:"cursor-pointer hover:bg-gray-50 rounded-lg p-2 transition-colors",onClick:()=>c(r),children:e.jsx(Xe,{rehearsal:r,compact:!0,onRehearsalClick:()=>{}})},r._id))})}),e.jsx("div",{className:"p-4 border-t border-gray-200 text-center",children:e.jsxs("p",{className:"text-xs text-gray-500",children:[s.length," חזרות ביום זה"]})})]})})}function Ze({rehearsals:s,viewMode:n,selectedDate:h=new Date,onSelectDate:c,onRehearsalClick:p,onEditRehearsal:r,onDeleteRehearsal:o,onViewDetails:j,onNavigateToRehearsal:m,className:u=""}){const[l,g]=i.useState(h),[y,C]=i.useState(!1),[I,$]=i.useState([]),[f,O]=i.useState(new Date),k=()=>{const d=new Date(l);n==="week"?d.setDate(d.getDate()-7):d.setMonth(d.getMonth()-1),g(d),c?.(d)},b=()=>{const d=new Date(l);n==="week"?d.setDate(d.getDate()+7):d.setMonth(d.getMonth()+1),g(d),c?.(d)},M=()=>{const d=new Date;g(d),c?.(d)},z=(d,a)=>{O(d),$(a),C(!0)},W=d=>{C(!1),m?.(d._id)},_=i.useMemo(()=>n==="week"?st(l,s):at(l,s),[l,s,n]),F=i.useMemo(()=>{if(n==="week"){const d=pe(l),a=new Date(d);return a.setDate(a.getDate()+6),d.getMonth()===a.getMonth()?`${d.getDate()}-${a.getDate()} ${d.toLocaleDateString("he-IL",{month:"long",year:"numeric"})}`:`${d.toLocaleDateString("he-IL",{day:"numeric",month:"short"})} - ${a.toLocaleDateString("he-IL",{day:"numeric",month:"short",year:"numeric"})}`}else return l.toLocaleDateString("he-IL",{month:"long",year:"numeric"})},[l,n]);return e.jsxs("div",{className:`bg-white rounded-lg border border-gray-200 ${u}`,children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:k,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(Fe,{className:"w-5 h-5 text-gray-600"})}),e.jsx("button",{onClick:b,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(Be,{className:"w-5 h-5 text-gray-600"})})]}),e.jsx("div",{className:"text-center",children:e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:F})}),e.jsx("button",{onClick:M,className:"px-3 py-1 text-sm text-primary-600 border border-primary-300 rounded-lg hover:bg-primary-50 transition-colors",children:"היום"})]}),e.jsx("div",{className:"p-4",children:n==="week"?e.jsx(et,{weekData:_,onRehearsalClick:p,onEditRehearsal:r,onDeleteRehearsal:o,onViewDetails:j}):e.jsx(tt,{monthData:_,currentDate:l,onRehearsalClick:p,onEditRehearsal:r,onDeleteRehearsal:o,onViewDetails:j,onNavigateToRehearsal:m,onShowAdditional:z})}),y&&e.jsx(Ge,{rehearsals:I,date:f,onClose:()=>C(!1),onRehearsalClick:W})]})}function et({weekData:s,onRehearsalClick:n,onEditRehearsal:h,onDeleteRehearsal:c,onViewDetails:p}){return e.jsxs("div",{className:"grid grid-cols-7 gap-1",children:[s.days.map((r,o)=>e.jsxs("div",{className:"p-2 text-center",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:$e(r.dayOfWeek)}),e.jsx("div",{className:`text-lg font-semibold mt-1 ${r.isToday?"text-primary-600":"text-gray-700"}`,children:r.date.getDate()})]},o)),s.days.map((r,o)=>e.jsx("div",{className:"min-h-[250px] border border-gray-200 rounded-lg p-3",children:e.jsx("div",{className:"space-y-2",children:r.rehearsals.map(j=>e.jsx(ge,{rehearsal:j,compact:!0,onRehearsalClick:n,onEditRehearsal:h,onDeleteRehearsal:c,onViewDetails:p},j._id))})},o))]})}function tt({monthData:s,currentDate:n,onRehearsalClick:h,onEditRehearsal:c,onDeleteRehearsal:p,onViewDetails:r,onNavigateToRehearsal:o,onShowAdditional:j}){return e.jsxs("div",{className:"grid grid-cols-7 gap-1",children:[Object.entries(Me).map(([m,u])=>e.jsx("div",{className:"p-2 text-center font-medium text-gray-900 text-sm",children:u},m)),s.weeks.map((m,u)=>m.map((l,g)=>e.jsxs("div",{className:`min-h-[120px] border border-gray-200 rounded-lg p-2 ${l.isCurrentMonth?"":"bg-gray-50"} ${l.isToday?"bg-primary-50 border-primary-200":""}`,children:[e.jsx("div",{className:`text-sm font-semibold mb-2 ${l.isCurrentMonth?l.isToday?"text-primary-600":"text-gray-900":"text-gray-400"}`,children:l.date.getDate()}),e.jsxs("div",{className:"space-y-1",children:[l.rehearsals.slice(0,3).map(y=>e.jsx(ge,{rehearsal:y,compact:!0,minimal:!0,onRehearsalClick:h,onEditRehearsal:c,onDeleteRehearsal:p,onViewDetails:r},y._id)),l.rehearsals.length>3&&e.jsxs("div",{className:"text-xs text-gray-500 text-center py-1 bg-gray-100 rounded-md cursor-pointer hover:bg-gray-200 transition-colors",onClick:y=>{y.stopPropagation(),j?.(l.date,l.rehearsals)},children:["+",l.rehearsals.length-3," נוספות"]})]})]},`${u}-${g}`)))]})}function ge({rehearsal:s,compact:n=!1,minimal:h=!1,onRehearsalClick:c,onEditRehearsal:p,onDeleteRehearsal:r,onViewDetails:o}){const j=xe(s),m=q(s),u=me(s),l=U(s);return h?e.jsxs("div",{className:`${u} rounded-md p-1.5 text-white cursor-pointer hover:shadow-md transition-all duration-200 text-xs shadow-sm`,onClick:()=>c?.(s),title:`${s.orchestra?.name||"ללא שם"} • ${l.time} • ${s.location}`,children:[e.jsx("div",{className:"font-medium truncate text-xs leading-tight",children:s.orchestra?.name||"ללא שם"}),e.jsxs("div",{className:"flex items-center justify-between mt-1 opacity-90",children:[e.jsx("span",{className:"text-[10px] truncate",children:l.time}),e.jsx("span",{className:"text-[10px] ml-1 truncate flex-shrink-0",children:s.location})]})]}):e.jsx("div",{className:`${u} rounded-lg p-3 text-white cursor-pointer hover:shadow-lg transition-all duration-200 shadow-md ${n?"text-sm":""}`,onClick:()=>c?.(s),children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx("div",{className:"font-semibold truncate text-base leading-tight",children:s.orchestra?.name||"ללא שם"})}),!n&&e.jsxs("div",{className:"flex items-center gap-0.5 mr-1 flex-shrink-0",children:[o&&e.jsx("button",{onClick:g=>{g.stopPropagation(),o(s)},className:"p-1.5 hover:bg-white hover:bg-opacity-20 rounded-full transition-colors",title:"צפה בפרטים",children:e.jsx(Pe,{className:"w-3.5 h-3.5"})}),p&&e.jsx("button",{onClick:g=>{g.stopPropagation(),p(s)},className:"p-1.5 hover:bg-white hover:bg-opacity-20 rounded-full transition-colors",title:"ערוך חזרה",children:e.jsx(ze,{className:"w-3.5 h-3.5"})}),r&&e.jsx("button",{onClick:g=>{g.stopPropagation(),r(s._id)},className:"p-1.5 hover:bg-white hover:bg-opacity-20 rounded-full transition-colors",title:"מחק חזרה",children:e.jsx(ee,{className:"w-3.5 h-3.5"})})]})]}),e.jsxs("div",{className:"space-y-1.5 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-1.5 opacity-95",children:[e.jsx(he,{className:"w-3.5 h-3.5 flex-shrink-0"}),e.jsx("span",{className:"font-medium",children:l.time})]}),e.jsxs("div",{className:"flex items-center gap-1.5 opacity-95",children:[e.jsx(se,{className:"w-3.5 h-3.5 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:s.location||"לא צוין מיקום"})]}),!n&&m.hasAttendanceData&&e.jsxs("div",{className:"flex items-center gap-1.5 opacity-95",children:[e.jsx(P,{className:"w-3.5 h-3.5 flex-shrink-0"}),e.jsxs("span",{children:[m.presentCount,"/",m.totalMembers," נוכחים"]})]})]}),n&&e.jsx("div",{className:"flex justify-end",children:e.jsx("div",{className:"px-2 py-0.5 rounded-full text-[10px] font-medium bg-white bg-opacity-20",children:j.text})})]})})}function pe(s){const n=new Date(s),h=n.getDay(),c=n.getDate()-h;return n.setDate(c),n.setHours(0,0,0,0),n}function st(s,n){const h=pe(s),c=new Date;c.setHours(0,0,0,0);const p=[];for(let r=0;r<7;r++){const o=new Date(h);o.setDate(h.getDate()+r);const j=n.filter(m=>{const u=new Date(m.date);return u.setHours(0,0,0,0),u.getTime()===o.getTime()}).sort((m,u)=>{const l=m.startTime||"00:00",g=u.startTime||"00:00";return o.getDate()===5&&console.log(`Comparing rehearsals on day ${o.getDate()}:`,{aName:m.orchestra?.name,aTime:l,bName:u.orchestra?.name,bTime:g,comparison:l.localeCompare(g)}),l.localeCompare(g)});p.push({date:o,dayOfWeek:o.getDay(),isToday:o.getTime()===c.getTime(),isCurrentMonth:!0,rehearsals:j})}return{days:p}}function at(s,n){const h=s.getFullYear(),c=s.getMonth(),p=new Date;p.setHours(0,0,0,0);const r=new Date(h,c,1),o=new Date(h,c+1,0),j=new Date(r);j.setDate(r.getDate()-r.getDay());const m=new Date(o);m.setDate(o.getDate()+(6-o.getDay()));const u=[],l=new Date(j);for(;l<=m;){const g=[];for(let y=0;y<7;y++){const C=new Date(l),I=n.filter($=>{const f=new Date($.date);return f.setHours(0,0,0,0),f.getTime()===C.getTime()}).sort(($,f)=>{const O=$.startTime||"00:00",k=f.startTime||"00:00";return O.localeCompare(k)});g.push({date:C,dayOfWeek:C.getDay(),isToday:C.getTime()===p.getTime(),isCurrentMonth:C.getMonth()===c,rehearsals:I}),l.setDate(l.getDate()+1)}u.push(g)}return{weeks:u}}function rt({rehearsal:s,onUpdateAttendance:n,onClose:h}){const[c,p]=i.useState(""),[r,o]=i.useState({present:new Set(s.attendance?.present||[]),absent:new Set(s.attendance?.absent||[])}),[j,m]=i.useState(!1),[u,l]=i.useState(!1),[g,y]=i.useState(null),[C,I]=i.useState(!1),$=U(s);q(s);const f=s.orchestra?.members||[],O=f.filter(a=>a.personalInfo?.fullName?.toLowerCase().includes(c.toLowerCase())||a.academicInfo?.class?.includes(c)),k={presentCount:r.present.size,absentCount:r.absent.size,totalMembers:f.length,unmarkedCount:f.length-r.present.size-r.absent.size};i.useEffect(()=>{const a=new Set(s.attendance?.present||[]),w=new Set(s.attendance?.absent||[]),N=a.size!==r.present.size||w.size!==r.absent.size||[...r.present].some(v=>!a.has(v))||[...r.absent].some(v=>!w.has(v));l(N)},[r,s.attendance]);const b=(a,w)=>{o(N=>{const v={present:new Set(N.present),absent:new Set(N.absent)};return v.present.delete(a),v.absent.delete(a),w==="present"?v.present.add(a):w==="absent"&&v.absent.add(a),v}),y(null)},M=a=>{o(w=>{const N={present:new Set,absent:new Set};return a==="present"?f.forEach(v=>N.present.add(v._id)):f.forEach(v=>N.absent.add(v._id)),N}),y(null)},z=()=>{o({present:new Set(s.attendance?.present||[]),absent:new Set(s.attendance?.absent||[])}),y(null)},W=async()=>{m(!0),y(null);try{const a={present:[...r.present],absent:[...r.absent]};await n(a),I(!0),setTimeout(()=>{I(!1),h()},1500)}catch(a){y(a.message||"שגיאה בשמירת הנוכחות")}finally{m(!1)}},_=a=>r.present.has(a)?"present":r.absent.has(a)?"absent":"unmarked",F=a=>{switch(a){case"present":return"bg-green-100 border-green-300 text-green-800";case"absent":return"bg-red-100 border-red-300 text-red-800";default:return"bg-gray-100 border-gray-300 text-gray-600"}},d=a=>{switch(a){case"present":return e.jsx(Z,{className:"w-4 h-4 text-green-600"});case"absent":return e.jsx(V,{className:"w-4 h-4 text-red-600"});default:return e.jsx(P,{className:"w-4 h-4 text-gray-400"})}};return C?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl p-8 max-w-md w-full text-center",children:[e.jsx("div",{className:"mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4",children:e.jsx(Qe,{className:"h-6 w-6 text-green-600"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"הנוכחות נשמרה בהצלחה"}),e.jsx("p",{className:"text-sm text-gray-500",children:"הנתונים עודכנו במערכת"})]})}):e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",onClick:h,children:e.jsx("div",{className:"bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto transform transition-all",onClick:a=>a.stopPropagation(),children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("button",{onClick:h,className:"p-2 text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(V,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex-1 text-center",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"ניהול נוכחות"}),e.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(te,{className:"w-4 h-4"}),e.jsx("span",{children:$.fullDateTime})]}),e.jsxs("div",{className:"flex items-center justify-center gap-2 mt-1",children:[e.jsx(P,{className:"w-4 h-4"}),e.jsx("span",{children:s.orchestra?.name})]})]})]}),e.jsx("div",{className:"w-8"})]}),e.jsxs("div",{className:"grid grid-cols-4 gap-4 mb-6 p-4 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:k.presentCount}),e.jsx("div",{className:"text-sm text-gray-600",children:"נוכחים"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:k.absentCount}),e.jsx("div",{className:"text-sm text-gray-600",children:"נעדרים"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-gray-600",children:k.unmarkedCount}),e.jsx("div",{className:"text-sm text-gray-600",children:"לא סומנו"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:k.totalMembers}),e.jsx("div",{className:"text-sm text-gray-600",children:"סך הכל"})]})]}),e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>M("present"),className:"flex items-center px-3 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors",children:[e.jsx(Z,{className:"w-4 h-4 ml-1"}),"סמן הכל כנוכח"]}),e.jsxs("button",{onClick:()=>M("absent"),className:"flex items-center px-3 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors",children:[e.jsx(V,{className:"w-4 h-4 ml-1"}),"סמן הכל כנעדר"]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(ue,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"חיפוש חבר...",value:c,onChange:a=>p(a.target.value),className:"pr-10 pl-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"})]})]}),g&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 mb-6 flex items-center",children:[e.jsx(He,{className:"w-5 h-5 text-red-600 ml-2"}),e.jsx("span",{className:"text-red-800",children:g})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg overflow-hidden mb-6",children:[e.jsx("div",{className:"max-h-96 overflow-y-auto",children:e.jsx("div",{className:"grid grid-cols-1 gap-1 p-2",children:O.map(a=>{const w=_(a._id),N=a.academicInfo?.instrumentProgress?.find(v=>v.isPrimary);return e.jsxs("div",{className:`flex items-center justify-between p-3 rounded-lg border ${F(w)} transition-colors`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex items-center justify-center w-8 h-8",children:d(w)}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:a.personalInfo?.fullName}),e.jsxs("div",{className:"text-sm opacity-75",children:[a.academicInfo?.class&&`כיתה ${a.academicInfo.class}`,N&&` • ${N.instrumentName}`]})]})]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:()=>b(a._id,"present"),className:`p-2 rounded-lg transition-colors ${w==="present"?"bg-green-200 text-green-800":"bg-white hover:bg-green-50 text-gray-600 hover:text-green-600"}`,title:"נוכח",children:e.jsx(Z,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>b(a._id,"absent"),className:`p-2 rounded-lg transition-colors ${w==="absent"?"bg-red-200 text-red-800":"bg-white hover:bg-red-50 text-gray-600 hover:text-red-600"}`,title:"נעדר",children:e.jsx(V,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>b(a._id,"unmarked"),className:`p-2 rounded-lg transition-colors ${w==="unmarked"?"bg-gray-200 text-gray-800":"bg-white hover:bg-gray-50 text-gray-600"}`,title:"בטל סימון",children:e.jsx(oe,{className:"w-4 h-4"})})]})]},a._id)})})}),O.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(P,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"אין תוצאות"}),e.jsx("p",{className:"text-gray-600",children:"לא נמצאו חברים התואמים לחיפוש"})]})]}),e.jsxs("div",{className:"flex justify-between pt-4 border-t border-gray-200",children:[e.jsxs("button",{onClick:z,disabled:!u||j,className:"flex items-center px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:[e.jsx(oe,{className:"w-4 h-4 ml-1"}),"איפוס"]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:h,className:"px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors",children:"ביטול"}),e.jsxs("button",{onClick:W,disabled:!u||j,className:`flex items-center px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors ${j?"cursor-wait":""}`,children:[e.jsx(Ve,{className:"w-4 h-4 ml-1"}),j?"שומר...":"שמור נוכחות"]})]})]})]})})})}function ut(){const s=Oe(),[n,h]=i.useState([]),[c,p]=i.useState([]),[r,o]=i.useState(!0),[j,m]=i.useState(null),[u,l]=i.useState("calendar"),[g,y]=i.useState("month"),[C,I]=i.useState(new Date),[$,f]=i.useState(!1),[O,k]=i.useState(!1),[b,M]=i.useState(null),[z,W]=i.useState(!1),[_,F]=i.useState(null),[d,a]=i.useState(!1),[w,N]=i.useState(null),[v,Y]=i.useState(!1),[D,Q]=i.useState({orchestraId:"",startDate:"",endDate:""}),[ae,je]=i.useState(!1),[S,re]=i.useState({searchQuery:"",orchestraId:"",dayOfWeek:"",location:"",status:"all",startDate:"",endDate:""}),[K,ye]=i.useState("date"),[J,fe]=i.useState("asc");i.useEffect(()=>{B()},[]);const B=async()=>{try{o(!0),m(null);const[t,x]=await Promise.all([L.getRehearsals(),Je.getOrchestras()]);h(t),p(x)}catch(t){console.error("Error loading rehearsals:",t),m("שגיאה בטעינת החזרות")}finally{o(!1)}},H=i.useMemo(()=>{const t=n.map(R=>{const T=c.find(A=>A._id===R.groupId);return{...R,orchestra:T?{_id:T._id,name:T.name,type:T.type,memberIds:T.memberIds||[],conductor:T.conductor,members:T.members}:void 0}});let x=_e(t,S);return Ae(x,K,J)},[n,c,S,K,J]),be=async(t,x)=>{try{x?await L.createBulkRehearsals(t):await L.createRehearsal(t),f(!1),await B()}catch(R){throw new Error(R.message||"שגיאה ביצירת החזרה")}},ve=async(t,x)=>{if(!(!b||x))try{await L.updateRehearsal(b._id,t),k(!1),M(null),await B()}catch(R){throw new Error(R.message||"שגיאה בעדכון החזרה")}},ne=t=>{N(t),a(!0)},Ne=async()=>{if(w)try{await L.deleteRehearsal(w),await B(),a(!1),N(null)}catch{m("שגיאה במחיקת החזרה"),a(!1),N(null)}},we=()=>{a(!1),N(null)},De=async()=>{if(!D.orchestraId||!D.startDate||!D.endDate){m("נדרש לבחור תזמורת ותאריכי התחלה וסיום");return}try{const t=await L.deleteRehearsalsByDateRange(D.orchestraId,D.startDate,D.endDate);await B(),Y(!1),Q({orchestraId:"",startDate:"",endDate:""}),m(null),console.log(`✅ נמחקו ${t.deletedCount} חזרות בהצלחה`)}catch(t){m(t.message||"שגיאה במחיקת החזרות בטווח התאריכים"),Y(!1)}},le=()=>{Y(!1),Q({orchestraId:"",startDate:"",endDate:""})},Ce=async t=>{if(_)try{await L.updateAttendance(_._id,t),W(!1),F(null),await B()}catch(x){throw new Error(x.message||"שגיאה בעדכון הנוכחות")}},E=(t,x)=>{re(R=>({...R,[t]:x}))},ke=()=>{re({searchQuery:"",orchestraId:"",dayOfWeek:"",location:"",status:"all",startDate:"",endDate:""})},Se=()=>{const t=H.map(A=>{const X=U(A),G=q(A);return{תזמורת:A.orchestra?.name||"",תאריך:X.date,יום:X.dayName,שעה:X.time,מיקום:A.location,נוכחים:G.presentCount,נעדרים:G.absentCount,אחוז_נוכחות:`${G.attendanceRate}%`,הערות:A.notes||""}}),x=[Object.keys(t[0]||{}).join(","),...t.map(A=>Object.values(A).join(","))].join(`
`),R=new Blob([x],{type:"text/csv;charset=utf-8;"}),T=document.createElement("a");T.href=URL.createObjectURL(R),T.download=`rehearsals_${new Date().toISOString().split("T")[0]}.csv`,T.click()},Re=[...new Set(n.map(t=>t.location).filter(Boolean))],Te=[{key:"orchestra",label:"תזמורת",render:t=>e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:t.orchestra?.name}),e.jsx("div",{className:"text-sm text-gray-500",children:t.type})]})},{key:"datetime",label:"תאריך ושעה",render:t=>{const x=U(t);return e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:x.date}),e.jsxs("div",{className:"text-sm text-gray-500",children:[x.dayName," • ",x.time]})]})}},{key:"location",label:"מיקום",render:t=>e.jsxs("div",{className:"flex items-center",children:[e.jsx(se,{className:"w-4 h-4 text-gray-400 ml-1"}),e.jsx("span",{className:"text-gray-900",children:t.location})]})},{key:"attendance",label:"נוכחות",render:t=>{const x=q(t);return x.hasAttendanceData?e.jsxs("div",{className:"flex items-center",children:[e.jsx(P,{className:"w-4 h-4 text-gray-400 ml-1"}),e.jsxs("span",{className:"text-gray-900",children:[x.presentCount,"/",x.totalMembers," (",x.attendanceRate,"%)"]})]}):e.jsx("span",{className:"text-gray-500 text-sm",children:"לא סומן"})}},{key:"status",label:"סטטוס",render:t=>{const x=xe(t);return e.jsx("span",{className:`inline-flex items-center px-2 py-1 text-xs font-medium rounded-full ${x.colorClass}`,children:x.text})}}];return r?e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600",children:"טוען חזרות..."})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"חזרות"}),e.jsx("p",{className:"text-gray-600",children:"ניהול חזרות תזמורת ומעקב נוכחות"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex bg-gray-100 rounded-lg p-1",children:[e.jsx("button",{onClick:()=>l("calendar"),className:`p-2 rounded-md transition-colors ${u==="calendar"?"bg-white text-gray-900 shadow-sm":"text-gray-500 hover:text-gray-700"}`,children:e.jsx(te,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>l("list"),className:`p-2 rounded-md transition-colors ${u==="list"?"bg-white text-gray-900 shadow-sm":"text-gray-500 hover:text-gray-700"}`,children:e.jsx(Ue,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>Y(!0),className:"flex items-center px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors",title:"מחיקת חזרות בטווח תאריכים",children:[e.jsx(ee,{className:"w-4 h-4 ml-1"}),"מחיקה בטווח תאריכים"]}),e.jsxs("button",{onClick:()=>f(!0),className:"flex items-center px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors",children:[e.jsx(de,{className:"w-4 h-4 ml-1"}),"חזרה חדשה"]})]})]})]}),j&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(qe,{className:"w-5 h-5 text-red-600 ml-2"}),e.jsx("span",{className:"text-red-800",children:j})]})}),e.jsxs(ce,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ue,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"חיפוש חזרות...",value:S.searchQuery,onChange:t=>E("searchQuery",t.target.value),className:"pr-10 pl-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"})]}),e.jsxs("button",{onClick:()=>je(!ae),className:"flex items-center px-3 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors",children:[e.jsx(Ye,{className:"w-4 h-4 ml-1"}),"מסננים"]}),Object.values(S).filter(t=>t&&t!=="all").length>1&&e.jsxs("span",{className:"text-sm text-primary-600",children:[Object.values(S).filter(t=>t&&t!=="all").length-1," מסננים פעילים"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:Se,className:"flex items-center px-3 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors",children:[e.jsx(Ke,{className:"w-4 h-4 ml-1"}),"ייצא"]}),u==="calendar"&&e.jsxs("div",{className:"flex bg-gray-100 rounded-lg p-1",children:[e.jsx("button",{onClick:()=>y("week"),className:`px-3 py-1 text-sm rounded transition-colors ${g==="week"?"bg-white text-gray-900 shadow-sm":"text-gray-500 hover:text-gray-700"}`,children:"שבוע"}),e.jsx("button",{onClick:()=>y("month"),className:`px-3 py-1 text-sm rounded transition-colors ${g==="month"?"bg-white text-gray-900 shadow-sm":"text-gray-500 hover:text-gray-700"}`,children:"חודש"})]})]})]}),ae&&e.jsxs("div",{className:"border-t border-gray-200 pt-4 grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"תזמורת"}),e.jsxs("select",{value:S.orchestraId,onChange:t=>E("orchestraId",t.target.value),className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500",children:[e.jsx("option",{value:"",children:"כל התזמורות"}),c.map(t=>e.jsx("option",{value:t._id,children:t.name},t._id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"יום בשבוע"}),e.jsxs("select",{value:S.dayOfWeek,onChange:t=>E("dayOfWeek",t.target.value?parseInt(t.target.value):""),className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500",children:[e.jsx("option",{value:"",children:"כל הימים"}),Ie.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"מיקום"}),e.jsxs("select",{value:S.location,onChange:t=>E("location",t.target.value),className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500",children:[e.jsx("option",{value:"",children:"כל המיקומים"}),Re.map(t=>e.jsx("option",{value:t,children:t},t))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"סטטוס"}),e.jsxs("select",{value:S.status,onChange:t=>E("status",t.target.value),className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500",children:[e.jsx("option",{value:"all",children:"כל החזרות"}),e.jsx("option",{value:"upcoming",children:"עתידות"}),e.jsx("option",{value:"in_progress",children:"מתקיימות"}),e.jsx("option",{value:"completed",children:"הסתיימו"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"מתאריך"}),e.jsx("input",{type:"date",value:S.startDate,onChange:t=>E("startDate",t.target.value),className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"עד תאריך"}),e.jsx("input",{type:"date",value:S.endDate,onChange:t=>E("endDate",t.target.value),className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"})]}),e.jsx("div",{className:"md:col-span-3 lg:col-span-6 flex justify-end",children:e.jsx("button",{onClick:ke,className:"text-sm text-gray-600 hover:text-gray-800 transition-colors",children:"נקה מסננים"})})]})]}),u==="calendar"?e.jsx(Ze,{rehearsals:H,viewMode:g,selectedDate:C,onSelectDate:I,onRehearsalClick:t=>{s(`/rehearsals/${t._id}`)},onEditRehearsal:t=>{M(t),k(!0)},onDeleteRehearsal:ne,onViewDetails:t=>{s(`/rehearsals/${t._id}`)},onNavigateToRehearsal:t=>{s(`/rehearsals/${t}`)}}):e.jsxs(ce,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900",children:["חזרות (",H.length,")"]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("select",{value:`${K}-${J}`,onChange:t=>{const[x,R]=t.target.value.split("-");ye(x),fe(R)},className:"px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500",children:[e.jsx("option",{value:"date-asc",children:"תאריך (עולה)"}),e.jsx("option",{value:"date-desc",children:"תאריך (יורד)"}),e.jsx("option",{value:"orchestra-asc",children:"תזמורת (א-ת)"}),e.jsx("option",{value:"orchestra-desc",children:"תזמורת (ת-א)"}),e.jsx("option",{value:"location-asc",children:"מיקום (א-ת)"}),e.jsx("option",{value:"location-desc",children:"מיקום (ת-א)"}),e.jsx("option",{value:"time-asc",children:"שעה (מוקדם)"}),e.jsx("option",{value:"time-desc",children:"שעה (מאוחר)"})]})})]}),H.length>0?e.jsx(Ee,{data:H,columns:Te,onView:t=>{s(`/rehearsals/${t._id}`)},onEdit:t=>{M(t),k(!0)},onDelete:t=>ne(t._id),actions:!0,actionLabels:{view:"נוכחות",edit:"ערוך",delete:"מחק"}}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(te,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"אין חזרות"}),e.jsx("p",{className:"text-gray-600 mb-4",children:Object.values(S).some(t=>t&&t!=="all")?"לא נמצאו חזרות התואמות למסננים":"התחל על ידי יצירת החזרה הראשונה"}),!Object.values(S).some(t=>t&&t!=="all")&&e.jsxs("button",{onClick:()=>f(!0),className:"inline-flex items-center px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors",children:[e.jsx(de,{className:"w-4 h-4 ml-1"}),"צור חזרה חדשה"]})]})]}),$&&e.jsx(ie,{orchestras:c,existingRehearsals:n,onSubmit:be,onCancel:()=>f(!1)}),O&&b&&e.jsx(ie,{orchestras:c,existingRehearsals:n,onSubmit:ve,onCancel:()=>{k(!1),M(null)},initialData:{groupId:b.groupId,type:b.type,date:b.date.split("T")[0],startTime:b.startTime,endTime:b.endTime,location:b.location,notes:b.notes,isActive:b.isActive}}),z&&_&&e.jsx(rt,{rehearsal:_,onUpdateAttendance:Ce,onClose:()=>{W(!1),F(null)}}),e.jsx(Le,{isOpen:d,title:"מחיקת חזרה",message:"האם אתה בטוח שברצונך למחוק את החזרה? פעולה זו אינה ניתנת לביטול.",confirmText:"מחק",cancelText:"ביטול",onConfirm:Ne,onCancel:we,variant:"danger"}),e.jsx(We,{isOpen:v,onClose:le,title:"מחיקת חזרות בטווח תאריכים",maxWidth:"lg",children:e.jsxs("div",{className:"p-6",children:[e.jsx("div",{className:"mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg",children:e.jsx("p",{className:"text-yellow-800",children:"⚠️ פעולה זו תמחק את כל החזרות בטווח התאריכים שנבחר עבור התזמורת הנבחרת. פעולה זו אינה ניתנת לביטול!"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"תזמורת"}),e.jsxs("select",{value:D.orchestraId,onChange:t=>Q({...D,orchestraId:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500",required:!0,children:[e.jsx("option",{value:"",children:"בחר תזמורת"}),c.map(t=>e.jsx("option",{value:t._id,children:t.name},t._id))]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"תאריך התחלה"}),e.jsx("input",{type:"date",value:D.startDate,onChange:t=>Q({...D,startDate:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"תאריך סיום"}),e.jsx("input",{type:"date",value:D.endDate,onChange:t=>Q({...D,endDate:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500",required:!0})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 mt-6",children:[e.jsx("button",{onClick:le,className:"px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors",children:"ביטול"}),e.jsxs("button",{onClick:De,className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors",disabled:!D.orchestraId||!D.startDate||!D.endDate,children:[e.jsx(ee,{className:"w-4 h-4 ml-2 inline"}),"מחק חזרות"]})]})]})})]})}export{ut as default};
