import{j as e,u as os,a as ds,S as ms}from"../assets/index-Bt-rbdKT.js";import{r as l,b as xs}from"./vendor-B2j9q2e_.js";import{c as hs}from"./utils-x1PSU_OZ.js";import{C as H}from"./Card-Bp9nq125.js";import{S as De,T as gs}from"./Table-BQGUFwcb.js";import{C as ue}from"./ConfirmationModal-B7HaZ5IM.js";import{T as se,b as Me,U as us,Z as $e,n as pe,X as be,j as fe,_ as W,i as K,$ as te,c as Q,d as ps,A as Ae,a0 as fs,r as bs,B as js,M as ys,f as je,I as Ns,O as vs,m as ws,P as Ss,a1 as Cs,a2 as ks,a as Ls}from"./ui-ypR0-hKN.js";import{c as ae,u as Is,a as D}from"./cascade-deletion-DAN0Gkem.js";import"./query-BI61muSV.js";const Ps=({student:x,showInstruments:t=!0,showTeacherAssignments:k=!0,showParentContact:$=!1,onClick:g,onDelete:i,className:h="",isSelectMode:S=!1,isSelected:N=!1,onSelectionChange:C})=>{const j=x.academicInfo.instrumentProgress?.find(p=>p.isPrimary)||x.academicInfo.instrumentProgress?.[0],P=p=>({1:"bg-gray-100 text-gray-800",2:"bg-blue-100 text-blue-800",3:"bg-green-100 text-green-800",4:"bg-yellow-100 text-yellow-800",5:"bg-orange-100 text-orange-800",6:"bg-red-100 text-red-800",7:"bg-purple-100 text-purple-800",8:"bg-indigo-100 text-indigo-800"})[p]||"bg-gray-100 text-gray-800",b=p=>p.split(" ").map(L=>L[0]).join("").slice(0,2),_=p=>({1:"bg-gray-500",2:"bg-blue-500",3:"bg-green-500",4:"bg-yellow-500",5:"bg-orange-500",6:"bg-red-500",7:"bg-purple-500",8:"bg-indigo-500"})[p]||"bg-gray-500",[v,u]=l.useState(!1),o=p=>{p.stopPropagation(),u(!0)},V=()=>{i&&i(x._id),u(!1)},G=()=>{u(!1)},O=p=>{p.stopPropagation(),C&&C(x._id,p.target.checked)};return e.jsxs(H,{className:`relative transition-all duration-200 hover:shadow-md ${g?"cursor-pointer hover:shadow-lg":""} ${N?"ring-2 ring-blue-500 bg-blue-50":""} ${h}`,onClick:g,padding:"md",children:[S&&e.jsx("div",{className:"absolute top-3 right-3",children:e.jsx("input",{type:"checkbox",checked:N,onChange:O,className:"w-4 h-4 text-blue-600 bg-white border-2 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"})}),e.jsxs("div",{className:"flex items-start space-x-4 space-x-reverse",children:[e.jsx("div",{className:`
          w-12 h-12 rounded-full flex items-center justify-center text-white font-semibold text-sm
          ${j?_(j.currentStage):"bg-gray-500"}
        `,children:b(x.personalInfo.fullName)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:`text-lg font-semibold truncate ${N?"text-blue-900":"text-gray-900"} ${S?"ml-6":""}`,children:x.personalInfo.fullName}),e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse",children:[i&&e.jsx("button",{onClick:o,className:"p-1.5 text-red-600 hover:bg-red-50 rounded-lg transition-colors",title:"מחק תלמיד",children:e.jsx(se,{className:"w-4 h-4"})}),e.jsx("div",{className:`w-3 h-3 rounded-full ${x.isActive?"bg-green-400":"bg-gray-300"}`}),e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800",children:["כיתה ",x.academicInfo.class]})]})]}),t&&j&&e.jsx("div",{className:"mb-3",children:e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"כלי ראשי:"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:j.instrumentName}),e.jsxs("span",{className:`
                  inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
                  ${P(j.currentStage)}
                `,children:["שלב ",j.currentStage]})]})}),k&&e.jsx("div",{className:"mb-3",children:e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse text-sm text-gray-600",children:[e.jsx(Me,{className:"w-4 h-4"}),e.jsxs("span",{children:[x.teacherAssignments?.length||0," שיעורים שבועיים"]})]})}),t&&x.academicInfo.instrumentProgress&&x.academicInfo.instrumentProgress.length>1&&e.jsxs("div",{className:"mb-3",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"כלים נוספים:"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:x.academicInfo.instrumentProgress.filter(p=>!p.isPrimary).map((p,L)=>e.jsxs("span",{className:"inline-flex items-center px-2 py-0.5 rounded text-xs bg-gray-100 text-gray-700",children:[p.instrumentName," (שלב ",p.currentStage,")"]},L))})]}),$&&x.personalInfo.parentName&&e.jsxs("div",{className:"border-t border-gray-100 pt-3 mt-3",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"פרטי הורה:"}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse text-sm",children:[e.jsx(us,{className:"w-3 h-3 text-gray-400"}),e.jsx("span",{className:"text-gray-700",children:x.personalInfo.parentName})]}),x.personalInfo.parentPhone&&e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse text-sm",children:[e.jsx($e,{className:"w-3 h-3 text-gray-400"}),e.jsx("span",{className:"text-gray-700 font-mono",dir:"ltr",children:x.personalInfo.parentPhone})]})]})]}),e.jsx("div",{className:"border-t border-gray-100 pt-2 mt-2",children:e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse text-sm",children:[e.jsx($e,{className:"w-3 h-3 text-gray-400"}),e.jsx("span",{className:"text-gray-600 font-mono",dir:"ltr",children:x.personalInfo.phone})]})})]})]}),e.jsx(ue,{isOpen:v,title:"מחיקת תלמיד",message:`האם אתה בטוח שברצונך למחוק את התלמיד ${x.personalInfo.fullName}? פעולה זו לא ניתנת לביטול.`,confirmText:"מחק",cancelText:"ביטול",onConfirm:V,onCancel:G,variant:"danger"})]})},Ds=Ps,$s=({isOpen:x,studentId:t,studentName:k,onClose:$,onConfirm:g})=>{const[i,h]=l.useState(null),[S,N]=l.useState(!1),[C,j]=l.useState(null),[P,b]=l.useState({createSnapshot:!0,skipValidation:!1,deleteDocuments:!0,notifyUsers:!1,reason:"Safe deletion via UI"});l.useEffect(()=>{x&&t&&_()},[x,t]);const _=async()=>{N(!0),j(null);try{const u=await ae.previewDeletion(t);h(u)}catch(u){console.error("Error loading deletion preview:",u),j(u.message||"שגיאה בטעינת תצוגה מקדימה")}finally{N(!1)}},v=()=>{g(t,P)};return x?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(pe,{className:"w-6 h-6 text-orange-600"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"מחיקה מאובטחת"})]}),e.jsx("button",{onClick:$,className:"text-gray-400 hover:text-gray-600",children:e.jsx(be,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"p-6 overflow-y-auto max-h-[calc(90vh-200px)]",children:[e.jsxs("div",{className:"mb-6 p-4 bg-orange-50 border border-orange-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(fe,{className:"w-5 h-5 text-orange-600"}),e.jsxs("span",{className:"font-medium text-orange-900",children:["מחיקת התלמיד: ",k]})]}),e.jsx("p",{className:"text-sm text-orange-700",children:"פעולה זו תמחק את התלמיד וכל הנתונים הקשורים אליו. המערכת תבצע בדיקות בטיחות ותיצור גיבוי לפני המחיקה."})]}),S&&e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx(W,{className:"w-6 h-6 animate-spin text-primary-600"}),e.jsx("span",{className:"ml-2 text-gray-600",children:"טוען תצוגה מקדימה..."})]}),C&&e.jsxs("div",{className:"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{className:"w-5 h-5 text-red-600"}),e.jsx("span",{className:"font-medium text-red-900",children:"שגיאה"})]}),e.jsx("p",{className:"text-sm text-red-700 mt-1",children:C})]}),i&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-3",children:"סיכום השפעה"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("div",{className:"text-sm text-gray-600",children:'סה"כ רשומות'}),e.jsx("div",{className:"text-xl font-bold text-gray-900",children:i.summary?.totalRecords||0})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"זמן משוער"}),e.jsxs("div",{className:"text-xl font-bold text-gray-900",children:[i.summary?.estimatedDuration||0," שניות"]})]})]})]}),e.jsx("div",{className:"mb-6",children:e.jsx("div",{className:`p-4 rounded-lg border ${i.summary?.riskLevel==="high"?"bg-red-50 border-red-200":i.summary?.riskLevel==="medium"?"bg-yellow-50 border-yellow-200":"bg-green-50 border-green-200"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(te,{className:`w-5 h-5 ${i.summary?.riskLevel==="high"?"text-red-600":i.summary?.riskLevel==="medium"?"text-yellow-600":"text-green-600"}`}),e.jsxs("span",{className:"font-medium",children:["רמת סיכון: ",i.summary?.riskLevel==="high"?"גבוהה":i.summary?.riskLevel==="medium"?"בינונית":"נמוכה"]})]})})}),i.summary?.affectedCollections?.length>0&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-3",children:"אזורים מושפעים"}),e.jsx("div",{className:"space-y-2",children:i.summary.affectedCollections.map((u,o)=>e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-gray-50 rounded",children:[e.jsx(Q,{className:"w-4 h-4 text-green-600"}),e.jsx("span",{className:"text-sm",children:u})]},o))})]}),i.warnings?.length>0&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-3",children:"אזהרות"}),e.jsx("div",{className:"space-y-2",children:i.warnings.map((u,o)=>e.jsxs("div",{className:"flex items-start gap-2 p-3 bg-yellow-50 border border-yellow-200 rounded",children:[e.jsx(fe,{className:"w-4 h-4 text-yellow-600 flex-shrink-0 mt-0.5"}),e.jsx("span",{className:"text-sm text-yellow-800",children:u})]},o))})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-3",children:"אפשרויות מחיקה"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:P.createSnapshot,onChange:u=>b(o=>({...o,createSnapshot:u.target.checked})),className:"rounded border-gray-300 text-primary-600 focus:ring-primary-500"}),e.jsx("span",{className:"text-sm text-gray-700",children:"צור גיבוי לפני המחיקה (מומלץ)"})]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:P.deleteDocuments,onChange:u=>b(o=>({...o,deleteDocuments:u.target.checked})),className:"rounded border-gray-300 text-primary-600 focus:ring-primary-500"}),e.jsx("span",{className:"text-sm text-gray-700",children:"מחק גם קבצים ומסמכים"})]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:P.notifyUsers,onChange:u=>b(o=>({...o,notifyUsers:u.target.checked})),className:"rounded border-gray-300 text-primary-600 focus:ring-primary-500"}),e.jsx("span",{className:"text-sm text-gray-700",children:"שלח התראות למורים קשורים"})]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:P.skipValidation,onChange:u=>b(o=>({...o,skipValidation:u.target.checked})),className:"rounded border-gray-300 text-primary-600 focus:ring-primary-500"}),e.jsx("span",{className:"text-sm text-gray-700",children:"דלג על בדיקות תקינות (לא מומלץ)"})]})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"סיבת המחיקה"}),e.jsx("textarea",{value:P.reason,onChange:u=>b(o=>({...o,reason:u.target.value})),rows:3,className:"w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500",placeholder:"הזן סיבה למחיקה..."})]})]}),e.jsxs("div",{className:"flex items-center justify-between p-6 border-t border-gray-200 bg-gray-50",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(ps,{className:"w-4 h-4"}),e.jsx("span",{children:"המחיקה תחל לאחר אישור"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:$,className:"px-4 py-2 border border-gray-200 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors",children:"ביטול"}),e.jsxs("button",{onClick:v,disabled:S||!i?.canProceed,className:"flex items-center gap-2 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(pe,{className:"w-4 h-4"}),"מחק באופן מאובטח"]})]})]})]})}):null},As=$s,Ms=({isOpen:x,preview:t,onClose:k})=>{if(!x||!t)return null;const $=i=>{switch(i){case"lessons":return e.jsx(Me,{className:"w-4 h-4"});case"attendance":return e.jsx(je,{className:"w-4 h-4"});case"orchestras":return e.jsx(ys,{className:"w-4 h-4"});case"theoryClasses":return e.jsx(js,{className:"w-4 h-4"});case"documents":return e.jsx(bs,{className:"w-4 h-4"});case"payments":return e.jsx(fs,{className:"w-4 h-4"});default:return e.jsx(te,{className:"w-4 h-4"})}},g=i=>{switch(i){case"lessons":return"שיעורים";case"attendance":return"נוכחות";case"orchestras":return"תזמורות";case"theoryClasses":return"תיאוריה";case"documents":return"מסמכים";case"payments":return"תשלומים";case"rehearsals":return"חזרות";case"assignments":return"הקצאות";default:return i}};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(te,{className:"w-6 h-6 text-blue-600"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"השפעת המחיקה"})]}),e.jsx("button",{onClick:k,className:"text-gray-400 hover:text-gray-600",children:e.jsx(be,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"p-6 overflow-y-auto max-h-[calc(90vh-140px)]",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"סיכום כללי"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx("div",{className:"text-sm text-blue-600 mb-1",children:'סה"כ רשומות'}),e.jsx("div",{className:"text-2xl font-bold text-blue-900",children:t.summary?.totalRecords||0})]}),e.jsxs("div",{className:"p-4 bg-green-50 border border-green-200 rounded-lg",children:[e.jsx("div",{className:"text-sm text-green-600 mb-1",children:"זמן משוער"}),e.jsxs("div",{className:"text-2xl font-bold text-green-900",children:[t.summary?.estimatedDuration||0,"s"]})]}),e.jsxs("div",{className:`p-4 border rounded-lg ${t.summary?.riskLevel==="high"?"bg-red-50 border-red-200":t.summary?.riskLevel==="medium"?"bg-yellow-50 border-yellow-200":"bg-green-50 border-green-200"}`,children:[e.jsx("div",{className:`text-sm mb-1 ${t.summary?.riskLevel==="high"?"text-red-600":t.summary?.riskLevel==="medium"?"text-yellow-600":"text-green-600"}`,children:"רמת סיכון"}),e.jsx("div",{className:`text-2xl font-bold ${t.summary?.riskLevel==="high"?"text-red-900":t.summary?.riskLevel==="medium"?"text-yellow-900":"text-green-900"}`,children:t.summary?.riskLevel==="high"?"גבוהה":t.summary?.riskLevel==="medium"?"בינונית":"נמוכה"})]})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"פירוט מפורט"}),e.jsx("div",{className:"space-y-4",children:Object.entries(t.details||{}).map(([i,h])=>{if(!h||Array.isArray(h)&&h.length===0)return null;const S=Array.isArray(h)?h.length:h.count||0;return S===0?null:e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 bg-gray-50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[$(i),e.jsx("span",{className:"font-medium text-gray-900",children:g(i)})]}),e.jsxs("div",{className:"px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium",children:[S," רשומות"]})]}),Array.isArray(h)&&h.length>0&&e.jsx("div",{className:"p-4 max-h-40 overflow-y-auto",children:e.jsxs("div",{className:"space-y-2",children:[h.slice(0,10).map((N,C)=>e.jsx("div",{className:"text-sm text-gray-600 p-2 bg-gray-50 rounded",children:N.title||N.name||N.date||`פריט ${C+1}`},C)),h.length>10&&e.jsxs("div",{className:"text-sm text-gray-500 text-center py-2",children:["ועוד ",h.length-10," פריטים..."]})]})})]},i)})})]}),t.dependencies?.length>0&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"תלויות"}),e.jsx("div",{className:"space-y-2",children:t.dependencies.map((i,h)=>e.jsxs("div",{className:"flex items-start gap-3 p-3 bg-orange-50 border border-orange-200 rounded-lg",children:[e.jsx(Ae,{className:"w-5 h-5 text-orange-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium text-orange-900",children:[i.type,": ",i.entity]}),e.jsx("div",{className:"text-sm text-orange-700",children:i.description})]})]},h))})]}),t.warnings?.length>0&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"אזהרות"}),e.jsx("div",{className:"space-y-2",children:t.warnings.map((i,h)=>e.jsxs("div",{className:"flex items-start gap-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg",children:[e.jsx(Ae,{className:"w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5"}),e.jsx("span",{className:"text-sm text-yellow-800",children:i})]},h))})]}),e.jsx("div",{className:"border-t pt-4",children:e.jsx("div",{className:`p-4 rounded-lg ${t.canProceed?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${t.canProceed?"bg-green-500":"bg-red-500"}`}),e.jsx("span",{className:`font-medium ${t.canProceed?"text-green-900":"text-red-900"}`,children:t.canProceed?"ניתן לבצע מחיקה":"לא ניתן לבצע מחיקה עקב תלויות קריטיות"})]})})})]}),e.jsx("div",{className:"flex items-center justify-end p-6 border-t border-gray-200 bg-gray-50",children:e.jsx("button",{onClick:k,className:"px-6 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors",children:"סגור"})})]})})},Ts=Ms,Es=({isOpen:x,selectedStudentIds:t,onClose:k,onComplete:$})=>{const[g,i]=l.useState("preview"),[h,S]=l.useState(!1),[N,C]=l.useState(null),[j,P]=l.useState([]),[b,_]=l.useState({current:0,total:0,stage:""}),[v,u]=l.useState({success:0,failed:0,details:[]});l.useEffect(()=>{x&&t.length>0&&o()},[x,t]);const o=async()=>{S(!0),C(null);try{const c=t.map(async I=>{try{const T=await ae.previewDeletion(I);return{studentId:I,studentName:`תלמיד ${I}`,canDelete:T.canProceed,riskLevel:T.summary?.riskLevel||"low",totalRecords:T.summary?.totalRecords||0,warnings:T.warnings||[],errors:[]}}catch(T){return{studentId:I,studentName:`תלמיד ${I}`,canDelete:!1,riskLevel:"high",totalRecords:0,warnings:[],errors:[T.message||"שגיאה בטעינת תצוגה מקדימה"]}}}),w=await Promise.all(c);P(w)}catch(c){console.error("Error loading batch previews:",c),C(c.message||"שגיאה בטעינת תצוגות מקדימות")}finally{S(!1)}},V=async()=>{const c=j.filter(F=>F.canDelete);if(c.length===0){C("אין תלמידים שניתן למחוק");return}i("progress"),_({current:0,total:c.length,stage:"מתחיל מחיקה..."});const w=[];let I=0,T=0;for(let F=0;F<c.length;F++){const A=c[F];_({current:F+1,total:c.length,stage:`מוחק ${A.studentName}...`});try{await ae.executeDelete(A.studentId,{createSnapshot:!0,batchMode:!0,batchIndex:F+1,batchTotal:c.length}),I++,w.push({studentId:A.studentId,studentName:A.studentName,success:!0,error:null})}catch(X){T++,w.push({studentId:A.studentId,studentName:A.studentName,success:!1,error:X.message||"שגיאה במחיקה"})}await new Promise(X=>setTimeout(X,500))}u({success:I,failed:T,details:w}),i("complete")},G=()=>{g!=="progress"&&(g==="complete"&&v.success>0?$():k())};if(!x)return null;const O=j.filter(c=>c.canDelete).length,p=j.filter(c=>c.riskLevel==="high").length,L=j.reduce((c,w)=>c+w.totalRecords,0);return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(je,{className:"w-6 h-6 text-red-600"}),e.jsxs("h2",{className:"text-xl font-semibold text-gray-900",children:["מחיקה מרובת תלמידים (",t.length,")"]})]}),e.jsx("button",{onClick:G,disabled:g==="progress",className:"text-gray-400 hover:text-gray-600 disabled:opacity-50",children:e.jsx(be,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"overflow-y-auto max-h-[calc(90vh-180px)]",children:[g==="preview"&&e.jsxs("div",{className:"p-6",children:[h&&e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx(W,{className:"w-6 h-6 animate-spin text-primary-600"}),e.jsx("span",{className:"ml-2 text-gray-600",children:"טוען תצוגות מקדימות..."})]}),N&&e.jsxs("div",{className:"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{className:"w-5 h-5 text-red-600"}),e.jsx("span",{className:"font-medium text-red-900",children:"שגיאה"})]}),e.jsx("p",{className:"text-sm text-red-700 mt-1",children:N})]}),j.length>0&&!h&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-6 grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"p-4 bg-blue-50 border border-blue-200 rounded-lg text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-900",children:t.length}),e.jsx("div",{className:"text-sm text-blue-600",children:"נבחרו"})]}),e.jsxs("div",{className:"p-4 bg-green-50 border border-green-200 rounded-lg text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-900",children:O}),e.jsx("div",{className:"text-sm text-green-600",children:"ניתן למחוק"})]}),e.jsxs("div",{className:"p-4 bg-red-50 border border-red-200 rounded-lg text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-red-900",children:p}),e.jsx("div",{className:"text-sm text-red-600",children:"סיכון גבוה"})]}),e.jsxs("div",{className:"p-4 bg-gray-50 border border-gray-200 rounded-lg text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:L}),e.jsx("div",{className:"text-sm text-gray-600",children:'סה"כ רשומות'})]})]}),e.jsx("div",{className:"space-y-3",children:j.map(c=>e.jsxs("div",{className:"border border-gray-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[c.canDelete?e.jsx(Q,{className:"w-5 h-5 text-green-600"}):e.jsx(K,{className:"w-5 h-5 text-red-600"}),e.jsx("span",{className:"font-medium",children:c.studentName}),e.jsx("div",{className:`px-2 py-1 rounded-full text-xs font-medium ${c.riskLevel==="high"?"bg-red-100 text-red-800":c.riskLevel==="medium"?"bg-yellow-100 text-yellow-800":"bg-green-100 text-green-800"}`,children:c.riskLevel==="high"?"סיכון גבוה":c.riskLevel==="medium"?"סיכון בינוני":"סיכון נמוך"})]}),e.jsxs("div",{className:"text-sm text-gray-600",children:[c.totalRecords," רשומות"]})]}),c.warnings.length>0&&e.jsx("div",{className:"mt-2 space-y-1",children:c.warnings.map((w,I)=>e.jsxs("div",{className:"flex items-start gap-2 text-xs text-yellow-700",children:[e.jsx(fe,{className:"w-3 h-3 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:w})]},I))}),c.errors.length>0&&e.jsx("div",{className:"mt-2 space-y-1",children:c.errors.map((w,I)=>e.jsxs("div",{className:"flex items-start gap-2 text-xs text-red-700",children:[e.jsx(K,{className:"w-3 h-3 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:w})]},I))})]},c.studentId))})]})]}),g==="progress"&&e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mb-4",children:e.jsx(W,{className:"w-12 h-12 animate-spin text-red-600 mx-auto"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"מבצע מחיקה..."}),e.jsx("p",{className:"text-gray-600 mb-6",children:b.stage}),e.jsxs("div",{className:"max-w-md mx-auto",children:[e.jsxs("div",{className:"flex justify-between text-sm text-gray-600 mb-2",children:[e.jsxs("span",{children:[b.current," מתוך ",b.total]}),e.jsxs("span",{children:[Math.round(b.current/b.total*100),"%"]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-red-600 h-2 rounded-full transition-all duration-300",style:{width:`${b.current/b.total*100}%`}})})]}),e.jsx("p",{className:"text-sm text-gray-500 mt-4",children:"אנא המתן עד לסיום הפעולה. אל תסגור את החלון."})]})}),g==="complete"&&e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("div",{className:"mb-4",children:e.jsx(Q,{className:"w-12 h-12 text-green-600 mx-auto"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"המחיקה הושלמה"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6",children:[e.jsxs("div",{className:"p-4 bg-green-50 border border-green-200 rounded-lg text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-900",children:v.success}),e.jsx("div",{className:"text-sm text-green-600",children:"נמחקו בהצלחה"})]}),e.jsxs("div",{className:"p-4 bg-red-50 border border-red-200 rounded-lg text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-red-900",children:v.failed}),e.jsx("div",{className:"text-sm text-red-600",children:"נכשלו"})]})]}),v.details.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:"פירוט מלא:"}),v.details.map((c,w)=>e.jsxs("div",{className:`flex items-center gap-3 p-3 rounded-lg ${c.success?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:[c.success?e.jsx(Q,{className:"w-4 h-4 text-green-600"}):e.jsx(K,{className:"w-4 h-4 text-red-600"}),e.jsx("span",{className:"flex-1",children:c.studentName}),c.error&&e.jsx("span",{className:"text-sm text-red-600",children:c.error})]},w))]})]})]}),g!=="progress"&&e.jsxs("div",{className:"flex items-center justify-between p-6 border-t border-gray-200 bg-gray-50",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[g==="preview"&&e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"w-4 h-4"}),e.jsxs("span",{children:["מוכן למחיקת ",O," תלמידים"]})]}),g==="complete"&&e.jsxs(e.Fragment,{children:[e.jsx(Q,{className:"w-4 h-4"}),e.jsxs("span",{children:["הושלמו ",v.success," מחיקות"]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:G,className:"px-4 py-2 border border-gray-200 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors",children:g==="complete"?"סגור":"ביטול"}),g==="preview"&&O>0&&e.jsxs("button",{onClick:V,disabled:h,className:"flex items-center gap-2 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors disabled:opacity-50",children:[e.jsx(se,{className:"w-4 h-4"}),"מחק ",O," תלמידים"]})]})]})]})})},Rs=Es;function Hs(){const x=xs(),{user:t}=os(),{currentSchoolYear:k,isLoading:$}=ds(),[g,i]=l.useState([]),[h,S]=l.useState(!0),[N,C]=l.useState(!1),[j,P]=l.useState(null),[b,_]=l.useState(""),[v,u]=l.useState(""),[o,V]=l.useState({orchestra:"",instrument:"",stageLevel:""}),[G,O]=l.useState(1),[p,L]=l.useState(!0),[c,w]=l.useState(!1),[I,T]=l.useState(!0),[F,A]=l.useState(0),X=20,[Te,re]=l.useState(!1),[U,le]=l.useState(null),[Y,ye]=l.useState("table"),[Ee,ne]=l.useState(!1),[Z,J]=l.useState(null),[ie,Ne]=l.useState(null),[Re,ve]=l.useState(!1),[z,ce]=l.useState(null),[Fe,we]=l.useState(null),[oe,ee]=l.useState(null),[Ue,de]=l.useState(!1),[Oe,ze]=l.useState(!1),[Be,me]=l.useState(!1),[y,E]=l.useState(new Set),[_e,Fs]=l.useState(null),[M,Se]=l.useState(!1);Is(),l.useEffect(()=>{const s=setTimeout(()=>{u(b)},500);return()=>clearTimeout(s)},[b]),l.useEffect(()=>{const s=()=>{oe&&ee(null)};return document.addEventListener("click",s),()=>document.removeEventListener("click",s)},[oe]),l.useEffect(()=>{$||B(1,!1)},[k,$]);const Ve=()=>!t||t.role==="admin"||t.roles?.includes("admin")||t.role==="מנהל"||t.roles?.includes("מנהל")?"admin":t.role==="teacher"||t.roles?.includes("teacher")||t.role==="מורה"||t.roles?.includes("מורה")||t.teaching?.studentIds?.length>0?"teacher":t.role==="theory-teacher"||t.roles?.includes("theory-teacher")||t.roles?.includes("theory_teacher")||t.role==="מורה תיאוריה"||t.roles?.includes("מורה תיאוריה")?"theory-teacher":t.role==="conductor"||t.roles?.includes("conductor")||t.role==="מנצח"||t.roles?.includes("מנצח")||t.conducting?.orchestraIds?.length>0?"conductor":"admin",B=async(s=1,a=!1)=>{try{a?w(!0):(I?S(!0):C(!0),O(1),L(!0)),P(null);const d=Ve();console.log("Loading students for user role:",d,"User:",t?.personalInfo?.fullName,"Page:",s);let f=[],m,q=null;if(d==="admin"){const r={...k?{schoolYearId:k._id}:{},...v?{name:v}:{},...o.instrument?{instrument:o.instrument}:{},...o.stageLevel?{stage:o.stageLevel}:{},page:s,limit:X},n=await D.students.getStudents(r);n.data&&n.pagination?(m=n.data,q=n.pagination,L(n.pagination.hasNextPage),A(n.pagination.totalCount),console.log("Admin - loaded students page",s,":",n.data.length,"/",n.pagination.totalCount)):(m=n,L(!1),A(n.length),console.log("Admin - loaded all students:",n.length))}else if(d==="teacher"){const n=(await D.teachers.getMyProfile())?.teaching?.studentIds||[];console.log("Teacher - assigned student IDs:",n),n.length>0?(m=await D.students.getBatchStudents(n),console.log("Teacher - loaded assigned students:",m.length)):(m=[],console.log("Teacher - no assigned students")),L(!1),A(m.length)}else{const r={...k?{schoolYearId:k._id}:{},...v?{name:v}:{},...o.instrument?{instrument:o.instrument}:{},...o.stageLevel?{stage:o.stageLevel}:{},page:s,limit:X},n=await D.students.getStudents(r);n.data&&n.pagination?(m=n.data,q=n.pagination,L(n.pagination.hasNextPage),A(n.pagination.totalCount),console.log("Other role - loaded students page",s,":",n.data.length,"/",n.pagination.totalCount)):(m=n,L(!1),A(n.length),console.log("Other role - loaded all students:",n.length))}f=m;const Pe=m.map(r=>({id:r._id,fullName:r.personalInfo.fullName,phone:r.personalInfo.phone,age:r.personalInfo.age,class:r.academicInfo.class,primaryInstrument:r.academicInfo.instrumentProgress.find(n=>n.isPrimary)?.instrumentName||r.academicInfo.instrumentProgress[0]?.instrumentName||"ללא כלי",currentStage:r.academicInfo.instrumentProgress.find(n=>n.isPrimary)?.currentStage||1,teacherAssignments:r.teacherAssignments,parentName:r.personalInfo.parentName,parentPhone:r.personalInfo.parentPhone,orchestraIds:r.enrollments.orchestraIds,isActive:r.isActive})).map(r=>({id:r.id,name:r.fullName,instrument:r.primaryInstrument,stageLevel:r.currentStage,orchestra:r.orchestraIds?.length>0?"תזמורת":"ללא תזמורת",grade:e.jsx(De,{status:"completed",children:r.class}),status:e.jsx(De,{status:r.isActive?"active":"inactive",children:r.isActive?"פעיל":"לא פעיל"}),teacherAssignments:r.teacherAssignments?.length||0,rawData:{...r,referenceCount:r.referenceCount||0,isOrphaned:r.isOrphaned||!1,hasNoRecentActivity:r.hasNoRecentActivity||!1,integrityStatus:r.integrityStatus||"healthy",lastActivity:r.lastActivity||null},originalStudent:m.find(n=>n._id===r.id),actions:e.jsxs("div",{className:"flex space-x-2 space-x-reverse",children:[M&&e.jsx("input",{type:"checkbox",checked:y.has(r.id),onChange:n=>{n.stopPropagation();const ge=new Set(y);n.target.checked?ge.add(r.id):ge.delete(r.id),E(ge)},className:"rounded border-gray-300 text-primary-600 focus:ring-primary-500"}),e.jsx("button",{className:"p-1.5 text-primary-600 hover:text-primary-900 hover:bg-primary-100 rounded transition-colors",onClick:n=>{n.stopPropagation(),console.log("Eye icon clicked for student:",r.id),xe(r.id)},title:"צפה בפרטי התלמיד",children:e.jsx(Ns,{className:"w-4 h-4"})}),e.jsx("button",{className:"p-1.5 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded transition-colors",onClick:n=>{n.stopPropagation(),Ye(r.id)},title:"ערוך פרטי התלמיד",children:e.jsx(vs,{className:"w-4 h-4"})}),(r.referenceCount||r.rawData?.referenceCount||0)>0?e.jsx("button",{className:"p-1.5 text-orange-600 hover:text-orange-900 hover:bg-orange-50 rounded transition-colors",onClick:n=>{n.stopPropagation(),He(r.id,r.name)},title:"מחיקה מאובטחת",children:e.jsx(pe,{className:"w-4 h-4"})}):e.jsx("button",{className:"p-1.5 text-red-600 hover:text-red-900 hover:bg-red-50 rounded transition-colors",onClick:n=>{n.stopPropagation(),Ke(r.id,r.name)},title:"מחק תלמיד",children:e.jsx(se,{className:"w-4 h-4"})})]})}));i(a?r=>[...r,...Pe]:Pe)}catch(d){console.error("Error loading students:",d),P(d.message)}finally{S(!1),C(!1),w(!1),T(!1)}},xe=s=>{console.log("=== NAVIGATION DEBUG ==="),console.log("Student ID:",s),console.log("Target path:",`/students/${s}`),console.log("Current location:",window.location.pathname);const a=`/students/${s}`;try{x(a),console.log("Navigate function called successfully")}catch(d){console.error("Navigate failed, using window.location:",d),window.location.href=a}},Ye=async s=>{try{ve(!0),le(s);const a=await D.students.getStudentById(s);Ne(a),re(!0)}catch(a){console.error("Error loading student for editing:",a),alert("שגיאה בטעינת נתוני התלמיד לעריכה")}finally{ve(!1)}},Ge=()=>{le(null),re(!0)},Ce=()=>{re(!1),le(null),Ne(null)},Xe=async s=>{try{let a=U;if(U){if(await D.students.updateStudent(U,s),ie?.enrollments?.orchestraIds){const d=ie.enrollments.orchestraIds,f=s.enrollments?.orchestraIds||[];for(const m of d)if(!f.includes(m))try{await D.orchestras.removeMember(m,U),console.log(`Removed student ${U} from orchestra ${m}`)}catch(q){console.error(`Failed to remove from orchestra ${m}:`,q)}for(const m of f)if(!d.includes(m))try{await D.orchestras.addMember(m,U),console.log(`Added student ${U} to orchestra ${m}`)}catch(q){console.error(`Failed to add to orchestra ${m}:`,q)}}else if(s.enrollments?.orchestraIds?.length>0)for(const d of s.enrollments.orchestraIds)try{await D.orchestras.addMember(d,U),console.log(`Added student ${U} to orchestra ${d}`)}catch(f){console.error(`Failed to add to orchestra ${d}:`,f)}}else if(a=(await D.students.createStudent(s))._id,s.enrollments?.orchestraIds?.length>0)for(const f of s.enrollments.orchestraIds)try{await D.orchestras.addMember(f,a),console.log(`Added new student ${a} to orchestra ${f}`)}catch(m){console.error(`Failed to add to orchestra ${f}:`,m)}B(1,!1),Ce()}catch(a){throw console.error("Error saving student:",a),a}},qe=()=>{Ce()},ke=async s=>{try{await D.students.deleteStudent(s),B(1,!1)}catch(a){console.error("Error deleting student:",a),alert("שגיאה במחיקת התלמיד")}},He=async(s,a)=>{J({id:s,name:a}),de(!0)},We=()=>{if(y.size===0){alert("יש לבחור לפחות תלמיד אחד");return}me(!0)},Ze=()=>{Se(!M),E(new Set)},Le=(s,a)=>{const d=new Set(y);a?d.add(s):d.delete(s),E(d)},Je=async(s,a)=>{try{await ae.executeDelete(s,a),de(!1),J(null),B(1,!1)}catch(d){console.error("Error in safe deletion:",d),alert("שגיאה במחיקה המאובטחת")}},Ke=(s,a)=>{J({id:s,name:a}),ne(!0)},Qe=()=>{Z&&(ke(Z.id),J(null)),ne(!1)},es=()=>{J(null),ne(!1)},ss=s=>{ee(s)},Ie=(s,a,d,f)=>{const m=f?d+1:d-1;m<1||m>8||ce({studentId:s,studentName:a,currentLevel:d,newLevel:m})},ts=async()=>{if(z)try{we(z.studentId),await D.students.updateStudentStageLevel(z.studentId,z.newLevel),await B(1,!1),ce(null),ee(null)}catch(s){console.error("Error updating stage level:",s),alert("שגיאה בעדכון השלב: "+s.message)}finally{we(null)}},as=()=>{ce(null),ee(null)},rs=async()=>{const s=G+1;O(s),await B(s,!0)};l.useEffect(()=>{$||B(1,!1)},[v,o.orchestra,o.instrument,o.stageLevel]);const R=g,he=F>0?F:g.length,ls=g.filter(s=>s.rawData?.isActive).length,ns=g.filter(s=>!s.rawData?.isActive).length,is=g.filter(s=>s.teacherAssignments>0).length,cs=[...M?[{key:"select",header:e.jsx("input",{type:"checkbox",checked:y.size===R.length&&R.length>0,onChange:s=>{s.target.checked?E(new Set(R.map(a=>a.id))):E(new Set)},className:"w-4 h-4 rounded border-gray-300 text-primary-600 focus:ring-2 focus:ring-primary-500 cursor-pointer"}),render:s=>e.jsx("input",{type:"checkbox",checked:y.has(s.id),onChange:a=>{a.stopPropagation();const d=new Set(y);a.target.checked?d.add(s.id):d.delete(s.id),E(d)},onClick:a=>a.stopPropagation(),className:"w-4 h-4 rounded border-gray-300 text-primary-600 focus:ring-2 focus:ring-primary-500 cursor-pointer"}),width:"60px",align:"center"}]:[],{key:"name",header:"שם התלמיד"},{key:"instrument",header:"כלי נגינה"},{key:"stageLevel",header:"שלב",align:"center",render:s=>{const a=oe===s.id;return Fe===s.id?e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("div",{className:"w-16 h-8 flex items-center justify-center bg-blue-50 rounded-lg border-2 border-blue-200",children:e.jsx("span",{className:"text-blue-600 font-medium",children:"..."})})}):a?e.jsxs("div",{className:"flex items-center justify-center gap-1",onClick:f=>f.stopPropagation(),children:[e.jsx("button",{onClick:f=>{f.stopPropagation(),Ie(s.id,s.name,s.stageLevel,!1)},disabled:s.stageLevel<=1,className:"w-6 h-6 flex items-center justify-center bg-red-100 text-red-600 hover:bg-red-200 rounded-full disabled:opacity-30 disabled:cursor-not-allowed transition-colors text-sm font-bold",title:"הורד שלב",children:"-"}),e.jsx("div",{className:"w-12 h-8 flex items-center justify-center bg-blue-50 rounded-lg border-2 border-blue-300 mx-1",children:e.jsx("span",{className:"text-blue-700 font-bold text-sm",children:s.stageLevel})}),e.jsx("button",{onClick:f=>{f.stopPropagation(),Ie(s.id,s.name,s.stageLevel,!0)},disabled:s.stageLevel>=8,className:"w-6 h-6 flex items-center justify-center bg-green-100 text-green-600 hover:bg-green-200 rounded-full disabled:opacity-30 disabled:cursor-not-allowed transition-colors text-sm font-bold",title:"העלה שלב",children:"+"})]}):e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("button",{onClick:f=>{f.stopPropagation(),ss(s.id)},className:"w-8 h-8 flex items-center justify-center text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition-colors font-medium border border-transparent hover:border-blue-200",title:"לחץ לעריכת השלב",children:s.stageLevel})})}},{key:"orchestra",header:"תזמורת"},{key:"grade",header:"כיתה",align:"center"},{key:"status",header:"סטטוס",align:"center"},{key:"lastActivity",header:"פעילות אחרונה",align:"center",render:s=>{const a=s.rawData.lastActivity;if(!a)return e.jsx("span",{className:"text-gray-400 text-xs",children:"-"});const d=new Date(a),m=Math.floor((new Date().getTime()-d.getTime())/(1e3*60*60*24));return e.jsx("span",{className:`text-xs ${m>30?"text-red-600":m>7?"text-yellow-600":"text-green-600"}`,children:m===0?"היום":m===1?"אתמול":`לפני ${m} ימים`})}},{key:"actions",header:"פעולות",align:"center",width:M?"120px":"140px"}];return h?e.jsx("div",{className:"flex items-center justify-center min-h-96",children:e.jsxs("div",{className:"text-center",children:[e.jsx(W,{className:"w-8 h-8 animate-spin mx-auto mb-4 text-primary-600"}),e.jsx("div",{className:"text-lg text-gray-600",children:"טוען תלמידים..."})]})}):j?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"text-red-600 text-lg mb-4",children:"❌ שגיאה בטעינת הנתונים"}),e.jsx("div",{className:"text-gray-600 mb-6",children:j}),e.jsx("button",{onClick:B,className:"px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600",children:"נסה שוב"})]}):e.jsxs("div",{className:"relative",children:[Te&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:Re?e.jsxs("div",{className:"p-8 text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"טוען נתוני תלמיד..."})]}):e.jsx(ms,{onSubmit:Xe,onCancel:qe,isEdit:!!U,initialData:ie})})}),e.jsx(H,{className:"mb-6",padding:"md",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(ws,{className:"absolute right-3 top-3 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"חיפוש תלמידים...",value:b,onChange:s=>_(s.target.value),className:"w-full pr-10 pl-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900 placeholder-gray-500"})]})}),e.jsxs("div",{className:"flex gap-3 flex-wrap",children:[e.jsxs("select",{value:o.orchestra,onChange:s=>V(a=>({...a,orchestra:s.target.value})),className:"px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900",children:[e.jsx("option",{value:"",children:"כל התזמורות"}),e.jsx("option",{value:"תזמורת",children:"תזמורת"}),e.jsx("option",{value:"ללא תזמורת",children:"ללא תזמורת"})]}),e.jsxs("select",{value:o.instrument,onChange:s=>V(a=>({...a,instrument:s.target.value})),className:"px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900",children:[e.jsx("option",{value:"",children:"כל הכלים"}),e.jsx("option",{value:"חלילית",children:"חלילית"}),e.jsx("option",{value:"חליל צד",children:"חליל צד"}),e.jsx("option",{value:"אבוב",children:"אבוב"}),e.jsx("option",{value:"בסון",children:"בסון"}),e.jsx("option",{value:"סקסופון",children:"סקסופון"}),e.jsx("option",{value:"קלרינט",children:"קלרינט"}),e.jsx("option",{value:"חצוצרה",children:"חצוצרה"}),e.jsx("option",{value:"קרן יער",children:"קרן יער"}),e.jsx("option",{value:"טרומבון",children:"טרומבון"}),e.jsx("option",{value:"טובה/בריטון",children:"טובה/בריטון"}),e.jsx("option",{value:"שירה",children:"שירה"}),e.jsx("option",{value:"כינור",children:"כינור"}),e.jsx("option",{value:"ויולה",children:"ויולה"}),e.jsx("option",{value:"צ'לו",children:"צ'לו"}),e.jsx("option",{value:"קונטרבס",children:"קונטרבס"}),e.jsx("option",{value:"פסנתר",children:"פסנתר"}),e.jsx("option",{value:"גיטרה",children:"גיטרה"}),e.jsx("option",{value:"גיטרה בס",children:"גיטרה בס"}),e.jsx("option",{value:"תופים",children:"תופים"})]}),e.jsxs("select",{value:o.stageLevel,onChange:s=>V(a=>({...a,stageLevel:s.target.value})),className:"px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900",children:[e.jsx("option",{value:"",children:"כל השלבים"}),[1,2,3,4,5,6,7,8].map(s=>e.jsxs("option",{value:s,children:["שלב ",s]},s))]}),e.jsxs("button",{onClick:Ge,className:"flex items-center px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors",children:[e.jsx(Ss,{className:"w-4 h-4 ml-2"}),"הוסף תלמיד"]})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6 mb-6",children:[e.jsx(H,{padding:"md",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-3xl font-bold text-primary-600 mb-1",children:he}),e.jsx("div",{className:"text-sm text-gray-600",children:"סה״כ תלמידים"})]})}),e.jsx(H,{padding:"md",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-3xl font-bold text-success-600 mb-1",children:ls}),e.jsx("div",{className:"text-sm text-gray-600",children:"פעילים"})]})}),e.jsx(H,{padding:"md",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-3xl font-bold text-orange-600 mb-1",children:ns}),e.jsx("div",{className:"text-sm text-gray-600",children:"לא פעילים"})]})}),e.jsx(H,{padding:"md",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-3xl font-bold text-purple-600 mb-1",children:is}),e.jsx("div",{className:"text-sm text-gray-600",children:"עם שיעורים"})]})})]}),e.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[e.jsx("div",{className:"text-sm text-gray-600",children:b||o.orchestra||o.instrument||o.stageLevel?e.jsxs("span",{children:["מציג ",g.length," תלמידים מתוך ",he,' סה"כ',p&&e.jsx("span",{className:"text-primary-600 font-medium",children:" (טען עוד לתוצאות נוספות)"})]}):e.jsxs("span",{children:["מציג ",g.length," מתוך ",he," תלמידים",p&&e.jsx("span",{className:"text-primary-600 font-medium",children:" (טען עוד לצפייה בנוספים)"})]})}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("button",{onClick:Ze,className:`flex items-center px-3 py-1 rounded-lg text-xs transition-colors ${M?"bg-gray-500 text-white hover:bg-gray-600":"bg-blue-500 text-white hover:bg-blue-600"}`,title:M?"בטל בחירה מרובה":"הפעל בחירה מרובה",children:[e.jsx(je,{className:"w-3 h-3 ml-1"}),M?"בטל בחירה":"בחירה מרובה"]}),M&&y.size>0&&e.jsxs("button",{onClick:We,className:"flex items-center px-3 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-xs",children:[e.jsx(se,{className:"w-3 h-3 ml-1"}),"מחק נבחרים (",y.size,")"]}),e.jsxs("div",{className:"flex items-center bg-gray-50 p-1 rounded-lg border border-gray-200 shadow-sm",children:[e.jsxs("button",{onClick:()=>ye("table"),className:`relative px-3 py-2 rounded-md text-sm font-medium transition-all duration-200 ease-in-out flex items-center gap-2 ${Y==="table"?"bg-white text-primary-700 shadow-sm border border-gray-200 ring-1 ring-primary-500/20":"text-gray-600 hover:text-gray-800 hover:bg-gray-100/50"}`,"aria-pressed":Y==="table","aria-label":"תצוגת טבלה",children:[e.jsx(Cs,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:"טבלה"}),Y==="table"&&e.jsx("div",{className:"absolute inset-0 rounded-md bg-gradient-to-r from-primary-500/5 to-primary-600/5 pointer-events-none"})]}),e.jsxs("button",{onClick:()=>ye("grid"),className:`relative px-3 py-2 rounded-md text-sm font-medium transition-all duration-200 ease-in-out flex items-center gap-2 ${Y==="grid"?"bg-white text-primary-700 shadow-sm border border-gray-200 ring-1 ring-primary-500/20":"text-gray-600 hover:text-gray-800 hover:bg-gray-100/50"}`,"aria-pressed":Y==="grid","aria-label":"תצוגת רשת",children:[e.jsx(ks,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:"רשת"}),Y==="grid"&&e.jsx("div",{className:"absolute inset-0 rounded-md bg-gradient-to-r from-primary-500/5 to-primary-600/5 pointer-events-none"})]})]})]})]}),e.jsxs("div",{className:"relative",children:[N&&e.jsx("div",{className:"absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-10 rounded-lg",children:e.jsxs("div",{className:"text-center",children:[e.jsx(W,{className:"w-6 h-6 animate-spin mx-auto mb-2 text-primary-600"}),e.jsx("div",{className:"text-sm text-gray-600",children:"מחפש תלמידים..."})]})}),Y==="table"?e.jsx(gs,{columns:cs,data:R,onRowClick:s=>{if(M){const a=new Set(y);a.has(s.id)?a.delete(s.id):a.add(s.id),E(a)}else xe(s.id)},rowClassName:s=>{const a=y.has(s.id);return hs("cursor-pointer transition-all duration-150",a?"bg-blue-50 hover:bg-blue-100 border-l-4 border-blue-500":"hover:bg-gray-50")}}):e.jsxs("div",{children:[M&&e.jsx("div",{className:"mb-4 p-3 bg-gray-50 rounded-lg border border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",checked:y.size===R.length&&R.length>0,onChange:s=>{s.target.checked?E(new Set(R.map(a=>a.id))):E(new Set)},className:"w-4 h-4 text-blue-600 bg-white border-2 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"}),e.jsxs("span",{className:"text-sm font-medium text-gray-700",children:["בחר הכל (",R.length," תלמידים)"]})]}),y.size>0&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsxs("span",{children:["נבחרו: ",y.size]}),e.jsx("button",{onClick:()=>E(new Set),className:"text-blue-600 hover:text-blue-800 underline",children:"נקה בחירה"})]})]})}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6",children:R.map(s=>e.jsx(Ds,{student:s.originalStudent,showInstruments:!0,showTeacherAssignments:!0,showParentContact:!1,onClick:()=>{M?Le(s.id,!y.has(s.id)):xe(s.id)},onDelete:ke,className:"h-full hover:shadow-lg transition-all duration-200 hover:scale-[1.02] hover:-translate-y-1",isSelectMode:M,isSelected:y.has(s.id),onSelectionChange:Le},s.id))})]}),R.length===0&&!h&&!N&&e.jsx("div",{className:"text-center py-12 text-gray-500",children:"לא נמצאו תלמידים התואמים לחיפוש"})]}),p&&R.length>0&&!h&&e.jsx("div",{className:"flex justify-center mt-8 mb-6",children:e.jsx("button",{onClick:rs,disabled:c,className:"flex items-center gap-2 px-6 py-3 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed shadow-md hover:shadow-lg",children:c?e.jsxs(e.Fragment,{children:[e.jsx(W,{className:"w-5 h-5 animate-spin"}),e.jsx("span",{children:"טוען עוד תלמידים..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ls,{className:"w-5 h-5"}),e.jsx("span",{children:"טען עוד תלמידים"})]})})}),e.jsx(ue,{isOpen:Ee,title:"מחיקת תלמיד",message:`האם אתה בטוח שברצונך למחוק את התלמיד ${Z?.name}? פעולה זו לא ניתנת לביטול.`,confirmText:"מחק",cancelText:"ביטול",onConfirm:Qe,onCancel:es,variant:"danger"}),e.jsx(ue,{isOpen:!!z,title:"עדכון שלב התלמיד",message:z?`האם אתה בטוח שברצונך לשנות את שלב התלמיד "${z.studentName}" משלב ${z.currentLevel} לשלב ${z.newLevel}?`:"",confirmText:"עדכן שלב",cancelText:"ביטול",onConfirm:ts,onCancel:as,variant:"primary"}),e.jsx(As,{isOpen:Ue,studentId:Z?.id||"",studentName:Z?.name||"",onClose:()=>de(!1),onConfirm:Je}),e.jsx(Ts,{isOpen:Oe,preview:_e,onClose:()=>ze(!1)}),e.jsx(Rs,{isOpen:Be,selectedStudentIds:Array.from(y),onClose:()=>me(!1),onComplete:()=>{me(!1),E(new Set),Se(!1),B(1,!1)}})]})}export{Hs as default};
