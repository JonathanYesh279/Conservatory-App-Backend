var Fe=Object.defineProperty;var Qe=(o,t,s)=>t in o?Fe(o,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):o[t]=s;var Ce=(o,t,s)=>Qe(o,typeof t!="symbol"?t+"":t,s);import{u as Te,j as e,a as ze}from"../assets/index-CshNMQn7.js";import{r as g,b as Ie}from"./vendor-B2j9q2e_.js";import{S as be}from"./StatsCard-Df_vv_Z7.js";import{C as pe}from"./Card-CWQjLmWC.js";import{a as B}from"./cascade-deletion-pmc3scKx.js";import{w as he,M as xe,f as ue,x as Ke,y as Le,G as Z,z as $e,b as ee,r as le,D as Ve,p as Me,E as ie,V as Ye,e as Xe,I as Ze,J as et,q as tt,K as Ee,A as st,X as at,d as ve,P as Ue,B as me,N as rt,O as nt,u as lt,o as it,Q as ot,t as Oe,W as ct,Y as Pe}from"./ui-26XYoSED.js";import{f as Be,s as dt,e as mt}from"./utils-Cgyyg58q.js";import"./query-BI61muSV.js";function ht(){const{user:o}=Te(),[t,s]=g.useState({totalOrchestras:0,activeMusicians:0,upcomingRehearsals:0,completedConcerts:0,totalMembers:0,weeklyRehearsals:0,bagrutMembers:0,activeBagrutStudents:0}),[r,i]=g.useState([]),[b,j]=g.useState([]),[E,Q]=g.useState([]),[O,q]=g.useState([]),[z,J]=g.useState(!0),[K,G]=g.useState(null);g.useEffect(()=>{o?._id&&x()},[o]);const x=async()=>{try{J(!0),G(null);const a=o._id,[k]=await Promise.all([B.teachers.getTeacher(a)]);if(!k)throw new Error("לא נמצא פרופיל מנצח");const $=k?.conducting?.orchestraIds||[];let N=[],M=0,I=[];if($.length>0){N=await B.orchestras.getBatchOrchestras($),M=N.reduce((d,n)=>d+(n.memberCount||0),0);try{const d=await B.rehearsals.getRehearsals({groupIds:$.join(","),limit:100});I=Array.isArray(d)?d:[]}catch(d){console.warn("Error loading rehearsals:",d),I=[]}}const U=new Date,H=new Date(U.getTime()+7*24*60*60*1e3),V=I.filter(d=>{const n=new Date(d.scheduledDate);return n>=U&&n<=H}).slice(0,5).map(d=>{const n=N.find(f=>f._id===d.groupId);return{id:d._id,orchestraName:n?.name||"תזמורת",date:new Date(d.scheduledDate).toLocaleDateString("he-IL"),time:d.startTime||"19:00",location:d.location||"אולם מוזיקה",attendanceRate:Math.floor(Math.random()*20)+80,duration:120,status:"scheduled"}});i(V);const Y=I.filter(d=>{const n=new Date(d.scheduledDate),f=new Date(U);f.setDate(U.getDate()-U.getDay());const C=new Date(f);return C.setDate(f.getDate()+6),n>=f&&n<=C}).length;let _=[],te=0,se=0;if(N.length>0){const d=N.flatMap(n=>n?.members?.map(f=>f.studentId)||[]);if(d.length>0)try{const[n,f]=await Promise.all([Promise.all(d.map(C=>B.bagrut.getBagrutByStudent(C).catch(()=>null))).then(C=>C.filter(Boolean)),B.students.getBatchStudents(d)]);_=d.map(C=>{const ge=f.find(y=>y._id===C),T=n.find(y=>y.studentId===C),fe=N.flatMap(y=>y.members||[]).find(y=>y.studentId===C),Se=N.find(y=>y.members?.some(R=>R.studentId===C));let X="none",l,w,F;if(T){const y=T.presentations?.filter(R=>R.completed).length||0;if(l=y+1,w=y/4*100,T.isCompleted&&T.finalGrade&&T.finalGrade>=55?X="completed":T.isCompleted&&T.finalGrade&&T.finalGrade<55?X="none":y===0?X="pending":X="active",X==="active"){const R=new Date,A=Math.floor(Math.random()*30)+7;F=new Date(R),F.setDate(R.getDate()+A)}}return{studentId:C,studentName:ge?.personalInfo?.fullName||"תלמיד לא ידוע",instrument:fe?.instrument||ge?.academicInfo?.primaryInstrument||"לא צוין",section:fe?.section||"לא צוין",bagrutStatus:X,stage:l,progress:w,nextExamDate:F,orchestraName:Se?.name||"תזמורת"}}),te=_.filter(C=>C.bagrutStatus!=="none").length,se=_.filter(C=>C.bagrutStatus==="active").length}catch(n){console.warn("Error loading Bagrut data:",n)}}q(_);const S={totalOrchestras:N.length,activeMusicians:M,upcomingRehearsals:V.length,completedConcerts:Math.floor(Math.random()*5)+2,totalMembers:M,weeklyRehearsals:Y,bagrutMembers:te,activeBagrutStudents:se};s(S);const ae=N.map(d=>{const n=I.filter(C=>C.groupId===d._id),f=Math.floor(Math.random()*20)+80;return{orchestraId:d._id,orchestraName:d.name,totalRehearsals:n.length,averageAttendance:f,upcomingConcerts:Math.floor(Math.random()*3)+1,lastRehearsal:n.length>0?new Date(n[n.length-1].scheduledDate).toLocaleDateString("he-IL"):"אין נתונים",status:f>=90?"excellent":f>=75?"good":"needs_attention"}});Q(ae);const m=[];I.slice(0,3).forEach(d=>{const n=N.find(f=>f._id===d.groupId);m.push({id:`rehearsal-${d._id}`,type:"rehearsal",title:"חזרה הושלמה",description:`חזרה של ${n?.name||"תזמורת"} - ${d.location||"אולם מוזיקה"}`,timestamp:new Date(Date.now()-Math.random()*864e5).toISOString(),orchestraName:n?.name})}),N.slice(0,2).forEach(d=>{m.push({id:`enrollment-${d._id}`,type:"enrollment",title:"רישום חדש",description:`תלמיד חדש הצטרף ל${d.name}`,timestamp:new Date(Date.now()-Math.random()*1728e5).toISOString(),orchestraName:d.name})}),j(m.sort((d,n)=>new Date(n.timestamp).getTime()-new Date(d.timestamp).getTime()))}catch(a){console.error("Error loading conductor dashboard data:",a),G("שגיאה בטעינת נתוני לוח הבקרה")}finally{J(!1)}},v=Ie(),P=a=>{switch(a){case"scheduleRehearsal":v("/profile",{state:{activeTab:"orchestras"}});break;case"markAttendance":v("/profile",{state:{activeTab:"orchestras"}});break;case"manageOrchestras":v("/profile",{state:{activeTab:"orchestras"}});break;case"viewMusicians":v("/profile",{state:{activeTab:"orchestras"}});break;default:console.log("Action:",a)}},c=a=>{const k=new Date(a),N=new Date().getTime()-k.getTime(),M=Math.floor(N/(1e3*60*60));return M<1?`לפני ${Math.floor(N/6e4)} דקות`:M<24?`לפני ${M} שעות`:`לפני ${Math.floor(M/24)} ימים`};return z?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600 font-reisinger-yonatan",children:"טוען לוח בקרה למנצח..."})]})}):K?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-6 max-w-md",children:e.jsxs("div",{className:"text-red-800 font-reisinger-yonatan text-center",children:[e.jsx(he,{className:"w-12 h-12 mx-auto mb-4 text-red-600"}),e.jsx("h3",{className:"text-lg font-bold mb-2",children:K}),e.jsx("button",{onClick:x,className:"mt-4 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700",children:"נסה שוב"})]})})}):e.jsx("div",{className:"min-h-screen bg-gray-50 py-8",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 font-reisinger-yonatan",children:["שלום מנצח ",o?.firstName||"יקר"," 🎼"]}),e.jsx("p",{className:"text-gray-600 mt-2",children:new Date().toLocaleDateString("he-IL",{weekday:"long",year:"numeric",month:"long",day:"numeric"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-6 mb-8",children:[e.jsx(ce,{icon:e.jsx(xe,{className:"w-6 h-6"}),title:"סה״כ תזמורות",value:t.totalOrchestras,bgColor:"bg-blue-50",iconColor:"text-blue-600",borderColor:"border-blue-200"}),e.jsx(ce,{icon:e.jsx(ue,{className:"w-6 h-6"}),title:"מוזיקאים פעילים",value:t.activeMusicians,bgColor:"bg-green-50",iconColor:"text-green-600",borderColor:"border-green-200"}),e.jsx(ce,{icon:e.jsx(Ke,{className:"w-6 h-6"}),title:"חזרות השבוע",value:t.weeklyRehearsals,bgColor:"bg-purple-50",iconColor:"text-purple-600",borderColor:"border-purple-200"}),e.jsx(ce,{icon:e.jsx(Le,{className:"w-6 h-6"}),title:"קונצרטים השנה",value:t.completedConcerts,bgColor:"bg-yellow-50",iconColor:"text-yellow-600",borderColor:"border-yellow-200"}),e.jsx(ce,{icon:e.jsx(Z,{className:"w-6 h-6"}),title:"חברי בגרות",value:t.bagrutMembers,bgColor:"bg-indigo-50",iconColor:"text-indigo-600",borderColor:"border-indigo-200"}),e.jsx(ce,{icon:e.jsx($e,{className:"w-6 h-6"}),title:"בגרות פעילה",value:t.activeBagrutStudents,bgColor:"bg-orange-50",iconColor:"text-orange-600",borderColor:"border-orange-200"})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900 mb-4 font-reisinger-yonatan",children:"פעולות מהירות"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(je,{icon:e.jsx(ee,{className:"w-5 h-5"}),label:"קבע חזרה",onClick:()=>P("scheduleRehearsal"),color:"indigo"}),e.jsx(je,{icon:e.jsx(le,{className:"w-5 h-5"}),label:"סמן נוכחות",onClick:()=>P("markAttendance"),color:"green"}),e.jsx(je,{icon:e.jsx(Ve,{className:"w-5 h-5"}),label:"נהל תזמורות",onClick:()=>P("manageOrchestras"),color:"blue"}),e.jsx(je,{icon:e.jsx(Me,{className:"w-5 h-5"}),label:"צפה במוזיקאים",onClick:()=>P("viewMusicians"),color:"purple"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900 font-reisinger-yonatan",children:"החזרות הקרובות"}),e.jsxs("button",{onClick:()=>v("/profile",{state:{activeTab:"orchestras"}}),className:"text-indigo-600 hover:text-indigo-700 text-sm font-medium flex items-center gap-1",children:["צפה בכל",e.jsx(ie,{className:"w-4 h-4"})]})]}),r.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(ee,{className:"w-12 h-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"font-reisinger-yonatan",children:"אין חזרות מתוכננות השבוע"})]}):e.jsx("div",{className:"space-y-3",children:r.map(a=>e.jsxs("div",{className:"flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center",children:e.jsx(Ye,{className:"w-6 h-6 text-indigo-600"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900 font-reisinger-yonatan",children:a.orchestraName}),e.jsxs("div",{className:"text-sm text-gray-600 flex items-center gap-2",children:[e.jsx(Xe,{className:"w-3 h-3"}),a.location]}),a.attendanceRate&&e.jsxs("div",{className:"text-xs text-gray-500",children:["נוכחות ממוצעת: ",a.attendanceRate,"%"]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-medium text-gray-900",children:a.date}),e.jsx("div",{className:"text-sm text-gray-600",children:a.time}),e.jsxs("div",{className:"text-xs text-gray-500",children:[e.jsx(Ze,{className:"w-3 h-3 inline mr-1"}),a.duration," דקות"]})]})]},a.id))})]}),O.length>0&&e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900 font-reisinger-yonatan",children:"חברי תזמורת עם בגרות"}),e.jsx(Z,{className:"w-5 h-5 text-gray-400"})]}),e.jsxs("div",{className:"grid grid-cols-4 gap-4 mb-6",children:[e.jsxs("div",{className:"text-center p-3 bg-blue-50 rounded-lg",children:[e.jsx("div",{className:"text-xl font-bold text-blue-600",children:O.filter(a=>a.bagrutStatus==="active").length}),e.jsx("div",{className:"text-sm text-gray-600",children:"בגרות פעילה"})]}),e.jsxs("div",{className:"text-center p-3 bg-green-50 rounded-lg",children:[e.jsx("div",{className:"text-xl font-bold text-green-600",children:O.filter(a=>a.bagrutStatus==="completed").length}),e.jsx("div",{className:"text-sm text-gray-600",children:"הושלמה"})]}),e.jsxs("div",{className:"text-center p-3 bg-yellow-50 rounded-lg",children:[e.jsx("div",{className:"text-xl font-bold text-yellow-600",children:O.filter(a=>a.bagrutStatus==="pending").length}),e.jsx("div",{className:"text-sm text-gray-600",children:"ממתינים"})]}),e.jsxs("div",{className:"text-center p-3 bg-gray-50 rounded-lg",children:[e.jsx("div",{className:"text-xl font-bold text-gray-600",children:O.filter(a=>a.bagrutStatus==="none").length}),e.jsx("div",{className:"text-sm text-gray-600",children:"ללא בגרות"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:"תלמידי בגרות פעילים"}),O.filter(a=>a.bagrutStatus==="active").slice(0,5).map(a=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center",children:e.jsx(xe,{className:"w-4 h-4 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:a.studentName}),e.jsxs("div",{className:"text-sm text-gray-600",children:[a.instrument," • ",a.section," • ",a.orchestraName]})]})]}),e.jsxs("div",{className:"text-right",children:[a.stage&&e.jsxs("div",{className:"text-sm font-medium text-gray-900 mb-1",children:["השמעה ",a.stage,"/4"]}),a.progress!==void 0&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-16 bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-600 h-2 rounded-full",style:{width:`${a.progress}%`}})}),e.jsxs("span",{className:"text-xs text-gray-500",children:[Math.round(a.progress),"%"]})]}),a.nextExamDate&&e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["מבחן הבא: ",a.nextExamDate.toLocaleDateString("he-IL")]}),e.jsx("button",{className:"mt-2 p-1 text-gray-400 hover:text-blue-600",children:e.jsx(et,{className:"w-4 h-4"})})]})]},a.studentId)),O.filter(a=>a.bagrutStatus==="active").length>5&&e.jsx("div",{className:"text-center pt-2",children:e.jsxs("button",{onClick:()=>window.location.href="/teacher/bagrut",className:"text-blue-600 hover:text-blue-700 text-sm font-medium",children:["צפה בכל תלמידי הבגרות (",O.filter(a=>a.bagrutStatus==="active").length,")"]})})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900 font-reisinger-yonatan",children:"ביצועי תזמורות"}),e.jsxs("button",{onClick:()=>v("/profile",{state:{activeTab:"orchestras"}}),className:"text-indigo-600 hover:text-indigo-700 text-sm font-medium flex items-center gap-1",children:["דוח מפורט",e.jsx(ie,{className:"w-4 h-4"})]})]}),E.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(tt,{className:"w-12 h-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"font-reisinger-yonatan",children:"אין נתוני ביצועים"})]}):e.jsx("div",{className:"space-y-3",children:E.map(a=>e.jsxs("div",{className:"flex items-center justify-between p-3 border border-gray-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${a.status==="excellent"?"bg-green-500":a.status==="good"?"bg-yellow-500":"bg-red-500"}`}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900 font-reisinger-yonatan",children:a.orchestraName}),e.jsxs("div",{className:"text-sm text-gray-600",children:[a.totalRehearsals," חזרות השנה • חזרה אחרונה: ",a.lastRehearsal]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx($e,{className:"w-4 h-4 text-gray-400"}),e.jsxs("span",{className:`font-medium ${a.averageAttendance>=90?"text-green-600":a.averageAttendance>=75?"text-yellow-600":"text-red-600"}`,children:[a.averageAttendance,"%"]})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"נוכחות ממוצעת"})]})]},a.orchestraId))})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900 font-reisinger-yonatan",children:"פעילות אחרונה"}),e.jsx(Ee,{className:"w-5 h-5 text-gray-400"})]}),b.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(he,{className:"w-12 h-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"font-reisinger-yonatan",children:"אין פעילות לאחרונה"})]}):e.jsx("div",{className:"space-y-4",children:b.map(a=>e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("div",{className:`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${a.type==="rehearsal"?"bg-blue-100":a.type==="enrollment"?"bg-green-100":a.type==="performance"?"bg-purple-100":"bg-yellow-100"}`,children:[a.type==="rehearsal"&&e.jsx(xe,{className:"w-4 h-4 text-blue-600"}),a.type==="enrollment"&&e.jsx(Me,{className:"w-4 h-4 text-green-600"}),a.type==="performance"&&e.jsx(Le,{className:"w-4 h-4 text-purple-600"}),a.type==="attendance"&&e.jsx(le,{className:"w-4 h-4 text-yellow-600"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 font-reisinger-yonatan",children:a.title}),e.jsx("p",{className:"text-sm text-gray-600 truncate font-reisinger-yonatan",children:a.description}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:c(a.timestamp)})]})]},a.id))})]})]})]})})}function ce({icon:o,title:t,value:s,suffix:r,bgColor:i,iconColor:b,borderColor:j}){return e.jsx("div",{className:`${i} border ${j} rounded-lg p-6`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-700 font-reisinger-yonatan",children:t}),e.jsxs("p",{className:"text-2xl font-bold text-gray-900 mt-2",children:[s," ",r&&e.jsx("span",{className:"text-lg font-normal",children:r})]})]}),e.jsx("div",{className:`${b}`,children:o})]})})}function je({icon:o,label:t,onClick:s,color:r}){const i={indigo:"bg-indigo-50 text-indigo-600 hover:bg-indigo-100 border-indigo-200",green:"bg-green-50 text-green-600 hover:bg-green-100 border-green-200",blue:"bg-blue-50 text-blue-600 hover:bg-blue-100 border-blue-200",purple:"bg-purple-50 text-purple-600 hover:bg-purple-100 border-purple-200"};return e.jsxs("button",{onClick:s,className:`flex flex-col items-center justify-center p-4 rounded-lg border transition-colors ${i[r]}`,children:[o,e.jsx("span",{className:"mt-2 text-sm font-medium font-reisinger-yonatan",children:t})]})}const _e={BASE_URL:"/api",TIMEOUT:3e4};class gt{constructor(){Ce(this,"baseURL");Ce(this,"token");this.baseURL=_e.BASE_URL,this.token=this.getStoredToken()}getStoredToken(){return localStorage.getItem("authToken")||sessionStorage.getItem("authToken")}getHeaders(){const t={"Content-Type":"application/json"};return this.token&&(t.Authorization=`Bearer ${this.token}`),t}async handleResponse(t){const s=t.headers.get("content-type");let r;if(s?.includes("application/json")?r=await t.json():r=await t.text(),!t.ok){const i={code:this.getErrorCode(t.status),message:this.getErrorMessage(t.status,r),details:r,status:t.status};throw r?.code==="DUPLICATE_TEACHER_DETECTED"&&(i.code="DUPLICATE_TEACHER_DETECTED",i.duplicateInfo=r.duplicateInfo),i}return r}getErrorCode(t){switch(t){case 401:return"UNAUTHORIZED";case 403:return"FORBIDDEN";case 404:return"NOT_FOUND";case 422:return"VALIDATION_ERROR";case 500:case 502:case 503:return"SERVER_ERROR";default:return"NETWORK_ERROR"}}getErrorMessage(t,s){const r={401:"נדרשת התחברות מחדש למערכת",403:"אין הרשאה לצפייה בתוכן זה",404:"המורה המבוקש לא נמצא",422:"נתונים לא תקינים",500:"שגיאת שרת פנימית",502:"השרת אינו זמין כרגע",503:"השירות אינו זמין כרגע"};return s?.message||r[t]||"שגיאה לא צפויה"}async request(t,s={}){const r=`${this.baseURL}${t}`,i={...s,headers:{...this.getHeaders(),...s.headers},signal:AbortSignal.timeout(_e.TIMEOUT)};try{const b=await fetch(r,i);return await this.handleResponse(b)}catch(b){if(b instanceof Error){if(b.name==="AbortError")throw{code:"NETWORK_ERROR",message:"הבקשה נכשלה - פג זמן ההמתנה",details:{timeout:!0}};if(b.message.includes("Failed to fetch"))throw{code:"NETWORK_ERROR",message:"לא ניתן להתחבר לשרת. בדוק את החיבור לאינטרנט",details:{networkError:!0}}}throw b}}async getTeacherDetails(t){return this.request(`/teacher/${t}`)}async getAllTeachers(t){const s=new URLSearchParams;t&&Object.keys(t).forEach(i=>{t[i]!==void 0&&t[i]!==null&&s.append(i,t[i].toString())});const r=s.toString();return this.request(`/teacher${r?"?"+r:""}`)}async getTeacherIds(){return this.request("/teacher/ids")}async getTeachersByRole(t){return this.request(`/teacher/role/${t}`)}async getTeacherStudents(t){const r=(await this.getTeacherDetails(t)).teaching?.studentIds||[];if(r.length===0)return[];const i=r.map(async j=>{try{return await this.request(`/student/${j}`)}catch(E){return console.warn(`Failed to fetch student ${j}:`,E),null}});return(await Promise.allSettled(i)).filter(j=>j.status==="fulfilled"&&j.value!==null).map(j=>j.value)}async updateTeacherSchedule(t,s){return this.request(`/teacher/${t}/schedule`,{method:"POST",body:JSON.stringify(s)})}async addStudentToTeacher(t,s){return this.request(`/teacher/${t}/student/${s}`,{method:"POST"})}async removeStudentFromTeacher(t,s){return this.request(`/teacher/${t}/student/${s}`,{method:"DELETE"})}async updateTeacherPersonalInfo(t,s){return this.request(`/teacher/${t}`,{method:"PUT",body:JSON.stringify({personalInfo:s})})}async updateTeacherProfessionalInfo(t,s){return this.request(`/teacher/${t}`,{method:"PUT",body:JSON.stringify({professionalInfo:s})})}async updateTeacherTimeBlocks(t,s){return this.request(`/teacher/${t}`,{method:"PUT",body:JSON.stringify({timeBlocks:s})})}async createTeacher(t,s){return this.request("/teacher",{method:"POST",body:JSON.stringify({...t,adminId:s})})}async deactivateTeacher(t){return this.request(`/teacher/${t}`,{method:"DELETE"})}async getTeacherStatistics(t,s){const r=new URLSearchParams;s&&(r.append("from",Be(s.from,"yyyy-MM-dd")),r.append("to",Be(s.to,"yyyy-MM-dd")));const i=r.toString();return this.request(`/analytics/teacher/${t}${i?"?"+i:""}`)}async checkScheduleAvailability(t,s,r,i){return this.request(`/teacher/${t}/availability`,{method:"POST",body:JSON.stringify({day:s,startTime:r,duration:i})})}async addTimeBlock(t,s){return this.request(`/teacher/${t}/timeblock`,{method:"POST",body:JSON.stringify(s)})}async updateTimeBlock(t,s,r){return this.request(`/teacher/${t}/timeblock/${s}`,{method:"PUT",body:JSON.stringify(r)})}async removeTimeBlock(t,s){return this.request(`/teacher/${t}/timeblock/${s}`,{method:"DELETE"})}}new gt;class xt{static transformHebrewDates(t){if(!t)return t;if(typeof t=="string"&&/^\d{4}-\d{2}-\d{2}/.test(t))return new Date(t);if(Array.isArray(t))return t.map(s=>this.transformHebrewDates(s));if(typeof t=="object"){const s={...t};for(const r in s)r.includes("Date")||r.includes("date")||r==="createdAt"||r==="updatedAt"?s[r]=this.transformHebrewDates(s[r]):typeof s[r]=="object"&&(s[r]=this.transformHebrewDates(s[r]));return s}return t}static formatPhoneNumber(t){if(!t)return"";const s=t.replace(/\D/g,"");return s.length===10&&s.startsWith("05")?`${s.slice(0,3)}-${s.slice(3,6)}-${s.slice(6)}`:s.length===9&&s.startsWith("5")?`05${s.slice(1,2)}-${s.slice(2,5)}-${s.slice(5)}`:t}static calculateTeachingHours(t){return!t||t.length===0?0:t.reduce((s,r)=>s+(r.duration||0),0)/60}static getActiveStudentCount(t){return t?t.length:0}static formatTimeBlock(t){return t?`${t.day} ${t.startTime}-${t.endTime} (${t.location||"ללא מיקום"})`:""}static checkTimeBlockConflict(t,s){return!t||t.length===0?!1:t.some(r=>{if(r.day!==s.day)return!1;const i=this.timeToMinutes(r.startTime),b=this.timeToMinutes(r.endTime),j=this.timeToMinutes(s.startTime),E=this.timeToMinutes(s.endTime);return j<b&&i<E})}static timeToMinutes(t){if(!t)return 0;const[s,r]=t.split(":").map(Number);return s*60+r}static minutesToTime(t){const s=Math.floor(t/60),r=t%60;return`${s.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`}static getWeekRange(t=new Date){return{start:dt(t,{weekStartsOn:0}),end:mt(t,{weekStartsOn:0})}}static safeParseJson(t,s){try{return JSON.parse(t)}catch{return s}}static handleNullUndefined(t,s){return t??s}static validateEmail(t){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)}static validatePhoneNumber(t){const s=t.replace(/\D/g,"");return s.length===10&&s.startsWith("05")}static generateTimeSlots(t,s,r){const i=[],b=this.timeToMinutes(t),j=this.timeToMinutes(s);for(let E=b;E<j;E+=r)i.push(this.minutesToTime(E));return i}static isWorkingDay(t){return["ראשון","שני","שלישי","רביעי","חמישי"].includes(t)}static sortTimeBlocks(t){const s=["ראשון","שני","שלישי","רביעי","חמישי","שישי","שבת"];return t.sort((r,i)=>{const b=s.indexOf(r.day)-s.indexOf(i.day);return b!==0?b:this.timeToMinutes(r.startTime)-this.timeToMinutes(i.startTime)})}}function ut(){const{user:o}=Te(),t=Ie(),[s,r]=g.useState({totalStudents:0,todaysLessons:0,weeklyHours:0,activeBagrutStudents:0}),[i,b]=g.useState([]),[j,E]=g.useState([]),[Q,O]=g.useState([]),[q,z]=g.useState([]),[J,K]=g.useState(!0),[G,x]=g.useState(null),[v,P]=g.useState(!1),[c,a]=g.useState(!1),[k,$]=g.useState(!1),[N,M]=g.useState([]),[I,U]=g.useState([]),[H,V]=g.useState(null),[Y,_]=g.useState([]),[te,se]=g.useState([]),[S,ae]=g.useState([]),[m,d]=g.useState({days:[]});g.useEffect(()=>{o?._id&&n()},[o]),g.useEffect(()=>{o?._id&&S.length>=0&&ge()},[o,S]),g.useEffect(()=>{if(H){const l=setTimeout(()=>V(null),4e3);return()=>clearTimeout(l)}},[H]);const n=()=>{const l=o?.roles||[],w=o?.role,F=o?.allRoles||[];let y=[...l];w&&!y.includes(w)&&y.push(w),y=[...new Set([...y,...F])];const R=y.map(A=>{const L=A?.toLowerCase();return L==="conductor"||L==="מנצח"?"conductor":L==="theory-teacher"||L==="מורה תיאוריה"||L==="theory teacher"?"theory-teacher":L==="teacher"||L==="מורה"?"teacher":A});ae([...new Set(R)])},f=async l=>{try{const w=await xt.getTransformedWeeklySchedule(l);if(w)return d(w),w}catch(w){console.log("Error loading weekly schedule:",w)}return C()},C=()=>({days:["ראשון","שני","שלישי","רביעי","חמישי","שישי","שבת"].map(w=>({dayName:w,lessons:[]}))}),ge=async()=>{try{K(!0),x(null);const l=o._id,[w,F]=await Promise.all([B.teachers.getMyProfile(),f(l)]);if(!w)throw new Error("לא נמצא פרופיל מורה");console.log("Teacher profile loaded:",{name:w?.personalInfo?.fullName,studentIds:w?.teaching?.studentIds,studentCount:w?.teaching?.studentIds?.length||0,timeBlocks:w?.teaching?.timeBlocks?.length||0});const y=w?.teaching?.studentIds||[],R=w?.teaching?.timeBlocks||[];M(R);let A=[];if(y.length>0){console.log("🎯 Teacher assigned student IDs:",y);const h=await B.students.getBatchStudents(y);if(console.log(`📊 API returned ${h.length} students for ${y.length} requested IDs`),A=h.filter(D=>{const p=D._id||D.id,u=y.includes(p);return!u&&h.length>y.length&&console.log(`⚠️ Filtering out unassigned student: ${p}`),u}),console.log(`✅ Showing ${A.length} assigned students (filtered from ${h.length})`),A.length<y.length){const D=A.map(u=>u._id||u.id),p=y.filter(u=>!D.includes(u));console.warn("⚠️ Missing students:",p)}}else console.log("No student IDs found in teacher profile");U(A);const L=new Date,ye=["ראשון","שני","שלישי","רביעי","חמישי","שישי","שבת"][L.getDay()],qe=F.days.find(h=>h.dayName===ye)?.lessons.filter(h=>h.lessonType!=="availability").length||0,Ge=F.days.reduce((h,D)=>h+D.lessons.filter(p=>p.lessonType!=="availability").reduce((p,u)=>{const De=new Date(`2000-01-01T${u.startTime}`),ne=new Date(`2000-01-01T${u.endTime}`);return p+(ne.getTime()-De.getTime())/(1e3*60*60)},0),0);let He=[];if(S.includes("conductor"))try{const D=(await B.orchestras.getOrchestras()).filter(p=>p.conductorId===l);_(D),console.log(`🎼 Loaded ${D.length} orchestras for conductor`)}catch(h){console.log("Error loading orchestras:",h)}if(S.includes("theory-teacher"))try{const h=await B.theory.getTheoryLessons({teacherId:l});se(h||[]),console.log(`📚 Loaded ${h?.length||0} theory lessons`)}catch(h){console.log("Error loading theory lessons:",h)}const Re=He.map(h=>{const D=I.find(oe=>oe._id===h.studentId),p=h.presentations?.filter(oe=>oe.completed).length||0,u=4,De=p/u*100;let ne="active";h.isCompleted&&h.finalGrade&&h.finalGrade>=55?ne="completed":h.isCompleted&&h.finalGrade&&h.finalGrade<55?ne="failed":p===0&&(ne="pending");let ke;if(ne==="active"&&p<4){const oe=new Date,Je=Math.floor(Math.random()*30)+7;ke=new Date(oe),ke.setDate(oe.getDate()+Je)}return{studentId:h.studentId,studentName:D?.personalInfo?.fullName||"תלמיד לא ידוע",instrument:D?.academicInfo?.primaryInstrument||"לא צוין",stage:p+1,progress:De,nextExamDate:ke,status:ne,finalGrade:h.finalGrade,completedPresentations:p,totalPresentations:u,bagrutId:h._id}});z(Re);const We=Re.filter(h=>h.status==="active").length;r({totalStudents:A.length,todaysLessons:qe,weeklyHours:Math.round(Ge*10)/10,activeBagrutStudents:We});let re=[];const Ae=F.days.find(h=>h.dayName===ye);if(Ae){const h=`${L.getHours().toString().padStart(2,"0")}:${L.getMinutes().toString().padStart(2,"0")}`;re=Ae.lessons.filter(p=>p.lessonType!=="availability"&&p.startTime>=h).slice(0,5).map(p=>({id:p.id,studentName:p.studentName||"תלמיד",time:p.startTime,instrument:p.instrument||"",duration:parseInt(p.notes?.match(/\d+/)?.[0]||"60"),type:p.lessonType}))}if(re.length===0&&w?.teaching?.schedule){const h=`${L.getHours().toString().padStart(2,"0")}:${L.getMinutes().toString().padStart(2,"0")}`;re=w.teaching.schedule.filter(u=>u.day===ye).filter(u=>u.startTime>=h).slice(0,5).map(u=>({id:u._id||`lesson-${u.studentId}`,studentName:u.studentName||"תלמיד",time:u.startTime,instrument:u.instrument||"",duration:u.duration||60,type:"individual"}))}if(re.length===0&&A.length>0){const h=`${L.getHours().toString().padStart(2,"0")}:${L.getMinutes().toString().padStart(2,"0")}`;A.forEach(D=>{(D.teacherAssignments?.filter(u=>u.teacherId===o._id&&u.day===ye)||[]).forEach(u=>{u.time&&u.time>=h&&re.push({id:`${D._id}-${u.time}`,studentName:D.personalInfo?.fullName||"תלמיד",time:u.time,instrument:D.academicInfo?.primaryInstrument||u.instrument||"כלי מוזיקה",duration:u.duration||60,type:"individual"})})}),re.sort((D,p)=>D.time.localeCompare(p.time))}b(re.slice(0,5)),E([]),O([])}catch(l){console.error("Error loading dashboard data:",l),x("שגיאה בטעינת נתוני לוח הבקרה")}finally{K(!1)}},T=l=>{switch(console.log("handleQuickAction called with:",l),console.log("Teacher time blocks:",N),l){case"addLesson":console.log("Adding lesson - checking time blocks..."),N.length===0?(console.log("No time blocks found, showing notification"),$(!0)):(console.log("Time blocks found, opening lesson modal"),console.log("Students available for lesson:",I.length,I),a(!0),console.log("Modal state set to true"));break;case"markAttendance":t("/profile",{state:{activeTab:"schedule"}});break;case"viewSchedule":t("/profile",{state:{activeTab:"schedule"}});break;case"manageStudents":t("/profile",{state:{activeTab:"students"}});break;case"manageTeachingDays":P(!0);break;case"viewOrchestras":t("/profile",{state:{activeTab:"orchestras"}});break;case"viewTheoryLessons":t("/profile",{state:{activeTab:"theory-lessons"}});break;case"addOrchestra":t("/orchestras/new");break;case"addTheoryLesson":t("/theory/new");break;case"manageBagrut":window.location.href="/teacher/bagrut";break;case"scheduleBagrutExam":window.location.href="/teacher/bagrut/schedule";break;case"viewBagrutProgress":window.location.href="/teacher/bagrut/progress";break;case"updateBagrutStatus":window.location.href="/teacher/bagrut/update";break;default:console.log("Action:",l)}},fe=l=>{switch(l){case"completed":return"text-green-600 bg-green-50";case"active":return"text-blue-600 bg-blue-50";case"pending":return"text-yellow-600 bg-yellow-50";case"failed":return"text-red-600 bg-red-50";default:return"text-gray-600 bg-gray-50"}},Se=l=>{switch(l){case"completed":return"הושלם";case"active":return"פעיל";case"pending":return"ממתין";case"failed":return"נכשל";default:return"לא ידוע"}},X=l=>{const w=new Date(l),y=new Date().getTime()-w.getTime(),R=Math.floor(y/(1e3*60*60));return R<1?`לפני ${Math.floor(y/6e4)} דקות`:R<24?`לפני ${R} שעות`:`לפני ${Math.floor(R/24)} ימים`};return J?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600 font-reisinger-yonatan",children:"טוען לוח בקרה..."})]})}):G?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-6 max-w-md",children:e.jsxs("div",{className:"text-red-800 font-reisinger-yonatan text-center",children:[e.jsx(he,{className:"w-12 h-12 mx-auto mb-4 text-red-600"}),e.jsx("h3",{className:"text-lg font-bold mb-2",children:G}),e.jsx("button",{onClick:ge,className:"mt-4 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700",children:"נסה שוב"})]})})}):e.jsx("div",{className:"min-h-screen bg-gray-50 py-8",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:[H&&e.jsx("div",{className:`fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${H.type==="success"?"bg-green-100 border border-green-200 text-green-800":"bg-red-100 border border-red-200 text-red-800"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[H.type==="success"?e.jsx(le,{className:"w-5 h-5"}):e.jsx(st,{className:"w-5 h-5"}),e.jsx("span",{className:"font-reisinger-yonatan",children:H.message}),e.jsx("button",{onClick:()=>V(null),className:"ml-2 text-gray-400 hover:text-gray-600",children:e.jsx(at,{className:"w-4 h-4"})})]})}),e.jsxs("div",{className:"mb-8",children:[e.jsx("div",{className:"flex items-center gap-4 mb-4",children:e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 font-reisinger-yonatan",children:["לוח בקרה - ",o?.personalInfo?.fullName||o?.fullName||"מורה"]})}),e.jsxs("p",{className:"text-gray-600 mt-2",children:["שלום ",o?.firstName||"מורה"," • ",new Date().toLocaleDateString("he-IL",{weekday:"long",year:"numeric",month:"long",day:"numeric"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8",children:[e.jsx(Ne,{icon:e.jsx(ue,{className:"w-6 h-6"}),title:"סה״כ תלמידים",value:s.totalStudents,bgColor:"bg-blue-50",iconColor:"text-blue-600",borderColor:"border-blue-200"}),e.jsx(Ne,{icon:e.jsx(ee,{className:"w-6 h-6"}),title:"שיעורים היום",value:s.todaysLessons,bgColor:"bg-green-50",iconColor:"text-green-600",borderColor:"border-green-200"}),e.jsx(Ne,{icon:e.jsx(ve,{className:"w-6 h-6"}),title:"שעות השבוע",value:s.weeklyHours,suffix:"שעות",bgColor:"bg-purple-50",iconColor:"text-purple-600",borderColor:"border-purple-200"}),e.jsx(Ne,{icon:e.jsx(Z,{className:"w-6 h-6"}),title:"תלמידי בגרות פעילים",value:s.activeBagrutStudents,bgColor:"bg-yellow-50",iconColor:"text-yellow-600",borderColor:"border-yellow-200"})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900 mb-4 font-reisinger-yonatan",children:"פעולות מהירות"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(W,{icon:e.jsx(Ue,{className:"w-5 h-5"}),label:"הוסף שיעור",onClick:()=>T("addLesson"),color:"indigo"}),e.jsx(W,{icon:e.jsx(le,{className:"w-5 h-5"}),label:"סמן נוכחות",onClick:()=>T("markAttendance"),color:"green"}),e.jsx(W,{icon:e.jsx(ee,{className:"w-5 h-5"}),label:"צפה בלו״ז",onClick:()=>T("viewSchedule"),color:"blue"}),e.jsx(W,{icon:e.jsx(Me,{className:"w-5 h-5"}),label:"ניהול תלמידים",onClick:()=>T("manageStudents"),color:"purple"}),S.includes("teacher")&&e.jsx(W,{icon:e.jsx(ve,{className:"w-5 h-5"}),label:"ימי לימוד",onClick:()=>T("manageTeachingDays"),color:"orange"}),S.includes("conductor")&&e.jsx(W,{icon:e.jsx(xe,{className:"w-5 h-5"}),label:"התזמורות שלי",onClick:()=>T("viewOrchestras"),color:"rose"}),S.includes("theory-teacher")&&e.jsx(W,{icon:e.jsx(me,{className:"w-5 h-5"}),label:"שיעורי תיאוריה",onClick:()=>T("viewTheoryLessons"),color:"amber"}),q.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(W,{icon:e.jsx(Z,{className:"w-5 h-5"}),label:"ניהול בגרות",onClick:()=>T("manageBagrut"),color:"emerald"}),e.jsx(W,{icon:e.jsx(rt,{className:"w-5 h-5"}),label:"תזמון מבחן",onClick:()=>T("scheduleBagrutExam"),color:"orange"}),e.jsx(W,{icon:e.jsx($e,{className:"w-5 h-5"}),label:"מעקב התקדמות",onClick:()=>T("viewBagrutProgress"),color:"cyan"}),e.jsx(W,{icon:e.jsx(nt,{className:"w-5 h-5"}),label:"עדכון סטטוס",onClick:()=>T("updateBagrutStatus"),color:"pink"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900 font-reisinger-yonatan",children:"השיעורים הבאים"}),e.jsxs("button",{onClick:()=>T("viewSchedule"),className:"text-indigo-600 hover:text-indigo-700 text-sm font-medium flex items-center gap-1",children:["צפה בכל",e.jsx(ie,{className:"w-4 h-4"})]})]}),i.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(ee,{className:"w-12 h-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"font-reisinger-yonatan",children:"אין שיעורים מתוכננים היום"})]}):e.jsx("div",{className:"space-y-3",children:i.map(l=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center",children:e.jsx(ve,{className:"w-5 h-5 text-indigo-600"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900 font-reisinger-yonatan",children:l.studentName}),e.jsx("div",{className:"text-sm text-gray-600",children:l.instrument})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-medium text-gray-900",children:l.time}),e.jsxs("div",{className:"text-xs text-gray-500",children:[l.duration," דקות • ",l.type==="individual"?"פרטני":"קבוצתי"]})]})]},l.id))})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900 font-reisinger-yonatan",children:"סקירת נוכחות"}),e.jsxs("button",{onClick:()=>T("manageStudents"),className:"text-indigo-600 hover:text-indigo-700 text-sm font-medium flex items-center gap-1",children:["צפה בכל",e.jsx(ie,{className:"w-4 h-4"})]})]}),Q.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(ue,{className:"w-12 h-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"font-reisinger-yonatan",children:"אין נתוני נוכחות"})]}):e.jsx("div",{className:"space-y-3",children:Q.map(l=>e.jsxs("div",{className:"flex items-center justify-between p-3 border border-gray-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${l.status==="present"?"bg-green-500":l.status==="late"?"bg-yellow-500":"bg-red-500"}`}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900 font-reisinger-yonatan",children:l.studentName}),e.jsxs("div",{className:"text-sm text-gray-600",children:["שיעור אחרון: ",l.lastLesson]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:`font-medium ${l.attendanceRate>=90?"text-green-600":l.attendanceRate>=75?"text-yellow-600":"text-red-600"}`,children:[l.attendanceRate,"%"]}),e.jsx("div",{className:"text-xs text-gray-500",children:"נוכחות"})]})]},l.studentId))})]}),q.length>0&&e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900 font-reisinger-yonatan",children:"התקדמות תלמידי בגרות"}),e.jsxs("button",{onClick:()=>T("manageBagrut"),className:"text-indigo-600 hover:text-indigo-700 text-sm font-medium flex items-center gap-1 mx-auto",children:["צפה בכל תלמידי הבגרות (",q.length,")",e.jsx(ie,{className:"w-4 h-4"})]})]}),e.jsx("div",{className:"space-y-3",children:q.slice(0,5).map(l=>e.jsxs("div",{className:"flex items-center justify-between p-3 border border-gray-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center",children:e.jsx(Z,{className:"w-4 h-4 text-indigo-600"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900 font-reisinger-yonatan",children:l.studentName}),e.jsx("div",{className:"text-sm text-gray-600",children:l.instrument})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"flex items-center gap-2 mb-1",children:e.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${fe(l.status)}`,children:Se(l.status)})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-16 bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:`h-2 rounded-full ${l.progress>=75?"bg-green-500":l.progress>=50?"bg-yellow-500":"bg-red-500"}`,style:{width:`${l.progress}%`}})}),e.jsxs("span",{className:"text-xs text-gray-600",children:[Math.round(l.progress),"%"]})]})]})]},l.studentId))})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900 font-reisinger-yonatan",children:"פעילות אחרונה"}),e.jsx(Ee,{className:"w-5 h-5 text-gray-400"})]}),j.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(he,{className:"w-12 h-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"font-reisinger-yonatan",children:"אין פעילות לאחרונה"})]}):e.jsx("div",{className:"space-y-4",children:j.map(l=>e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("div",{className:`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${l.type==="lesson"?"bg-blue-100":l.type==="attendance"?"bg-green-100":l.type==="note"?"bg-yellow-100":"bg-purple-100"}`,children:[l.type==="lesson"&&e.jsx(me,{className:"w-4 h-4 text-blue-600"}),l.type==="attendance"&&e.jsx(le,{className:"w-4 h-4 text-green-600"}),l.type==="note"&&e.jsx(lt,{className:"w-4 h-4 text-yellow-600"}),l.type==="grade"&&e.jsx(it,{className:"w-4 h-4 text-purple-600"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 font-reisinger-yonatan",children:l.title}),e.jsx("p",{className:"text-sm text-gray-600 truncate font-reisinger-yonatan",children:l.description}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:X(l.timestamp)})]})]},l.id))})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900 mb-4 font-reisinger-yonatan",children:"נתונים מהירים"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"תלמידים פעילים"}),e.jsx("span",{className:"font-bold text-indigo-600",children:I.filter(l=>l.academicInfo?.isActive!==!1).length})]}),S.includes("conductor")&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"תזמורות"}),e.jsx("span",{className:"font-bold text-purple-600",children:Y.length})]}),S.includes("theory-teacher")&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"שיעורי תיאוריה"}),e.jsx("span",{className:"font-bold text-blue-600",children:te.length})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"שעות השבוע"}),e.jsxs("span",{className:"font-bold text-green-600",children:[s.weeklyHours," שעות"]})]})]})]})]})]})]})})}function Ne({icon:o,title:t,value:s,suffix:r,bgColor:i,iconColor:b,borderColor:j}){return e.jsx("div",{className:`${i} border ${j} rounded-lg p-6`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-700 font-reisinger-yonatan",children:t}),e.jsxs("p",{className:"text-2xl font-bold text-gray-900 mt-2",children:[s," ",r&&e.jsx("span",{className:"text-lg font-normal",children:r})]})]}),e.jsx("div",{className:`${b}`,children:o})]})})}function W({icon:o,label:t,onClick:s,color:r}){const i={indigo:"bg-indigo-50 text-indigo-600 hover:bg-indigo-100 border-indigo-200",green:"bg-green-50 text-green-600 hover:bg-green-100 border-green-200",blue:"bg-blue-50 text-blue-600 hover:bg-blue-100 border-blue-200",purple:"bg-purple-50 text-purple-600 hover:bg-purple-100 border-purple-200",orange:"bg-orange-50 text-orange-600 hover:bg-orange-100 border-orange-200",rose:"bg-rose-50 text-rose-600 hover:bg-rose-100 border-rose-200",amber:"bg-amber-50 text-amber-600 hover:bg-amber-100 border-amber-200",emerald:"bg-emerald-50 text-emerald-600 hover:bg-emerald-100 border-emerald-200",cyan:"bg-cyan-50 text-cyan-600 hover:bg-cyan-100 border-cyan-200",pink:"bg-pink-50 text-pink-600 hover:bg-pink-100 border-pink-200"};return e.jsxs("button",{onClick:s,className:`flex flex-col items-center justify-center p-4 rounded-lg border transition-colors ${i[r]}`,children:[o,e.jsx("span",{className:"mt-2 text-sm font-medium font-reisinger-yonatan text-center",children:t})]})}function ft(){const{user:o}=Te(),[t,s]=g.useState({totalTheoryStudents:0,todaysLessons:0,weeklyTheoryHours:0,upcomingExams:0,activeTheoryGroups:0,pendingGrades:0}),[r,i]=g.useState([]),[b,j]=g.useState([]),[E,Q]=g.useState([]),[O,q]=g.useState(!0),[z,J]=g.useState(null);g.useEffect(()=>{o?._id&&K()},[o]);const K=async()=>{try{q(!0),J(null);const c=o._id,k=(await B.theory.getTheoryLessons()).filter(n=>n.teacherId===c),$=new Date,N=$.toISOString().split("T")[0],M=k.filter(n=>new Date(n.date).toISOString().split("T")[0]===N),I=G(new Date),U=new Date(I);U.setDate(I.getDate()+7);const V=k.filter(n=>{const f=new Date(n.date);return f>=I&&f<U}).reduce((n,f)=>n+(f.duration||90),0)/60,Y=new Set;k.forEach(n=>{n.studentIds&&n.studentIds.length>0&&n.studentIds.forEach(f=>Y.add(f))});const _=k.filter(n=>n.isActive&&n.studentIds&&n.studentIds.length>0).length,te=new Date($.getTime()+24*60*60*1e3).toISOString().split("T")[0],se=k.filter(n=>{const f=n.date.split("T")[0];return f===N||f===te}).slice(0,5).map(n=>({id:n._id,name:n.title||n.category,time:n.startTime,duration:n.duration||90,enrolledCount:n.studentIds?.length||0,capacity:n.maxStudents||15,level:n.category||"תיאוריה",venue:n.location}));s({totalTheoryStudents:Y.size,todaysLessons:M.length,weeklyTheoryHours:Math.round(V*10)/10,upcomingExams:Math.floor(Math.random()*5)+1,activeTheoryGroups:_,pendingGrades:Math.floor(Math.random()*10)+2}),i(se);const S=[];k.slice(0,5).forEach((n,f)=>{S.push({id:`activity-${n._id}-${f}`,type:"lesson",title:"שיעור תיאוריה הושלם",description:`שיעור ${n.title||n.category} - ${n.studentIds?.length||0} תלמידים`,timestamp:new Date(Date.now()-Math.random()*864e5*3).toISOString(),groupName:n.title||n.category})}),S.push({id:"attendance-1",type:"attendance",title:"נוכחות עודכנה",description:"נוכחות לשיעור מגמה מתקדמת",timestamp:new Date(Date.now()-2*60*60*1e3).toISOString(),groupName:"מגמה מתקדמת"}),j(S.sort((n,f)=>new Date(f.timestamp).getTime()-new Date(n.timestamp).getTime()));const ae=[],m=["מגמה מתחילים","מגמה בינוניים","מגמה מתקדמים","הרמוניה","קומפוזיציה"],d=["דניאל כהן","רחל לוי","יוסף גרין","שרה אברהם","מיכל דוד"];for(let n=0;n<Math.min(5,Y.size);n++)ae.push({studentId:`student-${n}`,studentName:d[n%d.length],theoryGroup:m[n%m.length],currentLevel:Math.random()>.5?"בינוני":"מתקדם",progressPercentage:Math.floor(Math.random()*30)+70,lastActivity:new Date(Date.now()-Math.random()*6048e5).toLocaleDateString("he-IL"),attendanceRate:Math.floor(Math.random()*20)+80});Q(ae)}catch(c){console.error("Error loading theory dashboard data:",c),J("שגיאה בטעינת נתוני לוח הבקרה לתיאוריה")}finally{q(!1)}},G=c=>{const a=new Date(c),k=a.getDay(),$=a.getDate()-k;return new Date(a.setDate($))},x=Ie(),v=c=>{switch(c){case"scheduleTheoryLesson":x("/profile",{state:{activeTab:"theory-lessons"}});break;case"markTheoryAttendance":x("/profile",{state:{activeTab:"theory-lessons"}});break;case"manageTheoryGroups":x("/profile",{state:{activeTab:"theory-lessons"}});break;case"gradeStudents":window.location.href="/teacher/theory-grades";break;default:console.log("Action:",c)}},P=c=>{const a=new Date(c),$=new Date().getTime()-a.getTime(),N=Math.floor($/(1e3*60*60));return N<1?`לפני ${Math.floor($/6e4)} דקות`:N<24?`לפני ${N} שעות`:`לפני ${Math.floor(N/24)} ימים`};return O?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600 font-reisinger-yonatan",children:"טוען לוח בקרה לתיאוריה..."})]})}):z?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-6 max-w-md",children:e.jsxs("div",{className:"text-red-800 font-reisinger-yonatan text-center",children:[e.jsx(he,{className:"w-12 h-12 mx-auto mb-4 text-red-600"}),e.jsx("h3",{className:"text-lg font-bold mb-2",children:z}),e.jsx("button",{onClick:K,className:"mt-4 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700",children:"נסה שוב"})]})})}):e.jsx("div",{className:"min-h-screen bg-gray-50 py-8",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 font-reisinger-yonatan",children:"לוח בקרה - מורה תיאוריה 🎼"}),e.jsxs("p",{className:"text-gray-600 mt-2",children:["שלום ",o?.firstName||"מורה"," • ",new Date().toLocaleDateString("he-IL",{weekday:"long",year:"numeric",month:"long",day:"numeric"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6 mb-8",children:[e.jsx(de,{icon:e.jsx(ue,{className:"w-6 h-6"}),title:"תלמידי תיאוריה",value:t.totalTheoryStudents,bgColor:"bg-blue-50",iconColor:"text-blue-600",borderColor:"border-blue-200"}),e.jsx(de,{icon:e.jsx(ee,{className:"w-6 h-6"}),title:"שיעורים היום",value:t.todaysLessons,bgColor:"bg-green-50",iconColor:"text-green-600",borderColor:"border-green-200"}),e.jsx(de,{icon:e.jsx(ve,{className:"w-6 h-6"}),title:"שעות השבוע",value:t.weeklyTheoryHours,suffix:"שעות",bgColor:"bg-purple-50",iconColor:"text-purple-600",borderColor:"border-purple-200"}),e.jsx(de,{icon:e.jsx(Z,{className:"w-6 h-6"}),title:"בחינות קרובות",value:t.upcomingExams,bgColor:"bg-yellow-50",iconColor:"text-yellow-600",borderColor:"border-yellow-200"}),e.jsx(de,{icon:e.jsx(me,{className:"w-6 h-6"}),title:"קבוצות פעילות",value:t.activeTheoryGroups,bgColor:"bg-indigo-50",iconColor:"text-indigo-600",borderColor:"border-indigo-200"}),e.jsx(de,{icon:e.jsx(ot,{className:"w-6 h-6"}),title:"ציונים ממתינים",value:t.pendingGrades,bgColor:"bg-orange-50",iconColor:"text-orange-600",borderColor:"border-orange-200"})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900 mb-4 font-reisinger-yonatan",children:"פעולות מהירות - תיאוריה"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(we,{icon:e.jsx(Ue,{className:"w-5 h-5"}),label:"תזמן שיעור תיאוריה",onClick:()=>v("scheduleTheoryLesson"),color:"indigo"}),e.jsx(we,{icon:e.jsx(le,{className:"w-5 h-5"}),label:"סמן נוכחות תיאוריה",onClick:()=>v("markTheoryAttendance"),color:"green"}),e.jsx(we,{icon:e.jsx(Oe,{className:"w-5 h-5"}),label:"נהל קבוצות תיאוריה",onClick:()=>v("manageTheoryGroups"),color:"blue"}),e.jsx(we,{icon:e.jsx(ct,{className:"w-5 h-5"}),label:"דרג תלמידים",onClick:()=>v("gradeStudents"),color:"purple"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900 font-reisinger-yonatan",children:"השיעורים הבאים - תיאוריה"}),e.jsxs("button",{onClick:()=>x("/profile",{state:{activeTab:"theory-lessons"}}),className:"text-indigo-600 hover:text-indigo-700 text-sm font-medium flex items-center gap-1",children:["צפה בכל",e.jsx(ie,{className:"w-4 h-4"})]})]}),r.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(ee,{className:"w-12 h-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"font-reisinger-yonatan",children:"אין שיעורי תיאוריה מתוכננים"})]}):e.jsx("div",{className:"space-y-3",children:r.map(c=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center",children:e.jsx(me,{className:"w-5 h-5 text-indigo-600"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900 font-reisinger-yonatan",children:c.name}),e.jsxs("div",{className:"text-sm text-gray-600 font-reisinger-yonatan",children:[c.level," • ",c.enrolledCount,"/",c.capacity," תלמידים"]}),c.venue&&e.jsx("div",{className:"text-xs text-gray-500 font-reisinger-yonatan",children:c.venue})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-medium text-gray-900",children:c.time}),e.jsxs("div",{className:"text-xs text-gray-500",children:[c.duration," דקות"]})]})]},c.id))})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900 font-reisinger-yonatan",children:"התקדמות תלמידי תיאוריה"}),e.jsxs("button",{onClick:()=>x("/profile",{state:{activeTab:"theory-lessons"}}),className:"text-indigo-600 hover:text-indigo-700 text-sm font-medium flex items-center gap-1",children:["צפה בכל",e.jsx(ie,{className:"w-4 h-4"})]})]}),E.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Pe,{className:"w-12 h-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"font-reisinger-yonatan",children:"אין נתוני התקדמות"})]}):e.jsx("div",{className:"space-y-3",children:E.map(c=>e.jsxs("div",{className:"flex items-center justify-between p-3 border border-gray-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center",children:e.jsx(me,{className:"w-4 h-4 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900 font-reisinger-yonatan",children:c.studentName}),e.jsxs("div",{className:"text-sm text-gray-600 font-reisinger-yonatan",children:[c.theoryGroup," • רמה: ",c.currentLevel]}),e.jsxs("div",{className:"text-xs text-gray-500 font-reisinger-yonatan",children:["פעילות אחרונה: ",c.lastActivity]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("div",{className:"w-16 bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:`h-2 rounded-full ${c.progressPercentage>=90?"bg-green-500":c.progressPercentage>=70?"bg-yellow-500":"bg-red-500"}`,style:{width:`${c.progressPercentage}%`}})}),e.jsxs("span",{className:"text-xs text-gray-600",children:[c.progressPercentage,"%"]})]}),e.jsxs("div",{className:"text-xs text-gray-500 font-reisinger-yonatan",children:["נוכחות: ",c.attendanceRate,"%"]})]})]},c.studentId))})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900 font-reisinger-yonatan",children:"פעילות אחרונה - תיאוריה"}),e.jsx(Ee,{className:"w-5 h-5 text-gray-400"})]}),b.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(he,{className:"w-12 h-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"font-reisinger-yonatan",children:"אין פעילות לאחרונה"})]}):e.jsx("div",{className:"space-y-4",children:b.map(c=>e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("div",{className:`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${c.type==="lesson"?"bg-blue-100":c.type==="attendance"?"bg-green-100":c.type==="grade"?"bg-purple-100":c.type==="enrollment"?"bg-yellow-100":"bg-indigo-100"}`,children:[c.type==="lesson"&&e.jsx(me,{className:"w-4 h-4 text-blue-600"}),c.type==="attendance"&&e.jsx(le,{className:"w-4 h-4 text-green-600"}),c.type==="grade"&&e.jsx(Pe,{className:"w-4 h-4 text-purple-600"}),c.type==="enrollment"&&e.jsx(Oe,{className:"w-4 h-4 text-yellow-600"}),c.type==="exam"&&e.jsx(Z,{className:"w-4 h-4 text-indigo-600"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 font-reisinger-yonatan",children:c.title}),e.jsx("p",{className:"text-sm text-gray-600 truncate font-reisinger-yonatan",children:c.description}),c.groupName&&e.jsx("p",{className:"text-xs text-indigo-600 font-reisinger-yonatan",children:c.groupName}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:P(c.timestamp)})]})]},c.id))})]})]})]})})}function de({icon:o,title:t,value:s,suffix:r,bgColor:i,iconColor:b,borderColor:j}){return e.jsx("div",{className:`${i} border ${j} rounded-lg p-4`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-700 font-reisinger-yonatan",children:t}),e.jsxs("p",{className:"text-xl font-bold text-gray-900 mt-1",children:[s," ",r&&e.jsx("span",{className:"text-sm font-normal",children:r})]})]}),e.jsx("div",{className:`${b}`,children:o})]})})}function we({icon:o,label:t,onClick:s,color:r}){const i={indigo:"bg-indigo-50 text-indigo-600 hover:bg-indigo-100 border-indigo-200",green:"bg-green-50 text-green-600 hover:bg-green-100 border-green-200",blue:"bg-blue-50 text-blue-600 hover:bg-blue-100 border-blue-200",purple:"bg-purple-50 text-purple-600 hover:bg-purple-100 border-purple-200"};return e.jsxs("button",{onClick:s,className:`flex flex-col items-center justify-center p-4 rounded-lg border transition-colors ${i[r]}`,children:[o,e.jsx("span",{className:"mt-2 text-sm font-medium font-reisinger-yonatan text-center",children:t})]})}function Dt(){const{user:o}=Te(),{currentSchoolYear:t}=ze(),[s,r]=g.useState(!0),[i,b]=g.useState({activeStudents:0,staffMembers:0,activeOrchestras:0,weeklyRehearsals:0,studentsTrend:0,staffTrend:0,rehearsalsTrend:0}),[j,E]=g.useState([]),[Q,O]=g.useState([]);g.useEffect(()=>{q()},[t]);const q=async()=>{try{r(!0);const x=t?{schoolYearId:t._id}:{},[v,P,c,a]=await Promise.all([B.students.getStudents(x),B.teachers.getTeachers(x),B.orchestras.getOrchestras(x),B.rehearsals.getRehearsals(x)]),k=v.filter(m=>m.isActive!==!1).length,$=P.filter(m=>m.isActive!==!1).length,N=c.filter(m=>m.isActive!==!1).length,M=new Date,I=new Date(M.getTime()+7*24*60*60*1e3),U=a.filter(m=>{const d=new Date(m.date);return d>=M&&d<=I}).length,H=Math.floor(Math.random()*20)-10,V=Math.floor(Math.random()*5)-2,Y=Math.floor(Math.random()*8)-4;b({activeStudents:k,staffMembers:$,activeOrchestras:N,weeklyRehearsals:U,studentsTrend:H,staffTrend:V,rehearsalsTrend:Y});const _=[];v.sort((m,d)=>new Date(d.createdAt||0)-new Date(m.createdAt||0)).slice(0,2).forEach(m=>{_.push({type:"student",title:"רישום תלמיד חדש",description:`${m.personalInfo?.fullName||"תלמיד"} נרשם לקונסרבטוריון`,time:z(m.createdAt),color:"primary"})}),a.filter(m=>new Date(m.date)>=M).sort((m,d)=>new Date(m.date)-new Date(d.date)).slice(0,2).forEach(m=>{_.push({type:"rehearsal",title:"חזרה נקבעה",description:`${m.orchestraId?.name||"תזמורת"} - ${J(m.date)} ${m.startTime||""}`,time:z(m.createdAt),color:"success"})}),P.length>0&&P.filter(d=>d.studentCount>0).slice(0,1).forEach(d=>{_.push({type:"assignment",title:"שיבוץ מורה",description:`${d.personalInfo?.fullName||"מורה"} - ${d.studentCount} תלמידים`,time:"השבוע",color:"orange"})}),E(_.slice(0,5));const S=[];a.filter(m=>new Date(m.date)>=M).sort((m,d)=>new Date(m.date)-new Date(d.date)).slice(0,2).forEach(m=>{S.push({title:m.orchestraId?.name||"חזרת תזמורת",date:J(m.date),description:`${m.type||"חזרה"} - ${m.location||"אולם ראשי"}`,isPrimary:m.type==="concert"})}),S.push({title:"קונצרט חורף",date:"15 בדצמבר",description:"כל התזמורות מבצעות",isPrimary:!0}),S.length<3&&S.push({title:"אספת סגל",date:"8 בדצמבר",description:"ישיבת תכנון חודשית",isPrimary:!1}),O(S.slice(0,3))}catch(x){console.error("Failed to load dashboard data:",x)}finally{r(!1)}},z=x=>{if(!x)return"לאחרונה";const v=new Date,P=new Date(x),c=v-P,a=Math.floor(c/6e4),k=Math.floor(c/36e5),$=Math.floor(c/864e5);return a<60?`לפני ${a} דקות`:k<24?`לפני ${k} שעות`:$<7?`לפני ${$} ימים`:"השבוע"},J=x=>{if(!x)return"";const v=new Date(x);return`${v.getDate()}/${v.getMonth()+1}`},G=!o||o.role==="admin"||o.roles?.includes("admin")||o.role==="מנהל"||o.roles?.includes("מנהל")?"admin":o.role==="theory-teacher"||o.roles?.includes("theory-teacher")||o.roles?.includes("theory_teacher")||o.role==="מורה תיאוריה"||o.roles?.includes("מורה תיאוריה")?"theory-teacher":o.role==="conductor"||o.roles?.includes("conductor")||o.role==="מנצח"||o.roles?.includes("מנצח")||o.conducting?.orchestraIds?.length>0?"conductor":o.role==="teacher"||o.roles?.includes("teacher")||o.role==="מורה"||o.roles?.includes("מורה")||o.teaching?.studentIds?.length>0?"teacher":"admin";return G==="theory-teacher"?e.jsx(ft,{}):G==="conductor"?e.jsx(ht,{}):G==="teacher"?e.jsx(ut,{}):e.jsxs("div",{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8",children:[e.jsx(be,{title:"תלמידים פעילים",value:s?"...":i.activeStudents.toString(),subtitle:"תלמידים רשומים",icon:e.jsx(ue,{}),color:"blue",trend:i.studentsTrend!==0?{value:Math.abs(i.studentsTrend),label:"מהחודש שעבר",direction:i.studentsTrend>0?"up":"down"}:void 0}),e.jsx(be,{title:"חברי סגל",value:s?"...":i.staffMembers.toString(),subtitle:"מורים ומדריכים",icon:e.jsx(Z,{}),color:"green",trend:i.staffTrend!==0?{value:Math.abs(i.staffTrend),label:"מהרבעון שעבר",direction:i.staffTrend>0?"up":"down"}:void 0}),e.jsx(be,{title:"הרכבים פעילים",value:s?"...":i.activeOrchestras.toString(),subtitle:"תזמורות וקבוצות",icon:e.jsx(xe,{}),color:"purple"}),e.jsx(be,{title:"חזרות השבוע",value:s?"...":i.weeklyRehearsals.toString(),subtitle:"מפגשים מתוכננים",icon:e.jsx(ee,{}),color:"orange",trend:i.rehearsalsTrend!==0?{value:Math.abs(i.rehearsalsTrend),label:"מהשבוע שעבר",direction:i.rehearsalsTrend>0?"up":"down"}:void 0})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8",children:[e.jsx("div",{className:"lg:col-span-2",children:e.jsxs(pe,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"פעילות אחרונה"}),e.jsx("button",{className:"text-sm text-primary-600 hover:text-primary-700 font-medium",children:"צפה בהכל"})]}),e.jsx("div",{className:"space-y-4",children:s?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"טוען..."}):j.length>0?j.map((x,v)=>e.jsxs("div",{className:"flex items-start",children:[e.jsx("div",{className:`w-2 h-2 bg-${x.color}-500 rounded-full mt-2 ml-4`}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:x.title}),e.jsx("span",{className:"text-xs text-gray-500",children:x.time})]}),e.jsx("p",{className:"text-sm text-gray-600",children:x.description})]})]},v)):e.jsx("div",{className:"text-center py-8 text-gray-500",children:"אין פעילות אחרונה"})})]})}),e.jsx("div",{children:e.jsxs(pe,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"אירועים קרובים"}),e.jsx("button",{className:"text-sm text-primary-600 hover:text-primary-700 font-medium",children:"יצירת אירוע"})]}),e.jsx("div",{className:"space-y-4",children:s?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"טוען..."}):Q.length>0?Q.map((x,v)=>e.jsxs("div",{className:`p-4 rounded-lg ${x.isPrimary?"bg-primary-50 border border-primary-100":"bg-gray-50"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("p",{className:`text-sm font-medium ${x.isPrimary?"text-primary-900":"text-gray-900"}`,children:x.title}),e.jsx("span",{className:`text-xs ${x.isPrimary?"text-primary-600":"text-gray-500"}`,children:x.date})]}),e.jsx("p",{className:`text-sm ${x.isPrimary?"text-primary-700":"text-gray-600"}`,children:x.description})]},v)):e.jsx("div",{className:"text-center py-8 text-gray-500",children:"אין אירועים קרובים"})})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(pe,{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-6",children:"התקדמות חודשית"}),e.jsx("div",{className:"h-64 bg-gray-50 rounded-lg flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-gray-500 mb-2",children:"סטטיסטיקות החודש"}),!s&&e.jsxs("div",{className:"grid grid-cols-2 gap-4 mt-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-primary-600",children:i.activeStudents}),e.jsx("p",{className:"text-sm text-gray-600",children:"תלמידים"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-success-600",children:i.weeklyRehearsals}),e.jsx("p",{className:"text-sm text-gray-600",children:"חזרות"})]})]})]})})]}),e.jsxs(pe,{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-6",children:"התפלגות תלמידים"}),e.jsx("div",{className:"h-64 bg-gray-50 rounded-lg flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-gray-500 mb-2",children:"התפלגות לפי הרכבים"}),!s&&e.jsxs("div",{className:"mt-4",children:[e.jsx("p",{className:"text-3xl font-bold text-purple-600",children:i.activeOrchestras}),e.jsx("p",{className:"text-sm text-gray-600",children:"הרכבים פעילים"}),e.jsxs("p",{className:"text-lg mt-2 text-gray-700",children:["ממוצע: ",i.activeOrchestras>0?Math.floor(i.activeStudents/i.activeOrchestras):0," תלמידים להרכב"]})]})]})})]})]})]})}export{Dt as default};
