import{u as ee,j as e}from"../assets/index-Y6gcqfIP.js";import{r as c}from"./vendor-E-WBaSU9.js";import{a as g}from"./cascade-deletion-MikTgWpr.js";import{A as te,a7 as re,f as E,c as se,d as ne,Y as ae,m as le,y as ie}from"./ui-DIGiJ8tL.js";import"./query-CMzvnXZ6.js";import"./utils-Cgyyg58q.js";function he(){const{user:y}=ee(),[o,$]=c.useState([]),[j,A]=c.useState([]),[R,C]=c.useState(!0),[h,M]=c.useState(""),[u,B]=c.useState("all"),[b,_]=c.useState("all"),[v,P]=c.useState("all"),[l,m]=c.useState([]),[d,T]=c.useState(!1),[I,L]=c.useState(null);c.useEffect(()=>{y?._id&&N()},[y]);const N=async()=>{try{C(!0),L(null);const t=y._id,s=(await g.teachers.getTeacher(t))?.conducting?.orchestraIds||[];let n=[];s.length>0&&(n=await g.orchestras.getBatchOrchestras(s));const i=n.map(a=>({id:a._id,name:a.name,type:a.type,level:a.level,memberCount:a.memberCount||0,maxMembers:a.maxMembers||50,status:a.status||"active"}));A(i);const X=(await g.students.getStudents({status:"active",limit:500})).map(a=>{const S=a.academicInfo?.instrumentProgress?.find(x=>x.isPrimary),Z=n.filter(x=>x.memberIds?.includes(a._id)).map(x=>x.name);return{id:a._id,name:a.personalInfo?.fullName||`${a.personalInfo?.firstName} ${a.personalInfo?.lastName}`,instrument:S?.instrumentName||"לא צוין",level:U(S?.currentStage||1),currentOrchestras:Z,enrollmentStatus:F(a,n),enrollmentDate:a.academicInfo?.enrollmentDate||new Date().toISOString(),attendanceRate:Math.floor(Math.random()*20)+80,performanceLevel:S?.currentStage||1,lastActivity:new Date(Date.now()-Math.random()*30*24*60*60*1e3).toISOString(),contactInfo:{email:a.personalInfo?.email,phone:a.personalInfo?.phone}}});$(X)}catch(t){console.error("Error loading enrollment data:",t),L("שגיאה בטעינת נתוני הרשמה")}finally{C(!1)}},U=t=>t<=2?"beginner":t<=4?"intermediate":"advanced",F=(t,r)=>r.some(n=>n.memberIds?.includes(t._id))?"enrolled":"pending",O=t=>{switch(t){case"beginner":return"מתחיל";case"intermediate":return"בינוני";case"advanced":return"מתקדם";default:return t}},k=t=>{switch(t){case"enrolled":return"רשום";case"pending":return"ממתין";case"declined":return"נדחה";case"graduated":return"בוגר";default:return t}},V=t=>{switch(t){case"enrolled":return"bg-green-100 text-green-800";case"pending":return"bg-yellow-100 text-yellow-800";case"declined":return"bg-red-100 text-red-800";case"graduated":return"bg-blue-100 text-blue-800";default:return"bg-gray-100 text-gray-800"}},q=t=>{m(r=>r.includes(t)?r.filter(s=>s!==t):[...r,t])},Y=()=>{const t=w().map(r=>r.id);l.length===t.length?m([]):m(t)},z=async t=>{if(l.length!==0)try{await Promise.all(l.map(r=>g.orchestras.addMember(t,r))),alert(`${l.length} תלמידים נרשמו בהצלחה`),m([]),await N()}catch(r){console.error("Error bulk enrolling students:",r),alert("שגיאה ברישום תלמידים")}},G=async t=>{if(l.length!==0&&window.confirm(`האם אתה בטוח שברצונך להסיר ${l.length} תלמידים מהתזמורת?`))try{await Promise.all(l.map(r=>g.orchestras.removeMember(t,r))),alert(`${l.length} תלמידים הוסרו בהצלחה`),m([]),await N()}catch(r){console.error("Error bulk removing students:",r),alert("שגיאה בהסרת תלמידים")}},H=()=>{const t=w().map(s=>({שם:s.name,כלי:s.instrument,רמה:O(s.level),תזמורות:s.currentOrchestras.join(", "),סטטוס:k(s.enrollmentStatus),"תאריך הרשמה":new Date(s.enrollmentDate).toLocaleDateString("he-IL"),"אחוז נוכחות":`${s.attendanceRate}%`,"דירוג ביצועים":s.performanceLevel,"פעילות אחרונה":new Date(s.lastActivity).toLocaleDateString("he-IL")})),r=J(t);K(r,"enrollment-data.csv")},J=t=>{if(t.length===0)return"";const r=Object.keys(t[0]).join(","),s=t.map(n=>Object.values(n).join(",")).join(`
`);return`${r}
${s}`},K=(t,r)=>{const s=new Blob([t],{type:"text/csv;charset=utf-8;"}),n=document.createElement("a"),i=URL.createObjectURL(s);n.setAttribute("href",i),n.setAttribute("download",r),n.style.visibility="hidden",document.body.appendChild(n),n.click(),document.body.removeChild(n)},w=()=>o.filter(t=>{const r=h===""||t.name.toLowerCase().includes(h.toLowerCase())||t.instrument.toLowerCase().includes(h.toLowerCase()),s=u==="all"||t.currentOrchestras.includes(u)||u==="none"&&t.currentOrchestras.length===0,n=b==="all"||t.enrollmentStatus===b,i=v==="all"||t.instrument===v;return r&&s&&n&&i}),Q=()=>[...new Set(o.map(t=>t.instrument))].filter(Boolean).sort(),W=()=>{const t=o.length,r=o.filter(i=>i.enrollmentStatus==="enrolled").length,s=o.filter(i=>i.enrollmentStatus==="pending").length,n=o.reduce((i,D)=>i+D.attendanceRate,0)/t||0;return{total:t,enrolled:r,pending:s,averageAttendance:n}};if(R)return e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600 font-reisinger-yonatan",children:"טוען נתוני הרשמה..."})]})});if(I)return e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center gap-2 text-red-800",children:[e.jsx(te,{className:"w-5 h-5"}),e.jsx("div",{className:"font-reisinger-yonatan",children:I})]})});const p=w(),f=W();return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 font-reisinger-yonatan",children:"ניהול הרשמות לתזמורות"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"ניהול רישום תלמידים לתזמורות וניתוח נתוני השתתפות"})]}),e.jsxs("button",{onClick:H,className:"flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700",children:[e.jsx(re,{className:"w-4 h-4"}),"ייצא נתונים"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx("div",{className:"bg-white p-4 rounded-lg border border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:f.total}),e.jsx("div",{className:"text-sm text-gray-600 font-reisinger-yonatan",children:"סה״כ תלמידים"})]}),e.jsx(E,{className:"w-8 h-8 text-blue-600"})]})}),e.jsx("div",{className:"bg-white p-4 rounded-lg border border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:f.enrolled}),e.jsx("div",{className:"text-sm text-gray-600 font-reisinger-yonatan",children:"רשומים"})]}),e.jsx(se,{className:"w-8 h-8 text-green-600"})]})}),e.jsx("div",{className:"bg-white p-4 rounded-lg border border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:f.pending}),e.jsx("div",{className:"text-sm text-gray-600 font-reisinger-yonatan",children:"ממתינים"})]}),e.jsx(ne,{className:"w-8 h-8 text-yellow-600"})]})}),e.jsx("div",{className:"bg-white p-4 rounded-lg border border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-2xl font-bold text-purple-600",children:[Math.round(f.averageAttendance),"%"]}),e.jsx("div",{className:"text-sm text-gray-600 font-reisinger-yonatan",children:"נוכחות ממוצעת"})]}),e.jsx(ae,{className:"w-8 h-8 text-purple-600"})]})})]}),e.jsx("div",{className:"bg-white p-4 rounded-lg border border-gray-200",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(le,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"text",placeholder:"חיפוש תלמידים...",value:h,onChange:t=>M(t.target.value),className:"w-full pl-4 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",dir:"rtl"})]}),e.jsxs("select",{value:u,onChange:t=>B(t.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"all",children:"כל התזמורות"}),e.jsx("option",{value:"none",children:"ללא תזמורת"}),j.map(t=>e.jsx("option",{value:t.name,children:t.name},t.id))]}),e.jsxs("select",{value:b,onChange:t=>_(t.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"all",children:"כל הסטטוסים"}),e.jsx("option",{value:"enrolled",children:"רשומים"}),e.jsx("option",{value:"pending",children:"ממתינים"}),e.jsx("option",{value:"declined",children:"נדחו"}),e.jsx("option",{value:"graduated",children:"בוגרים"})]}),e.jsxs("select",{value:v,onChange:t=>P(t.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"all",children:"כל הכלים"}),Q().map(t=>e.jsx("option",{value:t,children:t},t))]}),e.jsx("button",{onClick:()=>T(!d),className:`px-3 py-2 rounded-lg border transition-colors ${d?"bg-indigo-100 text-indigo-700 border-indigo-300":"bg-white text-gray-700 border-gray-300 hover:bg-gray-50"}`,children:"פעולות מרוכזות"})]})}),d&&l.length>0&&e.jsx("div",{className:"bg-indigo-50 border border-indigo-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-indigo-800 font-medium",children:["נבחרו ",l.length," תלמידים"]}),e.jsxs("div",{className:"flex gap-2",children:[j.map(t=>e.jsxs("button",{onClick:()=>z(t.id),className:"px-3 py-1.5 bg-green-600 text-white text-sm rounded hover:bg-green-700",children:["רשום ל",t.name]},t.id)),j.map(t=>e.jsxs("button",{onClick:()=>G(t.id),className:"px-3 py-1.5 bg-red-600 text-white text-sm rounded hover:bg-red-700",children:["הסר מ",t.name]},`remove-${t.id}`))]})]})}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 font-reisinger-yonatan",children:["רשימת תלמידים (",p.length,")"]}),d&&e.jsx("button",{onClick:Y,className:"text-sm text-indigo-600 hover:text-indigo-700",children:l.length===p.length?"בטל הכל":"בחר הכל"})]})}),p.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(E,{className:"w-12 h-12 text-gray-400 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 font-reisinger-yonatan",children:"לא נמצאו תלמידים"})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[d&&e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"בחר"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"שם התלמיד"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"כלי"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"רמה"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"תזמורות"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"סטטוס"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"נוכחות"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"ביצועים"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:p.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[d&&e.jsx("td",{className:"px-4 py-3",children:e.jsx("input",{type:"checkbox",checked:l.includes(t.id),onChange:()=>q(t.id),className:"h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"})}),e.jsxs("td",{className:"px-4 py-3",children:[e.jsx("div",{className:"font-medium text-gray-900 font-reisinger-yonatan",children:t.name}),e.jsx("div",{className:"text-sm text-gray-500",children:new Date(t.enrollmentDate).toLocaleDateString("he-IL")})]}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900",children:t.instrument}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${t.level==="advanced"?"bg-purple-100 text-purple-800":t.level==="intermediate"?"bg-blue-100 text-blue-800":"bg-green-100 text-green-800"}`,children:O(t.level)})}),e.jsx("td",{className:"px-4 py-3",children:t.currentOrchestras.length>0?e.jsx("div",{className:"space-y-1",children:t.currentOrchestras.map((r,s)=>e.jsx("div",{className:"text-sm text-gray-900 font-reisinger-yonatan",children:r},s))}):e.jsx("span",{className:"text-sm text-gray-500",children:"אין"})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${V(t.enrollmentStatus)}`,children:k(t.enrollmentStatus)})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:`text-sm font-medium ${t.attendanceRate>=90?"text-green-600":t.attendanceRate>=75?"text-yellow-600":"text-red-600"}`,children:[t.attendanceRate,"%"]}),e.jsx("div",{className:"w-16 bg-gray-200 rounded-full h-1.5",children:e.jsx("div",{className:`h-1.5 rounded-full ${t.attendanceRate>=90?"bg-green-600":t.attendanceRate>=75?"bg-yellow-600":"bg-red-600"}`,style:{width:`${t.attendanceRate}%`}})})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("div",{className:"flex items-center gap-1",children:Array.from({length:5},(r,s)=>e.jsx(ie,{className:`w-3 h-3 ${s<t.performanceLevel?"text-yellow-400 fill-current":"text-gray-300"}`},s))})})]},t.id))})]})})]})]})}export{he as default};
