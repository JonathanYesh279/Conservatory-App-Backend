import{j as e}from"../assets/index-BAwpfw4Y.js";import{r as l,b as Te}from"./vendor-E-WBaSU9.js";import{C as ie}from"./Card-Cf_Ok3Ft.js";import{T as Me}from"./Table-CRtO5CqB.js";import{C as _e,M as Ie}from"./ConfirmationModal-FX2Cuwnj.js";import{g as me,f as U,c as q,a as Ae,V as Oe,b as xe,d as Ee,s as Le,D as We,R as ce}from"./RehearsalForm-BJuSr_UU.js";import{m as he,n as se,U as z,X as H,$ as Fe,a0 as Pe,E as ze,v as Be,T as ee,l as Qe,C as te,g as Z,S as ue,k as Ve,R as oe,o as He,w as Ue,P as de,q as qe,F as Ye,N as Ke}from"./ui-BeR0qYie.js";import{r as E,o as Xe}from"./cascade-deletion-C-2LBfWA.js";import"./query-CMzvnXZ6.js";import"./utils-x1PSU_OZ.js";function Ge({rehearsal:s,compact:n=!1,onRehearsalClick:x}){const i=me(s),u=U(s),r=q(s);return e.jsx("div",{className:`${i} rounded-lg p-3 text-white cursor-pointer hover:shadow-lg transition-all duration-200 shadow-md ${n?"text-sm":""}`,onClick:()=>x?.(s),children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"flex items-start justify-between",children:e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx("div",{className:"font-semibold truncate text-base leading-tight",children:s.orchestra?.name||"ללא שם"})})}),e.jsxs("div",{className:"space-y-1.5 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-1.5 opacity-95",children:[e.jsx(he,{className:"w-3.5 h-3.5 flex-shrink-0"}),e.jsx("span",{className:"font-medium",children:u.time})]}),e.jsxs("div",{className:"flex items-center gap-1.5 opacity-95",children:[e.jsx(se,{className:"w-3.5 h-3.5 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:s.location||"לא צוין מיקום"})]}),!n&&r.hasAttendanceData&&e.jsxs("div",{className:"flex items-center gap-1.5 opacity-95",children:[e.jsx(z,{className:"w-3.5 h-3.5 flex-shrink-0"}),e.jsxs("span",{children:[r.presentCount,"/",r.totalMembers," נוכחים"]})]})]})]})})}function Je({rehearsals:s,date:n,onClose:x,onRehearsalClick:i}){const u=n.toLocaleDateString("he-IL",{weekday:"long",day:"numeric",month:"long",year:"numeric"});return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",style:{position:"fixed !important",top:"0 !important",left:"0 !important",right:"0 !important",bottom:"0 !important",display:"flex !important",alignItems:"center !important",justifyContent:"center !important",zIndex:9999},children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-md w-full max-h-[80vh] overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-200",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"חזרות ליום"}),e.jsx("p",{className:"text-sm text-gray-600",children:u})]}),e.jsx("button",{onClick:x,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(H,{className:"w-5 h-5 text-gray-500"})})]}),e.jsx("div",{className:"p-4 overflow-y-auto max-h-[60vh]",children:e.jsx("div",{className:"space-y-3",children:s.map((r,d)=>e.jsx("div",{className:"cursor-pointer hover:bg-gray-50 rounded-lg p-2 transition-colors",onClick:()=>i(r),children:e.jsx(Ge,{rehearsal:r,compact:!0,onRehearsalClick:()=>{}})},r._id))})}),e.jsx("div",{className:"p-4 border-t border-gray-200 text-center",children:e.jsxs("p",{className:"text-xs text-gray-500",children:[s.length," חזרות ביום זה"]})})]})})}function Ze({rehearsals:s,viewMode:n,selectedDate:x=new Date,onSelectDate:i,onRehearsalClick:u,onEditRehearsal:r,onDeleteRehearsal:d,onViewDetails:g,onNavigateToRehearsal:h,className:p=""}){const[c,j]=l.useState(x),[y,k]=l.useState(!1),[I,A]=l.useState([]),[N,L]=l.useState(new Date),R=()=>{const o=new Date(c);n==="week"?o.setDate(o.getDate()-7):o.setMonth(o.getMonth()-1),j(o),i?.(o)},f=()=>{const o=new Date(c);n==="week"?o.setDate(o.getDate()+7):o.setMonth(o.getMonth()+1),j(o),i?.(o)},T=()=>{const o=new Date;j(o),i?.(o)},B=(o,a)=>{L(o),A(a),k(!0)},W=o=>{k(!1),h?.(o._id)},M=l.useMemo(()=>n==="week"?st(c,s):at(c,s),[c,s,n]),F=l.useMemo(()=>{if(n==="week"){const o=pe(c),a=new Date(o);return a.setDate(a.getDate()+6),o.getMonth()===a.getMonth()?`${o.getDate()}-${a.getDate()} ${o.toLocaleDateString("he-IL",{month:"long",year:"numeric"})}`:`${o.toLocaleDateString("he-IL",{day:"numeric",month:"short"})} - ${a.toLocaleDateString("he-IL",{day:"numeric",month:"short",year:"numeric"})}`}else return c.toLocaleDateString("he-IL",{month:"long",year:"numeric"})},[c,n]);return e.jsxs("div",{className:`bg-white rounded-lg border border-gray-200 ${p}`,children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:R,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(Fe,{className:"w-5 h-5 text-gray-600"})}),e.jsx("button",{onClick:f,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(Pe,{className:"w-5 h-5 text-gray-600"})})]}),e.jsx("div",{className:"text-center",children:e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:F})}),e.jsx("button",{onClick:T,className:"px-3 py-1 text-sm text-primary-600 border border-primary-300 rounded-lg hover:bg-primary-50 transition-colors",children:"היום"})]}),e.jsx("div",{className:"p-4",children:n==="week"?e.jsx(et,{weekData:M,onRehearsalClick:u,onEditRehearsal:r,onDeleteRehearsal:d,onViewDetails:g}):e.jsx(tt,{monthData:M,currentDate:c,onRehearsalClick:u,onEditRehearsal:r,onDeleteRehearsal:d,onViewDetails:g,onNavigateToRehearsal:h,onShowAdditional:B})}),y&&e.jsx(Je,{rehearsals:I,date:N,onClose:()=>k(!1),onRehearsalClick:W})]})}function et({weekData:s,onRehearsalClick:n,onEditRehearsal:x,onDeleteRehearsal:i,onViewDetails:u}){return e.jsxs("div",{className:"grid grid-cols-7 gap-1",children:[s.days.map((r,d)=>e.jsxs("div",{className:"p-2 text-center",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:Ae(r.dayOfWeek)}),e.jsx("div",{className:`text-lg font-semibold mt-1 ${r.isToday?"text-primary-600":"text-gray-700"}`,children:r.date.getDate()})]},d)),s.days.map((r,d)=>e.jsx("div",{className:"min-h-[250px] border border-gray-200 rounded-lg p-3",children:e.jsx("div",{className:"space-y-2",children:r.rehearsals.map(g=>e.jsx(ge,{rehearsal:g,compact:!0,onRehearsalClick:n,onEditRehearsal:x,onDeleteRehearsal:i,onViewDetails:u},g._id))})},d))]})}function tt({monthData:s,currentDate:n,onRehearsalClick:x,onEditRehearsal:i,onDeleteRehearsal:u,onViewDetails:r,onNavigateToRehearsal:d,onShowAdditional:g}){return e.jsxs("div",{className:"grid grid-cols-7 gap-1",children:[Object.entries(Oe).map(([h,p])=>e.jsx("div",{className:"p-2 text-center font-medium text-gray-900 text-sm",children:p},h)),s.weeks.map((h,p)=>h.map((c,j)=>e.jsxs("div",{className:`min-h-[120px] border border-gray-200 rounded-lg p-2 ${c.isCurrentMonth?"":"bg-gray-50"} ${c.isToday?"bg-primary-50 border-primary-200":""}`,children:[e.jsx("div",{className:`text-sm font-semibold mb-2 ${c.isCurrentMonth?c.isToday?"text-primary-600":"text-gray-900":"text-gray-400"}`,children:c.date.getDate()}),e.jsxs("div",{className:"space-y-1",children:[c.rehearsals.slice(0,3).map(y=>e.jsx(ge,{rehearsal:y,compact:!0,minimal:!0,onRehearsalClick:x,onEditRehearsal:i,onDeleteRehearsal:u,onViewDetails:r},y._id)),c.rehearsals.length>3&&e.jsxs("div",{className:"text-xs text-gray-500 text-center py-1 bg-gray-100 rounded-md cursor-pointer hover:bg-gray-200 transition-colors",onClick:y=>{y.stopPropagation(),g?.(c.date,c.rehearsals)},children:["+",c.rehearsals.length-3," נוספות"]})]})]},`${p}-${j}`)))]})}function ge({rehearsal:s,compact:n=!1,minimal:x=!1,onRehearsalClick:i,onEditRehearsal:u,onDeleteRehearsal:r,onViewDetails:d}){const g=xe(s),h=q(s),p=me(s),c=U(s);return x?e.jsxs("div",{className:`${p} rounded-md p-1.5 text-white cursor-pointer hover:shadow-md transition-all duration-200 text-xs shadow-sm`,onClick:()=>i?.(s),title:`${s.orchestra?.name||"ללא שם"} • ${c.time} • ${s.location}`,children:[e.jsx("div",{className:"font-medium truncate text-xs leading-tight",children:s.orchestra?.name||"ללא שם"}),e.jsxs("div",{className:"flex items-center justify-between mt-1 opacity-90",children:[e.jsx("span",{className:"text-[10px] truncate",children:c.time}),e.jsx("span",{className:"text-[10px] ml-1 truncate flex-shrink-0",children:s.location})]})]}):e.jsx("div",{className:`${p} rounded-lg p-3 text-white cursor-pointer hover:shadow-lg transition-all duration-200 shadow-md ${n?"text-sm":""}`,onClick:()=>i?.(s),children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx("div",{className:"font-semibold truncate text-base leading-tight",children:s.orchestra?.name||"ללא שם"})}),!n&&e.jsxs("div",{className:"flex items-center gap-0.5 mr-1 flex-shrink-0",children:[d&&e.jsx("button",{onClick:j=>{j.stopPropagation(),d(s)},className:"p-1.5 hover:bg-white hover:bg-opacity-20 rounded-full transition-colors",title:"צפה בפרטים",children:e.jsx(ze,{className:"w-3.5 h-3.5"})}),u&&e.jsx("button",{onClick:j=>{j.stopPropagation(),u(s)},className:"p-1.5 hover:bg-white hover:bg-opacity-20 rounded-full transition-colors",title:"ערוך חזרה",children:e.jsx(Be,{className:"w-3.5 h-3.5"})}),r&&e.jsx("button",{onClick:j=>{j.stopPropagation(),r(s._id)},className:"p-1.5 hover:bg-white hover:bg-opacity-20 rounded-full transition-colors",title:"מחק חזרה",children:e.jsx(ee,{className:"w-3.5 h-3.5"})})]})]}),e.jsxs("div",{className:"space-y-1.5 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-1.5 opacity-95",children:[e.jsx(he,{className:"w-3.5 h-3.5 flex-shrink-0"}),e.jsx("span",{className:"font-medium",children:c.time})]}),e.jsxs("div",{className:"flex items-center gap-1.5 opacity-95",children:[e.jsx(se,{className:"w-3.5 h-3.5 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:s.location||"לא צוין מיקום"})]}),!n&&h.hasAttendanceData&&e.jsxs("div",{className:"flex items-center gap-1.5 opacity-95",children:[e.jsx(z,{className:"w-3.5 h-3.5 flex-shrink-0"}),e.jsxs("span",{children:[h.presentCount,"/",h.totalMembers," נוכחים"]})]})]}),n&&e.jsx("div",{className:"flex justify-end",children:e.jsx("div",{className:"px-2 py-0.5 rounded-full text-[10px] font-medium bg-white bg-opacity-20",children:g.text})})]})})}function pe(s){const n=new Date(s),x=n.getDay(),i=n.getDate()-x;return n.setDate(i),n.setHours(0,0,0,0),n}function st(s,n){const x=pe(s),i=new Date;i.setHours(0,0,0,0);const u=[];for(let r=0;r<7;r++){const d=new Date(x);d.setDate(x.getDate()+r);const g=n.filter(h=>{const p=new Date(h.date);return p.setHours(0,0,0,0),p.getTime()===d.getTime()});u.push({date:d,dayOfWeek:d.getDay(),isToday:d.getTime()===i.getTime(),isCurrentMonth:!0,rehearsals:g})}return{days:u}}function at(s,n){const x=s.getFullYear(),i=s.getMonth(),u=new Date;u.setHours(0,0,0,0);const r=new Date(x,i,1),d=new Date(x,i+1,0),g=new Date(r);g.setDate(r.getDate()-r.getDay());const h=new Date(d);h.setDate(d.getDate()+(6-d.getDay()));const p=[],c=new Date(g);for(;c<=h;){const j=[];for(let y=0;y<7;y++){const k=new Date(c),I=n.filter(A=>{const N=new Date(A.date);return N.setHours(0,0,0,0),N.getTime()===k.getTime()});j.push({date:k,dayOfWeek:k.getDay(),isToday:k.getTime()===u.getTime(),isCurrentMonth:k.getMonth()===i,rehearsals:I}),c.setDate(c.getDate()+1)}p.push(j)}return{weeks:p}}function rt({rehearsal:s,onUpdateAttendance:n,onClose:x}){const[i,u]=l.useState(""),[r,d]=l.useState({present:new Set(s.attendance?.present||[]),absent:new Set(s.attendance?.absent||[])}),[g,h]=l.useState(!1),[p,c]=l.useState(!1),[j,y]=l.useState(null),[k,I]=l.useState(!1),A=U(s);q(s);const N=s.orchestra?.members||[],L=N.filter(a=>a.personalInfo?.fullName?.toLowerCase().includes(i.toLowerCase())||a.academicInfo?.class?.includes(i)),R={presentCount:r.present.size,absentCount:r.absent.size,totalMembers:N.length,unmarkedCount:N.length-r.present.size-r.absent.size};l.useEffect(()=>{const a=new Set(s.attendance?.present||[]),w=new Set(s.attendance?.absent||[]),v=a.size!==r.present.size||w.size!==r.absent.size||[...r.present].some(b=>!a.has(b))||[...r.absent].some(b=>!w.has(b));c(v)},[r,s.attendance]);const f=(a,w)=>{d(v=>{const b={present:new Set(v.present),absent:new Set(v.absent)};return b.present.delete(a),b.absent.delete(a),w==="present"?b.present.add(a):w==="absent"&&b.absent.add(a),b}),y(null)},T=a=>{d(w=>{const v={present:new Set,absent:new Set};return a==="present"?N.forEach(b=>v.present.add(b._id)):N.forEach(b=>v.absent.add(b._id)),v}),y(null)},B=()=>{d({present:new Set(s.attendance?.present||[]),absent:new Set(s.attendance?.absent||[])}),y(null)},W=async()=>{h(!0),y(null);try{const a={present:[...r.present],absent:[...r.absent]};await n(a),I(!0),setTimeout(()=>{I(!1),x()},1500)}catch(a){y(a.message||"שגיאה בשמירת הנוכחות")}finally{h(!1)}},M=a=>r.present.has(a)?"present":r.absent.has(a)?"absent":"unmarked",F=a=>{switch(a){case"present":return"bg-green-100 border-green-300 text-green-800";case"absent":return"bg-red-100 border-red-300 text-red-800";default:return"bg-gray-100 border-gray-300 text-gray-600"}},o=a=>{switch(a){case"present":return e.jsx(Z,{className:"w-4 h-4 text-green-600"});case"absent":return e.jsx(H,{className:"w-4 h-4 text-red-600"});default:return e.jsx(z,{className:"w-4 h-4 text-gray-400"})}};return k?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl p-8 max-w-md w-full text-center",children:[e.jsx("div",{className:"mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4",children:e.jsx(Qe,{className:"h-6 w-6 text-green-600"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"הנוכחות נשמרה בהצלחה"}),e.jsx("p",{className:"text-sm text-gray-500",children:"הנתונים עודכנו במערכת"})]})}):e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",onClick:x,children:e.jsx("div",{className:"bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto transform transition-all",onClick:a=>a.stopPropagation(),children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("button",{onClick:x,className:"p-2 text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(H,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex-1 text-center",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"ניהול נוכחות"}),e.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(te,{className:"w-4 h-4"}),e.jsx("span",{children:A.fullDateTime})]}),e.jsxs("div",{className:"flex items-center justify-center gap-2 mt-1",children:[e.jsx(z,{className:"w-4 h-4"}),e.jsx("span",{children:s.orchestra?.name})]})]})]}),e.jsx("div",{className:"w-8"})]}),e.jsxs("div",{className:"grid grid-cols-4 gap-4 mb-6 p-4 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:R.presentCount}),e.jsx("div",{className:"text-sm text-gray-600",children:"נוכחים"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:R.absentCount}),e.jsx("div",{className:"text-sm text-gray-600",children:"נעדרים"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-gray-600",children:R.unmarkedCount}),e.jsx("div",{className:"text-sm text-gray-600",children:"לא סומנו"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:R.totalMembers}),e.jsx("div",{className:"text-sm text-gray-600",children:"סך הכל"})]})]}),e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>T("present"),className:"flex items-center px-3 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors",children:[e.jsx(Z,{className:"w-4 h-4 ml-1"}),"סמן הכל כנוכח"]}),e.jsxs("button",{onClick:()=>T("absent"),className:"flex items-center px-3 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors",children:[e.jsx(H,{className:"w-4 h-4 ml-1"}),"סמן הכל כנעדר"]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(ue,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"חיפוש חבר...",value:i,onChange:a=>u(a.target.value),className:"pr-10 pl-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"})]})]}),j&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 mb-6 flex items-center",children:[e.jsx(Ve,{className:"w-5 h-5 text-red-600 ml-2"}),e.jsx("span",{className:"text-red-800",children:j})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg overflow-hidden mb-6",children:[e.jsx("div",{className:"max-h-96 overflow-y-auto",children:e.jsx("div",{className:"grid grid-cols-1 gap-1 p-2",children:L.map(a=>{const w=M(a._id),v=a.academicInfo?.instrumentProgress?.find(b=>b.isPrimary);return e.jsxs("div",{className:`flex items-center justify-between p-3 rounded-lg border ${F(w)} transition-colors`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex items-center justify-center w-8 h-8",children:o(w)}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:a.personalInfo?.fullName}),e.jsxs("div",{className:"text-sm opacity-75",children:[a.academicInfo?.class&&`כיתה ${a.academicInfo.class}`,v&&` • ${v.instrumentName}`]})]})]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:()=>f(a._id,"present"),className:`p-2 rounded-lg transition-colors ${w==="present"?"bg-green-200 text-green-800":"bg-white hover:bg-green-50 text-gray-600 hover:text-green-600"}`,title:"נוכח",children:e.jsx(Z,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>f(a._id,"absent"),className:`p-2 rounded-lg transition-colors ${w==="absent"?"bg-red-200 text-red-800":"bg-white hover:bg-red-50 text-gray-600 hover:text-red-600"}`,title:"נעדר",children:e.jsx(H,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>f(a._id,"unmarked"),className:`p-2 rounded-lg transition-colors ${w==="unmarked"?"bg-gray-200 text-gray-800":"bg-white hover:bg-gray-50 text-gray-600"}`,title:"בטל סימון",children:e.jsx(oe,{className:"w-4 h-4"})})]})]},a._id)})})}),L.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(z,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"אין תוצאות"}),e.jsx("p",{className:"text-gray-600",children:"לא נמצאו חברים התואמים לחיפוש"})]})]}),e.jsxs("div",{className:"flex justify-between pt-4 border-t border-gray-200",children:[e.jsxs("button",{onClick:B,disabled:!p||g,className:"flex items-center px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:[e.jsx(oe,{className:"w-4 h-4 ml-1"}),"איפוס"]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:x,className:"px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors",children:"ביטול"}),e.jsxs("button",{onClick:W,disabled:!p||g,className:`flex items-center px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors ${g?"cursor-wait":""}`,children:[e.jsx(He,{className:"w-4 h-4 ml-1"}),g?"שומר...":"שמור נוכחות"]})]})]})]})})})}function gt(){const s=Te(),[n,x]=l.useState([]),[i,u]=l.useState([]),[r,d]=l.useState(!0),[g,h]=l.useState(null),[p,c]=l.useState("calendar"),[j,y]=l.useState("month"),[k,I]=l.useState(new Date),[A,N]=l.useState(!1),[L,R]=l.useState(!1),[f,T]=l.useState(null),[B,W]=l.useState(!1),[M,F]=l.useState(null),[o,a]=l.useState(!1),[w,v]=l.useState(null),[b,Y]=l.useState(!1),[D,Q]=l.useState({orchestraId:"",startDate:"",endDate:""}),[ae,je]=l.useState(!1),[C,re]=l.useState({searchQuery:"",orchestraId:"",dayOfWeek:"",location:"",status:"all",startDate:"",endDate:""}),[K,ye]=l.useState("date"),[X,fe]=l.useState("asc");l.useEffect(()=>{P()},[]);const P=async()=>{try{d(!0),h(null);const[t,m]=await Promise.all([E.getRehearsals(),Xe.getOrchestras()]);x(t),u(m)}catch(t){console.error("Error loading rehearsals:",t),h("שגיאה בטעינת החזרות")}finally{d(!1)}},V=l.useMemo(()=>{const t=n.map(S=>{const $=i.find(_=>_._id===S.groupId);return{...S,orchestra:$?{_id:$._id,name:$.name,type:$.type,memberIds:$.memberIds||[],conductor:$.conductor,members:$.members}:void 0}});let m=Ee(t,C);return Le(m,K,X)},[n,i,C,K,X]),be=async(t,m)=>{try{m?await E.createBulkRehearsals(t):await E.createRehearsal(t),N(!1),await P()}catch(S){throw new Error(S.message||"שגיאה ביצירת החזרה")}},ve=async(t,m)=>{if(!(!f||m))try{await E.updateRehearsal(f._id,t),R(!1),T(null),await P()}catch(S){throw new Error(S.message||"שגיאה בעדכון החזרה")}},ne=t=>{v(t),a(!0)},Ne=async()=>{if(w)try{await E.deleteRehearsal(w),await P(),a(!1),v(null)}catch{h("שגיאה במחיקת החזרה"),a(!1),v(null)}},we=()=>{a(!1),v(null)},De=async()=>{if(!D.orchestraId||!D.startDate||!D.endDate){h("נדרש לבחור תזמורת ותאריכי התחלה וסיום");return}try{const t=await E.deleteRehearsalsByDateRange(D.orchestraId,D.startDate,D.endDate);await P(),Y(!1),Q({orchestraId:"",startDate:"",endDate:""}),h(null),console.log(`✅ נמחקו ${t.deletedCount} חזרות בהצלחה`)}catch(t){h(t.message||"שגיאה במחיקת החזרות בטווח התאריכים"),Y(!1)}},le=()=>{Y(!1),Q({orchestraId:"",startDate:"",endDate:""})},ke=async t=>{if(M)try{await E.updateAttendance(M._id,t),W(!1),F(null),await P()}catch(m){throw new Error(m.message||"שגיאה בעדכון הנוכחות")}},O=(t,m)=>{re(S=>({...S,[t]:m}))},Ce=()=>{re({searchQuery:"",orchestraId:"",dayOfWeek:"",location:"",status:"all",startDate:"",endDate:""})},Se=()=>{const t=V.map(_=>{const G=U(_),J=q(_);return{תזמורת:_.orchestra?.name||"",תאריך:G.date,יום:G.dayName,שעה:G.time,מיקום:_.location,נוכחים:J.presentCount,נעדרים:J.absentCount,אחוז_נוכחות:`${J.attendanceRate}%`,הערות:_.notes||""}}),m=[Object.keys(t[0]||{}).join(","),...t.map(_=>Object.values(_).join(","))].join(`
`),S=new Blob([m],{type:"text/csv;charset=utf-8;"}),$=document.createElement("a");$.href=URL.createObjectURL(S),$.download=`rehearsals_${new Date().toISOString().split("T")[0]}.csv`,$.click()},Re=[...new Set(n.map(t=>t.location).filter(Boolean))],$e=[{key:"orchestra",label:"תזמורת",render:t=>e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:t.orchestra?.name}),e.jsx("div",{className:"text-sm text-gray-500",children:t.type})]})},{key:"datetime",label:"תאריך ושעה",render:t=>{const m=U(t);return e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:m.date}),e.jsxs("div",{className:"text-sm text-gray-500",children:[m.dayName," • ",m.time]})]})}},{key:"location",label:"מיקום",render:t=>e.jsxs("div",{className:"flex items-center",children:[e.jsx(se,{className:"w-4 h-4 text-gray-400 ml-1"}),e.jsx("span",{className:"text-gray-900",children:t.location})]})},{key:"attendance",label:"נוכחות",render:t=>{const m=q(t);return m.hasAttendanceData?e.jsxs("div",{className:"flex items-center",children:[e.jsx(z,{className:"w-4 h-4 text-gray-400 ml-1"}),e.jsxs("span",{className:"text-gray-900",children:[m.presentCount,"/",m.totalMembers," (",m.attendanceRate,"%)"]})]}):e.jsx("span",{className:"text-gray-500 text-sm",children:"לא סומן"})}},{key:"status",label:"סטטוס",render:t=>{const m=xe(t);return e.jsx("span",{className:`inline-flex items-center px-2 py-1 text-xs font-medium rounded-full ${m.colorClass}`,children:m.text})}}];return r?e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600",children:"טוען חזרות..."})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"חזרות"}),e.jsx("p",{className:"text-gray-600",children:"ניהול חזרות תזמורת ומעקב נוכחות"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex bg-gray-100 rounded-lg p-1",children:[e.jsx("button",{onClick:()=>c("calendar"),className:`p-2 rounded-md transition-colors ${p==="calendar"?"bg-white text-gray-900 shadow-sm":"text-gray-500 hover:text-gray-700"}`,children:e.jsx(te,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>c("list"),className:`p-2 rounded-md transition-colors ${p==="list"?"bg-white text-gray-900 shadow-sm":"text-gray-500 hover:text-gray-700"}`,children:e.jsx(Ue,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>Y(!0),className:"flex items-center px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors",title:"מחיקת חזרות בטווח תאריכים",children:[e.jsx(ee,{className:"w-4 h-4 ml-1"}),"מחיקה בטווח תאריכים"]}),e.jsxs("button",{onClick:()=>N(!0),className:"flex items-center px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors",children:[e.jsx(de,{className:"w-4 h-4 ml-1"}),"חזרה חדשה"]})]})]})]}),g&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(qe,{className:"w-5 h-5 text-red-600 ml-2"}),e.jsx("span",{className:"text-red-800",children:g})]})}),e.jsxs(ie,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ue,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"חיפוש חזרות...",value:C.searchQuery,onChange:t=>O("searchQuery",t.target.value),className:"pr-10 pl-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"})]}),e.jsxs("button",{onClick:()=>je(!ae),className:"flex items-center px-3 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors",children:[e.jsx(Ye,{className:"w-4 h-4 ml-1"}),"מסננים"]}),Object.values(C).filter(t=>t&&t!=="all").length>1&&e.jsxs("span",{className:"text-sm text-primary-600",children:[Object.values(C).filter(t=>t&&t!=="all").length-1," מסננים פעילים"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:Se,className:"flex items-center px-3 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors",children:[e.jsx(Ke,{className:"w-4 h-4 ml-1"}),"ייצא"]}),p==="calendar"&&e.jsxs("div",{className:"flex bg-gray-100 rounded-lg p-1",children:[e.jsx("button",{onClick:()=>y("week"),className:`px-3 py-1 text-sm rounded transition-colors ${j==="week"?"bg-white text-gray-900 shadow-sm":"text-gray-500 hover:text-gray-700"}`,children:"שבוע"}),e.jsx("button",{onClick:()=>y("month"),className:`px-3 py-1 text-sm rounded transition-colors ${j==="month"?"bg-white text-gray-900 shadow-sm":"text-gray-500 hover:text-gray-700"}`,children:"חודש"})]})]})]}),ae&&e.jsxs("div",{className:"border-t border-gray-200 pt-4 grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"תזמורת"}),e.jsxs("select",{value:C.orchestraId,onChange:t=>O("orchestraId",t.target.value),className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500",children:[e.jsx("option",{value:"",children:"כל התזמורות"}),i.map(t=>e.jsx("option",{value:t._id,children:t.name},t._id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"יום בשבוע"}),e.jsxs("select",{value:C.dayOfWeek,onChange:t=>O("dayOfWeek",t.target.value?parseInt(t.target.value):""),className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500",children:[e.jsx("option",{value:"",children:"כל הימים"}),We.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"מיקום"}),e.jsxs("select",{value:C.location,onChange:t=>O("location",t.target.value),className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500",children:[e.jsx("option",{value:"",children:"כל המיקומים"}),Re.map(t=>e.jsx("option",{value:t,children:t},t))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"סטטוס"}),e.jsxs("select",{value:C.status,onChange:t=>O("status",t.target.value),className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500",children:[e.jsx("option",{value:"all",children:"כל החזרות"}),e.jsx("option",{value:"upcoming",children:"עתידות"}),e.jsx("option",{value:"in_progress",children:"מתקיימות"}),e.jsx("option",{value:"completed",children:"הסתיימו"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"מתאריך"}),e.jsx("input",{type:"date",value:C.startDate,onChange:t=>O("startDate",t.target.value),className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"עד תאריך"}),e.jsx("input",{type:"date",value:C.endDate,onChange:t=>O("endDate",t.target.value),className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"})]}),e.jsx("div",{className:"md:col-span-3 lg:col-span-6 flex justify-end",children:e.jsx("button",{onClick:Ce,className:"text-sm text-gray-600 hover:text-gray-800 transition-colors",children:"נקה מסננים"})})]})]}),p==="calendar"?e.jsx(Ze,{rehearsals:V,viewMode:j,selectedDate:k,onSelectDate:I,onRehearsalClick:t=>{s(`/rehearsals/${t._id}`)},onEditRehearsal:t=>{T(t),R(!0)},onDeleteRehearsal:ne,onViewDetails:t=>{s(`/rehearsals/${t._id}`)},onNavigateToRehearsal:t=>{s(`/rehearsals/${t}`)}}):e.jsxs(ie,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900",children:["חזרות (",V.length,")"]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("select",{value:`${K}-${X}`,onChange:t=>{const[m,S]=t.target.value.split("-");ye(m),fe(S)},className:"px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500",children:[e.jsx("option",{value:"date-asc",children:"תאריך (עולה)"}),e.jsx("option",{value:"date-desc",children:"תאריך (יורד)"}),e.jsx("option",{value:"orchestra-asc",children:"תזמורת (א-ת)"}),e.jsx("option",{value:"orchestra-desc",children:"תזמורת (ת-א)"}),e.jsx("option",{value:"location-asc",children:"מיקום (א-ת)"}),e.jsx("option",{value:"location-desc",children:"מיקום (ת-א)"}),e.jsx("option",{value:"time-asc",children:"שעה (מוקדם)"}),e.jsx("option",{value:"time-desc",children:"שעה (מאוחר)"})]})})]}),V.length>0?e.jsx(Me,{data:V,columns:$e,onView:t=>{s(`/rehearsals/${t._id}`)},onEdit:t=>{T(t),R(!0)},onDelete:t=>ne(t._id),actions:!0,actionLabels:{view:"נוכחות",edit:"ערוך",delete:"מחק"}}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(te,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"אין חזרות"}),e.jsx("p",{className:"text-gray-600 mb-4",children:Object.values(C).some(t=>t&&t!=="all")?"לא נמצאו חזרות התואמות למסננים":"התחל על ידי יצירת החזרה הראשונה"}),!Object.values(C).some(t=>t&&t!=="all")&&e.jsxs("button",{onClick:()=>N(!0),className:"inline-flex items-center px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors",children:[e.jsx(de,{className:"w-4 h-4 ml-1"}),"צור חזרה חדשה"]})]})]}),A&&e.jsx(ce,{orchestras:i,existingRehearsals:n,onSubmit:be,onCancel:()=>N(!1)}),L&&f&&e.jsx(ce,{orchestras:i,existingRehearsals:n,onSubmit:ve,onCancel:()=>{R(!1),T(null)},initialData:{groupId:f.groupId,type:f.type,date:f.date.split("T")[0],startTime:f.startTime,endTime:f.endTime,location:f.location,notes:f.notes,isActive:f.isActive}}),B&&M&&e.jsx(rt,{rehearsal:M,onUpdateAttendance:ke,onClose:()=>{W(!1),F(null)}}),e.jsx(_e,{isOpen:o,title:"מחיקת חזרה",message:"האם אתה בטוח שברצונך למחוק את החזרה? פעולה זו אינה ניתנת לביטול.",confirmText:"מחק",cancelText:"ביטול",onConfirm:Ne,onCancel:we,variant:"danger"}),e.jsx(Ie,{isOpen:b,onClose:le,title:"מחיקת חזרות בטווח תאריכים",maxWidth:"lg",children:e.jsxs("div",{className:"p-6",children:[e.jsx("div",{className:"mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg",children:e.jsx("p",{className:"text-yellow-800",children:"⚠️ פעולה זו תמחק את כל החזרות בטווח התאריכים שנבחר עבור התזמורת הנבחרת. פעולה זו אינה ניתנת לביטול!"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"תזמורת"}),e.jsxs("select",{value:D.orchestraId,onChange:t=>Q({...D,orchestraId:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500",required:!0,children:[e.jsx("option",{value:"",children:"בחר תזמורת"}),i.map(t=>e.jsx("option",{value:t._id,children:t.name},t._id))]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"תאריך התחלה"}),e.jsx("input",{type:"date",value:D.startDate,onChange:t=>Q({...D,startDate:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"תאריך סיום"}),e.jsx("input",{type:"date",value:D.endDate,onChange:t=>Q({...D,endDate:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500",required:!0})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 mt-6",children:[e.jsx("button",{onClick:le,className:"px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors",children:"ביטול"}),e.jsxs("button",{onClick:De,className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors",disabled:!D.orchestraId||!D.startDate||!D.endDate,children:[e.jsx(ee,{className:"w-4 h-4 ml-2 inline"}),"מחק חזרות"]})]})]})})]})}export{gt as default};
