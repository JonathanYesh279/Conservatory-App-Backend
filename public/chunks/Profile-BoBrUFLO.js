import{j as e,u as Te,V as _e}from"../assets/index-CshNMQn7.js";import{R as it,r as i,u as lt,b as ot}from"./vendor-B2j9q2e_.js";import{a as R,t as ze}from"./cascade-deletion-pmc3scKx.js";import{M as we,J as qe,O as Be,T as Re,U as Le,e as Ne,Z as Je,b as xe,d as he,r as Oe,u as ct,c as Ue,A as Me,t as ye,m as ve,X as Se,f as fe,P as ke,ab as Ke,i as dt,E as mt,ac as ut,B as $e,v as Ge,g as gt,G as Ve,W as Xe,an as xt,j as ht,ah as ft,S as pt,a3 as yt,K as bt}from"./ui-26XYoSED.js";import{C as jt}from"./ConfirmationModal-Qas-wp2_.js";import{t as Ye}from"./theoryEnrollmentService-BfFV5mlM.js";import"./query-BI61muSV.js";import"./utils-Cgyyg58q.js";function vt({student:t,onEdit:v,onDelete:T,onViewDetails:b,onScheduleLesson:j,onUpdateLesson:l,onMarkAttendance:a,onAddNote:r,className:w=""}){const p=t.academicInfo?.instrumentProgress?.find(m=>m.isPrimary)||t.academicInfo?.instrumentProgress?.[0],$=p?.instrumentName||"לא הוגדר",d=p?.currentStage||0,M=t.scheduleInfo||t.teacherAssignments?.[0],P=M?`${M.day} ${M.startTime||M.time}`:null,c=M?.duration||60,N=!!M,D=t.academicInfo?.isActive!==!1&&t.status!=="inactive",x=D?"text-green-800 bg-green-100":"text-red-800 bg-red-100",h=D?"פעיל":"לא פעיל",z=D?Ue:Me,C=N?"border-2 border-green-400 shadow-sm shadow-green-200":"border border-gray-200";return e.jsxs("div",{className:`bg-white ${C} rounded-lg hover:shadow-lg hover:border-indigo-300 transition-all duration-200 transform hover:-translate-y-1 group ${w}`,children:[e.jsx("div",{className:"px-4 py-3 border-b border-gray-100",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h4",{className:"font-semibold text-gray-900 font-reisinger-yonatan text-lg",children:t.personalInfo.fullName}),e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${x}`,children:[it.createElement(z,{className:"w-3 h-3"}),h]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(we,{className:"w-4 h-4 text-indigo-500"}),e.jsx("span",{className:"font-reisinger-yonatan font-medium",children:$}),d>0&&e.jsxs("span",{className:"text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full font-reisinger-yonatan",children:["שלב ",d]})]})]}),e.jsxs("div",{className:"flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:[e.jsx("button",{onClick:()=>b(t.id),className:"p-1.5 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all duration-200",title:"צפה בפרטים מלאים",children:e.jsx(qe,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>v(t),className:"p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all duration-200",title:"עריכת תלמיד",children:e.jsx(Be,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>T(t.id),className:"p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all duration-200",title:"מחיקת תלמיד",children:e.jsx(Re,{className:"w-4 h-4"})})]})]})}),e.jsxs("div",{className:"px-4 py-3 space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{className:"space-y-1",children:[t.personalInfo.age&&e.jsxs("div",{className:"flex items-center gap-2 text-gray-600",children:[e.jsx(Le,{className:"w-3 h-3"}),e.jsxs("span",{className:"font-reisinger-yonatan",children:["גיל: ",t.personalInfo.age]})]}),t.personalInfo.class&&e.jsxs("div",{className:"flex items-center gap-2 text-gray-600",children:[e.jsx(Ne,{className:"w-3 h-3"}),e.jsxs("span",{className:"font-reisinger-yonatan",children:["כיתה: ",t.personalInfo.class]})]})]}),e.jsx("div",{className:"space-y-1",children:t.personalInfo.phone&&e.jsxs("div",{className:"flex items-center gap-2 text-gray-600",dir:"ltr",children:[e.jsx(Je,{className:"w-3 h-3"}),e.jsx("span",{className:"font-mono text-xs",children:t.personalInfo.phone})]})})]}),P&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-blue-800 font-reisinger-yonatan",children:[e.jsx(xe,{className:"w-4 h-4"}),e.jsx("span",{className:"font-medium",children:"שיעור קבוע:"})]}),e.jsxs("div",{className:"flex items-center justify-between mt-1",children:[e.jsx("span",{className:"text-sm font-reisinger-yonatan text-blue-700",children:P}),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-blue-600",children:[e.jsx(he,{className:"w-3 h-3"}),e.jsxs("span",{children:[c," דק'"]})]})]})]})]}),e.jsx("div",{className:"px-4 py-3 border-t border-gray-100 bg-gray-50",children:e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("button",{onClick:()=>b(t.id),className:"text-indigo-600 hover:text-indigo-800 hover:bg-indigo-100 px-3 py-1 rounded-lg text-sm font-medium font-reisinger-yonatan transition-all duration-200 flex items-center gap-1",children:[e.jsx(qe,{className:"w-4 h-4"}),"פרטים מלאים"]}),N&&l?e.jsxs("button",{onClick:()=>l(t),className:"text-blue-600 hover:text-blue-800 hover:bg-blue-100 px-3 py-1 rounded-lg text-sm font-medium font-reisinger-yonatan transition-all duration-200 flex items-center gap-1",children:[e.jsx(xe,{className:"w-4 h-4"}),"עדכן שיעור קבוע"]}):j&&!N?e.jsxs("button",{onClick:()=>j(t.id),className:"text-green-600 hover:text-green-800 hover:bg-green-100 px-3 py-1 rounded-lg text-sm font-medium font-reisinger-yonatan transition-all duration-200 flex items-center gap-1",children:[e.jsx(xe,{className:"w-4 h-4"}),"תזמן שיעור"]}):null,a&&e.jsxs("button",{onClick:()=>a(t.id),className:"text-blue-600 hover:text-blue-800 hover:bg-blue-100 px-3 py-1 rounded-lg text-sm font-medium font-reisinger-yonatan transition-all duration-200 flex items-center gap-1",children:[e.jsx(Oe,{className:"w-4 h-4"}),"נוכחות"]}),r&&e.jsxs("button",{onClick:()=>r(t.id),className:"text-yellow-600 hover:text-yellow-800 hover:bg-yellow-100 px-3 py-1 rounded-lg text-sm font-medium font-reisinger-yonatan transition-all duration-200 flex items-center gap-1",children:[e.jsx(ct,{className:"w-4 h-4"}),"הערה"]})]})})]})}const Nt=[30,45,60];function wt(){const{user:t}=Te(),[v,T]=i.useState([]),[b,j]=i.useState(!0),[l,a]=i.useState("");i.useState(!1),i.useState(null);const[r,w]=i.useState(null),[p,$]=i.useState(0);i.useState(!1);const[d,M]=i.useState({status:"all",instrument:"all",hasSchedule:"all",bagrutStatus:"all"});i.useState("cards"),i.useState(new Set),i.useState(!1);const[P,c]=i.useState(!1),[N,D]=i.useState([]),[x,h]=i.useState(!1),[z,C]=i.useState(!1),[m,_]=i.useState(!1),[u,E]=i.useState(null),[O,A]=i.useState([]);i.useEffect(()=>{q()},[t]);const q=async(k=!0)=>{if(t?._id)try{k&&j(!0),w(null);const F=t._id,X=await R.teachers.getTeacher(F);if(!X)throw new Error("לא נמצא פרופיל מורה");const V=X?.teaching?.studentIds||[];try{const g=await R.teacherSchedule.getTimeBlocks(F);let J=[];Array.isArray(g)?J=g:g?.data&&Array.isArray(g.data)&&(J=g.data),A(J.filter(W=>W._id&&W._id!=="undefined"))}catch(g){console.warn("Failed to load teaching days:",g),A([])}if(V.length===0){console.log("No students assigned to teacher"),T([]),$(0);return}const Y=await R.students.getBatchStudents(V);if(!Array.isArray(Y))throw new Error("תגובה לא תקינה מהשרת");const te=Y.filter(g=>V.includes(g._id)||V.includes(g.id));te.length!==Y.length&&console.warn(`🔧 Component-level filtering: ${te.length}/${Y.length} students match teacher's student IDs`);const n=te.map(g=>{const J=g.personalInfo?.fullName||"",W=J.split(" ");return{id:g._id,firstName:g.personalInfo?.firstName||W[0]||"",lastName:g.personalInfo?.lastName||W.slice(1).join(" ")||"",fullName:J,email:g.personalInfo?.email||g.contactInfo?.email||"",phone:g.personalInfo?.phone||g.contactInfo?.phone||"",instrument:g.academicInfo?.primaryInstrument||g.primaryInstrument||"",grade:g.academicInfo?.gradeLevel||"",status:g.academicInfo?.isActive!==!1?"active":"inactive",joinDate:g.createdAt,personalInfo:{fullName:J,phone:g.personalInfo?.phone||g.contactInfo?.phone,age:g.personalInfo?.age,class:g.personalInfo?.class||g.academicInfo?.class},academicInfo:{instrumentProgress:g.academicInfo?.instrumentProgress||[],isActive:g.academicInfo?.isActive!==!1},teacherAssignments:g.teacherAssignments||[],scheduleInfo:g.scheduleInfo}});T(n),$(0)}catch(F){console.error("Error loading teacher students:",F),w("שגיאה בטעינת רשימת התלמידים. בדוק את החיבור לאינטרנט ונסה שוב."),$(X=>X+1)}finally{k&&j(!1)}},ne=async()=>{try{h(!0);const k=await R.students.getStudents();if(!k||!Array.isArray(k)){console.error("Invalid response from getStudents"),D([]);return}const F=t?._id,V=(await R.teachers.getTeacher(F))?.teaching?.studentIds||[],Y=k.filter(te=>!V.includes(te._id)&&!V.includes(te.id));D(Y)}catch(k){console.error("Error loading all students:",k),D([])}finally{h(!1)}},y=v.filter(k=>{const F=l===""||`${k.firstName} ${k.lastName}`.toLowerCase().includes(l.toLowerCase())||k.instrument?.toLowerCase().includes(l.toLowerCase())||k.email?.toLowerCase().includes(l.toLowerCase()),X=d.status==="all"||k.status===d.status,V=d.instrument==="all"||k.instrument===d.instrument,Y=k.scheduleInfo||k.teacherAssignments?.length>0,te=d.hasSchedule==="all"||d.hasSchedule==="yes"&&Y||d.hasSchedule==="no"&&!Y,n=k.academicInfo?.isBagrutStudent||k.academicInfo?.instrumentProgress?.some(J=>J.currentStage>=4),g=d.bagrutStatus==="all"||d.bagrutStatus==="yes"&&n||d.bagrutStatus==="no"&&!n;return F&&X&&V&&te&&g}),S=async k=>{const F=v.find(V=>V.id===k),X=F?.personalInfo?.fullName||F?.fullName||"התלמיד";if(window.confirm(`האם אתה בטוח שברצונך למחוק את ${X}?

פעולה זו תמחק את כל הנתונים הקשורים לתלמיד ולא ניתנת לביטול.`))try{await R.students.deleteStudent(k),T(Y=>Y.filter(te=>te.id!==k));const V=document.createElement("div");V.className="fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg z-50",V.innerHTML=`<div class="flex items-center gap-2 font-reisinger-yonatan"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>${X} נמחק בהצלחה</div>`,document.body.appendChild(V),setTimeout(()=>V.remove(),3e3)}catch(V){console.error("Error deleting student:",V);const Y=document.createElement("div");Y.className="fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg z-50",Y.innerHTML=`<div class="flex items-center gap-2 font-reisinger-yonatan"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>שגיאה במחיקת ${X}</div>`,document.body.appendChild(Y),setTimeout(()=>Y.remove(),5e3)}},Q=k=>{window.location.href=`/students/${k}`},Z=k=>{const F=v.find(X=>X.id===k);F&&(E(F),C(!0))},oe=k=>{E(k),_(!0)},re=(k,F)=>{const X=document.createElement("div");X.className=`fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 ${F==="success"?"bg-green-500 text-white":F==="error"?"bg-red-500 text-white":"bg-blue-500 text-white"}`,X.innerHTML=`<div class="flex items-center gap-2 font-reisinger-yonatan">
      ${F==="success"?"✅":F==="error"?"❌":"ℹ️"} ${k}
    </div>`,document.body.appendChild(X),setTimeout(()=>X.remove(),3e3)},ce=async(k,F)=>{try{const X=t?._id,V=await R.students.getStudent(k._id),Y=(V.teacherAssignments||[]).findIndex(g=>g.teacherId===X),te={teacherId:X,day:F.lessonDay,time:F.lessonTime,duration:F.lessonDuration||45,location:F.lessonLocation||"",isActive:!0};let n;Y>=0?(n=[...V.teacherAssignments||[]],n[Y]={...n[Y],...te}):n=[...V.teacherAssignments||[],te],await R.students.updateStudent(k._id,{teacherAssignments:n}),await q(),re(`${k.personalInfo?.fullName} הוקצה בהצלחה`,"success"),c(!1)}catch(X){console.error("Error assigning student:",X),re("שגיאה בהקצאת התלמיד","error")}};return b?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600",children:"טוען רשימת תלמידים..."})]})}):r?e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-red-100 flex items-center justify-center",children:e.jsx("svg",{className:"w-4 h-4 text-red-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.728-.833-2.498 0L4.316 15.5c-.77.833.192 2.5 1.732 2.5z"})})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-red-800 font-semibold font-reisinger-yonatan",children:"שגיאה בטעינת הנתונים"}),e.jsx("p",{className:"text-red-700 text-sm font-reisinger-yonatan mt-1",children:r})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>q(),className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm font-reisinger-yonatan",children:"נסה שוב"}),p>2&&e.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm font-reisinger-yonatan",children:"רענן דף"})]})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:"התלמידים שלי"}),e.jsxs("p",{className:"text-gray-600 mt-1",children:[v.length," תלמידים רשומים"]})]}),e.jsxs("button",{onClick:()=>{c(!0),ne()},className:"flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors",children:[e.jsx(ye,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"הקצה תלמיד"})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(ve,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"חיפוש תלמידים...",value:l,onChange:k=>a(k.target.value),className:"w-full pl-4 pr-12 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"rtl"})]}),y.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ye,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2 font-reisinger-yonatan",children:l?"לא נמצאו תלמידים":"אין תלמידים רשומים"}),e.jsx("p",{className:"text-gray-600 font-reisinger-yonatan",children:l?"נסה מילות חיפוש אחרות":"התחל בהוספת התלמיד הראשון שלך"}),!l&&e.jsxs("button",{onClick:()=>{c(!0),ne()},className:"mt-4 inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-reisinger-yonatan",children:[e.jsx(ye,{className:"w-4 h-4"}),"הקצה תלמיד ראשון"]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ye,{className:"w-5 h-5 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-900 font-reisinger-yonatan",children:"סה״כ תלמידים"})]}),e.jsx("div",{className:"text-2xl font-bold text-blue-900 mt-1",children:v.length})]}),e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(qe,{className:"w-5 h-5 text-green-600"}),e.jsx("span",{className:"font-medium text-green-900 font-reisinger-yonatan",children:"פעילים"})]}),e.jsx("div",{className:"text-2xl font-bold text-green-900 mt-1",children:v.filter(k=>k.status==="active").length})]}),e.jsxs("div",{className:"bg-purple-50 border border-purple-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xe,{className:"w-5 h-5 text-purple-600"}),e.jsx("span",{className:"font-medium text-purple-900 font-reisinger-yonatan",children:"עם שיעורים"})]}),e.jsx("div",{className:"text-2xl font-bold text-purple-900 mt-1",children:v.filter(k=>k.scheduleInfo||k.teacherAssignments?.length>0).length})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6",children:y.map(k=>e.jsx(vt,{student:k,onEdit:F=>{alert("עריכת תלמיד זמינה רק למנהלים")},onDelete:S,onViewDetails:Q,onScheduleLesson:Z,onUpdateLesson:oe},k.id))})]}),P&&e.jsx(St,{allStudents:N,loading:x,onClose:()=>{c(!1),D([])},onSubmit:ce}),z&&u&&e.jsx(Tt,{student:u,teacherId:t?._id||"",teachingDays:O,onClose:()=>{C(!1),E(null)},onSave:()=>{C(!1),E(null),q(!1)},showNotification:re}),m&&u&&e.jsx(Ct,{student:u,teacherId:t?._id||"",teachingDays:O,onClose:()=>{_(!1),E(null)},onSave:()=>{_(!1),E(null),q(!1)},showNotification:re})]})}function St({allStudents:t,loading:v,onClose:T,onSubmit:b}){const{user:j}=Te(),[l,a]=i.useState(""),[r,w]=i.useState(null),[p,$]=i.useState({lessonDay:"",lessonTime:"",lessonDuration:45,lessonLocation:"",instrument:""}),[d,M]=i.useState(!1),[P,c]=i.useState([]),[N,D]=i.useState(!1),[x,h]=i.useState(null),z=t.filter(u=>{const E=l.toLowerCase().trim();if(!E)return!0;const O=u.personalInfo?.fullName||`${u.personalInfo?.firstName||""} ${u.personalInfo?.lastName||""}`.trim(),A=u.personalInfo?.class||u.academicInfo?.class||"",q=[u.academicInfo?.primaryInstrument,...u.academicInfo?.instrumentProgress?.map(S=>S.instrumentName)||[]].filter(Boolean).join(" "),ne=`${O} ${A} ${q}`.toLowerCase();return E.split(/\s+/).filter(S=>S.length>0).every(S=>ne.includes(S))});i.useEffect(()=>{r&&j?._id&&C()},[r,j?._id]);const C=async()=>{if(j?._id){D(!0);try{const u=await R.teachers.getTeacher(j._id);console.log("Teacher data for slots:",u);const E=u.teaching?.timeBlocks?.filter(A=>A.isActive!==!1)||[];console.log("Time blocks found:",E);const O=[];E.forEach(A=>{const q=A.startTime,ne=A.endTime,y=A.day,[S,Q]=q.split(":").map(Number),[Z,oe]=ne.split(":").map(Number),re=S*60+Q,k=Z*60+oe-re;Nt.forEach(F=>{const X=Math.floor(k/F);for(let V=0;V<X;V++){const Y=re+V*F,te=Y+F,n=Math.floor(Y/60),g=Y%60,J=Math.floor(te/60),W=te%60,B=`${n.toString().padStart(2,"0")}:${g.toString().padStart(2,"0")}`,s=`${J.toString().padStart(2,"0")}:${W.toString().padStart(2,"0")}`;u.teaching?.schedule?.some(U=>U.day===y&&U.time===B&&U.duration===F)||!1||O.push({_id:`${A._id||A.day}-${F}-${V}`,day:y,startTime:B,endTime:s,duration:F,isAvailable:!0,location:A.location,teacherName:u.personalInfo?.fullName,teacherId:u._id,instrument:u.professionalInfo?.instrument||u.teaching?.instrument})}})}),console.log("Generated available slots:",O),c(O)}catch(u){console.error("Error fetching teacher slots:",u),c([])}finally{D(!1)}}},m=u=>{h(u),$({lessonDay:u.day,lessonTime:u.startTime,lessonDuration:u.duration,lessonLocation:u.location||"",instrument:u.instrument||""})},_=async u=>{if(u.preventDefault(),!r){alert("אנא בחר תלמיד");return}if(!x){alert("אנא בחר זמן שיעור");return}M(!0);try{await b(r,p)}catch(E){console.error("Error submitting assignment:",E)}finally{M(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto flex flex-col",dir:"rtl",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 mb-4 font-reisinger-yonatan",children:"הקצאת תלמיד קיים"}),v?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"}),e.jsx("span",{className:"mr-3 text-gray-600",children:"טוען רשימת תלמידים..."})]}):e.jsxs("form",{onSubmit:_,className:"flex flex-col flex-1 overflow-hidden",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:"חפש תלמיד במערכת"}),e.jsxs("div",{className:"relative",children:[e.jsx(ve,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"חפש לפי שם, כיתה או כלי נגינה...",value:l,onChange:u=>a(u.target.value),className:"w-full pl-4 pr-12 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"rtl"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto mb-4 border border-gray-200 rounded-lg",children:z.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:l?"לא נמצאו תלמידים התואמים את החיפוש":"אין תלמידים זמינים להקצאה"}):e.jsx("div",{className:"divide-y divide-gray-200",children:z.map(u=>{const E=u.personalInfo?.fullName||`${u.personalInfo?.firstName||""} ${u.personalInfo?.lastName||""}`.trim(),O=u.personalInfo?.class||u.academicInfo?.class||"",A=u.academicInfo?.primaryInstrument||"",q=r?._id===u._id;return e.jsx("div",{onClick:()=>w(u),className:`p-3 cursor-pointer transition-colors ${q?"bg-indigo-50 border-r-4 border-indigo-600":"hover:bg-gray-50"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:E}),e.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:[O&&e.jsxs("span",{children:["כיתה ",O]}),A&&e.jsxs(e.Fragment,{children:[O&&" • ",e.jsx("span",{children:A})]})]})]}),q&&e.jsx("div",{className:"w-6 h-6 bg-indigo-600 rounded-full flex items-center justify-center",children:e.jsx(Oe,{className:"w-4 h-4 text-white"})})]})},u._id)})})}),r&&e.jsxs("div",{className:"space-y-4 border-t pt-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h4",{className:"font-medium text-gray-900 font-reisinger-yonatan",children:["בחר זמן שיעור עבור ",r.personalInfo?.fullName]}),x&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-green-600 bg-green-50 px-3 py-1 rounded-lg",children:[e.jsx(Oe,{className:"w-4 h-4"}),e.jsxs("span",{children:["נבחר: ",x.day," ",x.startTime]})]})]}),N?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"}),e.jsx("span",{className:"mr-3 text-gray-600",children:"טוען זמנים פנויים..."})]}):P.length>0?e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 mb-3",children:"בחר זמן ומשך שיעור מהאפשרויות הזמינות:"}),(()=>{const u=P.reduce((E,O)=>(E[O.day]||(E[O.day]=[]),E[O.day].push(O),E),{});return Object.entries(u).map(([E,O])=>e.jsxs("div",{className:"mb-4",children:[e.jsxs("h5",{className:"text-sm font-medium text-gray-600 mb-2 flex items-center gap-2",children:[e.jsx(xe,{className:"w-4 h-4"}),"יום ",E]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 pr-1",children:O.sort((A,q)=>A.startTime.localeCompare(q.startTime)).map(A=>{const q=x?._id===A._id;return e.jsx("button",{type:"button",onClick:()=>m(A),className:`p-3 border rounded-lg transition-all text-right ${q?"border-indigo-600 bg-indigo-50 ring-2 ring-indigo-600":A.duration===30?"border-green-300 bg-green-50 hover:border-green-500 hover:bg-green-100":A.duration===45?"border-blue-300 bg-blue-50 hover:border-blue-500 hover:bg-blue-100":"border-purple-300 bg-purple-50 hover:border-purple-500 hover:bg-purple-100"}`,children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(he,{className:"w-3 h-3"}),e.jsxs("span",{className:"text-sm font-medium text-gray-900",children:[A.startTime,"-",A.endTime]})]}),e.jsxs("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${A.duration===30?"bg-green-100 text-green-800":A.duration===45?"bg-blue-100 text-blue-800":"bg-purple-100 text-purple-800"}`,children:[A.duration," דק׳"]})]}),A.location&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-gray-500",children:[e.jsx(Ne,{className:"w-3 h-3"}),A.location]}),A.instrument&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-gray-600",children:[e.jsx(we,{className:"w-3 h-3"}),A.instrument]}),q&&e.jsx("div",{className:"flex justify-center mt-2",children:e.jsx(Oe,{className:"w-5 h-5 text-indigo-600"})})]})},A._id)})})]},E))})()]}):e.jsxs("div",{className:"text-center py-6 bg-gray-50 rounded-lg",children:[e.jsx(he,{className:"w-12 h-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-gray-500 text-sm mb-2",children:"אין זמנים פנויים"}),e.jsx("p",{className:"text-xs text-gray-400",children:"ייתכן שכל הזמנים הפנויים כבר תפוסים או שלא הוגדרו זמני הוראה"})]})]}),e.jsxs("div",{className:"flex gap-3 mt-6 pt-4 border-t",children:[e.jsx("button",{type:"submit",disabled:!r||!x||d,className:"flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 font-reisinger-yonatan flex items-center justify-center gap-2",children:d?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"מקצה..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ye,{className:"w-4 h-4"}),"הקצה תלמיד"]})}),e.jsxs("button",{type:"button",onClick:T,disabled:d,className:"flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 font-reisinger-yonatan flex items-center justify-center gap-2",children:[e.jsx(Se,{className:"w-4 h-4"}),"ביטול"]})]})]})]})})}function Tt({student:t,teacherId:v,teachingDays:T,onClose:b,onSave:j,showNotification:l}){const[a,r]=i.useState({day:"",startTime:"",endTime:"",duration:45,location:"",notes:""}),[w,p]=i.useState(!1),$=["ראשון","שני","שלישי","רביעי","חמישי","שישי"],d=[30,45,60],M=c=>{if(!a.startTime)return;const[N,D]=a.startTime.split(":").map(Number),x=N*60+D+c,h=Math.floor(x/60),z=x%60;r(C=>({...C,duration:c,endTime:`${String(h).padStart(2,"0")}:${String(z).padStart(2,"0")}`}))},P=async c=>{if(c.preventDefault(),!a.day||!a.startTime||!a.endTime){l("יש למלא את כל השדות הנדרשים","error");return}try{p(!0);const N={day:a.day,startTime:a.startTime,endTime:a.endTime,location:a.location||"חדר מוזיקה",duration:a.duration,notes:a.notes,studentId:t.id,studentName:t.personalInfo?.fullName||t.fullName,teacherId:v,recurring:{isRecurring:!0,excludeDates:[]}};await R.teacherSchedule.createTimeBlock(v,N),l("השיעור הקבוע נוצר בהצלחה","success"),j()}catch(N){console.error("Error creating lesson:",N),l(N.message||"שגיאה ביצירת השיעור","error")}finally{p(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-md mx-4",dir:"rtl",children:[e.jsxs("h3",{className:"text-xl font-bold text-gray-900 mb-4 font-reisinger-yonatan",children:["תזמן שיעור קבוע - ",t.personalInfo?.fullName||t.fullName]}),e.jsxs("form",{onSubmit:P,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:"יום"}),e.jsxs("select",{value:a.day,onChange:c=>r(N=>({...N,day:c.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-reisinger-yonatan",required:!0,children:[e.jsx("option",{value:"",children:"בחר יום"}),$.map(c=>e.jsx("option",{value:c,children:c},c))]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:"שעת התחלה"}),e.jsx("input",{type:"time",value:a.startTime,onChange:c=>{r(N=>({...N,startTime:c.target.value})),a.duration&&M(a.duration)},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:"משך (דקות)"}),e.jsx("select",{value:a.duration,onChange:c=>M(Number(c.target.value)),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-reisinger-yonatan",children:d.map(c=>e.jsxs("option",{value:c,children:[c," דק'"]},c))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:"מיקום"}),e.jsxs("select",{value:a.location,onChange:c=>r(N=>({...N,location:c.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-reisinger-yonatan",children:[e.jsx("option",{value:"",children:"בחר מיקום"}),_e.map(c=>e.jsx("option",{value:c,children:c},c))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:"הערות"}),e.jsx("textarea",{value:a.notes,onChange:c=>r(N=>({...N,notes:c.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-reisinger-yonatan",rows:3,placeholder:"הערות נוספות..."})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{type:"submit",disabled:w,className:"flex-1 bg-indigo-600 text-white py-2.5 px-4 rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 font-reisinger-yonatan font-medium",children:w?"שומר...":"שמור"}),e.jsx("button",{type:"button",onClick:b,disabled:w,className:"flex-1 bg-gray-200 text-gray-700 py-2.5 px-4 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 font-reisinger-yonatan font-medium",children:"ביטול"})]})]})]})})}function Ct({student:t,teacherId:v,teachingDays:T,onClose:b,onSave:j,showNotification:l}){const a=t.scheduleInfo||t.teacherAssignments?.[0],[r,w]=i.useState({day:a?.day||"",startTime:a?.startTime||a?.time||"",duration:a?.duration||45,endTime:a?.endTime||"",location:"",notes:""}),[p,$]=i.useState(!1),[d,M]=i.useState(null),P=["ראשון","שני","שלישי","רביעי","חמישי","שישי"],c=[30,45,60];i.useEffect(()=>{N()},[]);const N=async()=>{try{const h=await R.teacherSchedule.getTimeBlocks(v);let z=[];Array.isArray(h)?z=h:h?.data&&Array.isArray(h.data)&&(z=h.data);const C=z.find(m=>m.studentId===t.id);C&&(M(C._id),w({day:C.day,startTime:C.startTime,endTime:C.endTime,duration:C.duration||45,location:C.location||"",notes:C.notes||""}))}catch(h){console.error("Error loading time block:",h)}},D=h=>{if(!r.startTime)return;const[z,C]=r.startTime.split(":").map(Number),m=z*60+C+h,_=Math.floor(m/60),u=m%60;w(E=>({...E,duration:h,endTime:`${String(_).padStart(2,"0")}:${String(u).padStart(2,"0")}`}))},x=async h=>{if(h.preventDefault(),!d){l("לא נמצא שיעור קבוע לעדכון","error");return}if(!r.day||!r.startTime||!r.endTime){l("יש למלא את כל השדות הנדרשים","error");return}try{$(!0);const z={day:r.day,startTime:r.startTime,endTime:r.endTime,location:r.location||"חדר מוזיקה",duration:r.duration,notes:r.notes};await R.teacherSchedule.updateTimeBlock(v,d,z),l("השיעור הקבוע עודכן בהצלחה","success"),j()}catch(z){console.error("Error updating lesson:",z),l(z.message||"שגיאה בעדכון השיעור","error")}finally{$(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-md mx-4",dir:"rtl",children:[e.jsxs("h3",{className:"text-xl font-bold text-gray-900 mb-4 font-reisinger-yonatan",children:["עדכן שיעור קבוע - ",t.personalInfo?.fullName||t.fullName]}),e.jsxs("form",{onSubmit:x,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:"יום"}),e.jsxs("select",{value:r.day,onChange:h=>w(z=>({...z,day:h.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-reisinger-yonatan",required:!0,children:[e.jsx("option",{value:"",children:"בחר יום"}),P.map(h=>e.jsx("option",{value:h,children:h},h))]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:"שעת התחלה"}),e.jsx("input",{type:"time",value:r.startTime,onChange:h=>{w(z=>({...z,startTime:h.target.value})),r.duration&&D(r.duration)},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:"משך (דקות)"}),e.jsx("select",{value:r.duration,onChange:h=>D(Number(h.target.value)),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-reisinger-yonatan",children:c.map(h=>e.jsxs("option",{value:h,children:[h," דק'"]},h))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:"מיקום"}),e.jsxs("select",{value:r.location,onChange:h=>w(z=>({...z,location:h.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-reisinger-yonatan",children:[e.jsx("option",{value:"",children:"בחר מיקום"}),_e.map(h=>e.jsx("option",{value:h,children:h},h))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:"הערות"}),e.jsx("textarea",{value:r.notes,onChange:h=>w(z=>({...z,notes:h.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-reisinger-yonatan",rows:3,placeholder:"הערות נוספות..."})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{type:"submit",disabled:p,className:"flex-1 bg-indigo-600 text-white py-2.5 px-4 rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 font-reisinger-yonatan font-medium",children:p?"מעדכן...":"עדכן"}),e.jsx("button",{type:"button",onClick:b,disabled:p,className:"flex-1 bg-gray-200 text-gray-700 py-2.5 px-4 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 font-reisinger-yonatan font-medium",children:"ביטול"})]})]})]})})}function kt({isOpen:t,onClose:v,orchestraId:T,orchestraName:b,onSave:j}){const[l,a]=i.useState({date:"",startTime:"19:00",endTime:"21:00",location:"אולם מוזיקה",notes:"",recurring:!1,recurrencePattern:"weekly",endRecurrence:""}),[r,w]=i.useState({}),[p,$]=i.useState(!1);i.useEffect(()=>{if(t){const c=new Date;c.setDate(c.getDate()+1),a(N=>({...N,date:c.toISOString().split("T")[0]}))}},[t]);const d=()=>{const c={};if(!l.date)c.date="יש לבחור תאריך";else{const N=new Date(l.date),D=new Date;D.setHours(0,0,0,0),N<D&&(c.date="לא ניתן לקבוע חזרה בעבר")}if(l.startTime||(c.startTime="יש לבחור שעת התחלה"),l.endTime||(c.endTime="יש לבחור שעת סיום"),l.startTime&&l.endTime){const N=new Date(`2000-01-01T${l.startTime}`);new Date(`2000-01-01T${l.endTime}`)<=N&&(c.endTime="שעת הסיום חייבת להיות אחרי שעת ההתחלה")}return l.location.trim()||(c.location="יש לציין מקום"),l.recurring&&!l.endRecurrence&&(c.endRecurrence="יש לציין תאריך סיום לחזרות קבועות"),w(c),Object.keys(c).length===0},M=async c=>{if(c.preventDefault(),!!d()){$(!0);try{await j(l),v(),a({date:"",startTime:"19:00",endTime:"21:00",location:"אולם מוזיקה",notes:"",recurring:!1,recurrencePattern:"weekly",endRecurrence:""})}catch(N){console.error("Error saving rehearsal:",N)}finally{$(!1)}}},P=()=>{if(!l.startTime||!l.endTime)return"";const c=new Date(`2000-01-01T${l.startTime}`),D=(new Date(`2000-01-01T${l.endTime}`).getTime()-c.getTime())/(1e3*60);if(D<=0)return"";const x=Math.floor(D/60),h=D%60;return x===0?`${h} דקות`:h===0?`${x} שעות`:`${x} שעות ו-${h} דקות`};return t?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900 font-reisinger-yonatan",children:"קביעת חזרה חדשה"}),e.jsx("button",{onClick:v,className:"p-1 text-gray-400 hover:text-gray-600 rounded",children:e.jsx(Se,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center gap-2 text-blue-800",children:[e.jsx(fe,{className:"w-4 h-4"}),e.jsxs("span",{className:"font-medium font-reisinger-yonatan",children:["תזמורת: ",b]})]})}),e.jsxs("form",{onSubmit:M,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"תאריך החזרה *"}),e.jsxs("div",{className:"relative",children:[e.jsx(xe,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"date",required:!0,value:l.date,onChange:c=>a(N=>({...N,date:c.target.value})),className:`w-full pl-3 pr-10 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 ${r.date?"border-red-300":"border-gray-300"}`})]}),r.date&&e.jsx("p",{className:"text-red-600 text-xs mt-1 font-reisinger-yonatan",children:r.date})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שעת התחלה *"}),e.jsxs("div",{className:"relative",children:[e.jsx(he,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"time",required:!0,value:l.startTime,onChange:c=>a(N=>({...N,startTime:c.target.value})),className:`w-full pl-3 pr-10 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 ${r.startTime?"border-red-300":"border-gray-300"}`})]}),r.startTime&&e.jsx("p",{className:"text-red-600 text-xs mt-1 font-reisinger-yonatan",children:r.startTime})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שעת סיום *"}),e.jsxs("div",{className:"relative",children:[e.jsx(he,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"time",required:!0,value:l.endTime,onChange:c=>a(N=>({...N,endTime:c.target.value})),className:`w-full pl-3 pr-10 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 ${r.endTime?"border-red-300":"border-gray-300"}`})]}),r.endTime&&e.jsx("p",{className:"text-red-600 text-xs mt-1 font-reisinger-yonatan",children:r.endTime})]})]}),P()&&e.jsxs("div",{className:"text-sm text-gray-600 bg-gray-50 p-2 rounded font-reisinger-yonatan",children:["משך החזרה: ",P()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"מקום החזרה *"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ne,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"text",required:!0,value:l.location,onChange:c=>a(N=>({...N,location:c.target.value})),className:`w-full pl-3 pr-10 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 ${r.location?"border-red-300":"border-gray-300"}`,placeholder:"למשל: אולם מוזיקה, חדר 101"})]}),r.location&&e.jsx("p",{className:"text-red-600 text-xs mt-1 font-reisinger-yonatan",children:r.location})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"הערות"}),e.jsx("textarea",{value:l.notes,onChange:c=>a(N=>({...N,notes:c.target.value})),rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",placeholder:"הערות נוספות על החזרה (אופציונלי)"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{id:"recurring",type:"checkbox",checked:l.recurring,onChange:c=>a(N=>({...N,recurring:c.target.checked})),className:"h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"}),e.jsx("label",{htmlFor:"recurring",className:"mr-2 text-sm text-gray-700 font-reisinger-yonatan",children:"חזרה קבועה (חוזרת)"})]}),l.recurring&&e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"תדירות"}),e.jsxs("select",{value:l.recurrencePattern,onChange:c=>a(N=>({...N,recurrencePattern:c.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"weekly",children:"שבועי"}),e.jsx("option",{value:"biweekly",children:"דו-שבועי"}),e.jsx("option",{value:"monthly",children:"חודשי"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"תאריך סיום החזרות הקבועות *"}),e.jsx("input",{type:"date",required:l.recurring,value:l.endRecurrence,onChange:c=>a(N=>({...N,endRecurrence:c.target.value})),className:`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 ${r.endRecurrence?"border-red-300":"border-gray-300"}`}),r.endRecurrence&&e.jsx("p",{className:"text-red-600 text-xs mt-1 font-reisinger-yonatan",children:r.endRecurrence})]}),e.jsxs("div",{className:"text-xs text-amber-600 bg-amber-50 p-2 rounded flex items-start gap-2",children:[e.jsx(Me,{className:"w-4 h-4 mt-0.5 flex-shrink-0"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"חזרות קבועות ייווצרו אוטומטית עד התאריך שצוין"})]})]})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{type:"submit",disabled:p,className:"flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 disabled:opacity-50 transition-colors font-reisinger-yonatan",children:p?"קובע חזרה...":"קבע חזרה"}),e.jsx("button",{type:"button",onClick:v,className:"flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors font-reisinger-yonatan",children:"ביטול"})]})]})]})}):null}function It(){const{user:t}=Te(),[v,T]=i.useState([]),[b,j]=i.useState(!0),[l,a]=i.useState(""),[r,w]=i.useState(!1),[p,$]=i.useState(null),[d,M]=i.useState(null),[P,c]=i.useState([]),[N,D]=i.useState(null),[x,h]=i.useState("members");i.useState(!1);const[z,C]=i.useState(!1),[m,_]=i.useState([]),[u,E]=i.useState([]),[O,A]=i.useState(""),[q,ne]=i.useState(""),[y,S]=i.useState(null),[Q,Z]=i.useState({isOpen:!1,title:"",message:"",onConfirm:()=>{}});i.useEffect(()=>{oe()},[t]);const oe=async()=>{if(t?._id)try{j(!0);const s=t._id,L=await R.teachers.getTeacher(s);if(!L)throw new Error("לא נמצא פרופיל מנצח");const U=L?.conducting?.orchestraIds||[];if(U.length===0){console.log("No orchestras assigned to conductor"),T([]);return}const G=await R.orchestras.getBatchOrchestras(U);if(!Array.isArray(G))throw new Error("תגובה לא תקינה מהשרת");const se=G.map(K=>({id:K._id,name:K.name,description:K.description,type:K.type,level:K.level,memberCount:K.memberCount||0,status:K.status||"active",rehearsalDay:K.rehearsalSchedule?.day,rehearsalTime:K.rehearsalSchedule?.time,venue:K.venue}));T(se)}catch(s){console.error("Error loading conductor orchestras:",s),D("שגיאה בטעינת רשימת התזמורות")}finally{j(!1)}},re=async s=>{try{const G=((await R.orchestras.getOrchestra(s)).memberDetails||[]).map(se=>{const K=se.personalInfo?.fullName||"",be=K.trim().split(/\s+/),Pe=be[0]||"",Fe=be.slice(1).join(" ")||"",o=se.academicInfo?.instrumentProgress?.find(ae=>ae.isPrimary),f=o?.instrumentName||se.primaryInstrument||"לא צוין",I=o?.currentStage||0;return{id:se._id,fullName:K,firstName:Pe,lastName:Fe,instrument:f,currentStage:I,section:se.section||"כללי",status:se.status||"active",enrollmentDate:se.enrollmentDate||new Date().toISOString(),performanceLevel:se.performanceLevel||"intermediate",attendanceRate:se.attendanceRate||null}});c(G)}catch(L){console.error("Error loading orchestra members:",L)}},ce=async()=>{try{const s=await R.students.getStudents({status:"active",limit:200}),L=P.map(G=>G.id),U=s.filter(G=>!L.includes(G._id));_(U)}catch(s){console.error("Error loading available students:",s)}},k=async s=>{try{const U=(await R.rehearsals.getRehearsals({groupId:s,limit:20})).map(G=>{const se=G.scheduledDate||G.date||G.rehearsalDate;let K="תאריך לא זמין";if(se)try{const be=new Date(se);isNaN(be.getTime())||(K=be.toLocaleDateString("he-IL",{year:"numeric",month:"2-digit",day:"2-digit"}))}catch{console.warn("Failed to parse rehearsal date:",se)}return{id:G._id,date:K,time:G.startTime||"19:00",location:G.location||"אולם מוזיקה",duration:G.duration||120,status:G.status||"scheduled",attendanceCount:G.attendanceList?.length||0,totalMembers:P.length}});E(U)}catch(L){console.error("Error loading orchestra rehearsals:",L),E([])}},F=async s=>{if(d)try{await R.orchestras.addMember(d,s),await re(d),await ce(),S({type:"success",message:"התלמיד נוסף בהצלחה לתזמורת"}),setTimeout(()=>S(null),3e3)}catch(L){console.error("Error adding member:",L),S({type:"error",message:"שגיאה בהוספת התלמיד לתזמורת"}),setTimeout(()=>S(null),3e3)}},X=async s=>{d&&Z({isOpen:!0,title:"הסרת תלמיד מהתזמורת",message:"האם אתה בטוח שברצונך להסיר את התלמיד מהתזמורת?",onConfirm:async()=>{Z({...Q,isOpen:!1});try{await R.orchestras.removeMember(d,s),await re(d),await ce(),S({type:"success",message:"התלמיד הוסר בהצלחה מהתזמורת"}),setTimeout(()=>S(null),3e3)}catch(L){console.error("Error removing member:",L),S({type:"error",message:"שגיאה בהסרת התלמיד מהתזמורת"}),setTimeout(()=>S(null),3e3)}}})},V=async s=>{if(d)try{const L={groupId:d,groupType:"orchestra",scheduledDate:new Date(s.date).toISOString(),startTime:s.startTime,endTime:s.endTime,duration:Y(s.startTime,s.endTime),location:s.location,notes:s.notes,status:"scheduled"};if(s.recurring){const U=te(L,s);await Promise.all(U.map(G=>R.rehearsals.createRehearsal(G))),S({type:"success",message:`${U.length} חזרות נוצרו בהצלחה`})}else await R.rehearsals.createRehearsal(L),S({type:"success",message:"חזרה נוצרה בהצלחה"});await k(d),C(!1),setTimeout(()=>S(null),3e3)}catch(L){console.error("Error scheduling rehearsal:",L),S({type:"error",message:"שגיאה ביצירת החזרה"}),setTimeout(()=>S(null),3e3)}},Y=(s,L)=>{const U=new Date(`2000-01-01T${s}`),G=new Date(`2000-01-01T${L}`);return Math.round((G.getTime()-U.getTime())/(1e3*60))},te=(s,L)=>{const U=[],G=new Date(L.date),se=new Date(L.endRecurrence);let K=new Date(G);for(;K<=se;)switch(U.push({...s,scheduledDate:new Date(K).toISOString()}),L.recurrencePattern){case"weekly":K.setDate(K.getDate()+7);break;case"biweekly":K.setDate(K.getDate()+14);break;case"monthly":K.setMonth(K.getMonth()+1);break}return U},n=v.filter(s=>l===""||s.name.toLowerCase().includes(l.toLowerCase())||s.type.toLowerCase().includes(l.toLowerCase())||s.description?.toLowerCase().includes(l.toLowerCase())),g=async s=>{Z({isOpen:!0,title:"מחיקת תזמורת",message:"האם אתה בטוח שברצונך למחוק תזמורת זו? פעולה זו אינה ניתנת לביטול.",onConfirm:async()=>{Z({...Q,isOpen:!1});try{await R.orchestras.deleteOrchestra(s),T(L=>L.filter(U=>U.id!==s)),d===s&&(M(null),c([])),S({type:"success",message:"התזמורת נמחקה בהצלחה"}),setTimeout(()=>S(null),3e3)}catch(L){console.error("Error deleting orchestra:",L),S({type:"error",message:"שגיאה במחיקת התזמורת"}),setTimeout(()=>S(null),3e3)}}})},J=async s=>{try{if(p){const L={name:s.name,description:s.description,type:s.type,level:s.level,status:s.status,rehearsalSchedule:{day:s.rehearsalDay,time:s.rehearsalTime},venue:s.venue},U=await R.orchestras.updateOrchestra(p.id,L),G={id:U._id,name:U.name,description:U.description,type:U.type,level:U.level,memberCount:U.memberCount||0,status:U.status||"active",rehearsalDay:U.rehearsalSchedule?.day,rehearsalTime:U.rehearsalSchedule?.time,venue:U.venue};T(se=>se.map(K=>K.id===p.id?G:K))}else{const L=t?._id,U={name:s.name,description:s.description,type:s.type,level:s.level,status:s.status,rehearsalSchedule:{day:s.rehearsalDay,time:s.rehearsalTime},venue:s.venue,conductorId:L},G=await R.orchestras.createOrchestra(U),se={id:G._id,name:G.name,description:G.description,type:G.type,level:G.level,memberCount:G.memberCount||0,status:G.status||"active",rehearsalDay:G.rehearsalSchedule?.day,rehearsalTime:G.rehearsalSchedule?.time,venue:G.venue};T(K=>[...K,se])}w(!1),$(null),S({type:"success",message:p?"התזמורת עודכנה בהצלחה":"התזמורת נוצרה בהצלחה"}),setTimeout(()=>S(null),3e3)}catch(L){console.error("Error saving orchestra:",L),S({type:"error",message:"שגיאה בשמירת פרטי התזמורת"}),setTimeout(()=>S(null),3e3)}},W=s=>{switch(s){case"youth":return"תזמורת נוער";case"adult":return"תזמורת מבוגרים";case"chamber":return"תזמורת קאמרית";case"symphony":return"תזמורת סימפונית";default:return s}},B=s=>{switch(s){case"beginner":return"מתחילים";case"intermediate":return"בינוניים";case"advanced":return"מתקדמים";default:return s}};return b?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600",children:"טוען רשימת תזמורות..."})]})}):N?e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("div",{className:"text-red-800 font-reisinger-yonatan",children:N})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:"תזמורות שאני מנצח"}),e.jsxs("p",{className:"text-gray-600 mt-1",children:[v.length," תזמורות"]})]}),e.jsxs("button",{onClick:()=>w(!0),className:"flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors",children:[e.jsx(ke,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"הוסף תזמורת"})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(ve,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"חיפוש תזמורות...",value:l,onChange:s=>a(s.target.value),className:"w-full pl-4 pr-12 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"rtl"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsx("div",{className:"space-y-4",children:n.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(we,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2 font-reisinger-yonatan",children:l?"לא נמצאו תזמורות":"אין תזמורות רשומות"}),e.jsx("p",{className:"text-gray-600 font-reisinger-yonatan",children:l?"נסה מילות חיפוש אחרות":"התחל בהוספת התזמורת הראשונה שלך"})]}):n.map(s=>e.jsxs("div",{className:`bg-white border border-gray-200 rounded-lg p-4 hover:shadow-lg hover:border-indigo-300 transition-all duration-200 cursor-pointer transform hover:-translate-y-1 group ${d===s.id?"ring-2 ring-indigo-500 bg-indigo-50":""}`,onClick:()=>{M(s.id),re(s.id),k(s.id),h("members")},children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-gray-900 font-reisinger-yonatan",children:s.name}),e.jsxs("p",{className:"text-sm text-gray-600 font-reisinger-yonatan",children:[W(s.type)," • ",B(s.level)]}),s.description&&e.jsx("p",{className:"text-sm text-gray-500 mt-1 font-reisinger-yonatan",children:s.description})]}),e.jsxs("div",{className:"flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:[e.jsx("button",{onClick:L=>{L.stopPropagation(),$(s),w(!0)},className:"p-2 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all duration-200",title:"עריכת תזמורת",children:e.jsx(Be,{className:"w-4 h-4"})}),e.jsx("button",{onClick:L=>{L.stopPropagation(),g(s.id)},className:"p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all duration-200",title:"מחיקת תזמורת",children:e.jsx(Re,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(fe,{className:"w-4 h-4"}),e.jsxs("span",{children:[s.memberCount||0," חברים"]})]}),s.rehearsalDay&&e.jsxs("span",{children:["חזרות: ",s.rehearsalDay]})]}),e.jsx("span",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${s.status==="active"?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"}`,children:s.status==="active"?"פעיל":"לא פעיל"})]})]},s.id))}),d&&e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"flex gap-1 p-1",children:[e.jsxs("button",{onClick:()=>h("members"),className:`px-4 py-2 text-sm font-medium rounded-md transition-colors ${x==="members"?"bg-indigo-100 text-indigo-700":"text-gray-500 hover:text-gray-700"}`,children:[e.jsx(fe,{className:"w-4 h-4 inline mr-2"}),"חברי התזמורת"]}),e.jsxs("button",{onClick:()=>{h("enrollment"),ce()},className:`px-4 py-2 text-sm font-medium rounded-md transition-colors ${x==="enrollment"?"bg-indigo-100 text-indigo-700":"text-gray-500 hover:text-gray-700"}`,children:[e.jsx(ye,{className:"w-4 h-4 inline mr-2"}),"רישום חברים"]}),e.jsxs("button",{onClick:()=>h("rehearsals"),className:`px-4 py-2 text-sm font-medium rounded-md transition-colors ${x==="rehearsals"?"bg-indigo-100 text-indigo-700":"text-gray-500 hover:text-gray-700"}`,children:[e.jsx(xe,{className:"w-4 h-4 inline mr-2"}),"חזרות"]})]})}),e.jsxs("div",{className:"p-4",children:[x==="members"&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"font-semibold text-gray-900 font-reisinger-yonatan",children:["חברי התזמורת (",P.length,")"]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs("div",{className:"relative",children:[e.jsx(ve,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"text",placeholder:"חיפוש חברים...",value:q,onChange:s=>ne(s.target.value),className:"pl-4 pr-10 py-1.5 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-indigo-500",dir:"rtl"})]})})]}),P.filter(s=>q===""||`${s.firstName} ${s.lastName}`.toLowerCase().includes(q.toLowerCase())||s.instrument.toLowerCase().includes(q.toLowerCase())).length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(fe,{className:"w-12 h-12 text-gray-400 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 font-reisinger-yonatan",children:q?"לא נמצאו חברים":"אין חברים רשומים בתזמורת"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:P.filter(s=>q===""||`${s.firstName} ${s.lastName}`.toLowerCase().includes(q.toLowerCase())||s.instrument.toLowerCase().includes(q.toLowerCase())).map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors border border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${s.status==="active"?"bg-green-500":"bg-gray-400"}`}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm font-reisinger-yonatan",children:s.fullName||`${s.firstName} ${s.lastName}`.trim()}),e.jsxs("div",{className:"text-xs text-gray-500 font-reisinger-yonatan",children:[s.instrument,s.currentStage?` - שלב ${s.currentStage}`:""]}),s.attendanceRate!==null&&s.attendanceRate!==void 0&&e.jsxs("div",{className:"text-xs text-gray-400 mt-1",children:["נוכחות: ",s.attendanceRate,"%"]})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{onClick:()=>X(s.id),className:"p-1.5 text-red-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors",title:"הסר מהתזמורת",children:e.jsx(Ke,{className:"w-4 h-4"})})})]},s.id))})]}),x==="enrollment"&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h4",{className:"font-semibold text-gray-900 font-reisinger-yonatan",children:"הוסף חברים חדשים"}),e.jsxs("div",{className:"relative",children:[e.jsx(ve,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"text",placeholder:"חיפוש תלמידים...",value:O,onChange:s=>A(s.target.value),className:"pl-4 pr-10 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500",dir:"rtl"})]})]}),m.filter(s=>O===""||s.personalInfo?.fullName?.toLowerCase().includes(O.toLowerCase())||s.academicInfo?.primaryInstrument?.toLowerCase().includes(O.toLowerCase())).length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(ye,{className:"w-12 h-12 text-gray-400 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 font-reisinger-yonatan",children:O?"לא נמצאו תלמידים":"אין תלמידים זמינים"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:m.filter(s=>O===""||s.personalInfo?.fullName?.toLowerCase().includes(O.toLowerCase())||s.academicInfo?.primaryInstrument?.toLowerCase().includes(O.toLowerCase())).map(s=>{const L=s.academicInfo?.instrumentProgress?.find(se=>se.isPrimary),U=L?.instrumentName||s.academicInfo?.primaryInstrument||"לא צוין כלי",G=L?.currentStage;return e.jsxs("div",{className:"flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors border border-gray-200",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm font-reisinger-yonatan",children:s.personalInfo?.fullName}),e.jsxs("div",{className:"text-xs text-gray-500 font-reisinger-yonatan",children:[U,G?` - שלב ${G}`:""]})]}),e.jsxs("button",{onClick:()=>F(s._id),className:"flex items-center gap-1 px-3 py-1.5 bg-indigo-600 text-white text-sm rounded hover:bg-indigo-700 transition-colors",children:[e.jsx(ye,{className:"w-4 h-4"}),"הוסף"]})]},s._id)})})]}),x==="rehearsals"&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h4",{className:"font-semibold text-gray-900 font-reisinger-yonatan",children:"חזרות התזמורת"}),e.jsxs("button",{onClick:()=>C(!0),className:"flex items-center gap-2 px-3 py-1.5 bg-indigo-600 text-white text-sm rounded hover:bg-indigo-700 transition-colors",children:[e.jsx(ke,{className:"w-4 h-4"}),"קבע חזרה"]})]}),u.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(xe,{className:"w-12 h-12 text-gray-400 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 font-reisinger-yonatan",children:"אין חזרות מתוכננות"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:u.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors border border-gray-200",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-medium text-sm font-reisinger-yonatan",children:[s.date," • ",s.time]}),e.jsxs("div",{className:"text-xs text-gray-500 font-reisinger-yonatan flex items-center gap-2 mt-1",children:[e.jsx(Ne,{className:"w-3 h-3"}),s.location,e.jsx(he,{className:"w-3 h-3 mr-1"}),s.duration," דקות"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-sm font-medium text-gray-900",children:[s.attendanceCount,"/",s.totalMembers]}),e.jsx("div",{className:"text-xs text-gray-500",children:"נוכחות"})]})]},s.id))})]})]})]})]}),r&&e.jsx(Lt,{orchestra:p,onClose:()=>{w(!1),$(null)},onSubmit:J}),z&&d&&e.jsx(kt,{isOpen:z,onClose:()=>C(!1),orchestraId:d,orchestraName:v.find(s=>s.id===d)?.name||"",onSave:V}),e.jsx(jt,{isOpen:Q.isOpen,title:Q.title,message:Q.message,onConfirm:Q.onConfirm,onCancel:()=>Z({...Q,isOpen:!1}),variant:"danger",confirmText:"אישור",cancelText:"ביטול"}),y&&e.jsx("div",{className:"fixed bottom-4 left-1/2 transform -translate-x-1/2 z-50 animate-fade-in",dir:"rtl",children:e.jsxs("div",{className:`flex items-center gap-3 px-6 py-4 rounded-lg shadow-lg ${y.type==="success"?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:[y.type==="success"?e.jsx(Ue,{className:"w-5 h-5 text-green-600 flex-shrink-0"}):e.jsx(dt,{className:"w-5 h-5 text-red-600 flex-shrink-0"}),e.jsx("span",{className:`font-medium font-reisinger-yonatan ${y.type==="success"?"text-green-800":"text-red-800"}`,children:y.message})]})})]})}function Lt({orchestra:t,onClose:v,onSubmit:T}){const[b,j]=i.useState({name:t?.name||"",description:t?.description||"",type:t?.type||"youth",level:t?.level||"beginner",status:t?.status||"active",rehearsalDay:t?.rehearsalDay||"",rehearsalTime:t?.rehearsalTime||"",venue:t?.venue||""}),l=a=>{a.preventDefault(),T(b)};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto",dir:"rtl",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900 mb-4 font-reisinger-yonatan",children:t?"עריכת תזמורת":"הוספת תזמורת חדשה"}),e.jsxs("form",{onSubmit:l,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שם התזמורת *"}),e.jsx("input",{type:"text",required:!0,value:b.name,onChange:a=>j(r=>({...r,name:a.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"תיאור"}),e.jsx("textarea",{value:b.description,onChange:a=>j(r=>({...r,description:a.target.value})),rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"סוג תזמורת *"}),e.jsxs("select",{required:!0,value:b.type,onChange:a=>j(r=>({...r,type:a.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"youth",children:"תזמורת נוער"}),e.jsx("option",{value:"adult",children:"תזמורת מבוגרים"}),e.jsx("option",{value:"chamber",children:"תזמורת קאמרית"}),e.jsx("option",{value:"symphony",children:"תזמורת סימפונית"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"רמה *"}),e.jsxs("select",{required:!0,value:b.level,onChange:a=>j(r=>({...r,level:a.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"beginner",children:"מתחילים"}),e.jsx("option",{value:"intermediate",children:"בינוניים"}),e.jsx("option",{value:"advanced",children:"מתקדמים"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"יום חזרות"}),e.jsx("input",{type:"text",value:b.rehearsalDay,onChange:a=>j(r=>({...r,rehearsalDay:a.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",placeholder:"כלומר: יום ראשון"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שעת חזרות"}),e.jsx("input",{type:"time",value:b.rehearsalTime,onChange:a=>j(r=>({...r,rehearsalTime:a.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"מקום חזרות"}),e.jsx("input",{type:"text",value:b.venue,onChange:a=>j(r=>({...r,venue:a.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"סטטוס"}),e.jsxs("select",{value:b.status,onChange:a=>j(r=>({...r,status:a.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"active",children:"פעיל"}),e.jsx("option",{value:"inactive",children:"לא פעיל"})]})]}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx("button",{type:"submit",className:"flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors font-reisinger-yonatan",children:t?"עדכן":"הוסף"}),e.jsx("button",{type:"button",onClick:v,className:"flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors font-reisinger-yonatan",children:"ביטול"})]})]})]})})}function $t(){const{user:t}=Te(),[v,T]=i.useState(new Date),[b,j]=i.useState(null),[l,a]=i.useState([]),[r,w]=i.useState([]),[p,$]=i.useState(!0),[d,M]=i.useState(null),[P,c]=i.useState(!1),[N,D]=i.useState(null),[x,h]=i.useState(""),[z,C]=i.useState(!1),[m,_]=i.useState(null),[u,E]=i.useState(!1),[O,A]=i.useState(null),[q,ne]=i.useState(!1),[y,S]=i.useState(null),[Q,Z]=i.useState(!1),[oe,re]=i.useState("");i.useEffect(()=>{ce()},[v,t]);const ce=async()=>{if(t?._id)try{$(!0);const o=t._id,f=await R.teacherSchedule.getTimeBlocks(o);console.log("Raw API Response:",f);let I=[];try{if(Array.isArray(f))I=f;else if(f?.data&&Array.isArray(f.data))I=f.data;else if(f?.timeBlocks&&Array.isArray(f.timeBlocks))I=f.timeBlocks;else if(f&&typeof f=="object"){const H=Object.values(f).find(le=>Array.isArray(le));H?I=H:(console.warn("No array found in response, using empty array"),I=[])}else console.warn("Unexpected timeBlocks format:",f),I=[]}catch(H){console.error("Error parsing timeBlocks response:",H),I=[]}console.log("Parsed timeBlocks:",I),console.log("Time block IDs:",I.map(H=>({_id:H._id,day:H.day,time:`${H.startTime}-${H.endTime}`,location:H.location})));const ae=I.filter(H=>H._id&&H._id!=="undefined");console.log("Valid timeBlocks after filtering:",ae),w(ae);const ge=await R.teachers.getTeacher(o);console.log("Teacher profile:",ge);let ie=[];if(ge?.teaching?.studentIds?.length>0)try{ie=await R.students.getBatchStudents(ge.teaching.studentIds),console.log("Students loaded:",ie)}catch(H){console.warn("Failed to load students:",H)}else console.log("No student IDs found in teacher profile");console.log("Creating lesson blocks from student assignments...");const ee=[];ie.forEach(H=>{console.log("Processing student:",H.personalInfo?.fullName),console.log("Student assignments:",H.teacherAssignments),H.teacherAssignments&&H.teacherAssignments.forEach(le=>{if(le.teacherId===o){console.log("Creating lesson from assignment:",le);const Ce=le.time||le.startTime,We=le.duration||45,He=(Ie,tt)=>{const[st,at]=Ie.split(":").map(Number),Qe=st*60+at+tt,rt=Math.floor(Qe/60),nt=Qe%60;return`${rt.toString().padStart(2,"0")}:${nt.toString().padStart(2,"0")}`},je=le.endTime||He(Ce,We),Ze=r.find(Ie=>Ie.day===le.day)?.location||"",et={_id:`${H._id}-${le.day}-${le.time}`,day:le.day,startTime:Ce,endTime:je,totalDuration:We,studentId:H._id,studentName:H.personalInfo?.fullName,teacherId:o,instrument:H.academicInfo?.instrumentProgress?.find(Ie=>Ie.isPrimary)?.instrumentName,location:le.location||Ze,type:"lesson"};console.log(`Creating lesson: Student="${H.personalInfo?.fullName}", Day="${le.day}", Time="${Ce}-${je}"`),ee.push(et)}})}),console.log("Converted lessons from assignments:",ee);const me=ee.map(H=>{const le=ie.find(je=>je.teacherAssignments?.some(Ee=>Ee.teacherId===o&&Ee.day===H.day&&Ee.time===H.startTime)),Ce=le?.academicInfo?.instrumentProgress?.find(je=>je.isPrimary)||le?.academicInfo?.instrumentProgress?.[0],He=r.find(je=>je.day===H.day)?.location||"";return{id:H._id||H.id||`${H.day}-${H.startTime}`,day:H.day,startTime:H.startTime,endTime:H.endTime,studentName:le?le.personalInfo?.fullName:H.studentName,studentId:le?._id||H.studentId,instrument:Ce?.instrumentName||H.instrument,location:H.location||He,notes:H.notes,recurring:H.recurring||{isRecurring:!0,excludeDates:[]},totalDuration:H.totalDuration||F(H.startTime,H.endTime),studentClass:le?.personalInfo?.class||le?.academicInfo?.class,studentPhone:le?.personalInfo?.phone,studentStage:Ce?.currentStage}});a(me);const ue=X(v),pe=V(v),De=k(ue,me);console.log("Generated calendar days:",De),console.log("Calendar week range:",{weekStart:ue,weekEnd:pe}),console.log("Mapped lesson days for calendar:",me),j({weekStart:ue,weekEnd:pe,days:De})}catch(o){console.error("Error loading schedule:",o),M("שגיאה בטעינת לוח הזמנים")}finally{$(!1)}},k=(o,f)=>{const I=[],ae=["ראשון","שני","שלישי","רביעי","חמישי","שישי","שבת"],ge=new Map;ae.forEach((ee,de)=>{ge.set(ee,de)}),console.log("=== GENERATING CALENDAR ==="),console.log("weekStart:",o,"Day:",o.getDay()),console.log("lessons input:",f),console.log("Day name mapping:",Array.from(ge.entries()));const ie=new Map;f.forEach(ee=>{ie.has(ee.day)||ie.set(ee.day,[]),ie.get(ee.day).push(ee)}),console.log("Lessons grouped by day:",Array.from(ie.keys()));for(let ee=0;ee<7;ee++){const de=new Date(o);de.setDate(o.getDate()+ee);const me=ae[ee],ue=ie.get(me)||[];console.log(`Day ${ee} (${me}): found ${ue.length} lessons`,ue.map(pe=>({day:pe.day,time:pe.startTime,student:pe.studentName}))),I.push({date:de.toISOString().split("T")[0],dayName:me,lessons:ue})}return console.log("Generated calendar days with lessons:",I.map(ee=>({dayName:ee.dayName,lessonCount:ee.lessons.length}))),I},F=(o,f)=>{const[I,ae]=o.split(":").map(Number),[ge,ie]=f.split(":").map(Number);return ge*60+ie-(I*60+ae)},X=o=>{const f=new Date(o),I=f.getDay(),ae=f.getDate()-I;return f.setDate(ae),f.setHours(0,0,0,0),console.log("getWeekStart: input date:",o,"weekStart (Sunday):",f,"day:",f.getDay()),f},V=o=>{const f=X(o);return f.setDate(f.getDate()+6),f},Y=o=>{const f=new Date(v);f.setDate(v.getDate()+(o==="next"?7:-7)),T(f)},te=o=>o.slice(0,5),n=o=>new Date(o).toLocaleDateString("he-IL",{day:"numeric",month:"short"}),g=()=>{D(null),c(!0)},J=o=>{console.log("handleEditLessonDay called with:",{studentId:o.studentId,studentName:o.studentName,id:o.id,_id:o._id,type:o.type}),o.studentId&&o.studentName?(console.log("Opening EditLessonModal for student lesson"),A(o),E(!0)):(console.log("Opening LessonDayModal for teaching day/availability block"),D(o),c(!0))},W=o=>{console.log("handleEditTeachingDay called with:",{_id:o._id,id:o.id,day:o.day,startTime:o.startTime,hasStudentId:!!o.studentId,fullData:o});const f={id:o._id||o.id,day:o.day,startTime:o.startTime,endTime:o.endTime,location:o.location||"חדר מוזיקה",notes:o.notes||"",recurring:o.recurring||{isRecurring:!0,excludeDates:[]},totalDuration:F(o.startTime,o.endTime)};console.log("Opening LessonDayModal with lessonDay:",f),D(f),c(!0)},B=async o=>{S({message:"האם אתה בטוח שברצונך למחוק יום לימוד זה? פעולה זו תבטל את הזמינות שלך בזמן זה.",onConfirm:async()=>{try{await R.teacherSchedule.deleteTimeBlock(t?._id,o._id||o.id),s("יום הלימוד נמחק בהצלחה","success"),ce()}catch(f){console.error("Error deleting teaching day:",f),s("שגיאה במחיקת יום הלימוד","error")}}}),ne(!0)},s=(o,f)=>{const I=document.createElement("div");I.className=`fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 ${f==="success"?"bg-green-500 text-white":f==="error"?"bg-red-500 text-white":"bg-blue-500 text-white"}`,I.innerHTML=`<div class="flex items-center gap-2 font-reisinger-yonatan">
      ${f==="success"?"✅":f==="error"?"❌":"ℹ️"} ${o}
    </div>`,document.body.appendChild(I),setTimeout(()=>I.remove(),3e3)},L=o=>{re(o),Z(!0)},U=()=>{const o=[];for(let f=7;f<=21;f++)o.push(`${f.toString().padStart(2,"0")}:00`),o.push(`${f.toString().padStart(2,"0")}:30`);return o},G=(o,f)=>{const I=b?.days.find(ie=>ie.date===o),ae=ie=>{const[ee,de]=ie.split(":").map(Number);return ee*60+de};return I?.lessons.find(ie=>{const ee=ae(f),de=ee+30,me=ae(ie.startTime),ue=ae(ie.endTime),pe=me>=ee&&me<de,De=ee>=me&&ee<ue;return pe||De})},se=o=>{const f=F(o.startTime,o.endTime);return Math.ceil(f/30)*60},K=(o,f)=>{const I=o.startTime,ae=f,ge=me=>{const[ue,pe]=me.split(":").map(Number);return ue*60+pe},ie=ge(I),ee=ge(ae),de=ee+30;return ie>=ee&&ie<de},be=(o,f)=>{const I=de=>{const[me,ue]=de.split(":").map(Number);return me*60+ue},ae=I(f),ge=ae+30;return r.some(de=>{if(de.day!==o)return!1;const me=I(de.startTime),ue=I(de.endTime);return ae>=me&&ge<=ue})?!l.some(de=>{if(de.day!==o)return!1;const me=I(de.startTime),ue=I(de.endTime);return ae<ue&&ge>me}):!1},Pe=(o,f,I)=>{be(I,f)&&(_({date:o,time:f,dayName:I}),C(!0))};if(l.filter(o=>{if(!x)return!0;const f=x.toLowerCase();return o.studentName?.toLowerCase().includes(f)||o.instrument?.toLowerCase().includes(f)||o.location?.toLowerCase().includes(f)||o.day.toLowerCase().includes(f)}),p)return e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600",children:"טוען לוח זמנים..."})]})});if(d&&!b)return e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("div",{className:"text-red-800 font-reisinger-yonatan",children:d})});const Fe=U();return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:"לוח זמנים שבועי"}),e.jsx("p",{className:"text-gray-600 mt-1",children:b&&`${n(b.weekStart.toISOString().split("T")[0])} - ${n(b.weekEnd.toISOString().split("T")[0])}`})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>Y("prev"),className:"p-2 text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(mt,{className:"w-5 h-5"})}),e.jsx("button",{onClick:()=>T(new Date),className:"px-3 py-1 text-sm bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition-colors font-reisinger-yonatan",children:"השבוע"}),e.jsx("button",{onClick:()=>Y("next"),className:"p-2 text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(ut,{className:"w-5 h-5"})})]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:"grid grid-cols-8 border-b border-gray-200",children:[e.jsx("div",{className:"p-3 bg-gray-50 font-medium text-gray-700 font-reisinger-yonatan",children:"שעה"}),b?.days.map(o=>e.jsxs("div",{className:"p-3 bg-gray-50 text-center",children:[e.jsx("div",{className:"font-medium text-gray-900 font-reisinger-yonatan",children:o.dayName}),e.jsx("div",{className:"text-sm text-gray-500 font-reisinger-yonatan",children:n(o.date)})]},o.date))]}),e.jsx("div",{className:"max-h-96 overflow-y-auto relative",children:Fe.map(o=>e.jsxs("div",{className:"grid grid-cols-8 border-b border-gray-100",style:{height:"60px"},children:[e.jsx("div",{className:"p-3 bg-gray-50 text-sm font-medium text-gray-600 font-reisinger-yonatan flex items-center",children:te(o)}),b?.days.map(f=>{const I=G(f.date,o),ae=!I&&be(f.dayName,o);return e.jsxs("div",{className:`border-l border-gray-100 relative transition-all duration-300 group ${ae?"bg-blue-50/30 hover:bg-blue-100/50 cursor-pointer border-2 border-transparent hover:border-blue-200":"cursor-default"}`,style:{height:"60px"},onClick:()=>!I&&Pe(f.date,o,f.dayName),title:ae?"לחץ להוספת שיעור חדש":"",children:[ae&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"flex flex-col items-center opacity-30 group-hover:opacity-100 transition-all duration-300 group-hover:scale-110",children:[e.jsx(ke,{className:"w-6 h-6 text-blue-500"}),e.jsx("span",{className:"text-[10px] text-blue-600 font-medium mt-1 opacity-0 group-hover:opacity-100 transition-opacity duration-300",children:"הוסף שיעור"})]})}),I&&K(I,o)&&e.jsx("div",{className:"absolute left-1 right-1 top-1 p-2.5 rounded text-xs font-reisinger-yonatan bg-blue-100 text-blue-800 hover:bg-blue-200 border border-blue-300 shadow-sm cursor-pointer transition-all hover:scale-[1.02] z-10 overflow-hidden",style:{height:`${se(I)-2}px`,minHeight:"82px"},onClick:()=>J(I),title:`${I.studentName||"תלמיד"} - ${I.instrument||""}`,children:e.jsx("div",{className:"flex flex-col h-full justify-between",children:e.jsxs("div",{className:"flex-shrink-0 space-y-1",children:[e.jsxs("div",{className:"font-medium truncate flex items-center gap-1",children:[e.jsx(Le,{className:"w-3 h-3 opacity-60"}),I.studentName||"תלמיד"]}),e.jsxs("div",{className:"text-[10px] opacity-75",children:[te(I.startTime),"-",te(I.endTime)]}),e.jsx("div",{className:"flex items-center gap-1 text-[10px] opacity-80 h-4",children:I.instrument?e.jsxs(e.Fragment,{children:[e.jsx(we,{className:"w-2.5 h-2.5"}),e.jsx("span",{className:"truncate",children:I.instrument})]}):e.jsx("span",{className:"invisible",children:"placeholder"})}),e.jsx("div",{className:"flex items-center gap-1 text-[10px] opacity-70 h-4",children:I.location?e.jsxs(e.Fragment,{children:[e.jsx(Ne,{className:"w-2.5 h-2.5"}),e.jsx("span",{className:"truncate",children:I.location})]}):e.jsx("span",{className:"invisible",children:"placeholder"})})]})})})]},`${f.date}-${o}`)})]},o))})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-bold text-gray-900 font-reisinger-yonatan",children:"ימי לימוד - זמינות המורה"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"הגדר את הימים והשעות שבהם אתה זמין להוראה"})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs("button",{onClick:g,className:"flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors",children:[e.jsx(ke,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"הוסף יום לימוד"})]})})]}),r.length===0?e.jsxs("div",{className:"text-center py-12 bg-gray-50 rounded-lg",children:[e.jsx($e,{className:"w-12 h-12 text-gray-300 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500 font-reisinger-yonatan text-lg",children:"אין ימי לימוד מוגדרים"}),e.jsx("button",{onClick:g,className:"mt-4 text-indigo-600 hover:text-indigo-700 font-medium",children:"הוסף יום לימוד ראשון"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:r.map(o=>e.jsx(Mt,{teachingDay:o,onEdit:()=>W(o),onDelete:()=>B(o)},o._id||o.id))})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xe,{className:"w-5 h-5 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-900 font-reisinger-yonatan",children:"ימי לימוד"})]}),e.jsx("div",{className:"text-2xl font-bold text-blue-900 mt-2 font-reisinger-yonatan",children:r.length}),e.jsx("div",{className:"text-xs text-blue-700 mt-1",children:"ימי זמינות להוראה"})]}),e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(he,{className:"w-5 h-5 text-green-600"}),e.jsx("span",{className:"font-medium text-green-900 font-reisinger-yonatan",children:"שעות זמינות"})]}),e.jsx("div",{className:"text-2xl font-bold text-green-900 mt-2 font-reisinger-yonatan",children:(r.reduce((o,f)=>{const I=F(f.startTime,f.endTime);return o+I},0)/60).toFixed(1)}),e.jsx("div",{className:"text-xs text-green-700 mt-1",children:"שעות שבועיות זמינות"})]}),e.jsxs("div",{className:"bg-purple-50 border border-purple-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Le,{className:"w-5 h-5 text-purple-600"}),e.jsx("span",{className:"font-medium text-purple-900 font-reisinger-yonatan",children:"תלמידים"})]}),e.jsx("div",{className:"text-2xl font-bold text-purple-900 mt-2 font-reisinger-yonatan",children:new Set(l.map(o=>o.studentId).filter(Boolean)).size}),e.jsx("div",{className:"text-xs text-purple-700 mt-1",children:"תלמידים פעילים"})]}),e.jsxs("div",{className:"bg-orange-50 border border-orange-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"w-5 h-5 text-orange-600"}),e.jsx("span",{className:"font-medium text-orange-900 font-reisinger-yonatan",children:"שיעורים"})]}),e.jsx("div",{className:"text-2xl font-bold text-orange-900 mt-2 font-reisinger-yonatan",children:l.length}),e.jsx("div",{className:"text-xs text-orange-700 mt-1",children:"שיעורים קבועים"})]})]}),z&&m&&e.jsx(Et,{timeSlot:m,teacherId:t?._id||"",teachingDays:r,onClose:()=>{C(!1),_(null)},onSave:()=>{C(!1),_(null),ce()},showNotification:s}),P&&e.jsx(Dt,{lessonDay:N,teacherId:t?._id||"",onClose:()=>{c(!1),D(null)},onSave:()=>{c(!1),D(null),ce()},showAlert:L}),u&&O&&e.jsx(_t,{lesson:O,teacherId:t?._id||"",teachingDays:r,onClose:()=>{E(!1),A(null)},onSave:()=>{E(!1),A(null),ce()},showAlert:L}),q&&y&&e.jsx(At,{message:y.message,onConfirm:()=>{y.onConfirm(),ne(!1),S(null)},onCancel:()=>{ne(!1),S(null)}}),Q&&e.jsx(Ot,{message:oe,onClose:()=>{Z(!1),re("")}})]})}function Mt({teachingDay:t,onEdit:v,onDelete:T}){return e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4 hover:shadow-lg transition-shadow",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-2 bg-green-100 rounded-lg",children:e.jsx(xe,{className:"w-4 h-4 text-green-600"})}),e.jsxs("div",{children:[e.jsxs("h5",{className:"font-bold text-gray-900 font-reisinger-yonatan",children:["יום ",t.day]}),e.jsx("p",{className:"text-xs text-gray-500 mt-0.5",children:"זמינות להוראה"})]})]}),t.isRecurring!==!1&&e.jsx("span",{className:"px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full font-reisinger-yonatan",children:"שבועי"})]}),e.jsx("div",{className:"mb-3 pb-3 border-b border-gray-100",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-700",children:[e.jsx(he,{className:"w-4 h-4 text-gray-400"}),e.jsxs("span",{className:"font-medium",children:[t.startTime," - ",t.endTime]})]})}),t.location&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600 mb-3",children:[e.jsx(Ne,{className:"w-3.5 h-3.5 text-gray-400"}),e.jsx("span",{children:t.location})]}),e.jsx("div",{className:"p-2 bg-gray-50 rounded text-xs text-gray-600 mb-3",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(fe,{className:"w-3 h-3"}),e.jsx("span",{children:"זמין לקביעת שיעורים בזמן זה"})]})}),t.notes&&e.jsx("div",{className:"p-2 bg-gray-50 rounded text-xs text-gray-600 mb-3",children:t.notes}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:v,className:"flex-1 flex items-center justify-center gap-1.5 px-3 py-1.5 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 transition-colors text-sm",children:[e.jsx(Be,{className:"w-3.5 h-3.5"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"ערוך"})]}),e.jsx("button",{onClick:T,className:"flex items-center justify-center p-1.5 bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors",title:"מחק יום לימוד",children:e.jsx(Re,{className:"w-3.5 h-3.5"})})]})]})}function Dt({lessonDay:t,teacherId:v,onClose:T,onSave:b,showAlert:j}){const[l,a]=i.useState({day:t?.day||"ראשון",startTime:t?.startTime||"14:00",endTime:t?.endTime||"18:00",location:t?.location||"חדר מוזיקה",notes:t?.notes||"",recurring:t?.recurring||{isRecurring:!0,excludeDates:[]}}),[r,w]=i.useState(!1),p=async d=>{if(d.preventDefault(),t?.studentId){j("לא ניתן לערוך שיעור תלמיד מכאן. אנא השתמש באפשרות העריכה בכרטיס השיעור.");return}if(!l.day||!l.startTime||!l.endTime){j("יש למלא את כל השדות הנדרשים");return}try{w(!0);const M={day:l.day,startTime:l.startTime,endTime:l.endTime,location:l.location||null,notes:l.notes||null,recurring:l.recurring||{isRecurring:!0,excludeDates:[]}};t?.id&&/^[0-9a-fA-F]{24}$/.test(t.id)?await R.teacherSchedule.updateTimeBlock(v,t.id,M):await R.teacherSchedule.createTimeBlock(v,M),b()}catch(M){console.error("Error saving lesson day:",M),M?.message?.includes("not found")||M?.message?.includes("Resource not found")?(j("יום הלימוד הזה כבר לא קיים במערכת. הוא יוסר מהתצוגה."),T(),b()):j("שגיאה בשמירת יום הלימוד")}finally{w(!1)}},$=()=>["ראשון","שני","שלישי","רביעי","חמישי","שישי","שבת"];return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:t?"עריכת יום לימוד":"הוספת יום לימוד חדש"}),e.jsx("button",{onClick:T,className:"p-2 text-gray-400 hover:text-gray-600",children:e.jsx(Se,{className:"w-6 h-6"})})]}),e.jsxs("form",{onSubmit:p,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"יום בשבוע *"}),e.jsx("select",{value:l.day,onChange:d=>a(M=>({...M,day:d.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",required:!0,children:$().map(d=>e.jsx("option",{value:d,children:d},d))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שעת התחלה *"}),e.jsx("input",{type:"time",value:l.startTime,onChange:d=>a(M=>({...M,startTime:d.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שעת סיום *"}),e.jsx("input",{type:"time",value:l.endTime,onChange:d=>a(M=>({...M,endTime:d.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",required:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"מיקום / חדר"}),e.jsxs("select",{value:l.location||"",onChange:d=>a(M=>({...M,location:d.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"",children:"בחר חדר"}),_e.map(d=>e.jsx("option",{value:d,children:d},d))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"הערות"}),e.jsx("textarea",{value:l.notes||"",onChange:d=>a(M=>({...M,notes:d.target.value})),rows:3,placeholder:"הערות נוספות לגבי השיעור...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:l.recurring?.isRecurring!==!1,onChange:d=>a(M=>({...M,recurring:{isRecurring:d.target.checked,excludeDates:M.recurring?.excludeDates||[]}})),className:"rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"שיעור קבוע (חוזר שבועית)"})]}),l.recurring?.isRecurring&&e.jsx("p",{className:"text-xs text-gray-500 mr-6 mt-1",children:"השיעור יופיע באופן קבוע בכל שבוע ביום ובשעה שהוגדרו"})]}),e.jsxs("div",{className:"flex gap-3 pt-6 border-t",children:[e.jsx("button",{type:"submit",disabled:r,className:"flex-1 bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed font-reisinger-yonatan flex items-center justify-center gap-2",children:r?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"שומר..."]}):e.jsx(e.Fragment,{children:t?e.jsxs(e.Fragment,{children:[e.jsx(Ge,{className:"w-4 h-4"}),"עדכן יום לימוד"]}):e.jsxs(e.Fragment,{children:[e.jsx(ke,{className:"w-4 h-4"}),"הוסף יום לימוד"]})})}),e.jsx("button",{type:"button",onClick:T,disabled:r,className:"flex-1 bg-gray-300 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed font-reisinger-yonatan",children:"ביטול"})]})]})]})})}function Et({timeSlot:t,teacherId:v,teachingDays:T,onClose:b,onSave:j,showNotification:l}){const[a,r]=i.useState(""),[w,p]=i.useState(45),[$,d]=i.useState([]),[M,P]=i.useState(!1),[c,N]=i.useState(!1),[D,x]=i.useState(0),[h,z]=i.useState(""),[C,m]=i.useState(!1);i.useEffect(()=>{_()},[]),i.useEffect(()=>{const y=S=>{S.target.closest(".student-search-dropdown")||m(!1)};return C&&document.addEventListener("mousedown",y),()=>{document.removeEventListener("mousedown",y)}},[C]);const _=async()=>{try{P(!0);const S=(await R.students.getStudents()).map(Q=>{const Z=Q.academicInfo?.instrumentProgress?.find(oe=>oe.isPrimary)||Q.academicInfo?.instrumentProgress?.[0];return{id:Q._id,firstName:Q.personalInfo?.firstName||Q.personalInfo?.fullName?.split(" ")[0]||"",lastName:Q.personalInfo?.lastName||Q.personalInfo?.fullName?.split(" ").slice(1).join(" ")||"",instrument:Z?.instrumentName||"",class:Q.personalInfo?.class||Q.academicInfo?.class,stage:Z?.currentStage}});d(S)}catch(y){console.error("Error loading students:",y)}finally{P(!1)}},u=$.filter(y=>{if(!h)return!0;const S=h.toLowerCase();return`${y.firstName} ${y.lastName}`.toLowerCase().includes(S)||y.instrument?.toLowerCase().includes(S)||y.class?.toLowerCase().includes(S)}),E=(y,S)=>{const[Q,Z]=y.split(":").map(Number),oe=Q*60+Z+S,re=Math.floor(oe/60),ce=oe%60;return`${re.toString().padStart(2,"0")}:${ce.toString().padStart(2,"0")}`},O=()=>{const[y]=t.time.split(":").map(Number),S=D;return`${y.toString().padStart(2,"0")}:${S.toString().padStart(2,"0")}`},A=[0,5,10,15,20,25,30,35,40,45,50,55],q=async y=>{if(y.preventDefault(),!a){l("יש לבחור תלמיד","error");return}try{N(!0);const S=$.find(te=>te.id===a),Q=O(),Z=E(Q,w);console.log("📝 Creating lesson for student:",S),console.log("📅 Lesson details:",{day:t.dayName,time:Q,duration:w});const re=T.find(te=>te.day===t.dayName)?.location||"",ce={teacherId:v,day:t.dayName,time:Q,endTime:Z,duration:w,location:re,isActive:!0,startDate:new Date().toISOString(),isRecurring:!0};console.log("📖 Fetching student data...");const F=[...(await R.students.getStudent(a)).teacherAssignments||[],ce];console.log("💾 Updating student with teacher assignment..."),await R.students.updateStudent(a,{teacherAssignments:F}),console.log("👨‍🏫 Updating teacher student list...");const X=await R.teachers.getTeacher(v),V=X.teaching?.studentIds||[];V.includes(a)||await R.teachers.updateTeacher(v,{teaching:{...X.teaching,studentIds:[...V,a]}});const Y={day:t.dayName,startTime:Q,endTime:Z,studentId:a,studentName:S?`${S.firstName} ${S.lastName}`:"",instrument:S?.instrument||"",location:re,notes:`שיעור קבוע שבועי - נוצר ב-${new Date().toLocaleDateString("he-IL")}`,recurring:{isRecurring:!0,excludeDates:[]},isRecurring:!0,totalDuration:w};console.log("📋 Creating time block for teacher schedule..."),await R.teacherSchedule.createTimeBlock(v,Y),console.log("✅ Lesson created successfully!"),l("השיעור נוצר בהצלחה!","success"),j()}catch(S){console.error("❌ Error creating weekly lesson assignment:",S),l(`שגיאה ביצירת השיעור השבועי: ${S.message||"שגיאה לא ידועה"}`,"error")}finally{N(!1)}},ne=y=>y.slice(0,5);return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-md mx-4",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:"הוספת שיעור חדש"}),e.jsx("button",{onClick:b,className:"p-2 text-gray-400 hover:text-gray-600",children:e.jsx(Se,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"mb-4 p-3 bg-blue-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 text-blue-800 mb-2",children:[e.jsx(xe,{className:"w-4 h-4"}),e.jsxs("span",{className:"font-medium",children:["שיעור קבוע שבועי - יום ",t.dayName]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-blue-700",children:[e.jsx(he,{className:"w-4 h-4"}),e.jsxs("span",{children:[ne(O())," - ",ne(E(O(),w))," (",w," דקות)"]})]}),e.jsxs("div",{className:"text-xs text-blue-600 mt-1",children:["השיעור יתקיים כל שבוע ביום ",t.dayName," באותה שעה"]})]}),e.jsxs("form",{onSubmit:q,className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"בחר תלמיד *"}),M?e.jsx("div",{className:"text-center py-2 text-gray-500",children:"טוען רשימת תלמידים..."}):e.jsxs("div",{className:"relative student-search-dropdown",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ve,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",value:h,onChange:y=>{z(y.target.value),m(!0)},onFocus:()=>m(!0),placeholder:"חפש תלמיד לפי שם, כלי נגינה או כיתה...",className:"w-full pr-10 pl-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),a&&!C&&e.jsx("div",{className:"mt-2 p-2 bg-indigo-50 border border-indigo-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm",children:[e.jsxs("span",{className:"font-medium text-indigo-900",children:[$.find(y=>y.id===a)?.firstName," ",$.find(y=>y.id===a)?.lastName]}),$.find(y=>y.id===a)?.instrument&&e.jsxs("span",{className:"text-indigo-700",children:[" - ",$.find(y=>y.id===a)?.instrument]})]}),e.jsx("button",{type:"button",onClick:()=>{r(""),z(""),m(!0)},className:"text-indigo-600 hover:text-indigo-800",children:e.jsx(Se,{className:"w-4 h-4"})})]})}),C&&e.jsx("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto",children:u.length>0?u.map(y=>e.jsxs("button",{type:"button",onClick:()=>{r(y.id),z(`${y.firstName} ${y.lastName}`),m(!1)},className:`w-full text-right px-3 py-2 hover:bg-indigo-50 transition-colors border-b border-gray-100 last:border-b-0 ${a===y.id?"bg-indigo-100":""}`,children:[e.jsxs("div",{className:"font-medium text-gray-900",children:[y.firstName," ",y.lastName]}),e.jsxs("div",{className:"text-xs text-gray-600 mt-0.5",children:[y.instrument&&`${y.instrument}`,y.class&&` • כיתה ${y.class}`,y.stage&&` • שלב ${y.stage}`]})]},y.id)):e.jsx("div",{className:"px-3 py-4 text-center text-gray-500",children:"לא נמצאו תלמידים מתאימים"})})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:["זמן התחלה מדויק (שעה ",t.time.split(":")[0],":__)"]}),e.jsx("div",{className:"grid grid-cols-6 gap-2",children:A.map(y=>e.jsxs("button",{type:"button",onClick:()=>x(y),className:`px-3 py-2 rounded-lg border-2 transition-all font-medium ${D===y?"border-indigo-600 bg-indigo-50 text-indigo-700":"border-gray-200 hover:border-gray-300 hover:bg-gray-50"}`,children:[":",y.toString().padStart(2,"0")]},y))}),e.jsxs("div",{className:"mt-2 text-xs text-gray-600",children:["שעת התחלה: ",O()]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"משך השיעור (דקות)"}),e.jsxs("select",{value:w,onChange:y=>p(Number(y.target.value)),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:30,children:"30 דקות"}),e.jsx("option",{value:45,children:"45 דקות"}),e.jsx("option",{value:60,children:"60 דקות"}),e.jsx("option",{value:90,children:"90 דקות"})]})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{type:"submit",disabled:c||!a,className:"flex-1 bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed font-reisinger-yonatan flex items-center justify-center gap-2",children:c?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"יוצר שיעור שבועי..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ge,{className:"w-4 h-4"}),"צור שיעור שבועי"]})}),e.jsx("button",{type:"button",onClick:b,disabled:c,className:"flex-1 bg-gray-300 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed font-reisinger-yonatan",children:"ביטול"})]})]})]})})}function At({message:t,onConfirm:v,onCancel:T}){return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-md mx-4",dir:"rtl",children:[e.jsx("div",{className:"flex items-center justify-center mb-6",children:e.jsx("div",{className:"p-3 bg-orange-100 rounded-full",children:e.jsx(Me,{className:"w-8 h-8 text-orange-600"})})}),e.jsx("h3",{className:"text-lg font-bold text-gray-900 text-center mb-4 font-reisinger-yonatan",children:t}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:v,className:"flex-1 bg-red-600 text-white py-2.5 px-4 rounded-lg hover:bg-red-700 transition-colors font-reisinger-yonatan font-medium",children:"אישור"}),e.jsx("button",{onClick:T,className:"flex-1 bg-gray-200 text-gray-700 py-2.5 px-4 rounded-lg hover:bg-gray-300 transition-colors font-reisinger-yonatan font-medium",children:"ביטול"})]})]})})}function Ot({message:t,onClose:v}){return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-md mx-4",dir:"rtl",children:[e.jsx("div",{className:"flex items-center justify-center mb-6",children:e.jsx("div",{className:"p-3 bg-blue-100 rounded-full",children:e.jsx(Me,{className:"w-8 h-8 text-blue-600"})})}),e.jsx("h3",{className:"text-lg font-bold text-gray-900 text-center mb-6 font-reisinger-yonatan",children:t}),e.jsx("button",{onClick:v,className:"w-full bg-indigo-600 text-white py-2.5 px-4 rounded-lg hover:bg-indigo-700 transition-colors font-reisinger-yonatan font-medium",children:"הבנתי"})]})})}function _t({lesson:t,teacherId:v,teachingDays:T,onClose:b,onSave:j,showAlert:l}){const a=(m,_)=>{const[u,E]=m.split(":").map(Number),[O,A]=_.split(":").map(Number);return O*60+A-(u*60+E)},w=T.find(m=>m.day===t.day)?.location||"",[p,$]=i.useState({day:t.day,startTime:t.startTime,endTime:t.endTime,location:t.location||w,notes:t.notes||""}),[d,M]=i.useState(!1),[P,c]=i.useState(a(t.startTime,t.endTime)),[N,D]=i.useState([]);i.useState(""),i.useEffect(()=>{if(!p.day||!P)return;const m=T.filter(u=>u.day===p.day),_=[];m.forEach(u=>{const[E,O]=u.startTime.split(":").map(Number),[A,q]=u.endTime.split(":").map(Number),ne=E*60+O,S=A*60+q-ne,Q=Math.floor(S/P);for(let Z=0;Z<Q;Z++){const oe=ne+Z*P,re=oe+P,ce=Math.floor(oe/60),k=oe%60,F=Math.floor(re/60),X=re%60,V=`${ce.toString().padStart(2,"0")}:${k.toString().padStart(2,"0")}`,Y=`${F.toString().padStart(2,"0")}:${X.toString().padStart(2,"0")}`;_.push({id:`${u._id||u.id}-${P}-${Z}`,startTime:V,endTime:Y,duration:P})}}),D(_)},[p.day,P,T]);const x=m=>{$(_=>({..._,startTime:m.startTime,endTime:m.endTime}))},h=async m=>{if(m.preventDefault(),!p.day||!p.startTime||!p.endTime){l("יש למלא את כל השדות הנדרשים");return}const _=a(p.startTime,p.endTime);if(_<=0){l("זמן הסיום חייב להיות לאחר זמן ההתחלה");return}try{if(M(!0),t.studentId){const u={teacherId:v,day:p.day,time:p.startTime,startTime:p.startTime,endTime:p.endTime,duration:_,location:p.location,isActive:!0};await R.students.updateTeacherAssignment(t.studentId,v,u)}z("השיעור עודכן בהצלחה","success"),j()}catch(u){console.error("Error updating lesson:",u),z("שגיאה בעדכון השיעור","error")}finally{M(!1)}},z=(m,_)=>{const u=document.createElement("div");u.className=`fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 ${_==="success"?"bg-green-500 text-white":"bg-red-500 text-white"}`,u.innerHTML=`<div class="flex items-center gap-2 font-reisinger-yonatan">
      ${_==="success"?"✅":"❌"} ${m}
    </div>`,document.body.appendChild(u),setTimeout(()=>u.remove(),3e3)},C=()=>{const m=Array.from(new Set(T.map(_=>_.day)));return m.length===0?["ראשון","שני","שלישי","רביעי","חמישי","שישי","שבת"]:m};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:"עריכת שיעור"}),e.jsx("button",{onClick:b,className:"p-2 text-gray-400 hover:text-gray-600",children:e.jsx(Se,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsx("h4",{className:"font-medium text-blue-900 mb-2 font-reisinger-yonatan",children:"פרטי התלמיד"}),e.jsxs("div",{className:"space-y-1 text-sm text-blue-800",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Le,{className:"w-4 h-4"}),e.jsx("strong",{children:"תלמיד:"})," ",t.studentName||"לא צוין"]}),t.instrument&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(we,{className:"w-4 h-4"}),e.jsx("strong",{children:"כלי נגינה:"})," ",t.instrument]}),t.studentClass&&e.jsxs("div",{children:[e.jsx("strong",{children:"כיתה:"})," ",t.studentClass]}),t.studentStage&&e.jsxs("div",{children:[e.jsx("strong",{children:"שלב:"})," ",t.studentStage]})]})]}),e.jsxs("form",{onSubmit:h,className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"יום בשבוע *"}),e.jsx("select",{value:p.day,onChange:m=>{const _=m.target.value,u=T.find(E=>E.day===_);$(E=>({...E,day:_,location:(!E.location||E.location==="")&&u?.location?u.location:E.location}))},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",required:!0,children:C().map(m=>e.jsx("option",{value:m,children:m},m))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"משך השיעור (דקות) *"}),e.jsx("div",{className:"grid grid-cols-3 gap-3",children:[30,45,60].map(m=>e.jsxs("button",{type:"button",onClick:()=>c(m),className:`px-4 py-2 rounded-lg border-2 transition-all ${P===m?"border-indigo-600 bg-indigo-50 text-indigo-700 font-semibold":"border-gray-300 bg-white text-gray-700 hover:border-indigo-300"}`,children:[m," דק׳"]},m))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:"בחר זמן שיעור זמין *"}),N.length===0?e.jsxs("div",{className:"text-center py-6 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsx(he,{className:"w-8 h-8 mx-auto mb-2 text-gray-300"}),e.jsx("p",{className:"text-sm text-gray-500",children:"אין זמנים זמינים ליום ומשך שיעור שנבחרו"})]}):e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 max-h-64 overflow-y-auto p-2 bg-gray-50 rounded-lg border border-gray-200",children:N.map(m=>{const _=p.startTime===m.startTime&&p.endTime===m.endTime;return e.jsxs("button",{type:"button",onClick:()=>x(m),className:`p-3 rounded-lg border-2 transition-all text-sm ${_?"border-green-600 bg-green-50 text-green-800 font-semibold shadow-md":m.duration===30?"border-green-300 bg-green-50 text-green-800 hover:border-green-500":m.duration===45?"border-blue-300 bg-blue-50 text-blue-800 hover:border-blue-500":"border-purple-300 bg-purple-50 text-purple-800 hover:border-purple-500"}`,children:[e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx(he,{className:"w-3 h-3"}),e.jsxs("span",{className:"font-medium",children:[m.startTime,"-",m.endTime]})]}),e.jsxs("div",{className:"text-xs mt-1 opacity-75",children:[m.duration," דקות"]})]},m.id)})})]}),p.startTime&&p.endTime&&e.jsx("div",{className:"p-3 bg-indigo-50 rounded-lg border border-indigo-200",children:e.jsxs("div",{className:"flex items-center gap-2 text-indigo-800",children:[e.jsx(he,{className:"w-4 h-4"}),e.jsxs("span",{className:"font-reisinger-yonatan font-medium",children:["זמן שיעור נבחר: ",p.startTime," - ",p.endTime," (",a(p.startTime,p.endTime)," דקות)"]})]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"מיקום / חדר"}),e.jsxs("select",{value:p.location||"",onChange:m=>$(_=>({..._,location:m.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"",children:"בחר חדר"}),_e.map(m=>e.jsx("option",{value:m,children:m},m))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"הערות"}),e.jsx("textarea",{value:p.notes,onChange:m=>$(_=>({..._,notes:m.target.value})),rows:3,placeholder:"הערות נוספות לגבי השיעור...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{className:"flex gap-3 pt-6 border-t",children:[e.jsx("button",{type:"submit",disabled:d||!p.startTime||!p.endTime,className:"flex-1 bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed font-reisinger-yonatan flex items-center justify-center gap-2",children:d?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"שומר..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ge,{className:"w-4 h-4"}),"עדכן שיעור"]})}),e.jsx("button",{type:"button",onClick:b,disabled:d,className:"flex-1 bg-gray-300 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed font-reisinger-yonatan",children:"ביטול"})]})]})]})})}function Bt(){const{user:t}=Te(),[v,T]=i.useState([]),[b,j]=i.useState(!0),[l,a]=i.useState(""),[r,w]=i.useState(!1),[p,$]=i.useState(null),[d,M]=i.useState(null),[P,c]=i.useState([]),[N,D]=i.useState(null),[x,h]=i.useState(!1),[z,C]=i.useState(!1),[m,_]=i.useState(!1),[u,E]=i.useState([]),[O,A]=i.useState(null),[q,ne]=i.useState("lessons");i.useEffect(()=>{y()},[t]);const y=async()=>{if(t?._id)try{j(!0);const n=t._id,W=(await R.theory.getTheoryLessons()).filter(B=>B.teacherId===n).map(B=>({id:B._id,name:B.name,description:B.description,level:B.level,duration:B.duration,capacity:B.capacity,enrolledCount:B.enrolledStudentIds?.length||0,schedule:{dayOfWeek:B.dayOfWeek,startTime:B.startTime,endTime:B.endTime},status:B.isActive?"active":"inactive",venue:B.location,materials:B.materials||[]}));T(W)}catch(n){console.error("Error loading theory lessons:",n),D("שגיאה בטעינת רשימת שיעורי התיאוריה")}finally{j(!1)}},S=async n=>{try{const J=(await R.theory.getTheoryLesson(n)).enrolledStudentIds||[];if(J.length===0){c([]);return}const B=(await R.students.getStudents({ids:J.join(",")})).map(s=>({id:s._id,firstName:s.personalInfo?.firstName||"",lastName:s.personalInfo?.lastName||"",grade:s.academicInfo?.gradeLevel,instrument:s.primaryInstrument,enrollmentDate:s.createdAt||new Date().toISOString(),attendance:{total:0,present:0,absent:0}}));c(B)}catch(g){console.error("Error loading lesson students:",g)}},Q=v.filter(n=>l===""||n.name.toLowerCase().includes(l.toLowerCase())||n.level.toLowerCase().includes(l.toLowerCase())||n.description?.toLowerCase().includes(l.toLowerCase())),Z=async n=>{if(window.confirm("האם אתה בטוח שברצונך למחוק שיעור זה?"))try{await R.theory.deleteTheoryLesson(n),T(g=>g.filter(J=>J.id!==n)),d===n&&(M(null),c([]))}catch(g){console.error("Error deleting lesson:",g),alert("שגיאה במחיקת השיעור")}},oe=async n=>{try{const g=await re(n);if(g.hasConflict){A(g),_(!0);return}if(p){const J={name:n.name,description:n.description,level:n.level,duration:n.duration,capacity:n.capacity,dayOfWeek:n.schedule?.dayOfWeek,startTime:n.schedule?.startTime,endTime:n.schedule?.endTime,isActive:n.status==="active",location:n.venue},W=await R.theory.updateTheoryLesson(p.id,J),B={id:W._id,name:W.name,description:W.description,level:W.level,duration:W.duration,capacity:W.capacity,enrolledCount:W.enrolledStudentIds?.length||0,schedule:{dayOfWeek:W.dayOfWeek,startTime:W.startTime,endTime:W.endTime},status:W.isActive?"active":"inactive",venue:W.location,materials:W.materials||[]};T(s=>s.map(L=>L.id===p.id?B:L))}else{const J=t?._id,W={name:n.name,description:n.description,level:n.level,duration:n.duration,capacity:n.capacity,dayOfWeek:n.schedule?.dayOfWeek,startTime:n.schedule?.startTime,endTime:n.schedule?.endTime,isActive:n.status==="active",location:n.venue,teacherId:J},B=await R.theory.createTheoryLesson(W),s={id:B._id,name:B.name,description:B.description,level:B.level,duration:B.duration,capacity:B.capacity,enrolledCount:B.enrolledStudentIds?.length||0,schedule:{dayOfWeek:B.dayOfWeek,startTime:B.startTime,endTime:B.endTime},status:B.isActive?"active":"inactive",venue:B.location,materials:B.materials||[]};T(L=>[...L,s])}w(!1),$(null)}catch(g){console.error("Error saving lesson:",g),alert("שגיאה בשמירת פרטי השיעור")}},re=async n=>{try{const g=v.filter(s=>s.id!==p?.id&&s.schedule.dayOfWeek===n.schedule?.dayOfWeek),J=n.schedule?.startTime,W=n.schedule?.endTime,B=g.filter(s=>{const L=s.schedule.startTime,U=s.schedule.endTime;return J&&W&&L&&U&&(J>=L&&J<U||W>L&&W<=U||J<=L&&W>=U)});return B.length>0?{hasConflict:!0,conflictDetails:`התנגשות עם ${B[0].name} ב${te(B[0].schedule.dayOfWeek)} ${B[0].schedule.startTime}-${B[0].schedule.endTime}`,suggestions:["שנה את שעת השיעור","העבר ליום אחר","קצר את משך השיעור"]}:{hasConflict:!1}}catch(g){return console.error("Error checking conflicts:",g),{hasConflict:!1}}},ce=async()=>{try{const n=await R.students.getStudents(),g=P.map(W=>W.id),J=n.filter(W=>!g.includes(W._id)).map(W=>({id:W._id,firstName:W.personalInfo?.firstName||"",lastName:W.personalInfo?.lastName||"",grade:W.academicInfo?.gradeLevel,instrument:W.primaryInstrument,enrollmentDate:new Date().toISOString(),attendance:{total:0,present:0,absent:0}}));E(J)}catch(n){console.error("Error loading available students:",n)}},k=async n=>{if(d)try{await Ye.enrollStudent(d,n,{method:"manual",performedBy:"teacher",reason:"Teacher enrollment"}),await S(d),await ce()}catch(g){console.error("Error enrolling student:",g),alert("שגיאה ברישום התלמיד")}},F=async n=>{if(d)try{await Ye.unenrollStudent(d,n,{reason:"Teacher unenrollment"}),await S(d),await ce()}catch(g){console.error("Error unenrolling student:",g),alert("שגיאה בביטול רישום התלמיד")}},X=async n=>{try{const g={...n,name:`${n.name} - עותק`,id:void 0};await oe(g)}catch(g){console.error("Error duplicating lesson:",g),alert("שגיאה בשכפול השיעור")}},V=n=>{switch(n){case"beginner":return"מתחילים";case"intermediate":return"בינוניים";case"advanced":return"מתקדמים";default:return n}},Y=n=>n.substring(0,5),te=n=>({sunday:"יום ראשון",monday:"יום שני",tuesday:"יום שלישי",wednesday:"יום רביעי",thursday:"יום חמישי",friday:"יום שישי",saturday:"יום שבת"})[n.toLowerCase()]||n;return b?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600",children:"טוען רשימת שיעורים..."})]})}):N?e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("div",{className:"text-red-800 font-reisinger-yonatan",children:N})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:"ניהול תיאוריה מתקדם"}),e.jsxs("p",{className:"text-gray-600 mt-1",children:[v.length," שיעורים פעילים"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>h(!0),className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[e.jsx(gt,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"נהל קבוצות"})]}),e.jsxs("button",{onClick:()=>w(!0),className:"flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors",children:[e.jsx(ke,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"הוסף שיעור"})]})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsx("nav",{className:"flex space-x-8 px-6",dir:"rtl",children:[{id:"lessons",label:"שיעורים",icon:$e},{id:"groups",label:"קבוצות",icon:fe},{id:"curriculum",label:"תכנית לימודים",icon:Ve},{id:"grades",label:"ציונים",icon:Xe}].map(n=>{const g=n.icon;return e.jsxs("button",{onClick:()=>ne(n.id),className:`py-4 px-1 border-b-2 font-medium text-sm transition-colors flex items-center gap-2 font-reisinger-yonatan ${q===n.id?"border-indigo-500 text-indigo-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}`,children:[e.jsx(g,{className:"w-4 h-4"}),n.label]},n.id)})})}),e.jsxs("div",{className:"p-6",children:[q==="lessons"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative mb-6",children:[e.jsx(ve,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"חיפוש שיעורים...",value:l,onChange:n=>a(n.target.value),className:"w-full pl-4 pr-12 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"rtl"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsx("div",{className:"space-y-4",children:Q.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx($e,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2 font-reisinger-yonatan",children:l?"לא נמצאו שיעורים":"אין שיעורים רשומים"}),e.jsx("p",{className:"text-gray-600 font-reisinger-yonatan",children:l?"נסה מילות חיפוש אחרות":"התחל בהוספת השיעור הראשון שלך"})]}):Q.map(n=>e.jsxs("div",{className:`bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all cursor-pointer ${d===n.id?"ring-2 ring-indigo-500 bg-indigo-50":""}`,onClick:()=>{M(n.id),S(n.id)},children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-gray-900 font-reisinger-yonatan",children:n.name}),e.jsxs("p",{className:"text-sm text-gray-600 font-reisinger-yonatan",children:[V(n.level)," • ",n.duration," דקות"]}),n.description&&e.jsx("p",{className:"text-sm text-gray-500 mt-1 font-reisinger-yonatan",children:n.description})]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:g=>{g.stopPropagation(),X(n)},className:"p-1 text-gray-400 hover:text-blue-600 transition-colors",title:"שכפל שיעור",children:e.jsx(xt,{className:"w-4 h-4"})}),e.jsx("button",{onClick:g=>{g.stopPropagation(),$(n),w(!0)},className:"p-1 text-gray-400 hover:text-indigo-600 transition-colors",title:"ערוך שיעור",children:e.jsx(Be,{className:"w-4 h-4"})}),e.jsx("button",{onClick:g=>{g.stopPropagation(),Z(n.id)},className:"p-1 text-gray-400 hover:text-red-600 transition-colors",title:"מחק שיעור",children:e.jsx(Re,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm text-gray-600 mb-3",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(xe,{className:"w-4 h-4"}),e.jsx("span",{children:te(n.schedule.dayOfWeek)})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(he,{className:"w-4 h-4"}),e.jsxs("span",{children:[Y(n.schedule.startTime)," - ",Y(n.schedule.endTime)]})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(fe,{className:"w-4 h-4"}),e.jsxs("span",{children:[n.enrolledCount||0,"/",n.capacity]})]}),n.venue&&e.jsx("span",{children:n.venue})]}),e.jsx("span",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${n.status==="active"?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"}`,children:n.status==="active"?"פעיל":"לא פעיל"})]})]},n.id))}),d&&e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h4",{className:"font-semibold text-gray-900 font-reisinger-yonatan",children:"תלמידי השיעור"}),e.jsx("div",{className:"flex gap-2",children:e.jsxs("button",{onClick:()=>{C(!0),ce()},className:"flex items-center gap-1 text-indigo-600 hover:text-indigo-800 text-sm font-medium font-reisinger-yonatan",children:[e.jsx(ye,{className:"w-4 h-4"}),"הוסף תלמיד"]})})]}),P.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(fe,{className:"w-8 h-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-500 text-sm font-reisinger-yonatan",children:"אין תלמידים רשומים לשיעור"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:P.map(n=>e.jsxs("div",{className:"flex items-center justify-between p-3 hover:bg-gray-50 rounded border",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-medium text-sm font-reisinger-yonatan",children:[n.firstName," ",n.lastName]}),e.jsxs("div",{className:"text-xs text-gray-500 font-reisinger-yonatan",children:[n.instrument&&`${n.instrument} • `,n.grade&&`כיתה ${n.grade} • `,"רישום: ",new Date(n.enrollmentDate).toLocaleDateString("he-IL")]}),n.attendance&&e.jsxs("div",{className:"text-xs text-gray-500 mt-1 font-reisinger-yonatan",children:["נוכחות: ",n.attendance.present,"/",n.attendance.total," שיעורים",e.jsxs("span",{className:`ml-2 ${n.attendance.present/n.attendance.total>=.8?"text-green-600":"text-red-600"}`,children:["(",Math.round(n.attendance.present/n.attendance.total*100),"%)"]})]})]}),e.jsx("button",{onClick:()=>F(n.id),className:"text-red-600 hover:text-red-800 p-1",title:"הסר תלמיד",children:e.jsx(Ke,{className:"w-4 h-4"})})]},n.id))})]})]})]}),q==="groups"&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(fe,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2 font-reisinger-yonatan",children:"ניהול קבוצות תיאוריה"}),e.jsx("p",{className:"text-gray-600 font-reisinger-yonatan",children:"תכונה זו תהיה זמינה בקרוב"})]}),q==="curriculum"&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Ve,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2 font-reisinger-yonatan",children:"תכנית לימודים"}),e.jsx("p",{className:"text-gray-600 font-reisinger-yonatan",children:"תכונה זו תהיה זמינה בקרוב"})]}),q==="grades"&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Xe,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2 font-reisinger-yonatan",children:"ניהול ציונים"}),e.jsx("p",{className:"text-gray-600 font-reisinger-yonatan",children:"תכונה זו תהיה זמינה בקרוב"})]})]})]}),r&&e.jsx(Rt,{lesson:p,onClose:()=>{w(!1),$(null)},onSubmit:oe}),z&&e.jsx(Pt,{availableStudents:u,onClose:()=>C(!1),onEnroll:k}),m&&O&&e.jsx(Ft,{conflict:O,onClose:()=>_(!1),onResolve:()=>{_(!1),w(!0)}})]})}function Rt({lesson:t,onClose:v,onSubmit:T}){const[b,j]=i.useState({name:t?.name||"",description:t?.description||"",level:t?.level||"beginner",duration:t?.duration||60,capacity:t?.capacity||15,status:t?.status||"active",venue:t?.venue||"",schedule:{dayOfWeek:t?.schedule?.dayOfWeek||"sunday",startTime:t?.schedule?.startTime||"09:00",endTime:t?.schedule?.endTime||"10:00"}}),l=r=>{r.preventDefault(),T(b)},a=(r,w)=>{j(p=>({...p,schedule:{...p.schedule,[r]:w}}))};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto",dir:"rtl",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900 mb-4 font-reisinger-yonatan",children:t?"עריכת שיעור תיאוריה":"הוספת שיעור תיאוריה חדש"}),e.jsxs("form",{onSubmit:l,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שם השיעור *"}),e.jsx("input",{type:"text",required:!0,value:b.name,onChange:r=>j(w=>({...w,name:r.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"תיאור השיעור"}),e.jsx("textarea",{value:b.description,onChange:r=>j(w=>({...w,description:r.target.value})),rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"רמה *"}),e.jsxs("select",{required:!0,value:b.level,onChange:r=>j(w=>({...w,level:r.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"beginner",children:"מתחילים"}),e.jsx("option",{value:"intermediate",children:"בינוניים"}),e.jsx("option",{value:"advanced",children:"מתקדמים"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"משך השיעור (דקות) *"}),e.jsx("input",{type:"number",required:!0,min:"30",max:"180",step:"15",value:b.duration,onChange:r=>j(w=>({...w,duration:parseInt(r.target.value)})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"קיבולת תלמידים *"}),e.jsx("input",{type:"number",required:!0,min:"1",max:"50",value:b.capacity,onChange:r=>j(w=>({...w,capacity:parseInt(r.target.value)})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"סטטוס"}),e.jsxs("select",{value:b.status,onChange:r=>j(w=>({...w,status:r.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"active",children:"פעיל"}),e.jsx("option",{value:"inactive",children:"לא פעיל"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"יום השיעור *"}),e.jsxs("select",{required:!0,value:b.schedule.dayOfWeek,onChange:r=>a("dayOfWeek",r.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"sunday",children:"יום ראשון"}),e.jsx("option",{value:"monday",children:"יום שני"}),e.jsx("option",{value:"tuesday",children:"יום שלישי"}),e.jsx("option",{value:"wednesday",children:"יום רביעי"}),e.jsx("option",{value:"thursday",children:"יום חמישי"}),e.jsx("option",{value:"friday",children:"יום שישי"}),e.jsx("option",{value:"saturday",children:"יום שבת"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שעת התחלה *"}),e.jsx("input",{type:"time",required:!0,value:b.schedule.startTime,onChange:r=>a("startTime",r.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שעת סיום *"}),e.jsx("input",{type:"time",required:!0,value:b.schedule.endTime,onChange:r=>a("endTime",r.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"מקום השיעור"}),e.jsx("input",{type:"text",value:b.venue,onChange:r=>j(w=>({...w,venue:r.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx("button",{type:"submit",className:"flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors font-reisinger-yonatan",children:t?"עדכן":"הוסף"}),e.jsx("button",{type:"button",onClick:v,className:"flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors font-reisinger-yonatan",children:"ביטול"})]})]})]})})}function Pt({availableStudents:t,onClose:v,onEnroll:T}){const[b,j]=i.useState(""),l=t.filter(a=>`${a.firstName} ${a.lastName}`.toLowerCase().includes(b.toLowerCase())||a.instrument?.toLowerCase().includes(b.toLowerCase()));return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-md mx-4 max-h-[80vh] overflow-y-auto",dir:"rtl",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900 mb-4 font-reisinger-yonatan",children:"הוסף תלמיד לשיעור"}),e.jsxs("div",{className:"relative mb-4",children:[e.jsx(ve,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"text",placeholder:"חיפוש תלמידים...",value:b,onChange:a=>j(a.target.value),className:"w-full pl-4 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto",children:l.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(fe,{className:"w-8 h-8 mx-auto mb-2 text-gray-300"}),e.jsx("p",{className:"font-reisinger-yonatan",children:"אין תלמידים זמינים"})]}):l.map(a=>e.jsxs("div",{className:"flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium text-gray-900 font-reisinger-yonatan",children:[a.firstName," ",a.lastName]}),e.jsxs("div",{className:"text-sm text-gray-600 font-reisinger-yonatan",children:[a.instrument&&`${a.instrument} • `,a.grade&&`כיתה ${a.grade}`]})]}),e.jsxs("button",{onClick:()=>T(a.id),className:"flex items-center gap-1 px-3 py-1 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm font-reisinger-yonatan",children:[e.jsx(ye,{className:"w-4 h-4"}),"הוסף"]})]},a.id))}),e.jsx("div",{className:"flex gap-3 mt-6",children:e.jsx("button",{onClick:v,className:"flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors font-reisinger-yonatan",children:"סגור"})})]})})}function Ft({conflict:t,onClose:v,onResolve:T}){return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-md mx-4",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx(ht,{className:"w-8 h-8 text-yellow-600"}),e.jsx("h3",{className:"text-lg font-bold text-gray-900 font-reisinger-yonatan",children:"התנגשות בלוח הזמנים"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-gray-700 font-reisinger-yonatan mb-3",children:t.conflictDetails}),t.suggestions&&e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900 mb-2 font-reisinger-yonatan",children:"הצעות לפתרון:"}),e.jsx("ul",{className:"list-disc list-inside space-y-1 text-sm text-gray-600",children:t.suggestions.map((b,j)=>e.jsx("li",{className:"font-reisinger-yonatan",children:b},j))})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:T,className:"flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors font-reisinger-yonatan",children:"ערוך שיעור"}),e.jsx("button",{onClick:v,className:"flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors font-reisinger-yonatan",children:"ביטול"})]})]})})}function Wt(){const{user:t,checkAuthStatus:v}=Te(),[T,b]=i.useState(!1),[j,l]=i.useState(!1),[a,r]=i.useState({type:null,message:""}),[w,p]=i.useState(null),[$,d]=i.useState({fullName:"",email:"",phone:"",address:"",birthDate:""});i.useEffect(()=>{M()},[]);const M=async()=>{try{l(!0);const x=await ze.getMyProfile();p(x),d({fullName:x?.personalInfo?.fullName||"",email:x?.personalInfo?.email||"",phone:x?.personalInfo?.phone||"",address:x?.personalInfo?.address||"",birthDate:x?.personalInfo?.birthDate||""})}catch(x){console.error("Error fetching profile data:",x),r({type:"error",message:"שגיאה בטעינת פרטי הפרופיל"}),t&&d({fullName:t?.personalInfo?.fullName||"",email:t?.personalInfo?.email||t?.email||"",phone:t?.personalInfo?.phone||t?.phone||"",address:t?.personalInfo?.address||t?.address||"",birthDate:t?.personalInfo?.birthDate||t?.birthDate||""})}finally{l(!1)}},P=async()=>{try{l(!0),r({type:null,message:""});const x=await ze.updateMyProfile($);p(x),v&&await v(!0),b(!1),r({type:"success",message:"הפרופיל עודכן בהצלחה"}),setTimeout(()=>{r({type:null,message:""})},3e3)}catch(x){console.error("Error updating profile:",x),r({type:"error",message:"שגיאה בעדכון הפרופיל. אנא נסה שוב."})}finally{l(!1)}},c=()=>{const x=w||t;d({fullName:x?.personalInfo?.fullName||"",email:x?.personalInfo?.email||x?.email||"",phone:x?.personalInfo?.phone||x?.phone||"",address:x?.personalInfo?.address||x?.address||"",birthDate:x?.personalInfo?.birthDate||x?.birthDate||""}),b(!1),r({type:null,message:""})},N=x=>x?new Date(x).toLocaleDateString("he-IL"):"",D=w||t;return j&&!D?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"}),e.jsx("p",{className:"mt-4 text-gray-600 font-reisinger-yonatan",children:"טוען פרטי פרופיל..."})]})}):e.jsxs("div",{className:"space-y-6",children:[a.type&&e.jsxs("div",{className:`p-4 rounded-lg flex items-center gap-2 ${a.type==="success"?"bg-green-50 text-green-800 border border-green-200":"bg-red-50 text-red-800 border border-red-200"}`,children:[a.type==="success"?e.jsx(Ue,{className:"w-5 h-5"}):e.jsx(Me,{className:"w-5 h-5"}),e.jsx("span",{className:"font-reisinger-yonatan",children:a.message})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:"פרטים אישיים"}),T?e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:P,disabled:j,className:"flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[j?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}):e.jsx(pt,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"שמירה"})]}),e.jsxs("button",{onClick:c,disabled:j,className:"flex items-center gap-2 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(Se,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"ביטול"})]})]}):e.jsxs("button",{onClick:()=>b(!0),disabled:j,className:"flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(ft,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"עריכה"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 font-reisinger-yonatan",children:"שם מלא"}),T?e.jsx("input",{type:"text",value:$.fullName,onChange:x=>d(h=>({...h,fullName:x.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"rtl",placeholder:"הזן שם מלא"}):e.jsx("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:e.jsx("span",{className:"font-reisinger-yonatan",children:$.fullName||"לא צוין"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 font-reisinger-yonatan",children:'דוא"ל'}),T?e.jsx("input",{type:"email",value:$.email,onChange:x=>d(h=>({...h,email:x.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"ltr",placeholder:"example@email.com"}):e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:[e.jsx(yt,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"font-reisinger-yonatan",dir:"ltr",children:$.email||"לא צוין"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 font-reisinger-yonatan",children:"טלפון"}),T?e.jsx("input",{type:"tel",value:$.phone,onChange:x=>d(h=>({...h,phone:x.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"ltr",placeholder:"050-1234567"}):e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:[e.jsx(Je,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"font-reisinger-yonatan",dir:"ltr",children:$.phone||"לא צוין"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 font-reisinger-yonatan",children:"כתובת"}),T?e.jsx("input",{type:"text",value:$.address,onChange:x=>d(h=>({...h,address:x.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"rtl",placeholder:"הזן כתובת"}):e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:[e.jsx(Ne,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"font-reisinger-yonatan",children:$.address||"לא צוין"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 font-reisinger-yonatan",children:"תאריך לידה"}),T?e.jsx("input",{type:"date",value:$.birthDate,onChange:x=>d(h=>({...h,birthDate:x.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"}):e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:[e.jsx(xe,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"font-reisinger-yonatan",children:N($.birthDate)||"לא צוין"})]})]})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("h4",{className:"text-lg font-semibold text-blue-900 mb-2 font-reisinger-yonatan",children:"מידע תפקיד"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-sm font-medium text-blue-700 font-reisinger-yonatan",children:"תפקיד:"}),e.jsx("div",{className:"text-blue-900 font-reisinger-yonatan",children:(()=>{const x=D?.roles||[];if(x.length>0)return x.join(", ");const h=D?.role||"";switch(h){case"teacher":return"מורה";case"מורה":return"מורה";case"conductor":return"מנצח";case"מנצח":return"מנצח";case"theory_teacher":return"מורה תיאוריה";case"מורה תיאוריה":return"מורה תיאוריה";case"admin":return"מנהל";case"מנהל":return"מנהל";default:return h||"לא צוין"}})()})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-sm font-medium text-blue-700 font-reisinger-yonatan",children:"מזהה משתמש:"}),e.jsx("div",{className:"text-blue-900 font-reisinger-yonatan font-mono text-sm",children:D?.teacherId||D?._id||D?.id||"לא צוין"})]}),D?.isActive!==void 0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-sm font-medium text-blue-700 font-reisinger-yonatan",children:"סטטוס:"}),e.jsx("div",{className:"text-blue-900 font-reisinger-yonatan",children:D.isActive?"פעיל":"לא פעיל"})]}),D?.professionalInfo?.instrument&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-sm font-medium text-blue-700 font-reisinger-yonatan",children:"כלי נגינה:"}),e.jsx("div",{className:"text-blue-900 font-reisinger-yonatan",children:D.professionalInfo.instrument})]})]})]})]})}function Yt(){const{user:t}=Te(),v=lt();ot();const[T,b]=i.useState("general"),[j,l]=i.useState(null),[a,r]=i.useState(!0);i.useEffect(()=>{const C=v.state;C?.activeTab&&(b(C.activeTab),window.history.replaceState(null,"",window.location.pathname))},[v]),i.useEffect(()=>{t&&w()},[t]);const w=async()=>{try{if(r(!0),!(t?._id||t?.teacherId||t?.id)){console.warn("No user ID available for loading profile statistics");return}const m=await ze.getMyProfile();if(!m){console.warn("No teacher profile found"),l({studentsCount:0,activeStudents:0,weeklyHours:0,orchestrasCount:0,theoryLessonsCount:0});return}const _=m?.teaching?.studentIds||[],u=m?.conducting?.orchestraIds||[],E=m?.teaching?.timeBlocks||[],[O,A]=await Promise.allSettled([_.length>0?R.students.getBatchStudents(_):Promise.resolve([]),u.length>0?R.orchestras.getBatchOrchestras(u):Promise.resolve([])]),q=O.status==="fulfilled"?O.value:[];O.status==="rejected"&&console.error("Failed to load student data:",O.reason);const ne=A.status==="fulfilled"?A.value:[];A.status==="rejected"&&console.error("Failed to load orchestra data:",A.reason);const y=Array.isArray(q)?q.filter(Z=>Z.academicInfo?.isActive!==!1):[],S=Array.isArray(E)?E.reduce((Z,oe)=>Z+(parseInt(oe.totalDuration)||0),0):0,Q=Math.round(S/60*10)/10;l({studentsCount:Array.isArray(q)?q.length:0,activeStudents:y.length,weeklyHours:Q,orchestrasCount:Array.isArray(ne)?ne.length:0,theoryLessonsCount:0})}catch(C){console.error("Error loading profile statistics:",C),l({studentsCount:0,activeStudents:0,weeklyHours:0,orchestrasCount:0,theoryLessonsCount:0})}finally{r(!1)}};if(!t)return e.jsx("div",{className:"flex items-center justify-center min-h-96",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600",children:"טוען פרטי משתמש..."})]})});const p=()=>t?.roles?.includes("conductor")||t?.roles?.includes("מנצח")||t?.conducting?.orchestraIds&&t.conducting.orchestraIds.length>0,$=()=>t?.roles?.includes("teacher")||t?.roles?.includes("מורה")||t?.teaching?.studentIds&&t.teaching.studentIds.length>0,d=()=>t?.roles?.includes("theory_teacher")||t?.roles?.includes("מורה תאוריה"),P=(()=>{const m=[...[{id:"general",label:"פרטים כלליים",icon:Le,component:Wt}]];return $()&&(m.push({id:"students",label:"התלמידים שלי",icon:fe,component:wt}),m.push({id:"schedule",label:"לוח זמנים שבועי",icon:xe,component:$t})),p()&&m.push({id:"orchestras",label:"התזמורות שלי",icon:we,component:It}),d()&&m.push({id:"lessons",label:"שיעורי התיאוריה שלי",icon:$e,component:Bt}),m})(),N=(P.find(C=>C.id===T)||P[0]).component,D=()=>{const C=t?.role||t?.roles?.[0]||"";switch(C){case"teacher":return"מורה";case"מורה":return"מורה";case"conductor":return"מנצח";case"מנצח":return"מנצח";case"theory_teacher":return"מורה תיאוריה";case"מורה תיאוריה":return"מורה תיאוריה";case"admin":return"מנהל";case"מנהל":return"מנהל";default:return C||"משתמש"}},x=()=>t?.personalInfo?.fullName||t?.fullName||t?.name||"משתמש",h=()=>{const C=x();if(!C||C==="משתמש")return"מ";const m=C.trim().split(" ");return m.length>=2?m[0][0]+m[1][0]:m[0][0]||"מ"},z=()=>t?.personalInfo?.email||t?.email||"";return e.jsxs("div",{className:"p-6",dir:"rtl",children:[e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-indigo-600 flex items-center justify-center",children:e.jsx("span",{className:"text-xl font-bold text-white font-reisinger-yonatan",children:h()})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 font-reisinger-yonatan",children:x()}),e.jsxs("p",{className:"text-gray-600 mt-1",children:[D()," • ",z()]})]})]})}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-6",children:[e.jsx(Ae,{title:"סה״כ תלמידים",value:a?"...":j?.studentsCount?.toString()||"0",icon:fe,color:"blue",loading:a}),e.jsx(Ae,{title:"תלמידים פעילים",value:a?"...":j?.activeStudents?.toString()||"0",icon:bt,color:"green",loading:a}),e.jsx(Ae,{title:"שעות שבועיות",value:a?"...":j?.weeklyHours?.toString()||"0",icon:he,color:"purple",loading:a}),e.jsx(Ae,{title:p()?"תזמורות":"שיעורי תיאוריה",value:a?"...":(j?.orchestrasCount||j?.theoryLessonsCount)?.toString()||"0",icon:p()?we:$e,color:"indigo",loading:a})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 mb-6",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsx("nav",{className:"flex gap-0 overflow-x-auto scrollbar-hide",children:P.map(C=>{const m=C.icon;return e.jsxs("button",{onClick:()=>b(C.id),className:`flex items-center gap-2 sm:gap-3 px-3 sm:px-6 py-3 sm:py-4 font-medium text-xs sm:text-sm transition-all whitespace-nowrap ${T===C.id?"text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50":"text-gray-500 hover:text-gray-700 hover:bg-gray-50"}`,children:[e.jsx(m,{className:"w-5 h-5"}),e.jsx("span",{className:"font-reisinger-yonatan",children:C.label})]},C.id)})})}),e.jsx("div",{className:"p-6",children:e.jsx(N,{})})]})]})}function Ae({title:t,value:v,icon:T,color:b,loading:j}){const a={blue:{bg:"bg-blue-50",text:"text-blue-600",border:"border-blue-200"},green:{bg:"bg-green-50",text:"text-green-600",border:"border-green-200"},purple:{bg:"bg-purple-50",text:"text-purple-600",border:"border-purple-200"},indigo:{bg:"bg-indigo-50",text:"text-indigo-600",border:"border-indigo-200"}}[b];return e.jsx("div",{className:`bg-white rounded-lg border ${a.border} p-3 sm:p-4 shadow-sm hover:shadow-md transition-all duration-200`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-xs sm:text-sm font-medium text-gray-600 font-reisinger-yonatan truncate",children:t}),e.jsx("div",{className:"text-lg sm:text-2xl font-bold text-gray-900 mt-1 font-reisinger-yonatan",children:j?e.jsx("div",{className:"animate-pulse bg-gray-200 h-6 sm:h-8 w-12 sm:w-16 rounded"}):v})]}),e.jsx("div",{className:`${a.bg} p-2 sm:p-3 rounded-full flex-shrink-0 ml-2`,children:e.jsx(T,{className:`w-4 h-4 sm:w-6 sm:h-6 ${a.text}`})})]})})}export{Yt as default};
