import{j as e,e as ge,c as be,g as je,f as pe,R as fe}from"../assets/index-Bt-rbdKT.js";import{c as Ne,b as ve,r as a}from"./vendor-B2j9q2e_.js";import{r as g,o as ye,f as we}from"./cascade-deletion-DAN0Gkem.js";import{C as Se}from"./Card-Bp9nq125.js";import{C as ke}from"./ConfirmationModal-B7HaZ5IM.js";import{a9 as Ce,u as D,O as Re,T as Ae,b as H,d as De,e as ze,f as z,X as w,a5 as Me,c as Te,i as O,m as _e,S as Ie}from"./ui-ypR0-hKN.js";import"./query-BI61muSV.js";import"./utils-x1PSU_OZ.js";function Oe(){const{rehearsalId:b}=Ne(),j=ve(),[s,Q]=a.useState(null),[X,q]=a.useState([]),[V,M]=a.useState(!0),[T,p]=a.useState(null),[W,S]=a.useState(!1),[Y,f]=a.useState(!1),[n,N]=a.useState(null),[h,v]=a.useState(!1),[_,m]=a.useState(null),[d,x]=a.useState({present:new Set,absent:new Set}),[k,G]=a.useState(""),[I,E]=a.useState(!1),[U,J]=a.useState(!1),[B,o]=a.useState(null),[K,F]=a.useState(!1),[Z,C]=a.useState(!1),[ee,R]=a.useState(!1);a.useEffect(()=>{b&&y()},[b]);const y=async()=>{if(b)try{M(!0),p(null);const[t,r,c]=await Promise.all([g.getRehearsals(),ye.getOrchestras(),we.getStudents()]),l=t.find(u=>u._id===b);if(!l){p("החזרה לא נמצאה");return}const i=r.find(u=>u._id===l.groupId),he={...l,orchestra:i?{_id:i._id,name:i.name,type:i.type,memberIds:i.memberIds||[],conductor:i.conductor,members:i.memberIds?i.memberIds.map(u=>c.find(ue=>ue._id===u)).filter(Boolean):[]}:void 0};Q(he),q(r),x({present:new Set(l.attendance?.present||[]),absent:new Set(l.attendance?.absent||[])})}catch(t){console.error("Error loading rehearsal details:",t),p("שגיאה בטעינת פרטי החזרה")}finally{M(!1)}},se=async t=>{s&&(N(t),S(!1),m(null),f(!0))},te=async()=>{if(!(!s||!n)){v(!0),m(null);try{await g.updateRehearsal(s._id,n),f(!1),N(null),await y()}catch(t){m(t.message||"שגיאה בעדכון החזרה")}finally{v(!1)}}},ae=async()=>{if(!(!s||!n)){v(!0),m(null);try{const t=["_id","createdAt","updatedAt","groupId","date","schoolYearId","type"],r=Object.keys(n).filter(c=>!t.includes(c)).reduce((c,l)=>(c[l]=n[l],c),{});await g.updateBulkRehearsals(s.groupId,r),f(!1),N(null),await y()}catch(t){m(t.message||"שגיאה בעדכון החזרות")}finally{v(!1)}}},L=()=>{f(!1),N(null),m(null)},re=()=>{R(!0)},le=async()=>{if(s)try{await g.deleteRehearsal(s._id),j("/rehearsals")}catch{p("שגיאה במחיקת החזרה")}finally{R(!1)}},ne=()=>{R(!1)};a.useEffect(()=>{if(!s)return;const t=new Set(s.attendance?.present||[]),r=new Set(s.attendance?.absent||[]),c=t.size!==d.present.size||r.size!==d.absent.size||[...d.present].some(l=>!t.has(l))||[...d.absent].some(l=>!r.has(l));J(c)},[d,s]);const P=(t,r)=>{x(c=>{const l={present:new Set(c.present),absent:new Set(c.absent)};return l.present.delete(t),l.absent.delete(t),r==="present"?l.present.add(t):r==="absent"&&l.absent.add(t),l}),o(null)},de=()=>{s&&(x({present:new Set(s.attendance?.present||[]),absent:new Set(s.attendance?.absent||[])}),o(null))},ce=a.useCallback(()=>{if(!s?.orchestra?.members)return;const t=s.orchestra.members.map(r=>r._id);x({present:new Set(t),absent:new Set}),o(null)},[s]),ie=a.useCallback(()=>{if(!s?.orchestra?.members)return;const t=s.orchestra.members.map(r=>r._id);x({present:new Set,absent:new Set(t)}),o(null)},[s]),oe=a.useCallback(()=>{x({present:new Set,absent:new Set}),o(null)},[]),me=async()=>{if(s){E(!0),o(null);try{const t={present:[...d.present],absent:[...d.absent]};await g.updateAttendance(s._id,t),F(!0),setTimeout(()=>{F(!1),C(!1)},1500),await y()}catch(t){o(t.message||"שגיאה בשמירת הנוכחות")}finally{E(!1)}}},xe=t=>d.present.has(t)?"present":d.absent.has(t)?"absent":"unmarked",$=a.useMemo(()=>{if(!s)return!1;const t=new Date(s.date),r=new Date;return r.setHours(0,0,0,0),t.setHours(0,0,0,0),t<=r},[s]);if(V)return e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600",children:"טוען פרטי החזרה..."})]})});if(T)return e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:[e.jsx("p",{className:"text-red-800",children:T}),e.jsx("button",{onClick:()=>j("/rehearsals"),className:"mt-2 text-red-600 hover:text-red-800 underline",children:"חזור לחזרות"})]})});if(!s)return e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"החזרה לא נמצאה"}),e.jsx("button",{onClick:()=>j("/rehearsals"),className:"text-primary-600 hover:text-primary-800 underline",children:"חזור לחזרות"})]})});ge(s),be(s),je(s);const A=pe(s);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{onClick:()=>j("/rehearsals"),className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",title:"חזור לחזרות",children:e.jsx(Ce,{className:"w-5 h-5 text-gray-600"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"פרטי החזרה"}),e.jsx("p",{className:"text-gray-600 mt-1",children:s.orchestra?.name||"ללא שם"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[$&&e.jsxs("button",{onClick:()=>C(!0),className:"flex items-center px-4 py-2 text-green-700 border border-green-300 rounded-lg hover:bg-green-50 transition-colors",children:[e.jsx(D,{className:"w-4 h-4 ml-1"}),"סימון נוכחות"]}),e.jsxs("button",{onClick:()=>S(!0),className:"flex items-center px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors",children:[e.jsx(Re,{className:"w-4 h-4 ml-1"}),"ערוך"]}),e.jsxs("button",{onClick:re,className:"flex items-center px-4 py-2 text-red-600 border border-red-300 rounded-lg hover:bg-red-50 transition-colors",children:[e.jsx(Ae,{className:"w-4 h-4 ml-1"}),"מחק"]})]})]}),e.jsx("div",{className:"space-y-6",children:e.jsx(Se,{children:e.jsxs("div",{className:"p-6",children:[e.jsx("div",{className:"flex items-start justify-between mb-6",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:s.orchestra?.name||"ללא שם"}),e.jsx("div",{className:"flex items-center gap-4",children:e.jsx("span",{className:`inline-flex px-3 py-1 text-sm font-medium rounded-full ${s.type==="תזמורת"?"bg-blue-100 text-blue-800":"bg-pink-100 text-pink-800"}`,children:s.type})})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(H,{className:"w-5 h-5 text-gray-400"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:"תאריך"}),e.jsx("div",{className:"text-gray-600",children:A.date}),e.jsx("div",{className:"text-sm text-gray-500",children:A.dayName})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(De,{className:"w-5 h-5 text-gray-400"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:"שעה"}),e.jsx("div",{className:"text-gray-600",children:A.time})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ze,{className:"w-5 h-5 text-gray-400"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:"מיקום"}),e.jsx("div",{className:"text-gray-600",children:s.location||"לא צוין מיקום"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(z,{className:"w-5 h-5 text-gray-400"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:"חברי התזמורת"}),e.jsxs("div",{className:"text-gray-600",children:[s.orchestra?.members?.length||0," חברים"]})]})]})]}),s.notes&&e.jsxs("div",{className:"mt-6 pt-6 border-t border-gray-200",children:[e.jsx("div",{className:"font-medium text-gray-900 mb-2",children:"הערות"}),e.jsx("div",{className:"text-gray-600 whitespace-pre-wrap",children:s.notes})]}),!$&&e.jsx("div",{className:"mt-6 pt-6 border-t border-gray-200",children:e.jsxs("div",{className:"flex items-center p-3 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("svg",{className:"w-5 h-5 text-blue-600",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z",clipRule:"evenodd"})})}),e.jsx("div",{className:"mr-3",children:e.jsxs("div",{className:"text-sm text-blue-800",children:[e.jsx("strong",{children:"חזרה עתידית:"})," לא ניתן לסמן נוכחות לחזרות שטרם התרחשו. נוכחות תהיה זמינה החל מיום החזרה."]})})]})})]})})}),Z&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsx("div",{className:"bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"ניהול נוכחות"}),e.jsx("button",{onClick:()=>C(!1),className:"text-gray-400 hover:text-gray-600",children:e.jsx(w,{className:"w-6 h-6"})})]}),e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("button",{onClick:ce,className:"px-3 py-1 text-sm bg-green-600 text-white rounded-full hover:bg-green-700 transition-colors",children:[e.jsx(D,{className:"w-3 h-3 inline-block ml-1"}),"סמן הכל נוכח"]}),e.jsxs("button",{onClick:ie,className:"px-3 py-1 text-sm bg-red-600 text-white rounded-full hover:bg-red-700 transition-colors",children:[e.jsx(w,{className:"w-3 h-3 inline-block ml-1"}),"סמן הכל נעדר"]}),e.jsx("button",{onClick:oe,className:"px-3 py-1 text-sm bg-gray-500 text-white rounded-full hover:bg-gray-600 transition-colors",children:"נקה הכל"}),U&&e.jsxs("button",{onClick:de,className:"px-3 py-1 text-sm bg-blue-100 text-blue-800 rounded-full hover:bg-blue-200 transition-colors",children:[e.jsx(Me,{className:"w-3 h-3 mr-1 inline"}),"שחזר מקור"]})]})}),K&&e.jsx("div",{className:"mb-4 p-3 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(Te,{className:"w-4 h-4 text-green-600 ml-2"}),e.jsx("span",{className:"text-green-800 text-sm",children:"הנוכחות נשמרה בהצלחה!"})]})}),B&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(O,{className:"w-4 h-4 text-red-600 ml-2"}),e.jsx("span",{className:"text-red-800 text-sm",children:B})]})}),e.jsxs("div",{className:"grid grid-cols-4 gap-4 mb-6 p-4 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:d.present.size}),e.jsx("div",{className:"text-sm text-gray-600",children:"נוכחים"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:d.absent.size}),e.jsx("div",{className:"text-sm text-gray-600",children:"נעדרים"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-gray-600",children:(s.orchestra?.members?.length||0)-d.present.size-d.absent.size}),e.jsx("div",{className:"text-sm text-gray-600",children:"לא סומנו"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:s.orchestra?.members?.length||0}),e.jsx("div",{className:"text-sm text-gray-600",children:"סה״כ"})]})]}),e.jsxs("div",{className:"relative mb-4",children:[e.jsx(_e,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"חיפוש חבר...",value:k,onChange:t=>G(t.target.value),className:"w-full pr-10 pl-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"})]}),e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:!s.orchestra?.members||s.orchestra.members.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(z,{className:"w-12 h-12 mx-auto mb-2 text-gray-400"}),e.jsx("p",{children:"אין חברים רשומים לתזמורת/הרכב זה"}),e.jsx("p",{className:"text-sm mt-1",children:"יש להוסיף חברים דרך עמוד התזמורת"})]}):s.orchestra.members.filter(t=>t.personalInfo?.fullName?.toLowerCase().includes(k.toLowerCase())||t.academicInfo?.class?.includes(k)).map(t=>{const r=xe(t._id);return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-gray-900",children:t.personalInfo?.fullName}),t.academicInfo?.class&&e.jsx("div",{className:"text-sm text-gray-500",children:t.academicInfo.class})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>P(t._id,r==="present"?"unmarked":"present"),className:`p-2 rounded-lg transition-colors ${r==="present"?"bg-green-100 text-green-600 border-2 border-green-300":"bg-gray-100 text-gray-600 border-2 border-gray-300 hover:bg-green-50"}`,title:"נוכח",children:e.jsx(D,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>P(t._id,r==="absent"?"unmarked":"absent"),className:`p-2 rounded-lg transition-colors ${r==="absent"?"bg-red-100 text-red-600 border-2 border-red-300":"bg-gray-100 text-gray-600 border-2 border-gray-300 hover:bg-red-50"}`,title:"נעדר",children:e.jsx(w,{className:"w-4 h-4"})})]})]},t._id)})}),U&&e.jsx("div",{className:"mt-6 pt-4 border-t border-gray-200",children:e.jsx("button",{onClick:me,disabled:I,className:"w-full flex items-center justify-center px-4 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:I?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white ml-2"}),"שומר..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ie,{className:"w-4 h-4 ml-2"}),"שמור נוכחות"]})})})]})})}),Y&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsx("div",{className:"bg-white rounded-lg max-w-md w-full",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"עדכון חזרות"}),e.jsx("button",{onClick:L,className:"text-gray-400 hover:text-gray-600",children:e.jsx(w,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center mb-4",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("svg",{className:"w-12 h-12 text-blue-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})}),e.jsxs("div",{className:"mr-4",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900",children:"איך ברצונך לעדכן?"}),e.jsx("p",{className:"text-gray-600",children:"בחר את היקף העדכון לחזרות התזמורת"})]})]}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("svg",{className:"w-5 h-5 text-blue-600 ml-2",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z",clipRule:"evenodd"})}),e.jsxs("div",{className:"text-sm text-blue-800",children:[e.jsx("strong",{children:"תזמורת:"})," ",s?.orchestra?.name,e.jsx("br",{}),e.jsx("strong",{children:"שינויים:"}),n?.location&&` מיקום: ${n.location}`,n?.startTime&&` | זמן התחלה: ${n.startTime}`,n?.endTime&&` | זמן סיום: ${n.endTime}`,n?.notes!==void 0&&" | הערות עודכנו",n?.isActive!==void 0&&" | סטטוס עודכן"]})]})})]}),_&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(O,{className:"w-4 h-4 text-red-600 ml-2"}),e.jsx("span",{className:"text-red-800 text-sm",children:_})]})}),e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsx("button",{onClick:te,disabled:h,className:"w-full flex items-center justify-center px-4 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:h?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white ml-2"}),"מעדכן..."]}):e.jsxs(e.Fragment,{children:[e.jsx(H,{className:"w-5 h-5 ml-2"}),"עדכון חזרה זו בלבד"]})}),e.jsx("button",{onClick:ae,disabled:h,className:"w-full flex items-center justify-center px-4 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:h?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white ml-2"}),"מעדכן כל החזרות..."]}):e.jsxs(e.Fragment,{children:[e.jsx(z,{className:"w-5 h-5 ml-2"}),"עדכון כל החזרות של התזמורת"]})}),e.jsx("button",{onClick:L,disabled:h,className:"w-full flex items-center justify-center px-4 py-3 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:"ביטול"})]})]})})}),W&&e.jsx(fe,{orchestras:X,existingRehearsals:[],onSubmit:se,onCancel:()=>S(!1),initialData:{groupId:s.groupId,type:s.type,date:s.date.split("T")[0],startTime:s.startTime,endTime:s.endTime,location:s.location,notes:s.notes,isActive:s.isActive}}),e.jsx(ke,{isOpen:ee,title:"מחיקת חזרה",message:"האם אתה בטוח שברצונך למחוק את החזרה? פעולה זו אינה ניתנת לביטול ותמחק את כל הנתונים הקשורים לחזרה כולל נוכחות שנרשמה.",confirmText:"מחק לצמיתות",cancelText:"ביטול",onConfirm:le,onCancel:ne,variant:"danger"})]})}export{Oe as default};
