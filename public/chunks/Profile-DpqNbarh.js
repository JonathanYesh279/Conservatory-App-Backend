import{j as e,u as Ie,V as He,n as Ne}from"../assets/index-DVeVEBC0.js";import{R as xt,r,u as ht,b as ft}from"./vendor-B2j9q2e_.js";import{a as H,t as Ye}from"./cascade-deletion-DAN0Gkem.js";import{M as Ce,I as Xe,O as We,T as ze,U as De,e as ke,Z as tt,b as fe,d as pe,s as Oe,r as st,c as qe,A as $e,X as ve,an as pt,D as at,ac as nt,S as rt,u as Ue,q as be,m as Te,f as ye,P as Me,ab as it,i as _e,B as Pe,g as yt,G as Ze,W as Je,ao as bt,j as jt,a6 as Ve,aa as Ee,Y as Nt,ah as vt,a3 as wt,K as St}from"./ui-ypR0-hKN.js";import{C as Tt}from"./ConfirmationModal-BUz2XPR3.js";import{t as et}from"./theoryEnrollmentService-Bgf_GhXN.js";import"./query-BI61muSV.js";import"./utils-x1PSU_OZ.js";function Ct({student:t,onEdit:b,onDelete:N,onViewDetails:v,onScheduleLesson:y,onUpdateLesson:l,onMarkAttendance:a,onAddNote:n,className:C=""}){const w=t.academicInfo?.instrumentProgress?.find(p=>p.isPrimary)||t.academicInfo?.instrumentProgress?.[0],E=w?.instrumentName||"לא הוגדר",u=w?.currentStage||0,L=t.scheduleInfo||t.teacherAssignments?.[0],q=L?`${L.day} ${L.startTime||L.time}`:null,i=L?.duration||60,x=!!L,A=t.academicInfo?.isActive!==!1&&t.status!=="inactive",g=A?"text-green-800 bg-green-100":"text-red-800 bg-red-100",d=A?"פעיל":"לא פעיל",j=A?qe:$e,O=x?"border-2 border-green-400 shadow-sm shadow-green-200":"border border-gray-200";return e.jsxs("div",{className:`bg-white ${O} rounded-lg hover:shadow-lg hover:border-indigo-300 transition-all duration-200 transform hover:-translate-y-1 group ${C}`,children:[e.jsx("div",{className:"px-4 py-3 border-b border-gray-100",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h4",{className:"font-semibold text-gray-900 font-reisinger-yonatan text-lg",children:t.personalInfo.fullName}),e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${g}`,children:[xt.createElement(j,{className:"w-3 h-3"}),d]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(Ce,{className:"w-4 h-4 text-indigo-500"}),e.jsx("span",{className:"font-reisinger-yonatan font-medium",children:E}),u>0&&e.jsxs("span",{className:"text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full font-reisinger-yonatan",children:["שלב ",u]})]})]}),e.jsxs("div",{className:"flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:[e.jsx("button",{onClick:()=>v(t.id),className:"p-1.5 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all duration-200",title:"צפה בפרטים מלאים",children:e.jsx(Xe,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>b(t),className:"p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all duration-200",title:"עריכת תלמיד",children:e.jsx(We,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>N(t.id),className:"p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all duration-200",title:"מחיקת תלמיד",children:e.jsx(ze,{className:"w-4 h-4"})})]})]})}),e.jsxs("div",{className:"px-4 py-3 space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{className:"space-y-1",children:[t.personalInfo.age&&e.jsxs("div",{className:"flex items-center gap-2 text-gray-600",children:[e.jsx(De,{className:"w-3 h-3"}),e.jsxs("span",{className:"font-reisinger-yonatan",children:["גיל: ",t.personalInfo.age]})]}),t.personalInfo.class&&e.jsxs("div",{className:"flex items-center gap-2 text-gray-600",children:[e.jsx(ke,{className:"w-3 h-3"}),e.jsxs("span",{className:"font-reisinger-yonatan",children:["כיתה: ",t.personalInfo.class]})]})]}),e.jsx("div",{className:"space-y-1",children:t.personalInfo.phone&&e.jsxs("div",{className:"flex items-center gap-2 text-gray-600",dir:"ltr",children:[e.jsx(tt,{className:"w-3 h-3"}),e.jsx("span",{className:"font-mono text-xs",children:t.personalInfo.phone})]})})]}),q&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-blue-800 font-reisinger-yonatan",children:[e.jsx(fe,{className:"w-4 h-4"}),e.jsx("span",{className:"font-medium",children:"שיעור קבוע:"})]}),e.jsxs("div",{className:"flex items-center justify-between mt-1",children:[e.jsx("span",{className:"text-sm font-reisinger-yonatan text-blue-700",children:q}),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-blue-600",children:[e.jsx(pe,{className:"w-3 h-3"}),e.jsxs("span",{children:[i," דק'"]})]})]})]})]}),e.jsx("div",{className:"px-4 py-3 border-t border-gray-100 bg-gray-50",children:e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("button",{onClick:()=>v(t.id),className:"text-indigo-600 hover:text-indigo-800 hover:bg-indigo-100 px-3 py-1 rounded-lg text-sm font-medium font-reisinger-yonatan transition-all duration-200 flex items-center gap-1",children:[e.jsx(Xe,{className:"w-4 h-4"}),"פרטים מלאים"]}),x&&l?e.jsxs("button",{onClick:()=>l(t),className:"text-blue-600 hover:text-blue-800 hover:bg-blue-100 px-3 py-1 rounded-lg text-sm font-medium font-reisinger-yonatan transition-all duration-200 flex items-center gap-1",children:[e.jsx(fe,{className:"w-4 h-4"}),"עדכן שיעור קבוע"]}):y&&!x?e.jsxs("button",{onClick:()=>y(t.id),className:"text-green-600 hover:text-green-800 hover:bg-green-100 px-3 py-1 rounded-lg text-sm font-medium font-reisinger-yonatan transition-all duration-200 flex items-center gap-1",children:[e.jsx(fe,{className:"w-4 h-4"}),"תזמן שיעור"]}):null,a&&e.jsxs("button",{onClick:()=>a(t.id),className:"text-blue-600 hover:text-blue-800 hover:bg-blue-100 px-3 py-1 rounded-lg text-sm font-medium font-reisinger-yonatan transition-all duration-200 flex items-center gap-1",children:[e.jsx(Oe,{className:"w-4 h-4"}),"נוכחות"]}),n&&e.jsxs("button",{onClick:()=>n(t.id),className:"text-yellow-600 hover:text-yellow-800 hover:bg-yellow-100 px-3 py-1 rounded-lg text-sm font-medium font-reisinger-yonatan transition-all duration-200 flex items-center gap-1",children:[e.jsx(st,{className:"w-4 h-4"}),"הערה"]})]})})]})}function kt({student:t,teacherId:b,onClose:N,onSave:v}){const[y,l]=r.useState(new Date().toISOString().split("T")[0]),[a,n]=r.useState(null),[C,w]=r.useState(""),[E,u]=r.useState(!1),[L,q]=r.useState(!1),[i,x]=r.useState(!1),[A,g]=r.useState(null),[d,j]=r.useState([]),[O,p]=r.useState(!1),[$,c]=r.useState(!1),I=t.personalInfo?.fullName||t.fullName||`${t.firstName} ${t.lastName}`.trim(),R=t.academicInfo?.instrumentProgress?.find(S=>S.isPrimary)?.instrumentName||"לא צוין",_=t.scheduleInfo;r.useEffect(()=>{Y(y)},[y]),r.useEffect(()=>{O&&d.length===0&&ne()},[O]);const Y=async S=>{u(!0),g(null);try{const J=await H.attendance.getIndividualLessonAttendance({studentId:t.id,teacherId:b,date:S});J?(n(J.status),w(J.notes||"")):(n(null),w(""))}catch(J){console.error("Error loading attendance:",J),n(null),w("")}finally{u(!1)}},ne=async()=>{c(!0);try{const S=await H.attendance.getStudentAttendanceHistory({studentId:t.id,teacherId:b,lessonType:"individual",limit:20});j(S)}catch(S){console.error("Error loading attendance history:",S),j([])}finally{c(!1)}},k=async()=>{if(!a){g("יש לבחור סטטוס נוכחות");return}q(!0),g(null);try{const S={studentId:t.id,teacherId:b,date:y,status:a,notes:C.trim(),lessonType:"individual",duration:_?.duration||45};await H.attendance.saveIndividualLessonAttendance(S),j(J=>{const ae=J.filter(me=>me.date!==y);return[{...S,_id:Date.now().toString(),createdAt:new Date().toISOString()},...ae]}),x(!0),setTimeout(()=>{x(!1),v&&v(),N()},1500)}catch(S){console.error("Error saving attendance:",S),g(S.message||"שגיאה בשמירת הנוכחות")}finally{q(!1)}},W=S=>{switch(S){case"present":return"bg-green-100 border-green-300 text-green-800 hover:bg-green-200";case"absent":return"bg-red-100 border-red-300 text-red-800 hover:bg-red-200"}},V=S=>{switch(S){case"present":return e.jsx(Ue,{className:"w-5 h-5"});case"absent":return e.jsx(ve,{className:"w-5 h-5"})}},F=S=>{switch(S){case"present":return"נוכח";case"absent":return"נעדר"}},K=S=>{const J=new Date(y);J.setDate(J.getDate()+S),l(J.toISOString().split("T")[0])},Z=r.useMemo(()=>{const S=d.length,J=d.filter(oe=>oe.status==="present").length,ae=d.filter(oe=>oe.status==="absent").length,me=S>0?Math.round(J/S*100):0;return{total:S,present:J,absent:ae,attendanceRate:me}},[d]);return i?e.jsxs(e.Fragment,{children:[e.jsx("style",{children:`
          @keyframes scaleIn {
            0% {
              transform: scale(0.7);
              opacity: 0;
            }
            50% {
              transform: scale(1.05);
            }
            100% {
              transform: scale(1);
              opacity: 1;
            }
          }
          @keyframes checkMark {
            0% {
              transform: scale(0) rotate(-45deg);
            }
            50% {
              transform: scale(1.2) rotate(-45deg);
            }
            100% {
              transform: scale(1) rotate(0deg);
            }
          }
          .animate-scale-in {
            animation: scaleIn 0.4s ease-out forwards;
          }
          .animate-check {
            animation: checkMark 0.6s ease-out 0.2s forwards;
          }
        `}),e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl p-8 max-w-md w-full text-center animate-scale-in",children:[e.jsx("div",{className:"mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4 animate-check",children:e.jsx(qe,{className:"h-10 w-10 text-green-600"})}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"הנוכחות נשמרה בהצלחה!"}),e.jsxs("p",{className:"text-gray-600",children:[I," סומן כ",F(a)," ב-",new Date(y).toLocaleDateString("he-IL")]})]})})]}):e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",onClick:N,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto transform transition-all",onClick:S=>S.stopPropagation(),children:[e.jsxs("div",{className:"sticky top-0 bg-white border-b border-gray-200 px-6 py-4 z-10",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("button",{onClick:N,className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors","aria-label":"סגור",children:e.jsx(ve,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex-1 text-center",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900",children:"רישום נוכחות - שיעור אישי"}),e.jsxs("div",{className:"flex items-center justify-center gap-2 mt-1 text-sm text-gray-600",children:[e.jsx(De,{className:"w-4 h-4"}),e.jsx("span",{children:I}),_&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"•"}),e.jsxs("span",{children:[_.day," ",_.startTime]})]})]})]}),e.jsx("button",{onClick:()=>p(!O),className:`p-2 rounded-lg transition-colors ${O?"bg-indigo-100 text-indigo-600":"text-gray-400 hover:text-gray-600 hover:bg-gray-100"}`,"aria-label":"היסטוריה",title:"היסטוריית נוכחות",children:e.jsx(pt,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg p-3 mt-3",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 bg-indigo-600 rounded-full flex items-center justify-center",children:e.jsx(Ce,{className:"w-6 h-6 text-white"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-semibold text-gray-900",children:R}),e.jsx("div",{className:"text-sm text-gray-600",children:t.personalInfo?.class&&`כיתה ${t.personalInfo.class}`})]}),d.length>0&&e.jsxs("div",{className:"text-center px-3 py-1 bg-white rounded-lg border border-indigo-200",children:[e.jsxs("div",{className:"text-2xl font-bold text-indigo-600",children:[Z.attendanceRate,"%"]}),e.jsx("div",{className:"text-xs text-gray-600",children:"נוכחות"})]})]})})]}),e.jsx("div",{className:"p-6",children:O?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-900",children:"היסטוריית נוכחות"}),e.jsx("button",{onClick:()=>p(!1),className:"text-sm text-indigo-600 hover:text-indigo-700 font-medium",children:"חזור לרישום"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3 mb-6",children:[e.jsxs("div",{className:"bg-blue-50 rounded-lg p-3 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:Z.total}),e.jsx("div",{className:"text-xs text-gray-600",children:"סה״כ"})]}),e.jsxs("div",{className:"bg-green-50 rounded-lg p-3 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:Z.present}),e.jsx("div",{className:"text-xs text-gray-600",children:"נוכח"})]}),e.jsxs("div",{className:"bg-red-50 rounded-lg p-3 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:Z.absent}),e.jsx("div",{className:"text-xs text-gray-600",children:"נעדר"})]})]}),$?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-3"}),e.jsx("div",{className:"text-gray-600",children:"טוען היסטוריה..."})]}):d.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(st,{className:"w-12 h-12 text-gray-400 mx-auto mb-3"}),e.jsx("h4",{className:"text-gray-900 font-medium mb-2",children:"אין היסטוריית נוכחות"}),e.jsx("p",{className:"text-gray-600 text-sm",children:"התחל לרשום נוכחות כדי לראות היסטוריה"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:d.map(S=>e.jsxs("div",{className:"flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center ${S.status==="present"?"bg-green-100":S.status==="absent"?"bg-red-100":S.status==="excused"?"bg-yellow-100":"bg-orange-100"}`,children:V(S.status)}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:new Date(S.date).toLocaleDateString("he-IL",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}),S.notes&&e.jsx("div",{className:"text-sm text-gray-600 mt-1",children:S.notes})]})]}),e.jsx("div",{className:`px-3 py-1 rounded-full text-sm font-medium ${S.status==="present"?"bg-green-100 text-green-800":S.status==="absent"?"bg-red-100 text-red-800":S.status==="excused"?"bg-yellow-100 text-yellow-800":"bg-orange-100 text-orange-800"}`,children:F(S.status)})]},S._id))})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"תאריך השיעור"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>K(-7),className:"p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors",title:"שבוע קודם",children:e.jsx(at,{className:"w-5 h-5"})}),e.jsx("input",{type:"date",value:y,onChange:S=>l(S.target.value),max:new Date().toISOString().split("T")[0],className:"flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-center font-medium"}),e.jsx("button",{onClick:()=>K(7),disabled:y>=new Date().toISOString().split("T")[0],className:"p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",title:"שבוע הבא",children:e.jsx(nt,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"text-center mt-2 text-sm text-gray-600",children:new Date(y).toLocaleDateString("he-IL",{weekday:"long",year:"numeric",month:"long",day:"numeric"})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"סטטוס נוכחות *"}),e.jsx("div",{className:"grid grid-cols-2 gap-4",children:["present","absent"].map(S=>e.jsxs("button",{onClick:()=>n(S),className:`flex items-center justify-center gap-3 p-5 rounded-xl border-2 transition-all transform ${a===S?W(S)+" scale-105 shadow-lg ring-2 ring-offset-2 "+(S==="present"?"ring-green-500":"ring-red-500"):"bg-white border-gray-200 hover:border-gray-300 hover:shadow-md"}`,children:[V(S),e.jsx("span",{className:"font-semibold text-lg",children:F(S)})]},S))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"הערות (אופציונלי)"}),e.jsx("textarea",{value:C,onChange:S=>w(S.target.value),placeholder:"הוסף הערות על השיעור, ההתקדמות או נושאים לתרגול...",rows:3,className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none"})]}),A&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 flex items-start gap-3",children:[e.jsx($e,{className:"w-5 h-5 text-red-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-red-900",children:"שגיאה"}),e.jsx("div",{className:"text-red-700 text-sm",children:A})]})]}),e.jsxs("div",{className:"flex gap-3 pt-4 border-t border-gray-200",children:[e.jsx("button",{onClick:k,disabled:!a||L||E,className:`flex-1 flex items-center justify-center gap-2 px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold transition-all ${!a||L||E?"opacity-50 cursor-not-allowed":"hover:bg-indigo-700 hover:shadow-lg transform hover:scale-105"}`,children:L?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}),e.jsx("span",{children:"שומר..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(rt,{className:"w-5 h-5"}),e.jsx("span",{children:"שמור נוכחות"})]})}),e.jsx("button",{onClick:N,disabled:L,className:"px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:"ביטול"})]})]})})]})})}const It=[30,45,60];function Lt({action:t}={}){const{user:b}=Ie(),[N,v]=r.useState([]),[y,l]=r.useState(!0),[a,n]=r.useState("");r.useState(!1),r.useState(null);const[C,w]=r.useState(null),[E,u]=r.useState(0);r.useState(!1);const[L,q]=r.useState({status:"all",instrument:"all",hasSchedule:"all",bagrutStatus:"all"});r.useState("cards"),r.useState(new Set),r.useState(!1);const[i,x]=r.useState(!1),[A,g]=r.useState([]),[d,j]=r.useState(!1),[O,p]=r.useState(!1),[$,c]=r.useState(!1),[I,R]=r.useState(null),[_,Y]=r.useState([]),[ne,k]=r.useState(!1),[W,V]=r.useState(null);r.useEffect(()=>{F()},[b]),r.useEffect(()=>{t==="addStudent"&&!y&&(x(!0),K())},[t,y]);const F=async(h=!0)=>{if(b?._id)try{h&&l(!0),w(null);const B=b._id,D=await H.teachers.getTeacher(B);if(!D)throw new Error("לא נמצא פרופיל מורה");const M=D?.teaching?.studentIds||[];try{const f=await H.teacherSchedule.getTimeBlocks(B);let Q=[];Array.isArray(f)?Q=f:f?.data&&Array.isArray(f.data)&&(Q=f.data),Y(Q.filter(z=>z._id&&z._id!=="undefined"))}catch(f){console.warn("Failed to load teaching days:",f),Y([])}if(M.length===0){console.log("No students assigned to teacher"),v([]),u(0);return}const U=await H.students.getBatchStudents(M);if(!Array.isArray(U))throw new Error("תגובה לא תקינה מהשרת");const te=U.filter(f=>M.includes(f._id)||M.includes(f.id));te.length!==U.length&&console.warn(`🔧 Component-level filtering: ${te.length}/${U.length} students match teacher's student IDs`);const s=te.map(f=>{const Q=f.personalInfo?.fullName||"",z=Q.split(" ");return{id:f._id,firstName:f.personalInfo?.firstName||z[0]||"",lastName:f.personalInfo?.lastName||z.slice(1).join(" ")||"",fullName:Q,email:f.personalInfo?.email||f.contactInfo?.email||"",phone:f.personalInfo?.phone||f.contactInfo?.phone||"",instrument:f.academicInfo?.primaryInstrument||f.primaryInstrument||"",grade:f.academicInfo?.gradeLevel||"",status:f.academicInfo?.isActive!==!1?"active":"inactive",joinDate:f.createdAt,personalInfo:{fullName:Q,phone:f.personalInfo?.phone||f.contactInfo?.phone,age:f.personalInfo?.age,class:f.personalInfo?.class||f.academicInfo?.class},academicInfo:{instrumentProgress:f.academicInfo?.instrumentProgress||[],isActive:f.academicInfo?.isActive!==!1},teacherAssignments:f.teacherAssignments||[],scheduleInfo:f.scheduleInfo}});v(s),u(0)}catch(B){console.error("Error loading teacher students:",B),w("שגיאה בטעינת רשימת התלמידים. בדוק את החיבור לאינטרנט ונסה שוב."),u(D=>D+1)}finally{h&&l(!1)}},K=async()=>{try{j(!0);const h=await H.students.getStudents();if(!h||!Array.isArray(h)){console.error("Invalid response from getStudents"),g([]);return}const B=b?._id,M=(await H.teachers.getTeacher(B))?.teaching?.studentIds||[],U=h.filter(te=>!M.includes(te._id)&&!M.includes(te.id));g(U)}catch(h){console.error("Error loading all students:",h),g([])}finally{j(!1)}},Z=N.filter(h=>{const B=a===""||`${h.firstName} ${h.lastName}`.toLowerCase().includes(a.toLowerCase())||h.instrument?.toLowerCase().includes(a.toLowerCase())||h.email?.toLowerCase().includes(a.toLowerCase()),D=L.status==="all"||h.status===L.status,M=L.instrument==="all"||h.instrument===L.instrument,U=h.scheduleInfo||h.teacherAssignments?.length>0,te=L.hasSchedule==="all"||L.hasSchedule==="yes"&&U||L.hasSchedule==="no"&&!U,s=h.academicInfo?.isBagrutStudent||h.academicInfo?.instrumentProgress?.some(Q=>Q.currentStage>=4),f=L.bagrutStatus==="all"||L.bagrutStatus==="yes"&&s||L.bagrutStatus==="no"&&!s;return B&&D&&M&&te&&f}),S=async h=>{const B=N.find(M=>M.id===h),D=B?.personalInfo?.fullName||B?.fullName||"התלמיד";if(window.confirm(`האם אתה בטוח שברצונך למחוק את ${D}?

פעולה זו תמחק את כל הנתונים הקשורים לתלמיד ולא ניתנת לביטול.`))try{await H.students.deleteStudent(h),v(U=>U.filter(te=>te.id!==h));const M=document.createElement("div");M.className="fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg z-50",M.innerHTML=`<div class="flex items-center gap-2 font-reisinger-yonatan"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>${D} נמחק בהצלחה</div>`,document.body.appendChild(M),setTimeout(()=>M.remove(),3e3)}catch(M){console.error("Error deleting student:",M);const U=document.createElement("div");U.className="fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg z-50",U.innerHTML=`<div class="flex items-center gap-2 font-reisinger-yonatan"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>שגיאה במחיקת ${D}</div>`,document.body.appendChild(U),setTimeout(()=>U.remove(),5e3)}},J=h=>{window.location.href=`/students/${h}`},ae=h=>{const B=N.find(D=>D.id===h);B&&(R(B),p(!0))},me=h=>{R(h),c(!0)},oe=h=>{const B=N.find(D=>D.id===h);B&&(V(B),k(!0))},ge=h=>{const B=N.find(D=>D.id===h);if(B){const D=prompt(`הוסף הערה עבור ${B.personalInfo?.fullName}:`);D&&D.trim()&&de(`הערה נוספה עבור ${B.personalInfo?.fullName}`,"success")}},de=(h,B)=>{const D=document.createElement("div");D.className=`fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 ${B==="success"?"bg-green-500 text-white":B==="error"?"bg-red-500 text-white":"bg-blue-500 text-white"}`,D.innerHTML=`<div class="flex items-center gap-2 font-reisinger-yonatan">
      ${B==="success"?"✅":B==="error"?"❌":"ℹ️"} ${h}
    </div>`,document.body.appendChild(D),setTimeout(()=>D.remove(),3e3)},o=async(h,B)=>{try{const D=b?._id,M=await H.students.getStudent(h._id),U=(M.teacherAssignments||[]).findIndex(f=>f.teacherId===D),te={teacherId:D,day:B.lessonDay,time:B.lessonTime,duration:B.lessonDuration||45,location:B.lessonLocation||"",isActive:!0};let s;U>=0?(s=[...M.teacherAssignments||[]],s[U]={...s[U],...te}):s=[...M.teacherAssignments||[],te],await H.students.updateStudent(h._id,{teacherAssignments:s}),await F(),de(`${h.personalInfo?.fullName} הוקצה בהצלחה`,"success"),x(!1)}catch(D){console.error("Error assigning student:",D),de("שגיאה בהקצאת התלמיד","error")}};return y?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600",children:"טוען רשימת תלמידים..."})]})}):C?e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-red-100 flex items-center justify-center",children:e.jsx("svg",{className:"w-4 h-4 text-red-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.728-.833-2.498 0L4.316 15.5c-.77.833.192 2.5 1.732 2.5z"})})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-red-800 font-semibold font-reisinger-yonatan",children:"שגיאה בטעינת הנתונים"}),e.jsx("p",{className:"text-red-700 text-sm font-reisinger-yonatan mt-1",children:C})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>F(),className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm font-reisinger-yonatan",children:"נסה שוב"}),E>2&&e.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm font-reisinger-yonatan",children:"רענן דף"})]})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:"התלמידים שלי"}),e.jsxs("p",{className:"text-gray-600 mt-1",children:[N.length," תלמידים רשומים"]})]}),e.jsxs("button",{onClick:()=>{x(!0),K()},className:"flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors",children:[e.jsx(be,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"הוסף תלמיד"})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Te,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"חיפוש תלמידים...",value:a,onChange:h=>n(h.target.value),className:"w-full pl-4 pr-12 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"rtl"})]}),Z.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(be,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2 font-reisinger-yonatan",children:a?"לא נמצאו תלמידים":"אין תלמידים רשומים"}),e.jsx("p",{className:"text-gray-600 font-reisinger-yonatan",children:a?"נסה מילות חיפוש אחרות":"התחל בהוספת התלמיד הראשון שלך"}),!a&&e.jsxs("button",{onClick:()=>{x(!0),K()},className:"mt-4 inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-reisinger-yonatan",children:[e.jsx(be,{className:"w-4 h-4"}),"הוסף תלמיד ראשון"]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(be,{className:"w-5 h-5 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-900 font-reisinger-yonatan",children:"סה״כ תלמידים"})]}),e.jsx("div",{className:"text-2xl font-bold text-blue-900 mt-1",children:N.length})]}),e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Xe,{className:"w-5 h-5 text-green-600"}),e.jsx("span",{className:"font-medium text-green-900 font-reisinger-yonatan",children:"פעילים"})]}),e.jsx("div",{className:"text-2xl font-bold text-green-900 mt-1",children:N.filter(h=>h.status==="active").length})]}),e.jsxs("div",{className:"bg-purple-50 border border-purple-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(fe,{className:"w-5 h-5 text-purple-600"}),e.jsx("span",{className:"font-medium text-purple-900 font-reisinger-yonatan",children:"עם שיעורים"})]}),e.jsx("div",{className:"text-2xl font-bold text-purple-900 mt-1",children:N.filter(h=>h.scheduleInfo||h.teacherAssignments?.length>0).length})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6",children:Z.map(h=>e.jsx(Ct,{student:h,onEdit:B=>{alert("עריכת תלמיד זמינה רק למנהלים")},onDelete:S,onViewDetails:J,onScheduleLesson:ae,onUpdateLesson:me,onMarkAttendance:oe,onAddNote:ge},h.id))})]}),i&&e.jsx(Dt,{allStudents:A,loading:d,onClose:()=>{x(!1),g([])},onSubmit:o}),O&&I&&e.jsx(Mt,{student:I,teacherId:b?._id||"",teachingDays:_,onClose:()=>{p(!1),R(null)},onSave:()=>{p(!1),R(null),F(!1)},showNotification:de}),$&&I&&e.jsx($t,{student:I,teacherId:b?._id||"",teachingDays:_,onClose:()=>{c(!1),R(null)},onSave:()=>{c(!1),R(null),F(!1)},showNotification:de}),ne&&W&&e.jsx(kt,{student:W,teacherId:b?._id||"",onClose:()=>{k(!1),V(null)},onSave:()=>{F(!1)}})]})}function Dt({allStudents:t,loading:b,onClose:N,onSubmit:v}){const{user:y}=Ie(),[l,a]=r.useState(""),[n,C]=r.useState(null),[w,E]=r.useState({lessonDay:"",lessonTime:"",lessonDuration:45,lessonLocation:"",instrument:""}),[u,L]=r.useState(!1),[q,i]=r.useState([]),[x,A]=r.useState(!1),[g,d]=r.useState(null),j=t.filter(c=>{const I=l.toLowerCase().trim();if(!I)return!0;const R=c.personalInfo?.fullName||`${c.personalInfo?.firstName||""} ${c.personalInfo?.lastName||""}`.trim(),_=c.personalInfo?.class||c.academicInfo?.class||"",Y=[c.academicInfo?.primaryInstrument,...c.academicInfo?.instrumentProgress?.map(W=>W.instrumentName)||[]].filter(Boolean).join(" "),ne=`${R} ${_} ${Y}`.toLowerCase();return I.split(/\s+/).filter(W=>W.length>0).every(W=>ne.includes(W))});r.useEffect(()=>{n&&y?._id&&O()},[n,y?._id]);const O=async()=>{if(y?._id){A(!0);try{const c=await H.teachers.getTeacher(y._id);console.log("Teacher data for slots:",c);const I=c.teaching?.timeBlocks?.filter(_=>_.isActive!==!1)||[];console.log("Time blocks found:",I);const R=[];I.forEach(_=>{const Y=_.startTime,ne=_.endTime,k=_.day,[W,V]=Y.split(":").map(Number),[F,K]=ne.split(":").map(Number),Z=W*60+V,J=F*60+K-Z;It.forEach(ae=>{const me=Math.floor(J/ae);for(let oe=0;oe<me;oe++){const ge=Z+oe*ae,de=ge+ae,o=Math.floor(ge/60),h=ge%60,B=Math.floor(de/60),D=de%60,M=`${o.toString().padStart(2,"0")}:${h.toString().padStart(2,"0")}`,U=`${B.toString().padStart(2,"0")}:${D.toString().padStart(2,"0")}`;c.teaching?.schedule?.some(s=>s.day===k&&s.time===M&&s.duration===ae)||!1||R.push({_id:`${_._id||_.day}-${ae}-${oe}`,day:k,startTime:M,endTime:U,duration:ae,isAvailable:!0,location:_.location,teacherName:c.personalInfo?.fullName,teacherId:c._id,instrument:c.professionalInfo?.instrument||c.teaching?.instrument})}})}),console.log("Generated available slots:",R),i(R)}catch(c){console.error("Error fetching teacher slots:",c),i([])}finally{A(!1)}}},p=c=>{d(c),E({lessonDay:c.day,lessonTime:c.startTime,lessonDuration:c.duration,lessonLocation:c.location||"",instrument:c.instrument||""})},$=async c=>{if(c.preventDefault(),!n){alert("אנא בחר תלמיד");return}if(!g){alert("אנא בחר זמן שיעור");return}L(!0);try{await v(n,w)}catch(I){console.error("Error submitting assignment:",I)}finally{L(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto flex flex-col",dir:"rtl",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 mb-4 font-reisinger-yonatan",children:"הוסף תלמיד"}),b?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"}),e.jsx("span",{className:"mr-3 text-gray-600",children:"טוען רשימת תלמידים..."})]}):e.jsxs("form",{onSubmit:$,className:"flex flex-col flex-1 overflow-hidden",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:"חפש תלמיד במערכת"}),e.jsxs("div",{className:"relative",children:[e.jsx(Te,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"חפש לפי שם, כיתה או כלי נגינה...",value:l,onChange:c=>a(c.target.value),className:"w-full pl-4 pr-12 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"rtl"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto mb-4 border border-gray-200 rounded-lg",children:j.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:l?"לא נמצאו תלמידים התואמים את החיפוש":"אין תלמידים זמינים להקצאה"}):e.jsx("div",{className:"divide-y divide-gray-200",children:j.map(c=>{const I=c.personalInfo?.fullName||`${c.personalInfo?.firstName||""} ${c.personalInfo?.lastName||""}`.trim(),R=c.personalInfo?.class||c.academicInfo?.class||"",_=c.academicInfo?.primaryInstrument||"",Y=n?._id===c._id;return e.jsx("div",{onClick:()=>C(c),className:`p-3 cursor-pointer transition-colors ${Y?"bg-indigo-50 border-r-4 border-indigo-600":"hover:bg-gray-50"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:I}),e.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:[R&&e.jsxs("span",{children:["כיתה ",R]}),_&&e.jsxs(e.Fragment,{children:[R&&" • ",e.jsx("span",{children:_})]})]})]}),Y&&e.jsx("div",{className:"w-6 h-6 bg-indigo-600 rounded-full flex items-center justify-center",children:e.jsx(Oe,{className:"w-4 h-4 text-white"})})]})},c._id)})})}),n&&e.jsxs("div",{className:"space-y-4 border-t pt-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h4",{className:"font-medium text-gray-900 font-reisinger-yonatan",children:["בחר זמן שיעור עבור ",n.personalInfo?.fullName]}),g&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-green-600 bg-green-50 px-3 py-1 rounded-lg",children:[e.jsx(Oe,{className:"w-4 h-4"}),e.jsxs("span",{children:["נבחר: ",g.day," ",g.startTime]})]})]}),x?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"}),e.jsx("span",{className:"mr-3 text-gray-600",children:"טוען זמנים פנויים..."})]}):q.length>0?e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 mb-3",children:"בחר זמן ומשך שיעור מהאפשרויות הזמינות:"}),(()=>{const c=q.reduce((I,R)=>(I[R.day]||(I[R.day]=[]),I[R.day].push(R),I),{});return Object.entries(c).map(([I,R])=>e.jsxs("div",{className:"mb-4",children:[e.jsxs("h5",{className:"text-sm font-medium text-gray-600 mb-2 flex items-center gap-2",children:[e.jsx(fe,{className:"w-4 h-4"}),"יום ",I]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 pr-1",children:R.sort((_,Y)=>_.startTime.localeCompare(Y.startTime)).map(_=>{const Y=g?._id===_._id;return e.jsx("button",{type:"button",onClick:()=>p(_),className:`p-3 border rounded-lg transition-all text-right ${Y?"border-indigo-600 bg-indigo-50 ring-2 ring-indigo-600":_.duration===30?"border-green-300 bg-green-50 hover:border-green-500 hover:bg-green-100":_.duration===45?"border-blue-300 bg-blue-50 hover:border-blue-500 hover:bg-blue-100":"border-purple-300 bg-purple-50 hover:border-purple-500 hover:bg-purple-100"}`,children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(pe,{className:"w-3 h-3"}),e.jsxs("span",{className:"text-sm font-medium text-gray-900",children:[_.startTime,"-",_.endTime]})]}),e.jsxs("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${_.duration===30?"bg-green-100 text-green-800":_.duration===45?"bg-blue-100 text-blue-800":"bg-purple-100 text-purple-800"}`,children:[_.duration," דק׳"]})]}),_.location&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-gray-500",children:[e.jsx(ke,{className:"w-3 h-3"}),_.location]}),_.instrument&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-gray-600",children:[e.jsx(Ce,{className:"w-3 h-3"}),_.instrument]}),Y&&e.jsx("div",{className:"flex justify-center mt-2",children:e.jsx(Oe,{className:"w-5 h-5 text-indigo-600"})})]})},_._id)})})]},I))})()]}):e.jsxs("div",{className:"text-center py-6 bg-gray-50 rounded-lg",children:[e.jsx(pe,{className:"w-12 h-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-gray-500 text-sm mb-2",children:"אין זמנים פנויים"}),e.jsx("p",{className:"text-xs text-gray-400",children:"ייתכן שכל הזמנים הפנויים כבר תפוסים או שלא הוגדרו זמני הוראה"})]})]}),e.jsxs("div",{className:"flex gap-3 mt-6 pt-4 border-t",children:[e.jsx("button",{type:"submit",disabled:!n||!g||u,className:"flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 font-reisinger-yonatan flex items-center justify-center gap-2",children:u?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"מקצה..."]}):e.jsxs(e.Fragment,{children:[e.jsx(be,{className:"w-4 h-4"}),"הוסף תלמיד"]})}),e.jsxs("button",{type:"button",onClick:N,disabled:u,className:"flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 font-reisinger-yonatan flex items-center justify-center gap-2",children:[e.jsx(ve,{className:"w-4 h-4"}),"ביטול"]})]})]})]})})}function Mt({student:t,teacherId:b,teachingDays:N,onClose:v,onSave:y,showNotification:l}){const[a,n]=r.useState({day:"",startTime:"",endTime:"",duration:45,location:"",notes:""}),[C,w]=r.useState(!1),E=["ראשון","שני","שלישי","רביעי","חמישי","שישי"],u=[30,45,60],L=i=>{if(!a.startTime)return;const[x,A]=a.startTime.split(":").map(Number),g=x*60+A+i,d=Math.floor(g/60),j=g%60;n(O=>({...O,duration:i,endTime:`${String(d).padStart(2,"0")}:${String(j).padStart(2,"0")}`}))},q=async i=>{if(i.preventDefault(),!a.day||!a.startTime||!a.endTime){l("יש למלא את כל השדות הנדרשים","error");return}try{w(!0);const x={day:a.day,startTime:a.startTime,endTime:a.endTime,location:a.location||"חדר מוזיקה",duration:a.duration,notes:a.notes,studentId:t.id,studentName:t.personalInfo?.fullName||t.fullName,teacherId:b,recurring:{isRecurring:!0,excludeDates:[]}};await H.teacherSchedule.createTimeBlock(b,x),l("השיעור הקבוע נוצר בהצלחה","success"),y()}catch(x){console.error("Error creating lesson:",x),l(x.message||"שגיאה ביצירת השיעור","error")}finally{w(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-md mx-4",dir:"rtl",children:[e.jsxs("h3",{className:"text-xl font-bold text-gray-900 mb-4 font-reisinger-yonatan",children:["תזמן שיעור קבוע - ",t.personalInfo?.fullName||t.fullName]}),e.jsxs("form",{onSubmit:q,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:"יום"}),e.jsxs("select",{value:a.day,onChange:i=>n(x=>({...x,day:i.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-reisinger-yonatan",required:!0,children:[e.jsx("option",{value:"",children:"בחר יום"}),E.map(i=>e.jsx("option",{value:i,children:i},i))]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:"שעת התחלה"}),e.jsx("input",{type:"time",value:a.startTime,onChange:i=>{n(x=>({...x,startTime:i.target.value})),a.duration&&L(a.duration)},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:"משך (דקות)"}),e.jsx("select",{value:a.duration,onChange:i=>L(Number(i.target.value)),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-reisinger-yonatan",children:u.map(i=>e.jsxs("option",{value:i,children:[i," דק'"]},i))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:"מיקום"}),e.jsxs("select",{value:a.location,onChange:i=>n(x=>({...x,location:i.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-reisinger-yonatan",children:[e.jsx("option",{value:"",children:"בחר מיקום"}),He.map(i=>e.jsx("option",{value:i,children:i},i))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:"הערות"}),e.jsx("textarea",{value:a.notes,onChange:i=>n(x=>({...x,notes:i.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-reisinger-yonatan",rows:3,placeholder:"הערות נוספות..."})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{type:"submit",disabled:C,className:"flex-1 bg-indigo-600 text-white py-2.5 px-4 rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 font-reisinger-yonatan font-medium",children:C?"שומר...":"שמור"}),e.jsx("button",{type:"button",onClick:v,disabled:C,className:"flex-1 bg-gray-200 text-gray-700 py-2.5 px-4 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 font-reisinger-yonatan font-medium",children:"ביטול"})]})]})]})})}function $t({student:t,teacherId:b,teachingDays:N,onClose:v,onSave:y,showNotification:l}){const a=t.scheduleInfo||t.teacherAssignments?.[0],[n,C]=r.useState({day:a?.day||"",startTime:a?.startTime||a?.time||"",duration:a?.duration||45,endTime:a?.endTime||"",location:"",notes:""}),[w,E]=r.useState(!1),[u,L]=r.useState(null),q=["ראשון","שני","שלישי","רביעי","חמישי","שישי"],i=[30,45,60];r.useEffect(()=>{x()},[]);const x=async()=>{try{const d=await H.teacherSchedule.getTimeBlocks(b);let j=[];Array.isArray(d)?j=d:d?.data&&Array.isArray(d.data)&&(j=d.data);const O=j.find(p=>p.studentId===t.id);O&&(L(O._id),C({day:O.day,startTime:O.startTime,endTime:O.endTime,duration:O.duration||45,location:O.location||"",notes:O.notes||""}))}catch(d){console.error("Error loading time block:",d)}},A=d=>{if(!n.startTime)return;const[j,O]=n.startTime.split(":").map(Number),p=j*60+O+d,$=Math.floor(p/60),c=p%60;C(I=>({...I,duration:d,endTime:`${String($).padStart(2,"0")}:${String(c).padStart(2,"0")}`}))},g=async d=>{if(d.preventDefault(),!u){l("לא נמצא שיעור קבוע לעדכון","error");return}if(!n.day||!n.startTime||!n.endTime){l("יש למלא את כל השדות הנדרשים","error");return}try{E(!0);const j={day:n.day,startTime:n.startTime,endTime:n.endTime,location:n.location||"חדר מוזיקה",duration:n.duration,notes:n.notes};await H.teacherSchedule.updateTimeBlock(b,u,j),l("השיעור הקבוע עודכן בהצלחה","success"),y()}catch(j){console.error("Error updating lesson:",j),l(j.message||"שגיאה בעדכון השיעור","error")}finally{E(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-md mx-4",dir:"rtl",children:[e.jsxs("h3",{className:"text-xl font-bold text-gray-900 mb-4 font-reisinger-yonatan",children:["עדכן שיעור קבוע - ",t.personalInfo?.fullName||t.fullName]}),e.jsxs("form",{onSubmit:g,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:"יום"}),e.jsxs("select",{value:n.day,onChange:d=>C(j=>({...j,day:d.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-reisinger-yonatan",required:!0,children:[e.jsx("option",{value:"",children:"בחר יום"}),q.map(d=>e.jsx("option",{value:d,children:d},d))]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:"שעת התחלה"}),e.jsx("input",{type:"time",value:n.startTime,onChange:d=>{C(j=>({...j,startTime:d.target.value})),n.duration&&A(n.duration)},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:"משך (דקות)"}),e.jsx("select",{value:n.duration,onChange:d=>A(Number(d.target.value)),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-reisinger-yonatan",children:i.map(d=>e.jsxs("option",{value:d,children:[d," דק'"]},d))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:"מיקום"}),e.jsxs("select",{value:n.location,onChange:d=>C(j=>({...j,location:d.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-reisinger-yonatan",children:[e.jsx("option",{value:"",children:"בחר מיקום"}),He.map(d=>e.jsx("option",{value:d,children:d},d))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:"הערות"}),e.jsx("textarea",{value:n.notes,onChange:d=>C(j=>({...j,notes:d.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-reisinger-yonatan",rows:3,placeholder:"הערות נוספות..."})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{type:"submit",disabled:w,className:"flex-1 bg-indigo-600 text-white py-2.5 px-4 rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 font-reisinger-yonatan font-medium",children:w?"מעדכן...":"עדכן"}),e.jsx("button",{type:"button",onClick:v,disabled:w,className:"flex-1 bg-gray-200 text-gray-700 py-2.5 px-4 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 font-reisinger-yonatan font-medium",children:"ביטול"})]})]})]})})}function At({isOpen:t,onClose:b,orchestraId:N,orchestraName:v,onSave:y}){const[l,a]=r.useState({date:"",startTime:"19:00",endTime:"21:00",location:"אולם מוזיקה",notes:"",recurring:!1,recurrencePattern:"weekly",endRecurrence:""}),[n,C]=r.useState({}),[w,E]=r.useState(!1);r.useEffect(()=>{if(t){const i=new Date;i.setDate(i.getDate()+1),a(x=>({...x,date:i.toISOString().split("T")[0]}))}},[t]);const u=()=>{const i={};if(!l.date)i.date="יש לבחור תאריך";else{const x=new Date(l.date),A=new Date;A.setHours(0,0,0,0),x<A&&(i.date="לא ניתן לקבוע חזרה בעבר")}if(l.startTime||(i.startTime="יש לבחור שעת התחלה"),l.endTime||(i.endTime="יש לבחור שעת סיום"),l.startTime&&l.endTime){const x=new Date(`2000-01-01T${l.startTime}`);new Date(`2000-01-01T${l.endTime}`)<=x&&(i.endTime="שעת הסיום חייבת להיות אחרי שעת ההתחלה")}return l.location.trim()||(i.location="יש לציין מקום"),l.recurring&&!l.endRecurrence&&(i.endRecurrence="יש לציין תאריך סיום לחזרות קבועות"),C(i),Object.keys(i).length===0},L=async i=>{if(i.preventDefault(),!!u()){E(!0);try{await y(l),b(),a({date:"",startTime:"19:00",endTime:"21:00",location:"אולם מוזיקה",notes:"",recurring:!1,recurrencePattern:"weekly",endRecurrence:""})}catch(x){console.error("Error saving rehearsal:",x)}finally{E(!1)}}},q=()=>{if(!l.startTime||!l.endTime)return"";const i=new Date(`2000-01-01T${l.startTime}`),A=(new Date(`2000-01-01T${l.endTime}`).getTime()-i.getTime())/(1e3*60);if(A<=0)return"";const g=Math.floor(A/60),d=A%60;return g===0?`${d} דקות`:d===0?`${g} שעות`:`${g} שעות ו-${d} דקות`};return t?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900 font-reisinger-yonatan",children:"קביעת חזרה חדשה"}),e.jsx("button",{onClick:b,className:"p-1 text-gray-400 hover:text-gray-600 rounded",children:e.jsx(ve,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center gap-2 text-blue-800",children:[e.jsx(ye,{className:"w-4 h-4"}),e.jsxs("span",{className:"font-medium font-reisinger-yonatan",children:["תזמורת: ",v]})]})}),e.jsxs("form",{onSubmit:L,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"תאריך החזרה *"}),e.jsxs("div",{className:"relative",children:[e.jsx(fe,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"date",required:!0,value:l.date,onChange:i=>a(x=>({...x,date:i.target.value})),className:`w-full pl-3 pr-10 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 ${n.date?"border-red-300":"border-gray-300"}`})]}),n.date&&e.jsx("p",{className:"text-red-600 text-xs mt-1 font-reisinger-yonatan",children:n.date})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שעת התחלה *"}),e.jsxs("div",{className:"relative",children:[e.jsx(pe,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"time",required:!0,value:l.startTime,onChange:i=>a(x=>({...x,startTime:i.target.value})),className:`w-full pl-3 pr-10 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 ${n.startTime?"border-red-300":"border-gray-300"}`})]}),n.startTime&&e.jsx("p",{className:"text-red-600 text-xs mt-1 font-reisinger-yonatan",children:n.startTime})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שעת סיום *"}),e.jsxs("div",{className:"relative",children:[e.jsx(pe,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"time",required:!0,value:l.endTime,onChange:i=>a(x=>({...x,endTime:i.target.value})),className:`w-full pl-3 pr-10 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 ${n.endTime?"border-red-300":"border-gray-300"}`})]}),n.endTime&&e.jsx("p",{className:"text-red-600 text-xs mt-1 font-reisinger-yonatan",children:n.endTime})]})]}),q()&&e.jsxs("div",{className:"text-sm text-gray-600 bg-gray-50 p-2 rounded font-reisinger-yonatan",children:["משך החזרה: ",q()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"מקום החזרה *"}),e.jsxs("div",{className:"relative",children:[e.jsx(ke,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"text",required:!0,value:l.location,onChange:i=>a(x=>({...x,location:i.target.value})),className:`w-full pl-3 pr-10 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 ${n.location?"border-red-300":"border-gray-300"}`,placeholder:"למשל: אולם מוזיקה, חדר 101"})]}),n.location&&e.jsx("p",{className:"text-red-600 text-xs mt-1 font-reisinger-yonatan",children:n.location})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"הערות"}),e.jsx("textarea",{value:l.notes,onChange:i=>a(x=>({...x,notes:i.target.value})),rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",placeholder:"הערות נוספות על החזרה (אופציונלי)"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{id:"recurring",type:"checkbox",checked:l.recurring,onChange:i=>a(x=>({...x,recurring:i.target.checked})),className:"h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"}),e.jsx("label",{htmlFor:"recurring",className:"mr-2 text-sm text-gray-700 font-reisinger-yonatan",children:"חזרה קבועה (חוזרת)"})]}),l.recurring&&e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"תדירות"}),e.jsxs("select",{value:l.recurrencePattern,onChange:i=>a(x=>({...x,recurrencePattern:i.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"weekly",children:"שבועי"}),e.jsx("option",{value:"biweekly",children:"דו-שבועי"}),e.jsx("option",{value:"monthly",children:"חודשי"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"תאריך סיום החזרות הקבועות *"}),e.jsx("input",{type:"date",required:l.recurring,value:l.endRecurrence,onChange:i=>a(x=>({...x,endRecurrence:i.target.value})),className:`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 ${n.endRecurrence?"border-red-300":"border-gray-300"}`}),n.endRecurrence&&e.jsx("p",{className:"text-red-600 text-xs mt-1 font-reisinger-yonatan",children:n.endRecurrence})]}),e.jsxs("div",{className:"text-xs text-amber-600 bg-amber-50 p-2 rounded flex items-start gap-2",children:[e.jsx($e,{className:"w-4 h-4 mt-0.5 flex-shrink-0"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"חזרות קבועות ייווצרו אוטומטית עד התאריך שצוין"})]})]})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{type:"submit",disabled:w,className:"flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 disabled:opacity-50 transition-colors font-reisinger-yonatan",children:w?"קובע חזרה...":"קבע חזרה"}),e.jsx("button",{type:"button",onClick:b,className:"flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors font-reisinger-yonatan",children:"ביטול"})]})]})]})}):null}function Et(){const{user:t}=Ie(),[b,N]=r.useState([]),[v,y]=r.useState(!0),[l,a]=r.useState(""),[n,C]=r.useState(!1),[w,E]=r.useState(null),[u,L]=r.useState(null),[q,i]=r.useState([]),[x,A]=r.useState(null),[g,d]=r.useState("members");r.useState(!1);const[j,O]=r.useState(!1),[p,$]=r.useState([]),[c,I]=r.useState([]),[R,_]=r.useState(""),[Y,ne]=r.useState(""),[k,W]=r.useState(!1),[V,F]=r.useState(null),[K,Z]=r.useState({isOpen:!1,title:"",message:"",onConfirm:()=>{}});r.useEffect(()=>{S()},[t]),r.useEffect(()=>{u&&g==="enrollment"&&ae()},[u,g]);const S=async()=>{if(t?._id)try{y(!0);const s=t._id,f=await H.teachers.getTeacher(s);if(!f)throw new Error("לא נמצא פרופיל מנצח");const Q=f?.conducting?.orchestraIds||[];if(Q.length===0){console.log("No orchestras assigned to conductor"),N([]);return}const z=await H.orchestras.getBatchOrchestras(Q);if(!Array.isArray(z))throw new Error("תגובה לא תקינה מהשרת");const se=z.map(X=>({id:X._id,name:X.name,description:X.description,type:X.type,level:X.level,memberCount:X.memberCount||0,status:X.status||"active",rehearsalDay:X.rehearsalSchedule?.day,rehearsalTime:X.rehearsalSchedule?.time,venue:X.venue}));N(se)}catch(s){console.error("Error loading conductor orchestras:",s),A("שגיאה בטעינת רשימת התזמורות")}finally{y(!1)}},J=async s=>{try{const z=((await H.orchestras.getOrchestra(s)).memberDetails||[]).map(se=>{const X=se.personalInfo?.fullName||"",we=X.trim().split(/\s+/),m=we[0]||"",T=we.slice(1).join(" ")||"",P=se.academicInfo?.instrumentProgress?.find(ie=>ie.isPrimary),re=P?.instrumentName||se.primaryInstrument||"לא צוין",xe=P?.currentStage||0;return{id:se._id,fullName:X,firstName:m,lastName:T,instrument:re,currentStage:xe,section:se.section||"כללי",status:se.status||"active",enrollmentDate:se.enrollmentDate||new Date().toISOString(),performanceLevel:se.performanceLevel||"intermediate",attendanceRate:se.attendanceRate||null}});i(z)}catch(f){console.error("Error loading orchestra members:",f)}},ae=async()=>{if(u)try{W(!0),console.log("🔍 Loading available students for orchestra:",u);const s=await H.students.getStudents({status:"active",limit:500});console.log("📋 Raw API response:",s);let f=[];Array.isArray(s)?f=s:s&&Array.isArray(s.data)?f=s.data:s&&s.students&&Array.isArray(s.students)?f=s.students:(console.error("❌ Unexpected response structure:",s),f=[]),console.log("📋 Total active students fetched:",f.length);const z=(await H.orchestras.getOrchestra(u)).memberIds||[];console.log("👥 Current orchestra members:",z.length);const se=f.filter(X=>!z.includes(X._id)&&X.isActive!==!1);console.log("✅ Available students for enrollment:",se.length),$(se)}catch(s){console.error("❌ Error loading available students:",s),$([])}finally{W(!1)}},me=async s=>{try{const Q=(await H.rehearsals.getRehearsals({groupId:s,limit:20})).map(z=>{const se=z.scheduledDate||z.date||z.rehearsalDate;let X="תאריך לא זמין";if(se)try{const we=new Date(se);isNaN(we.getTime())||(X=we.toLocaleDateString("he-IL",{year:"numeric",month:"2-digit",day:"2-digit"}))}catch{console.warn("Failed to parse rehearsal date:",se)}return{id:z._id,date:X,time:z.startTime||"19:00",location:z.location||"אולם מוזיקה",duration:z.duration||120,status:z.status||"scheduled",attendanceCount:z.attendanceList?.length||0,totalMembers:q.length}});I(Q)}catch(f){console.error("Error loading orchestra rehearsals:",f),I([])}},oe=async s=>{if(u)try{await H.orchestras.addMember(u,s),await J(u),await ae(),F({type:"success",message:"התלמיד נוסף בהצלחה לתזמורת"}),setTimeout(()=>F(null),3e3)}catch(f){console.error("Error adding member:",f),F({type:"error",message:"שגיאה בהוספת התלמיד לתזמורת"}),setTimeout(()=>F(null),3e3)}},ge=async s=>{u&&Z({isOpen:!0,title:"הסרת תלמיד מהתזמורת",message:"האם אתה בטוח שברצונך להסיר את התלמיד מהתזמורת?",onConfirm:async()=>{Z({...K,isOpen:!1});try{await H.orchestras.removeMember(u,s),await J(u),await ae(),F({type:"success",message:"התלמיד הוסר בהצלחה מהתזמורת"}),setTimeout(()=>F(null),3e3)}catch(f){console.error("Error removing member:",f),F({type:"error",message:"שגיאה בהסרת התלמיד מהתזמורת"}),setTimeout(()=>F(null),3e3)}}})},de=async s=>{if(u)try{const f={groupId:u,groupType:"orchestra",scheduledDate:new Date(s.date).toISOString(),startTime:s.startTime,endTime:s.endTime,duration:o(s.startTime,s.endTime),location:s.location,notes:s.notes,status:"scheduled"};if(s.recurring){const Q=h(f,s);await Promise.all(Q.map(z=>H.rehearsals.createRehearsal(z))),F({type:"success",message:`${Q.length} חזרות נוצרו בהצלחה`})}else await H.rehearsals.createRehearsal(f),F({type:"success",message:"חזרה נוצרה בהצלחה"});await me(u),O(!1),setTimeout(()=>F(null),3e3)}catch(f){console.error("Error scheduling rehearsal:",f),F({type:"error",message:"שגיאה ביצירת החזרה"}),setTimeout(()=>F(null),3e3)}},o=(s,f)=>{const Q=new Date(`2000-01-01T${s}`),z=new Date(`2000-01-01T${f}`);return Math.round((z.getTime()-Q.getTime())/(1e3*60))},h=(s,f)=>{const Q=[],z=new Date(f.date),se=new Date(f.endRecurrence);let X=new Date(z);for(;X<=se;)switch(Q.push({...s,scheduledDate:new Date(X).toISOString()}),f.recurrencePattern){case"weekly":X.setDate(X.getDate()+7);break;case"biweekly":X.setDate(X.getDate()+14);break;case"monthly":X.setMonth(X.getMonth()+1);break}return Q},B=b.filter(s=>l===""||s.name.toLowerCase().includes(l.toLowerCase())||s.type.toLowerCase().includes(l.toLowerCase())||s.description?.toLowerCase().includes(l.toLowerCase())),D=async s=>{Z({isOpen:!0,title:"מחיקת תזמורת",message:"האם אתה בטוח שברצונך למחוק תזמורת זו? פעולה זו אינה ניתנת לביטול.",onConfirm:async()=>{Z({...K,isOpen:!1});try{await H.orchestras.deleteOrchestra(s),N(f=>f.filter(Q=>Q.id!==s)),u===s&&(L(null),i([])),F({type:"success",message:"התזמורת נמחקה בהצלחה"}),setTimeout(()=>F(null),3e3)}catch(f){console.error("Error deleting orchestra:",f),F({type:"error",message:"שגיאה במחיקת התזמורת"}),setTimeout(()=>F(null),3e3)}}})},M=async s=>{try{if(w){const f={name:s.name,description:s.description,type:s.type,level:s.level,status:s.status,rehearsalSchedule:{day:s.rehearsalDay,time:s.rehearsalTime},venue:s.venue},Q=await H.orchestras.updateOrchestra(w.id,f),z={id:Q._id,name:Q.name,description:Q.description,type:Q.type,level:Q.level,memberCount:Q.memberCount||0,status:Q.status||"active",rehearsalDay:Q.rehearsalSchedule?.day,rehearsalTime:Q.rehearsalSchedule?.time,venue:Q.venue};N(se=>se.map(X=>X.id===w.id?z:X))}else{const f=t?._id,Q={name:s.name,description:s.description,type:s.type,level:s.level,status:s.status,rehearsalSchedule:{day:s.rehearsalDay,time:s.rehearsalTime},venue:s.venue,conductorId:f},z=await H.orchestras.createOrchestra(Q),se={id:z._id,name:z.name,description:z.description,type:z.type,level:z.level,memberCount:z.memberCount||0,status:z.status||"active",rehearsalDay:z.rehearsalSchedule?.day,rehearsalTime:z.rehearsalSchedule?.time,venue:z.venue};N(X=>[...X,se])}C(!1),E(null),F({type:"success",message:w?"התזמורת עודכנה בהצלחה":"התזמורת נוצרה בהצלחה"}),setTimeout(()=>F(null),3e3)}catch(f){console.error("Error saving orchestra:",f),F({type:"error",message:"שגיאה בשמירת פרטי התזמורת"}),setTimeout(()=>F(null),3e3)}},U=s=>{switch(s){case"youth":return"תזמורת נוער";case"adult":return"תזמורת מבוגרים";case"chamber":return"תזמורת קאמרית";case"symphony":return"תזמורת סימפונית";default:return s}},te=s=>{switch(s){case"beginner":return"מתחילים";case"intermediate":return"בינוניים";case"advanced":return"מתקדמים";default:return s}};return v?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600",children:"טוען רשימת תזמורות..."})]})}):x?e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("div",{className:"text-red-800 font-reisinger-yonatan",children:x})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:"תזמורות שאני מנצח"}),e.jsxs("p",{className:"text-gray-600 mt-1",children:[b.length," תזמורות"]})]}),e.jsxs("button",{onClick:()=>C(!0),className:"flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors",children:[e.jsx(Me,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"הוסף תזמורת"})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Te,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"חיפוש תזמורות...",value:l,onChange:s=>a(s.target.value),className:"w-full pl-4 pr-12 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"rtl"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsx("div",{className:"space-y-4",children:B.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Ce,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2 font-reisinger-yonatan",children:l?"לא נמצאו תזמורות":"אין תזמורות רשומות"}),e.jsx("p",{className:"text-gray-600 font-reisinger-yonatan",children:l?"נסה מילות חיפוש אחרות":"התחל בהוספת התזמורת הראשונה שלך"})]}):B.map(s=>e.jsxs("div",{className:`bg-white border border-gray-200 rounded-lg p-4 hover:shadow-lg hover:border-indigo-300 transition-all duration-200 cursor-pointer transform hover:-translate-y-1 group ${u===s.id?"ring-2 ring-indigo-500 bg-indigo-50":""}`,onClick:()=>{L(s.id),J(s.id),me(s.id),d("members")},children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-gray-900 font-reisinger-yonatan",children:s.name}),e.jsxs("p",{className:"text-sm text-gray-600 font-reisinger-yonatan",children:[U(s.type)," • ",te(s.level)]}),s.description&&e.jsx("p",{className:"text-sm text-gray-500 mt-1 font-reisinger-yonatan",children:s.description})]}),e.jsxs("div",{className:"flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:[e.jsx("button",{onClick:f=>{f.stopPropagation(),E(s),C(!0)},className:"p-2 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all duration-200",title:"עריכת תזמורת",children:e.jsx(We,{className:"w-4 h-4"})}),e.jsx("button",{onClick:f=>{f.stopPropagation(),D(s.id)},className:"p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all duration-200",title:"מחיקת תזמורת",children:e.jsx(ze,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ye,{className:"w-4 h-4"}),e.jsxs("span",{children:[s.memberCount||0," חברים"]})]}),s.rehearsalDay&&e.jsxs("span",{children:["חזרות: ",s.rehearsalDay]})]}),e.jsx("span",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${s.status==="active"?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"}`,children:s.status==="active"?"פעיל":"לא פעיל"})]})]},s.id))}),u&&e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"flex gap-1 p-1",children:[e.jsxs("button",{onClick:()=>d("members"),className:`px-4 py-2 text-sm font-medium rounded-md transition-colors ${g==="members"?"bg-indigo-100 text-indigo-700":"text-gray-500 hover:text-gray-700"}`,children:[e.jsx(ye,{className:"w-4 h-4 inline mr-2"}),"חברי התזמורת"]}),e.jsxs("button",{onClick:()=>{d("enrollment"),ae()},className:`px-4 py-2 text-sm font-medium rounded-md transition-colors ${g==="enrollment"?"bg-indigo-100 text-indigo-700":"text-gray-500 hover:text-gray-700"}`,children:[e.jsx(be,{className:"w-4 h-4 inline mr-2"}),"רישום חברים"]}),e.jsxs("button",{onClick:()=>d("rehearsals"),className:`px-4 py-2 text-sm font-medium rounded-md transition-colors ${g==="rehearsals"?"bg-indigo-100 text-indigo-700":"text-gray-500 hover:text-gray-700"}`,children:[e.jsx(fe,{className:"w-4 h-4 inline mr-2"}),"חזרות"]})]})}),e.jsxs("div",{className:"p-4",children:[g==="members"&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"font-semibold text-gray-900 font-reisinger-yonatan",children:["חברי התזמורת (",q.length,")"]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs("div",{className:"relative",children:[e.jsx(Te,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"text",placeholder:"חיפוש חברים...",value:Y,onChange:s=>ne(s.target.value),className:"pl-4 pr-10 py-1.5 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-indigo-500",dir:"rtl"})]})})]}),q.filter(s=>Y===""||`${s.firstName} ${s.lastName}`.toLowerCase().includes(Y.toLowerCase())||s.instrument.toLowerCase().includes(Y.toLowerCase())).length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(ye,{className:"w-12 h-12 text-gray-400 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 font-reisinger-yonatan",children:Y?"לא נמצאו חברים":"אין חברים רשומים בתזמורת"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:q.filter(s=>Y===""||`${s.firstName} ${s.lastName}`.toLowerCase().includes(Y.toLowerCase())||s.instrument.toLowerCase().includes(Y.toLowerCase())).map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors border border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${s.status==="active"?"bg-green-500":"bg-gray-400"}`}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm font-reisinger-yonatan",children:s.fullName||`${s.firstName} ${s.lastName}`.trim()}),e.jsxs("div",{className:"text-xs text-gray-500 font-reisinger-yonatan",children:[s.instrument,s.currentStage?` - שלב ${s.currentStage}`:""]}),s.attendanceRate!==null&&s.attendanceRate!==void 0&&e.jsxs("div",{className:"text-xs text-gray-400 mt-1",children:["נוכחות: ",s.attendanceRate,"%"]})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{onClick:()=>ge(s.id),className:"p-1.5 text-red-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors",title:"הסר מהתזמורת",children:e.jsx(it,{className:"w-4 h-4"})})})]},s.id))})]}),g==="enrollment"&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"font-semibold text-gray-900 font-reisinger-yonatan",children:["רישום חברים ",!k&&`(${p.length} זמינים)`]}),e.jsxs("div",{className:"relative",children:[e.jsx(Te,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"text",placeholder:"חיפוש תלמידים...",value:R,onChange:s=>_(s.target.value),className:"pl-4 pr-10 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500",dir:"rtl",disabled:k})]})]}),k?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500 font-reisinger-yonatan",children:"טוען רשימת תלמידים..."})]}):p.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(be,{className:"w-12 h-12 text-gray-400 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 font-reisinger-yonatan",children:"כל התלמידים כבר רשומים לתזמורת"})]}):e.jsx("div",{children:p.filter(s=>R===""||s.personalInfo?.fullName?.toLowerCase().includes(R.toLowerCase())||s.academicInfo?.primaryInstrument?.toLowerCase().includes(R.toLowerCase())).length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(be,{className:"w-12 h-12 text-gray-400 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 font-reisinger-yonatan",children:"לא נמצאו תלמידים תואמים"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:p.filter(s=>R===""||s.personalInfo?.fullName?.toLowerCase().includes(R.toLowerCase())||s.academicInfo?.primaryInstrument?.toLowerCase().includes(R.toLowerCase())).map(s=>{const f=s.academicInfo?.instrumentProgress?.find(se=>se.isPrimary),Q=f?.instrumentName||s.academicInfo?.primaryInstrument||"לא צוין כלי",z=f?.currentStage;return e.jsxs("div",{className:"flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors border border-gray-200",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm font-reisinger-yonatan",children:s.personalInfo?.fullName}),e.jsxs("div",{className:"text-xs text-gray-500 font-reisinger-yonatan",children:[Q,z?` - שלב ${z}`:""]})]}),e.jsxs("button",{onClick:()=>oe(s._id),className:"flex items-center gap-1 px-3 py-1.5 bg-indigo-600 text-white text-sm rounded hover:bg-indigo-700 transition-colors",children:[e.jsx(be,{className:"w-4 h-4"}),"הוסף"]})]},s._id)})})})]}),g==="rehearsals"&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h4",{className:"font-semibold text-gray-900 font-reisinger-yonatan",children:"חזרות התזמורת"}),e.jsxs("button",{onClick:()=>O(!0),className:"flex items-center gap-2 px-3 py-1.5 bg-indigo-600 text-white text-sm rounded hover:bg-indigo-700 transition-colors",children:[e.jsx(Me,{className:"w-4 h-4"}),"קבע חזרה"]})]}),c.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(fe,{className:"w-12 h-12 text-gray-400 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 font-reisinger-yonatan",children:"אין חזרות מתוכננות"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:c.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors border border-gray-200",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-medium text-sm font-reisinger-yonatan",children:[s.date," • ",s.time]}),e.jsxs("div",{className:"text-xs text-gray-500 font-reisinger-yonatan flex items-center gap-2 mt-1",children:[e.jsx(ke,{className:"w-3 h-3"}),s.location,e.jsx(pe,{className:"w-3 h-3 mr-1"}),s.duration," דקות"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-sm font-medium text-gray-900",children:[s.attendanceCount,"/",s.totalMembers]}),e.jsx("div",{className:"text-xs text-gray-500",children:"נוכחות"})]})]},s.id))})]})]})]})]}),n&&e.jsx(_t,{orchestra:w,onClose:()=>{C(!1),E(null)},onSubmit:M}),j&&u&&e.jsx(At,{isOpen:j,onClose:()=>O(!1),orchestraId:u,orchestraName:b.find(s=>s.id===u)?.name||"",onSave:de}),e.jsx(Tt,{isOpen:K.isOpen,title:K.title,message:K.message,onConfirm:K.onConfirm,onCancel:()=>Z({...K,isOpen:!1}),variant:"danger",confirmText:"אישור",cancelText:"ביטול"}),V&&e.jsx("div",{className:"fixed bottom-4 left-1/2 transform -translate-x-1/2 z-50 animate-fade-in",dir:"rtl",children:e.jsxs("div",{className:`flex items-center gap-3 px-6 py-4 rounded-lg shadow-lg ${V.type==="success"?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:[V.type==="success"?e.jsx(qe,{className:"w-5 h-5 text-green-600 flex-shrink-0"}):e.jsx(_e,{className:"w-5 h-5 text-red-600 flex-shrink-0"}),e.jsx("span",{className:`font-medium font-reisinger-yonatan ${V.type==="success"?"text-green-800":"text-red-800"}`,children:V.message})]})})]})}function _t({orchestra:t,onClose:b,onSubmit:N}){const[v,y]=r.useState({name:t?.name||"",description:t?.description||"",type:t?.type||"youth",level:t?.level||"beginner",status:t?.status||"active",rehearsalDay:t?.rehearsalDay||"",rehearsalTime:t?.rehearsalTime||"",venue:t?.venue||""}),l=a=>{a.preventDefault(),N(v)};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto",dir:"rtl",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900 mb-4 font-reisinger-yonatan",children:t?"עריכת תזמורת":"הוספת תזמורת חדשה"}),e.jsxs("form",{onSubmit:l,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שם התזמורת *"}),e.jsx("input",{type:"text",required:!0,value:v.name,onChange:a=>y(n=>({...n,name:a.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"תיאור"}),e.jsx("textarea",{value:v.description,onChange:a=>y(n=>({...n,description:a.target.value})),rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"סוג תזמורת *"}),e.jsxs("select",{required:!0,value:v.type,onChange:a=>y(n=>({...n,type:a.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"youth",children:"תזמורת נוער"}),e.jsx("option",{value:"adult",children:"תזמורת מבוגרים"}),e.jsx("option",{value:"chamber",children:"תזמורת קאמרית"}),e.jsx("option",{value:"symphony",children:"תזמורת סימפונית"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"רמה *"}),e.jsxs("select",{required:!0,value:v.level,onChange:a=>y(n=>({...n,level:a.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"beginner",children:"מתחילים"}),e.jsx("option",{value:"intermediate",children:"בינוניים"}),e.jsx("option",{value:"advanced",children:"מתקדמים"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"יום חזרות"}),e.jsx("input",{type:"text",value:v.rehearsalDay,onChange:a=>y(n=>({...n,rehearsalDay:a.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",placeholder:"כלומר: יום ראשון"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שעת חזרות"}),e.jsx("input",{type:"time",value:v.rehearsalTime,onChange:a=>y(n=>({...n,rehearsalTime:a.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"מקום חזרות"}),e.jsx("input",{type:"text",value:v.venue,onChange:a=>y(n=>({...n,venue:a.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"סטטוס"}),e.jsxs("select",{value:v.status,onChange:a=>y(n=>({...n,status:a.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"active",children:"פעיל"}),e.jsx("option",{value:"inactive",children:"לא פעיל"})]})]}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx("button",{type:"submit",className:"flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors font-reisinger-yonatan",children:t?"עדכן":"הוסף"}),e.jsx("button",{type:"button",onClick:b,className:"flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors font-reisinger-yonatan",children:"ביטול"})]})]})]})})}function Ot(){const{user:t}=Ie(),[b,N]=r.useState(new Date),[v,y]=r.useState(null),[l,a]=r.useState([]),[n,C]=r.useState([]),[w,E]=r.useState(!0),[u,L]=r.useState(null),[q,i]=r.useState(!1),[x,A]=r.useState(null),[g,d]=r.useState(""),[j,O]=r.useState(!1),[p,$]=r.useState(null),[c,I]=r.useState(!1),[R,_]=r.useState(null),[Y,ne]=r.useState(!1),[k,W]=r.useState(null),[V,F]=r.useState(!1),[K,Z]=r.useState("");r.useEffect(()=>{S()},[b,t]);const S=async()=>{if(t?._id)try{E(!0);const m=t._id,T=await H.teacherSchedule.getTimeBlocks(m);console.log("Raw API Response:",T);let P=[];try{if(Array.isArray(T))P=T;else if(T?.data&&Array.isArray(T.data))P=T.data;else if(T?.timeBlocks&&Array.isArray(T.timeBlocks))P=T.timeBlocks;else if(T&&typeof T=="object"){const G=Object.values(T).find(le=>Array.isArray(le));G?P=G:(console.warn("No array found in response, using empty array"),P=[])}else console.warn("Unexpected timeBlocks format:",T),P=[]}catch(G){console.error("Error parsing timeBlocks response:",G),P=[]}console.log("Parsed timeBlocks:",P),console.log("Time block IDs:",P.map(G=>({_id:G._id,day:G.day,time:`${G.startTime}-${G.endTime}`,location:G.location})));const re=P.filter(G=>G._id&&G._id!=="undefined");console.log("Valid timeBlocks after filtering:",re),C(re);const xe=await H.teachers.getTeacher(m);console.log("Teacher profile:",xe);let ie=[];if(xe?.teaching?.studentIds?.length>0)try{ie=await H.students.getBatchStudents(xe.teaching.studentIds),console.log("Students loaded:",ie)}catch(G){console.warn("Failed to load students:",G)}else console.log("No student IDs found in teacher profile");console.log("Creating lesson blocks from student assignments...");const ee=[];ie.forEach(G=>{console.log("Processing student:",G.personalInfo?.fullName),console.log("Student assignments:",G.teacherAssignments),G.teacherAssignments&&G.teacherAssignments.forEach(le=>{if(le.teacherId===m){console.log("Creating lesson from assignment:",le);const Le=le.time||le.startTime,Ge=le.duration||45,Qe=(Ae,dt)=>{const[ct,mt]=Ae.split(":").map(Number),Ke=ct*60+mt+dt,ut=Math.floor(Ke/60),gt=Ke%60;return`${ut.toString().padStart(2,"0")}:${gt.toString().padStart(2,"0")}`},Se=le.endTime||Qe(Le,Ge),lt=n.find(Ae=>Ae.day===le.day)?.location||"",ot={_id:`${G._id}-${le.day}-${le.time}`,day:le.day,startTime:Le,endTime:Se,totalDuration:Ge,studentId:G._id,studentName:G.personalInfo?.fullName,teacherId:m,instrument:G.academicInfo?.instrumentProgress?.find(Ae=>Ae.isPrimary)?.instrumentName,location:le.location||lt,type:"lesson"};console.log(`Creating lesson: Student="${G.personalInfo?.fullName}", Day="${le.day}", Time="${Le}-${Se}"`),ee.push(ot)}})}),console.log("Converted lessons from assignments:",ee);const ue=ee.map(G=>{const le=ie.find(Se=>Se.teacherAssignments?.some(Be=>Be.teacherId===m&&Be.day===G.day&&Be.time===G.startTime)),Le=le?.academicInfo?.instrumentProgress?.find(Se=>Se.isPrimary)||le?.academicInfo?.instrumentProgress?.[0],Qe=n.find(Se=>Se.day===G.day)?.location||"";return{id:G._id||G.id||`${G.day}-${G.startTime}`,day:G.day,startTime:G.startTime,endTime:G.endTime,studentName:le?le.personalInfo?.fullName:G.studentName,studentId:le?._id||G.studentId,instrument:Le?.instrumentName||G.instrument,location:G.location||Qe,notes:G.notes,recurring:G.recurring||{isRecurring:!0,excludeDates:[]},totalDuration:G.totalDuration||ae(G.startTime,G.endTime),studentClass:le?.personalInfo?.class||le?.academicInfo?.class,studentPhone:le?.personalInfo?.phone,studentStage:Le?.currentStage}});a(ue);const he=me(b),je=oe(b),Re=J(he,ue);console.log("Generated calendar days:",Re),console.log("Calendar week range:",{weekStart:he,weekEnd:je}),console.log("Mapped lesson days for calendar:",ue),y({weekStart:he,weekEnd:je,days:Re})}catch(m){console.error("Error loading schedule:",m),L("שגיאה בטעינת לוח הזמנים")}finally{E(!1)}},J=(m,T)=>{const P=[],re=["ראשון","שני","שלישי","רביעי","חמישי","שישי","שבת"],xe=new Map;re.forEach((ee,ce)=>{xe.set(ee,ce)}),console.log("=== GENERATING CALENDAR ==="),console.log("weekStart:",m,"Day:",m.getDay()),console.log("lessons input:",T),console.log("Day name mapping:",Array.from(xe.entries()));const ie=new Map;T.forEach(ee=>{ie.has(ee.day)||ie.set(ee.day,[]),ie.get(ee.day).push(ee)}),console.log("Lessons grouped by day:",Array.from(ie.keys()));for(let ee=0;ee<7;ee++){const ce=new Date(m);ce.setDate(m.getDate()+ee);const ue=re[ee],he=ie.get(ue)||[];console.log(`Day ${ee} (${ue}): found ${he.length} lessons`,he.map(je=>({day:je.day,time:je.startTime,student:je.studentName}))),P.push({date:ce.toISOString().split("T")[0],dayName:ue,lessons:he})}return console.log("Generated calendar days with lessons:",P.map(ee=>({dayName:ee.dayName,lessonCount:ee.lessons.length}))),P},ae=(m,T)=>{const[P,re]=m.split(":").map(Number),[xe,ie]=T.split(":").map(Number);return xe*60+ie-(P*60+re)},me=m=>{const T=new Date(m),P=T.getDay(),re=T.getDate()-P;return T.setDate(re),T.setHours(0,0,0,0),console.log("getWeekStart: input date:",m,"weekStart (Sunday):",T,"day:",T.getDay()),T},oe=m=>{const T=me(m);return T.setDate(T.getDate()+6),T},ge=m=>{const T=new Date(b);T.setDate(b.getDate()+(m==="next"?7:-7)),N(T)},de=m=>m.slice(0,5),o=m=>new Date(m).toLocaleDateString("he-IL",{day:"numeric",month:"short"}),h=()=>{A(null),i(!0)},B=m=>{console.log("handleEditLessonDay called with:",{studentId:m.studentId,studentName:m.studentName,id:m.id,_id:m._id,type:m.type}),m.studentId&&m.studentName?(console.log("Opening EditLessonModal for student lesson"),_(m),I(!0)):(console.log("Opening LessonDayModal for teaching day/availability block"),A(m),i(!0))},D=m=>{console.log("handleEditTeachingDay called with:",{_id:m._id,id:m.id,day:m.day,startTime:m.startTime,hasStudentId:!!m.studentId,fullData:m});const T={id:m._id||m.id,day:m.day,startTime:m.startTime,endTime:m.endTime,location:m.location||"חדר מוזיקה",notes:m.notes||"",recurring:m.recurring||{isRecurring:!0,excludeDates:[]},totalDuration:ae(m.startTime,m.endTime)};console.log("Opening LessonDayModal with lessonDay:",T),A(T),i(!0)},M=async m=>{W({message:"האם אתה בטוח שברצונך למחוק יום לימוד זה? פעולה זו תבטל את הזמינות שלך בזמן זה.",onConfirm:async()=>{try{await H.teacherSchedule.deleteTimeBlock(t?._id,m._id||m.id),U("יום הלימוד נמחק בהצלחה","success"),S()}catch(T){console.error("Error deleting teaching day:",T),U("שגיאה במחיקת יום הלימוד","error")}}}),ne(!0)},U=(m,T)=>{const P=document.createElement("div");P.className=`fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 ${T==="success"?"bg-green-500 text-white":T==="error"?"bg-red-500 text-white":"bg-blue-500 text-white"}`,P.innerHTML=`<div class="flex items-center gap-2 font-reisinger-yonatan">
      ${T==="success"?"✅":T==="error"?"❌":"ℹ️"} ${m}
    </div>`,document.body.appendChild(P),setTimeout(()=>P.remove(),3e3)},te=m=>{Z(m),F(!0)},s=()=>{const m=[];for(let T=7;T<=21;T++)m.push(`${T.toString().padStart(2,"0")}:00`),m.push(`${T.toString().padStart(2,"0")}:30`);return m},f=(m,T)=>{const P=v?.days.find(ie=>ie.date===m),re=ie=>{const[ee,ce]=ie.split(":").map(Number);return ee*60+ce};return P?.lessons.find(ie=>{const ee=re(T),ce=ee+30,ue=re(ie.startTime),he=re(ie.endTime),je=ue>=ee&&ue<ce,Re=ee>=ue&&ee<he;return je||Re})},Q=m=>{const T=ae(m.startTime,m.endTime);return Math.ceil(T/30)*60},z=(m,T)=>{const P=m.startTime,re=T,xe=ue=>{const[he,je]=ue.split(":").map(Number);return he*60+je},ie=xe(P),ee=xe(re),ce=ee+30;return ie>=ee&&ie<ce},se=(m,T)=>{const P=ce=>{const[ue,he]=ce.split(":").map(Number);return ue*60+he},re=P(T),xe=re+30;return n.some(ce=>{if(ce.day!==m)return!1;const ue=P(ce.startTime),he=P(ce.endTime);return re>=ue&&xe<=he})?!l.some(ce=>{if(ce.day!==m)return!1;const ue=P(ce.startTime),he=P(ce.endTime);return re<he&&xe>ue}):!1},X=(m,T,P)=>{se(P,T)&&($({date:m,time:T,dayName:P}),O(!0))};if(l.filter(m=>{if(!g)return!0;const T=g.toLowerCase();return m.studentName?.toLowerCase().includes(T)||m.instrument?.toLowerCase().includes(T)||m.location?.toLowerCase().includes(T)||m.day.toLowerCase().includes(T)}),w)return e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600",children:"טוען לוח זמנים..."})]})});if(u&&!v)return e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("div",{className:"text-red-800 font-reisinger-yonatan",children:u})});const we=s();return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:"לוח זמנים שבועי"}),e.jsx("p",{className:"text-gray-600 mt-1",children:v&&`${o(v.weekStart.toISOString().split("T")[0])} - ${o(v.weekEnd.toISOString().split("T")[0])}`})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>ge("prev"),className:"p-2 text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(at,{className:"w-5 h-5"})}),e.jsx("button",{onClick:()=>N(new Date),className:"px-3 py-1 text-sm bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition-colors font-reisinger-yonatan",children:"השבוע"}),e.jsx("button",{onClick:()=>ge("next"),className:"p-2 text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(nt,{className:"w-5 h-5"})})]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:"grid grid-cols-8 border-b border-gray-200",children:[e.jsx("div",{className:"p-3 bg-gray-50 font-medium text-gray-700 font-reisinger-yonatan",children:"שעה"}),v?.days.map(m=>e.jsxs("div",{className:"p-3 bg-gray-50 text-center",children:[e.jsx("div",{className:"font-medium text-gray-900 font-reisinger-yonatan",children:m.dayName}),e.jsx("div",{className:"text-sm text-gray-500 font-reisinger-yonatan",children:o(m.date)})]},m.date))]}),e.jsx("div",{className:"max-h-96 overflow-y-auto relative",children:we.map(m=>e.jsxs("div",{className:"grid grid-cols-8 border-b border-gray-100",style:{height:"60px"},children:[e.jsx("div",{className:"p-3 bg-gray-50 text-sm font-medium text-gray-600 font-reisinger-yonatan flex items-center",children:de(m)}),v?.days.map(T=>{const P=f(T.date,m),re=!P&&se(T.dayName,m);return e.jsxs("div",{className:`border-l border-gray-100 relative transition-all duration-300 group ${re?"bg-blue-50/30 hover:bg-blue-100/50 cursor-pointer border-2 border-transparent hover:border-blue-200":"cursor-default"}`,style:{height:"60px"},onClick:()=>!P&&X(T.date,m,T.dayName),title:re?"לחץ להוספת שיעור חדש":"",children:[re&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"flex flex-col items-center opacity-30 group-hover:opacity-100 transition-all duration-300 group-hover:scale-110",children:[e.jsx(Me,{className:"w-6 h-6 text-blue-500"}),e.jsx("span",{className:"text-[10px] text-blue-600 font-medium mt-1 opacity-0 group-hover:opacity-100 transition-opacity duration-300",children:"הוסף שיעור"})]})}),P&&z(P,m)&&e.jsx("div",{className:"absolute left-1 right-1 top-1 p-2.5 rounded text-xs font-reisinger-yonatan bg-blue-100 text-blue-800 hover:bg-blue-200 border border-blue-300 shadow-sm cursor-pointer transition-all hover:scale-[1.02] z-10 overflow-hidden",style:{height:`${Q(P)-2}px`,minHeight:"82px"},onClick:()=>B(P),title:`${P.studentName||"תלמיד"} - ${P.instrument||""}`,children:e.jsx("div",{className:"flex flex-col h-full justify-between",children:e.jsxs("div",{className:"flex-shrink-0 space-y-1",children:[e.jsxs("div",{className:"font-medium truncate flex items-center gap-1",children:[e.jsx(De,{className:"w-3 h-3 opacity-60"}),P.studentName||"תלמיד"]}),e.jsxs("div",{className:"text-[10px] opacity-75",children:[de(P.startTime),"-",de(P.endTime)]}),e.jsx("div",{className:"flex items-center gap-1 text-[10px] opacity-80 h-4",children:P.instrument?e.jsxs(e.Fragment,{children:[e.jsx(Ce,{className:"w-2.5 h-2.5"}),e.jsx("span",{className:"truncate",children:P.instrument})]}):e.jsx("span",{className:"invisible",children:"placeholder"})}),e.jsx("div",{className:"flex items-center gap-1 text-[10px] opacity-70 h-4",children:P.location?e.jsxs(e.Fragment,{children:[e.jsx(ke,{className:"w-2.5 h-2.5"}),e.jsx("span",{className:"truncate",children:P.location})]}):e.jsx("span",{className:"invisible",children:"placeholder"})})]})})})]},`${T.date}-${m}`)})]},m))})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-bold text-gray-900 font-reisinger-yonatan",children:"ימי לימוד - זמינות המורה"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"הגדר את הימים והשעות שבהם אתה זמין להוראה"})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs("button",{onClick:h,className:"flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors",children:[e.jsx(Me,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"הוסף יום לימוד"})]})})]}),n.length===0?e.jsxs("div",{className:"text-center py-12 bg-gray-50 rounded-lg",children:[e.jsx(Pe,{className:"w-12 h-12 text-gray-300 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500 font-reisinger-yonatan text-lg",children:"אין ימי לימוד מוגדרים"}),e.jsx("button",{onClick:h,className:"mt-4 text-indigo-600 hover:text-indigo-700 font-medium",children:"הוסף יום לימוד ראשון"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:n.map(m=>e.jsx(Pt,{teachingDay:m,onEdit:()=>D(m),onDelete:()=>M(m)},m._id||m.id))})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(fe,{className:"w-5 h-5 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-900 font-reisinger-yonatan",children:"ימי לימוד"})]}),e.jsx("div",{className:"text-2xl font-bold text-blue-900 mt-2 font-reisinger-yonatan",children:n.length}),e.jsx("div",{className:"text-xs text-blue-700 mt-1",children:"ימי זמינות להוראה"})]}),e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(pe,{className:"w-5 h-5 text-green-600"}),e.jsx("span",{className:"font-medium text-green-900 font-reisinger-yonatan",children:"שעות זמינות"})]}),e.jsx("div",{className:"text-2xl font-bold text-green-900 mt-2 font-reisinger-yonatan",children:(n.reduce((m,T)=>{const P=ae(T.startTime,T.endTime);return m+P},0)/60).toFixed(1)}),e.jsx("div",{className:"text-xs text-green-700 mt-1",children:"שעות שבועיות זמינות"})]}),e.jsxs("div",{className:"bg-purple-50 border border-purple-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(De,{className:"w-5 h-5 text-purple-600"}),e.jsx("span",{className:"font-medium text-purple-900 font-reisinger-yonatan",children:"תלמידים"})]}),e.jsx("div",{className:"text-2xl font-bold text-purple-900 mt-2 font-reisinger-yonatan",children:new Set(l.map(m=>m.studentId).filter(Boolean)).size}),e.jsx("div",{className:"text-xs text-purple-700 mt-1",children:"תלמידים פעילים"})]}),e.jsxs("div",{className:"bg-orange-50 border border-orange-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ke,{className:"w-5 h-5 text-orange-600"}),e.jsx("span",{className:"font-medium text-orange-900 font-reisinger-yonatan",children:"שיעורים"})]}),e.jsx("div",{className:"text-2xl font-bold text-orange-900 mt-2 font-reisinger-yonatan",children:l.length}),e.jsx("div",{className:"text-xs text-orange-700 mt-1",children:"שיעורים קבועים"})]})]}),j&&p&&e.jsx(Bt,{timeSlot:p,teacherId:t?._id||"",teachingDays:n,onClose:()=>{O(!1),$(null)},onSave:()=>{O(!1),$(null),S()},showNotification:U}),q&&e.jsx(Rt,{lessonDay:x,teacherId:t?._id||"",onClose:()=>{i(!1),A(null)},onSave:()=>{i(!1),A(null),S()},showAlert:te}),c&&R&&e.jsx(Wt,{lesson:R,teacherId:t?._id||"",teachingDays:n,onClose:()=>{I(!1),_(null)},onSave:()=>{I(!1),_(null),S()},showAlert:te}),Y&&k&&e.jsx(Ft,{message:k.message,onConfirm:()=>{k.onConfirm(),ne(!1),W(null)},onCancel:()=>{ne(!1),W(null)}}),V&&e.jsx(Ht,{message:K,onClose:()=>{F(!1),Z("")}})]})}function Pt({teachingDay:t,onEdit:b,onDelete:N}){return e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4 hover:shadow-lg transition-shadow",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-2 bg-green-100 rounded-lg",children:e.jsx(fe,{className:"w-4 h-4 text-green-600"})}),e.jsxs("div",{children:[e.jsxs("h5",{className:"font-bold text-gray-900 font-reisinger-yonatan",children:["יום ",t.day]}),e.jsx("p",{className:"text-xs text-gray-500 mt-0.5",children:"זמינות להוראה"})]})]}),t.isRecurring!==!1&&e.jsx("span",{className:"px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full font-reisinger-yonatan",children:"שבועי"})]}),e.jsx("div",{className:"mb-3 pb-3 border-b border-gray-100",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-700",children:[e.jsx(pe,{className:"w-4 h-4 text-gray-400"}),e.jsxs("span",{className:"font-medium",children:[t.startTime," - ",t.endTime]})]})}),t.location&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600 mb-3",children:[e.jsx(ke,{className:"w-3.5 h-3.5 text-gray-400"}),e.jsx("span",{children:t.location})]}),e.jsx("div",{className:"p-2 bg-gray-50 rounded text-xs text-gray-600 mb-3",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ye,{className:"w-3 h-3"}),e.jsx("span",{children:"זמין לקביעת שיעורים בזמן זה"})]})}),t.notes&&e.jsx("div",{className:"p-2 bg-gray-50 rounded text-xs text-gray-600 mb-3",children:t.notes}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:b,className:"flex-1 flex items-center justify-center gap-1.5 px-3 py-1.5 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 transition-colors text-sm",children:[e.jsx(We,{className:"w-3.5 h-3.5"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"ערוך"})]}),e.jsx("button",{onClick:N,className:"flex items-center justify-center p-1.5 bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors",title:"מחק יום לימוד",children:e.jsx(ze,{className:"w-3.5 h-3.5"})})]})]})}function Rt({lessonDay:t,teacherId:b,onClose:N,onSave:v,showAlert:y}){const[l,a]=r.useState({day:t?.day||"ראשון",startTime:t?.startTime||"14:00",endTime:t?.endTime||"18:00",location:t?.location||"חדר מוזיקה",notes:t?.notes||"",recurring:t?.recurring||{isRecurring:!0,excludeDates:[]}}),[n,C]=r.useState(!1),w=async u=>{if(u.preventDefault(),t?.studentId){y("לא ניתן לערוך שיעור תלמיד מכאן. אנא השתמש באפשרות העריכה בכרטיס השיעור.");return}if(!l.day||!l.startTime||!l.endTime){y("יש למלא את כל השדות הנדרשים");return}try{C(!0);const L={day:l.day,startTime:l.startTime,endTime:l.endTime,location:l.location||null,notes:l.notes||null,recurring:l.recurring||{isRecurring:!0,excludeDates:[]}};t?.id&&/^[0-9a-fA-F]{24}$/.test(t.id)?await H.teacherSchedule.updateTimeBlock(b,t.id,L):await H.teacherSchedule.createTimeBlock(b,L),v()}catch(L){console.error("Error saving lesson day:",L),L?.message?.includes("not found")||L?.message?.includes("Resource not found")?(y("יום הלימוד הזה כבר לא קיים במערכת. הוא יוסר מהתצוגה."),N(),v()):y("שגיאה בשמירת יום הלימוד")}finally{C(!1)}},E=()=>["ראשון","שני","שלישי","רביעי","חמישי","שישי","שבת"];return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:t?"עריכת יום לימוד":"הוספת יום לימוד חדש"}),e.jsx("button",{onClick:N,className:"p-2 text-gray-400 hover:text-gray-600",children:e.jsx(ve,{className:"w-6 h-6"})})]}),e.jsxs("form",{onSubmit:w,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"יום בשבוע *"}),e.jsx("select",{value:l.day,onChange:u=>a(L=>({...L,day:u.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",required:!0,children:E().map(u=>e.jsx("option",{value:u,children:u},u))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שעת התחלה *"}),e.jsx("input",{type:"time",value:l.startTime,onChange:u=>a(L=>({...L,startTime:u.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שעת סיום *"}),e.jsx("input",{type:"time",value:l.endTime,onChange:u=>a(L=>({...L,endTime:u.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",required:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"מיקום / חדר"}),e.jsxs("select",{value:l.location||"",onChange:u=>a(L=>({...L,location:u.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"",children:"בחר חדר"}),He.map(u=>e.jsx("option",{value:u,children:u},u))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"הערות"}),e.jsx("textarea",{value:l.notes||"",onChange:u=>a(L=>({...L,notes:u.target.value})),rows:3,placeholder:"הערות נוספות לגבי השיעור...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:l.recurring?.isRecurring!==!1,onChange:u=>a(L=>({...L,recurring:{isRecurring:u.target.checked,excludeDates:L.recurring?.excludeDates||[]}})),className:"rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"שיעור קבוע (חוזר שבועית)"})]}),l.recurring?.isRecurring&&e.jsx("p",{className:"text-xs text-gray-500 mr-6 mt-1",children:"השיעור יופיע באופן קבוע בכל שבוע ביום ובשעה שהוגדרו"})]}),e.jsxs("div",{className:"flex gap-3 pt-6 border-t",children:[e.jsx("button",{type:"submit",disabled:n,className:"flex-1 bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed font-reisinger-yonatan flex items-center justify-center gap-2",children:n?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"שומר..."]}):e.jsx(e.Fragment,{children:t?e.jsxs(e.Fragment,{children:[e.jsx(Ue,{className:"w-4 h-4"}),"עדכן יום לימוד"]}):e.jsxs(e.Fragment,{children:[e.jsx(Me,{className:"w-4 h-4"}),"הוסף יום לימוד"]})})}),e.jsx("button",{type:"button",onClick:N,disabled:n,className:"flex-1 bg-gray-300 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed font-reisinger-yonatan",children:"ביטול"})]})]})]})})}function Bt({timeSlot:t,teacherId:b,teachingDays:N,onClose:v,onSave:y,showNotification:l}){const[a,n]=r.useState(""),[C,w]=r.useState(45),[E,u]=r.useState([]),[L,q]=r.useState(!1),[i,x]=r.useState(!1),[A,g]=r.useState(0),[d,j]=r.useState(""),[O,p]=r.useState(!1);r.useEffect(()=>{$()},[]),r.useEffect(()=>{const k=W=>{W.target.closest(".student-search-dropdown")||p(!1)};return O&&document.addEventListener("mousedown",k),()=>{document.removeEventListener("mousedown",k)}},[O]);const $=async()=>{try{q(!0);const W=(await H.students.getStudents()).map(V=>{const F=V.academicInfo?.instrumentProgress?.find(K=>K.isPrimary)||V.academicInfo?.instrumentProgress?.[0];return{id:V._id,firstName:V.personalInfo?.firstName||V.personalInfo?.fullName?.split(" ")[0]||"",lastName:V.personalInfo?.lastName||V.personalInfo?.fullName?.split(" ").slice(1).join(" ")||"",instrument:F?.instrumentName||"",class:V.personalInfo?.class||V.academicInfo?.class,stage:F?.currentStage}});u(W)}catch(k){console.error("Error loading students:",k)}finally{q(!1)}},c=E.filter(k=>{if(!d)return!0;const W=d.toLowerCase();return`${k.firstName} ${k.lastName}`.toLowerCase().includes(W)||k.instrument?.toLowerCase().includes(W)||k.class?.toLowerCase().includes(W)}),I=(k,W)=>{const[V,F]=k.split(":").map(Number),K=V*60+F+W,Z=Math.floor(K/60),S=K%60;return`${Z.toString().padStart(2,"0")}:${S.toString().padStart(2,"0")}`},R=()=>{const[k]=t.time.split(":").map(Number),W=A;return`${k.toString().padStart(2,"0")}:${W.toString().padStart(2,"0")}`},_=[0,5,10,15,20,25,30,35,40,45,50,55],Y=async k=>{if(k.preventDefault(),!a){l("יש לבחור תלמיד","error");return}try{x(!0);const W=E.find(de=>de.id===a),V=R(),F=I(V,C);console.log("📝 Creating lesson for student:",W),console.log("📅 Lesson details:",{day:t.dayName,time:V,duration:C});const Z=N.find(de=>de.day===t.dayName)?.location||"",S={teacherId:b,day:t.dayName,time:V,endTime:F,duration:C,location:Z,isActive:!0,startDate:new Date().toISOString(),isRecurring:!0};console.log("📖 Fetching student data...");const ae=[...(await H.students.getStudent(a)).teacherAssignments||[],S];console.log("💾 Updating student with teacher assignment..."),await H.students.updateStudent(a,{teacherAssignments:ae}),console.log("👨‍🏫 Updating teacher student list...");const me=await H.teachers.getTeacher(b),oe=me.teaching?.studentIds||[];oe.includes(a)||await H.teachers.updateTeacher(b,{teaching:{...me.teaching,studentIds:[...oe,a]}});const ge={day:t.dayName,startTime:V,endTime:F,studentId:a,studentName:W?`${W.firstName} ${W.lastName}`:"",instrument:W?.instrument||"",location:Z,notes:`שיעור קבוע שבועי - נוצר ב-${new Date().toLocaleDateString("he-IL")}`,recurring:{isRecurring:!0,excludeDates:[]},isRecurring:!0,totalDuration:C};console.log("📋 Creating time block for teacher schedule..."),await H.teacherSchedule.createTimeBlock(b,ge),console.log("✅ Lesson created successfully!"),l("השיעור נוצר בהצלחה!","success"),y()}catch(W){console.error("❌ Error creating weekly lesson assignment:",W),l(`שגיאה ביצירת השיעור השבועי: ${W.message||"שגיאה לא ידועה"}`,"error")}finally{x(!1)}},ne=k=>k.slice(0,5);return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-md mx-4",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:"הוספת שיעור חדש"}),e.jsx("button",{onClick:v,className:"p-2 text-gray-400 hover:text-gray-600",children:e.jsx(ve,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"mb-4 p-3 bg-blue-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 text-blue-800 mb-2",children:[e.jsx(fe,{className:"w-4 h-4"}),e.jsxs("span",{className:"font-medium",children:["שיעור קבוע שבועי - יום ",t.dayName]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-blue-700",children:[e.jsx(pe,{className:"w-4 h-4"}),e.jsxs("span",{children:[ne(R())," - ",ne(I(R(),C))," (",C," דקות)"]})]}),e.jsxs("div",{className:"text-xs text-blue-600 mt-1",children:["השיעור יתקיים כל שבוע ביום ",t.dayName," באותה שעה"]})]}),e.jsxs("form",{onSubmit:Y,className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"בחר תלמיד *"}),L?e.jsx("div",{className:"text-center py-2 text-gray-500",children:"טוען רשימת תלמידים..."}):e.jsxs("div",{className:"relative student-search-dropdown",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Te,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",value:d,onChange:k=>{j(k.target.value),p(!0)},onFocus:()=>p(!0),placeholder:"חפש תלמיד לפי שם, כלי נגינה או כיתה...",className:"w-full pr-10 pl-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),a&&!O&&e.jsx("div",{className:"mt-2 p-2 bg-indigo-50 border border-indigo-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm",children:[e.jsxs("span",{className:"font-medium text-indigo-900",children:[E.find(k=>k.id===a)?.firstName," ",E.find(k=>k.id===a)?.lastName]}),E.find(k=>k.id===a)?.instrument&&e.jsxs("span",{className:"text-indigo-700",children:[" - ",E.find(k=>k.id===a)?.instrument]})]}),e.jsx("button",{type:"button",onClick:()=>{n(""),j(""),p(!0)},className:"text-indigo-600 hover:text-indigo-800",children:e.jsx(ve,{className:"w-4 h-4"})})]})}),O&&e.jsx("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto",children:c.length>0?c.map(k=>e.jsxs("button",{type:"button",onClick:()=>{n(k.id),j(`${k.firstName} ${k.lastName}`),p(!1)},className:`w-full text-right px-3 py-2 hover:bg-indigo-50 transition-colors border-b border-gray-100 last:border-b-0 ${a===k.id?"bg-indigo-100":""}`,children:[e.jsxs("div",{className:"font-medium text-gray-900",children:[k.firstName," ",k.lastName]}),e.jsxs("div",{className:"text-xs text-gray-600 mt-0.5",children:[k.instrument&&`${k.instrument}`,k.class&&` • כיתה ${k.class}`,k.stage&&` • שלב ${k.stage}`]})]},k.id)):e.jsx("div",{className:"px-3 py-4 text-center text-gray-500",children:"לא נמצאו תלמידים מתאימים"})})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:["זמן התחלה מדויק (שעה ",t.time.split(":")[0],":__)"]}),e.jsx("div",{className:"grid grid-cols-6 gap-2",children:_.map(k=>e.jsxs("button",{type:"button",onClick:()=>g(k),className:`px-3 py-2 rounded-lg border-2 transition-all font-medium ${A===k?"border-indigo-600 bg-indigo-50 text-indigo-700":"border-gray-200 hover:border-gray-300 hover:bg-gray-50"}`,children:[":",k.toString().padStart(2,"0")]},k))}),e.jsxs("div",{className:"mt-2 text-xs text-gray-600",children:["שעת התחלה: ",R()]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"משך השיעור (דקות)"}),e.jsxs("select",{value:C,onChange:k=>w(Number(k.target.value)),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:30,children:"30 דקות"}),e.jsx("option",{value:45,children:"45 דקות"}),e.jsx("option",{value:60,children:"60 דקות"}),e.jsx("option",{value:90,children:"90 דקות"})]})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{type:"submit",disabled:i||!a,className:"flex-1 bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed font-reisinger-yonatan flex items-center justify-center gap-2",children:i?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"יוצר שיעור שבועי..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ue,{className:"w-4 h-4"}),"צור שיעור שבועי"]})}),e.jsx("button",{type:"button",onClick:v,disabled:i,className:"flex-1 bg-gray-300 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed font-reisinger-yonatan",children:"ביטול"})]})]})]})})}function Ft({message:t,onConfirm:b,onCancel:N}){return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-md mx-4",dir:"rtl",children:[e.jsx("div",{className:"flex items-center justify-center mb-6",children:e.jsx("div",{className:"p-3 bg-orange-100 rounded-full",children:e.jsx($e,{className:"w-8 h-8 text-orange-600"})})}),e.jsx("h3",{className:"text-lg font-bold text-gray-900 text-center mb-4 font-reisinger-yonatan",children:t}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:b,className:"flex-1 bg-red-600 text-white py-2.5 px-4 rounded-lg hover:bg-red-700 transition-colors font-reisinger-yonatan font-medium",children:"אישור"}),e.jsx("button",{onClick:N,className:"flex-1 bg-gray-200 text-gray-700 py-2.5 px-4 rounded-lg hover:bg-gray-300 transition-colors font-reisinger-yonatan font-medium",children:"ביטול"})]})]})})}function Ht({message:t,onClose:b}){return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-md mx-4",dir:"rtl",children:[e.jsx("div",{className:"flex items-center justify-center mb-6",children:e.jsx("div",{className:"p-3 bg-blue-100 rounded-full",children:e.jsx($e,{className:"w-8 h-8 text-blue-600"})})}),e.jsx("h3",{className:"text-lg font-bold text-gray-900 text-center mb-6 font-reisinger-yonatan",children:t}),e.jsx("button",{onClick:b,className:"w-full bg-indigo-600 text-white py-2.5 px-4 rounded-lg hover:bg-indigo-700 transition-colors font-reisinger-yonatan font-medium",children:"הבנתי"})]})})}function Wt({lesson:t,teacherId:b,teachingDays:N,onClose:v,onSave:y,showAlert:l}){const a=(p,$)=>{const[c,I]=p.split(":").map(Number),[R,_]=$.split(":").map(Number);return R*60+_-(c*60+I)},C=N.find(p=>p.day===t.day)?.location||"",[w,E]=r.useState({day:t.day,startTime:t.startTime,endTime:t.endTime,location:t.location||C,notes:t.notes||""}),[u,L]=r.useState(!1),[q,i]=r.useState(a(t.startTime,t.endTime)),[x,A]=r.useState([]);r.useState(""),r.useEffect(()=>{if(!w.day||!q)return;const p=N.filter(c=>c.day===w.day),$=[];p.forEach(c=>{const[I,R]=c.startTime.split(":").map(Number),[_,Y]=c.endTime.split(":").map(Number),ne=I*60+R,W=_*60+Y-ne,V=Math.floor(W/q);for(let F=0;F<V;F++){const K=ne+F*q,Z=K+q,S=Math.floor(K/60),J=K%60,ae=Math.floor(Z/60),me=Z%60,oe=`${S.toString().padStart(2,"0")}:${J.toString().padStart(2,"0")}`,ge=`${ae.toString().padStart(2,"0")}:${me.toString().padStart(2,"0")}`;$.push({id:`${c._id||c.id}-${q}-${F}`,startTime:oe,endTime:ge,duration:q})}}),A($)},[w.day,q,N]);const g=p=>{E($=>({...$,startTime:p.startTime,endTime:p.endTime}))},d=async p=>{if(p.preventDefault(),!w.day||!w.startTime||!w.endTime){l("יש למלא את כל השדות הנדרשים");return}const $=a(w.startTime,w.endTime);if($<=0){l("זמן הסיום חייב להיות לאחר זמן ההתחלה");return}try{if(L(!0),t.studentId){const c={teacherId:b,day:w.day,time:w.startTime,startTime:w.startTime,endTime:w.endTime,duration:$,location:w.location,isActive:!0};await H.students.updateTeacherAssignment(t.studentId,b,c)}j("השיעור עודכן בהצלחה","success"),y()}catch(c){console.error("Error updating lesson:",c),j("שגיאה בעדכון השיעור","error")}finally{L(!1)}},j=(p,$)=>{const c=document.createElement("div");c.className=`fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 ${$==="success"?"bg-green-500 text-white":"bg-red-500 text-white"}`,c.innerHTML=`<div class="flex items-center gap-2 font-reisinger-yonatan">
      ${$==="success"?"✅":"❌"} ${p}
    </div>`,document.body.appendChild(c),setTimeout(()=>c.remove(),3e3)},O=()=>{const p=Array.from(new Set(N.map($=>$.day)));return p.length===0?["ראשון","שני","שלישי","רביעי","חמישי","שישי","שבת"]:p};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:"עריכת שיעור"}),e.jsx("button",{onClick:v,className:"p-2 text-gray-400 hover:text-gray-600",children:e.jsx(ve,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsx("h4",{className:"font-medium text-blue-900 mb-2 font-reisinger-yonatan",children:"פרטי התלמיד"}),e.jsxs("div",{className:"space-y-1 text-sm text-blue-800",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(De,{className:"w-4 h-4"}),e.jsx("strong",{children:"תלמיד:"})," ",t.studentName||"לא צוין"]}),t.instrument&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ce,{className:"w-4 h-4"}),e.jsx("strong",{children:"כלי נגינה:"})," ",t.instrument]}),t.studentClass&&e.jsxs("div",{children:[e.jsx("strong",{children:"כיתה:"})," ",t.studentClass]}),t.studentStage&&e.jsxs("div",{children:[e.jsx("strong",{children:"שלב:"})," ",t.studentStage]})]})]}),e.jsxs("form",{onSubmit:d,className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"יום בשבוע *"}),e.jsx("select",{value:w.day,onChange:p=>{const $=p.target.value,c=N.find(I=>I.day===$);E(I=>({...I,day:$,location:(!I.location||I.location==="")&&c?.location?c.location:I.location}))},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",required:!0,children:O().map(p=>e.jsx("option",{value:p,children:p},p))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"משך השיעור (דקות) *"}),e.jsx("div",{className:"grid grid-cols-3 gap-3",children:[30,45,60].map(p=>e.jsxs("button",{type:"button",onClick:()=>i(p),className:`px-4 py-2 rounded-lg border-2 transition-all ${q===p?"border-indigo-600 bg-indigo-50 text-indigo-700 font-semibold":"border-gray-300 bg-white text-gray-700 hover:border-indigo-300"}`,children:[p," דק׳"]},p))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:"בחר זמן שיעור זמין *"}),x.length===0?e.jsxs("div",{className:"text-center py-6 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsx(pe,{className:"w-8 h-8 mx-auto mb-2 text-gray-300"}),e.jsx("p",{className:"text-sm text-gray-500",children:"אין זמנים זמינים ליום ומשך שיעור שנבחרו"})]}):e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 max-h-64 overflow-y-auto p-2 bg-gray-50 rounded-lg border border-gray-200",children:x.map(p=>{const $=w.startTime===p.startTime&&w.endTime===p.endTime;return e.jsxs("button",{type:"button",onClick:()=>g(p),className:`p-3 rounded-lg border-2 transition-all text-sm ${$?"border-green-600 bg-green-50 text-green-800 font-semibold shadow-md":p.duration===30?"border-green-300 bg-green-50 text-green-800 hover:border-green-500":p.duration===45?"border-blue-300 bg-blue-50 text-blue-800 hover:border-blue-500":"border-purple-300 bg-purple-50 text-purple-800 hover:border-purple-500"}`,children:[e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx(pe,{className:"w-3 h-3"}),e.jsxs("span",{className:"font-medium",children:[p.startTime,"-",p.endTime]})]}),e.jsxs("div",{className:"text-xs mt-1 opacity-75",children:[p.duration," דקות"]})]},p.id)})})]}),w.startTime&&w.endTime&&e.jsx("div",{className:"p-3 bg-indigo-50 rounded-lg border border-indigo-200",children:e.jsxs("div",{className:"flex items-center gap-2 text-indigo-800",children:[e.jsx(pe,{className:"w-4 h-4"}),e.jsxs("span",{className:"font-reisinger-yonatan font-medium",children:["זמן שיעור נבחר: ",w.startTime," - ",w.endTime," (",a(w.startTime,w.endTime)," דקות)"]})]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"מיקום / חדר"}),e.jsxs("select",{value:w.location||"",onChange:p=>E($=>({...$,location:p.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"",children:"בחר חדר"}),He.map(p=>e.jsx("option",{value:p,children:p},p))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"הערות"}),e.jsx("textarea",{value:w.notes,onChange:p=>E($=>({...$,notes:p.target.value})),rows:3,placeholder:"הערות נוספות לגבי השיעור...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{className:"flex gap-3 pt-6 border-t",children:[e.jsx("button",{type:"submit",disabled:u||!w.startTime||!w.endTime,className:"flex-1 bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed font-reisinger-yonatan flex items-center justify-center gap-2",children:u?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"שומר..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ue,{className:"w-4 h-4"}),"עדכן שיעור"]})}),e.jsx("button",{type:"button",onClick:v,disabled:u,className:"flex-1 bg-gray-300 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed font-reisinger-yonatan",children:"ביטול"})]})]})]})})}function zt(){const{user:t}=Ie(),[b,N]=r.useState([]),[v,y]=r.useState(!0),[l,a]=r.useState(""),[n,C]=r.useState(!1),[w,E]=r.useState(null),[u,L]=r.useState(null),[q,i]=r.useState([]),[x,A]=r.useState(null),[g,d]=r.useState(!1),[j,O]=r.useState(!1),[p,$]=r.useState(!1),[c,I]=r.useState([]),[R,_]=r.useState(null),[Y,ne]=r.useState("lessons");r.useEffect(()=>{k()},[t]);const k=async()=>{if(t?._id)try{y(!0);const o=t._id,D=(await H.theory.getTheoryLessons()).filter(M=>M.teacherId===o).map(M=>({id:M._id,name:M.name,description:M.description,level:M.level,duration:M.duration,capacity:M.capacity,enrolledCount:M.enrolledStudentIds?.length||0,schedule:{dayOfWeek:M.dayOfWeek,startTime:M.startTime,endTime:M.endTime},status:M.isActive?"active":"inactive",venue:M.location,materials:M.materials||[]}));N(D)}catch(o){console.error("Error loading theory lessons:",o),A("שגיאה בטעינת רשימת שיעורי התיאוריה")}finally{y(!1)}},W=async o=>{try{const B=(await H.theory.getTheoryLesson(o)).enrolledStudentIds||[];if(B.length===0){i([]);return}const M=(await H.students.getStudents({ids:B.join(",")})).map(U=>({id:U._id,firstName:U.personalInfo?.firstName||"",lastName:U.personalInfo?.lastName||"",grade:U.academicInfo?.gradeLevel,instrument:U.primaryInstrument,enrollmentDate:U.createdAt||new Date().toISOString(),attendance:{total:0,present:0,absent:0}}));i(M)}catch(h){console.error("Error loading lesson students:",h)}},V=b.filter(o=>l===""||o.name.toLowerCase().includes(l.toLowerCase())||o.level.toLowerCase().includes(l.toLowerCase())||o.description?.toLowerCase().includes(l.toLowerCase())),F=async o=>{if(window.confirm("האם אתה בטוח שברצונך למחוק שיעור זה?"))try{await H.theory.deleteTheoryLesson(o),N(h=>h.filter(B=>B.id!==o)),u===o&&(L(null),i([]))}catch(h){console.error("Error deleting lesson:",h),alert("שגיאה במחיקת השיעור")}},K=async o=>{try{const h=await Z(o);if(h.hasConflict){_(h),$(!0);return}if(w){const B={name:o.name,description:o.description,level:o.level,duration:o.duration,capacity:o.capacity,dayOfWeek:o.schedule?.dayOfWeek,startTime:o.schedule?.startTime,endTime:o.schedule?.endTime,isActive:o.status==="active",location:o.venue},D=await H.theory.updateTheoryLesson(w.id,B),M={id:D._id,name:D.name,description:D.description,level:D.level,duration:D.duration,capacity:D.capacity,enrolledCount:D.enrolledStudentIds?.length||0,schedule:{dayOfWeek:D.dayOfWeek,startTime:D.startTime,endTime:D.endTime},status:D.isActive?"active":"inactive",venue:D.location,materials:D.materials||[]};N(U=>U.map(te=>te.id===w.id?M:te))}else{const B=t?._id,D={name:o.name,description:o.description,level:o.level,duration:o.duration,capacity:o.capacity,dayOfWeek:o.schedule?.dayOfWeek,startTime:o.schedule?.startTime,endTime:o.schedule?.endTime,isActive:o.status==="active",location:o.venue,teacherId:B},M=await H.theory.createTheoryLesson(D),U={id:M._id,name:M.name,description:M.description,level:M.level,duration:M.duration,capacity:M.capacity,enrolledCount:M.enrolledStudentIds?.length||0,schedule:{dayOfWeek:M.dayOfWeek,startTime:M.startTime,endTime:M.endTime},status:M.isActive?"active":"inactive",venue:M.location,materials:M.materials||[]};N(te=>[...te,U])}C(!1),E(null)}catch(h){console.error("Error saving lesson:",h),alert("שגיאה בשמירת פרטי השיעור")}},Z=async o=>{try{const h=b.filter(U=>U.id!==w?.id&&U.schedule.dayOfWeek===o.schedule?.dayOfWeek),B=o.schedule?.startTime,D=o.schedule?.endTime,M=h.filter(U=>{const te=U.schedule.startTime,s=U.schedule.endTime;return B&&D&&te&&s&&(B>=te&&B<s||D>te&&D<=s||B<=te&&D>=s)});return M.length>0?{hasConflict:!0,conflictDetails:`התנגשות עם ${M[0].name} ב${de(M[0].schedule.dayOfWeek)} ${M[0].schedule.startTime}-${M[0].schedule.endTime}`,suggestions:["שנה את שעת השיעור","העבר ליום אחר","קצר את משך השיעור"]}:{hasConflict:!1}}catch(h){return console.error("Error checking conflicts:",h),{hasConflict:!1}}},S=async()=>{try{const o=await H.students.getStudents(),h=q.map(D=>D.id),B=o.filter(D=>!h.includes(D._id)).map(D=>({id:D._id,firstName:D.personalInfo?.firstName||"",lastName:D.personalInfo?.lastName||"",grade:D.academicInfo?.gradeLevel,instrument:D.primaryInstrument,enrollmentDate:new Date().toISOString(),attendance:{total:0,present:0,absent:0}}));I(B)}catch(o){console.error("Error loading available students:",o)}},J=async o=>{if(u)try{await et.enrollStudent(u,o,{method:"manual",performedBy:"teacher",reason:"Teacher enrollment"}),await W(u),await S()}catch(h){console.error("Error enrolling student:",h),alert("שגיאה ברישום התלמיד")}},ae=async o=>{if(u)try{await et.unenrollStudent(u,o,{reason:"Teacher unenrollment"}),await W(u),await S()}catch(h){console.error("Error unenrolling student:",h),alert("שגיאה בביטול רישום התלמיד")}},me=async o=>{try{const h={...o,name:`${o.name} - עותק`,id:void 0};await K(h)}catch(h){console.error("Error duplicating lesson:",h),alert("שגיאה בשכפול השיעור")}},oe=o=>{switch(o){case"beginner":return"מתחילים";case"intermediate":return"בינוניים";case"advanced":return"מתקדמים";default:return o}},ge=o=>o.substring(0,5),de=o=>({sunday:"יום ראשון",monday:"יום שני",tuesday:"יום שלישי",wednesday:"יום רביעי",thursday:"יום חמישי",friday:"יום שישי",saturday:"יום שבת"})[o.toLowerCase()]||o;return v?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600",children:"טוען רשימת שיעורים..."})]})}):x?e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("div",{className:"text-red-800 font-reisinger-yonatan",children:x})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:"ניהול תיאוריה מתקדם"}),e.jsxs("p",{className:"text-gray-600 mt-1",children:[b.length," שיעורים פעילים"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>d(!0),className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[e.jsx(yt,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"נהל קבוצות"})]}),e.jsxs("button",{onClick:()=>C(!0),className:"flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors",children:[e.jsx(Me,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"הוסף שיעור"})]})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsx("nav",{className:"flex space-x-8 px-6",dir:"rtl",children:[{id:"lessons",label:"שיעורים",icon:Pe},{id:"groups",label:"קבוצות",icon:ye},{id:"curriculum",label:"תכנית לימודים",icon:Ze},{id:"grades",label:"ציונים",icon:Je}].map(o=>{const h=o.icon;return e.jsxs("button",{onClick:()=>ne(o.id),className:`py-4 px-1 border-b-2 font-medium text-sm transition-colors flex items-center gap-2 font-reisinger-yonatan ${Y===o.id?"border-indigo-500 text-indigo-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}`,children:[e.jsx(h,{className:"w-4 h-4"}),o.label]},o.id)})})}),e.jsxs("div",{className:"p-6",children:[Y==="lessons"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative mb-6",children:[e.jsx(Te,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"חיפוש שיעורים...",value:l,onChange:o=>a(o.target.value),className:"w-full pl-4 pr-12 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"rtl"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsx("div",{className:"space-y-4",children:V.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Pe,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2 font-reisinger-yonatan",children:l?"לא נמצאו שיעורים":"אין שיעורים רשומים"}),e.jsx("p",{className:"text-gray-600 font-reisinger-yonatan",children:l?"נסה מילות חיפוש אחרות":"התחל בהוספת השיעור הראשון שלך"})]}):V.map(o=>e.jsxs("div",{className:`bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all cursor-pointer ${u===o.id?"ring-2 ring-indigo-500 bg-indigo-50":""}`,onClick:()=>{L(o.id),W(o.id)},children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-gray-900 font-reisinger-yonatan",children:o.name}),e.jsxs("p",{className:"text-sm text-gray-600 font-reisinger-yonatan",children:[oe(o.level)," • ",o.duration," דקות"]}),o.description&&e.jsx("p",{className:"text-sm text-gray-500 mt-1 font-reisinger-yonatan",children:o.description})]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:h=>{h.stopPropagation(),me(o)},className:"p-1 text-gray-400 hover:text-blue-600 transition-colors",title:"שכפל שיעור",children:e.jsx(bt,{className:"w-4 h-4"})}),e.jsx("button",{onClick:h=>{h.stopPropagation(),E(o),C(!0)},className:"p-1 text-gray-400 hover:text-indigo-600 transition-colors",title:"ערוך שיעור",children:e.jsx(We,{className:"w-4 h-4"})}),e.jsx("button",{onClick:h=>{h.stopPropagation(),F(o.id)},className:"p-1 text-gray-400 hover:text-red-600 transition-colors",title:"מחק שיעור",children:e.jsx(ze,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm text-gray-600 mb-3",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(fe,{className:"w-4 h-4"}),e.jsx("span",{children:de(o.schedule.dayOfWeek)})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(pe,{className:"w-4 h-4"}),e.jsxs("span",{children:[ge(o.schedule.startTime)," - ",ge(o.schedule.endTime)]})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ye,{className:"w-4 h-4"}),e.jsxs("span",{children:[o.enrolledCount||0,"/",o.capacity]})]}),o.venue&&e.jsx("span",{children:o.venue})]}),e.jsx("span",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${o.status==="active"?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"}`,children:o.status==="active"?"פעיל":"לא פעיל"})]})]},o.id))}),u&&e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h4",{className:"font-semibold text-gray-900 font-reisinger-yonatan",children:"תלמידי השיעור"}),e.jsx("div",{className:"flex gap-2",children:e.jsxs("button",{onClick:()=>{O(!0),S()},className:"flex items-center gap-1 text-indigo-600 hover:text-indigo-800 text-sm font-medium font-reisinger-yonatan",children:[e.jsx(be,{className:"w-4 h-4"}),"הוסף תלמיד"]})})]}),q.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(ye,{className:"w-8 h-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-500 text-sm font-reisinger-yonatan",children:"אין תלמידים רשומים לשיעור"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:q.map(o=>e.jsxs("div",{className:"flex items-center justify-between p-3 hover:bg-gray-50 rounded border",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-medium text-sm font-reisinger-yonatan",children:[o.firstName," ",o.lastName]}),e.jsxs("div",{className:"text-xs text-gray-500 font-reisinger-yonatan",children:[o.instrument&&`${o.instrument} • `,o.grade&&`כיתה ${o.grade} • `,"רישום: ",new Date(o.enrollmentDate).toLocaleDateString("he-IL")]}),o.attendance&&e.jsxs("div",{className:"text-xs text-gray-500 mt-1 font-reisinger-yonatan",children:["נוכחות: ",o.attendance.present,"/",o.attendance.total," שיעורים",e.jsxs("span",{className:`ml-2 ${o.attendance.present/o.attendance.total>=.8?"text-green-600":"text-red-600"}`,children:["(",Math.round(o.attendance.present/o.attendance.total*100),"%)"]})]})]}),e.jsx("button",{onClick:()=>ae(o.id),className:"text-red-600 hover:text-red-800 p-1",title:"הסר תלמיד",children:e.jsx(it,{className:"w-4 h-4"})})]},o.id))})]})]})]}),Y==="groups"&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ye,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2 font-reisinger-yonatan",children:"ניהול קבוצות תיאוריה"}),e.jsx("p",{className:"text-gray-600 font-reisinger-yonatan",children:"תכונה זו תהיה זמינה בקרוב"})]}),Y==="curriculum"&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Ze,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2 font-reisinger-yonatan",children:"תכנית לימודים"}),e.jsx("p",{className:"text-gray-600 font-reisinger-yonatan",children:"תכונה זו תהיה זמינה בקרוב"})]}),Y==="grades"&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Je,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2 font-reisinger-yonatan",children:"ניהול ציונים"}),e.jsx("p",{className:"text-gray-600 font-reisinger-yonatan",children:"תכונה זו תהיה זמינה בקרוב"})]})]})]}),n&&e.jsx(qt,{lesson:w,onClose:()=>{C(!1),E(null)},onSubmit:K}),j&&e.jsx(Ut,{availableStudents:c,onClose:()=>O(!1),onEnroll:J}),p&&R&&e.jsx(Gt,{conflict:R,onClose:()=>$(!1),onResolve:()=>{$(!1),C(!0)}})]})}function qt({lesson:t,onClose:b,onSubmit:N}){const[v,y]=r.useState({name:t?.name||"",description:t?.description||"",level:t?.level||"beginner",duration:t?.duration||60,capacity:t?.capacity||15,status:t?.status||"active",venue:t?.venue||"",schedule:{dayOfWeek:t?.schedule?.dayOfWeek||"sunday",startTime:t?.schedule?.startTime||"09:00",endTime:t?.schedule?.endTime||"10:00"}}),l=n=>{n.preventDefault(),N(v)},a=(n,C)=>{y(w=>({...w,schedule:{...w.schedule,[n]:C}}))};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto",dir:"rtl",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900 mb-4 font-reisinger-yonatan",children:t?"עריכת שיעור תיאוריה":"הוספת שיעור תיאוריה חדש"}),e.jsxs("form",{onSubmit:l,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שם השיעור *"}),e.jsx("input",{type:"text",required:!0,value:v.name,onChange:n=>y(C=>({...C,name:n.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"תיאור השיעור"}),e.jsx("textarea",{value:v.description,onChange:n=>y(C=>({...C,description:n.target.value})),rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"רמה *"}),e.jsxs("select",{required:!0,value:v.level,onChange:n=>y(C=>({...C,level:n.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"beginner",children:"מתחילים"}),e.jsx("option",{value:"intermediate",children:"בינוניים"}),e.jsx("option",{value:"advanced",children:"מתקדמים"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"משך השיעור (דקות) *"}),e.jsx("input",{type:"number",required:!0,min:"30",max:"180",step:"15",value:v.duration,onChange:n=>y(C=>({...C,duration:parseInt(n.target.value)})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"קיבולת תלמידים *"}),e.jsx("input",{type:"number",required:!0,min:"1",max:"50",value:v.capacity,onChange:n=>y(C=>({...C,capacity:parseInt(n.target.value)})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"סטטוס"}),e.jsxs("select",{value:v.status,onChange:n=>y(C=>({...C,status:n.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"active",children:"פעיל"}),e.jsx("option",{value:"inactive",children:"לא פעיל"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"יום השיעור *"}),e.jsxs("select",{required:!0,value:v.schedule.dayOfWeek,onChange:n=>a("dayOfWeek",n.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"sunday",children:"יום ראשון"}),e.jsx("option",{value:"monday",children:"יום שני"}),e.jsx("option",{value:"tuesday",children:"יום שלישי"}),e.jsx("option",{value:"wednesday",children:"יום רביעי"}),e.jsx("option",{value:"thursday",children:"יום חמישי"}),e.jsx("option",{value:"friday",children:"יום שישי"}),e.jsx("option",{value:"saturday",children:"יום שבת"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שעת התחלה *"}),e.jsx("input",{type:"time",required:!0,value:v.schedule.startTime,onChange:n=>a("startTime",n.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שעת סיום *"}),e.jsx("input",{type:"time",required:!0,value:v.schedule.endTime,onChange:n=>a("endTime",n.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"מקום השיעור"}),e.jsx("input",{type:"text",value:v.venue,onChange:n=>y(C=>({...C,venue:n.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx("button",{type:"submit",className:"flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors font-reisinger-yonatan",children:t?"עדכן":"הוסף"}),e.jsx("button",{type:"button",onClick:b,className:"flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors font-reisinger-yonatan",children:"ביטול"})]})]})]})})}function Ut({availableStudents:t,onClose:b,onEnroll:N}){const[v,y]=r.useState(""),l=t.filter(a=>`${a.firstName} ${a.lastName}`.toLowerCase().includes(v.toLowerCase())||a.instrument?.toLowerCase().includes(v.toLowerCase()));return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-md mx-4 max-h-[80vh] overflow-y-auto",dir:"rtl",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900 mb-4 font-reisinger-yonatan",children:"הוסף תלמיד לשיעור"}),e.jsxs("div",{className:"relative mb-4",children:[e.jsx(Te,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"text",placeholder:"חיפוש תלמידים...",value:v,onChange:a=>y(a.target.value),className:"w-full pl-4 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto",children:l.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(ye,{className:"w-8 h-8 mx-auto mb-2 text-gray-300"}),e.jsx("p",{className:"font-reisinger-yonatan",children:"אין תלמידים זמינים"})]}):l.map(a=>e.jsxs("div",{className:"flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium text-gray-900 font-reisinger-yonatan",children:[a.firstName," ",a.lastName]}),e.jsxs("div",{className:"text-sm text-gray-600 font-reisinger-yonatan",children:[a.instrument&&`${a.instrument} • `,a.grade&&`כיתה ${a.grade}`]})]}),e.jsxs("button",{onClick:()=>N(a.id),className:"flex items-center gap-1 px-3 py-1 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm font-reisinger-yonatan",children:[e.jsx(be,{className:"w-4 h-4"}),"הוסף"]})]},a.id))}),e.jsx("div",{className:"flex gap-3 mt-6",children:e.jsx("button",{onClick:b,className:"flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors font-reisinger-yonatan",children:"סגור"})})]})})}function Gt({conflict:t,onClose:b,onResolve:N}){return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-md mx-4",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx(jt,{className:"w-8 h-8 text-yellow-600"}),e.jsx("h3",{className:"text-lg font-bold text-gray-900 font-reisinger-yonatan",children:"התנגשות בלוח הזמנים"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-gray-700 font-reisinger-yonatan mb-3",children:t.conflictDetails}),t.suggestions&&e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900 mb-2 font-reisinger-yonatan",children:"הצעות לפתרון:"}),e.jsx("ul",{className:"list-disc list-inside space-y-1 text-sm text-gray-600",children:t.suggestions.map((v,y)=>e.jsx("li",{className:"font-reisinger-yonatan",children:v},y))})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:N,className:"flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors font-reisinger-yonatan",children:"ערוך שיעור"}),e.jsx("button",{onClick:b,className:"flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors font-reisinger-yonatan",children:"ביטול"})]})]})})}function Qt(){const{user:t}=Ie(),[b,N]=r.useState([]),[v,y]=r.useState(!0),[l,a]=r.useState(new Date().toISOString().split("T")[0]),[n,C]=r.useState({totalStudents:0,markedToday:0,presentToday:0,absentToday:0});r.useEffect(()=>{w()},[l]);const w=async()=>{try{y(!0);const i=t?._id||t?.teacherId||t?.id;if(!i){Ne.error("לא נמצא מזהה מורה");return}const x=t?.teaching?.studentIds||[];if(x.length===0){N([]),C({totalStudents:0,markedToday:0,presentToday:0,absentToday:0}),y(!1);return}const g=(await H.students.getBatchStudents(x)).map(async $=>{try{const c=await H.attendance.getIndividualLessonAttendance({studentId:$._id||$.id,teacherId:i,date:l});return{...$,attendanceStatus:c?.status||null,isMarking:!1}}catch{return{...$,attendanceStatus:null,isMarking:!1}}}),d=await Promise.all(g);N(d);const j=d.filter($=>$.attendanceStatus!==null),O=d.filter($=>$.attendanceStatus==="present"),p=d.filter($=>$.attendanceStatus==="absent");C({totalStudents:d.length,markedToday:j.length,presentToday:O.length,absentToday:p.length})}catch(i){console.error("Error loading students and attendance:",i),Ne.error("שגיאה בטעינת נתוני נוכחות")}finally{y(!1)}},E=async(i,x)=>{const A=t?._id||t?.teacherId||t?.id;if(!A){Ne.error("לא נמצא מזהה מורה");return}N(g=>g.map(d=>(d._id||d.id)===i?{...d,isMarking:!0}:d));try{const g={studentId:i,teacherId:A,date:l,status:x,lessonType:"individual"};await H.attendance.saveIndividualLessonAttendance(g),N(j=>j.map(O=>(O._id||O.id)===i?{...O,attendanceStatus:x,isMarking:!1}:O)),C(j=>{const O=b.find($=>($._id||$.id)===i)?.attendanceStatus!==null,p=b.find($=>($._id||$.id)===i)?.attendanceStatus==="present";return{...j,markedToday:O?j.markedToday:j.markedToday+1,presentToday:x==="present"?p?j.presentToday:j.presentToday+1:p?j.presentToday-1:j.presentToday,absentToday:x==="absent"?!p&&O?j.absentToday:j.absentToday+1:O&&!p?j.absentToday-1:j.absentToday}});const d=b.find(j=>(j._id||j.id)===i)?.personalInfo?.fullName||"התלמיד";Ne.success(x==="present"?`${d} סומן כנוכח ✓`:`${d} סומן כנעדר`,{duration:2e3})}catch(g){console.error("Error marking attendance:",g),Ne.error("שגיאה בסימון נוכחות"),N(d=>d.map(j=>(j._id||j.id)===i?{...j,isMarking:!1}:j))}},u=async i=>{const x=b.filter(d=>d.attendanceStatus===null);if(x.length===0){Ne("כל התלמידים כבר סומנו",{icon:"ℹ️"});return}N(d=>d.map(j=>j.attendanceStatus===null?{...j,isMarking:!0}:j));const A=i==="present"?"נוכחים":"נעדרים",g=Ne.loading(`מסמן ${x.length} תלמידים כ${A}...`);try{const d=x.map(j=>E(j._id||j.id,i));await Promise.all(d),Ne.success(`כל התלמידים סומנו כ${A} ✓`,{id:g})}catch{Ne.error("שגיאה בסימון נוכחות המונית",{id:g}),N(j=>j.map(O=>({...O,isMarking:!1})))}},L=()=>new Date().toLocaleDateString("he-IL",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),q=l===new Date().toISOString().split("T")[0];return v?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Ve,{className:"w-8 h-8 text-indigo-600 animate-spin mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"טוען נתוני נוכחות..."})]})}):b.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ye,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"אין תלמידים"}),e.jsx("p",{className:"text-gray-600",children:"טרם הוקצו לך תלמידים"})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:e.jsxs("div",{className:"flex items-center justify-between gap-4 flex-wrap",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(fe,{className:"w-5 h-5 text-indigo-600"}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"תאריך"}),e.jsx("input",{type:"date",value:l,onChange:i=>a(i.target.value),max:new Date().toISOString().split("T")[0],className:"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"})]})]}),q&&e.jsx("div",{className:"text-sm text-gray-600 font-medium",children:L()})]})}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx("div",{className:"bg-blue-50 rounded-lg border border-blue-200 p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-blue-600",children:"סה״כ תלמידים"}),e.jsx("p",{className:"text-2xl font-bold text-blue-700 mt-1",children:n.totalStudents})]}),e.jsx(ye,{className:"w-8 h-8 text-blue-400"})]})}),e.jsx("div",{className:"bg-green-50 rounded-lg border border-green-200 p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-green-600",children:"נוכחים"}),e.jsx("p",{className:"text-2xl font-bold text-green-700 mt-1",children:n.presentToday})]}),e.jsx(Ee,{className:"w-8 h-8 text-green-400"})]})}),e.jsx("div",{className:"bg-red-50 rounded-lg border border-red-200 p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-red-600",children:"נעדרים"}),e.jsx("p",{className:"text-2xl font-bold text-red-700 mt-1",children:n.absentToday})]}),e.jsx(_e,{className:"w-8 h-8 text-red-400"})]})}),e.jsx("div",{className:"bg-purple-50 rounded-lg border border-purple-200 p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-purple-600",children:"אחוז נוכחות"}),e.jsxs("p",{className:"text-2xl font-bold text-purple-700 mt-1",children:[n.markedToday>0?Math.round(n.presentToday/n.markedToday*100):0,"%"]})]}),e.jsx(Nt,{className:"w-8 h-8 text-purple-400"})]})})]}),n.markedToday<n.totalStudents&&e.jsx("div",{className:"bg-indigo-50 rounded-lg border border-indigo-200 p-4",children:e.jsxs("div",{className:"flex items-center justify-between gap-4 flex-wrap",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(pe,{className:"w-5 h-5 text-indigo-600"}),e.jsx("span",{className:"text-sm font-medium text-indigo-900",children:"סמן את כל התלמידים שטרם סומנו:"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>u("present"),className:"flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium",children:[e.jsx(Ee,{className:"w-4 h-4"}),"סמן הכל כנוכחים"]}),e.jsxs("button",{onClick:()=>u("absent"),className:"flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm font-medium",children:[e.jsx(_e,{className:"w-4 h-4"}),"סמן הכל כנעדרים"]})]})]})}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden",children:[e.jsx("div",{className:"bg-gray-50 px-6 py-3 border-b border-gray-200",children:e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"רשימת תלמידים"})}),e.jsx("div",{className:"divide-y divide-gray-200",children:b.map(i=>{const x=i._id||i.id;return e.jsx("div",{className:`px-6 py-4 hover:bg-gray-50 transition-colors ${i.isMarking?"opacity-60":""}`,children:e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0",children:e.jsx("span",{className:"text-indigo-600 font-semibold",children:i.personalInfo.fullName.split(" ").map(A=>A[0]).join("")})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("h4",{className:"font-medium text-gray-900 truncate",children:i.personalInfo.fullName}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[i.instrument&&e.jsx("span",{children:i.instrument}),i.academicInfo?.grade&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"•"}),e.jsxs("span",{children:["כיתה ",i.academicInfo.grade]})]})]})]})]})}),e.jsxs("div",{className:"flex-shrink-0",children:[i.attendanceStatus==="present"&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-3 py-1 rounded-full bg-green-100 text-green-800 text-sm font-medium",children:[e.jsx(Ee,{className:"w-4 h-4"}),"נוכח"]}),i.attendanceStatus==="absent"&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-3 py-1 rounded-full bg-red-100 text-red-800 text-sm font-medium",children:[e.jsx(_e,{className:"w-4 h-4"}),"נעדר"]}),i.attendanceStatus===null&&e.jsx("span",{className:"inline-flex items-center gap-1 px-3 py-1 rounded-full bg-gray-100 text-gray-600 text-sm font-medium",children:"לא סומן"})]}),e.jsxs("div",{className:"flex gap-2 flex-shrink-0",children:[e.jsxs("button",{onClick:()=>E(x,"present"),disabled:i.isMarking||i.attendanceStatus==="present",className:`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all ${i.attendanceStatus==="present"?"bg-green-100 text-green-700 cursor-default":"bg-green-600 text-white hover:bg-green-700 active:scale-95"} disabled:opacity-50 disabled:cursor-not-allowed`,children:[i.isMarking?e.jsx(Ve,{className:"w-4 h-4 animate-spin"}):e.jsx(Ee,{className:"w-4 h-4"}),"נוכח"]}),e.jsxs("button",{onClick:()=>E(x,"absent"),disabled:i.isMarking||i.attendanceStatus==="absent",className:`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all ${i.attendanceStatus==="absent"?"bg-red-100 text-red-700 cursor-default":"bg-red-600 text-white hover:bg-red-700 active:scale-95"} disabled:opacity-50 disabled:cursor-not-allowed`,children:[i.isMarking?e.jsx(Ve,{className:"w-4 h-4 animate-spin"}):e.jsx(_e,{className:"w-4 h-4"}),"נעדר"]})]})]})},x)})})]}),n.markedToday===n.totalStudents&&n.totalStudents>0&&e.jsx("div",{className:"bg-green-50 rounded-lg border border-green-200 p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ee,{className:"w-6 h-6 text-green-600 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-green-900",children:"כל התלמידים סומנו! ✓"}),e.jsxs("p",{className:"text-sm text-green-700",children:[n.presentToday," נוכחים • ",n.absentToday," נעדרים"]})]})]})})]})}function Vt(){const{user:t,checkAuthStatus:b}=Ie(),[N,v]=r.useState(!1),[y,l]=r.useState(!1),[a,n]=r.useState({type:null,message:""}),[C,w]=r.useState(null),[E,u]=r.useState({fullName:"",email:"",phone:"",address:"",birthDate:""});r.useEffect(()=>{L()},[]);const L=async()=>{try{l(!0);const g=await Ye.getMyProfile();w(g),u({fullName:g?.personalInfo?.fullName||"",email:g?.personalInfo?.email||"",phone:g?.personalInfo?.phone||"",address:g?.personalInfo?.address||"",birthDate:g?.personalInfo?.birthDate||""})}catch(g){console.error("Error fetching profile data:",g),n({type:"error",message:"שגיאה בטעינת פרטי הפרופיל"}),t&&u({fullName:t?.personalInfo?.fullName||"",email:t?.personalInfo?.email||t?.email||"",phone:t?.personalInfo?.phone||t?.phone||"",address:t?.personalInfo?.address||t?.address||"",birthDate:t?.personalInfo?.birthDate||t?.birthDate||""})}finally{l(!1)}},q=async()=>{try{l(!0),n({type:null,message:""});const g=await Ye.updateMyProfile(E);w(g),b&&await b(!0),v(!1),n({type:"success",message:"הפרופיל עודכן בהצלחה"}),setTimeout(()=>{n({type:null,message:""})},3e3)}catch(g){console.error("Error updating profile:",g),n({type:"error",message:"שגיאה בעדכון הפרופיל. אנא נסה שוב."})}finally{l(!1)}},i=()=>{const g=C||t;u({fullName:g?.personalInfo?.fullName||"",email:g?.personalInfo?.email||g?.email||"",phone:g?.personalInfo?.phone||g?.phone||"",address:g?.personalInfo?.address||g?.address||"",birthDate:g?.personalInfo?.birthDate||g?.birthDate||""}),v(!1),n({type:null,message:""})},x=g=>g?new Date(g).toLocaleDateString("he-IL"):"",A=C||t;return y&&!A?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"}),e.jsx("p",{className:"mt-4 text-gray-600 font-reisinger-yonatan",children:"טוען פרטי פרופיל..."})]})}):e.jsxs("div",{className:"space-y-6",children:[a.type&&e.jsxs("div",{className:`p-4 rounded-lg flex items-center gap-2 ${a.type==="success"?"bg-green-50 text-green-800 border border-green-200":"bg-red-50 text-red-800 border border-red-200"}`,children:[a.type==="success"?e.jsx(qe,{className:"w-5 h-5"}):e.jsx($e,{className:"w-5 h-5"}),e.jsx("span",{className:"font-reisinger-yonatan",children:a.message})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:"פרטים אישיים"}),N?e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:q,disabled:y,className:"flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[y?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}):e.jsx(rt,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"שמירה"})]}),e.jsxs("button",{onClick:i,disabled:y,className:"flex items-center gap-2 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(ve,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"ביטול"})]})]}):e.jsxs("button",{onClick:()=>v(!0),disabled:y,className:"flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(vt,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"עריכה"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 font-reisinger-yonatan",children:"שם מלא"}),N?e.jsx("input",{type:"text",value:E.fullName,onChange:g=>u(d=>({...d,fullName:g.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"rtl",placeholder:"הזן שם מלא"}):e.jsx("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:e.jsx("span",{className:"font-reisinger-yonatan",children:E.fullName||"לא צוין"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 font-reisinger-yonatan",children:'דוא"ל'}),N?e.jsx("input",{type:"email",value:E.email,onChange:g=>u(d=>({...d,email:g.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"ltr",placeholder:"example@email.com"}):e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:[e.jsx(wt,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"font-reisinger-yonatan",dir:"ltr",children:E.email||"לא צוין"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 font-reisinger-yonatan",children:"טלפון"}),N?e.jsx("input",{type:"tel",value:E.phone,onChange:g=>u(d=>({...d,phone:g.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"ltr",placeholder:"050-1234567"}):e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:[e.jsx(tt,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"font-reisinger-yonatan",dir:"ltr",children:E.phone||"לא צוין"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 font-reisinger-yonatan",children:"כתובת"}),N?e.jsx("input",{type:"text",value:E.address,onChange:g=>u(d=>({...d,address:g.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"rtl",placeholder:"הזן כתובת"}):e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:[e.jsx(ke,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"font-reisinger-yonatan",children:E.address||"לא צוין"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 font-reisinger-yonatan",children:"תאריך לידה"}),N?e.jsx("input",{type:"date",value:E.birthDate,onChange:g=>u(d=>({...d,birthDate:g.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"}):e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:[e.jsx(fe,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"font-reisinger-yonatan",children:x(E.birthDate)||"לא צוין"})]})]})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("h4",{className:"text-lg font-semibold text-blue-900 mb-2 font-reisinger-yonatan",children:"מידע תפקיד"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-sm font-medium text-blue-700 font-reisinger-yonatan",children:"תפקיד:"}),e.jsx("div",{className:"text-blue-900 font-reisinger-yonatan",children:(()=>{const g=A?.roles||[];if(g.length>0)return g.join(", ");const d=A?.role||"";switch(d){case"teacher":return"מורה";case"מורה":return"מורה";case"conductor":return"מנצח";case"מנצח":return"מנצח";case"theory_teacher":return"מורה תיאוריה";case"מורה תיאוריה":return"מורה תיאוריה";case"admin":return"מנהל";case"מנהל":return"מנהל";default:return d||"לא צוין"}})()})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-sm font-medium text-blue-700 font-reisinger-yonatan",children:"מזהה משתמש:"}),e.jsx("div",{className:"text-blue-900 font-reisinger-yonatan font-mono text-sm",children:A?.teacherId||A?._id||A?.id||"לא צוין"})]}),A?.isActive!==void 0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-sm font-medium text-blue-700 font-reisinger-yonatan",children:"סטטוס:"}),e.jsx("div",{className:"text-blue-900 font-reisinger-yonatan",children:A.isActive?"פעיל":"לא פעיל"})]}),A?.professionalInfo?.instrument&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-sm font-medium text-blue-700 font-reisinger-yonatan",children:"כלי נגינה:"}),e.jsx("div",{className:"text-blue-900 font-reisinger-yonatan",children:A.professionalInfo.instrument})]})]})]})]})}function as(){const{user:t}=Ie(),b=ht();ft();const[N,v]=r.useState("general"),[y,l]=r.useState(null),[a,n]=r.useState(!0),[C,w]=r.useState(null);r.useEffect(()=>{const c=b.state;if(c?.activeTab){v(c.activeTab),window.history.replaceState(null,"",window.location.pathname);return}const I=new URLSearchParams(b.search),R=I.get("tab"),_=I.get("action");R&&v(R),_&&w(_),(R||_)&&window.history.replaceState(null,"",window.location.pathname)},[b]),r.useEffect(()=>{t&&E()},[t]);const E=async()=>{try{if(n(!0),!(t?._id||t?.teacherId||t?.id)){console.warn("No user ID available for loading profile statistics");return}const I=await Ye.getMyProfile();if(!I){console.warn("No teacher profile found"),l({studentsCount:0,activeStudents:0,weeklyHours:0,orchestrasCount:0,theoryLessonsCount:0});return}const R=I?.teaching?.studentIds||[],_=I?.conducting?.orchestraIds||[],Y=I?.teaching?.timeBlocks||[],[ne,k]=await Promise.allSettled([R.length>0?H.students.getBatchStudents(R):Promise.resolve([]),_.length>0?H.orchestras.getBatchOrchestras(_):Promise.resolve([])]),W=ne.status==="fulfilled"?ne.value:[];ne.status==="rejected"&&console.error("Failed to load student data:",ne.reason);const V=k.status==="fulfilled"?k.value:[];k.status==="rejected"&&console.error("Failed to load orchestra data:",k.reason);const F=Array.isArray(W)?W.filter(S=>S.academicInfo?.isActive!==!1):[],K=Array.isArray(Y)?Y.reduce((S,J)=>S+(parseInt(J.totalDuration)||0),0):0,Z=Math.round(K/60*10)/10;l({studentsCount:Array.isArray(W)?W.length:0,activeStudents:F.length,weeklyHours:Z,orchestrasCount:Array.isArray(V)?V.length:0,theoryLessonsCount:0})}catch(c){console.error("Error loading profile statistics:",c),l({studentsCount:0,activeStudents:0,weeklyHours:0,orchestrasCount:0,theoryLessonsCount:0})}finally{n(!1)}};if(!t)return e.jsx("div",{className:"flex items-center justify-center min-h-96",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600",children:"טוען פרטי משתמש..."})]})});const u=()=>t?.roles?.includes("conductor")||t?.roles?.includes("מנצח")||t?.conducting?.orchestraIds&&t.conducting.orchestraIds.length>0,L=()=>t?.roles?.includes("teacher")||t?.roles?.includes("מורה")||t?.teaching?.studentIds&&t.teaching.studentIds.length>0,q=()=>t?.roles?.includes("theory_teacher")||t?.roles?.includes("מורה תאוריה"),x=(()=>{const I=[...[{id:"general",label:"פרטים כלליים",icon:De,component:Vt}]];return L()&&(I.push({id:"students",label:"התלמידים שלי",icon:ye,component:Lt}),I.push({id:"schedule",label:"לוח זמנים שבועי",icon:fe,component:Ot}),t?.teaching?.studentIds&&t.teaching.studentIds.length>0&&I.push({id:"attendance",label:"נוכחות",icon:Oe,component:Qt})),u()&&I.push({id:"orchestras",label:"התזמורות שלי",icon:Ce,component:Et}),q()&&I.push({id:"lessons",label:"שיעורי התיאוריה שלי",icon:Pe,component:zt}),I})(),g=(x.find(c=>c.id===N)||x[0]).component,d={};N==="students"&&C&&(d.action=C);const j=()=>{const c=t?.role||t?.roles?.[0]||"";switch(c){case"teacher":return"מורה";case"מורה":return"מורה";case"conductor":return"מנצח";case"מנצח":return"מנצח";case"theory_teacher":return"מורה תיאוריה";case"מורה תיאוריה":return"מורה תיאוריה";case"admin":return"מנהל";case"מנהל":return"מנהל";default:return c||"משתמש"}},O=()=>t?.personalInfo?.fullName||t?.fullName||t?.name||"משתמש",p=()=>{const c=O();if(!c||c==="משתמש")return"מ";const I=c.trim().split(" ");return I.length>=2?I[0][0]+I[1][0]:I[0][0]||"מ"},$=()=>t?.personalInfo?.email||t?.email||"";return e.jsxs("div",{className:"p-6",dir:"rtl",children:[e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-indigo-600 flex items-center justify-center",children:e.jsx("span",{className:"text-xl font-bold text-white font-reisinger-yonatan",children:p()})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 font-reisinger-yonatan",children:O()}),e.jsxs("p",{className:"text-gray-600 mt-1",children:[j()," • ",$()]})]})]})}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-6",children:[e.jsx(Fe,{title:"סה״כ תלמידים",value:a?"...":y?.studentsCount?.toString()||"0",icon:ye,color:"blue",loading:a}),e.jsx(Fe,{title:"תלמידים פעילים",value:a?"...":y?.activeStudents?.toString()||"0",icon:St,color:"green",loading:a}),e.jsx(Fe,{title:"שעות שבועיות",value:a?"...":y?.weeklyHours?.toString()||"0",icon:pe,color:"purple",loading:a}),e.jsx(Fe,{title:u()?"תזמורות":"שיעורי תיאוריה",value:a?"...":(y?.orchestrasCount||y?.theoryLessonsCount)?.toString()||"0",icon:u()?Ce:Pe,color:"indigo",loading:a})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 mb-6",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsx("nav",{className:"flex gap-0 overflow-x-auto scrollbar-hide",children:x.map(c=>{const I=c.icon;return e.jsxs("button",{onClick:()=>v(c.id),className:`flex items-center gap-2 sm:gap-3 px-3 sm:px-6 py-3 sm:py-4 font-medium text-xs sm:text-sm transition-all whitespace-nowrap ${N===c.id?"text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50":"text-gray-500 hover:text-gray-700 hover:bg-gray-50"}`,children:[e.jsx(I,{className:"w-5 h-5"}),e.jsx("span",{className:"font-reisinger-yonatan",children:c.label})]},c.id)})})}),e.jsx("div",{className:"p-6",children:e.jsx(g,{...d})})]})]})}function Fe({title:t,value:b,icon:N,color:v,loading:y}){const a={blue:{bg:"bg-blue-50",text:"text-blue-600",border:"border-blue-200"},green:{bg:"bg-green-50",text:"text-green-600",border:"border-green-200"},purple:{bg:"bg-purple-50",text:"text-purple-600",border:"border-purple-200"},indigo:{bg:"bg-indigo-50",text:"text-indigo-600",border:"border-indigo-200"}}[v];return e.jsx("div",{className:`bg-white rounded-lg border ${a.border} p-3 sm:p-4 shadow-sm hover:shadow-md transition-all duration-200`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-xs sm:text-sm font-medium text-gray-600 font-reisinger-yonatan truncate",children:t}),e.jsx("div",{className:"text-lg sm:text-2xl font-bold text-gray-900 mt-1 font-reisinger-yonatan",children:y?e.jsx("div",{className:"animate-pulse bg-gray-200 h-6 sm:h-8 w-12 sm:w-16 rounded"}):b})]}),e.jsx("div",{className:`${a.bg} p-2 sm:p-3 rounded-full flex-shrink-0 ml-2`,children:e.jsx(N,{className:`w-4 h-4 sm:w-6 sm:h-6 ${a.text}`})})]})})}export{as as default};
