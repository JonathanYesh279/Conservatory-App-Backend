import{j as e,u as je,V as Ee}from"../assets/index-DnlL1uC7.js";import{R as Ke,r as n,u as Ze,b as Ye}from"./vendor-B2j9q2e_.js";import{a as B,t as De}from"./cascade-deletion-C7j5aisD.js";import{M as ye,J as Me,O as ke,T as Ie,U as we,e as ge,Z as We,b as ne,d as re,r as qe,u as et,c as Ae,A as Oe,t as le,m as ue,X as ve,f as ae,P as be,ab as ze,i as tt,E as st,ac as at,B as Se,v as _e,g as rt,G as Re,W as Be,an as nt,j as it,ah as lt,S as ot,a3 as ct,K as dt}from"./ui-26XYoSED.js";import{C as mt}from"./ConfirmationModal-6LP76O7f.js";import{t as Fe}from"./theoryEnrollmentService-Bg5HiXhn.js";import"./query-BI61muSV.js";import"./utils-Cgyyg58q.js";function ut({student:s,onEdit:N,onDelete:S,onViewDetails:p,onScheduleLesson:h,onMarkAttendance:o,onAddNote:d,className:i=""}){const g=s.academicInfo?.instrumentProgress?.find(u=>u.isPrimary)||s.academicInfo?.instrumentProgress?.[0],L=g?.instrumentName||"לא הוגדר",y=g?.currentStage||0,m=s.scheduleInfo||s.teacherAssignments?.[0],z=m?`${m.day} ${m.startTime||m.time}`:null,H=m?.duration||60,l=!!m,b=s.academicInfo?.isActive!==!1&&s.status!=="inactive",k=b?"text-green-800 bg-green-100":"text-red-800 bg-red-100",f=b?"פעיל":"לא פעיל",E=b?Ae:Oe,X=l?"border-2 border-green-400 shadow-sm shadow-green-200":"border border-gray-200";return e.jsxs("div",{className:`bg-white ${X} rounded-lg hover:shadow-lg hover:border-indigo-300 transition-all duration-200 transform hover:-translate-y-1 group ${i}`,children:[e.jsx("div",{className:"px-4 py-3 border-b border-gray-100",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h4",{className:"font-semibold text-gray-900 font-reisinger-yonatan text-lg",children:s.personalInfo.fullName}),e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${k}`,children:[Ke.createElement(E,{className:"w-3 h-3"}),f]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(ye,{className:"w-4 h-4 text-indigo-500"}),e.jsx("span",{className:"font-reisinger-yonatan font-medium",children:L}),y>0&&e.jsxs("span",{className:"text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full font-reisinger-yonatan",children:["שלב ",y]})]})]}),e.jsxs("div",{className:"flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:[e.jsx("button",{onClick:()=>p(s.id),className:"p-1.5 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all duration-200",title:"צפה בפרטים מלאים",children:e.jsx(Me,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>N(s),className:"p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all duration-200",title:"עריכת תלמיד",children:e.jsx(ke,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>S(s.id),className:"p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all duration-200",title:"מחיקת תלמיד",children:e.jsx(Ie,{className:"w-4 h-4"})})]})]})}),e.jsxs("div",{className:"px-4 py-3 space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{className:"space-y-1",children:[s.personalInfo.age&&e.jsxs("div",{className:"flex items-center gap-2 text-gray-600",children:[e.jsx(we,{className:"w-3 h-3"}),e.jsxs("span",{className:"font-reisinger-yonatan",children:["גיל: ",s.personalInfo.age]})]}),s.personalInfo.class&&e.jsxs("div",{className:"flex items-center gap-2 text-gray-600",children:[e.jsx(ge,{className:"w-3 h-3"}),e.jsxs("span",{className:"font-reisinger-yonatan",children:["כיתה: ",s.personalInfo.class]})]})]}),e.jsx("div",{className:"space-y-1",children:s.personalInfo.phone&&e.jsxs("div",{className:"flex items-center gap-2 text-gray-600",dir:"ltr",children:[e.jsx(We,{className:"w-3 h-3"}),e.jsx("span",{className:"font-mono text-xs",children:s.personalInfo.phone})]})})]}),z&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-blue-800 font-reisinger-yonatan",children:[e.jsx(ne,{className:"w-4 h-4"}),e.jsx("span",{className:"font-medium",children:"שיעור קבוע:"})]}),e.jsxs("div",{className:"flex items-center justify-between mt-1",children:[e.jsx("span",{className:"text-sm font-reisinger-yonatan text-blue-700",children:z}),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-blue-600",children:[e.jsx(re,{className:"w-3 h-3"}),e.jsxs("span",{children:[H," דק'"]})]})]})]})]}),e.jsx("div",{className:"px-4 py-3 border-t border-gray-100 bg-gray-50",children:e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("button",{onClick:()=>p(s.id),className:"text-indigo-600 hover:text-indigo-800 hover:bg-indigo-100 px-3 py-1 rounded-lg text-sm font-medium font-reisinger-yonatan transition-all duration-200 flex items-center gap-1",children:[e.jsx(Me,{className:"w-4 h-4"}),"פרטים מלאים"]}),h&&e.jsxs("button",{onClick:()=>h(s.id),className:"text-green-600 hover:text-green-800 hover:bg-green-100 px-3 py-1 rounded-lg text-sm font-medium font-reisinger-yonatan transition-all duration-200 flex items-center gap-1",children:[e.jsx(ne,{className:"w-4 h-4"}),"קבע שיעור"]}),o&&e.jsxs("button",{onClick:()=>o(s.id),className:"text-blue-600 hover:text-blue-800 hover:bg-blue-100 px-3 py-1 rounded-lg text-sm font-medium font-reisinger-yonatan transition-all duration-200 flex items-center gap-1",children:[e.jsx(qe,{className:"w-4 h-4"}),"נוכחות"]}),d&&e.jsxs("button",{onClick:()=>d(s.id),className:"text-yellow-600 hover:text-yellow-800 hover:bg-yellow-100 px-3 py-1 rounded-lg text-sm font-medium font-reisinger-yonatan transition-all duration-200 flex items-center gap-1",children:[e.jsx(et,{className:"w-4 h-4"}),"הערה"]})]})})]})}function gt(){const{user:s}=je(),[N,S]=n.useState([]),[p,h]=n.useState(!0),[o,d]=n.useState("");n.useState(!1),n.useState(null);const[i,g]=n.useState(null),[L,y]=n.useState(0);n.useState(!1);const[m,z]=n.useState({status:"all",instrument:"all",hasSchedule:"all",bagrutStatus:"all"});n.useState("cards"),n.useState(new Set),n.useState(!1);const[H,l]=n.useState(!1),[b,k]=n.useState([]),[f,E]=n.useState(!1);n.useEffect(()=>{X()},[s]);const X=async(x=!0)=>{if(s?._id)try{x&&h(!0),g(null);const F=s._id,$=await B.teachers.getTeacher(F);if(!$)throw new Error("לא נמצא פרופיל מורה");const w=$?.teaching?.studentIds||[];if(w.length===0){console.log("No students assigned to teacher"),S([]),y(0);return}const D=await B.students.getBatchStudents(w);if(!Array.isArray(D))throw new Error("תגובה לא תקינה מהשרת");const U=D.filter(A=>w.includes(A._id)||w.includes(A.id));U.length!==D.length&&console.warn(`🔧 Component-level filtering: ${U.length}/${D.length} students match teacher's student IDs`);const Q=U.map(A=>{const te=A.personalInfo?.fullName||"",ie=te.split(" ");return{id:A._id,firstName:A.personalInfo?.firstName||ie[0]||"",lastName:A.personalInfo?.lastName||ie.slice(1).join(" ")||"",fullName:te,email:A.personalInfo?.email||A.contactInfo?.email||"",phone:A.personalInfo?.phone||A.contactInfo?.phone||"",instrument:A.academicInfo?.primaryInstrument||A.primaryInstrument||"",grade:A.academicInfo?.gradeLevel||"",status:A.academicInfo?.isActive!==!1?"active":"inactive",joinDate:A.createdAt,personalInfo:{fullName:te,phone:A.personalInfo?.phone||A.contactInfo?.phone,age:A.personalInfo?.age,class:A.personalInfo?.class||A.academicInfo?.class},academicInfo:{instrumentProgress:A.academicInfo?.instrumentProgress||[],isActive:A.academicInfo?.isActive!==!1},teacherAssignments:A.teacherAssignments||[],scheduleInfo:A.scheduleInfo}});S(Q),y(0)}catch(F){console.error("Error loading teacher students:",F),g("שגיאה בטעינת רשימת התלמידים. בדוק את החיבור לאינטרנט ונסה שוב."),y($=>$+1)}finally{x&&h(!1)}},u=async()=>{try{E(!0);const x=await B.students.getStudents();if(!x||!Array.isArray(x)){console.error("Invalid response from getStudents"),k([]);return}const F=s?._id,w=(await B.teachers.getTeacher(F))?.teaching?.studentIds||[],D=x.filter(U=>!w.includes(U._id)&&!w.includes(U.id));k(D)}catch(x){console.error("Error loading all students:",x),k([])}finally{E(!1)}},v=N.filter(x=>{const F=o===""||`${x.firstName} ${x.lastName}`.toLowerCase().includes(o.toLowerCase())||x.instrument?.toLowerCase().includes(o.toLowerCase())||x.email?.toLowerCase().includes(o.toLowerCase()),$=m.status==="all"||x.status===m.status,w=m.instrument==="all"||x.instrument===m.instrument,D=x.scheduleInfo||x.teacherAssignments?.length>0,U=m.hasSchedule==="all"||m.hasSchedule==="yes"&&D||m.hasSchedule==="no"&&!D,Q=x.academicInfo?.isBagrutStudent||x.academicInfo?.instrumentProgress?.some(te=>te.currentStage>=4),A=m.bagrutStatus==="all"||m.bagrutStatus==="yes"&&Q||m.bagrutStatus==="no"&&!Q;return F&&$&&w&&U&&A}),R=async x=>{const F=N.find(w=>w.id===x),$=F?.personalInfo?.fullName||F?.fullName||"התלמיד";if(window.confirm(`האם אתה בטוח שברצונך למחוק את ${$}?

פעולה זו תמחק את כל הנתונים הקשורים לתלמיד ולא ניתנת לביטול.`))try{await B.students.deleteStudent(x),S(D=>D.filter(U=>U.id!==x));const w=document.createElement("div");w.className="fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg z-50",w.innerHTML=`<div class="flex items-center gap-2 font-reisinger-yonatan"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>${$} נמחק בהצלחה</div>`,document.body.appendChild(w),setTimeout(()=>w.remove(),3e3)}catch(w){console.error("Error deleting student:",w);const D=document.createElement("div");D.className="fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg z-50",D.innerHTML=`<div class="flex items-center gap-2 font-reisinger-yonatan"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>שגיאה במחיקת ${$}</div>`,document.body.appendChild(D),setTimeout(()=>D.remove(),5e3)}},C=x=>{window.location.href=`/students/${x}`},G=x=>{N.find($=>$.id===x)&&(window.location.href=`/teacher/schedule?student=${x}`)},O=(x,F)=>{const $=document.createElement("div");$.className=`fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 ${F==="success"?"bg-green-500 text-white":F==="error"?"bg-red-500 text-white":"bg-blue-500 text-white"}`,$.innerHTML=`<div class="flex items-center gap-2 font-reisinger-yonatan">
      ${F==="success"?"✅":F==="error"?"❌":"ℹ️"} ${x}
    </div>`,document.body.appendChild($),setTimeout(()=>$.remove(),3e3)},V=async(x,F)=>{try{const $=s?._id,w=await B.students.getStudent(x._id),D=(w.teacherAssignments||[]).findIndex(A=>A.teacherId===$),U={teacherId:$,day:F.lessonDay,time:F.lessonTime,duration:F.lessonDuration||45,location:F.lessonLocation||"",isActive:!0};let Q;D>=0?(Q=[...w.teacherAssignments||[]],Q[D]={...Q[D],...U}):Q=[...w.teacherAssignments||[],U],await B.students.updateStudent(x._id,{teacherAssignments:Q}),await X(),O(`${x.personalInfo?.fullName} הוקצה בהצלחה`,"success"),l(!1)}catch($){console.error("Error assigning student:",$),O("שגיאה בהקצאת התלמיד","error")}};return p?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600",children:"טוען רשימת תלמידים..."})]})}):i?e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-red-100 flex items-center justify-center",children:e.jsx("svg",{className:"w-4 h-4 text-red-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.728-.833-2.498 0L4.316 15.5c-.77.833.192 2.5 1.732 2.5z"})})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-red-800 font-semibold font-reisinger-yonatan",children:"שגיאה בטעינת הנתונים"}),e.jsx("p",{className:"text-red-700 text-sm font-reisinger-yonatan mt-1",children:i})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>X(),className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm font-reisinger-yonatan",children:"נסה שוב"}),L>2&&e.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm font-reisinger-yonatan",children:"רענן דף"})]})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:"התלמידים שלי"}),e.jsxs("p",{className:"text-gray-600 mt-1",children:[N.length," תלמידים רשומים"]})]}),e.jsxs("button",{onClick:()=>{l(!0),u()},className:"flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors",children:[e.jsx(le,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"הקצה תלמיד"})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(ue,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"חיפוש תלמידים...",value:o,onChange:x=>d(x.target.value),className:"w-full pl-4 pr-12 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"rtl"})]}),v.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(le,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2 font-reisinger-yonatan",children:o?"לא נמצאו תלמידים":"אין תלמידים רשומים"}),e.jsx("p",{className:"text-gray-600 font-reisinger-yonatan",children:o?"נסה מילות חיפוש אחרות":"התחל בהוספת התלמיד הראשון שלך"}),!o&&e.jsxs("button",{onClick:()=>{l(!0),u()},className:"mt-4 inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-reisinger-yonatan",children:[e.jsx(le,{className:"w-4 h-4"}),"הקצה תלמיד ראשון"]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{className:"w-5 h-5 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-900 font-reisinger-yonatan",children:"סה״כ תלמידים"})]}),e.jsx("div",{className:"text-2xl font-bold text-blue-900 mt-1",children:N.length})]}),e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Me,{className:"w-5 h-5 text-green-600"}),e.jsx("span",{className:"font-medium text-green-900 font-reisinger-yonatan",children:"פעילים"})]}),e.jsx("div",{className:"text-2xl font-bold text-green-900 mt-1",children:N.filter(x=>x.status==="active").length})]}),e.jsxs("div",{className:"bg-purple-50 border border-purple-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ne,{className:"w-5 h-5 text-purple-600"}),e.jsx("span",{className:"font-medium text-purple-900 font-reisinger-yonatan",children:"עם שיעורים"})]}),e.jsx("div",{className:"text-2xl font-bold text-purple-900 mt-1",children:N.filter(x=>x.scheduleInfo||x.teacherAssignments?.length>0).length})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6",children:v.map(x=>e.jsx(ut,{student:x,onEdit:F=>{alert("עריכת תלמיד זמינה רק למנהלים")},onDelete:R,onViewDetails:C,onScheduleLesson:G},x.id))})]}),H&&e.jsx(xt,{allStudents:b,loading:f,onClose:()=>{l(!1),k([])},onSubmit:V})]})}function xt({allStudents:s,loading:N,onClose:S,onSubmit:p}){const[h,o]=n.useState(""),[d,i]=n.useState(null),[g,L]=n.useState({instrument:"",lessonDay:"",lessonTime:"",lessonDuration:45,lessonLocation:""}),[y,m]=n.useState(!1),z=s.filter(l=>{const b=h.toLowerCase().trim();if(!b)return!0;const k=l.personalInfo?.fullName||`${l.personalInfo?.firstName||""} ${l.personalInfo?.lastName||""}`.trim(),f=l.personalInfo?.class||l.academicInfo?.class||"",E=[l.academicInfo?.primaryInstrument,...l.academicInfo?.instrumentProgress?.map(v=>v.instrumentName)||[]].filter(Boolean).join(" "),X=`${k} ${f} ${E}`.toLowerCase();return b.split(/\s+/).filter(v=>v.length>0).every(v=>X.includes(v))}),H=async l=>{if(l.preventDefault(),!d){alert("אנא בחר תלמיד");return}if(!g.instrument){alert("אנא בחר כלי נגינה");return}m(!0);try{await p(d,g)}catch(b){console.error("Error submitting assignment:",b)}finally{m(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-hidden flex flex-col",dir:"rtl",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 mb-4 font-reisinger-yonatan",children:"הקצאת תלמיד קיים"}),N?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"}),e.jsx("span",{className:"mr-3 text-gray-600",children:"טוען רשימת תלמידים..."})]}):e.jsxs("form",{onSubmit:H,className:"flex flex-col flex-1 overflow-hidden",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:"חפש תלמיד במערכת"}),e.jsxs("div",{className:"relative",children:[e.jsx(ue,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"חפש לפי שם, כיתה או כלי נגינה...",value:h,onChange:l=>o(l.target.value),className:"w-full pl-4 pr-12 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"rtl"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto mb-4 border border-gray-200 rounded-lg",children:z.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:h?"לא נמצאו תלמידים התואמים את החיפוש":"אין תלמידים זמינים להקצאה"}):e.jsx("div",{className:"divide-y divide-gray-200",children:z.map(l=>{const b=l.personalInfo?.fullName||`${l.personalInfo?.firstName||""} ${l.personalInfo?.lastName||""}`.trim(),k=l.personalInfo?.class||l.academicInfo?.class||"",f=l.academicInfo?.primaryInstrument||"",E=d?._id===l._id;return e.jsx("div",{onClick:()=>i(l),className:`p-3 cursor-pointer transition-colors ${E?"bg-indigo-50 border-r-4 border-indigo-600":"hover:bg-gray-50"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:b}),e.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:[k&&e.jsxs("span",{children:["כיתה ",k]}),f&&e.jsxs(e.Fragment,{children:[k&&" • ",e.jsx("span",{children:f})]})]})]}),E&&e.jsx("div",{className:"w-6 h-6 bg-indigo-600 rounded-full flex items-center justify-center",children:e.jsx(qe,{className:"w-4 h-4 text-white"})})]})},l._id)})})}),d&&e.jsxs("div",{className:"space-y-4 border-t pt-4",children:[e.jsxs("h4",{className:"font-medium text-gray-900 font-reisinger-yonatan",children:["פרטי השיעור עבור ",d.personalInfo?.fullName]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"כלי נגינה לשיעור *"}),e.jsxs("select",{value:g.instrument,onChange:l=>L(b=>({...b,instrument:l.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",required:!0,children:[e.jsx("option",{value:"",children:"בחר כלי נגינה"}),e.jsx("option",{value:"פסנתר",children:"פסנתר"}),e.jsx("option",{value:"כינור",children:"כינור"}),e.jsx("option",{value:"צ'לו",children:"צ'לו"}),e.jsx("option",{value:"ויולה",children:"ויולה"}),e.jsx("option",{value:"חצוצרה",children:"חצוצרה"}),e.jsx("option",{value:"טרומבון",children:"טרומבון"}),e.jsx("option",{value:"קלרינט",children:"קלרינט"}),e.jsx("option",{value:"חליל",children:"חליל"}),e.jsx("option",{value:"סקסופון",children:"סקסופון"}),e.jsx("option",{value:"הורן",children:"הורן"}),e.jsx("option",{value:"טובה",children:"טובה"}),e.jsx("option",{value:"כלי הקשה",children:"כלי הקשה"}),e.jsx("option",{value:"גיטרה",children:"גיטרה"}),e.jsx("option",{value:"קונטרבס",children:"קונטרבס"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"יום בשבוע"}),e.jsxs("select",{value:g.lessonDay,onChange:l=>L(b=>({...b,lessonDay:l.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"",children:"בחר יום"}),e.jsx("option",{value:"ראשון",children:"יום ראשון"}),e.jsx("option",{value:"שני",children:"יום שני"}),e.jsx("option",{value:"שלישי",children:"יום שלישי"}),e.jsx("option",{value:"רביעי",children:"יום רביעי"}),e.jsx("option",{value:"חמישי",children:"יום חמישי"}),e.jsx("option",{value:"שישי",children:"יום שישי"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שעת התחלה"}),e.jsx("input",{type:"time",value:g.lessonTime,onChange:l=>L(b=>({...b,lessonTime:l.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"משך (דקות)"}),e.jsx("input",{type:"number",min:"15",max:"120",step:"15",value:g.lessonDuration,onChange:l=>L(b=>({...b,lessonDuration:parseInt(l.target.value)})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"מיקום"}),e.jsxs("select",{value:g.lessonLocation,onChange:l=>L(b=>({...b,lessonLocation:l.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"",children:"בחר חדר"}),Ee.map(l=>e.jsx("option",{value:l,children:l},l))]})]})]})]}),e.jsxs("div",{className:"flex gap-3 mt-6 pt-4 border-t",children:[e.jsx("button",{type:"submit",disabled:!d||!g.instrument||y,className:"flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 font-reisinger-yonatan flex items-center justify-center gap-2",children:y?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"מקצה..."]}):e.jsxs(e.Fragment,{children:[e.jsx(le,{className:"w-4 h-4"}),"הקצה תלמיד"]})}),e.jsxs("button",{type:"button",onClick:S,disabled:y,className:"flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 font-reisinger-yonatan flex items-center justify-center gap-2",children:[e.jsx(ve,{className:"w-4 h-4"}),"ביטול"]})]})]})]})})}function ht({isOpen:s,onClose:N,orchestraId:S,orchestraName:p,onSave:h}){const[o,d]=n.useState({date:"",startTime:"19:00",endTime:"21:00",location:"אולם מוזיקה",notes:"",recurring:!1,recurrencePattern:"weekly",endRecurrence:""}),[i,g]=n.useState({}),[L,y]=n.useState(!1);n.useEffect(()=>{if(s){const l=new Date;l.setDate(l.getDate()+1),d(b=>({...b,date:l.toISOString().split("T")[0]}))}},[s]);const m=()=>{const l={};if(!o.date)l.date="יש לבחור תאריך";else{const b=new Date(o.date),k=new Date;k.setHours(0,0,0,0),b<k&&(l.date="לא ניתן לקבוע חזרה בעבר")}if(o.startTime||(l.startTime="יש לבחור שעת התחלה"),o.endTime||(l.endTime="יש לבחור שעת סיום"),o.startTime&&o.endTime){const b=new Date(`2000-01-01T${o.startTime}`);new Date(`2000-01-01T${o.endTime}`)<=b&&(l.endTime="שעת הסיום חייבת להיות אחרי שעת ההתחלה")}return o.location.trim()||(l.location="יש לציין מקום"),o.recurring&&!o.endRecurrence&&(l.endRecurrence="יש לציין תאריך סיום לחזרות קבועות"),g(l),Object.keys(l).length===0},z=async l=>{if(l.preventDefault(),!!m()){y(!0);try{await h(o),N(),d({date:"",startTime:"19:00",endTime:"21:00",location:"אולם מוזיקה",notes:"",recurring:!1,recurrencePattern:"weekly",endRecurrence:""})}catch(b){console.error("Error saving rehearsal:",b)}finally{y(!1)}}},H=()=>{if(!o.startTime||!o.endTime)return"";const l=new Date(`2000-01-01T${o.startTime}`),k=(new Date(`2000-01-01T${o.endTime}`).getTime()-l.getTime())/(1e3*60);if(k<=0)return"";const f=Math.floor(k/60),E=k%60;return f===0?`${E} דקות`:E===0?`${f} שעות`:`${f} שעות ו-${E} דקות`};return s?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900 font-reisinger-yonatan",children:"קביעת חזרה חדשה"}),e.jsx("button",{onClick:N,className:"p-1 text-gray-400 hover:text-gray-600 rounded",children:e.jsx(ve,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center gap-2 text-blue-800",children:[e.jsx(ae,{className:"w-4 h-4"}),e.jsxs("span",{className:"font-medium font-reisinger-yonatan",children:["תזמורת: ",p]})]})}),e.jsxs("form",{onSubmit:z,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"תאריך החזרה *"}),e.jsxs("div",{className:"relative",children:[e.jsx(ne,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"date",required:!0,value:o.date,onChange:l=>d(b=>({...b,date:l.target.value})),className:`w-full pl-3 pr-10 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 ${i.date?"border-red-300":"border-gray-300"}`})]}),i.date&&e.jsx("p",{className:"text-red-600 text-xs mt-1 font-reisinger-yonatan",children:i.date})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שעת התחלה *"}),e.jsxs("div",{className:"relative",children:[e.jsx(re,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"time",required:!0,value:o.startTime,onChange:l=>d(b=>({...b,startTime:l.target.value})),className:`w-full pl-3 pr-10 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 ${i.startTime?"border-red-300":"border-gray-300"}`})]}),i.startTime&&e.jsx("p",{className:"text-red-600 text-xs mt-1 font-reisinger-yonatan",children:i.startTime})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שעת סיום *"}),e.jsxs("div",{className:"relative",children:[e.jsx(re,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"time",required:!0,value:o.endTime,onChange:l=>d(b=>({...b,endTime:l.target.value})),className:`w-full pl-3 pr-10 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 ${i.endTime?"border-red-300":"border-gray-300"}`})]}),i.endTime&&e.jsx("p",{className:"text-red-600 text-xs mt-1 font-reisinger-yonatan",children:i.endTime})]})]}),H()&&e.jsxs("div",{className:"text-sm text-gray-600 bg-gray-50 p-2 rounded font-reisinger-yonatan",children:["משך החזרה: ",H()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"מקום החזרה *"}),e.jsxs("div",{className:"relative",children:[e.jsx(ge,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"text",required:!0,value:o.location,onChange:l=>d(b=>({...b,location:l.target.value})),className:`w-full pl-3 pr-10 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 ${i.location?"border-red-300":"border-gray-300"}`,placeholder:"למשל: אולם מוזיקה, חדר 101"})]}),i.location&&e.jsx("p",{className:"text-red-600 text-xs mt-1 font-reisinger-yonatan",children:i.location})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"הערות"}),e.jsx("textarea",{value:o.notes,onChange:l=>d(b=>({...b,notes:l.target.value})),rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",placeholder:"הערות נוספות על החזרה (אופציונלי)"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{id:"recurring",type:"checkbox",checked:o.recurring,onChange:l=>d(b=>({...b,recurring:l.target.checked})),className:"h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"}),e.jsx("label",{htmlFor:"recurring",className:"mr-2 text-sm text-gray-700 font-reisinger-yonatan",children:"חזרה קבועה (חוזרת)"})]}),o.recurring&&e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"תדירות"}),e.jsxs("select",{value:o.recurrencePattern,onChange:l=>d(b=>({...b,recurrencePattern:l.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"weekly",children:"שבועי"}),e.jsx("option",{value:"biweekly",children:"דו-שבועי"}),e.jsx("option",{value:"monthly",children:"חודשי"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"תאריך סיום החזרות הקבועות *"}),e.jsx("input",{type:"date",required:o.recurring,value:o.endRecurrence,onChange:l=>d(b=>({...b,endRecurrence:l.target.value})),className:`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 ${i.endRecurrence?"border-red-300":"border-gray-300"}`}),i.endRecurrence&&e.jsx("p",{className:"text-red-600 text-xs mt-1 font-reisinger-yonatan",children:i.endRecurrence})]}),e.jsxs("div",{className:"text-xs text-amber-600 bg-amber-50 p-2 rounded flex items-start gap-2",children:[e.jsx(Oe,{className:"w-4 h-4 mt-0.5 flex-shrink-0"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"חזרות קבועות ייווצרו אוטומטית עד התאריך שצוין"})]})]})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{type:"submit",disabled:L,className:"flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 disabled:opacity-50 transition-colors font-reisinger-yonatan",children:L?"קובע חזרה...":"קבע חזרה"}),e.jsx("button",{type:"button",onClick:N,className:"flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors font-reisinger-yonatan",children:"ביטול"})]})]})]})}):null}function ft(){const{user:s}=je(),[N,S]=n.useState([]),[p,h]=n.useState(!0),[o,d]=n.useState(""),[i,g]=n.useState(!1),[L,y]=n.useState(null),[m,z]=n.useState(null),[H,l]=n.useState([]),[b,k]=n.useState(null),[f,E]=n.useState("members");n.useState(!1);const[X,u]=n.useState(!1),[v,R]=n.useState([]),[C,G]=n.useState([]),[O,V]=n.useState(""),[x,F]=n.useState(""),[$,w]=n.useState(null),[D,U]=n.useState({isOpen:!1,title:"",message:"",onConfirm:()=>{}});n.useEffect(()=>{Q()},[s]);const Q=async()=>{if(s?._id)try{h(!0);const t=s._id,a=await B.teachers.getTeacher(t);if(!a)throw new Error("לא נמצא פרופיל מנצח");const c=a?.conducting?.orchestraIds||[];if(c.length===0){console.log("No orchestras assigned to conductor"),S([]);return}const j=await B.orchestras.getBatchOrchestras(c);if(!Array.isArray(j))throw new Error("תגובה לא תקינה מהשרת");const P=j.map(T=>({id:T._id,name:T.name,description:T.description,type:T.type,level:T.level,memberCount:T.memberCount||0,status:T.status||"active",rehearsalDay:T.rehearsalSchedule?.day,rehearsalTime:T.rehearsalSchedule?.time,venue:T.venue}));S(P)}catch(t){console.error("Error loading conductor orchestras:",t),k("שגיאה בטעינת רשימת התזמורות")}finally{h(!1)}},A=async t=>{try{const j=((await B.orchestras.getOrchestra(t)).memberDetails||[]).map(P=>{const T=P.personalInfo?.fullName||"",q=T.trim().split(/\s+/),J=q[0]||"",Y=q.slice(1).join(" ")||"",ee=P.academicInfo?.instrumentProgress?.find(I=>I.isPrimary),se=ee?.instrumentName||P.primaryInstrument||"לא צוין",fe=ee?.currentStage||0;return{id:P._id,fullName:T,firstName:J,lastName:Y,instrument:se,currentStage:fe,section:P.section||"כללי",status:P.status||"active",enrollmentDate:P.enrollmentDate||new Date().toISOString(),performanceLevel:P.performanceLevel||"intermediate",attendanceRate:P.attendanceRate||null}});l(j)}catch(a){console.error("Error loading orchestra members:",a)}},te=async()=>{try{const t=await B.students.getStudents({status:"active",limit:200}),a=H.map(j=>j.id),c=t.filter(j=>!a.includes(j._id));R(c)}catch(t){console.error("Error loading available students:",t)}},ie=async t=>{try{const c=(await B.rehearsals.getRehearsals({groupId:t,limit:20})).map(j=>{const P=j.scheduledDate||j.date||j.rehearsalDate;let T="תאריך לא זמין";if(P)try{const q=new Date(P);isNaN(q.getTime())||(T=q.toLocaleDateString("he-IL",{year:"numeric",month:"2-digit",day:"2-digit"}))}catch{console.warn("Failed to parse rehearsal date:",P)}return{id:j._id,date:T,time:j.startTime||"19:00",location:j.location||"אולם מוזיקה",duration:j.duration||120,status:j.status||"scheduled",attendanceCount:j.attendanceList?.length||0,totalMembers:H.length}});G(c)}catch(a){console.error("Error loading orchestra rehearsals:",a),G([])}},de=async t=>{if(m)try{await B.orchestras.addMember(m,t),await A(m),await te(),w({type:"success",message:"התלמיד נוסף בהצלחה לתזמורת"}),setTimeout(()=>w(null),3e3)}catch(a){console.error("Error adding member:",a),w({type:"error",message:"שגיאה בהוספת התלמיד לתזמורת"}),setTimeout(()=>w(null),3e3)}},me=async t=>{m&&U({isOpen:!0,title:"הסרת תלמיד מהתזמורת",message:"האם אתה בטוח שברצונך להסיר את התלמיד מהתזמורת?",onConfirm:async()=>{U({...D,isOpen:!1});try{await B.orchestras.removeMember(m,t),await A(m),await te(),w({type:"success",message:"התלמיד הוסר בהצלחה מהתזמורת"}),setTimeout(()=>w(null),3e3)}catch(a){console.error("Error removing member:",a),w({type:"error",message:"שגיאה בהסרת התלמיד מהתזמורת"}),setTimeout(()=>w(null),3e3)}}})},oe=async t=>{if(m)try{const a={groupId:m,groupType:"orchestra",scheduledDate:new Date(t.date).toISOString(),startTime:t.startTime,endTime:t.endTime,duration:xe(t.startTime,t.endTime),location:t.location,notes:t.notes,status:"scheduled"};if(t.recurring){const c=he(a,t);await Promise.all(c.map(j=>B.rehearsals.createRehearsal(j))),w({type:"success",message:`${c.length} חזרות נוצרו בהצלחה`})}else await B.rehearsals.createRehearsal(a),w({type:"success",message:"חזרה נוצרה בהצלחה"});await ie(m),u(!1),setTimeout(()=>w(null),3e3)}catch(a){console.error("Error scheduling rehearsal:",a),w({type:"error",message:"שגיאה ביצירת החזרה"}),setTimeout(()=>w(null),3e3)}},xe=(t,a)=>{const c=new Date(`2000-01-01T${t}`),j=new Date(`2000-01-01T${a}`);return Math.round((j.getTime()-c.getTime())/(1e3*60))},he=(t,a)=>{const c=[],j=new Date(a.date),P=new Date(a.endRecurrence);let T=new Date(j);for(;T<=P;)switch(c.push({...t,scheduledDate:new Date(T).toISOString()}),a.recurrencePattern){case"weekly":T.setDate(T.getDate()+7);break;case"biweekly":T.setDate(T.getDate()+14);break;case"monthly":T.setMonth(T.getMonth()+1);break}return c},r=N.filter(t=>o===""||t.name.toLowerCase().includes(o.toLowerCase())||t.type.toLowerCase().includes(o.toLowerCase())||t.description?.toLowerCase().includes(o.toLowerCase())),_=async t=>{U({isOpen:!0,title:"מחיקת תזמורת",message:"האם אתה בטוח שברצונך למחוק תזמורת זו? פעולה זו אינה ניתנת לביטול.",onConfirm:async()=>{U({...D,isOpen:!1});try{await B.orchestras.deleteOrchestra(t),S(a=>a.filter(c=>c.id!==t)),m===t&&(z(null),l([])),w({type:"success",message:"התזמורת נמחקה בהצלחה"}),setTimeout(()=>w(null),3e3)}catch(a){console.error("Error deleting orchestra:",a),w({type:"error",message:"שגיאה במחיקת התזמורת"}),setTimeout(()=>w(null),3e3)}}})},Z=async t=>{try{if(L){const a={name:t.name,description:t.description,type:t.type,level:t.level,status:t.status,rehearsalSchedule:{day:t.rehearsalDay,time:t.rehearsalTime},venue:t.venue},c=await B.orchestras.updateOrchestra(L.id,a),j={id:c._id,name:c.name,description:c.description,type:c.type,level:c.level,memberCount:c.memberCount||0,status:c.status||"active",rehearsalDay:c.rehearsalSchedule?.day,rehearsalTime:c.rehearsalSchedule?.time,venue:c.venue};S(P=>P.map(T=>T.id===L.id?j:T))}else{const a=s?._id,c={name:t.name,description:t.description,type:t.type,level:t.level,status:t.status,rehearsalSchedule:{day:t.rehearsalDay,time:t.rehearsalTime},venue:t.venue,conductorId:a},j=await B.orchestras.createOrchestra(c),P={id:j._id,name:j.name,description:j.description,type:j.type,level:j.level,memberCount:j.memberCount||0,status:j.status||"active",rehearsalDay:j.rehearsalSchedule?.day,rehearsalTime:j.rehearsalSchedule?.time,venue:j.venue};S(T=>[...T,P])}g(!1),y(null),w({type:"success",message:L?"התזמורת עודכנה בהצלחה":"התזמורת נוצרה בהצלחה"}),setTimeout(()=>w(null),3e3)}catch(a){console.error("Error saving orchestra:",a),w({type:"error",message:"שגיאה בשמירת פרטי התזמורת"}),setTimeout(()=>w(null),3e3)}},W=t=>{switch(t){case"youth":return"תזמורת נוער";case"adult":return"תזמורת מבוגרים";case"chamber":return"תזמורת קאמרית";case"symphony":return"תזמורת סימפונית";default:return t}},M=t=>{switch(t){case"beginner":return"מתחילים";case"intermediate":return"בינוניים";case"advanced":return"מתקדמים";default:return t}};return p?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600",children:"טוען רשימת תזמורות..."})]})}):b?e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("div",{className:"text-red-800 font-reisinger-yonatan",children:b})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:"תזמורות שאני מנצח"}),e.jsxs("p",{className:"text-gray-600 mt-1",children:[N.length," תזמורות"]})]}),e.jsxs("button",{onClick:()=>g(!0),className:"flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors",children:[e.jsx(be,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"הוסף תזמורת"})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(ue,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"חיפוש תזמורות...",value:o,onChange:t=>d(t.target.value),className:"w-full pl-4 pr-12 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"rtl"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsx("div",{className:"space-y-4",children:r.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ye,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2 font-reisinger-yonatan",children:o?"לא נמצאו תזמורות":"אין תזמורות רשומות"}),e.jsx("p",{className:"text-gray-600 font-reisinger-yonatan",children:o?"נסה מילות חיפוש אחרות":"התחל בהוספת התזמורת הראשונה שלך"})]}):r.map(t=>e.jsxs("div",{className:`bg-white border border-gray-200 rounded-lg p-4 hover:shadow-lg hover:border-indigo-300 transition-all duration-200 cursor-pointer transform hover:-translate-y-1 group ${m===t.id?"ring-2 ring-indigo-500 bg-indigo-50":""}`,onClick:()=>{z(t.id),A(t.id),ie(t.id),E("members")},children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-gray-900 font-reisinger-yonatan",children:t.name}),e.jsxs("p",{className:"text-sm text-gray-600 font-reisinger-yonatan",children:[W(t.type)," • ",M(t.level)]}),t.description&&e.jsx("p",{className:"text-sm text-gray-500 mt-1 font-reisinger-yonatan",children:t.description})]}),e.jsxs("div",{className:"flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:[e.jsx("button",{onClick:a=>{a.stopPropagation(),y(t),g(!0)},className:"p-2 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all duration-200",title:"עריכת תזמורת",children:e.jsx(ke,{className:"w-4 h-4"})}),e.jsx("button",{onClick:a=>{a.stopPropagation(),_(t.id)},className:"p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all duration-200",title:"מחיקת תזמורת",children:e.jsx(Ie,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ae,{className:"w-4 h-4"}),e.jsxs("span",{children:[t.memberCount||0," חברים"]})]}),t.rehearsalDay&&e.jsxs("span",{children:["חזרות: ",t.rehearsalDay]})]}),e.jsx("span",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${t.status==="active"?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"}`,children:t.status==="active"?"פעיל":"לא פעיל"})]})]},t.id))}),m&&e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"flex gap-1 p-1",children:[e.jsxs("button",{onClick:()=>E("members"),className:`px-4 py-2 text-sm font-medium rounded-md transition-colors ${f==="members"?"bg-indigo-100 text-indigo-700":"text-gray-500 hover:text-gray-700"}`,children:[e.jsx(ae,{className:"w-4 h-4 inline mr-2"}),"חברי התזמורת"]}),e.jsxs("button",{onClick:()=>{E("enrollment"),te()},className:`px-4 py-2 text-sm font-medium rounded-md transition-colors ${f==="enrollment"?"bg-indigo-100 text-indigo-700":"text-gray-500 hover:text-gray-700"}`,children:[e.jsx(le,{className:"w-4 h-4 inline mr-2"}),"רישום חברים"]}),e.jsxs("button",{onClick:()=>E("rehearsals"),className:`px-4 py-2 text-sm font-medium rounded-md transition-colors ${f==="rehearsals"?"bg-indigo-100 text-indigo-700":"text-gray-500 hover:text-gray-700"}`,children:[e.jsx(ne,{className:"w-4 h-4 inline mr-2"}),"חזרות"]})]})}),e.jsxs("div",{className:"p-4",children:[f==="members"&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"font-semibold text-gray-900 font-reisinger-yonatan",children:["חברי התזמורת (",H.length,")"]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs("div",{className:"relative",children:[e.jsx(ue,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"text",placeholder:"חיפוש חברים...",value:x,onChange:t=>F(t.target.value),className:"pl-4 pr-10 py-1.5 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-indigo-500",dir:"rtl"})]})})]}),H.filter(t=>x===""||`${t.firstName} ${t.lastName}`.toLowerCase().includes(x.toLowerCase())||t.instrument.toLowerCase().includes(x.toLowerCase())).length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(ae,{className:"w-12 h-12 text-gray-400 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 font-reisinger-yonatan",children:x?"לא נמצאו חברים":"אין חברים רשומים בתזמורת"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:H.filter(t=>x===""||`${t.firstName} ${t.lastName}`.toLowerCase().includes(x.toLowerCase())||t.instrument.toLowerCase().includes(x.toLowerCase())).map(t=>e.jsxs("div",{className:"flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors border border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${t.status==="active"?"bg-green-500":"bg-gray-400"}`}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm font-reisinger-yonatan",children:t.fullName||`${t.firstName} ${t.lastName}`.trim()}),e.jsxs("div",{className:"text-xs text-gray-500 font-reisinger-yonatan",children:[t.instrument,t.currentStage?` - שלב ${t.currentStage}`:""]}),t.attendanceRate!==null&&t.attendanceRate!==void 0&&e.jsxs("div",{className:"text-xs text-gray-400 mt-1",children:["נוכחות: ",t.attendanceRate,"%"]})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{onClick:()=>me(t.id),className:"p-1.5 text-red-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors",title:"הסר מהתזמורת",children:e.jsx(ze,{className:"w-4 h-4"})})})]},t.id))})]}),f==="enrollment"&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h4",{className:"font-semibold text-gray-900 font-reisinger-yonatan",children:"הוסף חברים חדשים"}),e.jsxs("div",{className:"relative",children:[e.jsx(ue,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"text",placeholder:"חיפוש תלמידים...",value:O,onChange:t=>V(t.target.value),className:"pl-4 pr-10 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500",dir:"rtl"})]})]}),v.filter(t=>O===""||t.personalInfo?.fullName?.toLowerCase().includes(O.toLowerCase())||t.academicInfo?.primaryInstrument?.toLowerCase().includes(O.toLowerCase())).length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(le,{className:"w-12 h-12 text-gray-400 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 font-reisinger-yonatan",children:O?"לא נמצאו תלמידים":"אין תלמידים זמינים"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:v.filter(t=>O===""||t.personalInfo?.fullName?.toLowerCase().includes(O.toLowerCase())||t.academicInfo?.primaryInstrument?.toLowerCase().includes(O.toLowerCase())).map(t=>{const a=t.academicInfo?.instrumentProgress?.find(P=>P.isPrimary),c=a?.instrumentName||t.academicInfo?.primaryInstrument||"לא צוין כלי",j=a?.currentStage;return e.jsxs("div",{className:"flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors border border-gray-200",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm font-reisinger-yonatan",children:t.personalInfo?.fullName}),e.jsxs("div",{className:"text-xs text-gray-500 font-reisinger-yonatan",children:[c,j?` - שלב ${j}`:""]})]}),e.jsxs("button",{onClick:()=>de(t._id),className:"flex items-center gap-1 px-3 py-1.5 bg-indigo-600 text-white text-sm rounded hover:bg-indigo-700 transition-colors",children:[e.jsx(le,{className:"w-4 h-4"}),"הוסף"]})]},t._id)})})]}),f==="rehearsals"&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h4",{className:"font-semibold text-gray-900 font-reisinger-yonatan",children:"חזרות התזמורת"}),e.jsxs("button",{onClick:()=>u(!0),className:"flex items-center gap-2 px-3 py-1.5 bg-indigo-600 text-white text-sm rounded hover:bg-indigo-700 transition-colors",children:[e.jsx(be,{className:"w-4 h-4"}),"קבע חזרה"]})]}),C.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(ne,{className:"w-12 h-12 text-gray-400 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 font-reisinger-yonatan",children:"אין חזרות מתוכננות"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:C.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors border border-gray-200",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-medium text-sm font-reisinger-yonatan",children:[t.date," • ",t.time]}),e.jsxs("div",{className:"text-xs text-gray-500 font-reisinger-yonatan flex items-center gap-2 mt-1",children:[e.jsx(ge,{className:"w-3 h-3"}),t.location,e.jsx(re,{className:"w-3 h-3 mr-1"}),t.duration," דקות"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-sm font-medium text-gray-900",children:[t.attendanceCount,"/",t.totalMembers]}),e.jsx("div",{className:"text-xs text-gray-500",children:"נוכחות"})]})]},t.id))})]})]})]})]}),i&&e.jsx(pt,{orchestra:L,onClose:()=>{g(!1),y(null)},onSubmit:Z}),X&&m&&e.jsx(ht,{isOpen:X,onClose:()=>u(!1),orchestraId:m,orchestraName:N.find(t=>t.id===m)?.name||"",onSave:oe}),e.jsx(mt,{isOpen:D.isOpen,title:D.title,message:D.message,onConfirm:D.onConfirm,onCancel:()=>U({...D,isOpen:!1}),variant:"danger",confirmText:"אישור",cancelText:"ביטול"}),$&&e.jsx("div",{className:"fixed bottom-4 left-1/2 transform -translate-x-1/2 z-50 animate-fade-in",dir:"rtl",children:e.jsxs("div",{className:`flex items-center gap-3 px-6 py-4 rounded-lg shadow-lg ${$.type==="success"?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:[$.type==="success"?e.jsx(Ae,{className:"w-5 h-5 text-green-600 flex-shrink-0"}):e.jsx(tt,{className:"w-5 h-5 text-red-600 flex-shrink-0"}),e.jsx("span",{className:`font-medium font-reisinger-yonatan ${$.type==="success"?"text-green-800":"text-red-800"}`,children:$.message})]})})]})}function pt({orchestra:s,onClose:N,onSubmit:S}){const[p,h]=n.useState({name:s?.name||"",description:s?.description||"",type:s?.type||"youth",level:s?.level||"beginner",status:s?.status||"active",rehearsalDay:s?.rehearsalDay||"",rehearsalTime:s?.rehearsalTime||"",venue:s?.venue||""}),o=d=>{d.preventDefault(),S(p)};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto",dir:"rtl",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900 mb-4 font-reisinger-yonatan",children:s?"עריכת תזמורת":"הוספת תזמורת חדשה"}),e.jsxs("form",{onSubmit:o,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שם התזמורת *"}),e.jsx("input",{type:"text",required:!0,value:p.name,onChange:d=>h(i=>({...i,name:d.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"תיאור"}),e.jsx("textarea",{value:p.description,onChange:d=>h(i=>({...i,description:d.target.value})),rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"סוג תזמורת *"}),e.jsxs("select",{required:!0,value:p.type,onChange:d=>h(i=>({...i,type:d.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"youth",children:"תזמורת נוער"}),e.jsx("option",{value:"adult",children:"תזמורת מבוגרים"}),e.jsx("option",{value:"chamber",children:"תזמורת קאמרית"}),e.jsx("option",{value:"symphony",children:"תזמורת סימפונית"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"רמה *"}),e.jsxs("select",{required:!0,value:p.level,onChange:d=>h(i=>({...i,level:d.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"beginner",children:"מתחילים"}),e.jsx("option",{value:"intermediate",children:"בינוניים"}),e.jsx("option",{value:"advanced",children:"מתקדמים"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"יום חזרות"}),e.jsx("input",{type:"text",value:p.rehearsalDay,onChange:d=>h(i=>({...i,rehearsalDay:d.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",placeholder:"כלומר: יום ראשון"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שעת חזרות"}),e.jsx("input",{type:"time",value:p.rehearsalTime,onChange:d=>h(i=>({...i,rehearsalTime:d.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"מקום חזרות"}),e.jsx("input",{type:"text",value:p.venue,onChange:d=>h(i=>({...i,venue:d.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"סטטוס"}),e.jsxs("select",{value:p.status,onChange:d=>h(i=>({...i,status:d.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"active",children:"פעיל"}),e.jsx("option",{value:"inactive",children:"לא פעיל"})]})]}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx("button",{type:"submit",className:"flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors font-reisinger-yonatan",children:s?"עדכן":"הוסף"}),e.jsx("button",{type:"button",onClick:N,className:"flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors font-reisinger-yonatan",children:"ביטול"})]})]})]})})}function yt(){const{user:s}=je(),[N,S]=n.useState(new Date),[p,h]=n.useState(null),[o,d]=n.useState([]),[i,g]=n.useState([]),[L,y]=n.useState(!0),[m,z]=n.useState(null),[H,l]=n.useState(!1),[b,k]=n.useState(null),[f,E]=n.useState(""),[X,u]=n.useState(!1),[v,R]=n.useState(null),[C,G]=n.useState(!1),[O,V]=n.useState(null);n.useEffect(()=>{x()},[N,s]);const x=async()=>{if(s?._id)try{y(!0);const t=s._id,a=await B.teacherSchedule.getTimeBlocks(t);console.log("Raw API Response:",a);let c=[];try{if(Array.isArray(a))c=a;else if(a?.data&&Array.isArray(a.data))c=a.data;else if(a?.timeBlocks&&Array.isArray(a.timeBlocks))c=a.timeBlocks;else if(a&&typeof a=="object"){const I=Object.values(a).find(K=>Array.isArray(K));I?c=I:(console.warn("No array found in response, using empty array"),c=[])}else console.warn("Unexpected timeBlocks format:",a),c=[]}catch(I){console.error("Error parsing timeBlocks response:",I),c=[]}console.log("Parsed timeBlocks:",c),console.log("Time block IDs:",c.map(I=>({_id:I._id,day:I.day,time:`${I.startTime}-${I.endTime}`,location:I.location})));const j=c.filter(I=>I._id&&I._id!=="undefined");console.log("Valid timeBlocks after filtering:",j),g(j);const P=await B.teachers.getTeacher(t);console.log("Teacher profile:",P);let T=[];if(P?.teaching?.studentIds?.length>0)try{T=await B.students.getBatchStudents(P.teaching.studentIds),console.log("Students loaded:",T)}catch(I){console.warn("Failed to load students:",I)}else console.log("No student IDs found in teacher profile");console.log("Creating lesson blocks from student assignments...");const q=[];T.forEach(I=>{console.log("Processing student:",I.personalInfo?.fullName),console.log("Student assignments:",I.teacherAssignments),I.teacherAssignments&&I.teacherAssignments.forEach(K=>{if(K.teacherId===t){console.log("Creating lesson from assignment:",K);const pe=K.time||K.startTime,Le=K.duration||45,$e=(Ne,Ge)=>{const[Ve,Qe]=Ne.split(":").map(Number),Pe=Ve*60+Qe+Ge,Xe=Math.floor(Pe/60),Je=Pe%60;return`${Xe.toString().padStart(2,"0")}:${Je.toString().padStart(2,"0")}`},ce=K.endTime||$e(pe,Le),He=i.find(Ne=>Ne.day===K.day)?.location||"",Ue={_id:`${I._id}-${K.day}-${K.time}`,day:K.day,startTime:pe,endTime:ce,totalDuration:Le,studentId:I._id,studentName:I.personalInfo?.fullName,teacherId:t,instrument:I.academicInfo?.instrumentProgress?.find(Ne=>Ne.isPrimary)?.instrumentName,location:K.location||He,type:"lesson"};console.log(`Creating lesson: Student="${I.personalInfo?.fullName}", Day="${K.day}", Time="${pe}-${ce}"`),q.push(Ue)}})}),console.log("Converted lessons from assignments:",q);const Y=q.map(I=>{const K=T.find(ce=>ce.teacherAssignments?.some(Te=>Te.teacherId===t&&Te.day===I.day&&Te.time===I.startTime)),pe=K?.academicInfo?.instrumentProgress?.find(ce=>ce.isPrimary)||K?.academicInfo?.instrumentProgress?.[0],$e=i.find(ce=>ce.day===I.day)?.location||"";return{id:I._id||I.id||`${I.day}-${I.startTime}`,day:I.day,startTime:I.startTime,endTime:I.endTime,studentName:K?K.personalInfo?.fullName:I.studentName,studentId:K?._id||I.studentId,instrument:pe?.instrumentName||I.instrument,location:I.location||$e,notes:I.notes,recurring:I.recurring||{isRecurring:!0,excludeDates:[]},totalDuration:I.totalDuration||$(I.startTime,I.endTime),studentClass:K?.personalInfo?.class||K?.academicInfo?.class,studentPhone:K?.personalInfo?.phone,studentStage:pe?.currentStage}});d(Y);const ee=w(N),se=D(N),fe=F(ee,Y);console.log("Generated calendar days:",fe),console.log("Calendar week range:",{weekStart:ee,weekEnd:se}),console.log("Mapped lesson days for calendar:",Y),h({weekStart:ee,weekEnd:se,days:fe})}catch(t){console.error("Error loading schedule:",t),z("שגיאה בטעינת לוח הזמנים")}finally{y(!1)}},F=(t,a)=>{const c=[],j=["ראשון","שני","שלישי","רביעי","חמישי","שישי","שבת"],P=new Map;j.forEach((q,J)=>{P.set(q,J)}),console.log("=== GENERATING CALENDAR ==="),console.log("weekStart:",t,"Day:",t.getDay()),console.log("lessons input:",a),console.log("Day name mapping:",Array.from(P.entries()));const T=new Map;a.forEach(q=>{T.has(q.day)||T.set(q.day,[]),T.get(q.day).push(q)}),console.log("Lessons grouped by day:",Array.from(T.keys()));for(let q=0;q<7;q++){const J=new Date(t);J.setDate(t.getDate()+q);const Y=j[q],ee=T.get(Y)||[];console.log(`Day ${q} (${Y}): found ${ee.length} lessons`,ee.map(se=>({day:se.day,time:se.startTime,student:se.studentName}))),c.push({date:J.toISOString().split("T")[0],dayName:Y,lessons:ee})}return console.log("Generated calendar days with lessons:",c.map(q=>({dayName:q.dayName,lessonCount:q.lessons.length}))),c},$=(t,a)=>{const[c,j]=t.split(":").map(Number),[P,T]=a.split(":").map(Number);return P*60+T-(c*60+j)},w=t=>{const a=new Date(t),c=a.getDay(),j=a.getDate()-c;return a.setDate(j),a.setHours(0,0,0,0),console.log("getWeekStart: input date:",t,"weekStart (Sunday):",a,"day:",a.getDay()),a},D=t=>{const a=w(t);return a.setDate(a.getDate()+6),a},U=t=>{const a=new Date(N);a.setDate(N.getDate()+(t==="next"?7:-7)),S(a)},Q=t=>t.slice(0,5),A=t=>new Date(t).toLocaleDateString("he-IL",{day:"numeric",month:"short"}),te=()=>{k(null),l(!0)},ie=t=>{console.log("handleEditLessonDay called with:",{studentId:t.studentId,studentName:t.studentName,id:t.id,_id:t._id,type:t.type}),t.studentId&&t.studentName?(console.log("Opening EditLessonModal for student lesson"),V(t),G(!0)):(console.log("Opening LessonDayModal for teaching day/availability block"),k(t),l(!0))},de=t=>{console.log("handleEditTeachingDay called with:",{_id:t._id,id:t.id,day:t.day,startTime:t.startTime,hasStudentId:!!t.studentId,fullData:t});const a={id:t._id||t.id,day:t.day,startTime:t.startTime,endTime:t.endTime,location:t.location||"חדר מוזיקה",notes:t.notes||"",recurring:t.recurring||{isRecurring:!0,excludeDates:[]},totalDuration:$(t.startTime,t.endTime)};console.log("Opening LessonDayModal with lessonDay:",a),k(a),l(!0)},me=async t=>{if(window.confirm("האם אתה בטוח שברצונך למחוק יום לימוד זה? פעולה זו תבטל את הזמינות שלך בזמן זה."))try{await B.teacherSchedule.deleteTimeBlock(s?._id,t._id||t.id),oe("יום הלימוד נמחק בהצלחה","success"),x()}catch(c){console.error("Error deleting teaching day:",c),oe("שגיאה במחיקת יום הלימוד","error")}},oe=(t,a)=>{const c=document.createElement("div");c.className=`fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 ${a==="success"?"bg-green-500 text-white":a==="error"?"bg-red-500 text-white":"bg-blue-500 text-white"}`,c.innerHTML=`<div class="flex items-center gap-2 font-reisinger-yonatan">
      ${a==="success"?"✅":a==="error"?"❌":"ℹ️"} ${t}
    </div>`,document.body.appendChild(c),setTimeout(()=>c.remove(),3e3)},xe=()=>{const t=[];for(let a=7;a<=21;a++)t.push(`${a.toString().padStart(2,"0")}:00`),t.push(`${a.toString().padStart(2,"0")}:30`);return t},he=(t,a)=>{const c=p?.days.find(T=>T.date===t),j=T=>{const[q,J]=T.split(":").map(Number);return q*60+J};return c?.lessons.find(T=>{const q=j(a),J=q+30,Y=j(T.startTime),ee=j(T.endTime),se=Y>=q&&Y<J,fe=q>=Y&&q<ee;return se||fe})},r=t=>{const a=$(t.startTime,t.endTime);return Math.ceil(a/30)*60},_=(t,a)=>{const c=t.startTime,j=a,P=Y=>{const[ee,se]=Y.split(":").map(Number);return ee*60+se},T=P(c),q=P(j),J=q+30;return T>=q&&T<J},Z=(t,a)=>{const c=J=>{const[Y,ee]=J.split(":").map(Number);return Y*60+ee},j=c(a),P=j+30;return i.some(J=>{if(J.day!==t)return!1;const Y=c(J.startTime),ee=c(J.endTime);return j>=Y&&P<=ee})?!o.some(J=>{if(J.day!==t)return!1;const Y=c(J.startTime),ee=c(J.endTime);return j<ee&&P>Y}):!1},W=(t,a,c)=>{Z(c,a)&&(R({date:t,time:a,dayName:c}),u(!0))};if(o.filter(t=>{if(!f)return!0;const a=f.toLowerCase();return t.studentName?.toLowerCase().includes(a)||t.instrument?.toLowerCase().includes(a)||t.location?.toLowerCase().includes(a)||t.day.toLowerCase().includes(a)}),L)return e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600",children:"טוען לוח זמנים..."})]})});if(m&&!p)return e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("div",{className:"text-red-800 font-reisinger-yonatan",children:m})});const M=xe();return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:"לוח זמנים שבועי"}),e.jsx("p",{className:"text-gray-600 mt-1",children:p&&`${A(p.weekStart.toISOString().split("T")[0])} - ${A(p.weekEnd.toISOString().split("T")[0])}`})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>U("prev"),className:"p-2 text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(st,{className:"w-5 h-5"})}),e.jsx("button",{onClick:()=>S(new Date),className:"px-3 py-1 text-sm bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition-colors font-reisinger-yonatan",children:"השבוע"}),e.jsx("button",{onClick:()=>U("next"),className:"p-2 text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(at,{className:"w-5 h-5"})})]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:"grid grid-cols-8 border-b border-gray-200",children:[e.jsx("div",{className:"p-3 bg-gray-50 font-medium text-gray-700 font-reisinger-yonatan",children:"שעה"}),p?.days.map(t=>e.jsxs("div",{className:"p-3 bg-gray-50 text-center",children:[e.jsx("div",{className:"font-medium text-gray-900 font-reisinger-yonatan",children:t.dayName}),e.jsx("div",{className:"text-sm text-gray-500 font-reisinger-yonatan",children:A(t.date)})]},t.date))]}),e.jsx("div",{className:"max-h-96 overflow-y-auto relative",children:M.map(t=>e.jsxs("div",{className:"grid grid-cols-8 border-b border-gray-100",style:{height:"60px"},children:[e.jsx("div",{className:"p-3 bg-gray-50 text-sm font-medium text-gray-600 font-reisinger-yonatan flex items-center",children:Q(t)}),p?.days.map(a=>{const c=he(a.date,t),j=!c&&Z(a.dayName,t);return e.jsxs("div",{className:`border-l border-gray-100 relative transition-all duration-200 cursor-pointer group ${j?"hover:bg-blue-50":""}`,style:{height:"60px"},onClick:()=>!c&&W(a.date,t,a.dayName),title:j?"לחץ להוספת שיעור חדש":"",children:[j&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:e.jsx(be,{className:"w-6 h-6 text-blue-500 drop-shadow-lg"})}),c&&_(c,t)&&e.jsx("div",{className:"absolute left-1 right-1 top-1 p-2.5 rounded text-xs font-reisinger-yonatan bg-blue-100 text-blue-800 hover:bg-blue-200 border border-blue-300 shadow-sm cursor-pointer transition-all hover:scale-[1.02] z-10 overflow-hidden",style:{height:`${r(c)-2}px`,minHeight:"82px"},onClick:()=>ie(c),title:`${c.studentName||"תלמיד"} - ${c.instrument||""}`,children:e.jsx("div",{className:"flex flex-col h-full justify-between",children:e.jsxs("div",{className:"flex-shrink-0 space-y-1",children:[e.jsxs("div",{className:"font-medium truncate flex items-center gap-1",children:[e.jsx(we,{className:"w-3 h-3 opacity-60"}),c.studentName||"תלמיד"]}),e.jsxs("div",{className:"text-[10px] opacity-75",children:[Q(c.startTime),"-",Q(c.endTime)]}),e.jsx("div",{className:"flex items-center gap-1 text-[10px] opacity-80 h-4",children:c.instrument?e.jsxs(e.Fragment,{children:[e.jsx(ye,{className:"w-2.5 h-2.5"}),e.jsx("span",{className:"truncate",children:c.instrument})]}):e.jsx("span",{className:"invisible",children:"placeholder"})}),e.jsx("div",{className:"flex items-center gap-1 text-[10px] opacity-70 h-4",children:c.location?e.jsxs(e.Fragment,{children:[e.jsx(ge,{className:"w-2.5 h-2.5"}),e.jsx("span",{className:"truncate",children:c.location})]}):e.jsx("span",{className:"invisible",children:"placeholder"})})]})})})]},`${a.date}-${t}`)})]},t))})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-bold text-gray-900 font-reisinger-yonatan",children:"ימי לימוד - זמינות המורה"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"הגדר את הימים והשעות שבהם אתה זמין להוראה"})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs("button",{onClick:te,className:"flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors",children:[e.jsx(be,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"הוסף יום לימוד"})]})})]}),i.length===0?e.jsxs("div",{className:"text-center py-12 bg-gray-50 rounded-lg",children:[e.jsx(Se,{className:"w-12 h-12 text-gray-300 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500 font-reisinger-yonatan text-lg",children:"אין ימי לימוד מוגדרים"}),e.jsx("button",{onClick:te,className:"mt-4 text-indigo-600 hover:text-indigo-700 font-medium",children:"הוסף יום לימוד ראשון"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:i.map(t=>e.jsx(bt,{teachingDay:t,onEdit:()=>de(t),onDelete:()=>me(t)},t._id||t.id))})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ne,{className:"w-5 h-5 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-900 font-reisinger-yonatan",children:"ימי לימוד"})]}),e.jsx("div",{className:"text-2xl font-bold text-blue-900 mt-2 font-reisinger-yonatan",children:i.length}),e.jsx("div",{className:"text-xs text-blue-700 mt-1",children:"ימי זמינות להוראה"})]}),e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(re,{className:"w-5 h-5 text-green-600"}),e.jsx("span",{className:"font-medium text-green-900 font-reisinger-yonatan",children:"שעות זמינות"})]}),e.jsx("div",{className:"text-2xl font-bold text-green-900 mt-2 font-reisinger-yonatan",children:(i.reduce((t,a)=>{const c=$(a.startTime,a.endTime);return t+c},0)/60).toFixed(1)}),e.jsx("div",{className:"text-xs text-green-700 mt-1",children:"שעות שבועיות זמינות"})]}),e.jsxs("div",{className:"bg-purple-50 border border-purple-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(we,{className:"w-5 h-5 text-purple-600"}),e.jsx("span",{className:"font-medium text-purple-900 font-reisinger-yonatan",children:"תלמידים"})]}),e.jsx("div",{className:"text-2xl font-bold text-purple-900 mt-2 font-reisinger-yonatan",children:new Set(o.map(t=>t.studentId).filter(Boolean)).size}),e.jsx("div",{className:"text-xs text-purple-700 mt-1",children:"תלמידים פעילים"})]}),e.jsxs("div",{className:"bg-orange-50 border border-orange-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ge,{className:"w-5 h-5 text-orange-600"}),e.jsx("span",{className:"font-medium text-orange-900 font-reisinger-yonatan",children:"שיעורים"})]}),e.jsx("div",{className:"text-2xl font-bold text-orange-900 mt-2 font-reisinger-yonatan",children:o.length}),e.jsx("div",{className:"text-xs text-orange-700 mt-1",children:"שיעורים קבועים"})]})]}),X&&v&&e.jsx(vt,{timeSlot:v,teacherId:s?._id||"",teachingDays:i,onClose:()=>{u(!1),R(null)},onSave:()=>{u(!1),R(null),x()}}),H&&e.jsx(jt,{lessonDay:b,teacherId:s?._id||"",onClose:()=>{l(!1),k(null)},onSave:()=>{l(!1),k(null),x()}}),C&&O&&e.jsx(Nt,{lesson:O,teacherId:s?._id||"",teachingDays:i,onClose:()=>{G(!1),V(null)},onSave:()=>{G(!1),V(null),x()}})]})}function bt({teachingDay:s,onEdit:N,onDelete:S}){return e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4 hover:shadow-lg transition-shadow",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-2 bg-green-100 rounded-lg",children:e.jsx(ne,{className:"w-4 h-4 text-green-600"})}),e.jsxs("div",{children:[e.jsxs("h5",{className:"font-bold text-gray-900 font-reisinger-yonatan",children:["יום ",s.day]}),e.jsx("p",{className:"text-xs text-gray-500 mt-0.5",children:"זמינות להוראה"})]})]}),s.isRecurring!==!1&&e.jsx("span",{className:"px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full font-reisinger-yonatan",children:"שבועי"})]}),e.jsx("div",{className:"mb-3 pb-3 border-b border-gray-100",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-700",children:[e.jsx(re,{className:"w-4 h-4 text-gray-400"}),e.jsxs("span",{className:"font-medium",children:[s.startTime," - ",s.endTime]})]})}),s.location&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600 mb-3",children:[e.jsx(ge,{className:"w-3.5 h-3.5 text-gray-400"}),e.jsx("span",{children:s.location})]}),e.jsx("div",{className:"p-2 bg-gray-50 rounded text-xs text-gray-600 mb-3",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ae,{className:"w-3 h-3"}),e.jsx("span",{children:"זמין לקביעת שיעורים בזמן זה"})]})}),s.notes&&e.jsx("div",{className:"p-2 bg-gray-50 rounded text-xs text-gray-600 mb-3",children:s.notes}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:N,className:"flex-1 flex items-center justify-center gap-1.5 px-3 py-1.5 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 transition-colors text-sm",children:[e.jsx(ke,{className:"w-3.5 h-3.5"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"ערוך"})]}),e.jsx("button",{onClick:S,className:"flex items-center justify-center p-1.5 bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors",title:"מחק יום לימוד",children:e.jsx(Ie,{className:"w-3.5 h-3.5"})})]})]})}function jt({lessonDay:s,teacherId:N,onClose:S,onSave:p}){const[h,o]=n.useState({day:s?.day||"ראשון",startTime:s?.startTime||"14:00",endTime:s?.endTime||"18:00",location:s?.location||"חדר מוזיקה",notes:s?.notes||"",recurring:s?.recurring||{isRecurring:!0,excludeDates:[]}}),[d,i]=n.useState(!1),g=async y=>{if(y.preventDefault(),s?.studentId){alert("לא ניתן לערוך שיעור תלמיד מכאן. אנא השתמש באפשרות העריכה בכרטיס השיעור.");return}if(!h.day||!h.startTime||!h.endTime){alert("יש למלא את כל השדות הנדרשים");return}try{i(!0);const m={day:h.day,startTime:h.startTime,endTime:h.endTime,location:h.location||null,notes:h.notes||null,recurring:h.recurring||{isRecurring:!0,excludeDates:[]}};s?.id&&/^[0-9a-fA-F]{24}$/.test(s.id)?await B.teacherSchedule.updateTimeBlock(N,s.id,m):await B.teacherSchedule.createTimeBlock(N,m),p()}catch(m){console.error("Error saving lesson day:",m),m?.message?.includes("not found")||m?.message?.includes("Resource not found")?(alert("יום הלימוד הזה כבר לא קיים במערכת. הוא יוסר מהתצוגה."),S(),p()):alert("שגיאה בשמירת יום הלימוד")}finally{i(!1)}},L=()=>["ראשון","שני","שלישי","רביעי","חמישי","שישי","שבת"];return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:s?"עריכת יום לימוד":"הוספת יום לימוד חדש"}),e.jsx("button",{onClick:S,className:"p-2 text-gray-400 hover:text-gray-600",children:e.jsx(ve,{className:"w-6 h-6"})})]}),e.jsxs("form",{onSubmit:g,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"יום בשבוע *"}),e.jsx("select",{value:h.day,onChange:y=>o(m=>({...m,day:y.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",required:!0,children:L().map(y=>e.jsx("option",{value:y,children:y},y))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שעת התחלה *"}),e.jsx("input",{type:"time",value:h.startTime,onChange:y=>o(m=>({...m,startTime:y.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שעת סיום *"}),e.jsx("input",{type:"time",value:h.endTime,onChange:y=>o(m=>({...m,endTime:y.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",required:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"מיקום / חדר"}),e.jsxs("select",{value:h.location||"",onChange:y=>o(m=>({...m,location:y.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"",children:"בחר חדר"}),Ee.map(y=>e.jsx("option",{value:y,children:y},y))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"הערות"}),e.jsx("textarea",{value:h.notes||"",onChange:y=>o(m=>({...m,notes:y.target.value})),rows:3,placeholder:"הערות נוספות לגבי השיעור...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:h.recurring?.isRecurring!==!1,onChange:y=>o(m=>({...m,recurring:{isRecurring:y.target.checked,excludeDates:m.recurring?.excludeDates||[]}})),className:"rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"שיעור קבוע (חוזר שבועית)"})]}),h.recurring?.isRecurring&&e.jsx("p",{className:"text-xs text-gray-500 mr-6 mt-1",children:"השיעור יופיע באופן קבוע בכל שבוע ביום ובשעה שהוגדרו"})]}),e.jsxs("div",{className:"flex gap-3 pt-6 border-t",children:[e.jsx("button",{type:"submit",disabled:d,className:"flex-1 bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed font-reisinger-yonatan flex items-center justify-center gap-2",children:d?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"שומר..."]}):e.jsx(e.Fragment,{children:s?e.jsxs(e.Fragment,{children:[e.jsx(_e,{className:"w-4 h-4"}),"עדכן יום לימוד"]}):e.jsxs(e.Fragment,{children:[e.jsx(be,{className:"w-4 h-4"}),"הוסף יום לימוד"]})})}),e.jsx("button",{type:"button",onClick:S,disabled:d,className:"flex-1 bg-gray-300 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed font-reisinger-yonatan",children:"ביטול"})]})]})]})})}function vt({timeSlot:s,teacherId:N,teachingDays:S,onClose:p,onSave:h}){const[o,d]=n.useState(""),[i,g]=n.useState(45),[L,y]=n.useState([]),[m,z]=n.useState(!1),[H,l]=n.useState(!1),[b,k]=n.useState(0);n.useEffect(()=>{f()},[N]);const f=async()=>{try{z(!0);const G=(await B.teachers.getTeacherStudents(N)).map(O=>{const V=O.academicInfo?.instrumentProgress?.find(x=>x.isPrimary)||O.academicInfo?.instrumentProgress?.[0];return{id:O._id,firstName:O.personalInfo?.firstName||"",lastName:O.personalInfo?.lastName||"",instrument:V?.instrumentName||"",class:O.personalInfo?.class||O.academicInfo?.class,stage:V?.currentStage}});y(G)}catch(C){console.error("Error loading students:",C)}finally{z(!1)}},E=(C,G)=>{const[O,V]=C.split(":").map(Number),x=O*60+V+G,F=Math.floor(x/60),$=x%60;return`${F.toString().padStart(2,"0")}:${$.toString().padStart(2,"0")}`},X=()=>{const[C]=s.time.split(":").map(Number),G=b;return`${C.toString().padStart(2,"0")}:${G.toString().padStart(2,"0")}`},u=[0,5,10,15,20,25,30,35,40,45,50,55],v=async C=>{if(C.preventDefault(),!o){alert("יש לבחור תלמיד");return}try{l(!0);const G=L.find(D=>D.id===o),O=X(),V=E(O,i),F=S.find(D=>D.day===s.dayName)?.location||"",$={teacherId:N,day:s.dayName,time:O,endTime:V,duration:i,location:F,isActive:!0};await B.students.addTeacherAssignment(o,$);const w={day:s.dayName,startTime:O,endTime:V,studentId:o,studentName:G?`${G.firstName} ${G.lastName}`:"",instrument:G?.instrument||"",location:F,notes:`שיעור קבוע שבועי - נוצר ב-${new Date().toLocaleDateString("he-IL")}`,recurring:{isRecurring:!0,excludeDates:[]},isRecurring:!0,totalDuration:i};await B.teacherSchedule.createTimeBlock(N,w),h()}catch(G){console.error("Error creating weekly lesson assignment:",G),alert("שגיאה ביצירת הקצאת השיעור השבועי")}finally{l(!1)}},R=C=>C.slice(0,5);return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-md mx-4",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:"הוספת שיעור חדש"}),e.jsx("button",{onClick:p,className:"p-2 text-gray-400 hover:text-gray-600",children:e.jsx(ve,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"mb-4 p-3 bg-blue-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 text-blue-800 mb-2",children:[e.jsx(ne,{className:"w-4 h-4"}),e.jsxs("span",{className:"font-medium",children:["שיעור קבוע שבועי - יום ",s.dayName]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-blue-700",children:[e.jsx(re,{className:"w-4 h-4"}),e.jsxs("span",{children:[R(X())," - ",R(E(X(),i))," (",i," דקות)"]})]}),e.jsxs("div",{className:"text-xs text-blue-600 mt-1",children:["השיעור יתקיים כל שבוע ביום ",s.dayName," באותה שעה"]})]}),e.jsxs("form",{onSubmit:v,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"בחר תלמיד *"}),m?e.jsx("div",{className:"text-center py-2 text-gray-500",children:"טוען רשימת תלמידים..."}):e.jsxs("select",{value:o,onChange:C=>d(C.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",required:!0,children:[e.jsx("option",{value:"",children:"בחר תלמיד"}),L.map(C=>e.jsxs("option",{value:C.id,children:[C.firstName," ",C.lastName,C.instrument&&` - ${C.instrument}`,C.class&&` (כיתה ${C.class})`]},C.id))]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:["זמן התחלה מדויק (שעה ",s.time.split(":")[0],":__)"]}),e.jsx("div",{className:"grid grid-cols-6 gap-2",children:u.map(C=>e.jsxs("button",{type:"button",onClick:()=>k(C),className:`px-3 py-2 rounded-lg border-2 transition-all font-medium ${b===C?"border-indigo-600 bg-indigo-50 text-indigo-700":"border-gray-200 hover:border-gray-300 hover:bg-gray-50"}`,children:[":",C.toString().padStart(2,"0")]},C))}),e.jsxs("div",{className:"mt-2 text-xs text-gray-600",children:["שעת התחלה: ",X()]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"משך השיעור (דקות)"}),e.jsxs("select",{value:i,onChange:C=>g(Number(C.target.value)),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:30,children:"30 דקות"}),e.jsx("option",{value:45,children:"45 דקות"}),e.jsx("option",{value:60,children:"60 דקות"}),e.jsx("option",{value:90,children:"90 דקות"})]})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{type:"submit",disabled:H||!o,className:"flex-1 bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed font-reisinger-yonatan flex items-center justify-center gap-2",children:H?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"יוצר שיעור שבועי..."]}):e.jsxs(e.Fragment,{children:[e.jsx(_e,{className:"w-4 h-4"}),"צור שיעור שבועי"]})}),e.jsx("button",{type:"button",onClick:p,disabled:H,className:"flex-1 bg-gray-300 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed font-reisinger-yonatan",children:"ביטול"})]})]})]})})}function Nt({lesson:s,teacherId:N,teachingDays:S,onClose:p,onSave:h}){const o=(u,v)=>{const[R,C]=u.split(":").map(Number),[G,O]=v.split(":").map(Number);return G*60+O-(R*60+C)},i=S.find(u=>u.day===s.day)?.location||"",[g,L]=n.useState({day:s.day,startTime:s.startTime,endTime:s.endTime,location:s.location||i,notes:s.notes||""}),[y,m]=n.useState(!1),[z,H]=n.useState(o(s.startTime,s.endTime)),[l,b]=n.useState([]);n.useState(""),n.useEffect(()=>{if(!g.day||!z)return;const u=S.filter(R=>R.day===g.day),v=[];u.forEach(R=>{const[C,G]=R.startTime.split(":").map(Number),[O,V]=R.endTime.split(":").map(Number),x=C*60+G,$=O*60+V-x,w=Math.floor($/z);for(let D=0;D<w;D++){const U=x+D*z,Q=U+z,A=Math.floor(U/60),te=U%60,ie=Math.floor(Q/60),de=Q%60,me=`${A.toString().padStart(2,"0")}:${te.toString().padStart(2,"0")}`,oe=`${ie.toString().padStart(2,"0")}:${de.toString().padStart(2,"0")}`;v.push({id:`${R._id||R.id}-${z}-${D}`,startTime:me,endTime:oe,duration:z})}}),b(v)},[g.day,z,S]);const k=u=>{L(v=>({...v,startTime:u.startTime,endTime:u.endTime}))},f=async u=>{if(u.preventDefault(),!g.day||!g.startTime||!g.endTime){alert("יש למלא את כל השדות הנדרשים");return}const v=o(g.startTime,g.endTime);if(v<=0){alert("זמן הסיום חייב להיות לאחר זמן ההתחלה");return}try{if(m(!0),s.studentId){const R={teacherId:N,day:g.day,time:g.startTime,startTime:g.startTime,endTime:g.endTime,duration:v,location:g.location,isActive:!0};await B.students.updateTeacherAssignment(s.studentId,N,R)}E("השיעור עודכן בהצלחה","success"),h()}catch(R){console.error("Error updating lesson:",R),E("שגיאה בעדכון השיעור","error")}finally{m(!1)}},E=(u,v)=>{const R=document.createElement("div");R.className=`fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 ${v==="success"?"bg-green-500 text-white":"bg-red-500 text-white"}`,R.innerHTML=`<div class="flex items-center gap-2 font-reisinger-yonatan">
      ${v==="success"?"✅":"❌"} ${u}
    </div>`,document.body.appendChild(R),setTimeout(()=>R.remove(),3e3)},X=()=>{const u=Array.from(new Set(S.map(v=>v.day)));return u.length===0?["ראשון","שני","שלישי","רביעי","חמישי","שישי","שבת"]:u};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:"עריכת שיעור"}),e.jsx("button",{onClick:p,className:"p-2 text-gray-400 hover:text-gray-600",children:e.jsx(ve,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsx("h4",{className:"font-medium text-blue-900 mb-2 font-reisinger-yonatan",children:"פרטי התלמיד"}),e.jsxs("div",{className:"space-y-1 text-sm text-blue-800",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(we,{className:"w-4 h-4"}),e.jsx("strong",{children:"תלמיד:"})," ",s.studentName||"לא צוין"]}),s.instrument&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ye,{className:"w-4 h-4"}),e.jsx("strong",{children:"כלי נגינה:"})," ",s.instrument]}),s.studentClass&&e.jsxs("div",{children:[e.jsx("strong",{children:"כיתה:"})," ",s.studentClass]}),s.studentStage&&e.jsxs("div",{children:[e.jsx("strong",{children:"שלב:"})," ",s.studentStage]})]})]}),e.jsxs("form",{onSubmit:f,className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"יום בשבוע *"}),e.jsx("select",{value:g.day,onChange:u=>{const v=u.target.value,R=S.find(C=>C.day===v);L(C=>({...C,day:v,location:(!C.location||C.location==="")&&R?.location?R.location:C.location}))},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",required:!0,children:X().map(u=>e.jsx("option",{value:u,children:u},u))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"משך השיעור (דקות) *"}),e.jsx("div",{className:"grid grid-cols-3 gap-3",children:[30,45,60].map(u=>e.jsxs("button",{type:"button",onClick:()=>H(u),className:`px-4 py-2 rounded-lg border-2 transition-all ${z===u?"border-indigo-600 bg-indigo-50 text-indigo-700 font-semibold":"border-gray-300 bg-white text-gray-700 hover:border-indigo-300"}`,children:[u," דק׳"]},u))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:"בחר זמן שיעור זמין *"}),l.length===0?e.jsxs("div",{className:"text-center py-6 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsx(re,{className:"w-8 h-8 mx-auto mb-2 text-gray-300"}),e.jsx("p",{className:"text-sm text-gray-500",children:"אין זמנים זמינים ליום ומשך שיעור שנבחרו"})]}):e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 max-h-64 overflow-y-auto p-2 bg-gray-50 rounded-lg border border-gray-200",children:l.map(u=>{const v=g.startTime===u.startTime&&g.endTime===u.endTime;return e.jsxs("button",{type:"button",onClick:()=>k(u),className:`p-3 rounded-lg border-2 transition-all text-sm ${v?"border-green-600 bg-green-50 text-green-800 font-semibold shadow-md":u.duration===30?"border-green-300 bg-green-50 text-green-800 hover:border-green-500":u.duration===45?"border-blue-300 bg-blue-50 text-blue-800 hover:border-blue-500":"border-purple-300 bg-purple-50 text-purple-800 hover:border-purple-500"}`,children:[e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx(re,{className:"w-3 h-3"}),e.jsxs("span",{className:"font-medium",children:[u.startTime,"-",u.endTime]})]}),e.jsxs("div",{className:"text-xs mt-1 opacity-75",children:[u.duration," דקות"]})]},u.id)})})]}),g.startTime&&g.endTime&&e.jsx("div",{className:"p-3 bg-indigo-50 rounded-lg border border-indigo-200",children:e.jsxs("div",{className:"flex items-center gap-2 text-indigo-800",children:[e.jsx(re,{className:"w-4 h-4"}),e.jsxs("span",{className:"font-reisinger-yonatan font-medium",children:["זמן שיעור נבחר: ",g.startTime," - ",g.endTime," (",o(g.startTime,g.endTime)," דקות)"]})]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"מיקום / חדר"}),e.jsxs("select",{value:g.location||"",onChange:u=>L(v=>({...v,location:u.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"",children:"בחר חדר"}),Ee.map(u=>e.jsx("option",{value:u,children:u},u))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"הערות"}),e.jsx("textarea",{value:g.notes,onChange:u=>L(v=>({...v,notes:u.target.value})),rows:3,placeholder:"הערות נוספות לגבי השיעור...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{className:"flex gap-3 pt-6 border-t",children:[e.jsx("button",{type:"submit",disabled:y||!g.startTime||!g.endTime,className:"flex-1 bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed font-reisinger-yonatan flex items-center justify-center gap-2",children:y?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"שומר..."]}):e.jsxs(e.Fragment,{children:[e.jsx(_e,{className:"w-4 h-4"}),"עדכן שיעור"]})}),e.jsx("button",{type:"button",onClick:p,disabled:y,className:"flex-1 bg-gray-300 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed font-reisinger-yonatan",children:"ביטול"})]})]})]})})}function wt(){const{user:s}=je(),[N,S]=n.useState([]),[p,h]=n.useState(!0),[o,d]=n.useState(""),[i,g]=n.useState(!1),[L,y]=n.useState(null),[m,z]=n.useState(null),[H,l]=n.useState([]),[b,k]=n.useState(null),[f,E]=n.useState(!1),[X,u]=n.useState(!1),[v,R]=n.useState(!1),[C,G]=n.useState([]),[O,V]=n.useState(null),[x,F]=n.useState("lessons");n.useEffect(()=>{$()},[s]);const $=async()=>{if(s?._id)try{h(!0);const r=s._id,W=(await B.theory.getTheoryLessons()).filter(M=>M.teacherId===r).map(M=>({id:M._id,name:M.name,description:M.description,level:M.level,duration:M.duration,capacity:M.capacity,enrolledCount:M.enrolledStudentIds?.length||0,schedule:{dayOfWeek:M.dayOfWeek,startTime:M.startTime,endTime:M.endTime},status:M.isActive?"active":"inactive",venue:M.location,materials:M.materials||[]}));S(W)}catch(r){console.error("Error loading theory lessons:",r),k("שגיאה בטעינת רשימת שיעורי התיאוריה")}finally{h(!1)}},w=async r=>{try{const Z=(await B.theory.getTheoryLesson(r)).enrolledStudentIds||[];if(Z.length===0){l([]);return}const M=(await B.students.getStudents({ids:Z.join(",")})).map(t=>({id:t._id,firstName:t.personalInfo?.firstName||"",lastName:t.personalInfo?.lastName||"",grade:t.academicInfo?.gradeLevel,instrument:t.primaryInstrument,enrollmentDate:t.createdAt||new Date().toISOString(),attendance:{total:0,present:0,absent:0}}));l(M)}catch(_){console.error("Error loading lesson students:",_)}},D=N.filter(r=>o===""||r.name.toLowerCase().includes(o.toLowerCase())||r.level.toLowerCase().includes(o.toLowerCase())||r.description?.toLowerCase().includes(o.toLowerCase())),U=async r=>{if(window.confirm("האם אתה בטוח שברצונך למחוק שיעור זה?"))try{await B.theory.deleteTheoryLesson(r),S(_=>_.filter(Z=>Z.id!==r)),m===r&&(z(null),l([]))}catch(_){console.error("Error deleting lesson:",_),alert("שגיאה במחיקת השיעור")}},Q=async r=>{try{const _=await A(r);if(_.hasConflict){V(_),R(!0);return}if(L){const Z={name:r.name,description:r.description,level:r.level,duration:r.duration,capacity:r.capacity,dayOfWeek:r.schedule?.dayOfWeek,startTime:r.schedule?.startTime,endTime:r.schedule?.endTime,isActive:r.status==="active",location:r.venue},W=await B.theory.updateTheoryLesson(L.id,Z),M={id:W._id,name:W.name,description:W.description,level:W.level,duration:W.duration,capacity:W.capacity,enrolledCount:W.enrolledStudentIds?.length||0,schedule:{dayOfWeek:W.dayOfWeek,startTime:W.startTime,endTime:W.endTime},status:W.isActive?"active":"inactive",venue:W.location,materials:W.materials||[]};S(t=>t.map(a=>a.id===L.id?M:a))}else{const Z=s?._id,W={name:r.name,description:r.description,level:r.level,duration:r.duration,capacity:r.capacity,dayOfWeek:r.schedule?.dayOfWeek,startTime:r.schedule?.startTime,endTime:r.schedule?.endTime,isActive:r.status==="active",location:r.venue,teacherId:Z},M=await B.theory.createTheoryLesson(W),t={id:M._id,name:M.name,description:M.description,level:M.level,duration:M.duration,capacity:M.capacity,enrolledCount:M.enrolledStudentIds?.length||0,schedule:{dayOfWeek:M.dayOfWeek,startTime:M.startTime,endTime:M.endTime},status:M.isActive?"active":"inactive",venue:M.location,materials:M.materials||[]};S(a=>[...a,t])}g(!1),y(null)}catch(_){console.error("Error saving lesson:",_),alert("שגיאה בשמירת פרטי השיעור")}},A=async r=>{try{const _=N.filter(t=>t.id!==L?.id&&t.schedule.dayOfWeek===r.schedule?.dayOfWeek),Z=r.schedule?.startTime,W=r.schedule?.endTime,M=_.filter(t=>{const a=t.schedule.startTime,c=t.schedule.endTime;return Z&&W&&a&&c&&(Z>=a&&Z<c||W>a&&W<=c||Z<=a&&W>=c)});return M.length>0?{hasConflict:!0,conflictDetails:`התנגשות עם ${M[0].name} ב${he(M[0].schedule.dayOfWeek)} ${M[0].schedule.startTime}-${M[0].schedule.endTime}`,suggestions:["שנה את שעת השיעור","העבר ליום אחר","קצר את משך השיעור"]}:{hasConflict:!1}}catch(_){return console.error("Error checking conflicts:",_),{hasConflict:!1}}},te=async()=>{try{const r=await B.students.getStudents(),_=H.map(W=>W.id),Z=r.filter(W=>!_.includes(W._id)).map(W=>({id:W._id,firstName:W.personalInfo?.firstName||"",lastName:W.personalInfo?.lastName||"",grade:W.academicInfo?.gradeLevel,instrument:W.primaryInstrument,enrollmentDate:new Date().toISOString(),attendance:{total:0,present:0,absent:0}}));G(Z)}catch(r){console.error("Error loading available students:",r)}},ie=async r=>{if(m)try{await Fe.enrollStudent(m,r,{method:"manual",performedBy:"teacher",reason:"Teacher enrollment"}),await w(m),await te()}catch(_){console.error("Error enrolling student:",_),alert("שגיאה ברישום התלמיד")}},de=async r=>{if(m)try{await Fe.unenrollStudent(m,r,{reason:"Teacher unenrollment"}),await w(m),await te()}catch(_){console.error("Error unenrolling student:",_),alert("שגיאה בביטול רישום התלמיד")}},me=async r=>{try{const _={...r,name:`${r.name} - עותק`,id:void 0};await Q(_)}catch(_){console.error("Error duplicating lesson:",_),alert("שגיאה בשכפול השיעור")}},oe=r=>{switch(r){case"beginner":return"מתחילים";case"intermediate":return"בינוניים";case"advanced":return"מתקדמים";default:return r}},xe=r=>r.substring(0,5),he=r=>({sunday:"יום ראשון",monday:"יום שני",tuesday:"יום שלישי",wednesday:"יום רביעי",thursday:"יום חמישי",friday:"יום שישי",saturday:"יום שבת"})[r.toLowerCase()]||r;return p?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600",children:"טוען רשימת שיעורים..."})]})}):b?e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("div",{className:"text-red-800 font-reisinger-yonatan",children:b})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:"ניהול תיאוריה מתקדם"}),e.jsxs("p",{className:"text-gray-600 mt-1",children:[N.length," שיעורים פעילים"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>E(!0),className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[e.jsx(rt,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"נהל קבוצות"})]}),e.jsxs("button",{onClick:()=>g(!0),className:"flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors",children:[e.jsx(be,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"הוסף שיעור"})]})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsx("nav",{className:"flex space-x-8 px-6",dir:"rtl",children:[{id:"lessons",label:"שיעורים",icon:Se},{id:"groups",label:"קבוצות",icon:ae},{id:"curriculum",label:"תכנית לימודים",icon:Re},{id:"grades",label:"ציונים",icon:Be}].map(r=>{const _=r.icon;return e.jsxs("button",{onClick:()=>F(r.id),className:`py-4 px-1 border-b-2 font-medium text-sm transition-colors flex items-center gap-2 font-reisinger-yonatan ${x===r.id?"border-indigo-500 text-indigo-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}`,children:[e.jsx(_,{className:"w-4 h-4"}),r.label]},r.id)})})}),e.jsxs("div",{className:"p-6",children:[x==="lessons"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative mb-6",children:[e.jsx(ue,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"חיפוש שיעורים...",value:o,onChange:r=>d(r.target.value),className:"w-full pl-4 pr-12 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"rtl"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsx("div",{className:"space-y-4",children:D.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Se,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2 font-reisinger-yonatan",children:o?"לא נמצאו שיעורים":"אין שיעורים רשומים"}),e.jsx("p",{className:"text-gray-600 font-reisinger-yonatan",children:o?"נסה מילות חיפוש אחרות":"התחל בהוספת השיעור הראשון שלך"})]}):D.map(r=>e.jsxs("div",{className:`bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all cursor-pointer ${m===r.id?"ring-2 ring-indigo-500 bg-indigo-50":""}`,onClick:()=>{z(r.id),w(r.id)},children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-gray-900 font-reisinger-yonatan",children:r.name}),e.jsxs("p",{className:"text-sm text-gray-600 font-reisinger-yonatan",children:[oe(r.level)," • ",r.duration," דקות"]}),r.description&&e.jsx("p",{className:"text-sm text-gray-500 mt-1 font-reisinger-yonatan",children:r.description})]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:_=>{_.stopPropagation(),me(r)},className:"p-1 text-gray-400 hover:text-blue-600 transition-colors",title:"שכפל שיעור",children:e.jsx(nt,{className:"w-4 h-4"})}),e.jsx("button",{onClick:_=>{_.stopPropagation(),y(r),g(!0)},className:"p-1 text-gray-400 hover:text-indigo-600 transition-colors",title:"ערוך שיעור",children:e.jsx(ke,{className:"w-4 h-4"})}),e.jsx("button",{onClick:_=>{_.stopPropagation(),U(r.id)},className:"p-1 text-gray-400 hover:text-red-600 transition-colors",title:"מחק שיעור",children:e.jsx(Ie,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm text-gray-600 mb-3",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ne,{className:"w-4 h-4"}),e.jsx("span",{children:he(r.schedule.dayOfWeek)})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(re,{className:"w-4 h-4"}),e.jsxs("span",{children:[xe(r.schedule.startTime)," - ",xe(r.schedule.endTime)]})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ae,{className:"w-4 h-4"}),e.jsxs("span",{children:[r.enrolledCount||0,"/",r.capacity]})]}),r.venue&&e.jsx("span",{children:r.venue})]}),e.jsx("span",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${r.status==="active"?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"}`,children:r.status==="active"?"פעיל":"לא פעיל"})]})]},r.id))}),m&&e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h4",{className:"font-semibold text-gray-900 font-reisinger-yonatan",children:"תלמידי השיעור"}),e.jsx("div",{className:"flex gap-2",children:e.jsxs("button",{onClick:()=>{u(!0),te()},className:"flex items-center gap-1 text-indigo-600 hover:text-indigo-800 text-sm font-medium font-reisinger-yonatan",children:[e.jsx(le,{className:"w-4 h-4"}),"הוסף תלמיד"]})})]}),H.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(ae,{className:"w-8 h-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-500 text-sm font-reisinger-yonatan",children:"אין תלמידים רשומים לשיעור"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:H.map(r=>e.jsxs("div",{className:"flex items-center justify-between p-3 hover:bg-gray-50 rounded border",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-medium text-sm font-reisinger-yonatan",children:[r.firstName," ",r.lastName]}),e.jsxs("div",{className:"text-xs text-gray-500 font-reisinger-yonatan",children:[r.instrument&&`${r.instrument} • `,r.grade&&`כיתה ${r.grade} • `,"רישום: ",new Date(r.enrollmentDate).toLocaleDateString("he-IL")]}),r.attendance&&e.jsxs("div",{className:"text-xs text-gray-500 mt-1 font-reisinger-yonatan",children:["נוכחות: ",r.attendance.present,"/",r.attendance.total," שיעורים",e.jsxs("span",{className:`ml-2 ${r.attendance.present/r.attendance.total>=.8?"text-green-600":"text-red-600"}`,children:["(",Math.round(r.attendance.present/r.attendance.total*100),"%)"]})]})]}),e.jsx("button",{onClick:()=>de(r.id),className:"text-red-600 hover:text-red-800 p-1",title:"הסר תלמיד",children:e.jsx(ze,{className:"w-4 h-4"})})]},r.id))})]})]})]}),x==="groups"&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ae,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2 font-reisinger-yonatan",children:"ניהול קבוצות תיאוריה"}),e.jsx("p",{className:"text-gray-600 font-reisinger-yonatan",children:"תכונה זו תהיה זמינה בקרוב"})]}),x==="curriculum"&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Re,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2 font-reisinger-yonatan",children:"תכנית לימודים"}),e.jsx("p",{className:"text-gray-600 font-reisinger-yonatan",children:"תכונה זו תהיה זמינה בקרוב"})]}),x==="grades"&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Be,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2 font-reisinger-yonatan",children:"ניהול ציונים"}),e.jsx("p",{className:"text-gray-600 font-reisinger-yonatan",children:"תכונה זו תהיה זמינה בקרוב"})]})]})]}),i&&e.jsx(St,{lesson:L,onClose:()=>{g(!1),y(null)},onSubmit:Q}),X&&e.jsx(Tt,{availableStudents:C,onClose:()=>u(!1),onEnroll:ie}),v&&O&&e.jsx(Ct,{conflict:O,onClose:()=>R(!1),onResolve:()=>{R(!1),g(!0)}})]})}function St({lesson:s,onClose:N,onSubmit:S}){const[p,h]=n.useState({name:s?.name||"",description:s?.description||"",level:s?.level||"beginner",duration:s?.duration||60,capacity:s?.capacity||15,status:s?.status||"active",venue:s?.venue||"",schedule:{dayOfWeek:s?.schedule?.dayOfWeek||"sunday",startTime:s?.schedule?.startTime||"09:00",endTime:s?.schedule?.endTime||"10:00"}}),o=i=>{i.preventDefault(),S(p)},d=(i,g)=>{h(L=>({...L,schedule:{...L.schedule,[i]:g}}))};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto",dir:"rtl",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900 mb-4 font-reisinger-yonatan",children:s?"עריכת שיעור תיאוריה":"הוספת שיעור תיאוריה חדש"}),e.jsxs("form",{onSubmit:o,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שם השיעור *"}),e.jsx("input",{type:"text",required:!0,value:p.name,onChange:i=>h(g=>({...g,name:i.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"תיאור השיעור"}),e.jsx("textarea",{value:p.description,onChange:i=>h(g=>({...g,description:i.target.value})),rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"רמה *"}),e.jsxs("select",{required:!0,value:p.level,onChange:i=>h(g=>({...g,level:i.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"beginner",children:"מתחילים"}),e.jsx("option",{value:"intermediate",children:"בינוניים"}),e.jsx("option",{value:"advanced",children:"מתקדמים"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"משך השיעור (דקות) *"}),e.jsx("input",{type:"number",required:!0,min:"30",max:"180",step:"15",value:p.duration,onChange:i=>h(g=>({...g,duration:parseInt(i.target.value)})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"קיבולת תלמידים *"}),e.jsx("input",{type:"number",required:!0,min:"1",max:"50",value:p.capacity,onChange:i=>h(g=>({...g,capacity:parseInt(i.target.value)})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"סטטוס"}),e.jsxs("select",{value:p.status,onChange:i=>h(g=>({...g,status:i.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"active",children:"פעיל"}),e.jsx("option",{value:"inactive",children:"לא פעיל"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"יום השיעור *"}),e.jsxs("select",{required:!0,value:p.schedule.dayOfWeek,onChange:i=>d("dayOfWeek",i.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"sunday",children:"יום ראשון"}),e.jsx("option",{value:"monday",children:"יום שני"}),e.jsx("option",{value:"tuesday",children:"יום שלישי"}),e.jsx("option",{value:"wednesday",children:"יום רביעי"}),e.jsx("option",{value:"thursday",children:"יום חמישי"}),e.jsx("option",{value:"friday",children:"יום שישי"}),e.jsx("option",{value:"saturday",children:"יום שבת"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שעת התחלה *"}),e.jsx("input",{type:"time",required:!0,value:p.schedule.startTime,onChange:i=>d("startTime",i.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שעת סיום *"}),e.jsx("input",{type:"time",required:!0,value:p.schedule.endTime,onChange:i=>d("endTime",i.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"מקום השיעור"}),e.jsx("input",{type:"text",value:p.venue,onChange:i=>h(g=>({...g,venue:i.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx("button",{type:"submit",className:"flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors font-reisinger-yonatan",children:s?"עדכן":"הוסף"}),e.jsx("button",{type:"button",onClick:N,className:"flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors font-reisinger-yonatan",children:"ביטול"})]})]})]})})}function Tt({availableStudents:s,onClose:N,onEnroll:S}){const[p,h]=n.useState(""),o=s.filter(d=>`${d.firstName} ${d.lastName}`.toLowerCase().includes(p.toLowerCase())||d.instrument?.toLowerCase().includes(p.toLowerCase()));return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-md mx-4 max-h-[80vh] overflow-y-auto",dir:"rtl",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900 mb-4 font-reisinger-yonatan",children:"הוסף תלמיד לשיעור"}),e.jsxs("div",{className:"relative mb-4",children:[e.jsx(ue,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"text",placeholder:"חיפוש תלמידים...",value:p,onChange:d=>h(d.target.value),className:"w-full pl-4 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto",children:o.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(ae,{className:"w-8 h-8 mx-auto mb-2 text-gray-300"}),e.jsx("p",{className:"font-reisinger-yonatan",children:"אין תלמידים זמינים"})]}):o.map(d=>e.jsxs("div",{className:"flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium text-gray-900 font-reisinger-yonatan",children:[d.firstName," ",d.lastName]}),e.jsxs("div",{className:"text-sm text-gray-600 font-reisinger-yonatan",children:[d.instrument&&`${d.instrument} • `,d.grade&&`כיתה ${d.grade}`]})]}),e.jsxs("button",{onClick:()=>S(d.id),className:"flex items-center gap-1 px-3 py-1 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm font-reisinger-yonatan",children:[e.jsx(le,{className:"w-4 h-4"}),"הוסף"]})]},d.id))}),e.jsx("div",{className:"flex gap-3 mt-6",children:e.jsx("button",{onClick:N,className:"flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors font-reisinger-yonatan",children:"סגור"})})]})})}function Ct({conflict:s,onClose:N,onResolve:S}){return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-md mx-4",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx(it,{className:"w-8 h-8 text-yellow-600"}),e.jsx("h3",{className:"text-lg font-bold text-gray-900 font-reisinger-yonatan",children:"התנגשות בלוח הזמנים"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-gray-700 font-reisinger-yonatan mb-3",children:s.conflictDetails}),s.suggestions&&e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900 mb-2 font-reisinger-yonatan",children:"הצעות לפתרון:"}),e.jsx("ul",{className:"list-disc list-inside space-y-1 text-sm text-gray-600",children:s.suggestions.map((p,h)=>e.jsx("li",{className:"font-reisinger-yonatan",children:p},h))})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:S,className:"flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors font-reisinger-yonatan",children:"ערוך שיעור"}),e.jsx("button",{onClick:N,className:"flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors font-reisinger-yonatan",children:"ביטול"})]})]})})}function kt(){const{user:s,checkAuthStatus:N}=je(),[S,p]=n.useState(!1),[h,o]=n.useState(!1),[d,i]=n.useState({type:null,message:""}),[g,L]=n.useState(null),[y,m]=n.useState({fullName:"",email:"",phone:"",address:"",birthDate:""});n.useEffect(()=>{z()},[]);const z=async()=>{try{o(!0);const f=await De.getMyProfile();L(f),m({fullName:f?.personalInfo?.fullName||"",email:f?.personalInfo?.email||"",phone:f?.personalInfo?.phone||"",address:f?.personalInfo?.address||"",birthDate:f?.personalInfo?.birthDate||""})}catch(f){console.error("Error fetching profile data:",f),i({type:"error",message:"שגיאה בטעינת פרטי הפרופיל"}),s&&m({fullName:s?.personalInfo?.fullName||"",email:s?.personalInfo?.email||s?.email||"",phone:s?.personalInfo?.phone||s?.phone||"",address:s?.personalInfo?.address||s?.address||"",birthDate:s?.personalInfo?.birthDate||s?.birthDate||""})}finally{o(!1)}},H=async()=>{try{o(!0),i({type:null,message:""});const f=await De.updateMyProfile(y);L(f),N&&await N(!0),p(!1),i({type:"success",message:"הפרופיל עודכן בהצלחה"}),setTimeout(()=>{i({type:null,message:""})},3e3)}catch(f){console.error("Error updating profile:",f),i({type:"error",message:"שגיאה בעדכון הפרופיל. אנא נסה שוב."})}finally{o(!1)}},l=()=>{const f=g||s;m({fullName:f?.personalInfo?.fullName||"",email:f?.personalInfo?.email||f?.email||"",phone:f?.personalInfo?.phone||f?.phone||"",address:f?.personalInfo?.address||f?.address||"",birthDate:f?.personalInfo?.birthDate||f?.birthDate||""}),p(!1),i({type:null,message:""})},b=f=>f?new Date(f).toLocaleDateString("he-IL"):"",k=g||s;return h&&!k?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"}),e.jsx("p",{className:"mt-4 text-gray-600 font-reisinger-yonatan",children:"טוען פרטי פרופיל..."})]})}):e.jsxs("div",{className:"space-y-6",children:[d.type&&e.jsxs("div",{className:`p-4 rounded-lg flex items-center gap-2 ${d.type==="success"?"bg-green-50 text-green-800 border border-green-200":"bg-red-50 text-red-800 border border-red-200"}`,children:[d.type==="success"?e.jsx(Ae,{className:"w-5 h-5"}):e.jsx(Oe,{className:"w-5 h-5"}),e.jsx("span",{className:"font-reisinger-yonatan",children:d.message})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:"פרטים אישיים"}),S?e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:H,disabled:h,className:"flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[h?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}):e.jsx(ot,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"שמירה"})]}),e.jsxs("button",{onClick:l,disabled:h,className:"flex items-center gap-2 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(ve,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"ביטול"})]})]}):e.jsxs("button",{onClick:()=>p(!0),disabled:h,className:"flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(lt,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"עריכה"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 font-reisinger-yonatan",children:"שם מלא"}),S?e.jsx("input",{type:"text",value:y.fullName,onChange:f=>m(E=>({...E,fullName:f.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"rtl",placeholder:"הזן שם מלא"}):e.jsx("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:e.jsx("span",{className:"font-reisinger-yonatan",children:y.fullName||"לא צוין"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 font-reisinger-yonatan",children:'דוא"ל'}),S?e.jsx("input",{type:"email",value:y.email,onChange:f=>m(E=>({...E,email:f.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"ltr",placeholder:"example@email.com"}):e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:[e.jsx(ct,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"font-reisinger-yonatan",dir:"ltr",children:y.email||"לא צוין"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 font-reisinger-yonatan",children:"טלפון"}),S?e.jsx("input",{type:"tel",value:y.phone,onChange:f=>m(E=>({...E,phone:f.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"ltr",placeholder:"050-1234567"}):e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:[e.jsx(We,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"font-reisinger-yonatan",dir:"ltr",children:y.phone||"לא צוין"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 font-reisinger-yonatan",children:"כתובת"}),S?e.jsx("input",{type:"text",value:y.address,onChange:f=>m(E=>({...E,address:f.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"rtl",placeholder:"הזן כתובת"}):e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:[e.jsx(ge,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"font-reisinger-yonatan",children:y.address||"לא צוין"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 font-reisinger-yonatan",children:"תאריך לידה"}),S?e.jsx("input",{type:"date",value:y.birthDate,onChange:f=>m(E=>({...E,birthDate:f.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"}):e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:[e.jsx(ne,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"font-reisinger-yonatan",children:b(y.birthDate)||"לא צוין"})]})]})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("h4",{className:"text-lg font-semibold text-blue-900 mb-2 font-reisinger-yonatan",children:"מידע תפקיד"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-sm font-medium text-blue-700 font-reisinger-yonatan",children:"תפקיד:"}),e.jsx("div",{className:"text-blue-900 font-reisinger-yonatan",children:(()=>{const f=k?.roles||[];if(f.length>0)return f.join(", ");const E=k?.role||"";switch(E){case"teacher":return"מורה";case"מורה":return"מורה";case"conductor":return"מנצח";case"מנצח":return"מנצח";case"theory_teacher":return"מורה תיאוריה";case"מורה תיאוריה":return"מורה תיאוריה";case"admin":return"מנהל";case"מנהל":return"מנהל";default:return E||"לא צוין"}})()})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-sm font-medium text-blue-700 font-reisinger-yonatan",children:"מזהה משתמש:"}),e.jsx("div",{className:"text-blue-900 font-reisinger-yonatan font-mono text-sm",children:k?.teacherId||k?._id||k?.id||"לא צוין"})]}),k?.isActive!==void 0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-sm font-medium text-blue-700 font-reisinger-yonatan",children:"סטטוס:"}),e.jsx("div",{className:"text-blue-900 font-reisinger-yonatan",children:k.isActive?"פעיל":"לא פעיל"})]}),k?.professionalInfo?.instrument&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-sm font-medium text-blue-700 font-reisinger-yonatan",children:"כלי נגינה:"}),e.jsx("div",{className:"text-blue-900 font-reisinger-yonatan",children:k.professionalInfo.instrument})]})]})]})]})}function _t(){const{user:s}=je(),N=Ze();Ye();const[S,p]=n.useState("general"),[h,o]=n.useState(null),[d,i]=n.useState(!0);n.useEffect(()=>{const u=N.state;u?.activeTab&&(p(u.activeTab),window.history.replaceState(null,"",window.location.pathname))},[N]),n.useEffect(()=>{s&&g()},[s]);const g=async()=>{try{if(i(!0),!(s?._id||s?.teacherId||s?.id)){console.warn("No user ID available for loading profile statistics");return}const v=await De.getMyProfile();if(!v){console.warn("No teacher profile found"),o({studentsCount:0,activeStudents:0,weeklyHours:0,orchestrasCount:0,theoryLessonsCount:0});return}const R=v?.teaching?.studentIds||[],C=v?.conducting?.orchestraIds||[],G=v?.teaching?.timeBlocks||[],[O,V]=await Promise.allSettled([R.length>0?B.students.getBatchStudents(R):Promise.resolve([]),C.length>0?B.orchestras.getBatchOrchestras(C):Promise.resolve([])]),x=O.status==="fulfilled"?O.value:[];O.status==="rejected"&&console.error("Failed to load student data:",O.reason);const F=V.status==="fulfilled"?V.value:[];V.status==="rejected"&&console.error("Failed to load orchestra data:",V.reason);const $=Array.isArray(x)?x.filter(U=>U.academicInfo?.isActive!==!1):[],w=Array.isArray(G)?G.reduce((U,Q)=>U+(parseInt(Q.totalDuration)||0),0):0,D=Math.round(w/60*10)/10;o({studentsCount:Array.isArray(x)?x.length:0,activeStudents:$.length,weeklyHours:D,orchestrasCount:Array.isArray(F)?F.length:0,theoryLessonsCount:0})}catch(u){console.error("Error loading profile statistics:",u),o({studentsCount:0,activeStudents:0,weeklyHours:0,orchestrasCount:0,theoryLessonsCount:0})}finally{i(!1)}};if(!s)return e.jsx("div",{className:"flex items-center justify-center min-h-96",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600",children:"טוען פרטי משתמש..."})]})});const L=()=>s?.roles?.includes("conductor")||s?.roles?.includes("מנצח")||s?.conducting?.orchestraIds&&s.conducting.orchestraIds.length>0,y=()=>s?.roles?.includes("teacher")||s?.roles?.includes("מורה")||s?.teaching?.studentIds&&s.teaching.studentIds.length>0,m=()=>s?.roles?.includes("theory_teacher")||s?.roles?.includes("מורה תאוריה"),H=(()=>{const v=[...[{id:"general",label:"פרטים כלליים",icon:we,component:kt}]];return y()&&(v.push({id:"students",label:"התלמידים שלי",icon:ae,component:gt}),v.push({id:"schedule",label:"לוח זמנים שבועי",icon:ne,component:yt})),L()&&v.push({id:"orchestras",label:"התזמורות שלי",icon:ye,component:ft}),m()&&v.push({id:"lessons",label:"שיעורי התיאוריה שלי",icon:Se,component:wt}),v})(),b=(H.find(u=>u.id===S)||H[0]).component,k=()=>{const u=s?.role||s?.roles?.[0]||"";switch(u){case"teacher":return"מורה";case"מורה":return"מורה";case"conductor":return"מנצח";case"מנצח":return"מנצח";case"theory_teacher":return"מורה תיאוריה";case"מורה תיאוריה":return"מורה תיאוריה";case"admin":return"מנהל";case"מנהל":return"מנהל";default:return u||"משתמש"}},f=()=>s?.personalInfo?.fullName||s?.fullName||s?.name||"משתמש",E=()=>{const u=f();if(!u||u==="משתמש")return"מ";const v=u.trim().split(" ");return v.length>=2?v[0][0]+v[1][0]:v[0][0]||"מ"},X=()=>s?.personalInfo?.email||s?.email||"";return e.jsxs("div",{className:"p-6",dir:"rtl",children:[e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-indigo-600 flex items-center justify-center",children:e.jsx("span",{className:"text-xl font-bold text-white font-reisinger-yonatan",children:E()})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 font-reisinger-yonatan",children:f()}),e.jsxs("p",{className:"text-gray-600 mt-1",children:[k()," • ",X()]})]})]})}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-6",children:[e.jsx(Ce,{title:"סה״כ תלמידים",value:d?"...":h?.studentsCount?.toString()||"0",icon:ae,color:"blue",loading:d}),e.jsx(Ce,{title:"תלמידים פעילים",value:d?"...":h?.activeStudents?.toString()||"0",icon:dt,color:"green",loading:d}),e.jsx(Ce,{title:"שעות שבועיות",value:d?"...":h?.weeklyHours?.toString()||"0",icon:re,color:"purple",loading:d}),e.jsx(Ce,{title:L()?"תזמורות":"שיעורי תיאוריה",value:d?"...":(h?.orchestrasCount||h?.theoryLessonsCount)?.toString()||"0",icon:L()?ye:Se,color:"indigo",loading:d})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 mb-6",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsx("nav",{className:"flex gap-0 overflow-x-auto scrollbar-hide",children:H.map(u=>{const v=u.icon;return e.jsxs("button",{onClick:()=>p(u.id),className:`flex items-center gap-2 sm:gap-3 px-3 sm:px-6 py-3 sm:py-4 font-medium text-xs sm:text-sm transition-all whitespace-nowrap ${S===u.id?"text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50":"text-gray-500 hover:text-gray-700 hover:bg-gray-50"}`,children:[e.jsx(v,{className:"w-5 h-5"}),e.jsx("span",{className:"font-reisinger-yonatan",children:u.label})]},u.id)})})}),e.jsx("div",{className:"p-6",children:e.jsx(b,{})})]})]})}function Ce({title:s,value:N,icon:S,color:p,loading:h}){const d={blue:{bg:"bg-blue-50",text:"text-blue-600",border:"border-blue-200"},green:{bg:"bg-green-50",text:"text-green-600",border:"border-green-200"},purple:{bg:"bg-purple-50",text:"text-purple-600",border:"border-purple-200"},indigo:{bg:"bg-indigo-50",text:"text-indigo-600",border:"border-indigo-200"}}[p];return e.jsx("div",{className:`bg-white rounded-lg border ${d.border} p-3 sm:p-4 shadow-sm hover:shadow-md transition-all duration-200`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-xs sm:text-sm font-medium text-gray-600 font-reisinger-yonatan truncate",children:s}),e.jsx("div",{className:"text-lg sm:text-2xl font-bold text-gray-900 mt-1 font-reisinger-yonatan",children:h?e.jsx("div",{className:"animate-pulse bg-gray-200 h-6 sm:h-8 w-12 sm:w-16 rounded"}):N})]}),e.jsx("div",{className:`${d.bg} p-2 sm:p-3 rounded-full flex-shrink-0 ml-2`,children:e.jsx(S,{className:`w-4 h-4 sm:w-6 sm:h-6 ${d.text}`})})]})})}export{_t as default};
