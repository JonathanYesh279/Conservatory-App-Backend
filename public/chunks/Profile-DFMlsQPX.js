import{j as e,u as je,V as Ee}from"../assets/index-Y6gcqfIP.js";import{R as tt,r as o,u as st,b as at}from"./vendor-E-WBaSU9.js";import{a as R,t as De}from"./cascade-deletion-MikTgWpr.js";import{M as ue,J as Me,O as ke,T as Ie,U as we,e as xe,Z as ze,b as ae,d as re,r as Ue,u as rt,c as Ge,A as Ae,t as le,m as ge,X as ve,f as se,P as be,ab as Ve,V as nt,E as it,ac as lt,B as ye,v as Oe,g as ot,G as Pe,W as Re,an as ct,j as dt,ah as mt,S as ut,a3 as gt,K as xt}from"./ui-DIGiJ8tL.js";import{t as Be}from"./theoryEnrollmentService-Bw4SayZ7.js";import"./query-CMzvnXZ6.js";import"./utils-Cgyyg58q.js";function ht({student:t,onEdit:S,onDelete:T,onViewDetails:y,onScheduleLesson:h,onMarkAttendance:c,onAddNote:m,className:l=""}){const g=t.academicInfo?.instrumentProgress?.find(b=>b.isPrimary)||t.academicInfo?.instrumentProgress?.[0],D=g?.instrumentName||"לא הוגדר",p=g?.currentStage||0,u=t.scheduleInfo||t.teacherAssignments?.[0],F=u?`${u.day} ${u.startTime||u.time}`:null,q=u?.duration||60,i=!!u,v=t.academicInfo?.isActive!==!1&&t.status!=="inactive",I=v?"text-green-800 bg-green-100":"text-red-800 bg-red-100",d=v?"פעיל":"לא פעיל",C=v?Ge:Ae,H=i?"border-2 border-green-400 shadow-sm shadow-green-200":"border border-gray-200";return e.jsxs("div",{className:`bg-white ${H} rounded-lg hover:shadow-lg hover:border-indigo-300 transition-all duration-200 transform hover:-translate-y-1 group ${l}`,children:[e.jsx("div",{className:"px-4 py-3 border-b border-gray-100",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h4",{className:"font-semibold text-gray-900 font-reisinger-yonatan text-lg",children:t.personalInfo.fullName}),e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${I}`,children:[tt.createElement(C,{className:"w-3 h-3"}),d]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(ue,{className:"w-4 h-4 text-indigo-500"}),e.jsx("span",{className:"font-reisinger-yonatan font-medium",children:D}),p>0&&e.jsxs("span",{className:"text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full font-reisinger-yonatan",children:["שלב ",p]})]})]}),e.jsxs("div",{className:"flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:[e.jsx("button",{onClick:()=>y(t.id),className:"p-1.5 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all duration-200",title:"צפה בפרטים מלאים",children:e.jsx(Me,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>S(t),className:"p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all duration-200",title:"עריכת תלמיד",children:e.jsx(ke,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>T(t.id),className:"p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all duration-200",title:"מחיקת תלמיד",children:e.jsx(Ie,{className:"w-4 h-4"})})]})]})}),e.jsxs("div",{className:"px-4 py-3 space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{className:"space-y-1",children:[t.personalInfo.age&&e.jsxs("div",{className:"flex items-center gap-2 text-gray-600",children:[e.jsx(we,{className:"w-3 h-3"}),e.jsxs("span",{className:"font-reisinger-yonatan",children:["גיל: ",t.personalInfo.age]})]}),t.personalInfo.class&&e.jsxs("div",{className:"flex items-center gap-2 text-gray-600",children:[e.jsx(xe,{className:"w-3 h-3"}),e.jsxs("span",{className:"font-reisinger-yonatan",children:["כיתה: ",t.personalInfo.class]})]})]}),e.jsx("div",{className:"space-y-1",children:t.personalInfo.phone&&e.jsxs("div",{className:"flex items-center gap-2 text-gray-600",dir:"ltr",children:[e.jsx(ze,{className:"w-3 h-3"}),e.jsx("span",{className:"font-mono text-xs",children:t.personalInfo.phone})]})})]}),F&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-blue-800 font-reisinger-yonatan",children:[e.jsx(ae,{className:"w-4 h-4"}),e.jsx("span",{className:"font-medium",children:"שיעור קבוע:"})]}),e.jsxs("div",{className:"flex items-center justify-between mt-1",children:[e.jsx("span",{className:"text-sm font-reisinger-yonatan text-blue-700",children:F}),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-blue-600",children:[e.jsx(re,{className:"w-3 h-3"}),e.jsxs("span",{children:[q," דק'"]})]})]})]})]}),e.jsx("div",{className:"px-4 py-3 border-t border-gray-100 bg-gray-50",children:e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("button",{onClick:()=>y(t.id),className:"text-indigo-600 hover:text-indigo-800 hover:bg-indigo-100 px-3 py-1 rounded-lg text-sm font-medium font-reisinger-yonatan transition-all duration-200 flex items-center gap-1",children:[e.jsx(Me,{className:"w-4 h-4"}),"פרטים מלאים"]}),h&&e.jsxs("button",{onClick:()=>h(t.id),className:"text-green-600 hover:text-green-800 hover:bg-green-100 px-3 py-1 rounded-lg text-sm font-medium font-reisinger-yonatan transition-all duration-200 flex items-center gap-1",children:[e.jsx(ae,{className:"w-4 h-4"}),"קבע שיעור"]}),c&&e.jsxs("button",{onClick:()=>c(t.id),className:"text-blue-600 hover:text-blue-800 hover:bg-blue-100 px-3 py-1 rounded-lg text-sm font-medium font-reisinger-yonatan transition-all duration-200 flex items-center gap-1",children:[e.jsx(Ue,{className:"w-4 h-4"}),"נוכחות"]}),m&&e.jsxs("button",{onClick:()=>m(t.id),className:"text-yellow-600 hover:text-yellow-800 hover:bg-yellow-100 px-3 py-1 rounded-lg text-sm font-medium font-reisinger-yonatan transition-all duration-200 flex items-center gap-1",children:[e.jsx(rt,{className:"w-4 h-4"}),"הערה"]})]})})]})}function Fe(){const{user:t}=je(),[S,T]=o.useState([]),[y,h]=o.useState(!0),[c,m]=o.useState("");o.useState(!1),o.useState(null);const[l,g]=o.useState(null),[D,p]=o.useState(0);o.useState(!1);const[u,F]=o.useState({status:"all",instrument:"all",hasSchedule:"all",bagrutStatus:"all"});o.useState("cards"),o.useState(new Set),o.useState(!1);const[q,i]=o.useState(!1),[v,I]=o.useState([]),[d,C]=o.useState(!1);o.useEffect(()=>{H()},[t]);const H=async(f=!0)=>{if(t?._id)try{f&&h(!0),g(null);const B=t._id,M=await R.teachers.getTeacher(B);if(!M)throw new Error("לא נמצא פרופיל מורה");const A=M?.teaching?.studentIds||[];if(A.length===0){console.log("No students assigned to teacher"),T([]),p(0);return}const P=await R.students.getBatchStudents(A);if(!Array.isArray(P))throw new Error("תגובה לא תקינה מהשרת");const U=P.filter(O=>A.includes(O._id)||A.includes(O.id));U.length!==P.length&&console.warn(`🔧 Component-level filtering: ${U.length}/${P.length} students match teacher's student IDs`);const J=U.map(O=>{const ee=O.personalInfo?.fullName||"",ne=ee.split(" ");return{id:O._id,firstName:O.personalInfo?.firstName||ne[0]||"",lastName:O.personalInfo?.lastName||ne.slice(1).join(" ")||"",fullName:ee,email:O.personalInfo?.email||O.contactInfo?.email||"",phone:O.personalInfo?.phone||O.contactInfo?.phone||"",instrument:O.academicInfo?.primaryInstrument||O.primaryInstrument||"",grade:O.academicInfo?.gradeLevel||"",status:O.academicInfo?.isActive!==!1?"active":"inactive",joinDate:O.createdAt,personalInfo:{fullName:ee,phone:O.personalInfo?.phone||O.contactInfo?.phone,age:O.personalInfo?.age,class:O.personalInfo?.class||O.academicInfo?.class},academicInfo:{instrumentProgress:O.academicInfo?.instrumentProgress||[],isActive:O.academicInfo?.isActive!==!1},teacherAssignments:O.teacherAssignments||[],scheduleInfo:O.scheduleInfo}});T(J),p(0)}catch(B){console.error("Error loading teacher students:",B),g("שגיאה בטעינת רשימת התלמידים. בדוק את החיבור לאינטרנט ונסה שוב."),p(M=>M+1)}finally{f&&h(!1)}},b=async()=>{try{C(!0);const f=await R.students.getStudents();if(!f||!Array.isArray(f)){console.error("Invalid response from getStudents"),I([]);return}const B=t?._id,A=(await R.teachers.getTeacher(B))?.teaching?.studentIds||[],P=f.filter(U=>!A.includes(U._id)&&!A.includes(U.id));I(P)}catch(f){console.error("Error loading all students:",f),I([])}finally{C(!1)}},L=S.filter(f=>{const B=c===""||`${f.firstName} ${f.lastName}`.toLowerCase().includes(c.toLowerCase())||f.instrument?.toLowerCase().includes(c.toLowerCase())||f.email?.toLowerCase().includes(c.toLowerCase()),M=u.status==="all"||f.status===u.status,A=u.instrument==="all"||f.instrument===u.instrument,P=f.scheduleInfo||f.teacherAssignments?.length>0,U=u.hasSchedule==="all"||u.hasSchedule==="yes"&&P||u.hasSchedule==="no"&&!P,J=f.academicInfo?.isBagrutStudent||f.academicInfo?.instrumentProgress?.some(ee=>ee.currentStage>=4),O=u.bagrutStatus==="all"||u.bagrutStatus==="yes"&&J||u.bagrutStatus==="no"&&!J;return B&&M&&A&&U&&O}),E=async f=>{const B=S.find(A=>A.id===f),M=B?.personalInfo?.fullName||B?.fullName||"התלמיד";if(window.confirm(`האם אתה בטוח שברצונך למחוק את ${M}?

פעולה זו תמחק את כל הנתונים הקשורים לתלמיד ולא ניתנת לביטול.`))try{await R.students.deleteStudent(f),T(P=>P.filter(U=>U.id!==f));const A=document.createElement("div");A.className="fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg z-50",A.innerHTML=`<div class="flex items-center gap-2 font-reisinger-yonatan"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>${M} נמחק בהצלחה</div>`,document.body.appendChild(A),setTimeout(()=>A.remove(),3e3)}catch(A){console.error("Error deleting student:",A);const P=document.createElement("div");P.className="fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg z-50",P.innerHTML=`<div class="flex items-center gap-2 font-reisinger-yonatan"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>שגיאה במחיקת ${M}</div>`,document.body.appendChild(P),setTimeout(()=>P.remove(),5e3)}},k=f=>{window.location.href=`/students/${f}`},W=f=>{S.find(M=>M.id===f)&&(window.location.href=`/teacher/schedule?student=${f}`)},_=(f,B)=>{const M=document.createElement("div");M.className=`fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 ${B==="success"?"bg-green-500 text-white":B==="error"?"bg-red-500 text-white":"bg-blue-500 text-white"}`,M.innerHTML=`<div class="flex items-center gap-2 font-reisinger-yonatan">
      ${B==="success"?"✅":B==="error"?"❌":"ℹ️"} ${f}
    </div>`,document.body.appendChild(M),setTimeout(()=>M.remove(),3e3)},K=async(f,B)=>{try{const M=t?._id,A=await R.students.getStudent(f._id),P=(A.teacherAssignments||[]).findIndex(O=>O.teacherId===M),U={teacherId:M,day:B.lessonDay,time:B.lessonTime,duration:B.lessonDuration||45,location:B.lessonLocation||"",isActive:!0};let J;P>=0?(J=[...A.teacherAssignments||[]],J[P]={...J[P],...U}):J=[...A.teacherAssignments||[],U],await R.students.updateStudent(f._id,{teacherAssignments:J}),await H(),_(`${f.personalInfo?.fullName} הוקצה בהצלחה`,"success"),i(!1)}catch(M){console.error("Error assigning student:",M),_("שגיאה בהקצאת התלמיד","error")}};return y?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600",children:"טוען רשימת תלמידים..."})]})}):l?e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-red-100 flex items-center justify-center",children:e.jsx("svg",{className:"w-4 h-4 text-red-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.728-.833-2.498 0L4.316 15.5c-.77.833.192 2.5 1.732 2.5z"})})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-red-800 font-semibold font-reisinger-yonatan",children:"שגיאה בטעינת הנתונים"}),e.jsx("p",{className:"text-red-700 text-sm font-reisinger-yonatan mt-1",children:l})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>H(),className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm font-reisinger-yonatan",children:"נסה שוב"}),D>2&&e.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm font-reisinger-yonatan",children:"רענן דף"})]})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:"התלמידים שלי"}),e.jsxs("p",{className:"text-gray-600 mt-1",children:[S.length," תלמידים רשומים"]})]}),e.jsxs("button",{onClick:()=>{i(!0),b()},className:"flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors",children:[e.jsx(le,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"הקצה תלמיד"})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(ge,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"חיפוש תלמידים...",value:c,onChange:f=>m(f.target.value),className:"w-full pl-4 pr-12 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"rtl"})]}),L.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(le,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2 font-reisinger-yonatan",children:c?"לא נמצאו תלמידים":"אין תלמידים רשומים"}),e.jsx("p",{className:"text-gray-600 font-reisinger-yonatan",children:c?"נסה מילות חיפוש אחרות":"התחל בהוספת התלמיד הראשון שלך"}),!c&&e.jsxs("button",{onClick:()=>{i(!0),b()},className:"mt-4 inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-reisinger-yonatan",children:[e.jsx(le,{className:"w-4 h-4"}),"הקצה תלמיד ראשון"]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{className:"w-5 h-5 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-900 font-reisinger-yonatan",children:"סה״כ תלמידים"})]}),e.jsx("div",{className:"text-2xl font-bold text-blue-900 mt-1",children:S.length})]}),e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Me,{className:"w-5 h-5 text-green-600"}),e.jsx("span",{className:"font-medium text-green-900 font-reisinger-yonatan",children:"פעילים"})]}),e.jsx("div",{className:"text-2xl font-bold text-green-900 mt-1",children:S.filter(f=>f.status==="active").length})]}),e.jsxs("div",{className:"bg-purple-50 border border-purple-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ae,{className:"w-5 h-5 text-purple-600"}),e.jsx("span",{className:"font-medium text-purple-900 font-reisinger-yonatan",children:"עם שיעורים"})]}),e.jsx("div",{className:"text-2xl font-bold text-purple-900 mt-1",children:S.filter(f=>f.scheduleInfo||f.teacherAssignments?.length>0).length})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6",children:L.map(f=>e.jsx(ht,{student:f,onEdit:B=>{alert("עריכת תלמיד זמינה רק למנהלים")},onDelete:E,onViewDetails:k,onScheduleLesson:W},f.id))})]}),q&&e.jsx(ft,{allStudents:v,loading:d,onClose:()=>{i(!1),I([])},onSubmit:K})]})}function ft({allStudents:t,loading:S,onClose:T,onSubmit:y}){const[h,c]=o.useState(""),[m,l]=o.useState(null),[g,D]=o.useState({instrument:"",lessonDay:"",lessonTime:"",lessonDuration:45,lessonLocation:""}),[p,u]=o.useState(!1),F=t.filter(i=>{const v=h.toLowerCase().trim();if(!v)return!0;const I=i.personalInfo?.fullName||`${i.personalInfo?.firstName||""} ${i.personalInfo?.lastName||""}`.trim(),d=i.personalInfo?.class||i.academicInfo?.class||"",C=[i.academicInfo?.primaryInstrument,...i.academicInfo?.instrumentProgress?.map(L=>L.instrumentName)||[]].filter(Boolean).join(" "),H=`${I} ${d} ${C}`.toLowerCase();return v.split(/\s+/).filter(L=>L.length>0).every(L=>H.includes(L))}),q=async i=>{if(i.preventDefault(),!m){alert("אנא בחר תלמיד");return}if(!g.instrument){alert("אנא בחר כלי נגינה");return}u(!0);try{await y(m,g)}catch(v){console.error("Error submitting assignment:",v)}finally{u(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-hidden flex flex-col",dir:"rtl",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 mb-4 font-reisinger-yonatan",children:"הקצאת תלמיד קיים"}),S?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"}),e.jsx("span",{className:"mr-3 text-gray-600",children:"טוען רשימת תלמידים..."})]}):e.jsxs("form",{onSubmit:q,className:"flex flex-col flex-1 overflow-hidden",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:"חפש תלמיד במערכת"}),e.jsxs("div",{className:"relative",children:[e.jsx(ge,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"חפש לפי שם, כיתה או כלי נגינה...",value:h,onChange:i=>c(i.target.value),className:"w-full pl-4 pr-12 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"rtl"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto mb-4 border border-gray-200 rounded-lg",children:F.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:h?"לא נמצאו תלמידים התואמים את החיפוש":"אין תלמידים זמינים להקצאה"}):e.jsx("div",{className:"divide-y divide-gray-200",children:F.map(i=>{const v=i.personalInfo?.fullName||`${i.personalInfo?.firstName||""} ${i.personalInfo?.lastName||""}`.trim(),I=i.personalInfo?.class||i.academicInfo?.class||"",d=i.academicInfo?.primaryInstrument||"",C=m?._id===i._id;return e.jsx("div",{onClick:()=>l(i),className:`p-3 cursor-pointer transition-colors ${C?"bg-indigo-50 border-r-4 border-indigo-600":"hover:bg-gray-50"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:v}),e.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:[I&&e.jsxs("span",{children:["כיתה ",I]}),d&&e.jsxs(e.Fragment,{children:[I&&" • ",e.jsx("span",{children:d})]})]})]}),C&&e.jsx("div",{className:"w-6 h-6 bg-indigo-600 rounded-full flex items-center justify-center",children:e.jsx(Ue,{className:"w-4 h-4 text-white"})})]})},i._id)})})}),m&&e.jsxs("div",{className:"space-y-4 border-t pt-4",children:[e.jsxs("h4",{className:"font-medium text-gray-900 font-reisinger-yonatan",children:["פרטי השיעור עבור ",m.personalInfo?.fullName]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"כלי נגינה לשיעור *"}),e.jsxs("select",{value:g.instrument,onChange:i=>D(v=>({...v,instrument:i.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",required:!0,children:[e.jsx("option",{value:"",children:"בחר כלי נגינה"}),e.jsx("option",{value:"פסנתר",children:"פסנתר"}),e.jsx("option",{value:"כינור",children:"כינור"}),e.jsx("option",{value:"צ'לו",children:"צ'לו"}),e.jsx("option",{value:"ויולה",children:"ויולה"}),e.jsx("option",{value:"חצוצרה",children:"חצוצרה"}),e.jsx("option",{value:"טרומבון",children:"טרומבון"}),e.jsx("option",{value:"קלרינט",children:"קלרינט"}),e.jsx("option",{value:"חליל",children:"חליל"}),e.jsx("option",{value:"סקסופון",children:"סקסופון"}),e.jsx("option",{value:"הורן",children:"הורן"}),e.jsx("option",{value:"טובה",children:"טובה"}),e.jsx("option",{value:"כלי הקשה",children:"כלי הקשה"}),e.jsx("option",{value:"גיטרה",children:"גיטרה"}),e.jsx("option",{value:"קונטרבס",children:"קונטרבס"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"יום בשבוע"}),e.jsxs("select",{value:g.lessonDay,onChange:i=>D(v=>({...v,lessonDay:i.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"",children:"בחר יום"}),e.jsx("option",{value:"ראשון",children:"יום ראשון"}),e.jsx("option",{value:"שני",children:"יום שני"}),e.jsx("option",{value:"שלישי",children:"יום שלישי"}),e.jsx("option",{value:"רביעי",children:"יום רביעי"}),e.jsx("option",{value:"חמישי",children:"יום חמישי"}),e.jsx("option",{value:"שישי",children:"יום שישי"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שעת התחלה"}),e.jsx("input",{type:"time",value:g.lessonTime,onChange:i=>D(v=>({...v,lessonTime:i.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"משך (דקות)"}),e.jsx("input",{type:"number",min:"15",max:"120",step:"15",value:g.lessonDuration,onChange:i=>D(v=>({...v,lessonDuration:parseInt(i.target.value)})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"מיקום"}),e.jsxs("select",{value:g.lessonLocation,onChange:i=>D(v=>({...v,lessonLocation:i.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"",children:"בחר חדר"}),Ee.map(i=>e.jsx("option",{value:i,children:i},i))]})]})]})]}),e.jsxs("div",{className:"flex gap-3 mt-6 pt-4 border-t",children:[e.jsx("button",{type:"submit",disabled:!m||!g.instrument||p,className:"flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 font-reisinger-yonatan flex items-center justify-center gap-2",children:p?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"מקצה..."]}):e.jsxs(e.Fragment,{children:[e.jsx(le,{className:"w-4 h-4"}),"הקצה תלמיד"]})}),e.jsxs("button",{type:"button",onClick:T,disabled:p,className:"flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 font-reisinger-yonatan flex items-center justify-center gap-2",children:[e.jsx(ve,{className:"w-4 h-4"}),"ביטול"]})]})]})]})})}function pt({isOpen:t,onClose:S,orchestraId:T,orchestraName:y,onSave:h}){const[c,m]=o.useState({date:"",startTime:"19:00",endTime:"21:00",location:"אולם מוזיקה",notes:"",recurring:!1,recurrencePattern:"weekly",endRecurrence:""}),[l,g]=o.useState({}),[D,p]=o.useState(!1);o.useEffect(()=>{if(t){const i=new Date;i.setDate(i.getDate()+1),m(v=>({...v,date:i.toISOString().split("T")[0]}))}},[t]);const u=()=>{const i={};if(!c.date)i.date="יש לבחור תאריך";else{const v=new Date(c.date),I=new Date;I.setHours(0,0,0,0),v<I&&(i.date="לא ניתן לקבוע חזרה בעבר")}if(c.startTime||(i.startTime="יש לבחור שעת התחלה"),c.endTime||(i.endTime="יש לבחור שעת סיום"),c.startTime&&c.endTime){const v=new Date(`2000-01-01T${c.startTime}`);new Date(`2000-01-01T${c.endTime}`)<=v&&(i.endTime="שעת הסיום חייבת להיות אחרי שעת ההתחלה")}return c.location.trim()||(i.location="יש לציין מקום"),c.recurring&&!c.endRecurrence&&(i.endRecurrence="יש לציין תאריך סיום לחזרות קבועות"),g(i),Object.keys(i).length===0},F=async i=>{if(i.preventDefault(),!!u()){p(!0);try{await h(c),S(),m({date:"",startTime:"19:00",endTime:"21:00",location:"אולם מוזיקה",notes:"",recurring:!1,recurrencePattern:"weekly",endRecurrence:""})}catch(v){console.error("Error saving rehearsal:",v)}finally{p(!1)}}},q=()=>{if(!c.startTime||!c.endTime)return"";const i=new Date(`2000-01-01T${c.startTime}`),I=(new Date(`2000-01-01T${c.endTime}`).getTime()-i.getTime())/(1e3*60);if(I<=0)return"";const d=Math.floor(I/60),C=I%60;return d===0?`${C} דקות`:C===0?`${d} שעות`:`${d} שעות ו-${C} דקות`};return t?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900 font-reisinger-yonatan",children:"קביעת חזרה חדשה"}),e.jsx("button",{onClick:S,className:"p-1 text-gray-400 hover:text-gray-600 rounded",children:e.jsx(ve,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center gap-2 text-blue-800",children:[e.jsx(se,{className:"w-4 h-4"}),e.jsxs("span",{className:"font-medium font-reisinger-yonatan",children:["תזמורת: ",y]})]})}),e.jsxs("form",{onSubmit:F,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"תאריך החזרה *"}),e.jsxs("div",{className:"relative",children:[e.jsx(ae,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"date",required:!0,value:c.date,onChange:i=>m(v=>({...v,date:i.target.value})),className:`w-full pl-3 pr-10 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 ${l.date?"border-red-300":"border-gray-300"}`})]}),l.date&&e.jsx("p",{className:"text-red-600 text-xs mt-1 font-reisinger-yonatan",children:l.date})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שעת התחלה *"}),e.jsxs("div",{className:"relative",children:[e.jsx(re,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"time",required:!0,value:c.startTime,onChange:i=>m(v=>({...v,startTime:i.target.value})),className:`w-full pl-3 pr-10 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 ${l.startTime?"border-red-300":"border-gray-300"}`})]}),l.startTime&&e.jsx("p",{className:"text-red-600 text-xs mt-1 font-reisinger-yonatan",children:l.startTime})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שעת סיום *"}),e.jsxs("div",{className:"relative",children:[e.jsx(re,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"time",required:!0,value:c.endTime,onChange:i=>m(v=>({...v,endTime:i.target.value})),className:`w-full pl-3 pr-10 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 ${l.endTime?"border-red-300":"border-gray-300"}`})]}),l.endTime&&e.jsx("p",{className:"text-red-600 text-xs mt-1 font-reisinger-yonatan",children:l.endTime})]})]}),q()&&e.jsxs("div",{className:"text-sm text-gray-600 bg-gray-50 p-2 rounded font-reisinger-yonatan",children:["משך החזרה: ",q()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"מקום החזרה *"}),e.jsxs("div",{className:"relative",children:[e.jsx(xe,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"text",required:!0,value:c.location,onChange:i=>m(v=>({...v,location:i.target.value})),className:`w-full pl-3 pr-10 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 ${l.location?"border-red-300":"border-gray-300"}`,placeholder:"למשל: אולם מוזיקה, חדר 101"})]}),l.location&&e.jsx("p",{className:"text-red-600 text-xs mt-1 font-reisinger-yonatan",children:l.location})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"הערות"}),e.jsx("textarea",{value:c.notes,onChange:i=>m(v=>({...v,notes:i.target.value})),rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",placeholder:"הערות נוספות על החזרה (אופציונלי)"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{id:"recurring",type:"checkbox",checked:c.recurring,onChange:i=>m(v=>({...v,recurring:i.target.checked})),className:"h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"}),e.jsx("label",{htmlFor:"recurring",className:"mr-2 text-sm text-gray-700 font-reisinger-yonatan",children:"חזרה קבועה (חוזרת)"})]}),c.recurring&&e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"תדירות"}),e.jsxs("select",{value:c.recurrencePattern,onChange:i=>m(v=>({...v,recurrencePattern:i.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"weekly",children:"שבועי"}),e.jsx("option",{value:"biweekly",children:"דו-שבועי"}),e.jsx("option",{value:"monthly",children:"חודשי"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"תאריך סיום החזרות הקבועות *"}),e.jsx("input",{type:"date",required:c.recurring,value:c.endRecurrence,onChange:i=>m(v=>({...v,endRecurrence:i.target.value})),className:`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 ${l.endRecurrence?"border-red-300":"border-gray-300"}`}),l.endRecurrence&&e.jsx("p",{className:"text-red-600 text-xs mt-1 font-reisinger-yonatan",children:l.endRecurrence})]}),e.jsxs("div",{className:"text-xs text-amber-600 bg-amber-50 p-2 rounded flex items-start gap-2",children:[e.jsx(Ae,{className:"w-4 h-4 mt-0.5 flex-shrink-0"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"חזרות קבועות ייווצרו אוטומטית עד התאריך שצוין"})]})]})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{type:"submit",disabled:D,className:"flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 disabled:opacity-50 transition-colors font-reisinger-yonatan",children:D?"קובע חזרה...":"קבע חזרה"}),e.jsx("button",{type:"button",onClick:S,className:"flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors font-reisinger-yonatan",children:"ביטול"})]})]})]})}):null}function We(){const{user:t}=je(),[S,T]=o.useState([]),[y,h]=o.useState(!0),[c,m]=o.useState(""),[l,g]=o.useState(!1),[D,p]=o.useState(null),[u,F]=o.useState(null),[q,i]=o.useState([]),[v,I]=o.useState(null),[d,C]=o.useState("members");o.useState(!1);const[H,b]=o.useState(!1),[L,E]=o.useState([]),[k,W]=o.useState([]),[_,K]=o.useState(""),[f,B]=o.useState("");o.useEffect(()=>{M()},[t]);const M=async()=>{if(t?._id)try{h(!0);const s=t._id,w=await R.teachers.getTeacher(s);if(!w)throw new Error("לא נמצא פרופיל מנצח");const j=w?.conducting?.orchestraIds||[];if(j.length===0){console.log("No orchestras assigned to conductor"),T([]);return}const x=await R.orchestras.getBatchOrchestras(j);if(!Array.isArray(x))throw new Error("תגובה לא תקינה מהשרת");const a=x.map(n=>({id:n._id,name:n.name,description:n.description,type:n.type,level:n.level,memberCount:n.memberCount||0,status:n.status||"active",rehearsalDay:n.rehearsalSchedule?.day,rehearsalTime:n.rehearsalSchedule?.time,venue:n.venue}));T(a)}catch(s){console.error("Error loading conductor orchestras:",s),I("שגיאה בטעינת רשימת התזמורות")}finally{h(!1)}},A=async s=>{try{const x=((await R.orchestras.getOrchestra(s)).memberDetails||[]).map(a=>({id:a._id,firstName:a.personalInfo?.firstName||"",lastName:a.personalInfo?.lastName||"",instrument:a.academicInfo?.instrumentProgress?.find(n=>n.isPrimary)?.instrumentName||a.primaryInstrument||"",section:a.section||"כללי",status:a.status||"active",enrollmentDate:a.enrollmentDate||new Date().toISOString(),performanceLevel:a.performanceLevel||"intermediate",attendanceRate:Math.floor(Math.random()*20)+80}));i(x)}catch(w){console.error("Error loading orchestra members:",w)}},P=async()=>{try{const s=await R.students.getStudents({status:"active",limit:200}),w=q.map(x=>x.id),j=s.filter(x=>!w.includes(x._id));E(j)}catch(s){console.error("Error loading available students:",s)}},U=async s=>{try{const j=(await R.rehearsals.getRehearsals({groupId:s,limit:20})).map(x=>({id:x._id,date:new Date(x.scheduledDate).toLocaleDateString("he-IL"),time:x.startTime||"19:00",location:x.location||"אולם מוזיקה",duration:x.duration||120,status:x.status||"scheduled",attendanceCount:x.attendanceList?.length||0,totalMembers:q.length}));W(j)}catch(w){console.error("Error loading orchestra rehearsals:",w),W([])}},J=async s=>{if(u)try{await R.orchestras.addMember(u,s),await A(u),await P(),alert("התלמיד נוסף בהצלחה לתזמורת")}catch(w){console.error("Error adding member:",w),alert("שגיאה בהוספת התלמיד לתזמורת")}},O=async s=>{if(u&&window.confirm("האם אתה בטוח שברצונך להסיר את התלמיד מהתזמורת?"))try{await R.orchestras.removeMember(u,s),await A(u),await P(),alert("התלמיד הוסר בהצלחה מהתזמורת")}catch(w){console.error("Error removing member:",w),alert("שגיאה בהסרת התלמיד מהתזמורת")}},ee=async s=>{if(u)try{const w={groupId:u,groupType:"orchestra",scheduledDate:new Date(s.date).toISOString(),startTime:s.startTime,endTime:s.endTime,duration:ne(s.startTime,s.endTime),location:s.location,notes:s.notes,status:"scheduled"};if(s.recurring){const j=me(w,s);await Promise.all(j.map(x=>R.rehearsals.createRehearsal(x))),alert(`${j.length} חזרות נוצרו בהצלחה`)}else await R.rehearsals.createRehearsal(w),alert("חזרה נוצרה בהצלחה");await U(u),b(!1)}catch(w){console.error("Error scheduling rehearsal:",w),alert("שגיאה ביצירת החזרה")}},ne=(s,w)=>{const j=new Date(`2000-01-01T${s}`),x=new Date(`2000-01-01T${w}`);return Math.round((x.getTime()-j.getTime())/(1e3*60))},me=(s,w)=>{const j=[],x=new Date(w.date),a=new Date(w.endRecurrence);let n=new Date(x);for(;n<=a;)switch(j.push({...s,scheduledDate:new Date(n).toISOString()}),w.recurrencePattern){case"weekly":n.setDate(n.getDate()+7);break;case"biweekly":n.setDate(n.getDate()+14);break;case"monthly":n.setMonth(n.getMonth()+1);break}return j},oe=S.filter(s=>c===""||s.name.toLowerCase().includes(c.toLowerCase())||s.type.toLowerCase().includes(c.toLowerCase())||s.description?.toLowerCase().includes(c.toLowerCase())),ce=async s=>{if(window.confirm("האם אתה בטוח שברצונך למחוק תזמורת זו?"))try{await R.orchestras.deleteOrchestra(s),T(w=>w.filter(j=>j.id!==s)),u===s&&(F(null),i([]))}catch(w){console.error("Error deleting orchestra:",w),alert("שגיאה במחיקת התזמורת")}},he=async s=>{try{if(D){const w={name:s.name,description:s.description,type:s.type,level:s.level,status:s.status,rehearsalSchedule:{day:s.rehearsalDay,time:s.rehearsalTime},venue:s.venue},j=await R.orchestras.updateOrchestra(D.id,w),x={id:j._id,name:j.name,description:j.description,type:j.type,level:j.level,memberCount:j.memberCount||0,status:j.status||"active",rehearsalDay:j.rehearsalSchedule?.day,rehearsalTime:j.rehearsalSchedule?.time,venue:j.venue};T(a=>a.map(n=>n.id===D.id?x:n))}else{const w=t?._id,j={name:s.name,description:s.description,type:s.type,level:s.level,status:s.status,rehearsalSchedule:{day:s.rehearsalDay,time:s.rehearsalTime},venue:s.venue,conductorId:w},x=await R.orchestras.createOrchestra(j),a={id:x._id,name:x.name,description:x.description,type:x.type,level:x.level,memberCount:x.memberCount||0,status:x.status||"active",rehearsalDay:x.rehearsalSchedule?.day,rehearsalTime:x.rehearsalSchedule?.time,venue:x.venue};T(n=>[...n,a])}g(!1),p(null)}catch(w){console.error("Error saving orchestra:",w),alert("שגיאה בשמירת פרטי התזמורת")}},fe=s=>{switch(s){case"youth":return"תזמורת נוער";case"adult":return"תזמורת מבוגרים";case"chamber":return"תזמורת קאמרית";case"symphony":return"תזמורת סימפונית";default:return s}},r=s=>{switch(s){case"beginner":return"מתחילים";case"intermediate":return"בינוניים";case"advanced":return"מתקדמים";default:return s}};return y?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600",children:"טוען רשימת תזמורות..."})]})}):v?e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("div",{className:"text-red-800 font-reisinger-yonatan",children:v})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:"תזמורות שאני מנצח"}),e.jsxs("p",{className:"text-gray-600 mt-1",children:[S.length," תזמורות"]})]}),e.jsxs("button",{onClick:()=>g(!0),className:"flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors",children:[e.jsx(be,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"הוסף תזמורת"})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(ge,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"חיפוש תזמורות...",value:c,onChange:s=>m(s.target.value),className:"w-full pl-4 pr-12 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"rtl"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsx("div",{className:"space-y-4",children:oe.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ue,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2 font-reisinger-yonatan",children:c?"לא נמצאו תזמורות":"אין תזמורות רשומות"}),e.jsx("p",{className:"text-gray-600 font-reisinger-yonatan",children:c?"נסה מילות חיפוש אחרות":"התחל בהוספת התזמורת הראשונה שלך"})]}):oe.map(s=>e.jsxs("div",{className:`bg-white border border-gray-200 rounded-lg p-4 hover:shadow-lg hover:border-indigo-300 transition-all duration-200 cursor-pointer transform hover:-translate-y-1 group ${u===s.id?"ring-2 ring-indigo-500 bg-indigo-50":""}`,onClick:()=>{F(s.id),A(s.id),U(s.id),C("members")},children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-gray-900 font-reisinger-yonatan",children:s.name}),e.jsxs("p",{className:"text-sm text-gray-600 font-reisinger-yonatan",children:[fe(s.type)," • ",r(s.level)]}),s.description&&e.jsx("p",{className:"text-sm text-gray-500 mt-1 font-reisinger-yonatan",children:s.description})]}),e.jsxs("div",{className:"flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:[e.jsx("button",{onClick:w=>{w.stopPropagation(),p(s),g(!0)},className:"p-2 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all duration-200",title:"עריכת תזמורת",children:e.jsx(ke,{className:"w-4 h-4"})}),e.jsx("button",{onClick:w=>{w.stopPropagation(),ce(s.id)},className:"p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all duration-200",title:"מחיקת תזמורת",children:e.jsx(Ie,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(se,{className:"w-4 h-4"}),e.jsxs("span",{children:[s.memberCount||0," חברים"]})]}),s.rehearsalDay&&e.jsxs("span",{children:["חזרות: ",s.rehearsalDay]})]}),e.jsx("span",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${s.status==="active"?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"}`,children:s.status==="active"?"פעיל":"לא פעיל"})]})]},s.id))}),u&&e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"flex gap-1 p-1",children:[e.jsxs("button",{onClick:()=>C("members"),className:`px-4 py-2 text-sm font-medium rounded-md transition-colors ${d==="members"?"bg-indigo-100 text-indigo-700":"text-gray-500 hover:text-gray-700"}`,children:[e.jsx(se,{className:"w-4 h-4 inline mr-2"}),"חברי התזמורת"]}),e.jsxs("button",{onClick:()=>{C("enrollment"),P()},className:`px-4 py-2 text-sm font-medium rounded-md transition-colors ${d==="enrollment"?"bg-indigo-100 text-indigo-700":"text-gray-500 hover:text-gray-700"}`,children:[e.jsx(le,{className:"w-4 h-4 inline mr-2"}),"רישום חברים"]}),e.jsxs("button",{onClick:()=>C("rehearsals"),className:`px-4 py-2 text-sm font-medium rounded-md transition-colors ${d==="rehearsals"?"bg-indigo-100 text-indigo-700":"text-gray-500 hover:text-gray-700"}`,children:[e.jsx(ae,{className:"w-4 h-4 inline mr-2"}),"חזרות"]})]})}),e.jsxs("div",{className:"p-4",children:[d==="members"&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"font-semibold text-gray-900 font-reisinger-yonatan",children:["חברי התזמורת (",q.length,")"]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs("div",{className:"relative",children:[e.jsx(ge,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"text",placeholder:"חיפוש חברים...",value:f,onChange:s=>B(s.target.value),className:"pl-4 pr-10 py-1.5 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-indigo-500",dir:"rtl"})]})})]}),q.filter(s=>f===""||`${s.firstName} ${s.lastName}`.toLowerCase().includes(f.toLowerCase())||s.instrument.toLowerCase().includes(f.toLowerCase())).length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(se,{className:"w-12 h-12 text-gray-400 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 font-reisinger-yonatan",children:f?"לא נמצאו חברים":"אין חברים רשומים בתזמורת"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:q.filter(s=>f===""||`${s.firstName} ${s.lastName}`.toLowerCase().includes(f.toLowerCase())||s.instrument.toLowerCase().includes(f.toLowerCase())).map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors border border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${s.status==="active"?"bg-green-500":"bg-gray-400"}`}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium text-sm font-reisinger-yonatan",children:[s.firstName," ",s.lastName]}),e.jsxs("div",{className:"text-xs text-gray-500 font-reisinger-yonatan",children:[s.instrument," • ",s.section]}),e.jsxs("div",{className:"text-xs text-gray-400 mt-1",children:["נוכחות: ",s.attendanceRate,"% • רמה: ",r(s.performanceLevel||"intermediate")]})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{onClick:()=>O(s.id),className:"p-1.5 text-red-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors",title:"הסר מהתזמורת",children:e.jsx(Ve,{className:"w-4 h-4"})})})]},s.id))})]}),d==="enrollment"&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h4",{className:"font-semibold text-gray-900 font-reisinger-yonatan",children:"הוסף חברים חדשים"}),e.jsxs("div",{className:"relative",children:[e.jsx(ge,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"text",placeholder:"חיפוש תלמידים...",value:_,onChange:s=>K(s.target.value),className:"pl-4 pr-10 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500",dir:"rtl"})]})]}),L.filter(s=>_===""||s.personalInfo?.fullName?.toLowerCase().includes(_.toLowerCase())||s.academicInfo?.primaryInstrument?.toLowerCase().includes(_.toLowerCase())).length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(le,{className:"w-12 h-12 text-gray-400 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 font-reisinger-yonatan",children:_?"לא נמצאו תלמידים":"אין תלמידים זמינים"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:L.filter(s=>_===""||s.personalInfo?.fullName?.toLowerCase().includes(_.toLowerCase())||s.academicInfo?.primaryInstrument?.toLowerCase().includes(_.toLowerCase())).map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors border border-gray-200",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm font-reisinger-yonatan",children:s.personalInfo?.fullName}),e.jsx("div",{className:"text-xs text-gray-500 font-reisinger-yonatan",children:s.academicInfo?.primaryInstrument||"לא צוין כלי"})]}),e.jsxs("button",{onClick:()=>J(s._id),className:"flex items-center gap-1 px-3 py-1.5 bg-indigo-600 text-white text-sm rounded hover:bg-indigo-700 transition-colors",children:[e.jsx(le,{className:"w-4 h-4"}),"הוסף"]})]},s._id))})]}),d==="rehearsals"&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h4",{className:"font-semibold text-gray-900 font-reisinger-yonatan",children:"חזרות התזמורת"}),e.jsxs("button",{onClick:()=>b(!0),className:"flex items-center gap-2 px-3 py-1.5 bg-indigo-600 text-white text-sm rounded hover:bg-indigo-700 transition-colors",children:[e.jsx(be,{className:"w-4 h-4"}),"קבע חזרה"]})]}),k.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(ae,{className:"w-12 h-12 text-gray-400 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 font-reisinger-yonatan",children:"אין חזרות מתוכננות"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:k.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors border border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${s.status==="completed"?"bg-green-100":s.status==="cancelled"?"bg-red-100":"bg-blue-100"}`,children:e.jsx(nt,{className:`w-4 h-4 ${s.status==="completed"?"text-green-600":s.status==="cancelled"?"text-red-600":"text-blue-600"}`})}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium text-sm font-reisinger-yonatan",children:[s.date," • ",s.time]}),e.jsxs("div",{className:"text-xs text-gray-500 font-reisinger-yonatan flex items-center gap-2",children:[e.jsx(xe,{className:"w-3 h-3"}),s.location,e.jsx(re,{className:"w-3 h-3 mr-1"}),s.duration," דקות"]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-sm font-medium text-gray-900",children:[s.attendanceCount,"/",s.totalMembers]}),e.jsx("div",{className:"text-xs text-gray-500",children:"נוכחות"})]})]},s.id))})]})]})]})]}),l&&e.jsx(yt,{orchestra:D,onClose:()=>{g(!1),p(null)},onSubmit:he}),H&&u&&e.jsx(pt,{isOpen:H,onClose:()=>b(!1),orchestraId:u,orchestraName:S.find(s=>s.id===u)?.name||"",onSave:ee})]})}function yt({orchestra:t,onClose:S,onSubmit:T}){const[y,h]=o.useState({name:t?.name||"",description:t?.description||"",type:t?.type||"youth",level:t?.level||"beginner",status:t?.status||"active",rehearsalDay:t?.rehearsalDay||"",rehearsalTime:t?.rehearsalTime||"",venue:t?.venue||""}),c=m=>{m.preventDefault(),T(y)};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto",dir:"rtl",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900 mb-4 font-reisinger-yonatan",children:t?"עריכת תזמורת":"הוספת תזמורת חדשה"}),e.jsxs("form",{onSubmit:c,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שם התזמורת *"}),e.jsx("input",{type:"text",required:!0,value:y.name,onChange:m=>h(l=>({...l,name:m.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"תיאור"}),e.jsx("textarea",{value:y.description,onChange:m=>h(l=>({...l,description:m.target.value})),rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"סוג תזמורת *"}),e.jsxs("select",{required:!0,value:y.type,onChange:m=>h(l=>({...l,type:m.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"youth",children:"תזמורת נוער"}),e.jsx("option",{value:"adult",children:"תזמורת מבוגרים"}),e.jsx("option",{value:"chamber",children:"תזמורת קאמרית"}),e.jsx("option",{value:"symphony",children:"תזמורת סימפונית"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"רמה *"}),e.jsxs("select",{required:!0,value:y.level,onChange:m=>h(l=>({...l,level:m.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"beginner",children:"מתחילים"}),e.jsx("option",{value:"intermediate",children:"בינוניים"}),e.jsx("option",{value:"advanced",children:"מתקדמים"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"יום חזרות"}),e.jsx("input",{type:"text",value:y.rehearsalDay,onChange:m=>h(l=>({...l,rehearsalDay:m.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",placeholder:"כלומר: יום ראשון"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שעת חזרות"}),e.jsx("input",{type:"time",value:y.rehearsalTime,onChange:m=>h(l=>({...l,rehearsalTime:m.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"מקום חזרות"}),e.jsx("input",{type:"text",value:y.venue,onChange:m=>h(l=>({...l,venue:m.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"סטטוס"}),e.jsxs("select",{value:y.status,onChange:m=>h(l=>({...l,status:m.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"active",children:"פעיל"}),e.jsx("option",{value:"inactive",children:"לא פעיל"})]})]}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx("button",{type:"submit",className:"flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors font-reisinger-yonatan",children:t?"עדכן":"הוסף"}),e.jsx("button",{type:"button",onClick:S,className:"flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors font-reisinger-yonatan",children:"ביטול"})]})]})]})})}function qe(){const{user:t}=je(),[S,T]=o.useState(new Date),[y,h]=o.useState(null),[c,m]=o.useState([]),[l,g]=o.useState([]),[D,p]=o.useState(!0),[u,F]=o.useState(null),[q,i]=o.useState(!1),[v,I]=o.useState(null),[d,C]=o.useState(""),[H,b]=o.useState(!1),[L,E]=o.useState(null),[k,W]=o.useState(!1),[_,K]=o.useState(null);o.useEffect(()=>{f()},[S,t]);const f=async()=>{if(t?._id)try{p(!0);const a=t._id,n=await R.teacherSchedule.getTimeBlocks(a);console.log("Raw API Response:",n);let N=[];try{if(Array.isArray(n))N=n;else if(n?.data&&Array.isArray(n.data))N=n.data;else if(n?.timeBlocks&&Array.isArray(n.timeBlocks))N=n.timeBlocks;else if(n&&typeof n=="object"){const $=Object.values(n).find(Q=>Array.isArray(Q));$?N=$:(console.warn("No array found in response, using empty array"),N=[])}else console.warn("Unexpected timeBlocks format:",n),N=[]}catch($){console.error("Error parsing timeBlocks response:",$),N=[]}console.log("Parsed timeBlocks:",N),console.log("Time block IDs:",N.map($=>({_id:$._id,day:$.day,time:`${$.startTime}-${$.endTime}`,location:$.location})));const G=N.filter($=>$._id&&$._id!=="undefined");console.log("Valid timeBlocks after filtering:",G),g(G);const te=await R.teachers.getTeacher(a);console.log("Teacher profile:",te);let V=[];if(te?.teaching?.studentIds?.length>0)try{V=await R.students.getBatchStudents(te.teaching.studentIds),console.log("Students loaded:",V)}catch($){console.warn("Failed to load students:",$)}else console.log("No student IDs found in teacher profile");console.log("Creating lesson blocks from student assignments...");const z=[];V.forEach($=>{console.log("Processing student:",$.personalInfo?.fullName),console.log("Student assignments:",$.teacherAssignments),$.teacherAssignments&&$.teacherAssignments.forEach(Q=>{if(Q.teacherId===a){console.log("Creating lesson from assignment:",Q);const pe=Q.time||Q.startTime,Le=Q.duration||45,$e=(Ne,Ke)=>{const[Xe,Ze]=Ne.split(":").map(Number),_e=Xe*60+Ze+Ke,Ye=Math.floor(_e/60),et=_e%60;return`${Ye.toString().padStart(2,"0")}:${et.toString().padStart(2,"0")}`},de=Q.endTime||$e(pe,Le),Qe=l.find(Ne=>Ne.day===Q.day)?.location||"",Je={_id:`${$._id}-${Q.day}-${Q.time}`,day:Q.day,startTime:pe,endTime:de,totalDuration:Le,studentId:$._id,studentName:$.personalInfo?.fullName,teacherId:a,instrument:$.academicInfo?.instrumentProgress?.find(Ne=>Ne.isPrimary)?.instrumentName,location:Q.location||Qe,type:"lesson"};console.log(`Creating lesson: Student="${$.personalInfo?.fullName}", Day="${Q.day}", Time="${pe}-${de}"`),z.push(Je)}})}),console.log("Converted lessons from assignments:",z);const Z=z.map($=>{const Q=V.find(de=>de.teacherAssignments?.some(Te=>Te.teacherId===a&&Te.day===$.day&&Te.time===$.startTime)),pe=Q?.academicInfo?.instrumentProgress?.find(de=>de.isPrimary)||Q?.academicInfo?.instrumentProgress?.[0],$e=l.find(de=>de.day===$.day)?.location||"";return{id:$._id||$.id||`${$.day}-${$.startTime}`,day:$.day,startTime:$.startTime,endTime:$.endTime,studentName:Q?Q.personalInfo?.fullName:$.studentName,studentId:Q?._id||$.studentId,instrument:pe?.instrumentName||$.instrument,location:$.location||$e,notes:$.notes,recurring:$.recurring||{isRecurring:!0,excludeDates:[]},totalDuration:$.totalDuration||M($.startTime,$.endTime),studentClass:Q?.personalInfo?.class||Q?.academicInfo?.class,studentPhone:Q?.personalInfo?.phone,studentStage:pe?.currentStage}});m(Z);const Y=A(S),ie=P(S),Se=B(Y,Z);console.log("Generated calendar days:",Se),console.log("Calendar week range:",{weekStart:Y,weekEnd:ie}),console.log("Mapped lesson days for calendar:",Z),h({weekStart:Y,weekEnd:ie,days:Se})}catch(a){console.error("Error loading schedule:",a),F("שגיאה בטעינת לוח הזמנים")}finally{p(!1)}},B=(a,n)=>{const N=[],G=["ראשון","שני","שלישי","רביעי","חמישי","שישי","שבת"],te=new Map;G.forEach((z,X)=>{te.set(z,X)}),console.log("=== GENERATING CALENDAR ==="),console.log("weekStart:",a,"Day:",a.getDay()),console.log("lessons input:",n),console.log("Day name mapping:",Array.from(te.entries()));const V=new Map;n.forEach(z=>{V.has(z.day)||V.set(z.day,[]),V.get(z.day).push(z)}),console.log("Lessons grouped by day:",Array.from(V.keys()));for(let z=0;z<7;z++){const X=new Date(a);X.setDate(a.getDate()+z);const Z=G[z],Y=V.get(Z)||[];console.log(`Day ${z} (${Z}): found ${Y.length} lessons`,Y.map(ie=>({day:ie.day,time:ie.startTime,student:ie.studentName}))),N.push({date:X.toISOString().split("T")[0],dayName:Z,lessons:Y})}return console.log("Generated calendar days with lessons:",N.map(z=>({dayName:z.dayName,lessonCount:z.lessons.length}))),N},M=(a,n)=>{const[N,G]=a.split(":").map(Number),[te,V]=n.split(":").map(Number);return te*60+V-(N*60+G)},A=a=>{const n=new Date(a),N=n.getDay(),G=n.getDate()-N;return n.setDate(G),n.setHours(0,0,0,0),console.log("getWeekStart: input date:",a,"weekStart (Sunday):",n,"day:",n.getDay()),n},P=a=>{const n=A(a);return n.setDate(n.getDate()+6),n},U=a=>{const n=new Date(S);n.setDate(S.getDate()+(a==="next"?7:-7)),T(n)},J=a=>a.slice(0,5),O=a=>new Date(a).toLocaleDateString("he-IL",{day:"numeric",month:"short"}),ee=()=>{I(null),i(!0)},ne=a=>{console.log("handleEditLessonDay called with:",{studentId:a.studentId,studentName:a.studentName,id:a.id,_id:a._id,type:a.type}),a.studentId&&a.studentName?(console.log("Opening EditLessonModal for student lesson"),K(a),W(!0)):(console.log("Opening LessonDayModal for teaching day/availability block"),I(a),i(!0))},me=a=>{console.log("handleEditTeachingDay called with:",{_id:a._id,id:a.id,day:a.day,startTime:a.startTime,hasStudentId:!!a.studentId,fullData:a});const n={id:a._id||a.id,day:a.day,startTime:a.startTime,endTime:a.endTime,location:a.location||"חדר מוזיקה",notes:a.notes||"",recurring:a.recurring||{isRecurring:!0,excludeDates:[]},totalDuration:M(a.startTime,a.endTime)};console.log("Opening LessonDayModal with lessonDay:",n),I(n),i(!0)},oe=async a=>{if(window.confirm("האם אתה בטוח שברצונך למחוק יום לימוד זה? פעולה זו תבטל את הזמינות שלך בזמן זה."))try{await R.teacherSchedule.deleteTimeBlock(t?._id,a._id||a.id),ce("יום הלימוד נמחק בהצלחה","success"),f()}catch(N){console.error("Error deleting teaching day:",N),ce("שגיאה במחיקת יום הלימוד","error")}},ce=(a,n)=>{const N=document.createElement("div");N.className=`fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 ${n==="success"?"bg-green-500 text-white":n==="error"?"bg-red-500 text-white":"bg-blue-500 text-white"}`,N.innerHTML=`<div class="flex items-center gap-2 font-reisinger-yonatan">
      ${n==="success"?"✅":n==="error"?"❌":"ℹ️"} ${a}
    </div>`,document.body.appendChild(N),setTimeout(()=>N.remove(),3e3)},he=()=>{const a=[];for(let n=7;n<=21;n++)a.push(`${n.toString().padStart(2,"0")}:00`),a.push(`${n.toString().padStart(2,"0")}:30`);return a},fe=(a,n)=>{const N=y?.days.find(V=>V.date===a),G=V=>{const[z,X]=V.split(":").map(Number);return z*60+X};return N?.lessons.find(V=>{const z=G(n),X=z+30,Z=G(V.startTime),Y=G(V.endTime),ie=Z>=z&&Z<X,Se=z>=Z&&z<Y;return ie||Se})},r=a=>{const n=M(a.startTime,a.endTime);return Math.ceil(n/30)*60},s=(a,n)=>{const N=a.startTime,G=n,te=Z=>{const[Y,ie]=Z.split(":").map(Number);return Y*60+ie},V=te(N),z=te(G),X=z+30;return V>=z&&V<X},w=(a,n)=>{const N=X=>{const[Z,Y]=X.split(":").map(Number);return Z*60+Y},G=N(n),te=G+30;return l.some(X=>{if(X.day!==a)return!1;const Z=N(X.startTime),Y=N(X.endTime);return G>=Z&&te<=Y})?!c.some(X=>{if(X.day!==a)return!1;const Z=N(X.startTime),Y=N(X.endTime);return G<Y&&te>Z}):!1},j=(a,n,N)=>{w(N,n)&&(E({date:a,time:n,dayName:N}),b(!0))};if(c.filter(a=>{if(!d)return!0;const n=d.toLowerCase();return a.studentName?.toLowerCase().includes(n)||a.instrument?.toLowerCase().includes(n)||a.location?.toLowerCase().includes(n)||a.day.toLowerCase().includes(n)}),D)return e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600",children:"טוען לוח זמנים..."})]})});if(u&&!y)return e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("div",{className:"text-red-800 font-reisinger-yonatan",children:u})});const x=he();return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:"לוח זמנים שבועי"}),e.jsx("p",{className:"text-gray-600 mt-1",children:y&&`${O(y.weekStart.toISOString().split("T")[0])} - ${O(y.weekEnd.toISOString().split("T")[0])}`})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>U("prev"),className:"p-2 text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(it,{className:"w-5 h-5"})}),e.jsx("button",{onClick:()=>T(new Date),className:"px-3 py-1 text-sm bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition-colors font-reisinger-yonatan",children:"השבוע"}),e.jsx("button",{onClick:()=>U("next"),className:"p-2 text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(lt,{className:"w-5 h-5"})})]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:"grid grid-cols-8 border-b border-gray-200",children:[e.jsx("div",{className:"p-3 bg-gray-50 font-medium text-gray-700 font-reisinger-yonatan",children:"שעה"}),y?.days.map(a=>e.jsxs("div",{className:"p-3 bg-gray-50 text-center",children:[e.jsx("div",{className:"font-medium text-gray-900 font-reisinger-yonatan",children:a.dayName}),e.jsx("div",{className:"text-sm text-gray-500 font-reisinger-yonatan",children:O(a.date)})]},a.date))]}),e.jsx("div",{className:"max-h-96 overflow-y-auto relative",children:x.map(a=>e.jsxs("div",{className:"grid grid-cols-8 border-b border-gray-100",style:{height:"60px"},children:[e.jsx("div",{className:"p-3 bg-gray-50 text-sm font-medium text-gray-600 font-reisinger-yonatan flex items-center",children:J(a)}),y?.days.map(n=>{const N=fe(n.date,a),G=!N&&w(n.dayName,a);return e.jsxs("div",{className:`border-l border-gray-100 relative transition-all duration-200 cursor-pointer group ${G?"hover:bg-blue-50":""}`,style:{height:"60px"},onClick:()=>!N&&j(n.date,a,n.dayName),title:G?"לחץ להוספת שיעור חדש":"",children:[G&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:e.jsx(be,{className:"w-6 h-6 text-blue-500 drop-shadow-lg"})}),N&&s(N,a)&&e.jsx("div",{className:"absolute left-1 right-1 top-1 p-2.5 rounded text-xs font-reisinger-yonatan bg-blue-100 text-blue-800 hover:bg-blue-200 border border-blue-300 shadow-sm cursor-pointer transition-all hover:scale-[1.02] z-10 overflow-hidden",style:{height:`${r(N)-2}px`,minHeight:"82px"},onClick:()=>ne(N),title:`${N.studentName||"תלמיד"} - ${N.instrument||""}`,children:e.jsx("div",{className:"flex flex-col h-full justify-between",children:e.jsxs("div",{className:"flex-shrink-0 space-y-1",children:[e.jsxs("div",{className:"font-medium truncate flex items-center gap-1",children:[e.jsx(we,{className:"w-3 h-3 opacity-60"}),N.studentName||"תלמיד"]}),e.jsxs("div",{className:"text-[10px] opacity-75",children:[J(N.startTime),"-",J(N.endTime)]}),e.jsx("div",{className:"flex items-center gap-1 text-[10px] opacity-80 h-4",children:N.instrument?e.jsxs(e.Fragment,{children:[e.jsx(ue,{className:"w-2.5 h-2.5"}),e.jsx("span",{className:"truncate",children:N.instrument})]}):e.jsx("span",{className:"invisible",children:"placeholder"})}),e.jsx("div",{className:"flex items-center gap-1 text-[10px] opacity-70 h-4",children:N.location?e.jsxs(e.Fragment,{children:[e.jsx(xe,{className:"w-2.5 h-2.5"}),e.jsx("span",{className:"truncate",children:N.location})]}):e.jsx("span",{className:"invisible",children:"placeholder"})})]})})})]},`${n.date}-${a}`)})]},a))})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-bold text-gray-900 font-reisinger-yonatan",children:"ימי לימוד - זמינות המורה"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"הגדר את הימים והשעות שבהם אתה זמין להוראה"})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs("button",{onClick:ee,className:"flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors",children:[e.jsx(be,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"הוסף יום לימוד"})]})})]}),l.length===0?e.jsxs("div",{className:"text-center py-12 bg-gray-50 rounded-lg",children:[e.jsx(ye,{className:"w-12 h-12 text-gray-300 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500 font-reisinger-yonatan text-lg",children:"אין ימי לימוד מוגדרים"}),e.jsx("button",{onClick:ee,className:"mt-4 text-indigo-600 hover:text-indigo-700 font-medium",children:"הוסף יום לימוד ראשון"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:l.map(a=>e.jsx(bt,{teachingDay:a,onEdit:()=>me(a),onDelete:()=>oe(a)},a._id||a.id))})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ae,{className:"w-5 h-5 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-900 font-reisinger-yonatan",children:"ימי לימוד"})]}),e.jsx("div",{className:"text-2xl font-bold text-blue-900 mt-2 font-reisinger-yonatan",children:l.length}),e.jsx("div",{className:"text-xs text-blue-700 mt-1",children:"ימי זמינות להוראה"})]}),e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(re,{className:"w-5 h-5 text-green-600"}),e.jsx("span",{className:"font-medium text-green-900 font-reisinger-yonatan",children:"שעות זמינות"})]}),e.jsx("div",{className:"text-2xl font-bold text-green-900 mt-2 font-reisinger-yonatan",children:(l.reduce((a,n)=>{const N=M(n.startTime,n.endTime);return a+N},0)/60).toFixed(1)}),e.jsx("div",{className:"text-xs text-green-700 mt-1",children:"שעות שבועיות זמינות"})]}),e.jsxs("div",{className:"bg-purple-50 border border-purple-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(we,{className:"w-5 h-5 text-purple-600"}),e.jsx("span",{className:"font-medium text-purple-900 font-reisinger-yonatan",children:"תלמידים"})]}),e.jsx("div",{className:"text-2xl font-bold text-purple-900 mt-2 font-reisinger-yonatan",children:new Set(c.map(a=>a.studentId).filter(Boolean)).size}),e.jsx("div",{className:"text-xs text-purple-700 mt-1",children:"תלמידים פעילים"})]}),e.jsxs("div",{className:"bg-orange-50 border border-orange-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xe,{className:"w-5 h-5 text-orange-600"}),e.jsx("span",{className:"font-medium text-orange-900 font-reisinger-yonatan",children:"שיעורים"})]}),e.jsx("div",{className:"text-2xl font-bold text-orange-900 mt-2 font-reisinger-yonatan",children:c.length}),e.jsx("div",{className:"text-xs text-orange-700 mt-1",children:"שיעורים קבועים"})]})]}),H&&L&&e.jsx(vt,{timeSlot:L,teacherId:t?._id||"",teachingDays:l,onClose:()=>{b(!1),E(null)},onSave:()=>{b(!1),E(null),f()}}),q&&e.jsx(jt,{lessonDay:v,teacherId:t?._id||"",onClose:()=>{i(!1),I(null)},onSave:()=>{i(!1),I(null),f()}}),k&&_&&e.jsx(Nt,{lesson:_,teacherId:t?._id||"",teachingDays:l,onClose:()=>{W(!1),K(null)},onSave:()=>{W(!1),K(null),f()}})]})}function bt({teachingDay:t,onEdit:S,onDelete:T}){return e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4 hover:shadow-lg transition-shadow",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-2 bg-green-100 rounded-lg",children:e.jsx(ae,{className:"w-4 h-4 text-green-600"})}),e.jsxs("div",{children:[e.jsxs("h5",{className:"font-bold text-gray-900 font-reisinger-yonatan",children:["יום ",t.day]}),e.jsx("p",{className:"text-xs text-gray-500 mt-0.5",children:"זמינות להוראה"})]})]}),t.isRecurring!==!1&&e.jsx("span",{className:"px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full font-reisinger-yonatan",children:"שבועי"})]}),e.jsx("div",{className:"mb-3 pb-3 border-b border-gray-100",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-700",children:[e.jsx(re,{className:"w-4 h-4 text-gray-400"}),e.jsxs("span",{className:"font-medium",children:[t.startTime," - ",t.endTime]})]})}),t.location&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600 mb-3",children:[e.jsx(xe,{className:"w-3.5 h-3.5 text-gray-400"}),e.jsx("span",{children:t.location})]}),e.jsx("div",{className:"p-2 bg-gray-50 rounded text-xs text-gray-600 mb-3",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(se,{className:"w-3 h-3"}),e.jsx("span",{children:"זמין לקביעת שיעורים בזמן זה"})]})}),t.notes&&e.jsx("div",{className:"p-2 bg-gray-50 rounded text-xs text-gray-600 mb-3",children:t.notes}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:S,className:"flex-1 flex items-center justify-center gap-1.5 px-3 py-1.5 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 transition-colors text-sm",children:[e.jsx(ke,{className:"w-3.5 h-3.5"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"ערוך"})]}),e.jsx("button",{onClick:T,className:"flex items-center justify-center p-1.5 bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors",title:"מחק יום לימוד",children:e.jsx(Ie,{className:"w-3.5 h-3.5"})})]})]})}function jt({lessonDay:t,teacherId:S,onClose:T,onSave:y}){const[h,c]=o.useState({day:t?.day||"ראשון",startTime:t?.startTime||"14:00",endTime:t?.endTime||"18:00",location:t?.location||"חדר מוזיקה",notes:t?.notes||"",recurring:t?.recurring||{isRecurring:!0,excludeDates:[]}}),[m,l]=o.useState(!1),g=async p=>{if(p.preventDefault(),t?.studentId){alert("לא ניתן לערוך שיעור תלמיד מכאן. אנא השתמש באפשרות העריכה בכרטיס השיעור.");return}if(!h.day||!h.startTime||!h.endTime){alert("יש למלא את כל השדות הנדרשים");return}try{l(!0);const u={day:h.day,startTime:h.startTime,endTime:h.endTime,location:h.location||null,notes:h.notes||null,recurring:h.recurring||{isRecurring:!0,excludeDates:[]}};t?.id&&/^[0-9a-fA-F]{24}$/.test(t.id)?await R.teacherSchedule.updateTimeBlock(S,t.id,u):await R.teacherSchedule.createTimeBlock(S,u),y()}catch(u){console.error("Error saving lesson day:",u),u?.message?.includes("not found")||u?.message?.includes("Resource not found")?(alert("יום הלימוד הזה כבר לא קיים במערכת. הוא יוסר מהתצוגה."),T(),y()):alert("שגיאה בשמירת יום הלימוד")}finally{l(!1)}},D=()=>["ראשון","שני","שלישי","רביעי","חמישי","שישי","שבת"];return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:t?"עריכת יום לימוד":"הוספת יום לימוד חדש"}),e.jsx("button",{onClick:T,className:"p-2 text-gray-400 hover:text-gray-600",children:e.jsx(ve,{className:"w-6 h-6"})})]}),e.jsxs("form",{onSubmit:g,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"יום בשבוע *"}),e.jsx("select",{value:h.day,onChange:p=>c(u=>({...u,day:p.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",required:!0,children:D().map(p=>e.jsx("option",{value:p,children:p},p))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שעת התחלה *"}),e.jsx("input",{type:"time",value:h.startTime,onChange:p=>c(u=>({...u,startTime:p.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שעת סיום *"}),e.jsx("input",{type:"time",value:h.endTime,onChange:p=>c(u=>({...u,endTime:p.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",required:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"מיקום / חדר"}),e.jsxs("select",{value:h.location||"",onChange:p=>c(u=>({...u,location:p.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"",children:"בחר חדר"}),Ee.map(p=>e.jsx("option",{value:p,children:p},p))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"הערות"}),e.jsx("textarea",{value:h.notes||"",onChange:p=>c(u=>({...u,notes:p.target.value})),rows:3,placeholder:"הערות נוספות לגבי השיעור...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:h.recurring?.isRecurring!==!1,onChange:p=>c(u=>({...u,recurring:{isRecurring:p.target.checked,excludeDates:u.recurring?.excludeDates||[]}})),className:"rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"שיעור קבוע (חוזר שבועית)"})]}),h.recurring?.isRecurring&&e.jsx("p",{className:"text-xs text-gray-500 mr-6 mt-1",children:"השיעור יופיע באופן קבוע בכל שבוע ביום ובשעה שהוגדרו"})]}),e.jsxs("div",{className:"flex gap-3 pt-6 border-t",children:[e.jsx("button",{type:"submit",disabled:m,className:"flex-1 bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed font-reisinger-yonatan flex items-center justify-center gap-2",children:m?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"שומר..."]}):e.jsx(e.Fragment,{children:t?e.jsxs(e.Fragment,{children:[e.jsx(Oe,{className:"w-4 h-4"}),"עדכן יום לימוד"]}):e.jsxs(e.Fragment,{children:[e.jsx(be,{className:"w-4 h-4"}),"הוסף יום לימוד"]})})}),e.jsx("button",{type:"button",onClick:T,disabled:m,className:"flex-1 bg-gray-300 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed font-reisinger-yonatan",children:"ביטול"})]})]})]})})}function vt({timeSlot:t,teacherId:S,teachingDays:T,onClose:y,onSave:h}){const[c,m]=o.useState(""),[l,g]=o.useState(45),[D,p]=o.useState([]),[u,F]=o.useState(!1),[q,i]=o.useState(!1),[v,I]=o.useState(0);o.useEffect(()=>{d()},[S]);const d=async()=>{try{F(!0);const W=(await R.teachers.getTeacherStudents(S)).map(_=>{const K=_.academicInfo?.instrumentProgress?.find(f=>f.isPrimary)||_.academicInfo?.instrumentProgress?.[0];return{id:_._id,firstName:_.personalInfo?.firstName||"",lastName:_.personalInfo?.lastName||"",instrument:K?.instrumentName||"",class:_.personalInfo?.class||_.academicInfo?.class,stage:K?.currentStage}});p(W)}catch(k){console.error("Error loading students:",k)}finally{F(!1)}},C=(k,W)=>{const[_,K]=k.split(":").map(Number),f=_*60+K+W,B=Math.floor(f/60),M=f%60;return`${B.toString().padStart(2,"0")}:${M.toString().padStart(2,"0")}`},H=()=>{const[k]=t.time.split(":").map(Number),W=v;return`${k.toString().padStart(2,"0")}:${W.toString().padStart(2,"0")}`},b=[0,5,10,15,20,25,30,35,40,45,50,55],L=async k=>{if(k.preventDefault(),!c){alert("יש לבחור תלמיד");return}try{i(!0);const W=D.find(P=>P.id===c),_=H(),K=C(_,l),B=T.find(P=>P.day===t.dayName)?.location||"",M={teacherId:S,day:t.dayName,time:_,endTime:K,duration:l,location:B,isActive:!0};await R.students.addTeacherAssignment(c,M);const A={day:t.dayName,startTime:_,endTime:K,studentId:c,studentName:W?`${W.firstName} ${W.lastName}`:"",instrument:W?.instrument||"",location:B,notes:`שיעור קבוע שבועי - נוצר ב-${new Date().toLocaleDateString("he-IL")}`,recurring:{isRecurring:!0,excludeDates:[]},isRecurring:!0,totalDuration:l};await R.teacherSchedule.createTimeBlock(S,A),h()}catch(W){console.error("Error creating weekly lesson assignment:",W),alert("שגיאה ביצירת הקצאת השיעור השבועי")}finally{i(!1)}},E=k=>k.slice(0,5);return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-md mx-4",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:"הוספת שיעור חדש"}),e.jsx("button",{onClick:y,className:"p-2 text-gray-400 hover:text-gray-600",children:e.jsx(ve,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"mb-4 p-3 bg-blue-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 text-blue-800 mb-2",children:[e.jsx(ae,{className:"w-4 h-4"}),e.jsxs("span",{className:"font-medium",children:["שיעור קבוע שבועי - יום ",t.dayName]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-blue-700",children:[e.jsx(re,{className:"w-4 h-4"}),e.jsxs("span",{children:[E(H())," - ",E(C(H(),l))," (",l," דקות)"]})]}),e.jsxs("div",{className:"text-xs text-blue-600 mt-1",children:["השיעור יתקיים כל שבוע ביום ",t.dayName," באותה שעה"]})]}),e.jsxs("form",{onSubmit:L,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"בחר תלמיד *"}),u?e.jsx("div",{className:"text-center py-2 text-gray-500",children:"טוען רשימת תלמידים..."}):e.jsxs("select",{value:c,onChange:k=>m(k.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",required:!0,children:[e.jsx("option",{value:"",children:"בחר תלמיד"}),D.map(k=>e.jsxs("option",{value:k.id,children:[k.firstName," ",k.lastName,k.instrument&&` - ${k.instrument}`,k.class&&` (כיתה ${k.class})`]},k.id))]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:["זמן התחלה מדויק (שעה ",t.time.split(":")[0],":__)"]}),e.jsx("div",{className:"grid grid-cols-6 gap-2",children:b.map(k=>e.jsxs("button",{type:"button",onClick:()=>I(k),className:`px-3 py-2 rounded-lg border-2 transition-all font-medium ${v===k?"border-indigo-600 bg-indigo-50 text-indigo-700":"border-gray-200 hover:border-gray-300 hover:bg-gray-50"}`,children:[":",k.toString().padStart(2,"0")]},k))}),e.jsxs("div",{className:"mt-2 text-xs text-gray-600",children:["שעת התחלה: ",H()]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"משך השיעור (דקות)"}),e.jsxs("select",{value:l,onChange:k=>g(Number(k.target.value)),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:30,children:"30 דקות"}),e.jsx("option",{value:45,children:"45 דקות"}),e.jsx("option",{value:60,children:"60 דקות"}),e.jsx("option",{value:90,children:"90 דקות"})]})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{type:"submit",disabled:q||!c,className:"flex-1 bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed font-reisinger-yonatan flex items-center justify-center gap-2",children:q?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"יוצר שיעור שבועי..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Oe,{className:"w-4 h-4"}),"צור שיעור שבועי"]})}),e.jsx("button",{type:"button",onClick:y,disabled:q,className:"flex-1 bg-gray-300 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed font-reisinger-yonatan",children:"ביטול"})]})]})]})})}function Nt({lesson:t,teacherId:S,teachingDays:T,onClose:y,onSave:h}){const c=(b,L)=>{const[E,k]=b.split(":").map(Number),[W,_]=L.split(":").map(Number);return W*60+_-(E*60+k)},l=T.find(b=>b.day===t.day)?.location||"",[g,D]=o.useState({day:t.day,startTime:t.startTime,endTime:t.endTime,location:t.location||l,notes:t.notes||""}),[p,u]=o.useState(!1),[F,q]=o.useState(c(t.startTime,t.endTime)),[i,v]=o.useState([]);o.useState(""),o.useEffect(()=>{if(!g.day||!F)return;const b=T.filter(E=>E.day===g.day),L=[];b.forEach(E=>{const[k,W]=E.startTime.split(":").map(Number),[_,K]=E.endTime.split(":").map(Number),f=k*60+W,M=_*60+K-f,A=Math.floor(M/F);for(let P=0;P<A;P++){const U=f+P*F,J=U+F,O=Math.floor(U/60),ee=U%60,ne=Math.floor(J/60),me=J%60,oe=`${O.toString().padStart(2,"0")}:${ee.toString().padStart(2,"0")}`,ce=`${ne.toString().padStart(2,"0")}:${me.toString().padStart(2,"0")}`;L.push({id:`${E._id||E.id}-${F}-${P}`,startTime:oe,endTime:ce,duration:F})}}),v(L)},[g.day,F,T]);const I=b=>{D(L=>({...L,startTime:b.startTime,endTime:b.endTime}))},d=async b=>{if(b.preventDefault(),!g.day||!g.startTime||!g.endTime){alert("יש למלא את כל השדות הנדרשים");return}const L=c(g.startTime,g.endTime);if(L<=0){alert("זמן הסיום חייב להיות לאחר זמן ההתחלה");return}try{if(u(!0),t.studentId){const E={teacherId:S,day:g.day,time:g.startTime,startTime:g.startTime,endTime:g.endTime,duration:L,location:g.location,isActive:!0};await R.students.updateTeacherAssignment(t.studentId,S,E)}C("השיעור עודכן בהצלחה","success"),h()}catch(E){console.error("Error updating lesson:",E),C("שגיאה בעדכון השיעור","error")}finally{u(!1)}},C=(b,L)=>{const E=document.createElement("div");E.className=`fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 ${L==="success"?"bg-green-500 text-white":"bg-red-500 text-white"}`,E.innerHTML=`<div class="flex items-center gap-2 font-reisinger-yonatan">
      ${L==="success"?"✅":"❌"} ${b}
    </div>`,document.body.appendChild(E),setTimeout(()=>E.remove(),3e3)},H=()=>{const b=Array.from(new Set(T.map(L=>L.day)));return b.length===0?["ראשון","שני","שלישי","רביעי","חמישי","שישי","שבת"]:b};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:"עריכת שיעור"}),e.jsx("button",{onClick:y,className:"p-2 text-gray-400 hover:text-gray-600",children:e.jsx(ve,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsx("h4",{className:"font-medium text-blue-900 mb-2 font-reisinger-yonatan",children:"פרטי התלמיד"}),e.jsxs("div",{className:"space-y-1 text-sm text-blue-800",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(we,{className:"w-4 h-4"}),e.jsx("strong",{children:"תלמיד:"})," ",t.studentName||"לא צוין"]}),t.instrument&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ue,{className:"w-4 h-4"}),e.jsx("strong",{children:"כלי נגינה:"})," ",t.instrument]}),t.studentClass&&e.jsxs("div",{children:[e.jsx("strong",{children:"כיתה:"})," ",t.studentClass]}),t.studentStage&&e.jsxs("div",{children:[e.jsx("strong",{children:"שלב:"})," ",t.studentStage]})]})]}),e.jsxs("form",{onSubmit:d,className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"יום בשבוע *"}),e.jsx("select",{value:g.day,onChange:b=>{const L=b.target.value,E=T.find(k=>k.day===L);D(k=>({...k,day:L,location:(!k.location||k.location==="")&&E?.location?E.location:k.location}))},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",required:!0,children:H().map(b=>e.jsx("option",{value:b,children:b},b))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"משך השיעור (דקות) *"}),e.jsx("div",{className:"grid grid-cols-3 gap-3",children:[30,45,60].map(b=>e.jsxs("button",{type:"button",onClick:()=>q(b),className:`px-4 py-2 rounded-lg border-2 transition-all ${F===b?"border-indigo-600 bg-indigo-50 text-indigo-700 font-semibold":"border-gray-300 bg-white text-gray-700 hover:border-indigo-300"}`,children:[b," דק׳"]},b))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2 font-reisinger-yonatan",children:"בחר זמן שיעור זמין *"}),i.length===0?e.jsxs("div",{className:"text-center py-6 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsx(re,{className:"w-8 h-8 mx-auto mb-2 text-gray-300"}),e.jsx("p",{className:"text-sm text-gray-500",children:"אין זמנים זמינים ליום ומשך שיעור שנבחרו"})]}):e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 max-h-64 overflow-y-auto p-2 bg-gray-50 rounded-lg border border-gray-200",children:i.map(b=>{const L=g.startTime===b.startTime&&g.endTime===b.endTime;return e.jsxs("button",{type:"button",onClick:()=>I(b),className:`p-3 rounded-lg border-2 transition-all text-sm ${L?"border-green-600 bg-green-50 text-green-800 font-semibold shadow-md":b.duration===30?"border-green-300 bg-green-50 text-green-800 hover:border-green-500":b.duration===45?"border-blue-300 bg-blue-50 text-blue-800 hover:border-blue-500":"border-purple-300 bg-purple-50 text-purple-800 hover:border-purple-500"}`,children:[e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx(re,{className:"w-3 h-3"}),e.jsxs("span",{className:"font-medium",children:[b.startTime,"-",b.endTime]})]}),e.jsxs("div",{className:"text-xs mt-1 opacity-75",children:[b.duration," דקות"]})]},b.id)})})]}),g.startTime&&g.endTime&&e.jsx("div",{className:"p-3 bg-indigo-50 rounded-lg border border-indigo-200",children:e.jsxs("div",{className:"flex items-center gap-2 text-indigo-800",children:[e.jsx(re,{className:"w-4 h-4"}),e.jsxs("span",{className:"font-reisinger-yonatan font-medium",children:["זמן שיעור נבחר: ",g.startTime," - ",g.endTime," (",c(g.startTime,g.endTime)," דקות)"]})]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"מיקום / חדר"}),e.jsxs("select",{value:g.location||"",onChange:b=>D(L=>({...L,location:b.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"",children:"בחר חדר"}),Ee.map(b=>e.jsx("option",{value:b,children:b},b))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"הערות"}),e.jsx("textarea",{value:g.notes,onChange:b=>D(L=>({...L,notes:b.target.value})),rows:3,placeholder:"הערות נוספות לגבי השיעור...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{className:"flex gap-3 pt-6 border-t",children:[e.jsx("button",{type:"submit",disabled:p||!g.startTime||!g.endTime,className:"flex-1 bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed font-reisinger-yonatan flex items-center justify-center gap-2",children:p?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"שומר..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Oe,{className:"w-4 h-4"}),"עדכן שיעור"]})}),e.jsx("button",{type:"button",onClick:y,disabled:p,className:"flex-1 bg-gray-300 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed font-reisinger-yonatan",children:"ביטול"})]})]})]})})}function He(){const{user:t}=je(),[S,T]=o.useState([]),[y,h]=o.useState(!0),[c,m]=o.useState(""),[l,g]=o.useState(!1),[D,p]=o.useState(null),[u,F]=o.useState(null),[q,i]=o.useState([]),[v,I]=o.useState(null),[d,C]=o.useState(!1),[H,b]=o.useState(!1),[L,E]=o.useState(!1),[k,W]=o.useState([]),[_,K]=o.useState(null),[f,B]=o.useState("lessons");o.useEffect(()=>{M()},[t]);const M=async()=>{if(t?._id)try{h(!0);const r=t._id,j=(await R.theory.getTheoryLessons()).filter(x=>x.teacherId===r).map(x=>({id:x._id,name:x.name,description:x.description,level:x.level,duration:x.duration,capacity:x.capacity,enrolledCount:x.enrolledStudentIds?.length||0,schedule:{dayOfWeek:x.dayOfWeek,startTime:x.startTime,endTime:x.endTime},status:x.isActive?"active":"inactive",venue:x.location,materials:x.materials||[]}));T(j)}catch(r){console.error("Error loading theory lessons:",r),I("שגיאה בטעינת רשימת שיעורי התיאוריה")}finally{h(!1)}},A=async r=>{try{const w=(await R.theory.getTheoryLesson(r)).enrolledStudentIds||[];if(w.length===0){i([]);return}const x=(await R.students.getStudents({ids:w.join(",")})).map(a=>({id:a._id,firstName:a.personalInfo?.firstName||"",lastName:a.personalInfo?.lastName||"",grade:a.academicInfo?.gradeLevel,instrument:a.primaryInstrument,enrollmentDate:a.createdAt||new Date().toISOString(),attendance:{total:0,present:0,absent:0}}));i(x)}catch(s){console.error("Error loading lesson students:",s)}},P=S.filter(r=>c===""||r.name.toLowerCase().includes(c.toLowerCase())||r.level.toLowerCase().includes(c.toLowerCase())||r.description?.toLowerCase().includes(c.toLowerCase())),U=async r=>{if(window.confirm("האם אתה בטוח שברצונך למחוק שיעור זה?"))try{await R.theory.deleteTheoryLesson(r),T(s=>s.filter(w=>w.id!==r)),u===r&&(F(null),i([]))}catch(s){console.error("Error deleting lesson:",s),alert("שגיאה במחיקת השיעור")}},J=async r=>{try{const s=await O(r);if(s.hasConflict){K(s),E(!0);return}if(D){const w={name:r.name,description:r.description,level:r.level,duration:r.duration,capacity:r.capacity,dayOfWeek:r.schedule?.dayOfWeek,startTime:r.schedule?.startTime,endTime:r.schedule?.endTime,isActive:r.status==="active",location:r.venue},j=await R.theory.updateTheoryLesson(D.id,w),x={id:j._id,name:j.name,description:j.description,level:j.level,duration:j.duration,capacity:j.capacity,enrolledCount:j.enrolledStudentIds?.length||0,schedule:{dayOfWeek:j.dayOfWeek,startTime:j.startTime,endTime:j.endTime},status:j.isActive?"active":"inactive",venue:j.location,materials:j.materials||[]};T(a=>a.map(n=>n.id===D.id?x:n))}else{const w=t?._id,j={name:r.name,description:r.description,level:r.level,duration:r.duration,capacity:r.capacity,dayOfWeek:r.schedule?.dayOfWeek,startTime:r.schedule?.startTime,endTime:r.schedule?.endTime,isActive:r.status==="active",location:r.venue,teacherId:w},x=await R.theory.createTheoryLesson(j),a={id:x._id,name:x.name,description:x.description,level:x.level,duration:x.duration,capacity:x.capacity,enrolledCount:x.enrolledStudentIds?.length||0,schedule:{dayOfWeek:x.dayOfWeek,startTime:x.startTime,endTime:x.endTime},status:x.isActive?"active":"inactive",venue:x.location,materials:x.materials||[]};T(n=>[...n,a])}g(!1),p(null)}catch(s){console.error("Error saving lesson:",s),alert("שגיאה בשמירת פרטי השיעור")}},O=async r=>{try{const s=S.filter(a=>a.id!==D?.id&&a.schedule.dayOfWeek===r.schedule?.dayOfWeek),w=r.schedule?.startTime,j=r.schedule?.endTime,x=s.filter(a=>{const n=a.schedule.startTime,N=a.schedule.endTime;return w&&j&&n&&N&&(w>=n&&w<N||j>n&&j<=N||w<=n&&j>=N)});return x.length>0?{hasConflict:!0,conflictDetails:`התנגשות עם ${x[0].name} ב${fe(x[0].schedule.dayOfWeek)} ${x[0].schedule.startTime}-${x[0].schedule.endTime}`,suggestions:["שנה את שעת השיעור","העבר ליום אחר","קצר את משך השיעור"]}:{hasConflict:!1}}catch(s){return console.error("Error checking conflicts:",s),{hasConflict:!1}}},ee=async()=>{try{const r=await R.students.getStudents(),s=q.map(j=>j.id),w=r.filter(j=>!s.includes(j._id)).map(j=>({id:j._id,firstName:j.personalInfo?.firstName||"",lastName:j.personalInfo?.lastName||"",grade:j.academicInfo?.gradeLevel,instrument:j.primaryInstrument,enrollmentDate:new Date().toISOString(),attendance:{total:0,present:0,absent:0}}));W(w)}catch(r){console.error("Error loading available students:",r)}},ne=async r=>{if(u)try{await Be.enrollStudent(u,r,{method:"manual",performedBy:"teacher",reason:"Teacher enrollment"}),await A(u),await ee()}catch(s){console.error("Error enrolling student:",s),alert("שגיאה ברישום התלמיד")}},me=async r=>{if(u)try{await Be.unenrollStudent(u,r,{reason:"Teacher unenrollment"}),await A(u),await ee()}catch(s){console.error("Error unenrolling student:",s),alert("שגיאה בביטול רישום התלמיד")}},oe=async r=>{try{const s={...r,name:`${r.name} - עותק`,id:void 0};await J(s)}catch(s){console.error("Error duplicating lesson:",s),alert("שגיאה בשכפול השיעור")}},ce=r=>{switch(r){case"beginner":return"מתחילים";case"intermediate":return"בינוניים";case"advanced":return"מתקדמים";default:return r}},he=r=>r.substring(0,5),fe=r=>({sunday:"יום ראשון",monday:"יום שני",tuesday:"יום שלישי",wednesday:"יום רביעי",thursday:"יום חמישי",friday:"יום שישי",saturday:"יום שבת"})[r.toLowerCase()]||r;return y?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600",children:"טוען רשימת שיעורים..."})]})}):v?e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("div",{className:"text-red-800 font-reisinger-yonatan",children:v})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:"ניהול תיאוריה מתקדם"}),e.jsxs("p",{className:"text-gray-600 mt-1",children:[S.length," שיעורים פעילים"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>C(!0),className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[e.jsx(ot,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"נהל קבוצות"})]}),e.jsxs("button",{onClick:()=>g(!0),className:"flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors",children:[e.jsx(be,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"הוסף שיעור"})]})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsx("nav",{className:"flex space-x-8 px-6",dir:"rtl",children:[{id:"lessons",label:"שיעורים",icon:ye},{id:"groups",label:"קבוצות",icon:se},{id:"curriculum",label:"תכנית לימודים",icon:Pe},{id:"grades",label:"ציונים",icon:Re}].map(r=>{const s=r.icon;return e.jsxs("button",{onClick:()=>B(r.id),className:`py-4 px-1 border-b-2 font-medium text-sm transition-colors flex items-center gap-2 font-reisinger-yonatan ${f===r.id?"border-indigo-500 text-indigo-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}`,children:[e.jsx(s,{className:"w-4 h-4"}),r.label]},r.id)})})}),e.jsxs("div",{className:"p-6",children:[f==="lessons"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative mb-6",children:[e.jsx(ge,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"חיפוש שיעורים...",value:c,onChange:r=>m(r.target.value),className:"w-full pl-4 pr-12 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"rtl"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsx("div",{className:"space-y-4",children:P.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ye,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2 font-reisinger-yonatan",children:c?"לא נמצאו שיעורים":"אין שיעורים רשומים"}),e.jsx("p",{className:"text-gray-600 font-reisinger-yonatan",children:c?"נסה מילות חיפוש אחרות":"התחל בהוספת השיעור הראשון שלך"})]}):P.map(r=>e.jsxs("div",{className:`bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all cursor-pointer ${u===r.id?"ring-2 ring-indigo-500 bg-indigo-50":""}`,onClick:()=>{F(r.id),A(r.id)},children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-gray-900 font-reisinger-yonatan",children:r.name}),e.jsxs("p",{className:"text-sm text-gray-600 font-reisinger-yonatan",children:[ce(r.level)," • ",r.duration," דקות"]}),r.description&&e.jsx("p",{className:"text-sm text-gray-500 mt-1 font-reisinger-yonatan",children:r.description})]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:s=>{s.stopPropagation(),oe(r)},className:"p-1 text-gray-400 hover:text-blue-600 transition-colors",title:"שכפל שיעור",children:e.jsx(ct,{className:"w-4 h-4"})}),e.jsx("button",{onClick:s=>{s.stopPropagation(),p(r),g(!0)},className:"p-1 text-gray-400 hover:text-indigo-600 transition-colors",title:"ערוך שיעור",children:e.jsx(ke,{className:"w-4 h-4"})}),e.jsx("button",{onClick:s=>{s.stopPropagation(),U(r.id)},className:"p-1 text-gray-400 hover:text-red-600 transition-colors",title:"מחק שיעור",children:e.jsx(Ie,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm text-gray-600 mb-3",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ae,{className:"w-4 h-4"}),e.jsx("span",{children:fe(r.schedule.dayOfWeek)})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(re,{className:"w-4 h-4"}),e.jsxs("span",{children:[he(r.schedule.startTime)," - ",he(r.schedule.endTime)]})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(se,{className:"w-4 h-4"}),e.jsxs("span",{children:[r.enrolledCount||0,"/",r.capacity]})]}),r.venue&&e.jsx("span",{children:r.venue})]}),e.jsx("span",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${r.status==="active"?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"}`,children:r.status==="active"?"פעיל":"לא פעיל"})]})]},r.id))}),u&&e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h4",{className:"font-semibold text-gray-900 font-reisinger-yonatan",children:"תלמידי השיעור"}),e.jsx("div",{className:"flex gap-2",children:e.jsxs("button",{onClick:()=>{b(!0),ee()},className:"flex items-center gap-1 text-indigo-600 hover:text-indigo-800 text-sm font-medium font-reisinger-yonatan",children:[e.jsx(le,{className:"w-4 h-4"}),"הוסף תלמיד"]})})]}),q.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(se,{className:"w-8 h-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-500 text-sm font-reisinger-yonatan",children:"אין תלמידים רשומים לשיעור"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:q.map(r=>e.jsxs("div",{className:"flex items-center justify-between p-3 hover:bg-gray-50 rounded border",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-medium text-sm font-reisinger-yonatan",children:[r.firstName," ",r.lastName]}),e.jsxs("div",{className:"text-xs text-gray-500 font-reisinger-yonatan",children:[r.instrument&&`${r.instrument} • `,r.grade&&`כיתה ${r.grade} • `,"רישום: ",new Date(r.enrollmentDate).toLocaleDateString("he-IL")]}),r.attendance&&e.jsxs("div",{className:"text-xs text-gray-500 mt-1 font-reisinger-yonatan",children:["נוכחות: ",r.attendance.present,"/",r.attendance.total," שיעורים",e.jsxs("span",{className:`ml-2 ${r.attendance.present/r.attendance.total>=.8?"text-green-600":"text-red-600"}`,children:["(",Math.round(r.attendance.present/r.attendance.total*100),"%)"]})]})]}),e.jsx("button",{onClick:()=>me(r.id),className:"text-red-600 hover:text-red-800 p-1",title:"הסר תלמיד",children:e.jsx(Ve,{className:"w-4 h-4"})})]},r.id))})]})]})]}),f==="groups"&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(se,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2 font-reisinger-yonatan",children:"ניהול קבוצות תיאוריה"}),e.jsx("p",{className:"text-gray-600 font-reisinger-yonatan",children:"תכונה זו תהיה זמינה בקרוב"})]}),f==="curriculum"&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Pe,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2 font-reisinger-yonatan",children:"תכנית לימודים"}),e.jsx("p",{className:"text-gray-600 font-reisinger-yonatan",children:"תכונה זו תהיה זמינה בקרוב"})]}),f==="grades"&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Re,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2 font-reisinger-yonatan",children:"ניהול ציונים"}),e.jsx("p",{className:"text-gray-600 font-reisinger-yonatan",children:"תכונה זו תהיה זמינה בקרוב"})]})]})]}),l&&e.jsx(wt,{lesson:D,onClose:()=>{g(!1),p(null)},onSubmit:J}),H&&e.jsx(St,{availableStudents:k,onClose:()=>b(!1),onEnroll:ne}),L&&_&&e.jsx(Tt,{conflict:_,onClose:()=>E(!1),onResolve:()=>{E(!1),g(!0)}})]})}function wt({lesson:t,onClose:S,onSubmit:T}){const[y,h]=o.useState({name:t?.name||"",description:t?.description||"",level:t?.level||"beginner",duration:t?.duration||60,capacity:t?.capacity||15,status:t?.status||"active",venue:t?.venue||"",schedule:{dayOfWeek:t?.schedule?.dayOfWeek||"sunday",startTime:t?.schedule?.startTime||"09:00",endTime:t?.schedule?.endTime||"10:00"}}),c=l=>{l.preventDefault(),T(y)},m=(l,g)=>{h(D=>({...D,schedule:{...D.schedule,[l]:g}}))};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto",dir:"rtl",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900 mb-4 font-reisinger-yonatan",children:t?"עריכת שיעור תיאוריה":"הוספת שיעור תיאוריה חדש"}),e.jsxs("form",{onSubmit:c,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שם השיעור *"}),e.jsx("input",{type:"text",required:!0,value:y.name,onChange:l=>h(g=>({...g,name:l.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"תיאור השיעור"}),e.jsx("textarea",{value:y.description,onChange:l=>h(g=>({...g,description:l.target.value})),rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"רמה *"}),e.jsxs("select",{required:!0,value:y.level,onChange:l=>h(g=>({...g,level:l.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"beginner",children:"מתחילים"}),e.jsx("option",{value:"intermediate",children:"בינוניים"}),e.jsx("option",{value:"advanced",children:"מתקדמים"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"משך השיעור (דקות) *"}),e.jsx("input",{type:"number",required:!0,min:"30",max:"180",step:"15",value:y.duration,onChange:l=>h(g=>({...g,duration:parseInt(l.target.value)})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"קיבולת תלמידים *"}),e.jsx("input",{type:"number",required:!0,min:"1",max:"50",value:y.capacity,onChange:l=>h(g=>({...g,capacity:parseInt(l.target.value)})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"סטטוס"}),e.jsxs("select",{value:y.status,onChange:l=>h(g=>({...g,status:l.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"active",children:"פעיל"}),e.jsx("option",{value:"inactive",children:"לא פעיל"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"יום השיעור *"}),e.jsxs("select",{required:!0,value:y.schedule.dayOfWeek,onChange:l=>m("dayOfWeek",l.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"sunday",children:"יום ראשון"}),e.jsx("option",{value:"monday",children:"יום שני"}),e.jsx("option",{value:"tuesday",children:"יום שלישי"}),e.jsx("option",{value:"wednesday",children:"יום רביעי"}),e.jsx("option",{value:"thursday",children:"יום חמישי"}),e.jsx("option",{value:"friday",children:"יום שישי"}),e.jsx("option",{value:"saturday",children:"יום שבת"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שעת התחלה *"}),e.jsx("input",{type:"time",required:!0,value:y.schedule.startTime,onChange:l=>m("startTime",l.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"שעת סיום *"}),e.jsx("input",{type:"time",required:!0,value:y.schedule.endTime,onChange:l=>m("endTime",l.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 font-reisinger-yonatan",children:"מקום השיעור"}),e.jsx("input",{type:"text",value:y.venue,onChange:l=>h(g=>({...g,venue:l.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx("button",{type:"submit",className:"flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors font-reisinger-yonatan",children:t?"עדכן":"הוסף"}),e.jsx("button",{type:"button",onClick:S,className:"flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors font-reisinger-yonatan",children:"ביטול"})]})]})]})})}function St({availableStudents:t,onClose:S,onEnroll:T}){const[y,h]=o.useState(""),c=t.filter(m=>`${m.firstName} ${m.lastName}`.toLowerCase().includes(y.toLowerCase())||m.instrument?.toLowerCase().includes(y.toLowerCase()));return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-md mx-4 max-h-[80vh] overflow-y-auto",dir:"rtl",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900 mb-4 font-reisinger-yonatan",children:"הוסף תלמיד לשיעור"}),e.jsxs("div",{className:"relative mb-4",children:[e.jsx(ge,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"text",placeholder:"חיפוש תלמידים...",value:y,onChange:m=>h(m.target.value),className:"w-full pl-4 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"})]}),e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto",children:c.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(se,{className:"w-8 h-8 mx-auto mb-2 text-gray-300"}),e.jsx("p",{className:"font-reisinger-yonatan",children:"אין תלמידים זמינים"})]}):c.map(m=>e.jsxs("div",{className:"flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium text-gray-900 font-reisinger-yonatan",children:[m.firstName," ",m.lastName]}),e.jsxs("div",{className:"text-sm text-gray-600 font-reisinger-yonatan",children:[m.instrument&&`${m.instrument} • `,m.grade&&`כיתה ${m.grade}`]})]}),e.jsxs("button",{onClick:()=>T(m.id),className:"flex items-center gap-1 px-3 py-1 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm font-reisinger-yonatan",children:[e.jsx(le,{className:"w-4 h-4"}),"הוסף"]})]},m.id))}),e.jsx("div",{className:"flex gap-3 mt-6",children:e.jsx("button",{onClick:S,className:"flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors font-reisinger-yonatan",children:"סגור"})})]})})}function Tt({conflict:t,onClose:S,onResolve:T}){return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-md mx-4",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx(dt,{className:"w-8 h-8 text-yellow-600"}),e.jsx("h3",{className:"text-lg font-bold text-gray-900 font-reisinger-yonatan",children:"התנגשות בלוח הזמנים"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-gray-700 font-reisinger-yonatan mb-3",children:t.conflictDetails}),t.suggestions&&e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900 mb-2 font-reisinger-yonatan",children:"הצעות לפתרון:"}),e.jsx("ul",{className:"list-disc list-inside space-y-1 text-sm text-gray-600",children:t.suggestions.map((y,h)=>e.jsx("li",{className:"font-reisinger-yonatan",children:y},h))})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:T,className:"flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors font-reisinger-yonatan",children:"ערוך שיעור"}),e.jsx("button",{onClick:S,className:"flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors font-reisinger-yonatan",children:"ביטול"})]})]})})}function Ct(){const{user:t,checkAuthStatus:S}=je(),[T,y]=o.useState(!1),[h,c]=o.useState(!1),[m,l]=o.useState({type:null,message:""}),[g,D]=o.useState(null),[p,u]=o.useState({fullName:"",email:"",phone:"",address:"",birthDate:""});o.useEffect(()=>{F()},[]);const F=async()=>{try{c(!0);const d=await De.getMyProfile();D(d),u({fullName:d?.personalInfo?.fullName||"",email:d?.personalInfo?.email||"",phone:d?.personalInfo?.phone||"",address:d?.personalInfo?.address||"",birthDate:d?.personalInfo?.birthDate||""})}catch(d){console.error("Error fetching profile data:",d),l({type:"error",message:"שגיאה בטעינת פרטי הפרופיל"}),t&&u({fullName:t?.personalInfo?.fullName||"",email:t?.personalInfo?.email||t?.email||"",phone:t?.personalInfo?.phone||t?.phone||"",address:t?.personalInfo?.address||t?.address||"",birthDate:t?.personalInfo?.birthDate||t?.birthDate||""})}finally{c(!1)}},q=async()=>{try{c(!0),l({type:null,message:""});const d=await De.updateMyProfile(p);D(d),S&&await S(!0),y(!1),l({type:"success",message:"הפרופיל עודכן בהצלחה"}),setTimeout(()=>{l({type:null,message:""})},3e3)}catch(d){console.error("Error updating profile:",d),l({type:"error",message:"שגיאה בעדכון הפרופיל. אנא נסה שוב."})}finally{c(!1)}},i=()=>{const d=g||t;u({fullName:d?.personalInfo?.fullName||"",email:d?.personalInfo?.email||d?.email||"",phone:d?.personalInfo?.phone||d?.phone||"",address:d?.personalInfo?.address||d?.address||"",birthDate:d?.personalInfo?.birthDate||d?.birthDate||""}),y(!1),l({type:null,message:""})},v=d=>d?new Date(d).toLocaleDateString("he-IL"):"",I=g||t;return h&&!I?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"}),e.jsx("p",{className:"mt-4 text-gray-600 font-reisinger-yonatan",children:"טוען פרטי פרופיל..."})]})}):e.jsxs("div",{className:"space-y-6",children:[m.type&&e.jsxs("div",{className:`p-4 rounded-lg flex items-center gap-2 ${m.type==="success"?"bg-green-50 text-green-800 border border-green-200":"bg-red-50 text-red-800 border border-red-200"}`,children:[m.type==="success"?e.jsx(Ge,{className:"w-5 h-5"}):e.jsx(Ae,{className:"w-5 h-5"}),e.jsx("span",{className:"font-reisinger-yonatan",children:m.message})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:"פרטים אישיים"}),T?e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:q,disabled:h,className:"flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[h?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}):e.jsx(ut,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"שמירה"})]}),e.jsxs("button",{onClick:i,disabled:h,className:"flex items-center gap-2 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(ve,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"ביטול"})]})]}):e.jsxs("button",{onClick:()=>y(!0),disabled:h,className:"flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(mt,{className:"w-4 h-4"}),e.jsx("span",{className:"font-reisinger-yonatan",children:"עריכה"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 font-reisinger-yonatan",children:"שם מלא"}),T?e.jsx("input",{type:"text",value:p.fullName,onChange:d=>u(C=>({...C,fullName:d.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"rtl",placeholder:"הזן שם מלא"}):e.jsx("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:e.jsx("span",{className:"font-reisinger-yonatan",children:p.fullName||"לא צוין"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 font-reisinger-yonatan",children:'דוא"ל'}),T?e.jsx("input",{type:"email",value:p.email,onChange:d=>u(C=>({...C,email:d.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"ltr",placeholder:"example@email.com"}):e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:[e.jsx(gt,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"font-reisinger-yonatan",dir:"ltr",children:p.email||"לא צוין"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 font-reisinger-yonatan",children:"טלפון"}),T?e.jsx("input",{type:"tel",value:p.phone,onChange:d=>u(C=>({...C,phone:d.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"ltr",placeholder:"050-1234567"}):e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:[e.jsx(ze,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"font-reisinger-yonatan",dir:"ltr",children:p.phone||"לא צוין"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 font-reisinger-yonatan",children:"כתובת"}),T?e.jsx("input",{type:"text",value:p.address,onChange:d=>u(C=>({...C,address:d.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",dir:"rtl",placeholder:"הזן כתובת"}):e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:[e.jsx(xe,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"font-reisinger-yonatan",children:p.address||"לא צוין"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 font-reisinger-yonatan",children:"תאריך לידה"}),T?e.jsx("input",{type:"date",value:p.birthDate,onChange:d=>u(C=>({...C,birthDate:d.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"}):e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:[e.jsx(ae,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"font-reisinger-yonatan",children:v(p.birthDate)||"לא צוין"})]})]})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("h4",{className:"text-lg font-semibold text-blue-900 mb-2 font-reisinger-yonatan",children:"מידע תפקיד"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-sm font-medium text-blue-700 font-reisinger-yonatan",children:"תפקיד:"}),e.jsx("div",{className:"text-blue-900 font-reisinger-yonatan",children:(()=>{const d=I?.roles||[];if(d.length>0)return d.join(", ");const C=I?.role||"";switch(C){case"teacher":return"מורה";case"מורה":return"מורה";case"conductor":return"מנצח";case"מנצח":return"מנצח";case"theory_teacher":return"מורה תיאוריה";case"מורה תיאוריה":return"מורה תיאוריה";case"admin":return"מנהל";case"מנהל":return"מנהל";default:return C||"לא צוין"}})()})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-sm font-medium text-blue-700 font-reisinger-yonatan",children:"מזהה משתמש:"}),e.jsx("div",{className:"text-blue-900 font-reisinger-yonatan font-mono text-sm",children:I?.teacherId||I?._id||I?.id||"לא צוין"})]}),I?.isActive!==void 0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-sm font-medium text-blue-700 font-reisinger-yonatan",children:"סטטוס:"}),e.jsx("div",{className:"text-blue-900 font-reisinger-yonatan",children:I.isActive?"פעיל":"לא פעיל"})]}),I?.professionalInfo?.instrument&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-sm font-medium text-blue-700 font-reisinger-yonatan",children:"כלי נגינה:"}),e.jsx("div",{className:"text-blue-900 font-reisinger-yonatan",children:I.professionalInfo.instrument})]})]})]})]})}function At(){const{user:t}=je(),S=st();at();const[T,y]=o.useState("general"),[h,c]=o.useState(null),[m,l]=o.useState(!0);o.useEffect(()=>{const d=S.state;d?.activeTab&&(y(d.activeTab),window.history.replaceState(null,"",window.location.pathname))},[S]),o.useEffect(()=>{t&&g()},[t]);const g=async()=>{try{if(l(!0),!(t?._id||t?.teacherId||t?.id)){console.warn("No user ID available for loading profile statistics");return}const C=await De.getMyProfile();if(!C){console.warn("No teacher profile found"),c({studentsCount:0,activeStudents:0,weeklyHours:0,orchestrasCount:0,theoryLessonsCount:0});return}const H=C?.teaching?.studentIds||[],b=C?.conducting?.orchestraIds||[],L=C?.teaching?.timeBlocks||[],[E,k]=await Promise.allSettled([H.length>0?R.students.getBatchStudents(H):Promise.resolve([]),b.length>0?R.orchestras.getBatchOrchestras(b):Promise.resolve([])]),W=E.status==="fulfilled"?E.value:[];E.status==="rejected"&&console.error("Failed to load student data:",E.reason);const _=k.status==="fulfilled"?k.value:[];k.status==="rejected"&&console.error("Failed to load orchestra data:",k.reason);const K=Array.isArray(W)?W.filter(M=>M.academicInfo?.isActive!==!1):[],f=Array.isArray(L)?L.reduce((M,A)=>M+(parseInt(A.totalDuration)||0),0):0,B=Math.round(f/60*10)/10;c({studentsCount:Array.isArray(W)?W.length:0,activeStudents:K.length,weeklyHours:B,orchestrasCount:Array.isArray(_)?_.length:0,theoryLessonsCount:0})}catch(d){console.error("Error loading profile statistics:",d),c({studentsCount:0,activeStudents:0,weeklyHours:0,orchestrasCount:0,theoryLessonsCount:0})}finally{l(!1)}};if(!t)return e.jsx("div",{className:"flex items-center justify-center min-h-96",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600",children:"טוען פרטי משתמש..."})]})});const p=(()=>{const d=[{id:"general",label:"פרטים כלליים",icon:we,component:Ct}];switch(t?.role||t?.roles?.[0]||""){case"teacher":case"מורה":return[...d,{id:"students",label:"התלמידים שלי",icon:se,component:Fe},{id:"schedule",label:"לוח זמנים שבועי",icon:ae,component:qe}];case"conductor":case"מנצח":return[...d,{id:"orchestras",label:"תזמורות שאני מנצח",icon:ue,component:We}];case"theory_teacher":case"מורה תיאוריה":return[...d,{id:"lessons",label:"שיעורי התיאוריה שלי",icon:ye,component:He}];default:const H=[...d];return(t?.roles?.includes("teacher")||t?.roles?.includes("מורה"))&&(H.push({id:"students",label:"התלמידים שלי",icon:se,component:Fe}),H.push({id:"schedule",label:"לוח זמנים שבועי",icon:ae,component:qe})),(t?.roles?.includes("conductor")||t?.roles?.includes("מנצח"))&&H.push({id:"orchestras",label:"תזמורות שאני מנצח",icon:ue,component:We}),(t?.roles?.includes("theory_teacher")||t?.roles?.includes("מורה תיאוריה"))&&H.push({id:"lessons",label:"שיעורי התיאוריה שלי",icon:ye,component:He}),H}})(),F=(p.find(d=>d.id===T)||p[0]).component,q=()=>{const d=t?.role||t?.roles?.[0]||"";switch(d){case"teacher":return"מורה";case"מורה":return"מורה";case"conductor":return"מנצח";case"מנצח":return"מנצח";case"theory_teacher":return"מורה תיאוריה";case"מורה תיאוריה":return"מורה תיאוריה";case"admin":return"מנהל";case"מנהל":return"מנהל";default:return d||"משתמש"}},i=()=>t?.personalInfo?.fullName||t?.fullName||t?.name||"משתמש",v=()=>{const d=i();if(!d||d==="משתמש")return"מ";const C=d.trim().split(" ");return C.length>=2?C[0][0]+C[1][0]:C[0][0]||"מ"},I=()=>t?.personalInfo?.email||t?.email||"";return e.jsxs("div",{className:"p-6",dir:"rtl",children:[e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-indigo-600 flex items-center justify-center",children:e.jsx("span",{className:"text-xl font-bold text-white font-reisinger-yonatan",children:v()})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 font-reisinger-yonatan",children:i()}),e.jsxs("p",{className:"text-gray-600 mt-1",children:[q()," • ",I()]})]})]})}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-6",children:[e.jsx(Ce,{title:"סה״כ תלמידים",value:m?"...":h?.studentsCount?.toString()||"0",icon:se,color:"blue",loading:m}),e.jsx(Ce,{title:"תלמידים פעילים",value:m?"...":h?.activeStudents?.toString()||"0",icon:xt,color:"green",loading:m}),e.jsx(Ce,{title:"שעות שבועיות",value:m?"...":h?.weeklyHours?.toString()||"0",icon:re,color:"purple",loading:m}),e.jsx(Ce,{title:t?.roles?.includes("conductor")||t?.roles?.includes("מנצח")?"תזמורות":"שיעורי תיאוריה",value:m?"...":(h?.orchestrasCount||h?.theoryLessonsCount)?.toString()||"0",icon:t?.roles?.includes("conductor")||t?.roles?.includes("מנצח")?ue:ye,color:"indigo",loading:m})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 mb-6",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsx("nav",{className:"flex gap-0 overflow-x-auto scrollbar-hide",children:p.map(d=>{const C=d.icon;return e.jsxs("button",{onClick:()=>y(d.id),className:`flex items-center gap-2 sm:gap-3 px-3 sm:px-6 py-3 sm:py-4 font-medium text-xs sm:text-sm transition-all whitespace-nowrap ${T===d.id?"text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50":"text-gray-500 hover:text-gray-700 hover:bg-gray-50"}`,children:[e.jsx(C,{className:"w-5 h-5"}),e.jsx("span",{className:"font-reisinger-yonatan",children:d.label})]},d.id)})})}),e.jsx("div",{className:"p-6",children:e.jsx(F,{})})]})]})}function Ce({title:t,value:S,icon:T,color:y,loading:h}){const m={blue:{bg:"bg-blue-50",text:"text-blue-600",border:"border-blue-200"},green:{bg:"bg-green-50",text:"text-green-600",border:"border-green-200"},purple:{bg:"bg-purple-50",text:"text-purple-600",border:"border-purple-200"},indigo:{bg:"bg-indigo-50",text:"text-indigo-600",border:"border-indigo-200"}}[y];return e.jsx("div",{className:`bg-white rounded-lg border ${m.border} p-3 sm:p-4 shadow-sm hover:shadow-md transition-all duration-200`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-xs sm:text-sm font-medium text-gray-600 font-reisinger-yonatan truncate",children:t}),e.jsx("div",{className:"text-lg sm:text-2xl font-bold text-gray-900 mt-1 font-reisinger-yonatan",children:h?e.jsx("div",{className:"animate-pulse bg-gray-200 h-6 sm:h-8 w-12 sm:w-16 rounded"}):S})]}),e.jsx("div",{className:`${m.bg} p-2 sm:p-3 rounded-full flex-shrink-0 ml-2`,children:e.jsx(T,{className:`w-4 h-4 sm:w-6 sm:h-6 ${m.text}`})})]})})}export{At as default};
