const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["chunks/Dashboard-BfHH8TkA.js","chunks/vendor-E-WBaSU9.js","chunks/StatsCard-IHi88ezj.js","chunks/utils-Cgyyg58q.js","chunks/Card-ieVndSwB.js","chunks/cascade-deletion-MikTgWpr.js","chunks/query-CMzvnXZ6.js","chunks/ui-DIGiJ8tL.js","chunks/Students-yT3Y9j_E.js","chunks/Table-ECqVz6dn.js","chunks/ConfirmationModal-BqaXyp1U.js","chunks/StudentDetailsPageSimple-BJLFLsav.js","chunks/TeacherNameDisplay-Dtf5k020.js","chunks/apiCache-B1l-w5Fi.js","chunks/theoryEnrollmentService-Bw4SayZ7.js","chunks/Teachers-SSabGqyh.js","chunks/TheoryLessons-CV_9_cs2.js","chunks/TheoryLessonDetails-Bz5hd-Ul.js","chunks/Orchestras-pJ1gNVFP.js","chunks/Rehearsals-CaJ8i6uA.js","chunks/RehearsalDetails-uAhe6MQs.js","chunks/Bagruts-B0BSAxQa.js","chunks/useBagrut-Js8CkqlA.js","chunks/BagrutDetails-CFFwtq7k.js","chunks/Profile-DFMlsQPX.js","chunks/RehearsalAttendance-C_S_coUJ.js","chunks/OrchestraEnrollmentManager-myMgZEhB.js","chunks/TeacherDetailsPage-hpuWdHXC.js","chunks/OrchestraDetailsPage-BnkuSGn6.js"])))=>i.map(i=>d[i]);
var Rt=Object.defineProperty;var Pt=(t,r,o)=>r in t?Rt(t,r,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[r]=o;var Oe=(t,r,o)=>Pt(t,typeof r!="symbol"?r+"":r,o);import{r as u,a as $t,u as Lt,b as Ve,L as ht,c as Ut,d as M,N as Ie,R as Se,B as Bt}from"../chunks/vendor-E-WBaSU9.js";import{a as z,t as Ft,s as Mt,o as Vt,_ as G,e as Yt}from"../chunks/cascade-deletion-MikTgWpr.js";import{Q as gt,c as xt}from"../chunks/query-CMzvnXZ6.js";import{X as de,A as Ye,U as ie,C as ce,a as ae,B as Ne,M as ke,T as Ue,P as ge,b as te,c as De,F as Ke,d as ne,e as je,f as le,S as We,g as ve,h as Wt,R as Ht,i as Je,j as Ze,k as Xt,l as Re,m as zt,n as qt,H as we,G as ft,o as He,p as Ee,q as Gt,r as et,s as tt,t as pt,u as Qt,v as Kt,w as st,L as Jt}from"../chunks/ui-DIGiJ8tL.js";import"../chunks/utils-Cgyyg58q.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))c(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const l of n.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&c(l)}).observe(document,{childList:!0,subtree:!0});function o(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function c(i){if(i.ep)return;i.ep=!0;const n=o(i);fetch(i.href,n)}})();var yt={exports:{}},_e={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Zt=u,es=Symbol.for("react.element"),ts=Symbol.for("react.fragment"),ss=Object.prototype.hasOwnProperty,rs=Zt.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,as={key:!0,ref:!0,__self:!0,__source:!0};function bt(t,r,o){var c,i={},n=null,l=null;o!==void 0&&(n=""+o),r.key!==void 0&&(n=""+r.key),r.ref!==void 0&&(l=r.ref);for(c in r)ss.call(r,c)&&!as.hasOwnProperty(c)&&(i[c]=r[c]);if(t&&t.defaultProps)for(c in r=t.defaultProps,r)i[c]===void 0&&(i[c]=r[c]);return{$$typeof:es,type:t,key:n,ref:l,props:i,_owner:rs.current}}_e.Fragment=ts;_e.jsx=bt;_e.jsxs=bt;yt.exports=_e;var e=yt.exports,Be={},rt=$t;Be.createRoot=rt.createRoot,Be.hydrateRoot=rt.hydrateRoot;const jt=u.createContext(null),xe=()=>{const t=u.useContext(jt);if(!t)throw new Error("useAuth must be used within an AuthProvider");return t},ns=({children:t})=>{const[r,o]=u.useState(!1),[c,i]=u.useState(!0),[n,l]=u.useState(null),[f,j]=u.useState(null),[m,h]=u.useState(null),T=u.useRef(!1),A=u.useRef(null),I=u.useRef(!0);u.useEffect(()=>{I.current=!0;const y=setTimeout(()=>{I.current&&E()},100);return()=>{I.current=!1,A.current&&clearTimeout(A.current),clearTimeout(y)}},[]);const E=u.useCallback(async(y=!1)=>{if(T.current&&!y){console.log("🔐 AUTH CONTEXT - Validation already in progress, skipping");return}const S=Date.now();if(!y&&m&&S-m<3e4){console.log("🔐 AUTH CONTEXT - Using cached authentication status");return}T.current=!0,j(null);try{if(z.auth.isAuthenticated()){console.log("🔐 AUTH CONTEXT - Token found, validating with server");const C=await z.auth.validateToken();if(!I.current)return;const $=C?.data?.user||C?.user||C?.data||C;console.log("🔐 AUTH CONTEXT - Token validation successful, fetching full teacher data");let N=null;if($?._id)try{N=await z.teachers.getTeacher($._id),console.log("🔐 AUTH CONTEXT - Full teacher data fetched:",{hasPersonalInfo:!!N?.personalInfo,hasRoles:!!N?.roles,fullName:N?.personalInfo?.fullName})}catch(B){console.warn("🔐 AUTH CONTEXT - Could not fetch full teacher data:",B),N=$}const R=N||$,_={...R,teacherId:R?.teacherId||R?._id,personalInfo:R?.personalInfo||{fullName:R?.fullName||$?.fullName||"",email:R?.email||$?.email||"",phone:R?.phone||"",address:R?.address||""},roles:R?.roles||$?.roles||[],role:R?.role||R?.roles?.[0]||$?.roles?.[0]||""};console.log("🔐 AUTH CONTEXT - User data normalized:",{hasUserData:!!_,userRole:_?.role||_?.roles,userId:_?.teacherId||_?._id,fullName:_?.personalInfo?.fullName}),o(!0),l(_),h(S)}else console.log("🔐 AUTH CONTEXT - No valid token found"),o(!1),l(null),h(S)}catch(C){if(console.error("🔐 AUTH CONTEXT - Auth validation failed:",C),!I.current)return;j(C.message),o(!1),l(null),h(S),C.message.includes("Authentication failed")&&z.auth.isAuthenticated()&&console.log("🔐 AUTH CONTEXT - Attempting token refresh")}finally{I.current&&i(!1),T.current=!1}},[m]),L=async(y,S)=>{try{i(!0),j(null);const C=await z.auth.login(y,S);if(!I.current)return;console.log("🔐 AUTH CONTEXT - Login successful:",{hasToken:!!C.token,hasUserData:!!(C.teacher||C.user)});const{token:$}=C,N=C.teacher||C.user||C.data?.teacher||C.data?.user||C.data;if(!$||!N)throw new Error("Invalid login response: missing token or user data");console.log("🔐 AUTH CONTEXT - Fetching full teacher data after login");let R=null;if(N?._id||N?.teacherId)try{const K=N._id||N.teacherId;R=await z.teachers.getTeacher(K),console.log("🔐 AUTH CONTEXT - Full teacher data fetched after login:",{hasPersonalInfo:!!R?.personalInfo,hasRoles:!!R?.roles,fullName:R?.personalInfo?.fullName})}catch(K){console.warn("🔐 AUTH CONTEXT - Could not fetch full teacher data after login:",K),R=N}const _=R||N,B={..._,teacherId:_?.teacherId||_?._id,personalInfo:_?.personalInfo||{fullName:_?.fullName||N?.personalInfo?.fullName||N?.fullName||"",email:_?.email||N?.credentials?.email||N?.personalInfo?.email||N?.email||y,phone:_?.phone||N?.personalInfo?.phone||"",address:_?.address||N?.personalInfo?.address||""},roles:_?.roles||N?.roles||[],role:_?.role||_?.roles?.[0]||N?.roles?.[0]||""};return console.log("🔐 AUTH CONTEXT - User data normalized after login:",{hasUserData:!!B,userRole:B?.role||B?.roles,userId:B?.teacherId||B?._id,fullName:B?.personalInfo?.fullName}),o(!0),l(B),h(Date.now()),{success:!0,user:B}}catch(C){throw console.error("🔐 AUTH CONTEXT - Login failed:",C),I.current&&(j(C.message),o(!1),l(null)),C}finally{I.current&&i(!1)}},P=async()=>{try{i(!0),await z.auth.logout(),console.log("🔐 AUTH CONTEXT - Logout successful")}catch(y){console.warn("🔐 AUTH CONTEXT - Logout API call failed:",y)}finally{I.current&&(o(!1),l(null),j(null),h(null),i(!1))}},V=u.useCallback(async()=>{try{return console.log("🔐 AUTH CONTEXT - Attempting token refresh"),await E(!0),r}catch(y){return console.error("🔐 AUTH CONTEXT - Token refresh failed:",y),await P(),!1}},[r]),g=u.useCallback(()=>({isAuthenticated:r,isLoading:c,user:n?{id:n.teacherId||n.id,role:n.role}:null,authError:f,lastValidation:m?new Date(m).toISOString():null,isValidating:T.current,cacheAge:m?Date.now()-m:null}),[r,c,n,f,m]),v={isAuthenticated:r,isLoading:c,user:n,authError:f,login:L,logout:P,checkAuthStatus:E,refreshToken:V,debugAuth:g};return e.jsx(jt.Provider,{value:v,children:t})},vt=u.createContext(null),Nt=()=>{const t=u.useContext(vt);if(!t)throw new Error("useSchoolYear must be used within a SchoolYearProvider");return t},ls=({children:t})=>{const{isAuthenticated:r}=xe(),[o,c]=u.useState(null),[i,n]=u.useState([]),[l,f]=u.useState(!0),[j,m]=u.useState(null);u.useEffect(()=>{r?h():(c(null),n([]),f(!1),m(null))},[r]);const h=async()=>{try{f(!0),m(null);const g=await z.schoolYears.getSchoolYears();n(g);const v=await z.schoolYears.getCurrentSchoolYear();if(v)c(v);else if(g.length>0){const y=g.sort((S,C)=>new Date(C.startDate)-new Date(S.startDate))[0];c(y)}console.log(`🎓 Loaded ${g.length} school years, current: ${v?.name||"None"}`)}catch(g){console.error("Failed to load school years:",g),m(g.message||"שגיאה בטעינת שנות הלימוד")}finally{f(!1)}},T=async g=>{try{const v=i.find(y=>y._id===g);if(v)c(v),console.log(`🎯 Switched to school year: ${v.name}`);else{const y=await z.schoolYears.getSchoolYear(g);c(y),console.log(`🎯 Switched to fetched school year: ${y.name}`)}}catch(v){console.error("Failed to set school year:",v),m(v.message||"שגיאה בעדכון שנת הלימוד")}},A=async g=>{try{const v=await z.schoolYears.createSchoolYear(g);return n(y=>[...y,v]),g.isCurrent&&c(v),console.log(`➕ Created new school year: ${v.name}`),v}catch(v){throw console.error("Failed to create school year:",v),m(v.message||"שגיאה ביצירת שנת הלימוד"),v}},I=async(g,v)=>{try{const y=await z.schoolYears.updateSchoolYear(g,v);return n(S=>S.map(C=>C._id===g?y:C)),o&&o._id===g&&c(y),console.log(`✏️ Updated school year: ${y.name}`),y}catch(y){throw console.error("Failed to update school year:",y),m(y.message||"שגיאה בעדכון שנת הלימוד"),y}},E=async g=>{try{if(await z.schoolYears.deleteSchoolYear(g),n(v=>v.filter(y=>y._id!==g)),o&&o._id===g){const v=i.filter(y=>y._id!==g);v.length>0?c(v[0]):c(null)}console.log(`🗑️ Deleted school year: ${g}`)}catch(v){throw console.error("Failed to delete school year:",v),m(v.message||"שגיאה במחיקת שנת הלימוד"),v}},L=g=>{if(!g)return!1;const v=new Date,y=new Date(g.startDate),S=new Date(g.endDate);return v>=y&&v<=S&&g.isActive},V={currentSchoolYear:o,schoolYears:i,isLoading:l,error:j,loadSchoolYears:h,setCurrentSchoolYearById:T,createSchoolYear:A,updateSchoolYear:I,deleteSchoolYear:E,isSchoolYearActive:L,getSchoolYearDisplayName:g=>{if(!g)return"לא נבחרה שנה";const v=g.isCurrent,y=L(g);let S=g.name;return v?S+=" (נוכחית)":y&&(S+=" (פעילה)"),S}};return e.jsx(vt.Provider,{value:V,children:t})},os={currentBagrut:null,bagruts:[],loading:!1,error:null,validation:{errors:{},warnings:{}}},is=t=>{if(!t[3]?.detailedGrading)return 0;const r=t[3].detailedGrading;return(r.playingSkills?.points||0)+(r.musicalUnderstanding?.points||0)+(r.textKnowledge?.points||0)+(r.playingByHeart?.points||0)},cs=(t,r)=>{const o=t/100*100,c=r/100*100;return o*.9+c*.1},ds=t=>t>=95?"מצוין (100-95)":t>=85?"טוב מאד (94-85)":t>=75?"טוב (84-75)":t>=65?"כמעט טוב (74-65)":t>=55?"מספיק (64-55)":"לא מספיק (54-0)",us=t=>({presentations:[t.presentations?.[0]?.completed||!1,t.presentations?.[1]?.completed||!1,t.presentations?.[2]?.completed||!1,t.presentations?.[3]?.completed||!1],directorEvaluation:!!t.directorEvaluation?.points,recitalConfig:!!(t.recitalConfiguration?.units&&t.recitalConfiguration?.field),program:t.program?.length>0}),be=(t,r,o)=>t<0?`${o} לא יכול להיות שלילי`:t>r?`${o} לא יכול לעלות על ${r} נקודות`:null,ms=t=>t!==3&&t!==5?"יחידות רסיטל חייבות להיות 3 או 5":null,hs=(t,r)=>{switch(r.type){case"SET_LOADING":return{...t,loading:r.payload};case"SET_ERROR":return{...t,error:r.payload};case"SET_CURRENT_BAGRUT":return console.log("✅ BagrutContext: SET_CURRENT_BAGRUT reducer:",r.payload?._id),{...t,currentBagrut:r.payload};case"SET_BAGRUTS":return{...t,bagruts:r.payload};case"UPDATE_DIRECTOR_EVALUATION":{const{bagrutId:o,evaluation:c}=r.payload,i=t.currentBagrut?._id===o?{...t.currentBagrut,directorEvaluation:c}:t.currentBagrut,n=t.bagruts.map(l=>l._id===o?{...l,directorEvaluation:c}:l);return{...t,currentBagrut:i,bagruts:n}}case"UPDATE_RECITAL_CONFIG":{const{bagrutId:o,config:c}=r.payload,i={units:c.recitalUnits,field:c.recitalField},n=t.currentBagrut?._id===o?{...t.currentBagrut,recitalConfiguration:i,recitalUnits:c.recitalUnits,recitalField:c.recitalField}:t.currentBagrut,l=t.bagruts.map(f=>f._id===o?{...f,recitalConfiguration:i,recitalUnits:c.recitalUnits,recitalField:c.recitalField}:f);return{...t,currentBagrut:n,bagruts:l}}case"UPDATE_PRESENTATION":{const{bagrutId:o,index:c,data:i}=r.payload,n=(j=[])=>{const m=[...j];return m[c]={...m[c],...i},m},l=t.currentBagrut?._id===o?{...t.currentBagrut,presentations:n(t.currentBagrut.presentations)}:t.currentBagrut,f=t.bagruts.map(j=>j._id===o?{...j,presentations:n(j.presentations)}:j);return{...t,currentBagrut:l,bagruts:f}}case"CALCULATE_COMPUTED_VALUES":{const{bagrutId:o}=r.payload,c=i=>{if(i._id!==o)return i;const n=is(i.presentations||[]),l=i.directorEvaluation?.points||0,f=cs(n,l),j=ds(f),m=us(i);return{...i,computedValues:{totalPerformancePoints:n,weightedFinalGrade:f,gradeLevel:j,completionStatus:m},finalGrade:f,finalGradeLevel:j}};return{...t,currentBagrut:t.currentBagrut?c(t.currentBagrut):null,bagruts:t.bagruts.map(c)}}case"SET_VALIDATION_ERROR":return{...t,validation:{...t.validation,errors:{...t.validation.errors,[r.payload.field]:r.payload.message}}};case"CLEAR_VALIDATION_ERRORS":return{...t,validation:{...t.validation,errors:{}}};default:return t}},wt=u.createContext(null),gs=({children:t})=>{const[r,o]=u.useReducer(hs,os),c=u.useMemo(()=>({setLoading:n=>o({type:"SET_LOADING",payload:n}),setError:n=>o({type:"SET_ERROR",payload:n}),setCurrentBagrut:n=>{console.log("💾 BagrutContext: setCurrentBagrut action called with:",n?._id),o({type:"SET_CURRENT_BAGRUT",payload:n})},setBagruts:n=>o({type:"SET_BAGRUTS",payload:n}),updateDirectorEvaluation:(n,l)=>{const f=be(l.points||0,100,"הערכת מנהל");if(f){o({type:"SET_VALIDATION_ERROR",payload:{field:"directorEvaluation",message:f}});return}o({type:"UPDATE_DIRECTOR_EVALUATION",payload:{bagrutId:n,evaluation:l}}),o({type:"CALCULATE_COMPUTED_VALUES",payload:{bagrutId:n}})},updateRecitalConfig:(n,l)=>{const f=ms(l.recitalUnits);if(f){o({type:"SET_VALIDATION_ERROR",payload:{field:"recitalUnits",message:f}});return}o({type:"UPDATE_RECITAL_CONFIG",payload:{bagrutId:n,config:l}}),o({type:"CALCULATE_COMPUTED_VALUES",payload:{bagrutId:n}})},updatePresentation:(n,l,f)=>{if(f.detailedGrading){const j=f.detailedGrading,m=[];if(j.playingSkills?.points!==void 0){const h=be(j.playingSkills.points,40,"כישורי נגינה");h&&m.push(h)}if(j.musicalUnderstanding?.points!==void 0){const h=be(j.musicalUnderstanding.points,30,"הבנה מוזיקלית");h&&m.push(h)}if(j.textKnowledge?.points!==void 0){const h=be(j.textKnowledge.points,20,"ידע טקסט");h&&m.push(h)}if(j.playingByHeart?.points!==void 0){const h=be(j.playingByHeart.points,10,"נגינה בעל פה");h&&m.push(h)}if(m.length>0){o({type:"SET_VALIDATION_ERROR",payload:{field:`presentation${l}`,message:m[0]}});return}}o({type:"UPDATE_PRESENTATION",payload:{bagrutId:n,index:l,data:f}}),o({type:"CALCULATE_COMPUTED_VALUES",payload:{bagrutId:n}})},recalculateGrade:n=>{o({type:"CALCULATE_COMPUTED_VALUES",payload:{bagrutId:n}})},setValidationError:(n,l)=>{o({type:"SET_VALIDATION_ERROR",payload:{field:n,message:l}})},clearValidationErrors:()=>{o({type:"CLEAR_VALIDATION_ERRORS"})},validatePointTotal:n=>(n.playingSkills?.points||0)+(n.musicalUnderstanding?.points||0)+(n.textKnowledge?.points||0)+(n.playingByHeart?.points||0)>100?(o({type:"SET_VALIDATION_ERROR",payload:{field:"totalPoints",message:"סך הנקודות לא יכול לעלות על 100"}}),!1):!0,validateSequentialPresentation:(n,l)=>n>0&&!l[n-1]?.completed?(o({type:"SET_VALIDATION_ERROR",payload:{field:`presentation${n}`,message:`יש להשלים תחילה מצגת ${n}`}}),!1):!0}),[]),i=u.useMemo(()=>({state:r,actions:c}),[r,c]);return e.jsx(wt.Provider,{value:i,children:t})},fr=()=>{const t=u.useContext(wt);if(!t)throw new Error("useBagrutContext must be used within a BagrutProvider");return t},pr={getCurrentBagrut:t=>t.currentBagrut,getAllBagruts:t=>t.bagruts,getLoadingState:t=>t.loading,getError:t=>t.error,getValidationErrors:t=>t.validation.errors,getBagrutById:(t,r)=>t.bagruts.find(o=>o._id===r),getCompletedPresentations:(t,r)=>t.bagruts.find(c=>c._id===r)?.presentations?.filter(c=>c.completed)||[],getTotalPerformancePoints:(t,r)=>t.bagruts.find(c=>c._id===r)?.computedValues?.totalPerformancePoints||0,getWeightedFinalGrade:(t,r)=>t.bagruts.find(c=>c._id===r)?.computedValues?.weightedFinalGrade||0,getCompletionStatus:(t,r)=>t.bagruts.find(c=>c._id===r)?.computedValues?.completionStatus||{presentations:[!1,!1,!1,!1],directorEvaluation:!1,recitalConfig:!1,program:!1}},fe=new gt({defaultOptions:{queries:{staleTime:5*60*1e3,gcTime:10*60*1e3,refetchOnWindowFocus:!1,refetchOnReconnect:!0,refetchOnMount:!0,retry:(t,r)=>{const o=r?.response?.status;return o>=400&&o<500?!1:t<2},retryDelay:t=>Math.min(1e3*2**t,3e4),networkMode:"online"},mutations:{retry:1,networkMode:"online",onError:t=>{console.error("Mutation error:",t)}}}});fe.setQueryDefaults(["students"],{staleTime:2*60*1e3,gcTime:5*60*1e3});fe.setQueryDefaults(["teachers"],{staleTime:10*60*1e3,gcTime:30*60*1e3});fe.setQueryDefaults(["theory-lessons"],{staleTime:2*60*1e3,gcTime:5*60*1e3});fe.setQueryDefaults(["orchestras"],{staleTime:5*60*1e3,gcTime:15*60*1e3});fe.setQueryDefaults(["school-years"],{staleTime:30*60*1e3,gcTime:60*60*1e3});function xs({children:t}){return e.jsxs(xt,{client:fe,children:[t,!1]})}const Tt=u.createContext(void 0);function fs({children:t}){const[r,o]=u.useState(!0),[c,i]=u.useState(!1);return u.useEffect(()=>{const n=()=>{i(window.innerWidth<768)};return n(),window.addEventListener("resize",n),()=>window.removeEventListener("resize",n)},[]),e.jsx(Tt.Provider,{value:{isDesktopOpen:r,setIsDesktopOpen:o,isMobile:c},children:t})}function Xe(){const t=u.useContext(Tt);if(t===void 0)throw new Error("useSidebar must be used within a SidebarProvider");return t}const ps=["א","ב","ג","ד","ה","ו","ז","ח","ט","י","יא","יב","אחר"],ys=[1,2,3,4,5,6,7,8],bs=["חלילית","חליל צד","אבוב","בסון","סקסופון","קלרינט","חצוצרה","קרן יער","טרומבון","טובה/בריטון","שירה","כינור","ויולה","צ'לו","קונטרבס","פסנתר","גיטרה","גיטרה בס","תופים"],js=["ראשון","שני","שלישי","רביעי","חמישי","שישי"],vs=[30,45,60],at=["לא נבחן","עבר/ה","לא עבר/ה","עבר/ה בהצטיינות","עבר/ה בהצטיינות יתרה"],Ns=({initialData:t,onSubmit:r,onCancel:o,isEdit:c=!1})=>{const[i,n]=u.useState({personalInfo:{fullName:"",phone:"",age:null,address:"",parentName:"",parentPhone:"",parentEmail:"",studentEmail:""},academicInfo:{instrumentProgress:[{instrumentName:"",isPrimary:!0,currentStage:1,tests:{stageTest:{status:"לא נבחן"},technicalTest:{status:"לא נבחן"}}}],class:"א",tests:{bagrutId:null}},enrollments:{orchestraIds:[],ensembleIds:[],theoryLessonIds:[],schoolYears:[]},teacherIds:[],teacherAssignments:[],isActive:!0,...t}),[l,f]=u.useState({}),[j,m]=u.useState(!1),[h,T]=u.useState({personal:!0,academic:!0,instruments:!0,teachers:!0,enrollments:!1}),[A,I]=u.useState([]),[E,L]=u.useState([]),[P,V]=u.useState([]),[g,v]=u.useState([]),[y,S]=u.useState(""),[C,$]=u.useState(!1);u.useState([]);const[N,R]=u.useState({duration:null,selectedDays:[],startTime:"",endTime:""}),[_,B]=u.useState(!0);u.useEffect(()=>{const a=async()=>{try{const k=await z.teachers.getTeachers();I(k)}catch(k){console.error("Error fetching teachers:",k)}},x=async()=>{try{const k=await z.orchestras.getOrchestras();console.log("Fetched orchestras:",k);const O=await Promise.all((k||[]).map(async Y=>{if(Y.rehearsalIds&&Y.rehearsalIds.length>0)try{const Q=await z.rehearsals.getRehearsalById(Y.rehearsalIds[0]);return{...Y,rehearsalSchedule:Q?{day:Q.day||Q.dayOfWeek,startTime:Q.startTime,endTime:Q.endTime,location:Q.location||Y.location}:null}}catch{return console.log("Could not fetch rehearsal for orchestra:",Y.name),Y}return Y}));V(O)}catch(k){console.error("Error fetching orchestras:",k),V([])}},p=async()=>{try{const k=await z.theory.getTheoryLessons();console.log("Fetched theory lessons:",k),v(k||[])}catch(k){console.error("Error fetching theory lessons:",k),v([])}};a(),x(),p()},[]),u.useEffect(()=>{y&&(K(y),B(!0))},[y]);const K=async a=>{$(!0);try{const x=await z.teachers.getTeacherById(a);console.log("Teacher data for slots:",x);const p=x.teaching?.timeBlocks?.filter(O=>O.isActive!==!1)||[];console.log("Time blocks found:",p);const k=[];p.forEach(O=>{const Y=O.startTime,Q=O.endTime,w=O.day,[U,F]=Y.split(":").map(Number),[q,re]=Q.split(":").map(Number),ye=U*60+F,Dt=q*60+re-ye;vs.forEach(he=>{const Ct=Math.floor(Dt/he);for(let Te=0;Te<Ct;Te++){const Ae=ye+Te*he,qe=Ae+he,kt=Math.floor(Ae/60),Et=Ae%60,_t=Math.floor(qe/60),At=qe%60,Ge=`${kt.toString().padStart(2,"0")}:${Et.toString().padStart(2,"0")}`,Ot=`${_t.toString().padStart(2,"0")}:${At.toString().padStart(2,"0")}`;O.assignedLessons&&O.assignedLessons.some(Qe=>Qe.startTime===Ge&&Qe.duration===he)||k.push({_id:`${O._id}-${he}-${Te}`,day:w,startTime:Ge,endTime:Ot,duration:he,isAvailable:!0,location:O.location,teacherName:x.personalInfo?.fullName,teacherId:x._id,instrument:x.professionalInfo?.instrument})}})}),console.log("Generated available slots:",k),L(k)}catch(x){console.error("Error fetching teacher slots:",x),L([])}finally{$(!1)}},s=a=>{T(x=>({...x,[a]:!x[a]}))},d=(a,x,p)=>{n(k=>({...k,[a]:{...k[a],[x]:p}})),f(k=>({...k,[`${a}.${x}`]:""}))},b=(a,x,p)=>{const k=[...i.academicInfo.instrumentProgress];x==="tests"?k[a]={...k[a],tests:p}:k[a]={...k[a],[x]:p},x==="isPrimary"&&p===!0&&k.forEach((O,Y)=>{Y!==a&&(O.isPrimary=!1)}),n(O=>({...O,academicInfo:{...O.academicInfo,instrumentProgress:k}}))},D=()=>{const a=i.academicInfo.instrumentProgress.some(x=>x.isPrimary);n(x=>({...x,academicInfo:{...x.academicInfo,instrumentProgress:[...x.academicInfo.instrumentProgress,{instrumentName:"",isPrimary:!a,currentStage:1,tests:{stageTest:{status:"לא נבחן"},technicalTest:{status:"לא נבחן"}}}]}}))},W=a=>{const x=i.academicInfo.instrumentProgress.filter((p,k)=>k!==a);x.length>0&&!x.some(p=>p.isPrimary)&&(x[0].isPrimary=!0),n(p=>({...p,academicInfo:{...p.academicInfo,instrumentProgress:x}}))},ee=a=>{const x={teacherId:a.teacherId,day:a.day,time:a.startTime,duration:a.duration,isActive:!0,isRecurring:!0,...a.location&&{location:a.location}};n(p=>({...p,teacherAssignments:[...p.teacherAssignments,x],teacherIds:p.teacherIds.includes(a.teacherId)?p.teacherIds:[...p.teacherIds,a.teacherId]})),L(p=>p.filter(k=>k._id!==a._id)),B(!1)},ue=(a,x)=>{const[p,k]=a.split(":").map(Number),O=p*60+k+x,Y=Math.floor(O/60),Q=O%60;return`${Y.toString().padStart(2,"0")}:${Q.toString().padStart(2,"0")}`},me=a=>{const x=i.teacherAssignments[a];n(p=>{const k=p.teacherAssignments.filter((Y,Q)=>Q!==a),O=k.some(Y=>Y.teacherId===x.teacherId);return{...p,teacherAssignments:k,teacherIds:O?p.teacherIds:p.teacherIds.filter(Y=>Y!==x.teacherId)}})},J=()=>{const a={};i.personalInfo.fullName.trim()||(a["personalInfo.fullName"]="שם מלא הוא שדה חובה"),i.personalInfo.phone&&!/^05\d{8}$/.test(i.personalInfo.phone)&&(a["personalInfo.phone"]="מספר טלפון לא תקין (דוגמה: 0501234567)"),i.personalInfo.parentPhone&&!/^05\d{8}$/.test(i.personalInfo.parentPhone)&&(a["personalInfo.parentPhone"]="מספר טלפון הורה לא תקין"),i.personalInfo.parentEmail&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i.personalInfo.parentEmail)&&(a["personalInfo.parentEmail"]="אימייל הורה לא תקין"),i.personalInfo.studentEmail&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i.personalInfo.studentEmail)&&(a["personalInfo.studentEmail"]="אימייל תלמיד לא תקין"),i.academicInfo.class||(a["academicInfo.class"]="כיתה היא שדה חובה"),i.academicInfo.instrumentProgress.length===0?a["academicInfo.instruments"]="יש להוסיף לפחות כלי נגינה אחד":i.academicInfo.instrumentProgress.forEach((p,k)=>{p.instrumentName||(a[`instrument.${k}.name`]="שם הכלי הוא שדה חובה")});const x=i.academicInfo.instrumentProgress.some(p=>p.isPrimary);return i.academicInfo.instrumentProgress.length>0&&!x&&(a["academicInfo.primaryInstrument"]="יש לבחור כלי ראשי"),f(a),Object.keys(a).length===0},pe=async a=>{if(a.preventDefault(),!!J()){m(!0);try{console.log("📋 Form data being submitted:",JSON.stringify(i,null,2)),console.log("👥 Teacher assignments:",JSON.stringify(i.teacherAssignments,null,2)),console.log("👨‍🏫 Teacher IDs:",i.teacherIds),await r(i)}catch(x){console.error("Error submitting form:",x),f({submit:"שגיאה בשמירת הנתונים"})}finally{m(!1)}}};return e.jsxs("form",{onSubmit:pe,className:"space-y-6 max-w-4xl mx-auto p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:c?"עריכת תלמיד":"הוספת תלמיד חדש"}),e.jsx("button",{type:"button",onClick:o,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(de,{className:"w-5 h-5"})})]}),l.submit&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 flex items-center gap-2",children:[e.jsx(Ye,{className:"w-5 h-5 text-red-600"}),e.jsx("span",{className:"text-red-700",children:l.submit})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200",children:[e.jsxs("button",{type:"button",onClick:()=>s("personal"),className:"w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"w-5 h-5 text-primary-600"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"פרטים אישיים"})]}),h.personal?e.jsx(ce,{}):e.jsx(ae,{})]}),h.personal&&e.jsx("div",{className:"p-6 border-t border-gray-200",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["שם מלא ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:i.personalInfo.fullName,onChange:a=>d("personalInfo","fullName",a.target.value),className:`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 text-gray-900 ${l["personalInfo.fullName"]?"border-red-500":"border-gray-300"}`,placeholder:"הכנס שם משפחה ואז שם פרטי (לדוגמה: כהן יוסי)"}),l["personalInfo.fullName"]&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:l["personalInfo.fullName"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"טלפון תלמיד"}),e.jsx("input",{type:"tel",value:i.personalInfo.phone,onChange:a=>d("personalInfo","phone",a.target.value),className:`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 text-gray-900 ${l["personalInfo.phone"]?"border-red-500":"border-gray-300"}`,placeholder:"0501234567"}),l["personalInfo.phone"]&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:l["personalInfo.phone"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"גיל"}),e.jsx("input",{type:"number",value:i.personalInfo.age||"",onChange:a=>d("personalInfo","age",a.target.value?parseInt(a.target.value):null),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 text-gray-900",placeholder:"גיל התלמיד",min:"0",max:"99"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"אימייל תלמיד"}),e.jsx("input",{type:"email",value:i.personalInfo.studentEmail,onChange:a=>d("personalInfo","studentEmail",a.target.value),className:`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 text-gray-900 ${l["personalInfo.studentEmail"]?"border-red-500":"border-gray-300"}`,placeholder:"student@example.com"}),l["personalInfo.studentEmail"]&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:l["personalInfo.studentEmail"]})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"כתובת"}),e.jsx("input",{type:"text",value:i.personalInfo.address,onChange:a=>d("personalInfo","address",a.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 text-gray-900",placeholder:"הכנס כתובת מלאה"})]}),e.jsx("div",{className:"md:col-span-2 border-t pt-4 mt-2",children:e.jsx("h4",{className:"text-md font-medium text-gray-800 mb-4",children:"פרטי הורה"})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"שם הורה"}),e.jsx("input",{type:"text",value:i.personalInfo.parentName,onChange:a=>d("personalInfo","parentName",a.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 text-gray-900",placeholder:"שם ההורה"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"טלפון הורה"}),e.jsx("input",{type:"tel",value:i.personalInfo.parentPhone,onChange:a=>d("personalInfo","parentPhone",a.target.value),className:`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 text-gray-900 ${l["personalInfo.parentPhone"]?"border-red-500":"border-gray-300"}`,placeholder:"0501234567"}),l["personalInfo.parentPhone"]&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:l["personalInfo.parentPhone"]})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"אימייל הורה"}),e.jsx("input",{type:"email",value:i.personalInfo.parentEmail,onChange:a=>d("personalInfo","parentEmail",a.target.value),className:`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 text-gray-900 ${l["personalInfo.parentEmail"]?"border-red-500":"border-gray-300"}`,placeholder:"parent@example.com"}),l["personalInfo.parentEmail"]&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:l["personalInfo.parentEmail"]})]})]})})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200",children:[e.jsxs("button",{type:"button",onClick:()=>s("academic"),className:"w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"w-5 h-5 text-primary-600"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"פרטים אקדמיים"})]}),h.academic?e.jsx(ce,{}):e.jsx(ae,{})]}),h.academic&&e.jsx("div",{className:"p-6 border-t border-gray-200",children:e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["כיתה ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("select",{value:i.academicInfo.class,onChange:a=>d("academicInfo","class",a.target.value),className:`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 text-gray-900 ${l["academicInfo.class"]?"border-red-500":"border-gray-300"}`,children:ps.map(a=>e.jsx("option",{value:a,children:a},a))}),l["academicInfo.class"]&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:l["academicInfo.class"]})]})})})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200",children:[e.jsxs("button",{type:"button",onClick:()=>s("instruments"),className:"w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ke,{className:"w-5 h-5 text-primary-600"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"כלי נגינה"})]}),h.instruments?e.jsx(ce,{}):e.jsx(ae,{})]}),h.instruments&&e.jsxs("div",{className:"p-6 border-t border-gray-200",children:[l["academicInfo.instruments"]&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg",children:e.jsx("p",{className:"text-red-700 text-sm",children:l["academicInfo.instruments"]})}),l["academicInfo.primaryInstrument"]&&e.jsx("div",{className:"mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg",children:e.jsx("p",{className:"text-yellow-700 text-sm",children:l["academicInfo.primaryInstrument"]})}),e.jsxs("div",{className:"space-y-4",children:[i.academicInfo.instrumentProgress.map((a,x)=>e.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("h4",{className:"font-medium text-gray-900",children:["כלי נגינה ",x+1]}),i.academicInfo.instrumentProgress.length>1&&e.jsx("button",{type:"button",onClick:()=>W(x),className:"p-1 hover:bg-red-50 rounded text-red-600",children:e.jsx(Ue,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["שם הכלי ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:a.instrumentName,onChange:p=>b(x,"instrumentName",p.target.value),className:`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 text-gray-900 ${l[`instrument.${x}.name`]?"border-red-500":"border-gray-300"}`,children:[e.jsx("option",{value:"",children:"בחר כלי"}),bs.map(p=>e.jsx("option",{value:p,children:p},p))]}),l[`instrument.${x}.name`]&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:l[`instrument.${x}.name`]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"שלב נוכחי"}),e.jsx("select",{value:a.currentStage,onChange:p=>b(x,"currentStage",parseInt(p.target.value)),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 text-gray-900",children:ys.map(p=>e.jsxs("option",{value:p,children:["שלב ",p]},p))})]}),e.jsx("div",{children:e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:a.isPrimary,onChange:p=>b(x,"isPrimary",p.target.checked),className:"w-4 h-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"כלי ראשי"})]})}),e.jsxs("div",{className:"md:col-span-2 grid grid-cols-2 gap-4 mt-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"מבחן שלב"}),e.jsx("select",{value:a.tests.stageTest.status,onChange:p=>b(x,"tests",{...a.tests,stageTest:{...a.tests.stageTest,status:p.target.value}}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 text-gray-900",children:at.map(p=>e.jsx("option",{value:p,children:p},p))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"מבחן טכני"}),e.jsx("select",{value:a.tests.technicalTest.status,onChange:p=>b(x,"tests",{...a.tests,technicalTest:{...a.tests.technicalTest,status:p.target.value}}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 text-gray-900",children:at.map(p=>e.jsx("option",{value:p,children:p},p))})]})]})]})]},x)),e.jsxs("button",{type:"button",onClick:D,className:"w-full py-2 border-2 border-dashed border-gray-300 rounded-lg hover:border-primary-500 transition-colors flex items-center justify-center gap-2 text-gray-600 hover:text-primary-600",children:[e.jsx(ge,{className:"w-4 h-4"}),"הוסף כלי נגינה"]})]})]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200",children:[e.jsxs("button",{type:"button",onClick:()=>s("teachers"),className:"w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(te,{className:"w-5 h-5 text-primary-600"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"מורים ושיעורים"}),i.teacherAssignments.length>0&&e.jsxs("span",{className:"px-2 py-1 bg-primary-100 text-primary-700 rounded-full text-xs",children:[i.teacherAssignments.length," שיבוצים"]})]}),h.teachers?e.jsx(ce,{}):e.jsx(ae,{})]}),h.teachers&&e.jsxs("div",{className:"p-6 border-t border-gray-200",children:[i.teacherAssignments.length>0&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-700 mb-3",children:"שיעורים מתוכננים"}),e.jsx("div",{className:"space-y-2",children:i.teacherAssignments.map((a,x)=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded-lg border border-green-200",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(De,{className:"w-5 h-5 text-green-600"}),e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium text-gray-900",children:["מורה - ",A.find(p=>p._id===a.teacherId)?.professionalInfo?.instrument||"כלי"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[a.day," | ",a.time,"-",ue(a.time,a.duration)," | ",a.duration," דקות",a.location&&` | ${a.location}`]})]})]}),e.jsx("button",{type:"button",onClick:()=>me(x),className:"p-1 hover:bg-red-50 rounded text-red-600",children:e.jsx(Ue,{className:"w-4 h-4"})})]},x))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"בחר מורה"}),e.jsxs("select",{value:y,onChange:a=>S(a.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 text-gray-900",children:[e.jsx("option",{value:"",children:"בחר מורה לראות זמנים פנויים"}),A.map(a=>e.jsxs("option",{value:a._id,children:[a.personalInfo?.fullName," - ",a.professionalInfo?.instrument||"ללא כלי"]},a._id))]})]}),y&&e.jsxs("div",{className:"mt-4",children:[e.jsxs("h4",{className:"text-sm font-medium text-gray-700 mb-3",children:["זמנים פנויים - ",A.find(a=>a._id===y)?.personalInfo?.fullName||"מורה"]}),!_&&E.length>0&&e.jsx("div",{className:"mb-4",children:e.jsxs("button",{type:"button",onClick:()=>B(!0),className:"flex items-center gap-2 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors",children:[e.jsx(ge,{className:"w-4 h-4"}),"בחר שיעור נוסף"]})}),_&&!C&&E.length>0&&e.jsxs("div",{className:"mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h5",{className:"text-sm font-medium text-gray-700 flex items-center gap-2",children:[e.jsx(Ke,{className:"w-4 h-4"}),"סינון זמנים"]}),(N.duration||N.selectedDays.length>0||N.startTime||N.endTime)&&e.jsxs("button",{type:"button",onClick:()=>R({duration:null,selectedDays:[],startTime:"",endTime:""}),className:"text-xs text-primary-600 hover:text-primary-700 flex items-center gap-1",children:[e.jsx(de,{className:"w-3 h-3"}),"נקה סינון"]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-600 mb-1 block",children:"משך שיעור"}),e.jsxs("select",{value:N.duration||"",onChange:a=>R(x=>({...x,duration:a.target.value?Number(a.target.value):null})),className:"w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-1 focus:ring-primary-500 focus:border-primary-500 text-gray-900 bg-white",children:[e.jsx("option",{value:"",children:"כל המשכים"}),e.jsx("option",{value:"30",children:"30 דקות"}),e.jsx("option",{value:"45",children:"45 דקות"}),e.jsx("option",{value:"60",children:"60 דקות"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-600 mb-1 block",children:"ימים"}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{type:"button",className:"w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md bg-white text-right flex items-center justify-between text-gray-900",onClick:a=>{const x=a.currentTarget.nextElementSibling;x&&x.classList.toggle("hidden")},children:[e.jsx("span",{className:"truncate",children:N.selectedDays.length>0?`${N.selectedDays.length} ימים נבחרו`:"כל הימים"}),e.jsx(ae,{className:"w-4 h-4 flex-shrink-0"})]}),e.jsx("div",{className:"hidden absolute top-full mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg z-10",children:js.map(a=>e.jsxs("label",{className:"flex items-center px-3 py-2 hover:bg-gray-50 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:N.selectedDays.includes(a),onChange:x=>{x.target.checked?R(p=>({...p,selectedDays:[...p.selectedDays,a]})):R(p=>({...p,selectedDays:p.selectedDays.filter(k=>k!==a)}))},className:"ml-2 text-primary-600 rounded"}),e.jsx("span",{className:"text-sm text-gray-900",children:a})]},a))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-600 mb-1 block",children:"משעה"}),e.jsx("input",{type:"time",value:N.startTime,onChange:a=>R(x=>({...x,startTime:a.target.value})),className:"w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-1 focus:ring-primary-500 focus:border-primary-500 text-gray-900 bg-white"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-600 mb-1 block",children:"עד שעה"}),e.jsx("input",{type:"time",value:N.endTime,onChange:a=>R(x=>({...x,endTime:a.target.value})),className:"w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-1 focus:ring-primary-500 focus:border-primary-500 text-gray-900 bg-white"})]})]})]}),C?e.jsxs("div",{className:"text-center py-4",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto"}),e.jsx("p",{className:"text-sm text-gray-600 mt-2",children:"טוען זמנים פנויים..."})]}):_&&E.length>0?e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 mb-3",children:"בחר זמן ומשך שיעור מהאפשרויות הזמינות:"}),(()=>{const a=E.filter(p=>!(N.duration&&p.duration!==N.duration||N.selectedDays.length>0&&!N.selectedDays.includes(p.day)||N.startTime&&p.startTime<N.startTime||N.endTime&&p.endTime>N.endTime));if(a.length===0)return e.jsxs("div",{className:"text-center py-8 bg-gray-50 rounded-lg",children:[e.jsx(Ke,{className:"w-12 h-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-gray-500 text-sm mb-2",children:"אין זמנים התואמים לסינון שבחרת"}),e.jsx("button",{type:"button",onClick:()=>R({duration:null,selectedDays:[],startTime:"",endTime:""}),className:"text-xs text-primary-600 hover:text-primary-700",children:"נקה סינון ותראה את כל הזמנים"})]});const x=a.reduce((p,k)=>(p[k.day]||(p[k.day]=[]),p[k.day].push(k),p),{});return Object.entries(x).map(([p,k])=>e.jsxs("div",{className:"mb-4",children:[e.jsxs("h5",{className:"text-sm font-medium text-gray-600 mb-2 flex items-center gap-2",children:[e.jsx(te,{className:"w-4 h-4"}),p]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2",children:k.sort((O,Y)=>O.startTime.localeCompare(Y.startTime)).map(O=>e.jsx("button",{type:"button",onClick:()=>ee(O),className:`p-3 border rounded-lg hover:border-primary-500 hover:bg-primary-50 transition-colors text-right ${O.duration===30?"border-green-300 bg-green-50":O.duration===45?"border-blue-300 bg-blue-50":"border-purple-300 bg-purple-50"}`,children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ne,{className:"w-3 h-3"}),e.jsxs("span",{className:"text-sm font-medium text-gray-900",children:[O.startTime,"-",O.endTime]})]}),e.jsxs("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${O.duration===30?"bg-green-100 text-green-800":O.duration===45?"bg-blue-100 text-blue-800":"bg-purple-100 text-purple-800"}`,children:[O.duration," דק׳"]})]}),O.location&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-gray-500",children:[e.jsx(je,{className:"w-3 h-3"}),O.location]}),e.jsx("div",{className:"text-xs text-gray-600",children:O.instrument})]})},O._id))})]},p))})()]}):y&&!C&&_&&E.length===0?e.jsxs("div",{className:"text-center py-6 bg-gray-50 rounded-lg",children:[e.jsx(ne,{className:"w-12 h-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-gray-500 text-sm mb-2",children:"אין זמנים פנויים למורה זה"}),e.jsx("p",{className:"text-xs text-gray-400",children:"ייתכן שכל הזמנים הפנויים כבר תפוסים או שהמורה לא הגדיר זמני הוראה"})]}):null]})]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200",children:[e.jsxs("button",{type:"button",onClick:()=>s("enrollments"),className:"w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{className:"w-5 h-5 text-primary-600"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"הרשמות"})]}),h.enrollments?e.jsx(ce,{}):e.jsx(ae,{})]}),h.enrollments&&e.jsx("div",{className:"p-6 border-t border-gray-200",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"תזמורת"}),e.jsxs("select",{value:i.enrollments.orchestraIds[0]||"",onChange:a=>{n(x=>({...x,enrollments:{...x.enrollments,orchestraIds:a.target.value?[a.target.value]:[]}}))},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 text-gray-900",children:[e.jsx("option",{value:"",children:"בחר תזמורת"}),P.map(a=>{const x=a.rehearsalSchedule||a.schedule&&a.schedule[0]||a.rehearsals&&a.rehearsals[0]||null;let p=a.name;if(x){const k=x.day||x.dayOfWeek||"",O=x.startTime||"",Y=x.endTime||"",Q=x.location||a.location||"";k&&O&&Y&&(p+=` | ${k} ${O}-${Y}`),Q&&(p+=` | ${Q}`)}else a.location&&(p+=` | ${a.location}`);return e.jsx("option",{value:a._id,children:p},a._id)})]}),i.enrollments.orchestraIds[0]&&e.jsx("div",{className:"mt-2 p-3 bg-purple-50 rounded-lg border border-purple-200",children:(()=>{const a=P.find(x=>x._id===i.enrollments.orchestraIds[0]);return a?e.jsxs("div",{className:"space-y-1",children:[e.jsx("h4",{className:"font-medium text-purple-900",children:a.name}),e.jsxs("div",{className:"text-sm text-purple-700 space-y-1",children:[a.rehearsalSchedule&&e.jsxs("div",{className:"p-2 bg-purple-100 rounded",children:[e.jsx("strong",{children:"זמני חזרות:"})," ",a.rehearsalSchedule.day," ",a.rehearsalSchedule.startTime,"-",a.rehearsalSchedule.endTime,a.rehearsalSchedule.location&&e.jsxs("span",{children:[" | ",a.rehearsalSchedule.location]})]}),e.jsxs("div",{children:[e.jsx("strong",{children:"סוג:"})," ",a.type||"תזמורת"]}),!a.rehearsalSchedule&&a.location&&e.jsxs("div",{children:[e.jsx("strong",{children:"מיקום:"})," ",a.location]}),a.memberIds&&e.jsxs("div",{children:[e.jsx("strong",{children:"מספר חברים:"})," ",a.memberIds.length]}),e.jsxs("div",{children:[e.jsx("strong",{children:"סטטוס:"})," ",a.isActive?"פעיל":"לא פעיל"]}),a.rehearsalIds&&a.rehearsalIds.length>0&&e.jsxs("div",{children:[e.jsx("strong",{children:"מספר חזרות שמורות:"})," ",a.rehearsalIds.length]})]})]}):null})()})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"שיעור תיאוריה"}),e.jsxs("select",{value:i.enrollments.theoryLessonIds[0]||"",onChange:a=>{n(x=>({...x,enrollments:{...x.enrollments,theoryLessonIds:a.target.value?[a.target.value]:[]}}))},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 text-gray-900",children:[e.jsx("option",{value:"",children:"בחר שיעור תיאוריה"}),g.map(a=>{const x=a.schedule&&a.schedule.length>0?a.schedule[0]:null,p=x?`${x.day} ${x.startTime}-${x.endTime}${x.location?` | ${x.location}`:""}`:"";return e.jsxs("option",{value:a._id,children:[a.name||a.title||a.category," ",p?`| ${p}`:"",a.teacher?.personalInfo?.fullName&&` | מורה: ${a.teacher.personalInfo.fullName}`]},a._id)})]}),i.enrollments.theoryLessonIds[0]&&e.jsx("div",{className:"mt-2 p-3 bg-blue-50 rounded-lg border border-blue-200",children:(()=>{const a=g.find(x=>x._id===i.enrollments.theoryLessonIds[0]);return a?e.jsxs("div",{className:"space-y-1",children:[e.jsx("h4",{className:"font-medium text-blue-900",children:a.name}),e.jsxs("div",{className:"text-sm text-blue-700 space-y-1",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"רמה:"})," ",a.level]}),a.teacher?.personalInfo?.fullName&&e.jsxs("div",{children:[e.jsx("strong",{children:"מורה:"})," ",a.teacher.personalInfo.fullName]}),a.description&&e.jsxs("div",{children:[e.jsx("strong",{children:"תיאור:"})," ",a.description]}),a.maxStudents&&e.jsxs("div",{children:[e.jsx("strong",{children:"מקסימום תלמידים:"})," ",a.maxStudents]}),a.currentStudents!==void 0&&e.jsxs("div",{children:[e.jsx("strong",{children:"תלמידים נוכחיים:"})," ",a.currentStudents,"/",a.maxStudents||"∞"]}),a.schedule&&a.schedule.length>0&&e.jsxs("div",{children:[e.jsx("strong",{children:"זמני שיעור:"}),e.jsx("div",{className:"mt-1 space-y-1",children:a.schedule.map((x,p)=>e.jsxs("div",{className:"text-xs bg-blue-100 px-2 py-1 rounded",children:[x.day," ",x.startTime,"-",x.endTime,x.location&&` | ${x.location}`]},p))})]}),a.prerequisites&&e.jsxs("div",{className:"text-xs text-blue-600 mt-2",children:[e.jsx("strong",{children:"דרישות קדם:"})," ",a.prerequisites]})]})]}):null})()})]})]})})]}),e.jsxs("div",{className:"flex items-center justify-end gap-3 pt-6",children:[e.jsx("button",{type:"button",onClick:o,className:"px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors",children:"ביטול"}),e.jsx("button",{type:"submit",disabled:j,className:"px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-2",children:j?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"שומר..."]}):e.jsxs(e.Fragment,{children:[e.jsx(We,{className:"w-4 h-4"}),c?"עדכן תלמיד":"הוסף תלמיד"]})})]})]})},Fe=["אולם ערן","סטודיו קאמרי 1","סטודיו קאמרי 2","אולפן הקלטות","חדר חזרות 1","חדר חזרות 2","חדר מחשבים","חדר 1","חדר 2","חדר חזרות","חדר 5","חדר 6","חדר 7","חדר 8","חדר 9","חדר 10","חדר 11","חדר 12","חדר 13","חדר 14","חדר 15","חדר 16","חדר 17","חדר 18","חדר 19","חדר 20","חדר 21","חדר 22","חדר 23","חדר 24","חדר 25","חדר 26","חדר תאוריה א","חדר תאוריה ב"],ws=["מורה","מנצח","מדריך הרכב","מנהל","מורה תאוריה","מגמה"],Ts=["ראשון","שני","שלישי","רביעי","חמישי","שישי"],Is=["חלילית","חליל צד","אבוב","בסון","סקסופון","קלרינט","חצוצרה","קרן יער","טרומבון","טובה/בריטון","שירה","כינור","ויולה","צ'לו","קונטרבס","פסנתר","גיטרה","אורגן","חרמוניקה","מנדולינה","כינור בארוק","ויולה דה גמבה","פלוטה רקורדר","אוקרינה","חליל פאן","דולצימר","אוטו-הרפ","פסנתר אלקטרוני","גיטרה בס","גיטרה אקוסטית","גיטרה קלאסית","בנג׳ו","חליל אירי","כינור קלטי","בודהראן"],Me=(t,r)=>{if(!t||!r)return 0;const[o,c]=t.split(":").map(Number),[i,n]=r.split(":").map(Number),l=o*60+c,f=i*60+n;return f<=l?0:f-l},nt=(t,r)=>{if(!t||!r)return null;const o=Me(t,r);return o<=0?"שעת הסיום חייבת להיות אחרי שעת ההתחלה":o<30?"יום לימוד חייב להיות לפחות 30 דקות":o>480?"יום לימוד לא יכול להיות יותר מ-8 שעות":null},Ss=({isOpen:t,onClose:r,onTeacherAdded:o})=>{const{currentSchoolYear:c}=Nt(),[i,n]=u.useState("personal"),[l,f]=u.useState({personalInfo:{fullName:"",phone:"",email:"",address:""},roles:[],professionalInfo:{instrument:"",isActive:!0},teaching:{schedule:[]},conducting:{orchestraIds:[]},ensemblesIds:[]}),[j,m]=u.useState([]),[h,T]=u.useState([]),[A,I]=u.useState(!1),[E,L]=u.useState({}),[P,V]=u.useState("");u.useEffect(()=>{t&&g()},[t]);const g=async()=>{try{const[s,d]=await Promise.all([z.orchestras.getOrchestras(),z.orchestras.getOrchestras({type:"ensemble"})]);m(s||[]),T(d||[])}catch(s){console.error("Failed to load orchestras/ensembles:",s)}},v=()=>{const s={};return l.personalInfo.fullName.trim()||(s["personalInfo.fullName"]="שם מלא נדרש"),l.personalInfo.phone.match(/^05\d{8}$/)||(s["personalInfo.phone"]="מספר טלפון חייב להיות בפורמט: 05XXXXXXXX"),l.personalInfo.email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)||(s["personalInfo.email"]="כתובת אימייל לא תקינה"),l.personalInfo.address.trim()||(s["personalInfo.address"]="כתובת נדרשת"),l.roles.length===0&&(s.roles="יש לבחור לפחות תפקיד אחד"),(l.roles.includes("מורה")||l.roles.includes("מגמה")||!l.roles.includes("מורה תאוריה"))&&!l.professionalInfo.instrument&&(s["professionalInfo.instrument"]="יש לבחור כלי נגינה"),l.teaching.schedule.forEach((b,D)=>{if(b.startTime||(s[`schedule.${D}.startTime`]="שעת התחלה נדרשת"),b.endTime||(s[`schedule.${D}.endTime`]="שעת סיום נדרשת"),b.location?Fe.includes(b.location)||(s[`schedule.${D}.location`]="מיקום לא תקין"):s[`schedule.${D}.location`]="יש לבחור מיקום",b.startTime&&b.endTime){const W=nt(b.startTime,b.endTime);W&&(s[`schedule.${D}.timeRange`]=W)}}),L(s),Object.keys(s).length===0},y=(s,d,b)=>{f(W=>({...W,[s]:{...W[s],[d]:b}}));const D=`${s}.${d}`;E[D]&&L(W=>{const ee={...W};return delete ee[D],ee})},S=(s,d)=>{const b=d?[...l.roles,s]:l.roles.filter(D=>D!==s);f(D=>({...D,roles:b})),E.roles&&L(D=>{const W={...D};return delete W.roles,W})},C=()=>{const s={day:"ראשון",startTime:"14:00",endTime:"15:30",location:"",notes:""};f(d=>({...d,teaching:{...d.teaching,schedule:[...d.teaching.schedule,s]}}))},$=s=>{f(d=>({...d,teaching:{...d.teaching,schedule:d.teaching.schedule.filter((b,D)=>D!==s)}}))},N=(s,d,b)=>{f(D=>({...D,teaching:{...D.teaching,schedule:D.teaching.schedule.map((W,ee)=>ee===s?{...W,[d]:b}:W)}}))},R=async s=>{if(s.preventDefault(),!!v()){I(!0),V("");try{const d={personalInfo:l.personalInfo,roles:l.roles,professionalInfo:l.professionalInfo,teaching:{studentIds:[],schedule:l.teaching.schedule.map(D=>({day:D.day,startTime:D.startTime,endTime:D.endTime,duration:Me(D.startTime,D.endTime),location:D.location||null,notes:D.notes||null,isAvailable:!0,studentId:null,recurring:{isRecurring:!0,excludeDates:[]}}))},conducting:l.conducting,ensemblesIds:l.ensemblesIds,schoolYears:c?[{schoolYearId:c._id,isActive:!0}]:[],credentials:{email:l.personalInfo.email,password:null,isInvitationAccepted:!1},isActive:!0};console.log("🔄 Creating teacher:",d);const b=await z.teachers.addTeacher(d);console.log("✅ Teacher created successfully:",b),o(b),_(),r()}catch(d){console.error("❌ Failed to create teacher:",d),V(d.message||"שגיאה ביצירת המורה. נסה שוב.")}finally{I(!1)}}},_=()=>{f({personalInfo:{fullName:"",phone:"",email:"",address:""},roles:[],professionalInfo:{instrument:"",isActive:!0},teaching:{schedule:[]},conducting:{orchestraIds:[]},ensemblesIds:[]}),n("personal"),L({}),V("")},B=()=>{_(),r()};if(!t)return null;const K=[{id:"personal",label:"מידע אישי",icon:ie},{id:"professional",label:"מידע מקצועי",icon:Wt},{id:"schedule",label:"לוח זמנים",icon:te},{id:"conducting",label:"ניצוח",icon:ve}];return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[85vh] overflow-hidden border border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"הוספת מורה חדש"}),e.jsx("button",{onClick:B,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(de,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsx("nav",{className:"flex space-x-8 px-6",children:K.map(({id:s,label:d,icon:b})=>e.jsxs("button",{onClick:()=>n(s),className:`flex items-center gap-2 py-4 px-2 border-b-2 font-medium text-sm ${i===s?"border-primary-500 text-primary-600":"border-transparent text-gray-500 hover:text-gray-700"}`,children:[e.jsx(b,{className:"w-4 h-4"}),d]},s))})}),e.jsxs("form",{onSubmit:R,children:[e.jsxs("div",{className:"p-6 overflow-y-auto max-h-[60vh]",children:[i==="personal"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"שם מלא *"}),e.jsx("input",{type:"text",value:l.personalInfo.fullName,onChange:s=>y("personalInfo","fullName",s.target.value),className:`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 text-gray-900 placeholder-gray-500 bg-white ${E["personalInfo.fullName"]?"border-red-300 focus:ring-red-500":"border-gray-300 focus:ring-primary-500"}`,placeholder:"הכנס שם מלא"}),E["personalInfo.fullName"]&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:E["personalInfo.fullName"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"טלפון *"}),e.jsx("input",{type:"tel",value:l.personalInfo.phone,onChange:s=>y("personalInfo","phone",s.target.value),className:`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 text-gray-900 placeholder-gray-500 bg-white ${E["personalInfo.phone"]?"border-red-300 focus:ring-red-500":"border-gray-300 focus:ring-primary-500"}`,placeholder:"05XXXXXXXX"}),E["personalInfo.phone"]&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:E["personalInfo.phone"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"אימייל *"}),e.jsx("input",{type:"email",value:l.personalInfo.email,onChange:s=>y("personalInfo","email",s.target.value),className:`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 text-gray-900 placeholder-gray-500 bg-white ${E["personalInfo.email"]?"border-red-300 focus:ring-red-500":"border-gray-300 focus:ring-primary-500"}`,placeholder:"teacher@example.com"}),E["personalInfo.email"]&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:E["personalInfo.email"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"כתובת *"}),e.jsx("input",{type:"text",value:l.personalInfo.address,onChange:s=>y("personalInfo","address",s.target.value),className:`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 text-gray-900 placeholder-gray-500 bg-white ${E["personalInfo.address"]?"border-red-300 focus:ring-red-500":"border-gray-300 focus:ring-primary-500"}`,placeholder:"רחוב מספר, עיר"}),E["personalInfo.address"]&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:E["personalInfo.address"]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"תפקידים *"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-3",children:ws.map(s=>e.jsxs("label",{className:"flex items-center p-2 hover:bg-gray-50 rounded-lg cursor-pointer transition-colors",children:[e.jsx("input",{type:"checkbox",checked:l.roles.includes(s),onChange:d=>S(s,d.target.checked),className:"rounded border-gray-300 text-primary-600 focus:ring-primary-500 w-4 h-4"}),e.jsx("span",{className:"mr-3 text-sm text-gray-700 font-medium",children:s})]},s))}),E.roles&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:E.roles})]})]}),i==="professional"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["כלי נגינה ",!l.roles.includes("מורה תאוריה")&&"*"]}),e.jsxs("select",{value:l.professionalInfo.instrument,onChange:s=>y("professionalInfo","instrument",s.target.value),className:`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 text-gray-900 bg-white ${E["professionalInfo.instrument"]?"border-red-300 focus:ring-red-500":"border-gray-300 focus:ring-primary-500"}`,disabled:l.roles.includes("מורה תאוריה")&&l.roles.length===1,children:[e.jsx("option",{value:"",children:"בחר כלי נגינה"}),Is.map(s=>e.jsx("option",{value:s,children:s},s))]}),E["professionalInfo.instrument"]&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:E["professionalInfo.instrument"]})]}),e.jsx("div",{children:e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",checked:l.professionalInfo.isActive,onChange:s=>y("professionalInfo","isActive",s.target.checked),className:"rounded border-gray-300 text-primary-600 focus:ring-primary-500"}),e.jsx("span",{className:"ml-2 text-sm text-gray-700",children:"מורה פעיל"})]})})]}),i==="schedule"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"בלוקי זמן להוראה"}),e.jsxs("button",{type:"button",onClick:C,className:"flex items-center px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors",children:[e.jsx(ge,{className:"w-4 h-4 ml-2"}),"הוסף בלוק זמן"]})]}),l.teaching.schedule.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(te,{className:"w-12 h-12 mx-auto mb-4 text-gray-300"}),e.jsx("p",{children:"לא הוגדרו בלוקי זמן"}),e.jsx("p",{className:"text-sm",children:"הוסף בלוק זמן כדי לקבוע מתי המורה זמין להוראה"})]}):e.jsx("div",{className:"space-y-4",children:l.teaching.schedule.map((s,d)=>e.jsxs("div",{className:"border border-gray-200 rounded-lg p-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"יום"}),e.jsx("select",{value:s.day,onChange:b=>N(d,"day",b.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white",children:Ts.map(b=>e.jsx("option",{value:b,children:b},b))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"שעת התחלה"}),e.jsx("input",{type:"time",value:s.startTime,onChange:b=>N(d,"startTime",b.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"שעת סיום"}),e.jsx("input",{type:"time",value:s.endTime,onChange:b=>N(d,"endTime",b.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white"}),s.startTime&&s.endTime&&e.jsx("div",{className:"mt-1 text-xs",children:(()=>{const b=Me(s.startTime,s.endTime),D=nt(s.startTime,s.endTime);return D?e.jsx("span",{className:"text-red-600",children:D}):b>0?e.jsxs("span",{className:"text-gray-500",children:["משך: ",b," דקות"]}):null})()})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"מיקום"}),e.jsxs("select",{value:s.location,onChange:b=>N(d,"location",b.target.value),className:`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white ${E[`schedule.${d}.location`]?"border-red-300 focus:ring-red-500":"border-gray-300"}`,children:[e.jsx("option",{value:"",children:"בחר מיקום..."}),Fe.map(b=>e.jsx("option",{value:b,children:b},b))]}),E[`schedule.${d}.location`]&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:E[`schedule.${d}.location`]})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"הערות"}),e.jsx("input",{type:"text",value:s.notes,onChange:b=>N(d,"notes",b.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 placeholder-gray-500 bg-white",placeholder:"הערות נוספות"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsxs("button",{type:"button",onClick:()=>$(d),className:"flex items-center px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors",children:[e.jsx(Ue,{className:"w-4 h-4 ml-1"}),"הסר"]})})]},d))})]}),i==="conducting"&&e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl p-6 border border-purple-200",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center",children:e.jsx(ve,{className:"w-5 h-5 text-purple-600"})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-lg font-semibold text-gray-900",children:"תזמורות לניצוח"}),e.jsx("p",{className:"text-sm text-gray-600",children:"בחר את התזמורות שהמורה ינצח"})]})]}),e.jsx("div",{className:"grid grid-cols-1 gap-3 max-h-64 overflow-y-auto",children:j.map(s=>e.jsxs("label",{className:"flex items-center p-4 bg-white border-2 border-gray-200 rounded-xl hover:border-purple-300 hover:shadow-md transition-all duration-200 cursor-pointer group",children:[e.jsx("input",{type:"checkbox",checked:l.conducting.orchestraIds.includes(s._id),onChange:d=>{const b=d.target.checked?[...l.conducting.orchestraIds,s._id]:l.conducting.orchestraIds.filter(D=>D!==s._id);y("conducting","orchestraIds",b)},className:"rounded-lg border-gray-300 text-purple-600 focus:ring-purple-500 w-5 h-5"}),e.jsxs("div",{className:"mr-4 flex-1",children:[e.jsx("div",{className:"text-base font-semibold text-gray-900 group-hover:text-purple-700 transition-colors",children:s.name}),e.jsx("div",{className:"text-sm text-gray-500 mt-1",children:s.description||"תזמורת ללא תיאור"}),s.memberCount&&e.jsxs("div",{className:"text-xs text-purple-600 mt-1",children:["👥 ",s.memberCount," חברים"]})]})]},s._id))})]}),e.jsxs("div",{className:"bg-gradient-to-r from-green-50 to-teal-50 rounded-xl p-6 border border-green-200",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-10 h-10 bg-green-100 rounded-full flex items-center justify-center",children:e.jsx(ie,{className:"w-5 h-5 text-green-600"})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-lg font-semibold text-gray-900",children:"אנסמבלים להדרכה"}),e.jsx("p",{className:"text-sm text-gray-600",children:"בחר את האנסמבלים שהמורה ידריך"})]})]}),e.jsx("div",{className:"grid grid-cols-1 gap-3 max-h-64 overflow-y-auto",children:h.map(s=>e.jsxs("label",{className:"flex items-center p-4 bg-white border-2 border-gray-200 rounded-xl hover:border-green-300 hover:shadow-md transition-all duration-200 cursor-pointer group",children:[e.jsx("input",{type:"checkbox",checked:l.ensemblesIds.includes(s._id),onChange:d=>{const b=d.target.checked?[...l.ensemblesIds,s._id]:l.ensemblesIds.filter(D=>D!==s._id);f(D=>({...D,ensemblesIds:b}))},className:"rounded-lg border-gray-300 text-green-600 focus:ring-green-500 w-5 h-5"}),e.jsxs("div",{className:"mr-4 flex-1",children:[e.jsx("div",{className:"text-base font-semibold text-gray-900 group-hover:text-green-700 transition-colors",children:s.name}),e.jsx("div",{className:"text-sm text-gray-500 mt-1",children:s.description||"אנסמבל ללא תיאור"}),s.memberCount&&e.jsxs("div",{className:"text-xs text-green-600 mt-1",children:["🎵 ",s.memberCount," חברים"]})]})]},s._id))})]})]})]}),e.jsxs("div",{className:"px-6 py-4 border-t border-gray-200",children:[P&&e.jsxs("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg flex items-start gap-2",children:[e.jsx(Ye,{className:"w-5 h-5 text-red-500 flex-shrink-0 mt-0.5"}),e.jsx("span",{className:"text-sm text-red-700",children:P})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{type:"button",onClick:B,className:"px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors",disabled:A,children:"ביטול"}),e.jsxs("button",{type:"submit",disabled:A,className:"flex items-center px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[A?e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin ml-2"}):e.jsx(We,{className:"w-4 h-4 ml-2"}),A?"שומר...":"שמור מורה"]})]})]})]})]})})};function Ds({theoryLesson:t,theoryLessons:r,teachers:o,onSubmit:c,onCancel:i,mode:n="create"}){const[l,f]=u.useState("single"),[j,m]=u.useState({category:"מגמה",teacherId:"",date:"",dayOfWeek:0,startTime:"14:00",endTime:"15:00",location:"אולם ערן",studentIds:[],attendance:{present:[],absent:[]},notes:"",syllabus:"",homework:"",schoolYearId:""}),[h,T]=u.useState({category:"מגמה",teacherId:"",startDate:"",endDate:"",dayOfWeek:0,startTime:"14:00",endTime:"15:00",location:"אולם ערן",studentIds:[],notes:"",syllabus:"",excludeDates:[],schoolYearId:""}),[A,I]=u.useState(o||[]),[E,L]=u.useState(!1),[P,V]=u.useState(!1),[g,v]=u.useState(""),[y,S]=u.useState(""),C=["תלמידים חדשים ב-ד","מתחילים","מתחילים ב","מתחילים ד","מתקדמים ב","מתקדמים א","מתקדמים ג","תלמידים חדשים בוגרים (ה - ט)","תלמידים חדשים צעירים","הכנה לרסיטל קלאסי יא","הכנה לרסיטל רוק\\פופ\\ג'אז יא","הכנה לרסיטל רוק\\פופ\\ג'אז יב","מגמה","תאוריה כלי"],$={0:"ראשון",1:"שני",2:"שלישי",3:"רביעי",4:"חמישי",5:"שישי",6:"שבת"};u.useEffect(()=>{o||N(),R()},[o]),u.useEffect(()=>{if(n==="edit"&&t){const s=new Date(t.date);m({category:t.category||"מגמה",teacherId:t.teacherId||"",date:t.date?new Date(t.date).toISOString().split("T")[0]:"",dayOfWeek:t.dayOfWeek!==void 0?t.dayOfWeek:s.getDay(),startTime:t.startTime||"14:00",endTime:t.endTime||"15:00",location:t.location||"אולם ערן",studentIds:t.studentIds||[],attendance:t.attendance||{present:[],absent:[]},notes:t.notes||"",syllabus:t.syllabus||"",homework:t.homework||"",schoolYearId:t.schoolYearId||""}),T(d=>({...d,category:t.category||"מגמה",teacherId:t.teacherId||"",location:t.location||"אולם ערן",startTime:t.startTime||"14:00",endTime:t.endTime||"15:00",notes:t.notes||"",syllabus:t.syllabus||"",schoolYearId:t.schoolYearId||""}))}else if(n==="bulk-edit"&&r&&r.length>0){const s=r[0],d=r.every(J=>J.category===s.category)?s.category:"",b=r.every(J=>J.teacherId===s.teacherId)?s.teacherId:"",D=r.every(J=>J.location===s.location)?s.location:"",W=r.every(J=>J.startTime===s.startTime)?s.startTime:"",ee=r.every(J=>J.endTime===s.endTime)?s.endTime:"",ue=r.every(J=>J.notes===s.notes)?s.notes:"",me=r.every(J=>J.syllabus===s.syllabus)?s.syllabus:"";T({category:d||"מגמה",teacherId:b||"",startDate:"",endDate:"",dayOfWeek:0,startTime:W||"14:00",endTime:ee||"15:00",location:D||"אולם ערן",studentIds:[],notes:ue||"",syllabus:me||"",excludeDates:[],schoolYearId:s.schoolYearId||""})}},[t,r,n]);const N=async()=>{try{const d=(await Ft.getTeachers()).filter(b=>b.roles&&b.roles.includes("מורה תאוריה"));I(d)}catch(s){console.error("Error loading teachers:",s)}},R=async()=>{try{const s=await Mt.getCurrentSchoolYear();s&&(j.schoolYearId||m(d=>({...d,schoolYearId:s._id})),h.schoolYearId||T(d=>({...d,schoolYearId:s._id})))}catch(s){console.error("Error loading current school year:",s)}},_=(s,d)=>{if(n==="edit"||n==="create"&&l==="single"){if(m(b=>({...b,[s]:d})),s==="date"&&d){const D=new Date(d).getDay();m(W=>({...W,date:d,dayOfWeek:D}))}}else T(b=>({...b,[s]:d}))},B=()=>{if(l==="single"){if(!j.category.trim())return v("יש לבחור קטגוריה לשיעור"),!1;if(!j.teacherId)return v("יש לבחור מורה לשיעור"),!1;if(!j.date)return v("יש לבחור תאריך לשיעור"),!1;if(!j.startTime||!j.endTime)return v("יש להזין שעות התחלה וסיום"),!1;if(!j.location.trim())return v("יש להזין מיקום לשיעור"),!1;const s=j.startTime.split(":").map(Number),d=j.endTime.split(":").map(Number),b=s[0]*60+s[1];if(d[0]*60+d[1]<=b)return v("שעת הסיום חייבת להיות אחרי שעת ההתחלה"),!1}else{if(!h.category.trim())return v("יש לבחור קטגוריה לשיעורים"),!1;if(!h.teacherId)return v("יש לבחור מורה לשיעורים"),!1;if(!h.startDate||!h.endDate)return v("יש לבחור תאריכי התחלה וסיום"),!1;if(!h.startTime||!h.endTime)return v("יש להזין שעות התחלה וסיום"),!1;if(!h.location.trim())return v("יש להזין מיקום לשיעורים"),!1;if(h.dayOfWeek<0||h.dayOfWeek>6)return v("יש לבחור יום בשבוע"),!1;if(!h.schoolYearId)return v("יש לבחור שנת לימודים"),!1;if(new Date(h.endDate)<=new Date(h.startDate))return v("תאריך הסיום חייב להיות אחרי תאריך ההתחלה"),!1;const s=h.startTime.split(":").map(Number),d=h.endTime.split(":").map(Number),b=s[0]*60+s[1];if(d[0]*60+d[1]<=b)return v("שעת הסיום חייבת להיות אחרי שעת ההתחלה"),!1}return!0},K=async s=>{if(s.preventDefault(),v(""),S(""),!!B()){L(!0);try{if(n==="edit"){const d={...j,date:new Date(j.date+"T"+j.startTime+":00.000Z").toISOString(),mode:"edit",lessonId:t?._id};await c(d),S("שיעור התיאוריה עודכן בהצלחה")}else if(n==="bulk-edit"){const d={};h.category&&h.category.trim()&&(d.category=h.category),h.teacherId&&h.teacherId.trim()&&(d.teacherId=h.teacherId),h.location&&h.location.trim()&&(d.location=h.location),h.startTime&&h.startTime.trim()&&(d.startTime=h.startTime),h.endTime&&h.endTime.trim()&&(d.endTime=h.endTime),h.notes&&h.notes.trim()&&(d.notes=h.notes),h.syllabus&&h.syllabus.trim()&&(d.syllabus=h.syllabus);const b={mode:"bulk-edit",lessonIds:r?.map(D=>D._id)||[],updateData:d};await c(b),S(`${r?.length||0} שיעורי תיאוריה עודכנו בהצלחה`)}else if(l==="single"){const d={...j,date:new Date(j.date+"T"+j.startTime+":00.000Z").toISOString(),mode:"create"};await c(d),S("שיעור התיאוריה נוצר בהצלחה")}else{const d={...h,isBulk:!0,mode:"bulk-create"};console.log("🚀 Bulk theory lesson creation data:",JSON.stringify(d,null,2));const D=["category","teacherId","startDate","endDate","dayOfWeek","startTime","endTime","location","schoolYearId"].filter(W=>{const ee=d[W];return ee==null||typeof ee=="string"&&ee.trim()===""});if(D.length>0){console.error("❌ Missing required fields:",D),v(`חסרים שדות חובה: ${D.join(", ")}`);return}await c(d),S("רצף שיעורי התיאוריה נוצר בהצלחה")}}catch(d){console.error("Error submitting theory lesson form:",d),v(d.message||"שגיאה בשמירת השיעור")}finally{L(!1)}}};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:n==="edit"?"עריכת שיעור תיאוריה":n==="bulk-edit"?"עריכה קבוצתית של שיעורי תיאוריה":"שיעור תיאוריה חדש"}),e.jsx("button",{onClick:i,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(de,{className:"w-5 h-5 text-gray-500"})})]}),n==="create"&&e.jsxs("div",{className:"flex space-x-4 rtl:space-x-reverse",children:[e.jsxs("button",{type:"button",onClick:()=>f("single"),className:`flex items-center px-4 py-2 rounded-lg font-medium transition-colors ${l==="single"?"bg-primary-100 text-primary-700":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,children:[e.jsx(te,{className:"w-4 h-4 ml-2"}),"שיעור בודד"]}),e.jsxs("button",{type:"button",onClick:()=>f("bulk"),className:`flex items-center px-4 py-2 rounded-lg font-medium transition-colors ${l==="bulk"?"bg-primary-100 text-primary-700":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,children:[e.jsx(Ht,{className:"w-4 h-4 ml-2"}),"רצף שיעורים"]})]}),n==="bulk-edit"&&r&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(le,{className:"w-5 h-5 text-blue-600 ml-2"}),e.jsxs("p",{className:"text-blue-800",children:["עריכה קבוצתית של ",r.length," שיעורי תיאוריה"]})]}),e.jsx("p",{className:"text-blue-600 text-sm mt-1",children:"שדות ריקים יישארו ללא שינוי, רק שדות שימולאו יעודכנו"})]})]}),e.jsxs("form",{onSubmit:K,className:"p-6 space-y-6",children:[P&&e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 ml-2"}),e.jsx("p",{className:"text-blue-800 text-sm",children:"טוען נתוני שיעור..."})]})}),y&&e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:e.jsx("p",{className:"text-green-800 text-sm",children:y})}),g&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("p",{className:"text-red-800 text-sm",children:g})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[e.jsx(Ne,{className:"w-4 h-4 inline ml-1"}),"קטגוריה *"]}),e.jsxs("select",{value:n==="edit"||n==="create"&&l==="single"?j.category:h.category,onChange:s=>_("category",s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900",required:n!=="bulk-edit",children:[n==="bulk-edit"&&e.jsx("option",{value:"",children:"השאר ללא שינוי"}),C.map(s=>e.jsx("option",{value:s,children:s},s))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"מורה *"}),e.jsxs("select",{value:n==="edit"||n==="create"&&l==="single"?j.teacherId:h.teacherId,onChange:s=>_("teacherId",s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900",required:n!=="bulk-edit",children:[e.jsx("option",{value:"",children:n==="bulk-edit"?"השאר ללא שינוי":"בחר מורה"}),A.map(s=>e.jsx("option",{value:s._id,children:s.personalInfo?.fullName},s._id))]})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[e.jsx(je,{className:"w-4 h-4 inline ml-1"}),"מיקום *"]}),e.jsxs("select",{value:n==="edit"||n==="create"&&l==="single"?j.location:h.location,onChange:s=>_("location",s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900",required:n!=="bulk-edit",children:[n==="bulk-edit"&&e.jsx("option",{value:"",children:"השאר ללא שינוי"}),Fe.map(s=>e.jsx("option",{value:s,children:s},s))]})]}),n==="edit"||n==="create"&&l==="single"?e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"תאריך *"}),e.jsx("input",{type:"date",value:j.date,onChange:s=>_("date",s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"יום בשבוע"}),e.jsx("input",{type:"text",value:$[j.dayOfWeek]||"",className:"w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-700",disabled:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[e.jsx(ne,{className:"w-4 h-4 inline ml-1"}),"שעת התחלה *"]}),e.jsx("input",{type:"time",value:j.startTime,onChange:s=>_("startTime",s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"שעת סיום *"}),e.jsx("input",{type:"time",value:j.endTime,onChange:s=>_("endTime",s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900",required:!0})]})]}):n==="bulk-edit"?e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[e.jsx(ne,{className:"w-4 h-4 inline ml-1"}),"שעת התחלה"]}),e.jsx("input",{type:"time",value:h.startTime,onChange:s=>_("startTime",s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900",placeholder:"השאר ללא שינוי"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"שעת סיום"}),e.jsx("input",{type:"time",value:h.endTime,onChange:s=>_("endTime",s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900",placeholder:"השאר ללא שינוי"})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"תאריך התחלה *"}),e.jsx("input",{type:"date",value:h.startDate,onChange:s=>_("startDate",s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"תאריך סיום *"}),e.jsx("input",{type:"date",value:h.endDate,onChange:s=>_("endDate",s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"יום בשבוע *"}),e.jsx("select",{value:h.dayOfWeek,onChange:s=>_("dayOfWeek",parseInt(s.target.value)),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900",required:!0,children:Object.entries($).map(([s,d])=>e.jsx("option",{value:s,children:d},s))})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[e.jsx(ne,{className:"w-4 h-4 inline ml-1"}),"שעת התחלה *"]}),e.jsx("input",{type:"time",value:h.startTime,onChange:s=>_("startTime",s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"שעת סיום *"}),e.jsx("input",{type:"time",value:h.endTime,onChange:s=>_("endTime",s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900",required:!0})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"סילבוס"}),e.jsx("textarea",{value:n==="edit"||n==="create"&&l==="single"?j.syllabus:h.syllabus,onChange:s=>_("syllabus",s.target.value),rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900",placeholder:n==="bulk-edit"?"השאר ללא שינוי - נושאי השיעור...":n==="edit"||l==="single"?"נושאי השיעור...":"נושאי השיעורים..."})]}),n==="edit"||n==="create"&&l==="single"?e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"שיעורי בית"}),e.jsx("textarea",{value:j.homework,onChange:s=>_("homework",s.target.value),rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900",placeholder:"משימות לבית..."})]}):null,e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"הערות"}),e.jsx("textarea",{value:n==="edit"||n==="create"&&l==="single"?j.notes:h.notes,onChange:s=>_("notes",s.target.value),rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900",placeholder:n==="bulk-edit"?"השאר ללא שינוי - הערות כלליות...":"הערות כלליות..."})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-6 border-t border-gray-200",children:[e.jsx("button",{type:"button",onClick:i,className:"px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors",disabled:E,children:"ביטול"}),e.jsxs("button",{type:"submit",disabled:E,className:"flex items-center px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors disabled:opacity-50",children:[E?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white ml-2"}):e.jsx(We,{className:"w-4 h-4 ml-2"}),n==="edit"?"עדכן שיעור":n==="bulk-edit"?"עדכן שיעורים":l==="single"?"צור שיעור":"צור רצף שיעורים"]})]})]})]})})}const It={0:"ראשון",1:"שני",2:"שלישי",3:"רביעי",4:"חמישי",5:"שישי",6:"שבת"},Cs=Object.entries(It).map(([t,r])=>({value:parseInt(t),label:r})),ze=t=>It[t]||"לא ידוע",ks=t=>{const r=new Date(t.date).toLocaleDateString("he-IL"),o=`${t.startTime} - ${t.endTime}`,c=ze(t.dayOfWeek),i=`${c}, ${r} ${o}`;return{date:r,time:o,dayName:c,fullDateTime:i}},Ce=(t,r)=>{const o=oe(t);return oe(r)-o},oe=t=>{const[r,o]=t.split(":").map(Number);return r*60+o},lt=t=>{const r=t.attendance?.present?.length||0,o=t.attendance?.absent?.length||0,c=t.orchestra?.memberIds?.length||r+o,i=c>0?Math.round(r/c*100):0;return{presentCount:r,absentCount:o,totalMembers:c,attendanceRate:i,hasAttendanceData:r>0||o>0}},Es=t=>{if(!t.isActive)return{status:"cancelled",text:"בוטלה",colorClass:"bg-gray-100 text-gray-800"};const r=new Date;new Date(t.date);const o=new Date(`${t.date}T${t.startTime}:00`),c=new Date(`${t.date}T${t.endTime}:00`);return r<o?{status:"upcoming",text:"עתידה",colorClass:"bg-blue-100 text-blue-800"}:r>=o&&r<=c?{status:"in_progress",text:"מתקיימת כעת",colorClass:"bg-green-100 text-green-800"}:{status:"completed",text:"הסתיימה",colorClass:"bg-orange-100 text-orange-800"}},ot=(t,r)=>{if(t.date!==r.date)return{hasConflict:!1,conflictType:"none",severity:"none",message:""};if(t.groupId===r.groupId)return{hasConflict:!1,conflictType:"none",severity:"none",message:"אותה תזמורת"};const o=oe(t.startTime),c=oe(t.endTime),i=oe(r.startTime),n=oe(r.endTime);if(o<n&&i<c){if(t.location===r.location)return{hasConflict:!0,conflictType:"location",severity:"critical",message:`חפיפה במיקום: ${t.location}`};const f=t.orchestra?.conductor?._id,j=r.orchestra?.conductor?._id;if(f&&j&&f===j)return{hasConflict:!0,conflictType:"conductor",severity:"critical",message:"אותו מנצח בשני מקומות"};const m=new Set(t.orchestra?.memberIds||[]),h=new Set(r.orchestra?.memberIds||[]),T=[...m].filter(A=>h.has(A));return T.length>0?{hasConflict:!0,conflictType:"members",severity:"warning",message:`${T.length} חברים משותפים`}:{hasConflict:!0,conflictType:"time",severity:"warning",message:"חפיפת זמנים"}}return{hasConflict:!1,conflictType:"none",severity:"none",message:""}},yr=(t,r)=>t.filter(o=>{if(r.searchQuery){const c=r.searchQuery.toLowerCase();if(!(o.orchestra?.name?.toLowerCase().includes(c)||o.location?.toLowerCase().includes(c)||o.notes?.toLowerCase().includes(c)||ze(o.dayOfWeek).toLowerCase().includes(c)))return!1}if(r.orchestraId&&o.groupId!==r.orchestraId||r.type&&o.type!==r.type||r.dayOfWeek!==""&&r.dayOfWeek!==void 0&&o.dayOfWeek!==r.dayOfWeek||r.location&&o.location!==r.location)return!1;if(r.startDate){const c=new Date(o.date),i=new Date(r.startDate);if(c<i)return!1}if(r.endDate){const c=new Date(o.date),i=new Date(r.endDate);if(c>i)return!1}return!(r.status&&r.status!=="all"&&Es(o).status!==r.status||r.isActive!==void 0&&o.isActive!==r.isActive)}),br=(t,r="date",o="asc")=>[...t].sort((i,n)=>{let l=0;switch(r){case"date":l=new Date(i.date).getTime()-new Date(n.date).getTime();break;case"time":l=oe(i.startTime)-oe(n.startTime);break;case"orchestra":const f=i.orchestra?.name||"",j=n.orchestra?.name||"";l=f.localeCompare(j,"he");break;case"location":l=i.location.localeCompare(n.location,"he");break;case"attendance":const m=lt(i).attendanceRate,h=lt(n).attendanceRate;l=m-h;break;case"duration":const T=Ce(i.startTime,i.endTime),A=Ce(n.startTime,n.endTime);l=T-A;break;default:l=0}return o==="desc"?-l:l}),_s=t=>{const r=[],o=new Date(t.startDate),c=new Date(t.endDate),i=t.dayOfWeek,n=new Set(t.excludeDates||[]),l=new Date(o);for(;l.getDay()!==i&&l<=c;)l.setDate(l.getDate()+1);for(;l<=c;){const f=l.toISOString().split("T")[0];n.has(f)||r.push(f),l.setDate(l.getDate()+7)}return r},As=t=>{const r={};if(t.groupId?.trim()||(r.groupId="יש לבחור תזמורת"),t.type||(r.type="יש לבחור סוג הרכב"),!t.date)r.date="יש לבחור תאריך";else{const o=new Date(t.date),c=new Date;c.setHours(0,0,0,0),o<c&&(r.date="לא ניתן לקבוע חזרה בעבר")}if(t.startTime||(r.startTime="יש להזין שעת התחלה"),t.endTime||(r.endTime="יש להזין שעת סיום"),t.startTime&&t.endTime){const o=Ce(t.startTime,t.endTime);o<=0?r.endTime="שעת הסיום חייבת להיות אחרי שעת ההתחלה":o>300&&(r.endTime="משך החזרה לא יכול להיות יותר מ-5 שעות")}return t.location?.trim()||(r.location="יש לבחור מיקום"),{isValid:Object.keys(r).length===0,errors:r}},Os=t=>{const r={};if(t.orchestraId?.trim()||(r.orchestraId="יש לבחור תזמורת"),t.startDate||(r.startDate="יש לבחור תאריך התחלה"),t.endDate||(r.endDate="יש לבחור תאריך סיום"),t.startDate&&t.endDate){const o=new Date(t.startDate),c=new Date(t.endDate);o>=c&&(r.endDate="תאריך הסיום חייב להיות אחרי תאריך ההתחלה"),(c.getTime()-o.getTime())/(1e3*60*60*24)>365&&(r.endDate="תקופה לא יכולה להיות יותר משנה")}return(t.dayOfWeek===void 0||t.dayOfWeek<0||t.dayOfWeek>6)&&(r.dayOfWeek="יש לבחור יום בשבוע"),t.startTime||(r.startTime="יש להזין שעת התחלה"),t.endTime||(r.endTime="יש להזין שעת סיום"),t.startTime&&t.endTime&&Ce(t.startTime,t.endTime)<=0&&(r.endTime="שעת הסיום חייבת להיות אחרי שעת ההתחלה"),t.location?.trim()||(r.location="יש לבחור מיקום"),{isValid:Object.keys(r).length===0,errors:r}},jr=t=>{switch(t.orchestra?.type||t.type){case"תזמורת":return"bg-blue-500";case"הרכב":return"bg-pink-500";default:return"bg-gray-500"}};function Rs({newRehearsal:t,bulkData:r,existingRehearsals:o,orchestras:c,onConflictsChanged:i}){const[n,l]=u.useState([]),[f,j]=u.useState(!1);u.useEffect(()=>{t||r?m():l([])},[t,r,o]),u.useEffect(()=>{i?.(n)},[n,i]);const m=async()=>{j(!0);try{let g=[];t?g=await h(t):r&&(g=await T(r)),l(g)}catch(g){console.error("Error detecting conflicts:",g)}finally{j(!1)}},h=async g=>{const v=[],y={_id:"temp",groupId:g.groupId,type:g.type,date:g.date,dayOfWeek:new Date(g.date).getDay(),startTime:g.startTime,endTime:g.endTime,location:g.location,attendance:{present:[],absent:[]},notes:g.notes||"",schoolYearId:"current",isActive:g.isActive,orchestra:c.find(S=>S._id===g.groupId)};for(const S of o){if(S.groupId===g.groupId&&S.date===g.date)continue;const C=ot(y,S);C.hasConflict&&v.push({...C,conflictingRehearsal:S,affectedDate:g.date})}return v},T=async g=>{const v=[],y=A(g),S=c.find(C=>C._id===g.orchestraId);for(const C of y){const $={_id:"temp",groupId:g.orchestraId,type:S?.type||"תזמורת",date:C,dayOfWeek:new Date(C).getDay(),startTime:g.startTime,endTime:g.endTime,location:g.location,attendance:{present:[],absent:[]},notes:g.notes||"",schoolYearId:g.schoolYearId,isActive:!0,orchestra:S};for(const N of o){if(N.groupId===g.orchestraId&&N.date===C)continue;const R=ot($,N);R.hasConflict&&v.push({...R,conflictingRehearsal:N,affectedDate:C})}}return v},A=g=>{const v=[],y=new Date(g.startDate),S=new Date(g.endDate),C=g.dayOfWeek,$=new Set(g.excludeDates||[]),N=new Date(y);for(;N.getDay()!==C&&N<=S;)N.setDate(N.getDate()+1);for(;N<=S;){const R=N.toISOString().split("T")[0];$.has(R)||v.push(R),N.setDate(N.getDate()+7)}return v},I=g=>{switch(g){case"critical":return e.jsx(Je,{className:"w-5 h-5 text-red-600"});case"warning":return e.jsx(Ze,{className:"w-5 h-5 text-yellow-600"});default:return e.jsx(De,{className:"w-5 h-5 text-green-600"})}},E=g=>{switch(g){case"location":return e.jsx(je,{className:"w-4 h-4"});case"conductor":return e.jsx(ie,{className:"w-4 h-4"});case"members":return e.jsx(le,{className:"w-4 h-4"});case"time":return e.jsx(ne,{className:"w-4 h-4"});default:return e.jsx(De,{className:"w-4 h-4"})}},L=g=>{switch(g){case"critical":return"bg-red-50 border-red-200 text-red-800";case"warning":return"bg-yellow-50 border-yellow-200 text-yellow-800";default:return"bg-green-50 border-green-200 text-green-800"}},P=n.filter(g=>g.severity==="critical"),V=n.filter(g=>g.severity==="warning");return f?e.jsx("div",{className:"bg-gray-50 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-primary-600 ml-2"}),e.jsx("span",{className:"text-sm text-gray-600",children:"בודק התנגשויות..."})]})}):n.length===0&&(t||r)?e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(De,{className:"w-5 h-5 text-green-600 ml-2"}),e.jsx("span",{className:"text-sm text-green-800",children:"לא נמצאו התנגשויות - ניתן ליצור את החזרה"})]})}):n.length===0?null:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:"סיכום התנגשויות"}),e.jsxs("div",{className:"flex items-center gap-4 text-sm",children:[P.length>0&&e.jsxs("div",{className:"flex items-center text-red-600",children:[e.jsx(Je,{className:"w-4 h-4 ml-1"}),e.jsxs("span",{children:[P.length," קריטיות"]})]}),V.length>0&&e.jsxs("div",{className:"flex items-center text-yellow-600",children:[e.jsx(Ze,{className:"w-4 h-4 ml-1"}),e.jsxs("span",{children:[V.length," אזהרות"]})]})]})]}),P.length>0&&e.jsx("p",{className:"text-sm text-red-800",children:"נמצאו התנגשויות קריטיות שמונעות יצירת החזרה. יש לפתור אותן לפני המשך."}),V.length>0&&P.length===0&&e.jsx("p",{className:"text-sm text-yellow-800",children:"נמצאו אזהרות שכדאי לבדוק. ניתן להמשיך ביצירת החזרה אך מומלץ לוודא."})]}),e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:n.map((g,v)=>e.jsx("div",{className:`border rounded-lg p-3 ${L(g.severity)}`,children:e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{className:"flex items-start gap-2",children:[I(g.severity),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1 mb-1",children:[E(g.conflictType),e.jsx("span",{className:"font-medium text-sm",children:g.message})]}),g.conflictingRehearsal&&e.jsx("div",{className:"text-xs opacity-75",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("span",{children:g.conflictingRehearsal.orchestra?.name}),e.jsx("span",{children:ks(g.conflictingRehearsal).fullDateTime}),e.jsx("span",{children:g.conflictingRehearsal.location})]})}),g.affectedDate&&e.jsxs("div",{className:"text-xs opacity-75 mt-1",children:["תאריך מתנגש: ",new Date(g.affectedDate).toLocaleDateString("he-IL")]})]})]})})},v))}),P.length>0&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium text-red-900 mb-2",children:"פעולות מומלצות לפתרון:"}),e.jsxs("ul",{className:"text-sm text-red-800 space-y-1 list-disc list-inside",children:[P.some(g=>g.conflictType==="location")&&e.jsx("li",{children:"שנה את מיקום החזרה או בחר זמן אחר"}),P.some(g=>g.conflictType==="conductor")&&e.jsx("li",{children:"תאם עם המנצח או שנה את זמן החזרה"}),P.some(g=>g.conflictType==="time")&&e.jsx("li",{children:"בחר זמן אחר או תאריך אחר"})]})]})]})}function Ps({orchestras:t,existingRehearsals:r=[],onSubmit:o,onCancel:c,initialData:i}){const[n,l]=u.useState("single"),[f,j]=u.useState(!1),[m,h]=u.useState({}),[T,A]=u.useState({groupId:"",type:"תזמורת",date:"",startTime:"19:00",endTime:"21:00",location:"",notes:"",isActive:!0,...i}),[I,E]=u.useState({orchestraId:"",startDate:"",endDate:"",dayOfWeek:0,startTime:"19:00",endTime:"21:00",location:"",notes:"",excludeDates:[],schoolYearId:"current"}),[L,P]=u.useState(""),[V,g]=u.useState([]),[v,y]=u.useState(!1),[S,C]=u.useState(!1);u.useEffect(()=>{if(n==="single"&&T.groupId){const s=t.find(d=>d._id===T.groupId);s&&!T.location&&A(d=>({...d,location:s.location,type:s.type}))}},[T.groupId,t,n]),u.useEffect(()=>{if(n==="bulk"&&I.orchestraId){const s=t.find(d=>d._id===I.orchestraId);s&&!I.location&&E(d=>({...d,location:s.location}))}},[I.orchestraId,t,n]),u.useEffect(()=>{if(n==="bulk"&&I.startDate&&I.endDate&&I.dayOfWeek!==void 0)try{const s=_s(I);g(s)}catch{g([])}else g([])},[n,I.startDate,I.endDate,I.dayOfWeek,I.excludeDates]);const $=(s,d)=>{A(b=>({...b,[s]:d})),m[s]&&h(b=>({...b,[s]:""}))},N=(s,d)=>{E(b=>({...b,[s]:d})),m[s]&&h(b=>({...b,[s]:""}))},R=()=>{L&&(E(s=>({...s,excludeDates:[...s.excludeDates||[],L]})),P(""))},_=s=>{E(d=>({...d,excludeDates:(d.excludeDates||[]).filter(b=>b!==s)}))},B=s=>{y(s.length>0),C(s.some(d=>d.severity==="critical"))},K=async s=>{s.preventDefault(),j(!0),h({});try{if(S){h({submit:"יש לפתור התנגשויות קריטיות לפני יצירת החזרה"});return}if(n==="single"){const d=As(T);if(!d.isValid){h(d.errors);return}const D=new Date(T.date).getDay(),W={...T,dayOfWeek:D};await o(W,!1)}else{const d=Os(I);if(!d.isValid){h(d.errors);return}await o(I,!0)}}catch(d){h({submit:d.message||"שגיאה בשמירת החזרה"})}finally{j(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",onClick:c,children:e.jsx("div",{className:"bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto transform transition-all",onClick:s=>s.stopPropagation(),children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("button",{onClick:c,className:"p-2 text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(de,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex-1 text-center",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:i?"ערוך חזרה":"חזרה חדשה"}),!i&&e.jsx("div",{className:"flex justify-center mt-3",children:e.jsxs("div",{className:"flex bg-gray-100 rounded-lg p-1",children:[e.jsx("button",{type:"button",onClick:()=>l("single"),className:`px-4 py-2 text-sm font-medium rounded-md transition-colors ${n==="single"?"bg-white text-gray-900 shadow-sm":"text-gray-500 hover:text-gray-700"}`,children:"חזרה יחידה"}),e.jsx("button",{type:"button",onClick:()=>l("bulk"),className:`px-4 py-2 text-sm font-medium rounded-md transition-colors ${n==="bulk"?"bg-white text-gray-900 shadow-sm":"text-gray-500 hover:text-gray-700"}`,children:"חזרות חוזרות"})]})})]}),e.jsx("div",{className:"w-8"})]}),e.jsxs("form",{onSubmit:K,className:"space-y-6",children:[n==="single"?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[e.jsx(le,{className:"w-4 h-4 inline ml-1"}),"תזמורת"]}),e.jsxs("select",{value:T.groupId||"",onChange:s=>$("groupId",s.target.value),className:`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900 ${m.groupId?"border-red-300":"border-gray-300"}`,disabled:!!i,children:[e.jsx("option",{value:"",children:"בחר תזמורת"}),t.map(s=>e.jsxs("option",{value:s._id,children:[s.name," (",s.type,")"]},s._id))]}),m.groupId&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:m.groupId})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[e.jsx(te,{className:"w-4 h-4 inline ml-1"}),"תאריך"]}),e.jsx("input",{type:"date",value:T.date||"",onChange:s=>$("date",s.target.value),className:`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900 ${m.date?"border-red-300":"border-gray-300"}`}),m.date&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:m.date})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[e.jsx(ne,{className:"w-4 h-4 inline ml-1"}),"שעת התחלה"]}),e.jsx("input",{type:"time",value:T.startTime||"",onChange:s=>$("startTime",s.target.value),className:`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900 ${m.startTime?"border-red-300":"border-gray-300"}`}),m.startTime&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:m.startTime})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"שעת סיום"}),e.jsx("input",{type:"time",value:T.endTime||"",onChange:s=>$("endTime",s.target.value),className:`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900 ${m.endTime?"border-red-300":"border-gray-300"}`}),m.endTime&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:m.endTime})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[e.jsx(je,{className:"w-4 h-4 inline ml-1"}),"מיקום"]}),e.jsx("input",{type:"text",value:T.location||"",onChange:s=>$("location",s.target.value),placeholder:"כגון: אולם ערן, סטודיו קאמרי 1",className:`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900 ${m.location?"border-red-300":"border-gray-300"}`}),m.location&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:m.location})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"הערות"}),e.jsx("textarea",{value:T.notes||"",onChange:s=>$("notes",s.target.value),rows:3,placeholder:"הערות נוספות עבור החזרה...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[e.jsx(le,{className:"w-4 h-4 inline ml-1"}),"תזמורת"]}),e.jsxs("select",{value:I.orchestraId||"",onChange:s=>N("orchestraId",s.target.value),className:`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900 ${m.orchestraId?"border-red-300":"border-gray-300"}`,children:[e.jsx("option",{value:"",children:"בחר תזמורת"}),t.map(s=>e.jsxs("option",{value:s._id,children:[s.name," (",s.type,")"]},s._id))]}),m.orchestraId&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:m.orchestraId})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[e.jsx(te,{className:"w-4 h-4 inline ml-1"}),"תאריך התחלה"]}),e.jsx("input",{type:"date",value:I.startDate||"",onChange:s=>N("startDate",s.target.value),className:`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900 ${m.startDate?"border-red-300":"border-gray-300"}`}),m.startDate&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:m.startDate})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"תאריך סיום"}),e.jsx("input",{type:"date",value:I.endDate||"",onChange:s=>N("endDate",s.target.value),className:`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900 ${m.endDate?"border-red-300":"border-gray-300"}`}),m.endDate&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:m.endDate})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"יום בשבוע"}),e.jsx("select",{value:I.dayOfWeek||0,onChange:s=>N("dayOfWeek",parseInt(s.target.value)),className:`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900 ${m.dayOfWeek?"border-red-300":"border-gray-300"}`,children:Cs.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))}),m.dayOfWeek&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:m.dayOfWeek})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[e.jsx(ne,{className:"w-4 h-4 inline ml-1"}),"שעת התחלה"]}),e.jsx("input",{type:"time",value:I.startTime||"",onChange:s=>N("startTime",s.target.value),className:`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900 ${m.startTime?"border-red-300":"border-gray-300"}`}),m.startTime&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:m.startTime})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"שעת סיום"}),e.jsx("input",{type:"time",value:I.endTime||"",onChange:s=>N("endTime",s.target.value),className:`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900 ${m.endTime?"border-red-300":"border-gray-300"}`}),m.endTime&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:m.endTime})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[e.jsx(je,{className:"w-4 h-4 inline ml-1"}),"מיקום"]}),e.jsx("input",{type:"text",value:I.location||"",onChange:s=>N("location",s.target.value),placeholder:"כגון: אולם ערן, סטודיו קאמרי 1",className:`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900 ${m.location?"border-red-300":"border-gray-300"}`}),m.location&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:m.location})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"תאריכים לדילוג"}),e.jsxs("div",{className:"flex gap-2 mb-2",children:[e.jsx("input",{type:"date",value:L,onChange:s=>P(s.target.value),className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent",placeholder:"בחר תאריך לדילוג"}),e.jsx("button",{type:"button",onClick:R,disabled:!L,className:"px-3 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(ge,{className:"w-4 h-4"})})]}),I.excludeDates&&I.excludeDates.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2",children:I.excludeDates.map(s=>e.jsxs("div",{className:"flex items-center bg-gray-100 rounded-lg px-2 py-1",children:[e.jsx("span",{className:"text-sm text-gray-700",children:new Date(s).toLocaleDateString("he-IL")}),e.jsx("button",{type:"button",onClick:()=>_(s),className:"mr-1 text-gray-500 hover:text-red-600",children:e.jsx(Xt,{className:"w-3 h-3"})})]},s))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"הערות"}),e.jsx("textarea",{value:I.notes||"",onChange:s=>N("notes",s.target.value),rows:3,placeholder:"הערות נוספות עבור כל החזרות...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"})]}),V.length>0&&e.jsxs("div",{className:"bg-blue-50 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx(Ye,{className:"w-4 h-4 text-blue-600 ml-1"}),e.jsxs("span",{className:"text-sm font-medium text-blue-900",children:["תיווצרו ",V.length," חזרות"]})]}),e.jsxs("div",{className:"text-xs text-blue-700 max-h-32 overflow-y-auto",children:[V.slice(0,10).map(s=>e.jsxs("div",{children:[new Date(s).toLocaleDateString("he-IL")," - ",ze(new Date(s).getDay())]},s)),V.length>10&&e.jsxs("div",{className:"text-blue-600",children:["...ועוד ",V.length-10]})]})]})]}),e.jsx(Rs,{newRehearsal:n==="single"?T:null,bulkData:n==="bulk"?I:null,existingRehearsals:r,orchestras:t,onConflictsChanged:B}),m.submit&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("p",{className:"text-red-800 text-sm",children:m.submit})}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t border-gray-200",children:[e.jsx("button",{type:"button",onClick:c,className:"px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors",children:"ביטול"}),e.jsx("button",{type:"submit",disabled:f||S,className:`px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors ${f||S?"opacity-50 cursor-not-allowed":""}`,children:f?"שומר...":i?"עדכן חזרה":n==="single"?"צור חזרה":`צור ${V.length} חזרות`})]})]})]})})})}const $s=[{name:"מידע כללי",href:"/dashboard",icon:we,category:"general"},{name:"תלמידים",href:"/students",icon:le,category:"management",roles:["admin"]},{name:"מורים",href:"/teachers",icon:ft,category:"management",roles:["admin"]},{name:"שיעורי תיאוריה",href:"/theory-lessons",icon:Ne,category:"management",roles:["admin"]},{name:"תזמורות",href:"/orchestras",icon:ke,category:"management",roles:["admin"]},{name:"חזרות",href:"/rehearsals",icon:te,category:"management",roles:["admin"]},{name:"בגרויות",href:"/bagruts",icon:He,category:"operations",roles:["admin"]},{name:"נוכחות",href:"/attendance",icon:Ee,category:"operations",roles:["admin"]},{name:"דוחות",href:"/reports",icon:Gt,category:"management",roles:["admin"]},{name:"הגדרות",href:"/settings",icon:ve,category:"system",roles:["admin"]}],Ls=[{name:"לוח בקרה",href:"/dashboard",icon:we,category:"general"},{name:"התלמידים שלי",href:"/students",icon:le,category:"personal",roles:["teacher"]},{name:"לוח זמנים שלי",href:"/profile",icon:te,category:"personal",roles:["teacher"]},{name:"נוכחות",href:"/attendance",icon:Ee,category:"operations",roles:["teacher"]},{name:"ניהול בגרויות",href:"/bagruts",icon:He,category:"operations",roles:["teacher"]},{name:"פרופיל",href:"/profile",icon:ie,category:"personal"}],Us=[{name:"לוח בקרה",href:"/dashboard",icon:we,category:"general"},{name:"התזמורות שלי",href:"/orchestras",icon:ke,category:"personal",roles:["conductor"]},{name:"חזרות",href:"/rehearsals",icon:te,category:"personal",roles:["conductor"]},{name:"נוכחות",href:"/conductor/attendance",icon:Ee,category:"operations",roles:["conductor"]},{name:"ניהול רישומים",href:"/conductor/enrollment",icon:pt,category:"operations",roles:["conductor"]},{name:"פרופיל",href:"/profile",icon:ie,category:"personal"}],Bs=[{name:"לוח בקרה",href:"/dashboard",icon:we,category:"general"},{name:"השיעורים שלי",href:"/theory-lessons",icon:Ne,category:"personal",roles:["theory-teacher"]},{name:"קבוצות תיאוריה",href:"/theory-lessons",icon:le,category:"personal",roles:["theory-teacher"]},{name:"נוכחות",href:"/attendance",icon:Ee,category:"operations",roles:["theory-teacher"]},{name:"תכנית לימודים",href:"/theory-lessons",icon:Qt,category:"personal",roles:["theory-teacher"]},{name:"פרופיל",href:"/profile",icon:ie,category:"personal"}],it={admin:[{name:"הוסף תלמיד חדש",href:"/students/new",icon:le,role:"admin"},{name:"הוסף מורה חדש",href:"/teachers/new",icon:ft,role:"admin"},{name:"צור שיעור תיאוריה",href:"/theory-lessons/new",icon:Ne,role:"admin"},{name:"תזמן חזרה",href:"/rehearsals/new",icon:te,role:"admin"}],teacher:[{name:"הוסף שיעור",href:"/profile",icon:ge,role:"teacher"},{name:"סמן נוכחות",href:"/attendance",icon:et,role:"teacher"},{name:"צפה בלוח זמנים",href:"/profile",icon:ne,role:"teacher"}],conductor:[{name:"תזמן חזרה",href:"/rehearsals/new",icon:tt,role:"conductor"},{name:"נהל תזמורת",href:"/orchestras",icon:ke,role:"conductor"},{name:"סמן נוכחות",href:"/conductor/attendance",icon:et,role:"conductor"}],"theory-teacher":[{name:"תזמן שיעור תיאוריה",href:"/theory-lessons/new",icon:tt,role:"theory-teacher"},{name:"נהל קבוצות",href:"/theory-lessons",icon:pt,role:"theory-teacher"},{name:"דרג תלמידים",href:"/theory-lessons",icon:He,role:"theory-teacher"}]};function Fs(){const t=Lt(),r=Ve(),{user:o,isLoading:c}=xe(),{isDesktopOpen:i,setIsDesktopOpen:n,isMobile:l}=Xe(),[f,j]=u.useState(""),[m,h]=u.useState(!1),[T,A]=u.useState(new Set),[I,E]=u.useState(!1),[L,P]=u.useState(!1),[V,g]=u.useState(!1),[v,y]=u.useState(!1),[S,C]=u.useState([]),[$,N]=u.useState(!1),R=w=>t.pathname===w,B=(()=>{if(!o)return["admin"];const w=[];return o.role==="admin"||o.role==="מנהל"||o.roles?.includes("admin")||o.roles?.includes("מנהל")?["admin"]:(o.role&&w.push(o.role),o.roles&&Array.isArray(o.roles)&&w.push(...o.roles),o.teaching?.studentIds?.length>0&&!w.includes("teacher")&&w.push("teacher"),o.conducting?.orchestraIds?.length>0&&!w.includes("conductor")&&w.push("conductor"),[...new Set(w.map(U=>U==="theory_teacher"?"theory-teacher":U))])})(),K=B.includes("admin"),s=B.length>1,d=()=>{if(K)return $s;const w=new Map,U=[];return B.includes("teacher")&&U.push(...Ls),B.includes("conductor")&&U.push(...Us),B.includes("theory-teacher")&&U.push(...Bs),U.forEach(F=>{const q=F.href;if(!w.has(q))w.set(q,F);else{const re=w.get(q);F.roles&&re.roles&&(re.roles=[...new Set([...re.roles,...F.roles])])}}),Array.from(w.values())},b=()=>{if(K)return it.admin;const w=[],U=new Map;return B.forEach(F=>{const q=it[F];q&&q.forEach(re=>{const ye=`${re.href}-${re.name}`;U.has(ye)||(U.set(ye,!0),w.push(re))})}),w},D=w=>{const U={general:{label:"כללי",items:[]},personal:{label:"אזור אישי",items:[]},management:{label:"ניהול מערכת",items:[]},operations:{label:"פעולות",items:[]},system:{label:"מערכת",items:[]}};return w.forEach(F=>{const q=F.category||"general";U[q]&&U[q].items.push(F)}),Object.entries(U).filter(([F,q])=>q.items.length>0).map(([F,q])=>({key:F,...q}))},W=d(),ee=D(W),ue=b();u.useEffect(()=>{l||h(!1)},[l]),u.useEffect(()=>{const w=U=>{if(l&&m){const F=document.getElementById("mobile-sidebar"),q=document.getElementById("hamburger-button");F&&!F.contains(U.target)&&q&&!q.contains(U.target)&&h(!1)}};return document.addEventListener("mousedown",w),()=>document.removeEventListener("mousedown",w)},[l,m]),u.useEffect(()=>(l&&m?document.body.style.overflow="hidden":document.body.style.overflow="unset",()=>{document.body.style.overflow="unset"}),[l,m]);const me=()=>{l&&h(!1)},J=w=>{const U=new Set(T);U.has(w)?U.delete(w):U.add(w),A(U)},pe=w=>{switch(w){case"admin":return"מנהל";case"teacher":return"מורה";case"conductor":return"מנצח";case"theory-teacher":return"מורה תיאוריה";default:return w}},a=w=>{switch(w){case"admin":return"bg-purple-100 text-purple-700";case"teacher":return"bg-blue-100 text-blue-700";case"conductor":return"bg-green-100 text-green-700";case"theory-teacher":return"bg-yellow-100 text-yellow-700";default:return"bg-gray-100 text-gray-700"}},x=async(w,U)=>{me(),w==="הוסף תלמיד חדש"?E(!0):w==="הוסף מורה חדש"?P(!0):w==="צור שיעור תיאוריה"?g(!0):w==="תזמן חזרה"?(await p(),y(!0)):r(U)},p=async()=>{try{N(!0);const w=await Vt.getOrchestras();C(w||[])}catch(w){console.error("Failed to load orchestras:",w),C([])}finally{N(!1)}},k=async w=>{E(!1)},O=async()=>{P(!1)},Y=async w=>{g(!1)},Q=async w=>{y(!1)};return e.jsxs(e.Fragment,{children:[l&&e.jsx("button",{id:"hamburger-button",onClick:()=>h(!m),className:"fixed top-4 right-4 z-[1001] p-2 bg-white rounded-lg shadow-lg border border-gray-200 hover:bg-gray-50 transition-colors duration-200","aria-label":"Toggle menu",children:m?e.jsx(de,{className:"w-6 h-6 text-gray-600"}):e.jsx(Re,{className:"w-6 h-6 text-gray-600"})}),!l&&!i&&e.jsx("button",{onClick:()=>n(!0),className:"fixed top-4 right-4 z-[1001] p-2 bg-white rounded-lg shadow-lg border border-gray-200 hover:bg-indigo-50 hover:border-indigo-300 transition-all duration-200","aria-label":"Open sidebar",children:e.jsx(Re,{className:"w-5 h-5 text-indigo-600"})}),l&&m&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-[999] transition-opacity duration-300",onClick:()=>h(!1)}),e.jsxs("div",{id:"sidebar",className:`fixed top-0 right-0 w-[280px] h-screen bg-white border-l border-gray-200 shadow-[-4px_0_6px_-1px_rgba(0,0,0,0.1)] rtl z-[999] transition-transform duration-300 ease-in-out flex flex-col ${l?m?"translate-x-0":"translate-x-full":i?"translate-x-0":"translate-x-full"}`,children:[!l&&e.jsx("button",{onClick:()=>n(!i),className:"absolute top-4 left-4 p-2 bg-gray-50 rounded-lg border border-gray-200 hover:bg-indigo-50 hover:border-indigo-300 transition-all duration-200 z-10","aria-label":"Toggle sidebar",children:i?e.jsx(de,{className:"w-5 h-5 text-gray-600"}):e.jsx(Re,{className:"w-5 h-5 text-indigo-600"})}),e.jsx("div",{className:"p-4 border-b border-gray-100 flex-shrink-0",children:e.jsxs("div",{className:"relative",children:[e.jsx(zt,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"חיפוש...",value:f,onChange:w=>j(w.target.value),className:"w-full pr-10 pl-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-reisinger-yonatan text-right rtl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]})}),s&&!K&&e.jsx("div",{className:"px-4 py-3 border-b border-gray-100 flex-shrink-0",children:e.jsx("div",{className:"flex flex-wrap gap-2",children:B.map(w=>e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${a(w)}`,children:[e.jsx(qt,{className:"w-3 h-3"}),pe(w)]},w))})}),e.jsx("nav",{className:"flex-1 px-3 py-4 overflow-y-auto overflow-x-hidden min-h-0 custom-scrollbar",children:c?e.jsx("div",{className:"space-y-2 px-4 py-8",children:e.jsxs("div",{className:"animate-pulse space-y-3",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/2"}),e.jsx("div",{className:"h-8 bg-gray-200 rounded"}),e.jsx("div",{className:"h-8 bg-gray-200 rounded"}),e.jsx("div",{className:"h-8 bg-gray-200 rounded"})]})}):e.jsxs(e.Fragment,{children:[ee.map((w,U)=>e.jsxs("div",{className:U>0?"mt-6":"",children:[e.jsx("div",{className:"px-4 mb-2",children:e.jsxs("button",{onClick:()=>J(w.key),className:"flex items-center justify-between w-full text-xs font-semibold text-gray-500 uppercase tracking-wider hover:text-gray-700 transition-colors",children:[e.jsx("span",{children:w.label}),e.jsx(ae,{className:`w-3 h-3 transition-transform ${T.has(w.key)?"rotate-180":""}`})]})}),!T.has(w.key)&&e.jsx("div",{className:"space-y-1",children:w.items.map(F=>{const q=F.icon,re=R(F.href);return e.jsxs(ht,{to:F.href,onClick:me,className:`flex items-center justify-between px-4 py-3 mx-3 rounded-lg text-sm font-medium transition-all duration-150 rtl font-reisinger-yonatan ${re?"bg-primary-50 text-primary-700 border border-primary-200":"text-gray-600 hover:bg-gray-50 hover:text-gray-700"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-right",children:F.name}),s&&!K&&F.roles&&F.roles.length===1&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded-full ${a(F.roles[0])}`,children:pe(F.roles[0])})]}),e.jsx(q,{className:"w-4 h-4 flex-shrink-0"})]},`${w.key}-${F.href}-${F.name}`)})})]},w.key)),ue.length>0&&e.jsxs("div",{className:"space-y-1 border-t border-gray-200 pt-6 mt-6",children:[e.jsx("h3",{className:"px-4 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3",children:"פעולות מהירות"}),ue.map(w=>{const U=w.icon;return e.jsxs("button",{onClick:()=>x(w.name,w.href),className:"w-full flex items-center justify-between px-4 py-2 mx-3 rounded-lg text-sm font-medium transition-all duration-150 rtl font-reisinger-yonatan text-gray-600 hover:bg-green-50 hover:text-green-700 group",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-right",children:w.name}),s&&!K&&w.role&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded-full ${a(w.role)}`,children:pe(w.role)})]}),e.jsxs("div",{className:"flex items-center space-x-1 space-x-reverse",children:[e.jsx(ge,{className:"w-3 h-3 group-hover:text-green-500"}),e.jsx(U,{className:"w-3.5 h-3.5"})]})]},`${w.href}-${w.name}-${w.role}`)})]})]})})]}),I&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[1002] p-4",children:e.jsx("div",{className:"bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:e.jsx(Ns,{onSubmit:k,onCancel:()=>E(!1),isEdit:!1,initialData:null})})}),L&&e.jsx(Ss,{isOpen:L,onClose:()=>P(!1),onSuccess:O}),V&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[1002] p-4",children:e.jsx("div",{className:"bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:e.jsx(Ds,{onSubmit:Y,onCancel:()=>g(!1)})})}),v&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[1002] p-4",children:e.jsx("div",{className:"bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:$?e.jsxs("div",{className:"p-8 text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"טוען תזמורות..."})]}):e.jsx(Ps,{orchestras:S,onSubmit:Q,onCancel:()=>y(!1)})})})]})}function Ms(){const[t,r]=u.useState(!1),o=u.useRef(null),{currentSchoolYear:c,schoolYears:i,isLoading:n,setCurrentSchoolYearById:l,getSchoolYearDisplayName:f}=Nt();u.useEffect(()=>{const m=h=>{o.current&&!o.current.contains(h.target)&&r(!1)};return document.addEventListener("mousedown",m),()=>document.removeEventListener("mousedown",m)},[]);const j=async m=>{await l(m),r(!1)};return n?e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg",children:[e.jsx(te,{className:"w-4 h-4 text-gray-400"}),e.jsx("div",{className:"w-24 h-4 bg-gray-200 rounded animate-pulse"})]}):e.jsxs("div",{className:"relative",ref:o,children:[e.jsxs("button",{onClick:()=>r(!t),className:"flex items-center gap-2 px-3 py-2 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 hover:border-gray-300 transition-all duration-150 ease-in-out min-w-[200px]",style:{direction:"rtl"},children:[e.jsx(te,{className:"w-4 h-4 text-indigo-600 flex-shrink-0"}),e.jsx("span",{className:"text-sm font-medium text-gray-700 font-reisinger-yonatan flex-grow text-right truncate",children:c?f(c):"בחר שנת לימוד"}),t?e.jsx(ce,{className:"w-4 h-4 text-gray-500 flex-shrink-0"}):e.jsx(ae,{className:"w-4 h-4 text-gray-500 flex-shrink-0"})]}),t&&e.jsxs("div",{className:"absolute right-0 mt-2 w-full min-w-[250px] bg-white rounded-lg shadow-lg border border-gray-200 py-2 z-[1000]",children:[e.jsx("div",{className:"px-4 py-2 border-b border-gray-100",children:e.jsx("h3",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wide font-reisinger-yonatan text-right",children:"שנות לימוד"})}),e.jsx("div",{className:"max-h-64 overflow-y-auto",children:i.length===0?e.jsx("div",{className:"px-4 py-3 text-sm text-gray-500 font-reisinger-yonatan text-center",children:"לא נמצאו שנות לימוד"}):i.sort((m,h)=>new Date(h.startDate).getTime()-new Date(m.startDate).getTime()).map(m=>{const h=c?._id===m._id,T=m.isCurrent,A=m.isActive;return e.jsxs("button",{onClick:()=>j(m._id),className:`w-full px-4 py-3 text-right hover:bg-gray-50 flex items-center justify-between transition-colors duration-150 ${h?"bg-indigo-50 border-l-4 border-indigo-500":""}`,style:{direction:"rtl"},children:[e.jsxs("div",{className:"flex flex-col items-end",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`text-sm font-medium font-reisinger-yonatan ${h?"text-indigo-700":"text-gray-700"}`,children:m.name}),T&&e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800",children:"נוכחית"}),!A&&e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600",children:"לא פעילה"})]}),e.jsxs("span",{className:"text-xs text-gray-500 font-reisinger-yonatan",children:[new Date(m.startDate).toLocaleDateString("he-IL")," - ",new Date(m.endDate).toLocaleDateString("he-IL")]})]}),h&&e.jsx(Kt,{className:"w-4 h-4 text-indigo-600 flex-shrink-0"})]},m._id)})}),e.jsx("div",{className:"px-4 py-2 border-t border-gray-100",children:e.jsx("button",{className:"text-xs text-indigo-600 hover:text-indigo-700 font-medium font-reisinger-yonatan",children:"+ הוסף שנת לימוד חדשה"})})]})]})}function Vs(){const[t,r]=u.useState(!1),[o,c]=u.useState(!1),i=u.useRef(null),n=u.useRef(null),l=Ve(),{user:f,logout:j}=xe(),{isDesktopOpen:m,isMobile:h}=Xe(),T=!f||f.role==="admin"||f.roles?.includes("admin"),A=T||f?.role==="teacher"||f?.roles?.includes("teacher")||f?.role==="conductor"||f?.roles?.includes("conductor")||f?.role==="theory-teacher"||f?.roles?.includes("theory-teacher")||f?.role==="theory_teacher"||f?.roles?.includes("theory_teacher")||f?.teaching?.studentIds?.length>0||f?.conducting?.orchestraIds?.length>0;u.useEffect(()=>{const y=S=>{i.current&&!i.current.contains(S.target)&&r(!1),n.current&&!n.current.contains(S.target)&&c(!1)};return document.addEventListener("mousedown",y),()=>document.removeEventListener("mousedown",y)},[]);const I=()=>[{icon:st,label:"התראות",action:()=>console.log("Notifications")},{icon:te,label:"לוח שנה",action:()=>console.log("Calendar")},{icon:ve,label:"הגדרות",action:()=>console.log("Settings")}],E=()=>{l("/profile"),c(!1)},L=async()=>{try{await j(),l("/login")}catch(y){console.error("Logout error:",y)}c(!1)},P=()=>{l("/dashboard")},V=()=>{const y=f?.personalInfo?.fullName||f?.fullName||f?.name||"";if(!y)return"מ";const S=y.trim().split(" ");return S.length>=2?S[0][0]+S[1][0]:S[0][0]||"מ"},g=()=>f?.personalInfo?.fullName||f?.fullName||f?.name||"משתמש",v=()=>{const y=f?.role||f?.roles?.[0]||"";switch(y){case"teacher":return"מורה";case"מורה":return"מורה";case"conductor":return"מנצח";case"מנצח":return"מנצח";case"theory_teacher":return"מורה תיאוריה";case"מורה תיאוריה":return"מורה תיאוריה";case"admin":return"מנהל";case"מנהל":return"מנהל";default:return y||"משתמש"}};return e.jsxs("header",{className:"fixed top-0 left-0 h-16 bg-white border-b border-gray-200 flex items-center justify-between z-[998] transition-all duration-300",style:{direction:"rtl",right:A&&!h&&m?"280px":"0",paddingLeft:"1.5rem",paddingRight:A&&!h&&!m?"4rem":"1.5rem"},children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("img",{src:"/logo.png",alt:"Logo",className:"h-10 w-auto object-contain"}),e.jsx(Ms,{})]}),e.jsxs("div",{className:"flex items-center gap-4",style:{direction:"ltr"},children:[!h&&e.jsxs(e.Fragment,{children:[!T&&e.jsx("button",{onClick:P,className:"w-10 h-10 rounded-lg bg-indigo-50 border border-indigo-200 flex items-center justify-center hover:bg-indigo-100 hover:border-indigo-300 transition-all duration-150 ease-in-out cursor-pointer",title:"לוח בקרה",children:e.jsx(we,{className:"w-5 h-5 text-indigo-600"})}),e.jsx("button",{className:"w-10 h-10 rounded-lg bg-gray-50 border border-gray-200 flex items-center justify-center hover:bg-gray-100 hover:border-gray-300 transition-all duration-150 ease-in-out cursor-pointer",children:e.jsx(st,{className:"w-5 h-5 text-gray-600"})}),e.jsx("button",{className:"w-10 h-10 rounded-lg bg-gray-50 border border-gray-200 flex items-center justify-center hover:bg-gray-100 hover:border-gray-300 transition-all duration-150 ease-in-out cursor-pointer",children:e.jsx(te,{className:"w-5 h-5 text-gray-600"})}),e.jsx("button",{className:"w-10 h-10 rounded-lg bg-gray-50 border border-gray-200 flex items-center justify-center hover:bg-gray-100 hover:border-gray-300 transition-all duration-150 ease-in-out cursor-pointer",children:e.jsx(ve,{className:"w-5 h-5 text-gray-600"})})]}),h&&e.jsxs("div",{className:"relative",ref:i,children:[e.jsx("button",{onClick:()=>r(!t),className:"w-10 h-10 rounded-lg bg-gray-50 border border-gray-200 flex items-center justify-center hover:bg-gray-100 hover:border-gray-300 transition-all duration-150 ease-in-out cursor-pointer",children:t?e.jsx(ce,{className:"w-5 h-5 text-gray-600"}):e.jsx(ae,{className:"w-5 h-5 text-gray-600"})}),t&&e.jsx("div",{className:"absolute left-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-2 z-[1000]",children:I().map((y,S)=>{const C=y.icon,$=y.label==="לוח בקרה";return e.jsxs("button",{onClick:()=>{y.action(),r(!1)},className:`w-full px-4 py-3 text-right hover:bg-gray-50 flex items-center justify-between transition-colors duration-150 ${$?"hover:bg-indigo-50":""}`,style:{direction:"rtl"},children:[e.jsx("span",{className:`text-sm font-medium font-reisinger-yonatan ${$?"text-indigo-700":"text-gray-700"}`,children:y.label}),e.jsx(C,{className:`w-4 h-4 ${$?"text-indigo-600":"text-gray-500"}`})]},S)})})]}),e.jsxs("div",{className:"relative",ref:n,children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center cursor-pointer hover:bg-indigo-700 transition-colors",onClick:()=>c(!o),children:e.jsx("span",{className:"text-sm font-semibold text-white font-reisinger-yonatan",children:V()})}),o&&e.jsxs("div",{className:"absolute left-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-2 z-[1000]",children:[e.jsxs("div",{className:"px-4 py-3 border-b border-gray-100",children:[e.jsx("div",{className:"text-sm font-medium text-gray-700 font-reisinger-yonatan",children:g()}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:v()})]}),e.jsxs("button",{onClick:E,className:"w-full px-4 py-3 text-right hover:bg-gray-50 flex items-center justify-between transition-colors duration-150",style:{direction:"rtl"},children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 font-reisinger-yonatan",children:"עמוד אישי"}),e.jsx(ie,{className:"w-4 h-4 text-gray-500"})]}),e.jsxs("button",{onClick:L,className:"w-full px-4 py-3 text-right hover:bg-gray-50 flex items-center justify-between transition-colors duration-150 text-red-600 hover:bg-red-50",style:{direction:"rtl"},children:[e.jsx("span",{className:"text-sm font-medium font-reisinger-yonatan",children:"יציאה"}),e.jsx(Jt,{className:"w-4 h-4"})]})]})]})]})]})}function H({children:t}){const{user:r}=xe(),{isDesktopOpen:o,isMobile:c}=Xe(),i=!r||r.role==="admin"||r.roles?.includes("admin")||r.role==="teacher"||r.roles?.includes("teacher")||r.role==="conductor"||r.roles?.includes("conductor")||r.role==="theory-teacher"||r.roles?.includes("theory-teacher")||r.role==="theory_teacher"||r.roles?.includes("theory_teacher")||r.teaching?.studentIds?.length>0||r.conducting?.orchestraIds?.length>0;return e.jsxs("div",{className:"min-h-screen bg-gray-50",dir:"rtl",children:[i&&e.jsx(Fs,{}),e.jsx(Vs,{}),e.jsx("main",{className:"mt-16 ml-0 p-0 bg-gray-50 min-h-[calc(100vh-64px)] rtl transition-all duration-300",style:{marginRight:i&&!c&&o?"280px":"0"},children:e.jsx("div",{className:"p-6 bg-gray-50",children:t})})]})}function Ys(){const[t,r]=u.useState(""),[o,c]=u.useState(""),[i,n]=u.useState(""),[l,f]=u.useState(!1),j=Ve(),{login:m}=xe(),h=async T=>{T.preventDefault(),n(""),f(!0),console.log("🔐 Login attempt started:",{email:t,password:"***"}),console.log("🌐 API Base URL:","https://conservatory-app-backend.onrender.com/api"),console.log("🔧 Environment check:",{VITE_API_URL:"https://conservatory-app-backend.onrender.com/api",fallback:"http://localhost:3001/api",actual:"https://conservatory-app-backend.onrender.com/api"});try{console.log("📤 Sending login request to API service...");const A=await m(t,o);console.log("✅ Login successful:",{user:A.user?.personalInfo?.fullName||"Unknown"}),console.log("🔑 Authentication token stored successfully"),console.log("🧭 Navigating to dashboard..."),j("/dashboard")}catch(A){console.error("❌ Login failed:",A),console.error("📍 Error details:",{message:A.message,stack:A.stack}),n(A.message||"שגיאה בהתחברות. אנא בדוק את הפרטים ונסה שוב.")}finally{f(!1)}};return e.jsxs("div",{className:"min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8 relative",style:{backgroundImage:'url("/login-background.jpg")',backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat"},dir:"rtl",children:[e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-30"}),e.jsx("div",{className:"max-w-md w-full space-y-8 relative z-10",children:e.jsxs("div",{className:"backdrop-blur-lg bg-white/10 border border-white/20 rounded-2xl shadow-xl p-8",children:[e.jsx("div",{children:e.jsx("h2",{className:"mt-6 text-center text-3xl font-extrabold text-yellow-400 drop-shadow-lg",style:{fontFamily:"'Reisinger Yonatan', 'Arial Hebrew', 'Noto Sans Hebrew', Arial, sans-serif"},children:"✅ HEBREW WORKING! כניסה לחשבון שלך"})}),e.jsxs("form",{className:"mt-8 space-y-6",onSubmit:h,children:[i&&e.jsx("div",{className:"mb-4 p-3 bg-red-500/20 border border-red-500/50 rounded-lg backdrop-blur-sm",children:e.jsx("p",{className:"text-red-100 text-sm text-center font-reisinger-yonatan",children:i})}),e.jsxs("div",{className:"rounded-md shadow-sm space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"email",className:"sr-only font-reisinger-yonatan",children:'כתובת דוא"ל'}),e.jsx("input",{id:"email",name:"email",type:"email",required:!0,disabled:l,className:"relative block w-full px-3 py-3 border border-white/30 placeholder-gray-400 text-gray-900 rounded-lg bg-white/80 backdrop-blur-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent focus:z-10 sm:text-sm placeholder:text-right font-reisinger-yonatan disabled:opacity-50 disabled:cursor-not-allowed",placeholder:"כתובת דוא״ל",value:t,onChange:T=>r(T.target.value),dir:"ltr",style:{textAlign:"left"}})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"password",className:"sr-only font-reisinger-yonatan",children:"סיסמה"}),e.jsx("input",{id:"password",name:"password",type:"password",required:!0,disabled:l,className:"relative block w-full px-3 py-3 border border-white/30 placeholder-gray-400 text-gray-900 rounded-lg bg-white/80 backdrop-blur-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent focus:z-10 sm:text-sm placeholder:text-right font-reisinger-yonatan disabled:opacity-50 disabled:cursor-not-allowed",placeholder:"סיסמה",value:o,onChange:T=>c(T.target.value),dir:"ltr",style:{textAlign:"left"}})]})]}),e.jsx("div",{children:e.jsx("button",{type:"submit",disabled:l,className:"group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-blue-600/90 hover:bg-blue-700/90 backdrop-blur-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 shadow-lg font-reisinger-yonatan disabled:opacity-50 disabled:cursor-not-allowed",children:l?e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"מתחבר..."]}):"כניסה"})}),e.jsx("div",{className:"text-center",children:e.jsx(ht,{to:"/dashboard",className:"font-medium text-white/90 hover:text-white drop-shadow transition-colors duration-200 font-reisinger-yonatan",children:"דלג למרכז הבקרה (הדגמה)"})})]})]})})]})}function Z(t,r,o=3){return u.lazy(()=>{let c=0;const i=async()=>{try{const n=await t();return console.log(`✅ Successfully loaded ${r}`),n}catch(n){if(console.error(`❌ Failed to load ${r}, attempt ${c+1}/${o}:`,n),c<o-1){c++;const l=Math.min(1e3*Math.pow(2,c),5e3);return await new Promise(f=>setTimeout(f,l)),i()}else throw console.error(`❌ All retry attempts failed for ${r}`),n}};return i()})}class Ws{constructor(){Oe(this,"preloadedComponents",new Set);Oe(this,"preloadPromises",new Map)}preload(r,o){if(this.preloadedComponents.has(r))return Promise.resolve();if(this.preloadPromises.has(r))return this.preloadPromises.get(r);const c=o().then(i=>(this.preloadedComponents.add(r),console.log(`✅ Preloaded ${r}`),i)).catch(i=>{throw console.error(`❌ Failed to preload ${r}:`,i),i}).finally(()=>{this.preloadPromises.delete(r)});return this.preloadPromises.set(r,c),c}preloadOnHover(r,o){return()=>{this.preloadedComponents.has(r)||this.preload(r,o)}}getPreloadStats(){return{preloadedComponents:Array.from(this.preloadedComponents),pendingPreloads:Array.from(this.preloadPromises.keys())}}}const Pe=new Ws,$e={STUDENT_DETAILS:"StudentDetailsPage",THEORY_TAB:"TheoryTab",ORCHESTRA_TAB:"OrchestraTab",DASHBOARD:"Dashboard",STUDENTS_LIST:"Students"};function Hs(){setTimeout(()=>{Pe.preload($e.DASHBOARD,()=>G(()=>import("../chunks/Dashboard-BfHH8TkA.js"),__vite__mapDeps([0,1,2,3,4,5,6,7]))),Pe.preload($e.STUDENTS_LIST,()=>G(()=>import("../chunks/Students-yT3Y9j_E.js"),__vite__mapDeps([8,1,3,4,9,7,10,5,6])))},1e3),setTimeout(()=>{Pe.preload($e.STUDENT_DETAILS,()=>G(()=>import("../chunks/StudentDetailsPageSimple-BJLFLsav.js"),__vite__mapDeps([11,1,7,5,6,3,12,13,14,4])))},3e3)}function Xs(){const t=document.head,r=document.createElement("link");r.rel="dns-prefetch",r.href="//localhost",t.appendChild(r);const o=document.createElement("link");o.rel="preconnect",o.href="http://localhost:3001",o.crossOrigin="anonymous",t.appendChild(o);const c=document.createElement("link");c.rel="prefetch",c.as="style",c.href="/src/index.css",t.appendChild(c)}function zs(){typeof window>"u"||(Xs(),Hs(),console.log("🚀 Bundle optimizations initialized"))}const qs=Z(()=>G(()=>import("../chunks/Dashboard-BfHH8TkA.js"),__vite__mapDeps([0,1,2,3,4,5,6,7])),"Dashboard"),ct=Z(()=>G(()=>import("../chunks/Students-yT3Y9j_E.js"),__vite__mapDeps([8,1,3,4,9,7,10,5,6])),"Students"),Gs=Z(()=>G(()=>import("../chunks/Teachers-SSabGqyh.js"),__vite__mapDeps([15,1,4,3,9,7,5,6])),"Teachers"),Le=Z(()=>G(()=>import("../chunks/TheoryLessons-CV_9_cs2.js"),__vite__mapDeps([16,1,4,3,2,12,5,6,7,10])),"TheoryLessons"),Qs=Z(()=>G(()=>import("../chunks/TheoryLessonDetails-Bz5hd-Ul.js"),__vite__mapDeps([17,1,4,3,9,7,2,10,5,6])),"TheoryLessonDetails"),dt=Z(()=>G(()=>import("../chunks/Orchestras-pJ1gNVFP.js"),__vite__mapDeps([18,1,4,3,9,7,2,5,6])),"Orchestras"),ut=Z(()=>G(()=>import("../chunks/Rehearsals-CaJ8i6uA.js"),__vite__mapDeps([19,1,4,3,9,7,10,5,6])),"Rehearsals"),Ks=Z(()=>G(()=>import("../chunks/RehearsalDetails-uAhe6MQs.js"),__vite__mapDeps([20,1,5,6,3,4,10,7])),"RehearsalDetails"),Js=Z(()=>G(()=>import("../chunks/Bagruts-B0BSAxQa.js"),__vite__mapDeps([21,1,4,3,9,7,2,10,22,5,6])),"Bagruts"),Zs=Z(()=>G(()=>import("../chunks/BagrutDetails-CFFwtq7k.js"),__vite__mapDeps([23,1,4,3,9,7,2,10,22,5,6])),"BagrutDetails"),er=Z(()=>G(()=>import("../chunks/Profile-DFMlsQPX.js"),__vite__mapDeps([24,1,5,6,3,7,14])),"Profile"),mt=Z(()=>G(()=>import("../chunks/RehearsalAttendance-C_S_coUJ.js"),__vite__mapDeps([25,1,5,6,3,7])),"ConductorAttendance"),tr=Z(()=>G(()=>import("../chunks/OrchestraEnrollmentManager-myMgZEhB.js"),__vite__mapDeps([26,1,5,6,3,7])),"OrchestraEnrollmentManager"),sr=Z(()=>G(()=>import("../chunks/StudentDetailsPageSimple-BJLFLsav.js"),__vite__mapDeps([11,1,7,5,6,3,12,13,14,4])),"StudentDetailsPage"),rr=Z(()=>G(()=>import("../chunks/TeacherDetailsPage-hpuWdHXC.js"),__vite__mapDeps([27,1,7,5,6,3])),"TeacherDetailsPage"),ar=Z(()=>G(()=>import("../chunks/OrchestraDetailsPage-BnkuSGn6.js"),__vite__mapDeps([28,1,5,6,3,7,10])),"OrchestraDetailsPage"),se=({message:t="טוען עמוד..."})=>e.jsx("div",{className:"flex items-center justify-center min-h-96",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600",children:t})]})});function X({children:t,allowedRoles:r}){const{isAuthenticated:o,isLoading:c,authError:i,checkAuthStatus:n,user:l}=xe(),[f,j]=Se.useState(0),m=2,h=()=>{if(!r||r.length===0)return!0;if(!l)return!1;const T=l.role||l.roles?.[0]||"",A=l.roles||[T],I={מנהל:"admin",מורה:"teacher",מנצח:"conductor","מדריך תדר":"theory-teacher","מורה תיאוריה":"theory-teacher"},E=A.map(P=>I[P]||P),L=I[T]||T;return r.some(P=>E.includes(P)||L===P||P==="admin"&&!T)};return Se.useEffect(()=>{if(i&&f<m){const T=setTimeout(()=>{console.log(`🔄 ProtectedRoute - Retrying authentication (${f+1}/${m})`),n(!0),j(A=>A+1)},1e3*(f+1));return()=>clearTimeout(T)}},[i,f,n]),Se.useEffect(()=>{o&&f>0&&j(0)},[o]),c?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600",children:"מאמת הרשאות..."}),i&&f>0&&e.jsxs("div",{className:"mt-2 text-sm text-amber-600",children:["מנסה שוב (",f,"/",m,")..."]})]})}):o?h()?e.jsx(e.Fragment,{children:t}):e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"text-red-600 mb-4",children:[e.jsx("h3",{className:"text-lg font-bold",children:"אין הרשאה"}),e.jsx("p",{className:"text-gray-600",children:"אין לך הרשאה לגשת לעמוד זה"})]}),e.jsx("button",{onClick:()=>window.history.back(),className:"px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700",children:"חזור"})]})}):e.jsx(Ie,{to:"/login",replace:!0})}function nr(){return e.jsx("div",{dir:"rtl",children:e.jsxs(Ut,{children:[e.jsx(M,{path:"/login",element:e.jsx(Ys,{})}),e.jsx(M,{path:"/dashboard",element:e.jsx(X,{children:e.jsx(H,{children:e.jsx(u.Suspense,{fallback:e.jsx(se,{message:"טוען דשבורד..."}),children:e.jsx(qs,{})})})})}),e.jsx(M,{path:"/students",element:e.jsx(X,{children:e.jsx(H,{children:e.jsx(u.Suspense,{fallback:e.jsx(se,{message:"טוען רשימת תלמידים..."}),children:e.jsx(ct,{})})})})}),e.jsx(M,{path:"/students/:studentId",element:e.jsx(X,{children:e.jsx(H,{children:e.jsx(u.Suspense,{fallback:e.jsx(se,{message:"טוען פרטי תלמיד..."}),children:e.jsx(sr,{})})})})}),e.jsx(M,{path:"/teachers",element:e.jsx(X,{allowedRoles:["admin","teacher","conductor","theory-teacher"],children:e.jsx(H,{children:e.jsx(Gs,{})})})}),e.jsx(M,{path:"/teachers/:teacherId",element:e.jsx(X,{children:e.jsx(H,{children:e.jsx(u.Suspense,{fallback:e.jsx("div",{className:"flex items-center justify-center min-h-96",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600",children:"טוען פרטי מורה..."})]})}),children:e.jsx(rr,{})})})})}),e.jsx(M,{path:"/theory-lessons",element:e.jsx(X,{children:e.jsx(H,{children:e.jsx(Le,{})})})}),e.jsx(M,{path:"/theory-lessons/:theoryId",element:e.jsx(X,{children:e.jsx(H,{children:e.jsx(Qs,{})})})}),e.jsx(M,{path:"/orchestras",element:e.jsx(X,{children:e.jsx(H,{children:e.jsx(dt,{})})})}),e.jsx(M,{path:"/orchestras/:orchestraId",element:e.jsx(X,{children:e.jsx(H,{children:e.jsx(u.Suspense,{fallback:e.jsx("div",{className:"flex items-center justify-center min-h-96",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600",children:"טוען פרטי תזמורת..."})]})}),children:e.jsx(ar,{})})})})}),e.jsx(M,{path:"/rehearsals",element:e.jsx(X,{children:e.jsx(H,{children:e.jsx(ut,{})})})}),e.jsx(M,{path:"/rehearsals/:rehearsalId",element:e.jsx(X,{children:e.jsx(H,{children:e.jsx(Ks,{})})})}),e.jsx(M,{path:"/bagruts",element:e.jsx(X,{children:e.jsx(H,{children:e.jsx(Js,{})})})}),e.jsx(M,{path:"/bagruts/:bagrutId",element:e.jsx(X,{children:e.jsx(H,{children:e.jsx(Zs,{})})})}),e.jsx(M,{path:"/bagruts/:bagrutId/edit",element:e.jsx(X,{children:e.jsx(H,{children:e.jsxs("div",{className:"p-6",dir:"rtl",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-4",children:"עריכת בגרות"}),e.jsx("p",{className:"text-gray-600",children:"עריכת פרטי הבגרות והתקדמות"}),e.jsx("div",{className:"mt-8 p-4 bg-blue-50 rounded-lg",children:e.jsx("p",{className:"text-blue-700",children:"🔧 עמוד עריכת בגרות בפיתוח - בינתיים ניתן לערוך דרך עמוד הפרטים"})})]})})})}),e.jsx(M,{path:"/bagrut",element:e.jsx(Ie,{to:"/bagruts",replace:!0})}),e.jsx(M,{path:"/profile",element:e.jsx(X,{children:e.jsx(H,{children:e.jsx(u.Suspense,{fallback:e.jsx(se,{message:"טוען עמוד אישי..."}),children:e.jsx(er,{})})})})}),e.jsx(M,{path:"/conductor/attendance",element:e.jsx(X,{allowedRoles:["conductor","admin"],children:e.jsx(H,{children:e.jsx(u.Suspense,{fallback:e.jsx(se,{message:"טוען נוכחות חזרות..."}),children:e.jsx(mt,{})})})})}),e.jsx(M,{path:"/conductor/attendance/:rehearsalId",element:e.jsx(X,{allowedRoles:["conductor","admin"],children:e.jsx(H,{children:e.jsx(u.Suspense,{fallback:e.jsx(se,{message:"טוען נוכחות חזרה..."}),children:e.jsx(mt,{})})})})}),e.jsx(M,{path:"/conductor/enrollment",element:e.jsx(X,{allowedRoles:["conductor","admin"],children:e.jsx(H,{children:e.jsx(u.Suspense,{fallback:e.jsx(se,{message:"טוען ניהול רישומים..."}),children:e.jsx(tr,{})})})})}),e.jsx(M,{path:"/conductor/orchestras",element:e.jsx(X,{allowedRoles:["conductor","admin"],children:e.jsx(H,{children:e.jsx(u.Suspense,{fallback:e.jsx(se,{message:"טוען ניהול תזמורות..."}),children:e.jsx(dt,{})})})})}),e.jsx(M,{path:"/conductor/rehearsals",element:e.jsx(X,{allowedRoles:["conductor","admin"],children:e.jsx(H,{children:e.jsx(u.Suspense,{fallback:e.jsx(se,{message:"טוען חזרות..."}),children:e.jsx(ut,{})})})})}),e.jsx(M,{path:"/conductor/musicians",element:e.jsx(X,{allowedRoles:["conductor","admin"],children:e.jsx(H,{children:e.jsx(u.Suspense,{fallback:e.jsx(se,{message:"טוען מוזיקאים..."}),children:e.jsx(ct,{})})})})}),e.jsx(M,{path:"/theory-teacher/lessons",element:e.jsx(X,{allowedRoles:["theory-teacher","admin"],children:e.jsx(H,{children:e.jsx(u.Suspense,{fallback:e.jsx(se,{message:"טוען שיעורי תיאוריה..."}),children:e.jsx(Le,{})})})})}),e.jsx(M,{path:"/theory-teacher/groups",element:e.jsx(X,{allowedRoles:["theory-teacher","admin"],children:e.jsx(H,{children:e.jsx(u.Suspense,{fallback:e.jsx(se,{message:"טוען קבוצות תיאוריה..."}),children:e.jsx(Le,{})})})})}),e.jsx(M,{path:"/",element:e.jsx(Ie,{to:"/dashboard",replace:!0})}),e.jsx(M,{path:"*",element:e.jsx(Ie,{to:"/dashboard",replace:!0})})]})})}function lr(){return u.useEffect(()=>{zs()},[]),e.jsx(xs,{children:e.jsx(ns,{children:e.jsx(ls,{children:e.jsx(gs,{children:e.jsx(fs,{children:e.jsx(nr,{})})})})})})}Yt();const or=new gt({defaultOptions:{queries:{staleTime:1e3*60*5,retry:(t,r)=>r?.status===404||r?.status===403?!1:t<3}}}),St=document.getElementById("root");if(!St)throw new Error("Root element not found");Be.createRoot(St).render(e.jsx(Se.StrictMode,{children:e.jsx(xt,{client:or,children:e.jsx(Bt,{future:{v7_startTransition:!0,v7_relativeSplatPath:!0},children:e.jsx(lr,{})})})}));export{Ss as A,Cs as D,Ps as R,Ns as S,Ds as T,Fe as V,Nt as a,ze as b,lt as c,It as d,Es as e,ks as f,jr as g,yr as h,fr as i,e as j,pr as k,br as s,xe as u};
